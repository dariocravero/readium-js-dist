/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * @license RequireJS text 2.0.6 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

//  LauncherOSX
//
//  Created by Boris Schneiderman.
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

/**
 * @preserve JSizes - JQuery plugin v0.33
 *
 * Licensed under the revised BSD License.
 * Copyright 2008-2010 Bram Stein
 * All rights reserved.
 */

//  Created by Boris Schneiderman.
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  LauncherOSX
//
//  Created by Boris Schneiderman.
// Modified by Daniel Weck
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  LauncherOSX
//
//  Created by Boris Schneiderman.
// Modified by Daniel Weck, Andrey Kavarma
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

/**
 * Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Highlighter module for Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core, TextRange and CssClassApplier modules.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Class Applier module for Rangy.
 * Adds, removes and toggles classes on Ranges and Selections
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Text range module for Rangy.
 * Text-based manipulation and searching of ranges and selections.
 *
 * Features
 *
 * - Ability to move range boundaries by character or word offsets
 * - Customizable word tokenizer
 * - Ignores text nodes inside <script> or <style> elements or those hidden by CSS display and visibility properties
 * - Range findText method to search for text or regex within the page or within a range. Flags for whole words and case
 *   sensitivity
 * - Selection and range save/restore as text offsets within a node
 * - Methods to return visible text within a range or selection
 * - innerText method for elements
 *
 * References
 *
 * https://www.w3.org/Bugs/Public/show_bug.cgi?id=13145
 * http://aryeh.name/spec/innertext/innertext.html
 * http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Position module for Rangy.
 * Extensions to Range and Selection objects to provide access to pixel positions relative to the viewport or document.
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright %%build:year%%, Tim Down
 * Licensed under the MIT license.
 * Version: %%build:version%%
 * Build date: %%build:date%%
 */

//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
// 
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Created by Dmitry Markushevich (dmitrym@evidentpoint.com)
// 
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Created by Boris Schneiderman.
// Modified by Daniel Weck
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.

!function(){var e,t,n;!function(i){function r(e,t){return R.call(e,t)}function o(e,t){var n,i,r,o,a,s,l,u,c,d,f,h=t&&t.split("/"),g=S.map,p=g&&g["*"]||{};if(e&&"."===e.charAt(0))if(t){for(h=h.slice(0,h.length-1),e=e.split("/"),a=e.length-1,S.nodeIdCompat&&w.test(e[a])&&(e[a]=e[a].replace(w,"")),e=h.concat(e),c=0;c<e.length;c+=1)if(f=e[c],"."===f)e.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((h||p)&&g){for(n=e.split("/"),c=n.length;c>0;c-=1){if(i=n.slice(0,c).join("/"),h)for(d=h.length;d>0;d-=1)if(r=g[h.slice(0,d).join("/")],r&&(r=r[i])){o=r,s=c;break}if(o)break;!l&&p&&p[i]&&(l=p[i],u=c)}!o&&l&&(o=l,s=u),o&&(n.splice(0,s,o),e=n.join("/"))}return e}function a(e,t){return function(){var n=I.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),h.apply(i,n.concat([e,t]))}}function s(e){return function(t){return o(t,e)}}function l(e){return function(t){m[e]=t}}function u(e){if(r(v,e)){var t=v[e];delete v[e],y[e]=!0,f.apply(i,t)}if(!r(m,e)&&!r(y,e))throw new Error("No "+e);return m[e]}function c(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function d(e){return function(){return S&&S.config&&S.config[e]||{}}}var f,h,g,p,m={},v={},S={},y={},R=Object.prototype.hasOwnProperty,I=[].slice,w=/\.js$/;g=function(e,t){var n,i=c(e),r=i[0];return e=i[1],r&&(r=o(r,t),n=u(r)),r?e=n&&n.normalize?n.normalize(e,s(t)):o(e,t):(e=o(e,t),i=c(e),r=i[0],e=i[1],r&&(n=u(r))),{f:r?r+"!"+e:e,n:e,pr:r,p:n}},p={require:function(e){return a(e)},exports:function(e){var t=m[e];return"undefined"!=typeof t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:d(e)}}},f=function(e,t,n,o){var s,c,d,f,h,S,R=[],I=typeof n;if(o=o||e,"undefined"===I||"function"===I){for(t=!t.length&&n.length?["require","exports","module"]:t,h=0;h<t.length;h+=1)if(f=g(t[h],o),c=f.f,"require"===c)R[h]=p.require(e);else if("exports"===c)R[h]=p.exports(e),S=!0;else if("module"===c)s=R[h]=p.module(e);else if(r(m,c)||r(v,c)||r(y,c))R[h]=u(c);else{if(!f.p)throw new Error(e+" missing "+c);f.p.load(f.n,a(o,!0),l(c),{}),R[h]=m[c]}d=n?n.apply(m[e],R):void 0,e&&(s&&s.exports!==i&&s.exports!==m[e]?m[e]=s.exports:d===i&&S||(m[e]=d))}else e&&(m[e]=n)},e=t=h=function(e,t,n,r,o){if("string"==typeof e)return p[e]?p[e](t):u(g(e,t).f);if(!e.splice){if(S=e,S.deps&&h(S.deps,S.callback),!t)return;t.splice?(e=t,t=n,n=null):e=i}return t=t||function(){},"function"==typeof n&&(n=r,r=o),r?f(i,e,t,n):setTimeout(function(){f(i,e,t,n)},4),h},h.config=function(e){return h(e)},e._defined=m,n=function(e,t,n){t.splice||(n=t,t=[]),r(m,e)||r(v,e)||(v[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("text",["module"],function(e){var n,i,r,o,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],s=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,l=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,u="undefined"!=typeof location&&location.href,c=u&&location.protocol&&location.protocol.replace(/\:/,""),d=u&&location.hostname,f=u&&(location.port||void 0),h=[],g=e.config&&e.config()||{};return n={version:"2.0.6",strip:function(e){if(e){e=e.replace(s,"");var t=e.match(l);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:g.createXhr||function(){var e,t,n;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){n=a[t];try{e=new ActiveXObject(n)}catch(i){}if(e){a=[n];break}}return e},parseName:function(e){var t,n,i,r=!1,o=e.indexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==o&&(!a||o>1)?(t=e.substring(0,o),n=e.substring(o+1,e.length)):t=e,i=n||t,o=i.indexOf("!"),-1!==o&&(r="strip"===i.substring(o+1),i=i.substring(0,o),n?n=i:t=i),{moduleName:t,ext:n,strip:r}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,i,r){var o,a,s,l=n.xdRegExp.exec(e);return l?(o=l[2],a=l[3],a=a.split(":"),s=a[1],a=a[0],!(o&&o!==t||a&&a.toLowerCase()!==i.toLowerCase()||(s||a)&&s!==r)):!0},finishLoad:function(e,t,i,r){i=t?n.strip(i):i,g.isBuild&&(h[e]=i),r(i)},load:function(e,t,i,r){if(r.isBuild&&!r.inlineText)return void i();g.isBuild=r.isBuild;var o=n.parseName(e),a=o.moduleName+(o.ext?"."+o.ext:""),s=t.toUrl(a),l=g.useXhr||n.useXhr;!u||l(s,c,d,f)?n.get(s,function(t){n.finishLoad(e,o.strip,t,i)},function(e){i.error&&i.error(e)}):t([a],function(e){n.finishLoad(o.moduleName+"."+o.ext,o.strip,e,i)})},write:function(e,t,i){if(h.hasOwnProperty(t)){var r=n.jsEscape(h[t]);i.asModule(e+"!"+t,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,t,i,r,o){var a=n.parseName(t),s=a.ext?"."+a.ext:"",l=a.moduleName+s,u=i.toUrl(a.moduleName+s)+".js";n.load(l,i,function(){var t=function(e){return r(u,e)};t.asModule=function(e,t){return r.asModule(e,u,t)},n.write(e,l,t,o)},o)}},"node"===g.env||!g.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(i=t.nodeRequire("fs"),n.get=function(e,t){var n=i.readFileSync(e,"utf8");0===n.indexOf("﻿")&&(n=n.substring(1)),t(n)}):"xhr"===g.env||!g.env&&n.createXhr()?n.get=function(e,t,i,r){var o,a=n.createXhr();if(a.open("GET",e,!0),r)for(o in r)r.hasOwnProperty(o)&&a.setRequestHeader(o.toLowerCase(),r[o]);g.onXhr&&g.onXhr(a,e),a.onreadystatechange=function(){var n,r;4===a.readyState&&(n=a.status,n>399&&600>n?(r=new Error(e+" HTTP status: "+n),r.xhr=a,i(r)):t(a.responseText),g.onXhrComplete&&g.onXhrComplete(a,e))},a.send(null)}:"rhino"===g.env||!g.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?n.get=function(e,t){var n,i,r="utf-8",o=new java.io.File(e),a=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(o),r)),l="";try{for(n=new java.lang.StringBuffer,i=s.readLine(),i&&i.length()&&65279===i.charAt(0)&&(i=i.substring(1)),n.append(i);null!==(i=s.readLine());)n.append(a),n.append(i);l=String(n.toString())}finally{s.close()}t(l)}:("xpconnect"===g.env||!g.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(r=Components.classes,o=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),n.get=function(e,t){var n,i,a={},s=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(o.nsIFileInputStream),n.init(s,1,0,!1),i=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(o.nsIConverterInputStream),i.init(n,"utf-8",n.available(),o.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),i.readString(n.available(),a),i.close(),n.close(),t(a.value)}catch(l){throw new Error((s&&s.path||"")+": "+l)}}),n}),function(){console.debug||(console.debug=console.log),console.info||(console.info=console.log),console.warn||(console.warn=console.log),console.error||(console.error=console.log)}(),n("console_shim",function(){}),ReadiumSDK={version:function(){return"0.8.0"},Models:{Smil:{}},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Collections:{},Routers:{},Helpers:{},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"}},navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(e,t){return t&&"1.0"!==t?!1:"dom-manipulation"===e?!0:"layout-changes"===e?!0:"touch-events"===e?!1:"mouse-events"===e?!0:"keyboard-events"===e?!0:"spine-scripting"===e?!0:!1}},_.extend(ReadiumSDK,Backbone.Events),n("readiumSDK",["backbone"],function(e){return function(){var t;return t||e.readiumSDK}}(this)),function(e){var t=function(e){return parseInt(e,10)||0};e.each(["min","max"],function(n,i){e.fn[i+"Size"]=function(e){var n,r;return e?(void 0!==e.width&&this.css(i+"-width",e.width),void 0!==e.height&&this.css(i+"-height",e.height),this):(n=this.css(i+"-width"),r=this.css(i+"-height"),{width:"max"===i&&(void 0===n||"none"===n||-1===t(n))&&Number.MAX_VALUE||t(n),height:"max"===i&&(void 0===r||"none"===r||-1===t(r))&&Number.MAX_VALUE||t(r)})}}),e.fn.isVisible=function(){return this.is(":visible")},e.each(["border","margin","padding"],function(n,i){e.fn[i]=function(e){return e?(void 0!==e.top&&this.css(i+"-top"+("border"===i?"-width":""),e.top),void 0!==e.bottom&&this.css(i+"-bottom"+("border"===i?"-width":""),e.bottom),void 0!==e.left&&this.css(i+"-left"+("border"===i?"-width":""),e.left),void 0!==e.right&&this.css(i+"-right"+("border"===i?"-width":""),e.right),this):{top:t(this.css(i+"-top"+("border"===i?"-width":""))),bottom:t(this.css(i+"-bottom"+("border"===i?"-width":""))),left:t(this.css(i+"-left"+("border"===i?"-width":""))),right:t(this.css(i+"-right"+("border"===i?"-width":"")))}}})}(jQuery),n("jquerySizes",["jquery"],function(e){return function(){var t;return t||e.jquerySizes}}(this)),ReadiumSDK.Helpers.Rect=function(e,t,n,i){this.left=e,this.top=t,this.width=n,this.height=i,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(e,t){return void 0==t&&(t=0),!(e.right()<this.left+t||e.left>this.right()-t||e.bottom()<this.top+t||e.top>this.bottom()-t)}},ReadiumSDK.Helpers.Rect.fromElement=function(e){var t;t=_.isArray(e)||e instanceof jQuery?e[0]:e,3===t.nodeType&&(t=e.parent()[0]);for(var n=t.offsetLeft,i=t.offsetTop,r=t.offsetWidth,o=t.offsetHeight;t=t.offsetParent;)n+=t.offsetLeft,i+=t.offsetTop;return new ReadiumSDK.Helpers.Rect(n,i,r,o)},ReadiumSDK.Helpers.ResolveContentRef=function(e,t){if(!t)return e;var n=t.split("/");n.pop();for(var i=e.split("/");n.length>0&&".."===i[0];)n.pop(),i.splice(0,1);var r=n.concat(i);return r.join("/")},ReadiumSDK.Helpers.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},ReadiumSDK.Helpers.BeginsWith=function(e,t){return 0===e.indexOf(t)},ReadiumSDK.Helpers.RemoveFromString=function(e,t){var n=e.indexOf(t);return-1==n?e:e.substring(0,n)+e.substring(n+t.length)},ReadiumSDK.Helpers.Margins=function(e,t,n){this.margin=e,this.border=t,this.padding=n,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},ReadiumSDK.Helpers.triggerLayout=function(e){var t=e[0].contentDocument;if(t){var n=void 0;try{if(n=t.styleSheets&&t.styleSheets.length?t.styleSheets[0]:void 0,!n){var i=t.createElement("style");t.head.appendChild(i),i.appendChild(t.createTextNode("")),n=i.sheet}n&&n.insertRule("body:first-child::before {content:'READIUM';color: red;font-weight: bold;}",n.cssRules.length)}catch(r){console.error(r)}try{var o=t.createElementNS("http://www.w3.org/1999/xhtml","style");o.appendChild(t.createTextNode("*{}")),t.body.appendChild(o),t.body.removeChild(o),n&&n.deleteRule(n.cssRules.length-1)}catch(r){console.error(r)}if(t.body){t.body.offsetTop}}},ReadiumSDK.Helpers.deduceSyntheticSpread=function(e,t,n){if(!e||0==e.length)return 0;var i=t?t.getRenditionSpread():void 0;if(i===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE)return!1;if("double"==n.syntheticSpread)return!0;if("single"==n.syntheticSpread)return!1;if(!t)return 0;if(i===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH)return!0;var r=ReadiumSDK.Helpers.getOrientation(e);if(i===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE)return r===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;if(i===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT)return r===ReadiumSDK.Views.ORIENTATION_PORTRAIT;if(!i||i===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO){var o=r===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;return o?1:0}return console.warn("ReadiumSDK.Helpers.deduceSyntheticSpread: spread properties?!"),0},ReadiumSDK.Helpers.Margins.fromElement=function(e){return new this(e.margin(),e.border(),e.padding())},ReadiumSDK.Helpers.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},ReadiumSDK.Helpers.loadTemplate=function(e){return ReadiumSDK.Helpers.loadTemplate.cache[e]},ReadiumSDK.Helpers.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe scrolling="no" id="epubContentIframe"></iframe></div>'},ReadiumSDK.Helpers.setStyles=function(e,t){var n=e.length;if(n)for(var i=0;n>i;i++){var r=e[i];r.selector?$(r.selector,t).css(r.declarations):t.css(r.declarations)}},ReadiumSDK.Helpers.isIframeAlive=function(e){var t=void 0,n=void 0;try{t=e.contentWindow,n=e.contentDocument}catch(i){return console.error(i),!1}return t&&n},ReadiumSDK.Helpers.getOrientation=function(e){var t=e.width(),n=e.height();return t&&n?t>=n?ReadiumSDK.Views.ORIENTATION_LANDSCAPE:ReadiumSDK.Views.ORIENTATION_PORTRAIT:void 0},ReadiumSDK.Helpers.isRenditionSpreadPermittedForItem=function(e,t){var n=e.getRenditionSpread();return!n||n==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH||n==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO||n==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE&&t==ReadiumSDK.Views.ORIENTATION_LANDSCAPE||n==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT&&t==ReadiumSDK.Views.ORIENTATION_PORTRAIT},ReadiumSDK.Helpers.CSSTransformString=function(e){var t,n,i,r=e.origin;if(e.left||e.top){var o=e.left||0,a=e.top||0;t="translate("+o+"px, "+a+"px)"}if(e.scale&&(n="scale("+e.scale+")"),e.angle&&(i="rotate("+e.angle+"deg)"),!(t||n||i))return{};var s=t&&n?t+" "+n:t?t:n;i&&(s=s+" "+i);var l={};return _.each(["-webkit-","-moz-","-ms-",""],function(e){l[e+"transform"]=s,l[e+"transform-origin"]=r?r:"0 0"}),l},ReadiumSDK.Helpers.escapeJQuerySelector=function(e){if(!e)return void 0;var t=e.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1");return t},n("helpers",["readiumSDK","jquerySizes"],function(e){return function(){var t;return t||e.helpers}}(this)),ReadiumSDK.Models.ViewerSettings=function(e){function t(e){for(var t=[],n=e.split(/[\s,;]+/),i=0;i<n.length;i++){var r=n[i].trim();""!==r&&t.push(r)}return t}function n(e,t,n){void 0!==t[e]&&(i[e]=n?n(t[e]):t[e])}var i=this;this.syntheticSpread="auto",this.fontSize=100,this.columnGap=20,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!0,this.pageTransition=-1,this.scroll="auto",this.update=function(e){n("columnGap",e),n("fontSize",e),n("mediaOverlaysPreservePlaybackWhenScroll",e),n("mediaOverlaysSkipSkippables",e),n("mediaOverlaysEscapeEscapables",e),n("mediaOverlaysSkippables",e,t),n("mediaOverlaysEscapables",e,t),n("mediaOverlaysEnableClick",e),n("mediaOverlaysRate",e),n("mediaOverlaysVolume",e),n("mediaOverlaysSynchronizationGranularity",e),n("mediaOverlaysAutomaticPageTurn",e),n("scroll",e),n("syntheticSpread",e),n("pageTransition",e),n("enableGPUHardwareAccelerationCSS3D",e)},this.update(e)},n("viewerSettings",["readiumSDK"],function(e){return function(){var t;return t||e.viewerSettings}}(this)),ReadiumSDK.Models.Style=function(e,t){this.selector=e,this.declarations=t,this.setDeclarations=function(e){for(var t in e)e.hasOwnProperty(t)&&(this.declarations[t]=e[t])}},n("style",["readiumSDK"],function(e){return function(){var t;return t||e.style}}(this)),ReadiumSDK.Collections.StyleCollection=function(){var e=[];this.clear=function(){e.length=0},this.findStyle=function(t){for(var n=e.length,i=0;n>i;i++)if(e[i].selector===t)return e[i];return void 0},this.addStyle=function(t,n){var i=this.findStyle(t);return i?i.setDeclarations(n):(i=new ReadiumSDK.Models.Style(t,n),e.push(i)),i},this.removeStyle=function(t){for(var n=e.length,i=0;n>i;i++)if(e[i].selector===t)return void e.splice(i,1)},this.getStyles=function(){return e},this.resetStyleValues=function(){for(var t=e.length,n=0;t>n;n++){var i=e[n],r=i.declarations;for(var o in r)r.hasOwnProperty(o)&&(r[o]="")}}},n("styleCollection",["readiumSDK","style"],function(e){return function(){var t;return t||e.styleCollection}}(this)),ReadiumSDK.Models.SpineItem=function(e,t,n){function i(){o.page_spread&&o.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_LEFT&&o.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_RIGHT&&o.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_CENTER&&console.error(o.page_spread+" is not a recognized spread type")}function r(e,t){return o[e]?o[e]===t:o.spine.package[e]?o.spine.package[e]===t:!1}var o=this;this.idref=e.idref,this.href=e.href,this.linear=e.linear?e.linear.toLowerCase():e.linear,this.page_spread=e.page_spread,this.rendition_viewport=e.rendition_viewport,this.rendition_spread=e.rendition_spread,this.rendition_orientation=e.rendition_orientation,this.rendition_layout=e.rendition_layout,this.rendition_flow=e.rendition_flow,this.media_overlay_id=e.media_overlay_id,this.media_type=e.media_type,this.index=t,this.spine=n,i(),this.setSpread=function(e){this.page_spread=e,i()},this.isRenditionSpreadAllowed=function(){var e=o.getRenditionSpread();return!e||e!=ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return o.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_LEFT},this.isRightPage=function(){return o.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_RIGHT},this.isCenterPage=function(){return o.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_CENTER},this.isReflowable=function(){return!o.isFixedLayout()},this.isFixedLayout=function(){var e=o.getRenditionLayout();if(e){if(o.rendition_layout){if(o.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED)return!0;if(o.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE)return!1}return o.spine.package.isFixedLayout()}return o.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return o.rendition_flow?o.rendition_flow:o.spine.package.rendition_flow},this.getRenditionViewport=function(){return o.rendition_viewport?o.rendition_viewport:o.spine.package.rendition_viewport},this.getRenditionSpread=function(){return o.rendition_spread?o.rendition_spread:o.spine.package.rendition_spread},this.getRenditionOrientation=function(){return o.rendition_orientation?o.rendition_orientation:o.spine.package.rendition_orientation},this.getRenditionLayout=function(){return o.rendition_layout?o.rendition_layout:o.spine.package.rendition_layout},this.isFlowScrolledContinuous=function(){return r("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return r("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC)}},ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE="reflowable",ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_AUTO="auto",ReadiumSDK.Models.SpineItem.SPREAD_LEFT="page-spread-left",ReadiumSDK.Models.SpineItem.SPREAD_RIGHT="page-spread-right",ReadiumSDK.Models.SpineItem.SPREAD_CENTER="page-spread-center",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE="none",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH="both",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO="auto",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_PAGINATED="paginated",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_AUTO="auto",ReadiumSDK.Models.SpineItem.alternateSpread=function(e){return e===ReadiumSDK.Models.SpineItem.SPREAD_LEFT?ReadiumSDK.Models.SpineItem.SPREAD_RIGHT:e===ReadiumSDK.Models.SpineItem.SPREAD_RIGHT?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:e},n("spineItem",["readiumSDK"],function(e){return function(){var t;return t||e.spineItem}}(this)),ReadiumSDK.Models.Spine=function(e,t){function n(e){return!l||"no"!==e.linear}function i(e){if(!o(e))return void 0;var t=s.items[e];return n(t)?t:i(t.index+1)}function r(e){if(!o(e))return void 0;var t=s.items[e];return n(t)?t:r(t.index-1)}function o(e){return e>=0&&e<s.items.length}function a(){for(var e=s.items.length,t=!1,n=s.isLeftToRight()?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:ReadiumSDK.Models.SpineItem.SPREAD_RIGHT,i=0;e>i;i++){var r=s.items[i];if(!r.page_spread){var o=t?n:ReadiumSDK.Models.SpineItem.alternateSpread(n);r.setSpread(o)}t=!r.isRenditionSpreadAllowed()||r.page_spread!=n}}var s=this;this.items=[],this.direction="ltr",this.package=e;var l=!1;if(this.handleLinear=function(e){l=e},this.isValidLinearItem=function(e){return n(this.item(e))},this.prevItem=function(e){return r(e.index-1)},this.nextItem=function(e){return i(e.index+1)},this.getItemUrl=function(e){return s.package.resolveRelativeUrl(e.href)},this.first=function(){return i(0)},this.last=function(){return r(this.items.length-1)},this.isFirstItem=function(e){return s.first()===e},this.isLastItem=function(e){return s.last()===e},this.item=function(e){return o(e)?s.items[e]:void 0},this.isRightToLeft=function(){return"rtl"==s.direction},this.isLeftToRight=function(){return!s.isRightToLeft()},this.getItemById=function(e){for(var t=s.items.length,n=0;t>n;n++)if(s.items[n].idref==e)return s.items[n];return void 0},this.getItemByHref=function(e){for(var t=s.items.length,n=0;t>n;n++)if(s.items[n].href==e)return s.items[n];return void 0},t){t.direction&&(this.direction=t.direction);for(var u=t.items.length,c=0;u>c;c++){var d=new ReadiumSDK.Models.SpineItem(t.items[c],c,this);this.items.push(d)}a()}},n("spine",["readiumSDK","spineItem"],function(e){return function(){var t;return t||e.spine}}(this)),ReadiumSDK.Models.Smil.SmilNode=function(e){this.parent=e,this.id="",this.getSmil=function(){for(var e=this;e.parent;)e=e.parent;return e},this.hasAncestor=function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1}},ReadiumSDK.Models.Smil.TimeContainerNode=function(e){this.parent=e,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.escapables;e.length>0&&(n=e);for(var i=0;i<n.length;i++)if(this.epubtype.indexOf(n[i])>=0)return!0;return!1},this.isSkippable=function(e){if(""===this.epubtype)return!1;var t=this.getSmil();if(!t.mo)return!1;var n=t.mo.skippables;e.length>0&&(n=e);for(var i=0;i<n.length;i++)if(this.epubtype.indexOf(n[i])>=0)return!0;return!1}},ReadiumSDK.Models.Smil.TimeContainerNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.MediaNode=function(e){this.parent=e,this.src=""},ReadiumSDK.Models.Smil.MediaNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.SeqNode=function(e){this.parent=e,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var e=this.getSmil(),t=0,n=0;n<this.children.length;n++){var i=this.children[n];if("par"===i.nodeType){if(!i.audio)continue;if(i.text&&(!i.text.manifestItemId||i.text.manifestItemId!=e.spineItemId))continue;var r=i.audio.clipDurationMilliseconds();t+=r}else"seq"===i.nodeType&&(t+=i.durationMilliseconds())}return t},this.clipOffset=function(e,t){for(var n=this.getSmil(),i=0;i<this.children.length;i++){var r=this.children[i];if("par"===r.nodeType){if(r==t)return!0;if(!r.audio)continue;if(r.text&&(!r.text.manifestItemId||r.text.manifestItemId!=n.spineItemId))continue;var o=r.audio.clipDurationMilliseconds();e.offset+=o}else if("seq"===r.nodeType){var a=r.clipOffset(e,t);if(a)return!0}}return!1},this.parallelAt=function(e){for(var t=this.getSmil(),n=0,i=0;i<this.children.length;i++){var r=e-n,o=this.children[i];if("par"===o.nodeType){if(!o.audio)continue;if(o.text&&(!o.text.manifestItemId||o.text.manifestItemId!=t.spineItemId))continue;var a=o.audio.clipDurationMilliseconds();if(a>0&&a>=r)return o;n+=a}else if("seq"===o.nodeType){var s=o.parallelAt(r);if(s)return s;n+=o.durationMilliseconds()}}return void 0},this.nthParallel=function(e,t){for(var n=0;n<this.children.length;n++){var i=this.children[n];if("par"===i.nodeType){if(t.count++,t.count==e)return i}else if("seq"===i.nodeType){var r=i.nthParallel(e,t);if(r)return r}}return void 0}},ReadiumSDK.Models.Smil.SeqNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.ParNode=function(e){this.parent=e,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(e,t){if(!e)return void 0;for(var n=t?this:this.parent;n;){if(n.epubtype&&n.epubtype.indexOf(e)>=0)return n;n=n.parent}return void 0}},ReadiumSDK.Models.Smil.ParNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.TextNode=function(e){this.parent=e,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var e=this.getSmil();if(e.href&&e.href.length){for(var t=this.srcFile?this.srcFile:this.src,n=ReadiumSDK.Helpers.ResolveContentRef(t,e.href),i=e.mo.package.resolveRelativeUrlMO(n),r=0;r<e.mo.package.spine.items.length;r++){var o=e.mo.package.spine.items[r],a=e.mo.package.resolveRelativeUrl(o.href);if(a===i)return void(this.manifestItemId=o.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+e.href)}}},ReadiumSDK.Models.Smil.TextNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.Smil.AudioNode=function(e){this.parent=e,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var e=1e3*this.clipBegin,t=1e3*this.clipEnd;return this.clipEnd>=this.MAX||e>=t?0:t-e}},ReadiumSDK.Models.Smil.AudioNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.SmilModel=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(e){return this.children[0].parallelAt(e)},this.nthParallel=function(e){var t={count:-1};return this.children[0].nthParallel(e,t)},this.clipOffset=function(e){var t={offset:0};return this.children[0].clipOffset(t,e)?t.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var e=[];this.hasSync=function(t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1},this.addSync=function(t){if(t)for(var n=t.split(" "),i=0;i<n.length;i++){var r=n[i].trim();r.length>0&&!this.hasSync(r)&&e.push(r)}}},ReadiumSDK.Models.SmilModel.fromSmilDTO=function(e,t){t.DEBUG&&console.debug("Media Overlay DTO import...");var n=0,i=function(){for(var e="",t=0;n>t;t++)e+="   ";return e},r=new ReadiumSDK.Models.SmilModel;r.id=e.id,r.spineItemId=e.spineItemId,r.href=e.href,r.smilVersion=e.smilVersion,r.duration=e.duration,r.duration&&r.duration.length&&r.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+r.duration+")"),r.duration=parseFloat(r.duration)),r.mo=t,r.mo.DEBUG&&(console.log("JS MO smilVersion="+r.smilVersion),console.log("JS MO id="+r.id),console.log("JS MO spineItemId="+r.spineItemId),console.log("JS MO href="+r.href),console.log("JS MO duration="+r.duration));var o=function(e,t,n,o){e in t?(e in n||console.debug("property "+e+" not declared in smil node "+n.nodeType),n[e]=t[e],r.mo.DEBUG&&console.log(i()+"JS MO: ["+e+"="+n[e]+"]")):o&&console.log("Required property "+e+" not found in smil node "+t.nodeType)},a=function(e,t){var a;if("seq"==e.nodeType)r.mo.DEBUG&&console.log(i()+"JS MO seq"),a=new ReadiumSDK.Models.Smil.SeqNode(t),o("textref",e,a,t&&t.parent?!0:!1),o("id",e,a),o("epubtype",e,a),a.epubtype&&a.getSmil().addSync(a.epubtype),n++,s(e,a),n--;else if("par"==e.nodeType){r.mo.DEBUG&&console.log(i()+"JS MO par"),a=new ReadiumSDK.Models.Smil.ParNode(t),o("id",e,a),o("epubtype",e,a),a.epubtype&&a.getSmil().addSync(a.epubtype),n++,s(e,a),n--;for(var l=0,u=a.children.length;u>l;l++){var c=a.children[l];"text"==c.nodeType?a.text=c:"audio"==c.nodeType?a.audio=c:console.error("Unexpected smil node type: "+c.nodeType)}var d=!1;if(d||!a.audio){var f=new ReadiumSDK.Models.Smil.AudioNode(a);f.clipBegin=0,f.clipEnd=f.MAX,f.src=void 0,a.audio=f}}else if("text"==e.nodeType)r.mo.DEBUG&&console.log(i()+"JS MO text"),a=new ReadiumSDK.Models.Smil.TextNode(t),o("src",e,a,!0),o("srcFile",e,a,!0),o("srcFragmentId",e,a,!1),o("id",e,a),a.updateMediaManifestItemId();else{if("audio"!=e.nodeType)return void console.error("Unexpected smil node type: "+e.nodeType);r.mo.DEBUG&&console.log(i()+"JS MO audio"),a=new ReadiumSDK.Models.Smil.AudioNode(t),o("src",e,a,!0),o("id",e,a),o("clipBegin",e,a),a.clipBegin&&a.clipBegin.length&&a.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+a.clipBegin+")"),a.clipBegin=parseFloat(a.clipBegin)),a.clipBegin<0&&(r.mo.DEBUG&&console.log(i()+"JS MO clipBegin adjusted to ZERO"),a.clipBegin=0),o("clipEnd",e,a),a.clipEnd&&a.clipEnd.length&&a.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+a.clipEnd+")"),a.clipEnd=parseFloat(a.clipEnd)),a.clipEnd<=a.clipBegin&&(r.mo.DEBUG&&console.log(i()+"JS MO clipEnd adjusted to MAX"),a.clipEnd=a.MAX)}return a},s=function(e,t){for(var n=e.children.length,i=0;n>i;i++){var r=a(e.children[i],t);r.index=i,t.children.push(r)}};return s(e,r),r},n("smilModel",["readiumSDK"],function(e){return function(){var t;return t||e.smilModel}}(this)),ReadiumSDK.Models.MediaOverlay=function(e){this.package=e,this.parallelAt=function(e){for(var t=0,n=0;n<this.smil_models.length;n++){var i=this.smil_models[n],r=e-t,o=i.parallelAt(r);if(o)return o;t+=i.durationMilliseconds_Calculated()}return void 0},this.percentToPosition=function(e,t,n,i){(0>e||e>100)&&(e=0);var r=this.durationMilliseconds_Calculated(),o=r*(e/100);if(n.par=this.parallelAt(o),n.par){var a=n.par.getSmil();if(a){for(var s=0,l=0;l<this.smil_models.length&&(t.smilData=this.smil_models[l],t.smilData!=a);l++)s+=t.smilData.durationMilliseconds_Calculated();i.milliseconds=o-(s+t.smilData.clipOffset(n.par))}}},this.durationMilliseconds_Calculated=function(){for(var e=0,t=0;t<this.smil_models.length;t++){var n=this.smil_models[t];e+=n.durationMilliseconds_Calculated()}return e},this.smilAt=function(e){return 0>e||e>=this.smil_models.length?void 0:this.smil_models[e]},this.positionToPercent=function(e,t,n){if(e>=this.smil_models.length)return-1;for(var i=0,r=0;e>r;r++){var o=this.smil_models[r];i+=o.durationMilliseconds_Calculated()
}var a=this.smil_models[e],s=a.nthParallel(t);if(!s)return-1;var l=i+a.clipOffset(s)+n,u=this.durationMilliseconds_Calculated(),c=l/u*100;return c},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=!1,this.getSmilBySpineItem=function(e){if(!e)return void 0;for(var t=0,n=this.smil_models.length;n>t;t++){var i=this.smil_models[t];if(i.spineItemId===e.idref)return e.media_overlay_id!==i.id&&console.error("SMIL INCORRECT ID?? "+e.media_overlay_id+" /// "+i.id),i}return void 0},this.getNextSmil=function(e){var t=this.smil_models.indexOf(e);return-1==t||t==this.smil_models.length-1?void 0:this.smil_models[t+1]},this.getPreviousSmil=function(e){var t=this.smil_models.indexOf(e);return-1==t||0==t?void 0:this.smil_models[t-1]}},ReadiumSDK.Models.MediaOverlay.fromDTO=function(e,t){var n=new ReadiumSDK.Models.MediaOverlay(t);if(!e)return console.debug("No Media Overlay."),n;console.debug("Media Overlay INIT..."),n.duration=e.duration,n.duration&&n.duration.length&&n.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+n.duration+")"),n.duration=parseFloat(n.duration)),n.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+n.duration),n.narrator=e.narrator,n.DEBUG&&console.debug("Media Overlay Narrator: "+n.narrator),n.activeClass=e.activeClass,n.DEBUG&&console.debug("Media Overlay Active-Class: "+n.activeClass),n.playbackActiveClass=e.playbackActiveClass,n.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+n.playbackActiveClass);var i=e.smil_models.length;n.DEBUG&&console.debug("Media Overlay SMIL count: "+i);for(var r=0;i>r;r++){var o=ReadiumSDK.Models.SmilModel.fromSmilDTO(e.smil_models[r],n);n.smil_models.push(o),n.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+o.duration)}i=e.skippables.length,n.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+i);for(var r=0;i>r;r++)n.skippables.push(e.skippables[r]);i=e.escapables.length,n.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+i);for(var r=0;i>r;r++)n.escapables.push(e.escapables[r]);return n},n("mediaOverlay",["readiumSDK","smilModel"],function(e){return function(){var t;return t||e.mediaOverlay}}(this)),ReadiumSDK.Models.Package=function(e){var t=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(e){return t.rootUrlMO&&t.rootUrlMO.length>0?ReadiumSDK.Helpers.EndsWith(t.rootUrlMO,"/")?t.rootUrlMO+e:t.rootUrlMO+"/"+e:t.resolveRelativeUrl(e)},this.resolveRelativeUrl=function(e){return t.rootUrl?ReadiumSDK.Helpers.EndsWith(t.rootUrl,"/")?t.rootUrl+e:t.rootUrl+"/"+e:e},this.isFixedLayout=function(){return t.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!t.isFixedLayout()},e&&(this.rootUrl=e.rootUrl,this.rootUrlMO=e.rootUrlMO,this.rendition_viewport=e.rendition_viewport,this.rendition_layout=e.rendition_layout,this.rendition_flow=e.rendition_flow,this.rendition_orientation=e.rendition_orientation,this.rendition_spread=e.rendition_spread,this.spine=new ReadiumSDK.Models.Spine(this,e.spine),this.media_overlay=ReadiumSDK.Models.MediaOverlay.fromDTO(e.media_overlay,this))},n("package",["readiumSDK","spine","mediaOverlay"],function(e){return function(){var t;return t||e.package}}(this)),function(){var e=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,t=navigator.userAgent.toLowerCase().indexOf("android")>-1,n=!1,i=new Audio;n&&(i.addEventListener("load",function(){console.debug("0) load")}),i.addEventListener("loadstart",function(){console.debug("1) loadstart")}),i.addEventListener("durationchange",function(){console.debug("2) durationchange")}),i.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),i.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),i.addEventListener("progress",function(){console.debug("5) progress")}),i.addEventListener("canplay",function(){console.debug("6) canplay")}),i.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),i.addEventListener("play",function(){console.debug("8) play")}),i.addEventListener("pause",function(){console.debug("9) pause")}),i.addEventListener("ended",function(){console.debug("10) ended")}),i.addEventListener("seeked",function(){console.debug("X) seeked")}),i.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")})),ReadiumSDK.Views.AudioPlayer=function(r,o,a,s,l){function u(){r({isPlaying:!0}),s()}function c(){l(),r({isPlaying:!1})}function d(){return i.moSeeking?void(n&&console.debug("onEnded() skipped (still seeking...)")):(h(),a(),void r({isPlaying:!1}))}function f(){C||(C=setInterval(function(){if(i.moSeeking)return n&&console.debug("interval timer skipped (still seeking...)"),w++,void(w>1e3&&(w=0,h()));var e=i.currentTime;o(e,1)},20))}function h(){C&&clearInterval(C),C=void 0}function g(e){$(i).off(x,g),n&&console.debug("onReadyToSeek #"+e.data.playId),p(e.data.seekBegin,e.data.playId,!0)}function p(e,t,r){if(n&&console.debug("playSeekCurrentTime() #"+t),0==e&&(e=.01),Math.abs(e-i.currentTime)<.3)return n&&console.debug("playSeekCurrentTime() CONTINUE"),i.moSeeking=void 0,void v.play();var o=r?O:_;n&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+o),v.pause(),$(i).on(o,{newCurrentTime:e,playId:t,isNewSrc:r},m);try{i.currentTime=e}catch(a){console.error(a.message),setTimeout(function(){try{i.currentTime=e}catch(t){console.error(t.message)}},5)}}function m(e){var t=e.data.isNewSrc?O:_,r=void 0==e.data.seekRetries;(r||e.data.seekRetries==D)&&$(i).off(t,m),n&&console.debug("onSeeked() #"+e.data.playId+" FIRST? "+r+" EV: "+t);var o=i.currentTime,a=Math.abs(e.data.newCurrentTime-o);if((r||e.data.seekRetries>=0)&&a>=1)n&&console.debug("onSeeked() time diff: "+e.data.newCurrentTime+" vs. "+o+" ("+a+")"),r&&(e.data.seekRetries=D,e.data.isNewSrc=!1),e.data.seekRetries--,n&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){m(e)},50),setTimeout(function(){try{i.pause(),setTimeout(function(){i.currentTime=e.data.newCurrentTime},0)}catch(t){console.error(t.message),setTimeout(function(){try{i.pause(),setTimeout(function(){i.currentTime=e.data.newCurrentTime},0)}catch(t){console.error(t.message)}},4)}},5);else{if(n&&(console.debug("onSeeked() STATE:"),console.debug(r),console.debug(e.data.seekRetries),console.debug(a)),a>=1){n&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var s=y,l=S,u=e.data.newCurrentTime;return v.reset(),void setTimeout(function(){v.playFile(s,l,u)},10)}n&&console.debug("onSeeked() OKAY => play!"),e.data.seekRetries=void 0,v.play(),i.moSeeking=void 0}}var v=this,S=void 0,y=void 0;this.currentSmilSrc=function(){return y};var R=1;this.setRate=function(e){R=e,.5>R&&(R=.5),R>4&&(R=4),i.playbackRate=R},v.setRate(R),this.getRate=function(){return R};var I=100;this.setVolume=function(e){I=e,0>I&&(I=0),I>1&&(I=1),i.volume=I},v.setVolume(I),this.getVolume=function(){return I},this.play=function(){return n&&console.error("this.play()"),S?(f(),v.setVolume(I),v.setRate(R),i.play(),!0):!1},this.pause=function(){n&&console.error("this.pause()"),h(),i.pause()},i.addEventListener("play",u,!1),i.addEventListener("pause",c,!1),i.addEventListener("ended",d,!1);var w=0,C=void 0;this.isPlaying=function(){return void 0!==C},this.reset=function(){n&&console.error("this.reset()"),this.pause(),i.moSeeking=void 0,y=void 0,S=void 0,setTimeout(function(){i.setAttribute("src","")},1)},i.addEventListener("loadstart",function(){E=!0});var E=!1;this.touchInit=function(){return e?E?!1:(E=!0,i.setAttribute("src","touch/init/html5/audio.mp3"),i.load(),!0):!1};var T=0,b=0;this.playFile=function(e,r,o){T++,T>99999&&(T=0);var a=T;if(i.moSeeking)return b++,b>D?void(b=0):(n&&console.debug("this.playFile("+r+") @"+o+" (POSTPONE, SEEKING...)"),void setTimeout(function(){v.playFile(e,r,o)},20));i.moSeeking={},n&&console.debug("this.playFile("+r+") @"+o+" #"+a);var s=!S||S!==r;return s?(n&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+S),console.debug("epubSrc: "+r)),this.reset(),i.moSeeking={},y=e,S=r,t||i.addEventListener("play",N,!1),$(i).on(x,{seekBegin:o,playId:a},g),void setTimeout(function(){i.setAttribute("src",S),i.load(),t||P()},1)):(n&&console.debug("this.playFile() SAME SRC"),this.pause(),y=e,S=r,void p(o,a,!1))};var P=function(){n&&console.debug("playToForcePreload");var e=I;I=0,v.play(),I=e},N=function(){i.removeEventListener("play",N,!1),n&&console.debug("onPlayToForcePreload"),i.pause()},x=t?"canplaythrough":"canplay",D=10,O=e?"canplaythrough":"seeked",_=e?"timeupdate":"seeked"}}(),n("audioPlayer",["readiumSDK"],function(e){return function(){var t;return t||e.audioPlayer}}(this)),n("domReady",[],function(){function e(e){var t;for(t=0;t<e.length;t+=1)e[t](u)}function t(){var t=c;l&&t.length&&(c=[],e(t))}function n(){l||(l=!0,a&&clearInterval(a),t())}function i(e){return l?e(u):c.push(e),i}var r,o,a,s="undefined"!=typeof window&&window.document,l=!s,u=s?document:null,c=[];if(s){if(document.addEventListener)document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1);else if(window.attachEvent){window.attachEvent("onload",n),o=document.createElement("div");try{r=null===window.frameElement}catch(d){}o.doScroll&&r&&window.external&&(a=setInterval(function(){try{o.doScroll(),n()}catch(e){}},30))}"complete"===document.readyState&&n()}return i.version="2.0.1",i.load=function(e,t,n,r){r.isBuild?n(null):i(n)},i}),function(e){function t(e,t){var n=typeof e[t];return n==y||!(n!=S||!e[t])||"unknown"==n}function n(e,t){return!(typeof e[t]!=S||!e[t])}function i(e,t){return typeof e[t]!=R}function r(e){return function(t,n){for(var i=n.length;i--;)if(!e(t,n[i]))return!1;return!0}}function o(e){return e&&T(e,E)&&P(e,C)}function a(e){return n(e,"body")?e.body:e.getElementsByTagName("body")[0]}function s(e){n(window,"console")&&t(window.console,"log")&&window.console.log(e)}function l(e,t){t?window.alert(e):s(e)}function u(e){x.initialized=!0,x.supported=!1,l("Rangy is not supported on this page in your browser. Reason: "+e,x.config.alertOnFail)}function c(e){l("Rangy warning: "+e,x.config.alertOnWarn)}function d(e){return e.message||e.description||String(e)}function f(){if(!x.initialized){var e,n=!1,i=!1;t(document,"createRange")&&(e=document.createRange(),T(e,w)&&P(e,I)&&(n=!0),e.detach());var r=a(document);if(!r||"body"!=r.nodeName.toLowerCase())return void u("No body element found");if(r&&t(r,"createTextRange")&&(e=r.createTextRange(),o(e)&&(i=!0)),!n&&!i)return void u("Neither Range nor TextRange are available");x.initialized=!0,x.features={implementsDomRange:n,implementsTextRange:i};var l,c;for(var f in N)(l=N[f])instanceof g&&l.init(l,x);for(var h=0,p=O.length;p>h;++h)try{O[h](x)}catch(m){c="Rangy init listener threw an exception. Continuing. Detail: "+d(m),s(c)}}}function h(e){e=e||window,f();for(var t=0,n=_.length;n>t;++t)_[t](e)}function g(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function p(e,t,n,i){var r=new g(t,n,function(e){if(!e.initialized){e.initialized=!0;try{i(x,e),e.supported=!0}catch(n){var r="Module '"+t+"' failed to load: "+d(n);s(r)}}});N[t]=r}function m(){}function v(){}var S=("function"==typeof e.define&&e.define.amd,"object"),y="function",R="undefined",I=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],w=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],C=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],E=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],T=r(t),b=r(n),P=r(i),N={},x={version:"1.3alpha.804",initialized:!1,supported:!0,util:{isHostMethod:t,isHostObject:n,isHostProperty:i,areHostMethods:T,areHostObjects:b,areHostProperties:P,isTextRange:o,getBody:a},features:{},modules:N,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};x.fail=u,x.warn=c,{}.hasOwnProperty?x.util.extend=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&x.util.extend(i,r,!0),e[o]=r);return e}:u("hasOwnProperty not supported"),function(){var e=document.createElementNS("http://www.w3.org/1999/xhtml","div");e.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(i){}t||(t=function(e){for(var t=[],n=0,i=e.length;i>n;++n)t[n]=e[n];return t}),x.util.toArray=t}();var D;t(document,"addEventListener")?D=function(e,t,n){e.addEventListener(t,n,!1)}:t(document,"attachEvent")?D=function(e,t,n){e.attachEvent("on"+t,n)}:u("Document does not have required addEventListener or attachEvent method"),x.util.addListener=D;var O=[];x.init=f,x.addInitListener=function(e){x.initialized?e(x):O.push(e)};var _=[];x.addCreateMissingNativeApiListener=function(e){_.push(e)},x.createMissingNativeApi=h,g.prototype={init:function(){for(var e,t,n=this.dependencies||[],i=0,r=n.length;r>i;++i){if(t=n[i],e=N[t],!(e&&e instanceof g))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){x.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){x.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},x.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]),p(!1,e,n,t)},x.createCoreModule=function(e,t,n){p(!0,e,t,n)},x.RangePrototype=m,x.rangePrototype=new m,x.selectionPrototype=new v;var A=!1,M=function(){A||(A=!0,x.initialized||f())};return typeof window==R?void u("No window found"):typeof document==R?void u("No document found"):(t(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",M,!1),D(window,"load",M),void(e.rangy=x))}(this),rangy.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==x||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function i(e){var t=e.parentNode;return 1==t.nodeType?t:null}function r(e){for(var t=0;e=e.previousSibling;)++t;return t}function o(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,i=[];for(n=e;n;n=n.parentNode)i.push(n);for(n=t;n;n=n.parentNode)if(A(i,n))return n;return null}function s(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function l(e,t){return s(e,t,!0)}function u(e,t,n){for(var i,r=n?e:e.parentNode;r;){if(i=r.parentNode,i===t)return r;r=i}return null}function c(e){var t=e.nodeType;return 3==t||4==t||8==t}function d(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function f(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function h(e,t,n){var i=e.cloneNode(!1);if(i.deleteData(0,t),e.deleteData(t,e.length-t),f(i,e),n)for(var o,a=0;o=n[a++];)o.node==e&&o.offset>t?(o.node=i,o.offset-=t):o.node==e.parentNode&&o.offset>r(e)&&++o.offset;return i}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=x)return e.ownerDocument;if(typeof e.document!=x)return e.document;if(e.parentNode)return g(e.parentNode);throw t.createError("getDocument: no document found for node")}function p(e){var n=g(e);if(typeof n.defaultView!=x)return n.defaultView;if(typeof n.parentWindow!=x)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function m(e){if(typeof e.contentDocument!=x)return e.contentDocument;if(typeof e.contentWindow!=x)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=x)return e.contentWindow;if(typeof e.contentDocument!=x)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function S(e){return e&&D.isHostMethod(e,"setTimeout")&&D.isHostObject(e,"document")}function y(e,t,n){var i;if(e?D.isHostProperty(e,"nodeType")?i=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?m(e):g(e):S(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i}function R(e){for(var t;t=e.parentNode;)e=t;return e}function I(e,n,i,o){var s,l,c,d,f;if(e==i)return n===o?0:o>n?-1:1;if(s=u(i,e,!0))return n<=r(s)?-1:1;if(s=u(e,i,!0))return r(s)<o?-1:1;if(l=a(e,i),!l)throw new Error("comparePoints error: nodes have no common ancestor");if(c=e===l?l:u(e,l,!0),d=i===l?l:u(i,l,!0),c===d)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(f=l.firstChild;f;){if(f===c)return-1;if(f===d)return 1;f=f.nextSibling}}function w(e){try{return e.parentNode,!1}catch(t){return!0}}function C(e){if(!e)return"[No node]";if(M&&w(e))return"[Broken node]";if(c(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">["+r(e)+"]["+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function E(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function T(e){this.root=e,this._next=e}function b(e){return new T(e)}function P(e,t){this.node=e,this.offset=t}function N(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var x="undefined",D=e.util;D.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),D.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var O=document.createElementNS("http://www.w3.org/1999/xhtml","div");D.areHostMethods(O,["insertBefore","appendChild","cloneNode"]||!D.areHostObjects(O,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),D.isHostProperty(O,"innerHTML")||t.fail("Element is missing innerHTML property");var _=document.createTextNode("test");D.areHostMethods(_,["splitText","deleteData","insertData","appendData","cloneNode"]||!D.areHostObjects(O,["previousSibling","nextSibling","childNodes","parentNode"])||!D.areHostProperties(_,["data"]))||t.fail("Incomplete Text Node implementation");var A=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},M=!1;!function(){var t=document.createElementNS("http://www.w3.org/1999/xhtml","b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br>",M=w(n),e.features.crashyTextNodes=M}();var k;typeof window.getComputedStyle!=x?k=function(e,t){return p(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=x?k=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),T.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},P.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+C(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},N.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},N.prototype.toString=function(){return this.message},e.dom={arrayContains:A,isHtmlNamespace:n,parentElement:i,getNodeIndex:r,getNodeLength:o,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:l,getClosestAncestorIn:u,isCharacterDataNode:c,isTextOrCommentNode:d,insertAfter:f,splitDataNode:h,getDocument:g,getWindow:p,getIframeWindow:v,getIframeDocument:m,getBody:D.getBody,isWindow:S,getContentDocument:y,getRootContainer:R,comparePoints:I,isBrokenNode:w,inspectNode:C,getComputedStyleProperty:k,fragmentFromNodeChildren:E,createIterator:b,DomPosition:P},e.DOMException=N}),rangy.createCoreModule("DomRange",["DomUtil"],function(e){function t(e,t){return 3!=e.nodeType&&(U(e,t.startContainer)||U(e,t.endContainer))}function n(e){return e.document||$(e.startContainer)}function i(e){return new B(e.parentNode,K(e))}function r(e){return new B(e.parentNode,K(e)+1)}function o(e,t,n){var i=11==e.nodeType?e.firstChild:e;return H(t)?n==t.length?L.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:G(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function a(e,t,i){if(b(e),b(t),n(t)!=n(e))throw new V("WRONG_DOCUMENT_ERR");var r=W(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=W(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return i?0>=r&&o>=0:0>r&&o>0}function s(e){for(var t,i,r,o=n(e.range).createDocumentFragment();i=e.next();){if(t=e.isPartiallySelectedSubtree(),i=i.cloneNode(!t),t&&(r=e.getSubtreeIterator(),i.appendChild(s(r)),r.detach(!0)),10==i.nodeType)throw new V("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}function l(e,t,n){var i,r;n=n||{stop:!1};for(var o,a;o=e.next();)if(e.isPartiallySelectedSubtree()){if(t(o)===!1)return void(n.stop=!0);if(a=e.getSubtreeIterator(),l(a,t,n),a.detach(!0),n.stop)return}else for(i=L.createIterator(o);r=i.next();)if(t(r)===!1)return void(n.stop=!0)}function u(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),u(t),t.detach(!0)):e.remove()}function c(e){for(var t,i,r=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),i=e.getSubtreeIterator(),t.appendChild(c(i)),i.detach(!0)):e.remove(),10==t.nodeType)throw new V("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function d(e,t,n){var i,r=!(!t||!t.length),o=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var a=[];return l(new h(e,!1),function(t){if(!(r&&!i.test(t.nodeType)||o&&!n(t))){var s=e.startContainer;if(t!=s||!H(s)||e.startOffset!=s.length){var l=e.endContainer;t==l&&H(l)&&0==e.endOffset||a.push(t)}}}),a}function f(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+L.inspectNode(e.startContainer)+":"+e.startOffset+", "+L.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function h(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&H(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||H(this.sc)?j(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||H(this.ec)?j(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function g(e){this.code=this[e],this.codeName=e,this.message="RangeException: "+this.codeName}function p(e){return function(t,n){for(var i,r=n?t:t.parentNode;r;){if(i=r.nodeType,z(e,i))return r;r=r.parentNode}return null}}function m(e,t){if(rt(e,t))throw new g("INVALID_NODE_TYPE_ERR")}function v(e){if(!e.startContainer)throw new V("INVALID_STATE_ERR")}function S(e,t){if(!z(t,e.nodeType))throw new g("INVALID_NODE_TYPE_ERR")}function y(e,t){if(0>t||t>(H(e)?e.length:e.childNodes.length))throw new V("INDEX_SIZE_ERR")}function R(e,t){if(nt(e,!0)!==nt(t,!0))throw new V("WRONG_DOCUMENT_ERR")}function I(e){if(it(e,!0))throw new V("NO_MODIFICATION_ALLOWED_ERR")}function w(e,t){if(!e)throw new V(t)}function C(e){return J&&L.isBrokenNode(e)||!z(Z,e.nodeType)&&!nt(e,!0)}function E(e,t){return t<=(H(e)?e.length:e.childNodes.length)}function T(e){return!!e.startContainer&&!!e.endContainer&&!C(e.startContainer)&&!C(e.endContainer)&&E(e.startContainer,e.startOffset)&&E(e.endContainer,e.endOffset)}function b(e){if(v(e),!T(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function P(e,t){b(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,a=n===r;H(r)&&o>0&&o<r.length&&G(r,o,t),H(n)&&i>0&&i<n.length&&(n=G(n,i,t),a?(o-=i,r=n):r==n.parentNode&&o>=K(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}function N(e){e.START_TO_START=ct,e.START_TO_END=dt,e.END_TO_END=ft,e.END_TO_START=ht,e.NODE_BEFORE=gt,e.NODE_AFTER=pt,e.NODE_BEFORE_AND_AFTER=mt,e.NODE_INSIDE=vt}function x(e){N(e),N(e.prototype)}function D(e,t){return function(){b(this);var n,i,o=this.startContainer,a=this.startOffset,s=this.commonAncestorContainer,u=new h(this,!0);o!==s&&(n=j(o,s,!0),i=r(n),o=i.node,a=i.offset),l(u,I),u.reset();var c=e(u);return u.detach(),t(this,o,a,o,a),c}}function O(n,o,a){function s(e,t){return function(n){v(this),S(n,Y),S(X(n),Z);var o=(e?i:r)(n);(t?l:d)(this,o.node,o.offset)}}function l(e,t,n){var i=e.endContainer,r=e.endOffset;(t!==e.startContainer||n!==e.startOffset)&&((X(t)!=X(i)||1==W(t,n,i,r))&&(i=t,r=n),o(e,t,n,i,r))}function d(e,t,n){var i=e.startContainer,r=e.startOffset;(t!==e.endContainer||n!==e.endOffset)&&((X(t)!=X(i)||-1==W(t,n,i,r))&&(i=t,r=n),o(e,i,r,t,n))}var f=function(){};f.prototype=e.rangePrototype,n.prototype=new f,F.extend(n.prototype,{setStart:function(e,t){v(this),m(e,!0),y(e,t),l(this,e,t)},setEnd:function(e,t){v(this),m(e,!0),y(e,t),d(this,e,t)},setStartAndEnd:function(){v(this);var e=arguments,t=e[0],n=e[1],i=t,r=n;switch(e.length){case 3:r=e[2];break;case 4:i=e[2],r=e[3]}o(this,t,n,i,r)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:s(!0,!0),setStartAfter:s(!1,!0),setEndBefore:s(!0,!1),setEndAfter:s(!1,!1),collapse:function(e){b(this),e?o(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):o(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){v(this),m(e,!0),o(this,e,0,e,q(e))},selectNode:function(e){v(this),m(e,!1),S(e,Y);var t=i(e),n=r(e);o(this,t.node,t.offset,n.node,n.offset)},extractContents:D(c,o),deleteContents:D(u,o),canSurroundContents:function(){b(this),I(this.startContainer),I(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},detach:function(){a(this)},splitBoundaries:function(){P(this)},splitBoundariesPreservingPositions:function(e){P(this,e)},normalizeBoundaries:function(){b(this);var e=this.startContainer,t=this.startOffset,n=this.endContainer,i=this.endOffset,r=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(n=e,i=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},a=function(r){var o=r.previousSibling;if(o&&o.nodeType==r.nodeType){e=r;var a=r.length;if(t=o.length,r.insertData(0,o.data),o.parentNode.removeChild(o),e==n)i+=t,n=e;else if(n==r.parentNode){var s=K(r);i==s?(n=r,i=a):i>s&&i--}}},s=!0;if(H(n))n.length==i&&r(n);else{if(i>0){var l=n.childNodes[i-1];l&&H(l)&&r(l)}s=!this.collapsed}if(s){if(H(e))0==t&&a(e);else if(t<e.childNodes.length){var u=e.childNodes[t];u&&H(u)&&a(u)}}else e=n,t=i;o(this,e,t,n,i)},collapseToPoint:function(e,t){v(this),m(e,!0),y(e,t),this.setStartAndEnd(e,t)}}),x(n)}function _(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:L.getCommonAncestor(e.startContainer,e.endContainer)}function A(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=L.getDocument(t),_(e)}function M(e){v(e),e.startContainer=e.startOffset=e.endContainer=e.endOffset=e.document=null,e.collapsed=e.commonAncestorContainer=null}function k(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,_(this)}var L=e.dom,F=e.util,B=L.DomPosition,V=e.DOMException,H=L.isCharacterDataNode,K=L.getNodeIndex,U=L.isOrIsAncestorOf,$=L.getDocument,W=L.comparePoints,G=L.splitDataNode,j=L.getClosestAncestorIn,q=L.getNodeLength,z=L.arrayContains,X=L.getRootContainer,J=e.features.crashyTextNodes;h.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,H(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!H(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new k(n(this.range));var t=this._current,i=t,r=0,o=t,a=q(t);U(t,this.sc)&&(i=this.sc,r=this.so),U(t,this.ec)&&(o=this.ec,a=this.eo),A(e,i,r,o,a)}return new h(e,this.clonePartiallySelectedTextNodes)},detach:function(e){e&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},g.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},g.prototype.toString=function(){return this.message};var Y=[1,3,4,5,7,8,10],Z=[2,9,11],Q=[5,6,10,12],et=[1,3,4,5,7,8,10,11],tt=[1,3,4,5,7,8],nt=p([9,11]),it=p(Q),rt=p([6,10,12]),ot=document.createElementNS("http://www.w3.org/1999/xhtml","style"),at=!1;try{ot.innerHTML="<b>x</b>",at=3==ot.firstChild.nodeType}catch(st){}e.features.htmlParsingConforms=at;var lt=at?function(e){var t=this.startContainer,n=$(t);if(!t)throw new V("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:H(t)&&(i=L.parentElement(t)),i=null===i||"HTML"==i.nodeName&&L.isHtmlNamespace($(i).documentElement)&&L.isHtmlNamespace(i)?n.createElementNS("http://www.w3.org/1999/xhtml","body"):i.cloneNode(!1),i.innerHTML=e,L.fragmentFromNodeChildren(i)}:function(e){v(this);var t=n(this),i=t.createElementNS("http://www.w3.org/1999/xhtml","body");return i.innerHTML=e,L.fragmentFromNodeChildren(i)},ut=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ct=0,dt=1,ft=2,ht=3,gt=0,pt=1,mt=2,vt=3;F.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){b(this),R(this.startContainer,t.startContainer);var n,i,r,o,a=e==ht||e==ct?"start":"end",s=e==dt||e==ct?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],r=t[s+"Container"],o=t[s+"Offset"],W(n,i,r,o)},insertNode:function(e){if(b(this),S(e,et),I(this.startContainer),U(e,this.startContainer))throw new V("HIERARCHY_REQUEST_ERR");var t=o(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){b(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&H(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var i=new h(this,!0);return e=s(i),i.detach(),e},canSurroundContents:function(){b(this),I(this.startContainer),I(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(S(e,tt),!this.canSurroundContents())throw new g("BAD_BOUNDARYPOINTS_ERR");
var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);o(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){b(this);for(var e,t=new k(n(this)),i=ut.length;i--;)e=ut[i],t[e]=this[e];return t},toString:function(){b(this);var e=this.startContainer;if(e===this.endContainer&&H(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new h(this,!0);return l(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){b(this);var t=e.parentNode,n=K(e);if(!t)throw new V("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return 0>i?r>0?mt:gt:r>0?pt:vt},comparePoint:function(e,t){return b(this),w(e,"HIERARCHY_REQUEST_ERR"),R(e,this.startContainer),W(e,t,this.startContainer,this.startOffset)<0?-1:W(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:lt,toHtml:function(){b(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(b(this),w(e,"NOT_FOUND_ERR"),$(e)!==n(this))return!1;var i=e.parentNode,r=K(e);w(i,"NOT_FOUND_ERR");var o=W(i,r,this.endContainer,this.endOffset),a=W(i,r+1,this.startContainer,this.startOffset);return t?0>=o&&a>=0:0>o&&a>0},isPointInRange:function(e,t){return b(this),w(e,"HIERARCHY_REQUEST_ERR"),R(e,this.startContainer),W(e,t,this.startContainer,this.startOffset)>=0&&W(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return a(this,e,!1)},intersectsOrTouchesRange:function(e){return a(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=W(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=W(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==W(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==W(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new g("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==vt},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,q(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var i=n.pop();t.setEnd(i,i.length);var r=this.containsRange(t);return t.detach(),r}return this.containsNodeContents(e)},getNodes:function(e,t){return b(this),d(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){v(this),this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){v(this),this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var i=n(this),r=e.createRange(i);t=t||L.getBody(i),r.selectNodeContents(t);var o=this.intersection(r),a=0,s=0;return o&&(r.setEnd(o.startContainer,o.startOffset),a=r.toString().length,s=a+o.toString().length,r.detach()),{start:a,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,a,s=[t],l=!1,u=!1;!u&&(i=s.pop());)if(3==i.nodeType)r=n+i.length,!l&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),l=!0),l&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),u=!0),n=r;else for(a=i.childNodes,o=a.length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return k.rangesEqual(this,e)},isValid:function(){return T(this)},inspect:function(){return f(this)}}),O(k,A,M),F.extend(k,{rangeProperties:ut,RangeIterator:h,copyComparisonConstants:x,createPrototypeRange:O,inspect:f,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=k,e.RangeException=g}),rangy.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,i,r=e.dom,o=e.util,a=r.DomPosition,s=e.DomRange,l=r.getBody,u=r.getContentDocument,c=r.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function i(e){for(var t,n=h.length;n--;)t=h[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==i||e.endOffset!=r,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(i,r),e.setStart(t,n))}function c(e){e.nativeRange.detach(),e.detached=!0;for(var t=h.length;t--;)e[h[t]]=null}var d,f,h=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,i(this)},s.createPrototypeRange(n,a,c),d=n.prototype,d.selectNode=function(e){this.nativeRange.selectNode(e),i(this)},d.cloneContents=function(){return this.nativeRange.cloneContents()},d.surroundContents=function(e){this.nativeRange.surroundContents(e),i(this)},d.collapse=function(e){this.nativeRange.collapse(e),i(this)},d.cloneRange=function(){return new n(this.nativeRange.cloneRange())},d.refresh=function(){i(this)},d.toString=function(){return this.nativeRange.toString()};var g=document.createTextNode("test");l(document).appendChild(g);var p=document.createRange();p.setStart(g,0),p.setEnd(g,0);try{p.setStart(g,1),d.setStart=function(e,t){this.nativeRange.setStart(e,t),i(this)},d.setEnd=function(e,t){this.nativeRange.setEnd(e,t),i(this)},f=function(e){return function(t){this.nativeRange[e](t),i(this)}}}catch(m){d.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}i(this)},d.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}i(this)},f=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}i(this)}}}d.setStartBefore=f("setStartBefore","setEndBefore"),d.setStartAfter=f("setStartAfter","setEndAfter"),d.setEndBefore=f("setEndBefore","setStartBefore"),d.setEndAfter=f("setEndAfter","setStartAfter"),d.selectNodeContents=function(e){this.setStartAndEnd(e,0,r.getNodeLength(e))},p.selectNodeContents(g),p.setEnd(g,3);var v=document.createRange();v.selectNodeContents(g),v.setEnd(g,4),v.setStart(g,2),d.compareBoundaryPoints=-1==p.compareBoundaryPoints(p.START_TO_END,v)&&1==p.compareBoundaryPoints(p.END_TO_START,v)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var S=document.createElementNS("http://www.w3.org/1999/xhtml","div");S.innerHTML="123";var y=S.firstChild,R=l(document);R.appendChild(S),p.setStart(y,1),p.setEnd(y,2),p.deleteContents(),"13"==y.data&&(d.deleteContents=function(){this.nativeRange.deleteContents(),i(this)},d.extractContents=function(){var e=this.nativeRange.extractContents();return i(this),e}),R.removeChild(S),R=null,o.isHostMethod(p,"createContextualFragment")&&(d.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),l(document).removeChild(g),p.detach(),v.detach(),d.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=u(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var d=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();n=e.duplicate(),n.collapse(!1);var o=n.parentElement(),a=i==o?i:r.getCommonAncestor(i,o);return a==t?a:r.getCommonAncestor(t,a)},f=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,i,o){var s=e.duplicate();s.collapse(n);var l=s.parentElement();if(r.isOrIsAncestorOf(t,l)||(l=t),!l.canHaveHTML){var u=new a(l.parentNode,r.getNodeIndex(l));return{boundaryPosition:u,nodeInfo:{nodeIndex:u.offset,containerElement:u.node}}}var d=r.getDocument(l).createElementNS("http://www.w3.org/1999/xhtml","span");d.parentNode&&d.parentNode.removeChild(d);for(var f,h,g,p,m,v=n?"StartToStart":"StartToEnd",S=o&&o.containerElement==l?o.nodeIndex:0,y=l.childNodes.length,R=y,I=R;;){if(I==y?l.appendChild(d):l.insertBefore(d,l.childNodes[I]),s.moveToElementText(d),f=s.compareEndPoints(v,e),0==f||S==R)break;if(-1==f){if(R==S+1)break;S=I}else R=R==S+1?S:I;I=Math.floor((S+R)/2),l.removeChild(d)}if(m=d.nextSibling,-1==f&&m&&c(m)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var w;if(/[\r\n]/.test(m.data)){var C=s.duplicate(),E=C.text.replace(/\r\n/g,"\r").length;for(w=C.moveStart("character",E);-1==(f=C.compareEndPoints("StartToEnd",C));)w++,C.moveStart("character",1)}else w=s.text.length;p=new a(m,w)}else h=(i||!n)&&d.previousSibling,g=(i||n)&&d.nextSibling,p=g&&c(g)?new a(g,0):h&&c(h)?new a(h,h.data.length):new a(l,r.getNodeIndex(d));return d.parentNode.removeChild(d),{boundaryPosition:p,nodeInfo:{nodeIndex:I,containerElement:l}}},g=function(e,t){var n,i,o,a,s=e.offset,u=r.getDocument(e.node),d=l(u).createTextRange(),f=c(e.node);return f?(n=e.node,i=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,i=e.node),o=u.createElementNS("http://www.w3.org/1999/xhtml","span"),o.innerHTML="&#feff;",n?i.insertBefore(o,n):i.appendChild(o),d.moveToElementText(o),d.collapse(!t),i.removeChild(o),f&&d[t?"moveStart":"moveEnd"]("character",s),d};if(i=function(e){this.textRange=e,this.refresh()},i.prototype=new s(document),i.prototype.refresh=function(){var e,t,n,i=d(this.textRange);f(this.textRange)?t=e=h(this.textRange,i,!0,!0).boundaryPosition:(n=h(this.textRange,i,!0,!1),e=n.boundaryPosition,t=h(this.textRange,i,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},i.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(i),i.rangeToTextRange=function(e){if(e.collapsed)return g(new a(e.startContainer,e.startOffset),!0);var t=g(new a(e.startContainer,e.startOffset),!0),n=g(new a(e.endContainer,e.endOffset),!1),i=l(s.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},e.WrappedTextRange=i,!e.features.implementsDomRange||e.config.preferTextRange){var p=function(){return this}();"undefined"==typeof p.Range&&(p.Range=i),e.createNativeRange=function(e){return e=u(e,t,"createNativeRange"),l(e).createTextRange()},e.WrappedRange=i}}e.createRange=function(n){return n=u(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=u(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function i(e,n){if(e){if(N.isWindow(e))return e;if(e instanceof v)return e.win;var i=N.getContentDocument(e,t,n);return N.getWindow(i)}return window}function r(e){return i(e,"getWinSelection").getSelection()}function o(e){return i(e,"getDocSelection").document.selection}function a(e){var t=!1;return e.anchorNode&&(t=1==N.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function s(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function l(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function u(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function c(t){var n;return t instanceof O?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof _?n=t.nativeRange:k.implementsDomRange&&t instanceof N.getWindow(t.startContainer).Range&&(n=t),n}function d(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!N.isAncestorOf(e[0],e[t]))return!1;return!0}function f(e){var n=e.getNodes();if(!d(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&"undefined"!=typeof e.text}function g(e,t){var n=new _(t);e._ranges=[n],s(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function p(t){if(t._ranges.length=0,"None"==t.docSelection.type)u(t);else{var n=t.docSelection.createRange();if(h(n))g(t,n);else{t.rangeCount=n.length;for(var i,r=F(n.item(0)),o=0;o<t.rangeCount;++o)i=e.createRange(r),i.selectNode(n.item(o)),t._ranges.push(i);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,s(t,t._ranges[t.rangeCount-1],!1)}}}function m(e,n){for(var i=e.docSelection.createRange(),r=f(n),o=F(i.item(0)),a=B(o).createControlRange(),s=0,l=i.length;l>s;++s)a.add(i.item(s));try{a.add(r)}catch(u){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),p(e)}function v(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function S(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function y(e,t){for(var n,i,r=tt.length;r--;)if(n=tt[r],i=n.selection,"deleteAll"==t)S(i);else if(n.win==e)return"delete"==t?(tt.splice(r,1),!0):i;return"deleteAll"==t&&(tt.length=0),null}function R(e,n){for(var i,r=F(n[0].startContainer),o=B(r).createControlRange(),a=0,s=n.length;s>a;++a){i=f(n[a]);try{o.add(i)}catch(l){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),p(e)}function I(e,t){if(e.win.document!=F(t))throw new A("WRONG_DOCUMENT_ERR")}function w(t){return function(n,i){var r;this.rangeCount?(r=this.getRangeAt(0),r["set"+(t?"Start":"End")](n,i)):(r=e.createRange(this.win.document),r.setStartAndEnd(n,i)),this.setSingleRange(r,this.isBackward())}}function C(e){var t=[],n=new M(e.anchorNode,e.anchorOffset),i=new M(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var o=0,a=e.rangeCount;a>o;++o)t[o]=O.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}e.config.checkSelectionRanges=!0;var E,T,b="boolean",P="number",N=e.dom,x=e.util,D=x.isHostMethod,O=e.DomRange,_=e.WrappedRange,A=e.DOMException,M=N.DomPosition,k=e.features,L="Control",F=N.getDocument,B=N.getBody,V=O.rangesEqual,H=D(window,"getSelection"),K=x.isHostObject(document,"selection");k.implementsWinGetSelection=H,k.implementsDocSelection=K;var U=K&&(!H||e.config.preferTextRange);U?(E=o,e.isSelectionValid=function(e){var t=i(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||F(n.createRange().parentElement())==t}):H?(E=r,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=E;var $=E(),W=e.createNativeRange(document),G=B(document),j=x.areHostProperties($,["anchorNode","focusNode","anchorOffset","focusOffset"]);k.selectionHasAnchorAndFocus=j;var q=D($,"extend");k.selectionHasExtend=q;var z=typeof $.rangeCount==P;k.selectionHasRangeCount=z;var X=!1,J=!0,Y=q?function(t,n){var i=O.getRangeDocument(n),r=e.createRange(i);r.collapseToPoint(n.endContainer,n.endOffset),t.addRange(c(r)),t.extend(n.startContainer,n.startOffset)}:null;x.areHostMethods($,["addRange","getRangeAt","removeAllRanges"])&&typeof $.rangeCount==P&&k.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,i=n>1,r=[],o=a(t),s=0;n>s;++s)r[s]=t.getRangeAt(s);var l=B(document),u=l.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","div"));u.contentEditable="false";var c=u.appendChild(document.createTextNode("   ")),d=document.createRange();if(d.setStart(c,1),d.collapse(!0),t.addRange(d),J=1==t.rangeCount,t.removeAllRanges(),!i){var f=d.cloneRange();d.setStart(c,0),f.setEnd(c,3),f.setStart(c,2),t.addRange(d),t.addRange(f),X=2==t.rangeCount,f.detach()}for(l.removeChild(u),t.removeAllRanges(),d.detach(),s=0;n>s;++s)0==s&&o?Y?Y(t,r[s]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because browser does not support Selection.extend"),t.addRange(r[s])):t.addRange(r[s])}}(),k.selectionSupportsMultipleRanges=X,k.collapsedNonEditableSelectionsSupported=J;var Z,Q=!1;G&&D(G,"createControlRange")&&(Z=G.createControlRange(),x.areHostProperties(Z,["item","add"])&&(Q=!0)),k.implementsControlRange=Q,T=j?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var et;D($,"getRangeAt")?et=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:j&&(et=function(t){var n=F(t.anchorNode),i=e.createRange(n);return i.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),i}),v.prototype=e.selectionPrototype;var tt=[],nt=function(e){if(e&&e instanceof v)return e.refresh(),e;e=i(e,"getNativeSelection");var t=y(e),n=E(e),r=K?o(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new v(n,r,e),tt.push({win:e,selection:t})),t};e.getSelection=nt,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(N.getIframeWindow(n))};var it=v.prototype;if(!U&&j&&x.areHostMethods($,["removeAllRanges","addRange"])){it.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),u(this)};var rt=function(e,t){Y(e.nativeSelection,t),e.refresh()};it.addRange=z?function(t,i){if(Q&&K&&this.docSelection.type==L)m(this,t);else if(n(i)&&q)rt(this,t);else{var r;if(X?r=this.rangeCount:(this.removeAllRanges(),r=0),this.nativeSelection.addRange(c(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var o=et(this.nativeSelection,this.rangeCount-1);o&&!V(o,t)&&(t=new _(o))}this._ranges[this.rangeCount-1]=t,s(this,t,st(this.nativeSelection)),this.isCollapsed=T(this)}else this.refresh()}}:function(e,t){n(t)&&q?rt(this,e):(this.nativeSelection.addRange(c(e)),this.refresh())},it.setRanges=function(e){if(Q&&e.length>1)R(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(D($,"empty")&&D(W,"select")&&Q&&U))return t.fail("No means of selecting a Range or TextRange was found"),!1;it.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=F(this.anchorNode);else if(this.docSelection.type==L){var t=this.docSelection.createRange();t.length&&(e=F(t.item(0)))}if(e){var n=B(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(i){}u(this)},it.addRange=function(t){this.docSelection.type==L?m(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,t,!1))},it.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?R(this,e):t&&this.addRange(e[0])}}it.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new A("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var ot;if(U)ot=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=B(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==L?p(t):h(n)?g(t,n):u(t)};else if(D($,"getRangeAt")&&typeof $.rangeCount==P)ot=function(t){if(Q&&K&&t.docSelection.type==L)p(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,i=t.rangeCount;i>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));s(t,t._ranges[t.rangeCount-1],st(t.nativeSelection)),t.isCollapsed=T(t)}else u(t)};else{if(!j||typeof $.isCollapsed!=b||typeof W.collapsed!=b||!k.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;ot=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=et(n,0),e._ranges=[t],e.rangeCount=1,l(e),e.isCollapsed=T(e)):u(e)}}it.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(ot(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!V(t[r],this._ranges[r]))return!0;return!1}};var at=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;r>i;++i)V(t,n[i])||e.addRange(n[i]);e.rangeCount||u(e)};it.removeRange=Q?function(e){if(this.docSelection.type==L){for(var t,n=this.docSelection.createRange(),i=f(e),r=F(n.item(0)),o=B(r).createControlRange(),a=!1,s=0,l=n.length;l>s;++s)t=n.item(s),t!==i||a?o.add(n.item(s)):a=!0;o.select(),p(this)}else at(this,e)}:function(e){at(this,e)};var st;!U&&j&&k.implementsDomRange?(st=a,it.isBackward=function(){return st(this)}):st=it.isBackward=function(){return!1},it.isBackwards=it.isBackward,it.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},it.collapse=function(t,n){I(this,t);var i=e.createRange(t);i.collapseToPoint(t,n),this.setSingleRange(i),this.isCollapsed=!0},it.collapseToStart=function(){if(!this.rangeCount)throw new A("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},it.collapseToEnd=function(){if(!this.rangeCount)throw new A("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},it.selectAllChildren=function(t){I(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},it.deleteFromDocument=function(){if(Q&&K&&this.docSelection.type==L){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;r>i;++i)n[i].deleteContents();this.addRange(n[r-1])}}},it.eachRange=function(e,t){for(var n=0,i=this._ranges.length;i>n;++n)if(e(this.getRangeAt(n)))return t},it.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},it.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},it.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(i){n.push(i[e].apply(i,t))}),n},it.setStart=w(!0),it.setEnd=w(!1),e.rangePrototype.select=function(e){nt(this.getDocument()).setSingleRange(this,e)},it.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},it.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)},it.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},it.moveToBookmark=function(t){for(var n,i,r=[],o=0;n=t.rangeBookmarks[o++];)i=e.createRange(this.win),i.moveToBookmark(n),r.push(i);t.backward?this.setSingleRange(r[0],"backward"):this.setRanges(r)},it.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},it.getName=function(){return"WrappedSelection"},it.inspect=function(){return C(this)},it.detach=function(){y(this.win,"delete"),S(this)},v.detachAll=function(){y(null,"deleteAll")},v.inspect=C,v.isDirectionBackward=n,e.Selection=v,e.selectionPrototype=it,e.addCreateMissingNativeApiListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return nt(e)}),e=null})}),n("rangy-core",["domReady"],function(e){return function(){var t,n;return n=function(e){var t=this.rangy;return e(function(){t.init()}),this.rangy},t=n.apply(e,arguments),t||e.rangy}}(this)),rangy.createModule("Highlighter",["ClassApplier"],function(e){function t(e,t){return e.characterRange.start-t.characterRange.start}function n(e,t){this.type=e,this.converterCreator=t}function i(e,t){h[e]=new n(e,t)}function r(e){var t=h[e];if(t instanceof n)return t.create();throw new Error("Highlighter type '"+e+"' is not valid")}function o(e,t){this.start=e,this.end=t}function a(e,t,n,i,r,o){r?(this.id=r,f=Math.max(f,r+1)):this.id=f++,this.characterRange=t,this.doc=e,this.classApplier=n,this.converter=i,this.containerElementId=o||null,this.applied=!1}function s(e,t){t=t||"textContent",this.doc=e||document,this.classAppliers={},this.highlights=[],this.converter=r(t)}var l=e.dom,u=l.arrayContains,c=l.getBody,d=[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,i=e.length;i>n;++n)t(e[n])},f=1,h={};n.prototype.create=function(){var e=this.converterCreator();return e.type=this.type,e},e.registerHighlighterType=i,o.prototype={intersects:function(e){return this.start<e.end&&this.end>e.start},union:function(e){return new o(Math.min(this.start,e.start),Math.max(this.end,e.end))},intersection:function(e){return new o(Math.max(this.start,e.start),Math.min(this.end,e.end))},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},o.fromCharacterRange=function(e){return new o(e.start,e.end)};var g={rangeToCharacterRange:function(e,t){var n=e.getBookmark(t);return new o(n.start,n.end)},characterRangeToRange:function(t,n,i){var r=e.createRange(t);return r.moveToBookmark({start:n.start,end:n.end,containerNode:i}),r},serializeSelection:function(e,t){for(var n=e.getAllRanges(),i=n.length,r=[],o=1==i&&e.isBackward(),a=0,s=n.length;s>a;++a)r[a]={characterRange:this.rangeToCharacterRange(n[a],t),backward:o};return r},restoreSelection:function(e,t,n){e.removeAllRanges();for(var i,r,o,a=e.win.document,s=0,l=t.length;l>s;++s)r=t[s],o=r.characterRange,i=this.characterRangeToRange(a,r.characterRange,n),e.addRange(i,r.backward)}};i("textContent",function(){return g}),i("TextRange",function(){var t;return function(){if(!t){var n=e.modules.TextRange;if(!n)throw new Error("TextRange module is missing.");if(!n.supported)throw new Error("TextRange module is present but not supported.");t={rangeToCharacterRange:function(e,t){return o.fromCharacterRange(e.toCharacterRange(t))},characterRangeToRange:function(t,n,i){var r=e.createRange(t);return r.selectCharacters(i,n.start,n.end),r},serializeSelection:function(e,t){return e.saveCharacterRanges(t)},restoreSelection:function(e,t,n){e.restoreCharacterRanges(n,t)}}}return t}}()),a.prototype={getContainerElement:function(){return this.containerElementId?this.doc.getElementById(this.containerElementId):c(this.doc)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(e){this.characterRange=this.converter.rangeToCharacterRange(e,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(e){return this.getRange().containsNodeContents(e.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.cssClass+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},s.prototype={addClassApplier:function(e){this.classAppliers[e.cssClass]=e},getHighlightForElement:function(e){for(var t=this.highlights,n=0,i=t.length;i>n;++n)if(t[n].containsElement(e))return t[n];return null},removeHighlights:function(e){for(var t,n=0,i=this.highlights.length;i>n;++n)t=this.highlights[n],u(e,t)&&(t.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(e){{var t=[],n=this.highlights;this.converter}return d(e,function(e){d(n,function(n){e.intersectsRange(n.getRange())&&!u(t,n)&&t.push(n)})}),t},highlightCharacterRanges:function(t,n,i){var r,s,l,u=this.highlights,c=this.converter,f=this.doc,h=[],g=this.classAppliers[t];i=i||null;var p,m,v;i&&(p=this.doc.getElementById(i),p&&(m=e.createRange(this.doc),m.selectNodeContents(p),v=new o(0,m.toString().length),m.detach()));var S,y,R;for(r=0,s=n.length;s>r;++r){for(S=n[r],R=!1,v&&(S=S.intersection(v)),l=0;l<u.length;++l)i==u[l].containerElementId&&(y=u[l].characterRange,y.intersects(S)&&(h.push(u[l]),u[l]=new a(f,y.union(S),g,c,null,i)));R||u.push(new a(f,S,g,c,null,i))}d(h,function(e){e.unapply()});var I=[];return d(u,function(e){e.applied||(e.apply(),I.push(e))}),I},highlightRanges:function(t,n,i){var r,o=[],a=this.converter,s=i?i.id:null;return i&&(r=e.createRange(i),r.selectNodeContents(i)),d(n,function(e){var t=i?r.intersection(e):e;o.push(a.rangeToCharacterRange(t,i||c(e.getDocument())))}),this.highlightCharacterRanges(o,n,s)},highlightSelection:function(t,n,i){var r=this.converter;n=n||e.getSelection();var a=this.classAppliers[t],s=n.win.document,l=i?s.getElementById(i):c(s);if(!a)throw new Error("No class applier found for class '"+t+"'");var u=r.serializeSelection(n,l),f=[];d(u,function(e){f.push(o.fromCharacterRange(e.characterRange))});var h=this.highlightCharacterRanges(t,f,i);return r.restoreSelection(n,u,l),h},unhighlightSelection:function(t){t=t||e.getSelection();var n=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(n),t.removeAllRanges(),n},getHighlightsInSelection:function(t){return t=t||e.getSelection(),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(e){return this.getHighlightsInSelection(e).length>0},serialize:function(e){var n=this.highlights;n.sort(t);var i=["type:"+this.converter.type];return d(n,function(t){var n=t.characterRange,r=[n.start,n.end,t.id,t.classApplier.cssClass,t.containerElementId];e&&e.serializeHighlightText&&r.push(t.getText()),i.push(r.join("$"))}),i.join("|")},deserialize:function(e){var t,n,i,s=e.split("|"),l=[],u=s[0],d=!1;if(!u||!(t=/^type:(\w+)$/.exec(u)))throw new Error("Serialized highlights are invalid.");n=t[1],n!=this.converter.type&&(i=r(n),d=!0),s.shift();for(var f,h,g,p,m,v,S=s.length;S-->0;)v=s[S].split("$"),g=new o(+v[0],+v[1]),p=v[4]||null,m=p?this.doc.getElementById(p):c(this.doc),d&&(g=this.converter.rangeToCharacterRange(i.characterRangeToRange(this.doc,g,m),m)),f=this.classAppliers[v[3]],h=new a(this.doc,g,f,this.converter,parseInt(v[2]),p),h.apply(),l.push(h);this.highlights=l}},e.Highlighter=s,e.createHighlighter=function(e,t){return new s(e,t)}}),n("rangy-highlighter",["rangy-core"],function(e){return function(){var t;return t||e.rangy.modules.Highlighter}}(this)),rangy.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t(n,e[n])===!1)return!1;return!0}function i(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function r(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function o(e,t){e.className?r(e,t)||(e.className+=" "+t):e.className=t}function a(e){return e.split(/\s+/).sort().join(" ")}function s(e){return a(e.className)}function l(e,t){return s(e)==s(t)}function u(e,t,n,i,r){var o=e.node,a=e.offset,s=o,l=a;o==i&&a>r&&++l,o!=t||a!=n&&a!=n+1||(s=i,l+=r-n),o==t&&a>n+1&&--l,e.node=s,e.offset=l
}function c(e,t,n){e.node==t&&e.offset>n&&--e.offset}function d(e,t,n,i){-1==n&&(n=t.childNodes.length);for(var r,o=e.parentNode,a=A.getNodeIndex(e),s=0;r=i[s++];)u(r,o,a,t,n);t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function f(e,t){for(var n,i=e.parentNode,r=A.getNodeIndex(e),o=0;n=t[o++];)c(n,i,r);e.parentNode.removeChild(e)}function h(e,t,n,i,r){for(var o,a=[];o=e.firstChild;)d(o,t,n++,r),a.push(o);return i&&e.parentNode.removeChild(e),a}function g(e,t){return h(e,e.parentNode,A.getNodeIndex(e),!0,t)}function p(e,t){var n=e.cloneRange();n.selectNodeContents(t);var i=n.intersection(e),r=i?i.toString():"";return n.detach(),""!=r}function m(e){for(var t,n=e.getNodes([3]),i=0;(t=n[i])&&!p(e,t);)++i;for(var r=n.length-1;(t=n[r])&&!p(e,t);)--r;return n.slice(i,r+1)}function v(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,i,r,o=0,a=e.attributes.length;a>o;++o)if(n=e.attributes[o],r=n.name,"class"!=r){if(i=t.attributes.getNamedItem(r),null===n!=(null===i))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function S(e,t){for(var n,i=0,r=e.attributes.length;r>i;++i)if(n=e.attributes[i].name,(!t||!k(t,n))&&e.attributes[i].specified&&"class"!=n)return!0;return!1}function y(e,t){return n(t,function(t,n){if("object"==typeof n){if(!y(e[t],n))return!1}else if(e[t]!==n)return!1}),!0}function R(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||V(e)&&!V(e.parentNode))}function I(e){return(V(e)||1!=e.nodeType&&V(e.parentNode))&&!R(e)}function w(e){return e&&1==e.nodeType&&!H.test(B(e,"display"))}function C(e){if(0==e.data.length)return!0;if(K.test(e.data))return!1;var t=B(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return w(e.previousSibling)||w(e.nextSibling)}function E(e){var t,n,i=[];for(t=0;n=e[t++];)i.push(new M(n.startContainer,n.startOffset),new M(n.endContainer,n.endOffset));return i}function T(e,t){for(var n,i,r,o=0,a=e.length;a>o;++o)n=e[o],i=t[2*o],r=t[2*o+1],n.setStartAndEnd(i.node,i.offset,r.node,r.offset)}function b(e,t){return A.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function P(e,n,i,r){var o,a,s=0==i;if(A.isAncestorOf(n,e))return e;if(A.isCharacterDataNode(n)){var l=A.getNodeIndex(n);if(0==i)i=l;else{if(i!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+i+" in "+n.data);i=l+1}n=n.parentNode}if(b(n,i)){o=n.cloneNode(!1),a=n.parentNode,o.id&&o.removeAttribute("id");for(var u,c=0;u=n.childNodes[i];)d(u,o,c++,r);return d(o,a,A.getNodeIndex(n)+1,r),n==e?o:P(e,a,A.getNodeIndex(o),r)}if(e!=n){o=n.parentNode;var f=A.getNodeIndex(n);return s||f++,P(e,o,f,r)}return e}function N(e,t){return e.tagName==t.tagName&&l(e,t)&&v(e,t)&&"inline"==B(e,"display")&&"inline"==B(t,"display")}function x(e){var t=e?"nextSibling":"previousSibling";return function(n,i){var r=n.parentNode,o=n[t];if(o){if(o&&3==o.nodeType)return o}else if(i&&(o=r[t],o&&1==o.nodeType&&N(r,o))){var a=o[e?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}function D(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function O(e,t,r){var o,a,s,l,u=this;u.cssClass=e;var c=null,d={};if("object"==typeof t&&null!==t){for(r=t.tagNames,c=t.elementProperties,d=t.elementAttributes,a=0;l=W[a++];)t.hasOwnProperty(l)&&(u[l]=t[l]);o=t.normalize}else o=t;u.normalize="undefined"==typeof o?!0:o,u.attrExceptions=[];var f=document.createElementNS("http://www.w3.org/1999/xhtml",u.elementTagName);u.elementProperties=u.copyPropertiesToElement(c,f,!0),n(d,function(e){u.attrExceptions.push(e)}),u.elementAttributes=d,u.elementSortedClassName=u.elementProperties.hasOwnProperty("className")?u.elementProperties.className:e,u.applyToAnyTagName=!1;var h=typeof r;if("string"==h)"*"==r?u.applyToAnyTagName=!0:u.tagNames=i(r.toLowerCase()).split(/\s*,\s*/);else if("object"==h&&"number"==typeof r.length)for(u.tagNames=[],a=0,s=r.length;s>a;++a)"*"==r[a]?u.applyToAnyTagName=!0:u.tagNames.push(r[a].toLowerCase());else u.tagNames=[u.elementTagName]}function _(e,t,n){return new O(e,t,n)}var A=e.dom,M=A.DomPosition,k=A.arrayContains,L="span",F=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e))}}(),B=A.getComputedStyleProperty,V=function(){var e=document.createElementNS("http://www.w3.org/1999/xhtml","div");return"boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||V(e.parentNode):!1}}(),H=/^inline(-block|-table)?$/i,K=/[^\r\n\t\f \u200B]/,U=x(!1),$=x(!0);D.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){for(var i,r,o,a,s=[],l=0,u=0,c=t.length;c>u;++u){if(i=t[u],r=i.parentNode,u>0&&(r.removeChild(i),r.hasChildNodes()||r.parentNode.removeChild(r),e))for(o=0;a=e[o++];)a.node==i&&(a.node=n,a.offset+=l);s[u]=i.data,l+=i.data.length}n.data=s.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;n>t;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var W=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],G={};O.prototype={elementTagName:L,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var i,r,s,l,u,c,d={};for(var f in e)if(e.hasOwnProperty(f))if(l=e[f],u=t[f],"className"==f)o(t,l),o(t,this.cssClass),t[f]=a(t[f]),n&&(d[f]=t[f]);else if("style"==f){r=u,n&&(d[f]=s={});for(i in e[f])r[i]=l[i],n&&(s[i]=r[i]);this.attrExceptions.push(f)}else t[f]=l,n&&(d[f]=t[f],c=G.hasOwnProperty(f)?G[f]:f,this.attrExceptions.push(c));return n?d:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&t.setAttribute(n,e[n])},hasClass:function(e){return 1==e.nodeType&&k(this.tagNames,e.tagName.toLowerCase())&&r(e,this.cssClass)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||I(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&C(e)},postApply:function(e,t,n,i){for(var r,o,a,s=e[0],l=e[e.length-1],u=[],c=s,d=l,f=0,h=l.length,g=0,p=e.length;p>g;++g)o=e[g],a=U(o,!i),a?(r||(r=new D(a),u.push(r)),r.textNodes.push(o),o===s&&(c=r.textNodes[0],f=c.length),o===l&&(d=r.textNodes[0],h=r.getLength())):r=null;var m=$(l,!i);if(m&&(r||(r=new D(l),u.push(r)),r.textNodes.push(m)),u.length){for(g=0,p=u.length;p>g;++g)u[g].doMerge(n);t.setStartAndEnd(c,f,d,h)}},createContainer:function(e){var t=e.createElementNS("http://www.w3.org/1999/xhtml",this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),this.copyAttributesToElement(this.elementAttributes,t),o(t,this.cssClass),this.onElementCreate&&this.onElementCreate(t,this),t},applyToTextNode:function(e){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&k(this.tagNames,t.tagName.toLowerCase())&&y(t,this.elementProperties))o(t,this.cssClass);else{var n=this.createContainer(A.getDocument(e));e.parentNode.insertBefore(n,e),n.appendChild(e)}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&s(e)==this.elementSortedClassName&&y(e,this.elementProperties)&&!S(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,i=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),r=[e],o=E(r),a=0;t=i[a++];)f(t,o);T(r,o)},undoToTextNode:function(e,t,n,i){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(P(n,t.endContainer,t.endOffset,i),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=P(n,t.startContainer,t.startOffset,i))}this.isRemovable(n)?g(n,i):F(n,this.cssClass)},applyToRange:function(e,t){t=t||[];var n=E(t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var i=m(e);if(i.length){for(var r,o=0;r=i[o++];)this.isIgnorableWhiteSpaceNode(r)||this.getSelfOrAncestorWithClass(r)||!this.isModifiable(r)||this.applyToTextNode(r,n);r=i[i.length-1],e.setStartAndEnd(i[0],0,r,r.length),this.normalize&&this.postApply(i,e,n,!1),T(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){t=t||[];var n=E(t);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var i,r,o=m(e),a=o[o.length-1];if(o.length){for(var s=0,l=o.length;l>s;++s)i=o[s],r=this.getSelfOrAncestorWithClass(i),r&&this.isModifiable(i)&&this.undoToTextNode(i,e,r,n),e.setStartAndEnd(o[0],0,a,a.length);this.normalize&&this.postApply(o,e,n,!0),T(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),i=e.getSelection(t).getAllRanges();this.undoToRanges(i),n.setRanges(i)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,i=0;n=t[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&p(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var i=n.getSelfOrAncestorWithClass(e);i&&!k(t,i)&&t.push(i)}),t},detach:function(){}},O.util={hasClass:r,addClass:o,removeClass:F,hasSameClasses:l,replaceWithOwnChildren:g,elementsHaveSameNonClassAttributes:v,elementHasNonClassAttributes:S,splitNodeAt:P,isEditableElement:V,isEditingHost:R,isEditable:I},e.CssClassApplier=e.ClassApplier=O,e.createCssClassApplier=e.createClassApplier=_}),n("rangy-cssclassapplier",["rangy-core"],function(e){return function(){var t;return t||e.rangy.modules.ClassApplier}}(this)),rangy.createModule("TextRange",["WrappedSelection"],function(e,t){function n(e,t){function n(t,n,i){for(var r=e.slice(t,n),o={isWord:i,chars:r,toString:function(){return r.join("")}},a=0,l=r.length;l>a;++a)r[a].token=o;s.push(o)}for(var i,r,o,a=e.join(""),s=[],l=0;i=t.wordRegex.exec(a);){if(r=i.index,o=r+i[0].length,r>l&&n(l,r,!1),t.includeTrailingSpace)for(;X.test(e[o]);)++o;n(r,o,!0),l=o}return l<e.length&&n(l,e.length,!1),s}function i(e,t){if(e){var n={};return W(n,t),W(n,e),n}return t}function r(e){var t,n;return e?(t=e.language||J,n={},W(n,ot[t]||ot[J]),W(n,e),n):ot[J]}function o(e){return i(e,it)}function a(e){return i(e,rt)}function s(e,t){var n=ct(e,"display",t),i=e.tagName.toLowerCase();return"block"==n&&nt&&dt.hasOwnProperty(i)?dt[i]:n}function l(e){for(var t=h(e),n=0,i=t.length;i>n;++n)if(1==t[n].nodeType&&"none"==s(t[n]))return!0;return!1}function u(e){var t;return 3==e.nodeType&&(t=e.parentNode)&&"hidden"==ct(t,"visibility")}function c(e){return e&&(1==e.nodeType&&!/^(inline(-block|-table)?|none)$/.test(s(e))||9==e.nodeType||11==e.nodeType)}function d(e){return U.isCharacterDataNode(e)||!/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i.test(e.nodeName)}function f(e){for(var t=[];e.parentNode;)t.unshift(e.parentNode),e=e.parentNode;return t}function h(e){return f(e).concat([e])}function g(e){for(;e&&!e.nextSibling;)e=e.parentNode;return e?e.nextSibling:null}function p(e,t){return!t&&e.hasChildNodes()?e.firstChild:g(e)}function m(e){var t=e.previousSibling;if(t){for(e=t;e.hasChildNodes();)e=e.lastChild;return e}var n=e.parentNode;return n&&1==n.nodeType?n:null}function v(e){if(!e||3!=e.nodeType)return!1;var t=e.data;if(""===t)return!0;var n=e.parentNode;if(!n||1!=n.nodeType)return!1;var i=ct(e.parentNode,"whiteSpace");return/^[\t\n\r ]+$/.test(t)&&/^(normal|nowrap)$/.test(i)||/^[\t\r ]+$/.test(t)&&"pre-line"==i}function S(e){if(""===e.data)return!0;if(!v(e))return!1;var t=e.parentNode;return t?l(e)?!0:!1:!0}function y(e){var t=e.nodeType;return 7==t||8==t||l(e)||/^(script|style)$/i.test(e.nodeName)||u(e)||S(e)}function R(e,t){var n=e.nodeType;return 7==n||8==n||1==n&&"none"==s(e,t)}function I(){this.store={}}function w(e,t,n){return function(i){var r=this.cache;if(r.hasOwnProperty(e))return ft++,r[e];ht++;var o=t.call(this,n?this[n]:this,i);return r[e]=o,o}}function C(e,t){this.node=e,this.session=t,this.cache=new I,this.positions=new I}function E(e,t){this.offset=t,this.nodeWrapper=e,this.node=e.node,this.session=e.session,this.cache=new I}function T(){return"[Position("+U.inspectNode(this.node)+":"+this.offset+")]"}function b(){return N(),Tt=new bt}function P(){return Tt||b()}function N(){Tt&&Tt.detach(),Tt=null}function x(e,n,i,r){function o(){var e=null;return n?(e=s,l||(s=s.previousVisible(),l=!s||i&&s.equals(i))):l||(e=s=s.nextVisible(),l=!s||i&&s.equals(i)),l&&(s=null),e}i&&(n?y(i.node)&&(i=e.previousVisible()):y(i.node)&&(i=i.nextVisible()));var a,s=e,l=!1,u=!1;return{next:function(){if(u)return u=!1,a;for(var e,t;e=o();)if(t=e.getCharacter(r))return a=e,e;return null},rewind:function(){if(!a)throw t.createError("createCharacterIterator: cannot rewind. Only one position can be rewound.");u=!0},dispose:function(){e=i=null}}}function D(e,t,n){function i(e){for(var t,n,i=[],a=e?r:o,s=!1,l=!1;t=a.next();){if(n=t.character,z.test(n))l&&(l=!1,s=!0);else{if(s){a.rewind();break}l=!0}i.push(t)}return i}var r=x(e,!1,null,t),o=x(e,!0,null,t),a=n.tokenizer,s=i(!0),l=i(!1).reverse(),u=a(l.concat(s),n),c=s.length?u.slice(Pt(u,s[0].token)):[],d=l.length?u.slice(0,Pt(u,l.pop().token)+1):[];return{nextEndToken:function(){for(var e,t;1==c.length&&!(e=c[0]).isWord&&(t=i(!0)).length>0;)c=a(e.chars.concat(t),n);return c.shift()},previousStartToken:function(){for(var e,t;1==d.length&&!(e=d[0]).isWord&&(t=i(!1)).length>0;)d=a(t.reverse().concat(e.chars),n);return d.pop()},dispose:function(){r.dispose(),o.dispose(),c=d=null}}}function O(e,t,n,i,r){var o,a,s,l,u=0,c=e,d=Math.abs(n);if(0!==n){var f=0>n;switch(t){case H:for(a=x(e,f,null,i);(o=a.next())&&d>u;)++u,c=o;s=o,a.dispose();break;case K:for(var h=D(e,i,r),g=f?h.previousStartToken:h.nextEndToken;(l=g())&&d>u;)l.isWord&&(++u,c=f?l.chars[0]:l.chars[l.chars.length-1]);break;default:throw new Error("movePositionBy: unit '"+t+"' not implemented")}f?(c=c.previousVisible(),u=-u):c&&c.isLeadingSpace&&(t==K&&(a=x(e,!1,null,i),s=a.next(),a.dispose()),s&&(c=s.previousVisible()))}return{position:c,unitsMoved:u}}function _(e,t,n,i){var r=e.getRangeBoundaryPosition(t,!0),o=e.getRangeBoundaryPosition(t,!1),a=i?o:r,s=i?r:o;return x(a,!!i,s,n)}function A(e,t,n){for(var i,r=[],o=_(e,t,n);i=o.next();)r.push(i);return o.dispose(),r}function M(t,n,i){var r=e.createRange(t.node);r.setStartAndEnd(t.node,t.offset,n.node,n.offset);var o=!r.expand("word",i);return r.detach(),o}function k(e,t,n,i,r){function o(e,t){var n=p[e].previousVisible(),i=p[t-1],o=!r.wholeWordsOnly||M(n,i,r.wordOptions);return{startPos:n,endPos:i,valid:o}}for(var a,s,l,u,c,d,f=Y(r.direction),h=x(e,f,e.session.getRangeBoundaryPosition(i,f),r),g="",p=[],m=null;a=h.next();)if(s=a.character,n||r.caseSensitive||(s=s.toLowerCase()),f?(p.unshift(a),g=s+g):(p.push(a),g+=s),n){if(c=t.exec(g))if(d){if(l=c.index,u=l+c[0].length,!f&&u<g.length||f&&l>0){m=o(l,u);break}}else d=!0}else if(-1!=(l=g.indexOf(t))){m=o(l,l+t.length);break}return d&&(m=o(l,u)),h.dispose(),m}function L(e){return function(){var t=!!Tt,n=P(),i=[n].concat($.toArray(arguments)),r=e.apply(this,i);return t||N(),r}}function F(e,t){return L(function(n,a,s,l){"undefined"==typeof s&&(s=a,a=H),l=i(l,st);var u=o(l.characterOptions),c=r(l.wordOptions),d=e;t&&(d=s>=0,this.collapse(!d));var f=O(n.getRangeBoundaryPosition(this,d),a,s,u,c),h=f.position;return this[d?"setStart":"setEnd"](h.node,h.offset),f.unitsMoved})}function B(e){return L(function(t,n){n=o(n);for(var i,r=_(t,this,n,!e),a=0;(i=r.next())&&z.test(i.character);)++a;r.dispose();var s=a>0;return s&&this[e?"moveStart":"moveEnd"]("character",e?a:-a,{characterOptions:n}),s})}function V(e){return L(function(t,n){var i=!1;return this.changeEachRange(function(t){i=t[e](n)||i}),i})}var H="character",K="word",U=e.dom,$=e.util,W=$.extend,G=U.getBody,j=/^[ \t\f\r\n]+$/,q=/^[ \t\f\r]+$/,z=/^[\t-\r \u0085\u00A0\u1680\u180E\u2000-\u200B\u2028\u2029\u202F\u205F\u3000]+$/,X=/^[\t \u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]+$/,J="en",Y=e.Selection.isDirectionBackward,Z=!1,Q=!1,et=!1,tt=!0;!function(){var t=document.createElementNS("http://www.w3.org/1999/xhtml","div");t.contentEditable="true",t.innerHTML="<p>1 </p><p></p>";var n=G(document),i=t.firstChild,r=e.getSelection();n.appendChild(t),r.collapse(i.lastChild,2),r.setStart(i.firstChild,0),Z=1==(""+r).length,t.innerHTML="1 <br>",r.collapse(t,2),r.setStart(t.firstChild,0),Q=1==(""+r).length,t.innerHTML="1 <p>1</p>",r.collapse(t,2),r.setStart(t.firstChild,0),et=1==(""+r).length,n.removeChild(t),r.removeAllRanges()}();var nt,it={includeBlockContentTrailingSpace:!0,includeSpaceBeforeBr:!0,includeSpaceBeforeBlock:!0,includePreLineTrailingSpace:!0},rt={includeBlockContentTrailingSpace:!tt,includeSpaceBeforeBr:!Q,includeSpaceBeforeBlock:!et,includePreLineTrailingSpace:!0},ot={en:{wordRegex:/[a-z0-9]+('[a-z0-9]+)*/gi,includeTrailingSpace:!1,tokenizer:n}},at={caseSensitive:!1,withinRange:null,wholeWordsOnly:!1,wrap:!1,direction:"forward",wordOptions:null,characterOptions:null},st={wordOptions:null,characterOptions:null},lt={wordOptions:null,characterOptions:null,trim:!1,trimStart:!0,trimEnd:!0},ut={wordOptions:null,characterOptions:null,direction:"forward"},ct=U.getComputedStyleProperty;!function(){var e=document.createElementNS("http://www.w3.org/1999/xhtml","table"),t=G(document);t.appendChild(e),nt="block"==ct(e,"display"),t.removeChild(e)}(),e.features.tableCssDisplayBlock=nt;var dt={table:"table",caption:"table-caption",colgroup:"table-column-group",col:"table-column",thead:"table-header-group",tbody:"table-row-group",tfoot:"table-footer-group",tr:"table-row",td:"table-cell",th:"table-cell"};I.prototype={get:function(e){return this.store.hasOwnProperty(e)?this.store[e]:null},set:function(e,t){return this.store[e]=t}};var ft=0,ht=0,gt={getPosition:function(e){var t=this.positions;return t.get(e)||t.set(e,new E(this,e))},toString:function(){return"[NodeWrapper("+U.inspectNode(this.node)+")]"}};C.prototype=gt;var pt="EMPTY",mt="NON_SPACE",vt="UNCOLLAPSIBLE_SPACE",St="COLLAPSIBLE_SPACE",yt="TRAILING_SPACE_BEFORE_BLOCK",Rt="TRAILING_SPACE_IN_BLOCK",It="TRAILING_SPACE_BEFORE_BR",wt="PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK",Ct="TRAILING_LINE_BREAK_AFTER_BR";W(gt,{isCharacterDataNode:w("isCharacterDataNode",U.isCharacterDataNode,"node"),getNodeIndex:w("nodeIndex",U.getNodeIndex,"node"),getLength:w("nodeLength",U.getNodeLength,"node"),containsPositions:w("containsPositions",d,"node"),isWhitespace:w("isWhitespace",v,"node"),isCollapsedWhitespace:w("isCollapsedWhitespace",S,"node"),getComputedDisplay:w("computedDisplay",s,"node"),isCollapsed:w("collapsed",y,"node"),isIgnored:w("ignored",R,"node"),next:w("nextPos",p,"node"),previous:w("previous",m,"node"),getTextNodeInfo:w("textNodeInfo",function(e){var t=null,n=!1,i=ct(e.parentNode,"whiteSpace"),r="pre-line"==i;return r?(t=q,n=!0):("normal"==i||"nowrap"==i)&&(t=j,n=!0),{node:e,text:e.data,spaceRegex:t,collapseSpaces:n,preLine:r}},"node"),hasInnerText:w("hasInnerText",function(e,t){for(var n=this.session,i=n.getPosition(e.parentNode,this.getNodeIndex()+1),r=n.getPosition(e,0),o=t?i:r,a=t?r:i;o!==a;){if(o.prepopulateChar(),o.isDefinitelyNonEmpty())return!0;o=t?o.previousVisible():o.nextVisible()}return!1},"node"),isRenderedBlock:w("isRenderedBlock",function(e){for(var t=e.getElementsByTagName("br"),n=0,i=t.length;i>n;++n)if(!y(t[n]))return!0;return this.hasInnerText()},"node"),getTrailingSpace:w("trailingSpace",function(e){if("br"==e.tagName.toLowerCase())return"";switch(this.getComputedDisplay()){case"inline":for(var t=e.lastChild;t;){if(!R(t))return 1==t.nodeType?this.session.getNodeWrapper(t).getTrailingSpace():"";t=t.previousSibling}break;case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":break;case"table-cell":return"	";default:return this.isRenderedBlock(!0)?"\n":""}return""},"node"),getLeadingSpace:w("leadingSpace",function(){switch(this.getComputedDisplay()){case"inline":case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":case"table-cell":break;default:return this.isRenderedBlock(!1)?"\n":""}return""},"node")});var Et={character:"",characterType:pt,isBr:!1,prepopulateChar:function(){var e=this;if(!e.prepopulatedChar){var t=e.node,n=e.offset,i="",r=pt,o=!1;if(n>0)if(3==t.nodeType){var a=t.data,s=a.charAt(n-1),l=e.nodeWrapper.getTextNodeInfo(),u=l.spaceRegex;l.collapseSpaces?u.test(s)?n>1&&u.test(a.charAt(n-2))||(l.preLine&&"\n"===a.charAt(n)?(i=" ",r=wt):(i=" ",r=St)):(i=s,r=mt,o=!0):(i=s,r=vt,o=!0)}else{var c=t.childNodes[n-1];if(c&&1==c.nodeType&&!y(c)&&("br"==c.tagName.toLowerCase()?(i="\n",e.isBr=!0,r=St,o=!1):e.checkForTrailingSpace=!0),!i){var d=t.childNodes[n];d&&1==d.nodeType&&!y(d)&&(e.checkForLeadingSpace=!0)}}e.prepopulatedChar=!0,e.character=i,e.characterType=r,e.isCharInvariant=o}},isDefinitelyNonEmpty:function(){var e=this.characterType;return e==mt||e==vt},resolveLeadingAndTrailingSpaces:function(){if(this.prepopulatedChar||this.prepopulateChar(),this.checkForTrailingSpace){var e=this.session.getNodeWrapper(this.node.childNodes[this.offset-1]).getTrailingSpace();e&&(this.isTrailingSpace=!0,this.character=e,this.characterType=St),this.checkForTrailingSpace=!1}if(this.checkForLeadingSpace){var t=this.session.getNodeWrapper(this.node.childNodes[this.offset]).getLeadingSpace();t&&(this.isLeadingSpace=!0,this.character=t,this.characterType=St),this.checkForLeadingSpace=!1}},getPrecedingUncollapsedPosition:function(e){for(var t,n=this;n=n.previousVisible();)if(t=n.getCharacter(e),""!==t)return n;return null},getCharacter:function(e){function t(){return l||(o=u.getPrecedingUncollapsedPosition(e),l=!0),o}if(this.resolveLeadingAndTrailingSpaces(),this.isCharInvariant)return this.character;var n=["character",e.includeSpaceBeforeBr,e.includeBlockContentTrailingSpace,e.includePreLineTrailingSpace].join("_"),i=this.cache.get(n);if(null!==i)return i;var r,o,a="",s=this.characterType==St,l=!1,u=this;return s?(" "!=this.character||t()&&!o.isTrailingSpace&&"\n"!=o.character)&&("\n"==this.character&&this.isLeadingSpace?t()&&"\n"!=o.character&&(a="\n"):(r=this.nextUncollapsed(),r&&(r.isBr?this.type=It:r.isTrailingSpace&&"\n"==r.character?this.type=Rt:r.isLeadingSpace&&"\n"==r.character&&(this.type=yt),"\n"===r.character?(this.type!=It||e.includeSpaceBeforeBr)&&(this.type!=yt||e.includeSpaceBeforeBlock)&&(this.type==Rt&&r.isTrailingSpace&&!e.includeBlockContentTrailingSpace||(this.type!=wt||r.type!=mt||e.includePreLineTrailingSpace)&&("\n"===this.character?r.isTrailingSpace?this.isTrailingSpace||this.isBr&&(r.type=Ct,t()&&o.isLeadingSpace&&"\n"==o.character&&(r.character="")):a="\n":" "===this.character&&(a=" "))):a=this.character))):"\n"===this.character&&(!(r=this.nextUncollapsed())||r.isTrailingSpace),this.cache.set(n,a),a},equals:function(e){return!!e&&this.node===e.node&&this.offset===e.offset},inspect:T,toString:function(){return this.character}};E.prototype=Et,W(Et,{next:w("nextPos",function(e){var t=e.nodeWrapper,n=e.node,i=e.offset,r=t.session;if(!n)return null;var o,a,s;return i==t.getLength()?(o=n.parentNode,a=o?t.getNodeIndex()+1:0):t.isCharacterDataNode()?(o=n,a=i+1):(s=n.childNodes[i],r.getNodeWrapper(s).containsPositions()?(o=s,a=0):(o=n,a=i+1)),o?r.getPosition(o,a):null}),previous:w("previous",function(e){var t,n,i,r=e.nodeWrapper,o=e.node,a=e.offset,s=r.session;return 0==a?(t=o.parentNode,n=t?r.getNodeIndex():0):r.isCharacterDataNode()?(t=o,n=a-1):(i=o.childNodes[a-1],s.getNodeWrapper(i).containsPositions()?(t=i,n=U.getNodeLength(i)):(t=o,n=a-1)),t?s.getPosition(t,n):null}),nextVisible:w("nextVisible",function(e){var t=e.next();if(!t)return null;var n=t.nodeWrapper,i=t.node,r=t;return n.isCollapsed()&&(r=n.session.getPosition(i.parentNode,n.getNodeIndex()+1)),r}),nextUncollapsed:w("nextUncollapsed",function(e){for(var t=e;t=t.nextVisible();)if(t.resolveLeadingAndTrailingSpaces(),""!==t.character)return t;return null}),previousVisible:w("previousVisible",function(e){var t=e.previous();if(!t)return null;var n=t.nodeWrapper,i=t.node,r=t;return n.isCollapsed()&&(r=n.session.getPosition(i.parentNode,n.getNodeIndex())),r})});var Tt=null,bt=function(){function e(e){var t=new I;return{get:function(n){var i=t.get(n[e]);if(i)for(var r,o=0;r=i[o++];)if(r.node===n)return r;return null},set:function(n){var i=n.node[e],r=t.get(i)||t.set(i,[]);r.push(n)}}}function t(){this.initCaches()}var n=$.isHostProperty(document.documentElement,"uniqueID");return t.prototype={initCaches:function(){this.elementCache=n?function(){var e=new I;return{get:function(t){return e.get(t.uniqueID)},set:function(t){e.set(t.node.uniqueID,t)}}}():e("tagName"),this.textNodeCache=e("data"),this.otherNodeCache=e("nodeName")},getNodeWrapper:function(e){var t;switch(e.nodeType){case 1:t=this.elementCache;break;case 3:t=this.textNodeCache;break;default:t=this.otherNodeCache}var n=t.get(e);return n||(n=new C(e,this),t.set(n)),n},getPosition:function(e,t){return this.getNodeWrapper(e).getPosition(t)},getRangeBoundaryPosition:function(e,t){var n=t?"start":"end";return this.getPosition(e[n+"Container"],e[n+"Offset"])},detach:function(){this.elementCache=this.textNodeCache=this.otherNodeCache=null}},t}();W(U,{nextNode:p,previousNode:m});var Pt=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0,i=e.length;i>n;++n)if(e[n]===t)return n;return-1};W(e.rangePrototype,{moveStart:F(!0,!1),moveEnd:F(!1,!1),move:F(!0,!0),trimStart:B(!0),trimEnd:B(!1),trim:L(function(e,t){var n=this.trimStart(t),i=this.trimEnd(t);return n||i}),expand:L(function(e,t,n){var a=!1;n=i(n,lt);var s=o(n.characterOptions);if(t||(t=H),t==K){var l,u,c=r(n.wordOptions),d=e.getRangeBoundaryPosition(this,!0),f=e.getRangeBoundaryPosition(this,!1),h=D(d,s,c),g=h.nextEndToken(),p=g.chars[0].previousVisible();if(this.collapsed)l=g;else{var m=D(f,s,c);l=m.previousStartToken()}return u=l.chars[l.chars.length-1],p.equals(d)||(this.setStart(p.node,p.offset),a=!0),u&&!u.equals(f)&&(this.setEnd(u.node,u.offset),a=!0),n.trim&&(n.trimStart&&(a=this.trimStart(s)||a),n.trimEnd&&(a=this.trimEnd(s)||a)),a}return this.moveEnd(H,1,n)}),text:L(function(e,t){return this.collapsed?"":A(e,this,o(t)).join("")}),selectCharacters:L(function(e,t,n,i,r){var o={characterOptions:r};t||(t=G(this.getDocument())),this.selectNodeContents(t),this.collapse(!0),this.moveStart("character",n,o),this.collapse(!0),this.moveEnd("character",i-n,o)}),toCharacterRange:L(function(e,t,n){t||(t=G(this.getDocument()));var i,r,o=t.parentNode,a=U.getNodeIndex(t),s=-1==U.comparePoints(this.startContainer,this.endContainer,o,a),l=this.cloneRange();return s?(l.setStartAndEnd(this.startContainer,this.startOffset,o,a),i=-l.text(n).length):(l.setStartAndEnd(o,a,this.startContainer,this.startOffset),i=l.text(n).length),r=i+this.text(n).length,{start:i,end:r}}),findText:L(function(t,n,o){o=i(o,at),o.wholeWordsOnly&&(o.wordOptions=r(o.wordOptions),o.wordOptions.includeTrailingSpace=!1);var a=Y(o.direction),s=o.withinRange;s||(s=e.createRange(),s.selectNodeContents(this.getDocument()));var l=n,u=!1;"string"==typeof l?o.caseSensitive||(l=l.toLowerCase()):u=!0;var c=t.getRangeBoundaryPosition(this,!a),d=s.comparePoint(c.node,c.offset);-1===d?c=t.getRangeBoundaryPosition(s,!0):1===d&&(c=t.getRangeBoundaryPosition(s,!1));for(var f,h=c,g=!1;;)if(f=k(h,l,u,s,o)){if(f.valid)return this.setStartAndEnd(f.startPos.node,f.startPos.offset,f.endPos.node,f.endPos.offset),!0;h=a?f.startPos:f.endPos}else{if(!o.wrap||g)return!1;s=s.cloneRange(),h=t.getRangeBoundaryPosition(s,!a),s.setBoundary(c.node,c.offset,a),g=!0}}),pasteHtml:function(e){if(this.deleteContents(),e){var t=this.createContextualFragment(e),n=t.lastChild;this.insertNode(t),this.collapseAfter(n)}}}),W(e.selectionPrototype,{expand:L(function(e,t,n){this.changeEachRange(function(e){e.expand(t,n)})}),move:L(function(e,t,n,i){var r=0;if(this.focusNode){this.collapse(this.focusNode,this.focusOffset);var o=this.getRangeAt(0);i||(i={}),i.characterOptions=a(i.characterOptions),r=o.move(t,n,i),this.setSingleRange(o)}return r}),trimStart:V("trimStart"),trimEnd:V("trimEnd"),trim:V("trim"),selectCharacters:L(function(t,n,i,r,o,a){var s=e.createRange(n);s.selectCharacters(n,i,r,a),this.setSingleRange(s,o)}),saveCharacterRanges:L(function(e,t,n){for(var i=this.getAllRanges(),r=i.length,o=[],a=1==r&&this.isBackward(),s=0,l=i.length;l>s;++s)o[s]={characterRange:i[s].toCharacterRange(t,n),backward:a,characterOptions:n};return o}),restoreCharacterRanges:L(function(t,n,i){this.removeAllRanges();for(var r,o,a,s=0,l=i.length;l>s;++s)o=i[s],a=o.characterRange,r=e.createRange(n),r.selectCharacters(n,a.start,a.end,o.characterOptions),this.addRange(r,o.backward)}),text:L(function(e,t){for(var n=[],i=0,r=this.rangeCount;r>i;++i)n[i]=this.getRangeAt(i).text(t);return n.join("")})}),e.innerText=function(t,n){var i=e.createRange(t);i.selectNodeContents(t);var r=i.text(n);return i.detach(),r},e.createWordIterator=function(e,t,n){var a=P();n=i(n,ut);var s=o(n.characterOptions),l=r(n.wordOptions),u=a.getPosition(e,t),c=D(u,s,l),d=Y(n.direction);return{next:function(){return d?c.previousStartToken():c.nextEndToken()},dispose:function(){c.dispose(),this.next=function(){}}}},e.noMutation=function(e){var t=P();e(t),N()},e.noMutation.createEntryPointFunction=L,e.textRange={isBlockNode:c,isCollapsedWhitespaceNode:S,createPosition:L(function(e,t,n){return e.getPosition(t,n)})}}),n("rangy-textrange",["rangy-core"],function(e){return function(){var t;return t||e.rangy.modules.TextRange}}(this)),rangy.createModule("Position",["WrappedSelection"],function(e,t){function n(e){var t=0,n=0;if(typeof e.pageXOffset==I&&typeof e.pageYOffset==I)t=e.pageXOffset,n=e.pageYOffset;else{var i=e.document,r=i.documentElement,o=i.compatMode,a="string"==typeof o&&o.indexOf("CSS")>=0&&r?r:T.getBody(i);if(a&&typeof a.scrollLeft==I&&typeof a.scrollTop==I)try{t=a.scrollLeft,n=a.scrollTop}catch(s){}}return{x:t,y:n}}function i(e,t){for(t=t.toLowerCase();e;){if(1==e.nodeType&&e.tagName.toLowerCase()==t)return e;e=e.parentNode}return null}function r(e,t,n,i){this.top=e,this.right=t,this.bottom=n,this.left=i,this.width=t-i,this.height=n-e}function o(e,t,n){return new r(e.top+n,e.right+t,e.bottom+n,e.left+t)}function a(e,t){var n=0,i=0,r=t.documentElement,a=T.getBody(t),s=0===r.clientWidth&&typeof a.clientTop==I?a:r,l=s.clientLeft,u=s.clientTop;return l&&(n=-l),u&&(i=-u),o(e,n,i)}function s(e){for(var t,n=[],i=[],o=[],a=[],s=0,l=e.length;l>s;++s)t=e[s],t&&(n.push(t.top),i.push(t.bottom),o.push(t.left),a.push(t.right));return new r(Math.min.apply(Math,n),Math.max.apply(Math,a),Math.max.apply(Math,i),Math.min.apply(Math,o))
}function l(t,n,i){var r=T.getBody(t).createTextRange();r.moveToPoint(n,i);var o=new e.WrappedTextRange(r);return new P(o.startContainer,o.startOffset)}function u(e,t,n){var i=e.caretPositionFromPoint(t,n);return new P(i.offsetNode,i.offset)}function c(e,t,n){var i=e.caretRangeFromPoint(t,n);return new P(i.startContainer,i.startOffset)}function d(e){var t=(e.nativeRange||e).getClientRects();return t.length>0?t[t.length-1]:null}function f(e,t,n){return console.log("pointIsInOrAboveRect",e,t,Math.floor(n.top),Math.floor(n.right),Math.floor(n.bottom),Math.floor(n.left)),t<n.bottom&&e>=n.left&&e<=n.right}function h(t,n,i,r){var o=t.elementFromPoint(n,i);console.log("elementFromPoint is ",o);var a=e.createRange(t);a.selectNodeContents(o),a.collapse(!0);var s,l,u,c=o.firstChild;if(c){e:for(;c;){if(console.log(c),3==c.nodeType){for(s=0,u=c.length;u>=s;++s)if(a.setEnd(c,s),l=d(a),l&&f(n,i,l)){l.right-n>n-l.left&&--s;break e}}else if(a.setEndAfter(c),l=d(a),l&&f(n,i,l)){s=T.getNodeIndex(c),c=o.parentNode,r||++s;break}c=c.nextSibling}c||(c=o,s=o.childNodes.length)}else c=o.parentNode,s=T.getNodeIndex(o),r||++s;return new P(c,s)}function g(n){if(e.features.implementsTextRange)return l;if(typeof n.caretPositionFromPoint!=w)return u;if(typeof n.caretRangeFromPoint!=w)return c;if(typeof n.elementFromPoint!=w&&D)return h;throw t.createError("createCaretPositionFromPointGetter(): Browser does not provide a recognised method to create a selection from pixel coordinates")}function p(n,i,r,o,a){a=T.getContentDocument(a,t,"createRangeFromPoints");var s=g(a),l=s(a,n,i,!1),u=s(a,r,o,!0);console.log(l.node,l.offset,u.node,u.offset);var c=e.createRange(a);return c.setStartAndEnd(l.node,l.offset,u.node,u.offset),c}function m(e,t,n,i,r){var o,a,s,l,u=t>i||t==i&&e>n;u?(o=n,a=i,s=e,l=t):(o=e,a=t,s=n,l=i);var c=rangy.getSelection(r),d=p(o,a,s,l,r);return c.setSingleRange(d),c}function v(e){return function(){var t=this["get"+(e?"Start":"End")+"ClientPos"](),i=n(T.getWindow(this.startContainer));return{x:t.x+i.x,y:t.y+i.y}}}function S(e,t){return e.compareBoundaryPoints(t.START_TO_START,t)}function y(e){return function(){for(var t="getBounding"+(e?"Document":"Client")+"Rect",n=[],i=0;i<this.rangeCount;++i)n.push(this.getRangeAt(i)[t]());return s(n)}}function R(e,t){return function(){if(0==this.rangeCount)return null;var n=t?"Document":"Client",i=this.getAllRanges();return i.length>1&&i.sort(S),e?i[0]["getStart"+n+"Pos"]():i[i.length-1]["getEnd"+n+"Pos"]()}}var I="number",w="undefined",C=e.WrappedRange,E=e.WrappedTextRange,T=e.dom,b=e.util,P=T.DomPosition,N=document.createElementNS("http://www.w3.org/1999/xhtml","span"),x=b.isHostMethod(N,"getBoundingClientRect");N=null;var D=!1,O=!1;if(e.features.implementsDomRange){var _=e.createNativeRange();D=b.isHostMethod(_,"getClientRects"),O=b.isHostMethod(_,"getBoundingClientRect"),_.detach()}b.extend(e.features,{rangeSupportsGetBoundingClientRect:O,rangeSupportsGetClientRects:D,elementSupportsGetBoundingClientRect:x});var A=function(e){return function(){var t=this.cloneRange();t.collapse(e);var n=t.getBoundingClientRect();return{x:n[e?"left":"right"],y:n[e?"top":"bottom"]}}},M=e.rangePrototype;if(e.features.implementsTextRange&&x)M.getBoundingClientRect=function(){var e,t=E.rangeToTextRange(this),n=this.getNodes([1],function(e){return/^t[dh]$/i.test(e.tagName)}),r=[];if(n.length>0){for(var o,l,u,c,d=i(this.startContainer,"table"),f=0;o=n[f];++f)u=i(o,"table"),d&&u==d||(c=this.cloneRange(),d&&c.setStartAfter(d),c.setEndBefore(u),r.push(E.rangeToTextRange(c).getBoundingClientRect())),this.containsNode(o)?r.push(o.getBoundingClientRect()):(l=t.duplicate(),l.moveToElementText(o),-1==l.compareEndPoints("StartToStart",t)?l.setEndPoint("StartToStart",t):1==l.compareEndPoints("EndToEnd",t)&&l.setEndPoint("EndToEnd",t),r.push(l.getBoundingClientRect())),d=u;var h=i(this.endContainer,"table");!h&&d&&(c=this.cloneRange(),c.setStartAfter(d),r.push(E.rangeToTextRange(c).getBoundingClientRect())),e=s(r)}else e=t.getBoundingClientRect();return a(e,T.getDocument(this.startContainer))};else if(e.features.implementsDomRange){var k=function(e){return e instanceof C?e:new C(e)};if(O){if(M.getBoundingClientRect=function(){var e=k(this).nativeRange,t=e.getBoundingClientRect()||e.getClientRects()[0];return a(t,T.getDocument(this.startContainer))},D){A=function(e){return function(){var n,i=k(this).nativeRange,r=i.getClientRects();if(0==r.length&&x&&(console.log(i,i.getClientRects(),i.getBoundingClientRect()),this.collapsed&&1==this.startContainer.nodeType&&this.startOffset<this.startContainer.childNodes.length)){var o=this.startContainer.childNodes[this.startOffset];o.getClientRects&&console.log(o,o.getClientRects(),this.startContainer.getClientRects())}if(r.length>0)return e?(n=r[0],{x:n.left,y:n.top}):(n=r[r.length-1],{x:n.right,y:n.bottom});throw t.createError("Cannot get position for range "+this.inspect())}}}}else{var L=x?function(e){return a(e.getBoundingClientRect(),T.getDocument(e))}:function(e){for(var t=0,n=0,i=e,o=e.offsetWidth,s=e.offsetHeight;i;)t+=i.offsetLeft,n+=i.offsetTop,i=i.offsetParent;return a(new r(n,t+o,n+s,t),T.getDocument(e))},F=function(e){var t;e.splitBoundaries();var n=document.createElementNS("http://www.w3.org/1999/xhtml","span");if(e.collapsed)e.insertNode(n),t=L(n),n.parentNode.removeChild(n);else{var i=e.cloneRange();i.collapse(!0),i.insertNode(n);var r=L(n);n.parentNode.removeChild(n),i.collapseToPoint(e.endContainer,e.endOffset),i.insertNode(n);var o=L(n);n.parentNode.removeChild(n);for(var a=[r,o],l=e.getNodes([1],function(t){return e.containsNode(t)}),u=0,c=l.length;c>u;++u)a.push(L(l[u]));t=s(a)}return e.normalizeBoundaries(),t};M.getBoundingClientRect=function(e){return F(k(e))}}}b.extend(M,{getBoundingDocumentRect:function(){var e=n(T.getWindow(this.startContainer));return o(this.getBoundingClientRect(),e.x,e.y)},getStartClientPos:A(!0),getEndClientPos:A(!1),getStartDocumentPos:v(!0),getEndDocumentPos:v(!1)}),b.extend(e.selectionPrototype,{getBoundingClientRect:y(!1),getBoundingDocumentRect:y(!0),getStartClientPos:R(!0,!1),getEndClientPos:R(!1,!1),getStartDocumentPos:R(!0,!0),getEndDocumentPos:R(!1,!0)}),e.positionFromPoint=function(e,n,i){return i=T.getContentDocument(i,t,"positionFromPoint"),g(i)(i,e,n)},e.createRangeFromPoints=p,e.moveSelectionToPoints=m}),n("rangy-position",["rangy-core"],function(e){return function(){var t;return t||e.rangy.modules.Position}}(this)),n("rangy",["rangy-core","rangy-highlighter","rangy-cssclassapplier","rangy-textrange","rangy-position"],function(e){return e}),ReadiumSDK.Views.MediaOverlayElementHighlighter=function(e){function t(e,t,i){if(h)try{if(h[0].ownerDocument===e[0].ownerDocument)return}catch(r){}$head=$("head",e[0].ownerDocument.documentElement),h=$("<style type='text/css'> </style>"),h.append("."+n+" {");var o="background-color: yellow !important; color: black !important; border-radius: 0.4em;",a=i;if(a){var s=!1;for(var l in a.declarations)a.declarations.hasOwnProperty(l)&&(s=!0,h.append(l+": "+a.declarations[l]+"; "));s||t||h.append(o)}else t||h.append(o);h.append("}"),h.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var n="mo-active-default",i="mo-sub-sync",r=void 0;this.isElementHighlighted=function(e){return r&&e===r};var o=void 0;this.isCfiHighlighted=function(e){return o&&e===o};var a="",s="",l=e,u=!0&&"undefined"!=typeof rangy,c=void 0,d=void 0,f="MO_SPEAK",h=void 0;this.reDo=function(){h&&h.remove(),h=void 0;var e=r,t=o,n=a,i=s;r?(this.reset(),this.highlightElement(e,n,i)):o&&(this.reset(),this.highlightCfi(t,n,i))},this.highlightElement=function(e,u,c){if(e&&e!==r){this.reset(),r=e,o=void 0,a=u,s=c;var d=this.adjustParToSeqSyncGranularity(r),f=d.element;s&&""!==s&&$(f.ownerDocument.documentElement).addClass(s);var h=$(f),g=a&&""!==a,p=l.userStyles().findStyle("."+n);t(h,g,p),p||!g?(g&&h.addClass(a),h.addClass(n)):h.addClass(a),(this.includeParWhenAdjustingToSeqSyncGranularity||r!==d)&&$(r.element).addClass(i)}},this.highlightCfi=function(e,i,h){if(e&&e!==o){this.reset(),r=void 0,o=e,a=i,s=h;var g=$(o.cfi.cfiTextParent),p=a&&""!==a,m=l.userStyles().findStyle("."+n);t(g,p,m);var v=m||!p?(p?a+" ":"")+n:a;if(u){var S=o.cfi.cfiTextParent.ownerDocument;d=rangy.createRange(S);var y="epubcfi("+o.cfi.partialStartCfi+")",R=EPUBcfi.getTextTerminusInfoWithPartialCFI(y,S,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),I="epubcfi("+o.cfi.partialEndCfi+")",w=EPUBcfi.getTextTerminusInfoWithPartialCFI(I,S,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);d.setStartAndEnd(R.textNode[0],R.textOffset,w.textNode[0],w.textOffset);d.MO_createCssClassApplier=!0,c&&c.cssClass===v||(c=rangy.createCssClassApplier(v,{elementTagName:"span",elementProperties:{className:"mo-cfi-highlight"},ignoreWhiteSpace:!0,applyToEditableOnly:!1,normalize:!0},["span"])),c.applyToRange(d)}else try{var C=e.getSmil().spineItemId;l.addHighlight(C,e.cfi.partialRangeCfi,f,"highlight",void 0)}catch(E){console.error(E)}}},this.reset=function(){if(o){var e=o.cfi.cfiTextParent.ownerDocument;if(u){if(c&&d.MO_createCssClassApplier)c.undoToRange(d);else for(var t=void 0;null!==(t=e.getElementById(f));){var h=t.textContent,g=e.createTextNode(h);t.parentNode.replaceChild(g,t),g.parentNode.normalize()}d=void 0}else try{l.removeHighlight(f);for(var t=void 0;null!==(t=e.getElementById("start-"+f));)console.log("toRemove START"),console.log(t),t.parentNode.removeChild(t);for(;null!==(t=e.getElementById("end-"+f));)console.log("toRemove END"),console.log(t),t.parentNode.removeChild(t)}catch(p){console.error(p)}o=void 0}if(r){var m=this.adjustParToSeqSyncGranularity(r),v=m.element;(this.includeParWhenAdjustingToSeqSyncGranularity||r!==m)&&$(r.element).removeClass(i),s&&""!==s&&$(v.ownerDocument.documentElement).removeClass(s),a&&""!==a&&$(v).removeClass(a),$(v).removeClass(n),r=void 0}a="",s=""},this.adjustParToSeqSyncGranularity=function(e){if(!e)return void 0;var t=l.viewerSettings().mediaOverlaysSynchronizationGranularity;if(t&&t.length>0){var n=e.element||(e.cfi?e.cfi.cfiTextParent:void 0);if(!n)return console.error("adjustParToSeqSyncGranularity !element ???"),e;var i=e.getFirstSeqAncestorWithEpubType(t,this.includeParWhenAdjustingToSeqSyncGranularity);if(i&&i.element)return i}return e}},n("mediaOverlayElementHighlighter",["readiumSDK","rangy"],function(e){return function(){var t;return t||e.mediaOverlayElementHighlighter}}(this)),ReadiumSDK.Views.MediaOverlayPlayer=function(e,t){function n(e){var t=e.getSmil();return f&&f.smil==t?f.reset():f=new ReadiumSDK.Models.SmilIterator(t),f.goToPar(e),f.currentPar?void r():void console.error("playPar !_smilIterator.currentPar")}function i(){C.resetBlankPage(),N=setTimeout(function(){if(N){if(C.resetBlankPage(),!f||!f.currentPar)return void C.reset();D=0,a(f.currentPar.audio.clipEnd+.1,2)}},2e3),t({isPlaying:!0})}function r(){if(F=!1,!f||!f.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!f.smil.id)return h.reset(),C.resetTTS(),C.resetEmbedded(),void setTimeout(function(){i()},100);if(f.currentPar.audio.src){C.resetTTS(),C.resetEmbedded(),C.resetBlankPage();var e=f.currentPar.audio.clipEnd-f.currentPar.audio.clipBegin;(0>=e||P>e)&&(console.error("### MO XXX PAR OFFSET: "+P+" / "+e),P=0);var n=ReadiumSDK.Helpers.ResolveContentRef(f.currentPar.audio.src,f.smil.href),r=I.resolveRelativeUrlMO(n),o=f.currentPar.audio.clipBegin+P;h.playFile(f.currentPar.audio.src,r,o)}else{P=0,h.reset();var a=f.currentPar.element;if(a){D=0;var s=a.nodeName?a.nodeName.toLowerCase():void 0;"audio"===s||"video"===s?(C.resetTTS(),C.resetBlankPage(),R&&C.resetEmbedded(),R=a,R.pause(),R.currentTime=0,R.play(),$(R).on("ended",C.onEmbeddedEnd),y=!0,setTimeout(function(){t({isPlaying:!0})},80)):(C.resetEmbedded(),C.resetBlankPage(),p=a.textContent,p&&""!=p?M(p):p=void 0)}var l=f.currentPar.cfi;if(l){D=0,C.resetEmbedded(),C.resetBlankPage(),E.reset();var u=l.cfiTextParent.ownerDocument,c="epubcfi("+l.partialStartCfi+")",g=EPUBcfi.getTextTerminusInfoWithPartialCFI(c,u,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),m="epubcfi("+l.partialEndCfi+")",v=EPUBcfi.getTextTerminusInfoWithPartialCFI(m,u,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(rangy){var S=rangy.createRange(u);S.setStartAndEnd(g.textNode[0],g.textOffset,v.textNode[0],v.textOffset),p=S.toString()}else p=void 0;p&&""!=p?M(p):p=void 0}}P=0,d()}function o(t){C.pause();var n=t?I.media_overlay.getNextSmil(f.smil):I.media_overlay.getPreviousSmil(f.smil);if(n){if(f=new ReadiumSDK.Models.SmilIterator(n),f.currentPar){if(!t)for(;!f.isLast();)f.next();e.openContentUrl(f.currentPar.text.src,f.smil.href,C)}}else console.log("No more SMIL"),C.reset()}function a(e,t){if(D=e,x=!1,f&&f.currentPar){var n=f.currentPar,i=f.currentPar.audio;if(!(e>O&&e<=i.clipEnd)){x=!0;var s=h.isPlaying();s&&6===t&&console.debug("from userNav _audioPlayer.isPlaying() ???");var l=e>i.clipEnd,u=!V&&6!==t&&l,c=f&&f.smil&&f.smil.spineItemId?f.smil.spineItemId:b&&b.spineItem&&b.spineItem.idref?b.spineItem.idref:void 0;if(u&&c&&b&&b.paginationInfo&&b.paginationInfo.openPages&&b.paginationInfo.openPages.length>1){var g=0,p=b.paginationInfo.openPages[g];c===p.idref&&(u=!1)}if(l?f.next():f.previous(),!f.currentPar)return void(u?(B=!0,C.reset()):o(l));if(!f.currentPar.audio)return void C.pause();if(w.mediaOverlaysSkipSkippables){for(var m=!1,v=f.currentPar;v;){if(v.isSkippable&&v.isSkippable(w.mediaOverlaysSkippables)){m=!0;break}v=v.parent}if(m){console.log("MO SKIP: "+v.epubtype),C.pause();var S=l?f.currentPar.audio.clipEnd+.1:O-1;return void a(S,t,!0)}}if(!s&&(f.currentPar.element||f.currentPar.cfi&&f.currentPar.cfi.cfiTextParent)){var y=E.adjustParToSeqSyncGranularity(f.currentPar);if(y&&y!==f.currentPar){var R=E.adjustParToSeqSyncGranularity(n);if(R&&(R===y||!l)){if(R===y){do l?f.next():f.previous();while(f.currentPar&&f.currentPar.hasAncestor(R));if(!f.currentPar)return void(u?(B=!0,C.reset()):o(l))}if(!l){var I=E.adjustParToSeqSyncGranularity(f.currentPar);if(I&&I!==f.currentPar){var T=f.currentPar,P=void 0;do P=f.currentPar,f.previous();while(f.currentPar&&f.currentPar.hasAncestor(I));f.currentPar?(f.next(),f.currentPar.hasAncestor(I)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(f.reset(),f.currentPar!==P&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),f.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),f.goToPar(T))}}}}}return h.isPlaying()&&f.currentPar.audio.src&&f.currentPar.audio.src==h.currentSmilSrc()&&e>=f.currentPar.audio.clipBegin&&e<=f.currentPar.audio.clipEnd?void d():void r()}}}function s(e){if(!A||A[0].ownerDocument!==e[0].ownerDocument){var t=".tts_on{background-color:red;color:white;} .tts_off{}";$head=$("head",e[0].ownerDocument.documentElement),A=$("<style type='text/css'> </style>").appendTo($head),A.append(t)}}function l(){u();var e=function(){if(f&&f.currentPar){var e=f.smil;if(e.mo){var n=D-f.currentPar.audio.clipBegin;if(!(0>=n)){for(var i=e.mo.smil_models.indexOf(e),r=new ReadiumSDK.Models.SmilIterator(e),o=-1;r.currentPar&&(o++,r.currentPar!=f.currentPar);)r.next();t({playPosition:n,smilIndex:i,parIndex:o})}}}};setTimeout(e,500),L=setInterval(e,1500)}function u(){D=0,void 0!==L&&clearInterval(L),L=void 0}function c(){return u(),x?void(x=!1):f&&f.currentPar?void a(f.currentPar.audio.clipEnd+.1,5):void C.reset()}function d(){if(f&&f.currentPar){if(f.currentPar.text.srcFragmentId&&f.currentPar.text.srcFragmentId.length>0){if(f.currentPar.element)return void(E.isElementHighlighted(f.currentPar)||(E.highlightElement(f.currentPar,I.media_overlay.activeClass,I.media_overlay.playbackActiveClass),F||e.insureElementVisibility(f.currentPar.getSmil().spineItemId,f.currentPar.element,C)));if(f.currentPar.cfi)return void(E.isCfiHighlighted(f.currentPar)||(E.highlightCfi(f.currentPar,I.media_overlay.activeClass,I.media_overlay.playbackActiveClass),F||e.insureElementVisibility(f.currentPar.getSmil().spineItemId,f.currentPar.cfi.cfiTextParent,C)))}if(!f.currentPar.element){var t=f.currentPar.text.src,n=f.smil.href;f=void 0,e.openContentUrl(t,n,C)}}}var f=void 0,h=new ReadiumSDK.Views.AudioPlayer(t,a,c,l,u),g=!1,p=void 0,m=!0&&"undefined"!=typeof window.speechSynthesis&&null!=speechSynthesis,v=void 0,S=!1,y=!1,R=void 0;this.isPlaying=function(){return h.isPlaying()||g||y||N};var I=e.package(),w=e.viewerSettings(),C=this,E=new ReadiumSDK.Views.MediaOverlayElementHighlighter(e);e.on(ReadiumSDK.Events.READER_VIEW_DESTROYED,function(){C.reset()}),this.applyStyles=function(){E.reDo()},this.onSettingsApplied=function(){h.setRate(w.mediaOverlaysRate),h.setVolume(w.mediaOverlaysVolume/100)},C.onSettingsApplied(),e.on(ReadiumSDK.Events.SETTINGS_APPLIED,this.onSettingsApplied,this);var T=!1;this.onDocLoadStart=function(){var e=C.isPlaying();e&&(T=!0,C.pause())};var b=void 0;this.onPageChanged=function(t){b=t;var i=B;B=!1;var o=T;if(T=!1,!t)return void C.reset();var a=void 0,s="/99!",l="epubcfi";if(t.elementId||t.initiator==C){for(var u=e.getLoadedSpineItems(),c=e.spine().isRightToLeft(),h=c?u.length-1:0;c&&h>=0||!c&&h<u.length;h+=c?-1:1){var g=u[h];if(!t.spineItem||t.spineItem==g){if(t.elementId&&0===t.elementId.indexOf(l)){E.reset();var p=t.elementId.substr(l.length+1,t.elementId.length-l.length-2);0===p.indexOf(s)&&(p=p.substr(s.length,p.length-s.length));var m=p.split(",");if(m&&3===m.length)try{var v=m[0]+m[1],S=e.getElementByCfi(g,v,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(a=S&&S.length>0?S[0]:void 0){a.nodeType===Node.TEXT_NODE&&(a=a.parentNode);break}}catch(y){console.error(y)}else try{var S=e.getElementByCfi(g,p,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(a=S&&S.length>0?S[0]:void 0){a.nodeType===Node.TEXT_NODE&&(a=a.parentNode);break}}catch(y){console.error(y)}}if(!a){if(t.initiator!=C||t.elementId){var S=e.getElementById(g,t.elementId);a=S&&S.length>0?S[0]:void 0}else{var S=e.getElement(g,"body");a=S&&S.length>0?S[0]:void 0}if(a)break}}}a||console.error("paginationData.elementId BUT !element: "+t.elementId)}var R=C.isPlaying()||o;if(!f||!f.currentPar){if(t.initiator!==C)return P=0,C.reset(),void(t.elementId&&a?(R||i)&&(t.elementIdResolved=a,C.toggleMediaOverlayRefresh(t)):(R||i)&&C.toggleMediaOverlay());if(!a)return console.error("!element: "+t.elementId),void(P=0);var I=$(a).data("mediaOverlayData");if(!I)return console.error("!moData: "+t.elementId),void(P=0);var w=I.par?I.par:I.pars[0];if(I.pars)for(var N=0;N<I.pars.length;N++){var x=I.pars[N];if(t.elementId===x.cfi.smilTextSrcCfi){w=x;break}}return void n(w)}var D=!f.currentPar.element&&!f.currentPar.cfi;if(D&&console.error("!! _smilIterator.currentPar.element ??"),t.initiator==C){var O=t.elementId&&t.elementId!==f.currentPar.text.srcFragmentId;if(O&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),O||D)return void(P=0);R?d():r()}else{if(!R&&!i)return void C.reset();if(!t.elementId,t.elementId&&!a)return;t.elementId&&(t.elementIdResolved=a),C.toggleMediaOverlayRefresh(t)}};var P=0,N=void 0,x=!1,D=0,O=-999;this.touchInit=function(){var e=h.touchInit();e&&m&&M("o",0)};var _=function(e){var t=["p","div","pagenum","td","table","li","ul","ol"],n=[",",";",".","-","??","??","?","!"],i=function(e,t){if(!(e.word.length<=0)){var n=e.text.length;t.spanMap[n]=e.counter,e.text+=e.word,e.markup+=e.html.substring(0,e.wordStart)+'<span class="tts_off" id="tts_'+e.counter+'">'+e.html.substring(e.wordStart,e.wordEnd)+"</span>"+e.html.substring(e.wordEnd,e.html.length),e.word="",e.html="",e.wordStart=-1,e.wordEnd=-1,e.counter++}},r={element:e,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};r.element.innerHTML_original=e.innerHTML;for(var o={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},a=r.element.innerHTML_original.length,s=0;a>=s;){if(o.inTag){if(o.html+=r.element.innerHTML_original[s],">"==r.element.innerHTML_original[s]){o.inTag=!1;var l=o.html.match(/<\/(.*?)>$/);l&&t.indexOf(l[1])>-1&&(i(o,r),o.text+=" ")}}else s==a||r.element.innerHTML_original[s].match(/\s/)?(i(o,r),a>s&&(o.text+=r.element.innerHTML_original[s],o.markup+=r.element.innerHTML_original[s])):n.indexOf(r.element.innerHTML_original[s])>-1?(i(o,r),o.wordStart=o.html.length,o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s],i(o,r)):"<"==r.element.innerHTML_original[s]?(o.inTag=!0,o.html+=r.element.innerHTML_original[s]):(0==o.word.length&&(o.wordStart=o.html.length),o.wordEnd=o.html.length+1,o.word+=r.element.innerHTML_original[s],o.html+=r.element.innerHTML_original[s]);s++}return r.text=o.text,r.innerHTML_tts=o.markup,r.element.innerHTML=r.innerHTML_tts,r},A=void 0,M=function(n,i){function r(e){e||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){r(!1)},5)):o()}function o(){v=new SpeechSynthesisUtterance,S&&a&&(v.tokenData=a,v.onboundary=function(e){if(v){console.debug("TTS boundary: "+e.name+" / "+e.charIndex);var t=e.target.tokenData;if(t&&t.spanMap.hasOwnProperty(e.charIndex)){var n;[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF "+e.id),e.className="tts_off"});var n="tts_"+t.spanMap[e.charIndex];console.debug("TTS charIndex ID: "+n);var i=t.element.querySelector("#"+n);i&&(console.debug("TTS ON"),i.className="tts_on"),t.lastCharIndex=e.charIndex}}}),v.onend=function(e){if(v)if(console.debug("TTS ended"),S){var t=e.target.tokenData,n=!e.forceSkipEnd&&v===e.target&&(!t||t.element.innerHTML_original);t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (end)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0),n?C.onTTSEnd():console.debug("TTS end SKIPPED")}else C.onTTSEnd()},v.onerror=function(e){if(v&&(console.error("TTS error"),console.debug(v.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),S)){var t=e.target.tokenData;t&&(t.element.innerHTML_original?t.element.innerHTML=t.element.innerHTML_original:[].forEach.call(t.element.ownerDocument.querySelectorAll(".tts_on"),function(e){console.debug("TTS OFF (error)"+e.id),e.className="tts_off"}),t.element.innerHTML_original=void 0)}};var e=i||h.getVolume();v.volume=e,v.rate=h.getRate(),v.pitch=1,v.text=d,window.speechSynthesis.speak(v),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}{var a=void 0,l=f&&f.currentPar?f.currentPar:void 0,u=l?l.element:void 0;l?l.cfi:void 0}if((!i||i>0)&&(setTimeout(function(){t({isPlaying:!0})},80),g=!0,S&&u)){var c=$(u);s(c),u.innerHTML_original&&(u.innerHTML=u.innerHTML_original,u.innerHTML_original=void 0),a=_(u)}if(!m)return void e.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:n});if(!n&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var d=n||p;d&&(v&&(S&&(v.onend&&v.onend({forceSkipEnd:!0,target:v}),v.tokenData=void 0,v.onboundary=void 0),v.onend=void 0,v.onerror=void 0,v=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),r(!0))},k=function(){return t({isPlaying:!1}),g=!1,m?void window.speechSynthesis.pause():void e.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_STOP,void 0)},L=void 0;this.onEmbeddedEnd=function(){return D=0,y=!1,f&&f.currentPar?void a(f.currentPar.audio.clipEnd+.1,3):void C.reset()},this.onTTSEnd=function(){return D=0,g=!1,f&&f.currentPar?void a(f.currentPar.audio.clipEnd+.1,4):void C.reset()},this.escape=function(){if(!f||!f.currentPar)return void this.toggleMediaOverlay();if(!C.isPlaying())return void C.play();if(w.mediaOverlaysEscapeEscapables)for(var e=f.currentPar;e;){if(e.isEscapable&&e.isEscapable(w.mediaOverlaysEscapables)){do f.next();while(f.currentPar&&f.currentPar.hasAncestor(e));return f.currentPar?void r():void o(!0)}e=e.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(e){if(C.isPlaying()&&C.pause(),e.element||e.cfi&&e.cfi.cfiTextParent){var t=E.adjustParToSeqSyncGranularity(e);if(t&&t!==e){var i=function(e){if(e.nodeType&&"par"===e.nodeType)return e;if(!e.children||e.children.length<=0)return void 0;for(var t=0;t<e.children.length;t++){var n=e.children[t],r=i(n);if(r)return r}},r=i(t);r&&(e=r)}}n(e)},this.resetTTS=function(){p=void 0,k()},this.resetBlankPage=function(){if(N){var e=N;N=void 0,clearTimeout(e)}N=void 0,t({isPlaying:!1})},this.resetEmbedded=function(){R&&($(R).off("ended",C.onEmbeddedEnd),R.pause()),R=void 0,t({isPlaying:!1}),y=!1},this.reset=function(){P=0,h.reset(),C.resetTTS(),C.resetEmbedded(),C.resetBlankPage(),E.reset(),f=void 0,x=!1},this.play=function(){if(f&&f.smil&&!f.smil.id)return void i();if(R)y=!0,R.play(),t({isPlaying:!0});else if(p)M(void 0);else if(!h.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();d()},this.pause=function(){F=!1,N?this.resetBlankPage():y?(y=!1,R&&R.pause(),t({isPlaying:!1})):g?k():h.pause(),E.reset()},this.isMediaOverlayAvailable=function(){var t=e.getFirstVisibleMediaOverlayElement();return"undefined"!=typeof t},this.nextOrPreviousMediaOverlay=function(e){if(C.isPlaying())C.pause();else if(f&&f.currentPar)return void C.play();if(!f)return void this.toggleMediaOverlay();var t=e?O-1:f.currentPar.audio.clipEnd+.1;a(t,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(t,n,i){P=i,f=void 0,e.openContentUrl(t,n,C)},this.toggleMediaOverlay=function(){return C.isPlaying()?void C.pause():f?void C.play():void this.toggleMediaOverlayRefresh(void 0)};var F=!1;this.toggleMediaOverlayRefresh=function(t){var n=e.getLoadedSpineItems(),i=e.spine().isRightToLeft(),o=void 0,a=C.isPlaying();if(a&&f){var s=t.initiator&&t.initiator instanceof ReadiumSDK.Views.ScrollView;if(s&&w.mediaOverlaysPreservePlaybackWhenScroll)return void(F=!0);o=f.currentPar,C.pause()}F=!1;var l=t&&t.elementIdResolved?t.elementIdResolved:void 0,u=t&&t.elementId?t.elementId:void 0;if(!l){u&&console.error("[WARN] id did not resolve to element?");for(var c=i?n.length-1:0;i&&c>=0||!i&&c<n.length;c+=i?-1:1){var d=n[c];if(d){if(!t||!t.spineItem||t.spineItem==d){if(u){var h=e.getElementById(d,u);l=h&&h.length>0?h[0]:void 0}else if(d.isFixedLayout()&&t&&t.paginationInfo&&t.paginationInfo.openPages){var g=0;if(t.paginationInfo.openPages[g]&&t.paginationInfo.openPages[g].idref&&t.paginationInfo.openPages[g].idref===d.idref){var h=e.getElement(d,"body");l=h&&h.length>0?h[0]:void 0}}if(l)break}}else console.error("spineItems[i] is undefined??")}}if(l||(l=e.getFirstVisibleMediaOverlayElement()),!l)return void C.reset();var p=$(l).data("mediaOverlayData");if(!p){for(var m=!1,v=function(e){if(!e)return!1;for(var t=0;t<e.length;t++){if(l===e[t]&&(m=!0),m){var n=$(e[t]).data("mediaOverlayData");if(n)return p=n,!0}var i=v(e[t].children);if(i)return!0}return!1},S=l;S&&"body"!==S.nodeName.toLowerCase();)S=S.parentNode;if(!S)return void C.reset();v([S])}if(!p)return void C.reset();var y=p.par?p.par:p.pars[0],R=y.getSmil();return f&&f.smil==R?f.reset():f=new ReadiumSDK.Models.SmilIterator(R),f.goToPar(y),!f.currentPar&&u&&(f.reset(),f.findTextId(u)),f.currentPar?void(a&&o&&o===f.currentPar?C.play():r()):void C.reset()},this.isPlayingCfi=function(){return f&&f.currentPar&&f.currentPar.cfi};var B=!1,V=!0;this.setAutomaticNextSmil=function(e){V=e}},n("mediaOverlayPlayer",["readiumSDK","mediaOverlay","audioPlayer","mediaOverlayElementHighlighter","rangy"],function(e){return function(){var t;return t||e.mediaOverlayPlayer}}(this)),ReadiumSDK.Models.PageOpenRequest=function(e,t){this.spineItem=e,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=t,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(e){this.reset(),this.spineItemPageIndex=e},this.setElementId=function(e){this.reset(),this.elementId=e},this.setElementCfi=function(e){this.reset(),this.elementCfi=e}},n("pageOpenRequest",["readiumSDK"],function(e){return function(){var t;return t||e.pageOpenRequest}}(this)),function(e){var t={};t.Parser=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function i(e){M>_||(_>M&&(M=_,k=[]),k.push(e))}function r(){var e,n,r,s,l;return s=_,l=_,"epubcfi("===t.substr(_,8)?(e="epubcfi(",_+=8):(e=null,0===A&&i('"epubcfi("')),null!==e?(n=o(),null===n&&(n=a()),null!==n?(41===t.charCodeAt(_)?(r=")",_++):(r=null,0===A&&i('")"')),null!==r?e=[e,n,r]:(e=null,_=l)):(e=null,_=l)):(e=null,_=l),null!==e&&(e=function(e,t){return{type:"CFIAST",cfiString:t}}(s,e[1])),null===e&&(_=s),e}function o(){var e,n,r,o,a,u,c,d;return c=_,d=_,e=l(),null!==e?(n=s(),null!==n?(44===t.charCodeAt(_)?(r=",",_++):(r=null,0===A&&i('","')),null!==r?(o=s(),null!==o?(44===t.charCodeAt(_)?(a=",",_++):(a=null,0===A&&i('","')),null!==a?(u=s(),null!==u?e=[e,n,r,o,a,u]:(e=null,_=d)):(e=null,_=d)):(e=null,_=d)):(e=null,_=d)):(e=null,_=d)):(e=null,_=d),null!==e&&(e=function(e,t,n,i,r){return{type:"range",path:t,localPath:n,range1:i,range2:r}}(c,e[0],e[1],e[3],e[5])),null===e&&(_=c),e}function a(){var e,t,n,i;return n=_,i=_,e=l(),null!==e?(t=s(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null!==e&&(e=function(e,t,n){return{type:"path",path:t,localPath:n}}(n,e[0],e[1])),null===e&&(_=n),e}function s(){var e,t,n,i;if(n=_,i=_,t=l(),null===t&&(t=u()),null!==t)for(e=[];null!==t;)e.push(t),t=l(),null===t&&(t=u());else e=null;return null!==e?(t=c(),t=null!==t?t:"",null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null!==e&&(e=function(e,t,n){return{steps:t,termStep:n}}(n,e[0],e[1])),null===e&&(_=n),e}function l(){var e,n,r,o,a,s,l,u;return s=_,l=_,47===t.charCodeAt(_)?(e="/",_++):(e=null,0===A&&i('"/"')),null!==e?(n=y(),null!==n?(u=_,91===t.charCodeAt(_)?(r="[",_++):(r=null,0===A&&i('"["')),null!==r?(o=d(),null!==o?(93===t.charCodeAt(_)?(a="]",_++):(a=null,0===A&&i('"]"')),null!==a?r=[r,o,a]:(r=null,_=u)):(r=null,_=u)):(r=null,_=u),r=null!==r?r:"",null!==r?e=[e,n,r]:(e=null,_=l)):(e=null,_=l)):(e=null,_=l),null!==e&&(e=function(e,t,n){return{type:"indexStep",stepLength:t,idAssertion:n[1]}}(s,e[1],e[2])),null===e&&(_=s),e}function u(){var e,n,r,o,a,s,l,u;return s=_,l=_,"!/"===t.substr(_,2)?(e="!/",_+=2):(e=null,0===A&&i('"!/"')),null!==e?(n=y(),null!==n?(u=_,91===t.charCodeAt(_)?(r="[",_++):(r=null,0===A&&i('"["')),null!==r?(o=d(),null!==o?(93===t.charCodeAt(_)?(a="]",_++):(a=null,0===A&&i('"]"')),null!==a?r=[r,o,a]:(r=null,_=u)):(r=null,_=u)):(r=null,_=u),r=null!==r?r:"",null!==r?e=[e,n,r]:(e=null,_=l)):(e=null,_=l)):(e=null,_=l),null!==e&&(e=function(e,t,n){return{type:"indirectionStep",stepLength:t,idAssertion:n[1]}}(s,e[1],e[2])),null===e&&(_=s),e}function c(){var e,n,r,o,a,s,l,u;return s=_,l=_,58===t.charCodeAt(_)?(e=":",_++):(e=null,0===A&&i('":"')),null!==e?(n=y(),null!==n?(u=_,91===t.charCodeAt(_)?(r="[",_++):(r=null,0===A&&i('"["')),null!==r?(o=f(),null!==o?(93===t.charCodeAt(_)?(a="]",_++):(a=null,0===A&&i('"]"')),null!==a?r=[r,o,a]:(r=null,_=u)):(r=null,_=u)):(r=null,_=u),r=null!==r?r:"",null!==r?e=[e,n,r]:(e=null,_=l)):(e=null,_=l)):(e=null,_=l),null!==e&&(e=function(e,t,n){return{type:"textTerminus",offsetValue:t,textAssertion:n[1]}}(s,e[1],e[2])),null===e&&(_=s),e}function d(){var e,t;
return t=_,e=m(),null!==e&&(e=function(e,t){return t}(t,e)),null===e&&(_=t),e}function f(){var e,t,n,i;return n=_,i=_,e=g(),e=null!==e?e:"",null!==e?(t=h(),t=null!==t?t:"",null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null!==e&&(e=function(e,t,n){return{type:"textLocationAssertion",csv:t,parameter:n}}(n,e[0],e[1])),null===e&&(_=n),e}function h(){var e,n,r,o,a,s;return a=_,s=_,59===t.charCodeAt(_)?(e=";",_++):(e=null,0===A&&i('";"')),null!==e?(n=p(),null!==n?(61===t.charCodeAt(_)?(r="=",_++):(r=null,0===A&&i('"="')),null!==r?(o=p(),null!==o?e=[e,n,r,o]:(e=null,_=s)):(e=null,_=s)):(e=null,_=s)):(e=null,_=s),null!==e&&(e=function(e,t,n){return{type:"parameter",LHSValue:t,RHSValue:n}}(a,e[1],e[3])),null===e&&(_=a),e}function g(){var e,n,r,o,a;return o=_,a=_,e=m(),e=null!==e?e:"",null!==e?(44===t.charCodeAt(_)?(n=",",_++):(n=null,0===A&&i('","')),null!==n?(r=m(),r=null!==r?r:"",null!==r?e=[e,n,r]:(e=null,_=a)):(e=null,_=a)):(e=null,_=a),null!==e&&(e=function(e,t,n){return{type:"csv",preAssertion:t,postAssertion:n}}(o,e[0],e[2])),null===e&&(_=o),e}function p(){var e,t,n;if(n=_,t=v(),null===t&&(t=N()),null!==t)for(e=[];null!==t;)e.push(t),t=v(),null===t&&(t=N());else e=null;return null!==e&&(e=function(e,t){return t.join("")}(n,e)),null===e&&(_=n),e}function m(){var e,t,n;if(n=_,t=v(),null===t&&(t=N(),null===t&&(t=R())),null!==t)for(e=[];null!==t;)e.push(t),t=v(),null===t&&(t=N(),null===t&&(t=R()));else e=null;return null!==e&&(e=function(e,t){return t.join("")}(n,e)),null===e&&(_=n),e}function v(){var e,t,n,i;return n=_,i=_,e=I(),null!==e?(t=I(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null===e&&(i=_,e=I(),null!==e?(t=C(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null===e&&(i=_,e=I(),null!==e?(t=E(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null===e&&(i=_,e=I(),null!==e?(t=T(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null===e&&(i=_,e=I(),null!==e?(t=b(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i),null===e&&(i=_,e=I(),null!==e?(t=P(),null!==t?e=[e,t]:(e=null,_=i)):(e=null,_=i)))))),null!==e&&(e=function(e,t){return t[1]}(n,e)),null===e&&(_=n),e}function S(){var e,n,r,o,a,s,l;if(a=_,s=_,l=_,/^[1-9]/.test(t.charAt(_))?(e=t.charAt(_),_++):(e=null,0===A&&i("[1-9]")),null!==e){if(/^[0-9]/.test(t.charAt(_))?(r=t.charAt(_),_++):(r=null,0===A&&i("[0-9]")),null!==r)for(n=[];null!==r;)n.push(r),/^[0-9]/.test(t.charAt(_))?(r=t.charAt(_),_++):(r=null,0===A&&i("[0-9]"));else n=null;null!==n?e=[e,n]:(e=null,_=l)}else e=null,_=l;if(null!==e)if(46===t.charCodeAt(_)?(n=".",_++):(n=null,0===A&&i('"."')),null!==n){for(l=_,r=[],/^[0-9]/.test(t.charAt(_))?(o=t.charAt(_),_++):(o=null,0===A&&i("[0-9]"));null!==o;)r.push(o),/^[0-9]/.test(t.charAt(_))?(o=t.charAt(_),_++):(o=null,0===A&&i("[0-9]"));null!==r?(/^[1-9]/.test(t.charAt(_))?(o=t.charAt(_),_++):(o=null,0===A&&i("[1-9]")),null!==o?r=[r,o]:(r=null,_=l)):(r=null,_=l),null!==r?e=[e,n,r]:(e=null,_=s)}else e=null,_=s;else e=null,_=s;return null!==e&&(e=function(e,t,n){return t.join("")+"."+n.join("")}(a,e[0],e[2])),null===e&&(_=a),e}function y(){var e,n,r,o,a;if(o=_,48===t.charCodeAt(_)?(e="0",_++):(e=null,0===A&&i('"0"')),null===e)if(a=_,/^[1-9]/.test(t.charAt(_))?(e=t.charAt(_),_++):(e=null,0===A&&i("[1-9]")),null!==e){for(n=[],/^[0-9]/.test(t.charAt(_))?(r=t.charAt(_),_++):(r=null,0===A&&i("[0-9]"));null!==r;)n.push(r),/^[0-9]/.test(t.charAt(_))?(r=t.charAt(_),_++):(r=null,0===A&&i("[0-9]"));null!==n?e=[e,n]:(e=null,_=a)}else e=null,_=a;return null!==e&&(e=function(e,t){return"0"===t?"0":t[0].concat(t[1].join(""))}(o,e)),null===e&&(_=o),e}function R(){var e,n;return n=_,32===t.charCodeAt(_)?(e=" ",_++):(e=null,0===A&&i('" "')),null!==e&&(e=function(){return" "}(n)),null===e&&(_=n),e}function I(){var e,n;return n=_,94===t.charCodeAt(_)?(e="^",_++):(e=null,0===A&&i('"^"')),null!==e&&(e=function(){return"^"}(n)),null===e&&(_=n),e}function w(){var e,n;return n=_,34===t.charCodeAt(_)?(e='"',_++):(e=null,0===A&&i('"\\""')),null!==e&&(e=function(){return'"'}(n)),null===e&&(_=n),e}function C(){var e,n;return n=_,91===t.charCodeAt(_)?(e="[",_++):(e=null,0===A&&i('"["')),null===e&&(93===t.charCodeAt(_)?(e="]",_++):(e=null,0===A&&i('"]"'))),null!==e&&(e=function(e,t){return t}(n,e)),null===e&&(_=n),e}function E(){var e,n;return n=_,40===t.charCodeAt(_)?(e="(",_++):(e=null,0===A&&i('"("')),null===e&&(41===t.charCodeAt(_)?(e=")",_++):(e=null,0===A&&i('")"'))),null!==e&&(e=function(e,t){return t}(n,e)),null===e&&(_=n),e}function T(){var e,n;return n=_,44===t.charCodeAt(_)?(e=",",_++):(e=null,0===A&&i('","')),null!==e&&(e=function(){return","}(n)),null===e&&(_=n),e}function b(){var e,n;return n=_,59===t.charCodeAt(_)?(e=";",_++):(e=null,0===A&&i('";"')),null!==e&&(e=function(){return";"}(n)),null===e&&(_=n),e}function P(){var e,n;return n=_,61===t.charCodeAt(_)?(e="=",_++):(e=null,0===A&&i('"="')),null!==e&&(e=function(){return"="}(n)),null===e&&(_=n),e}function N(){var e,n;return n=_,/^[a-z]/.test(t.charAt(_))?(e=t.charAt(_),_++):(e=null,0===A&&i("[a-z]")),null===e&&(/^[A-Z]/.test(t.charAt(_))?(e=t.charAt(_),_++):(e=null,0===A&&i("[A-Z]")),null===e&&(/^[0-9]/.test(t.charAt(_))?(e=t.charAt(_),_++):(e=null,0===A&&i("[0-9]")),null===e&&(45===t.charCodeAt(_)?(e="-",_++):(e=null,0===A&&i('"-"')),null===e&&(95===t.charCodeAt(_)?(e="_",_++):(e=null,0===A&&i('"_"')),null===e&&(46===t.charCodeAt(_)?(e=".",_++):(e=null,0===A&&i('"."'))))))),null!==e&&(e=function(e,t){return t}(n,e)),null===e&&(_=n),e}function x(e){e.sort();for(var t=null,n=[],i=0;i<e.length;i++)e[i]!==t&&(n.push(e[i]),t=e[i]);return n}function D(){for(var e=1,n=1,i=!1,r=0;r<Math.max(_,M);r++){var o=t.charAt(r);"\n"===o?(i||e++,n=1,i=!1):"\r"===o||"\u2028"===o||"\u2029"===o?(e++,n=1,i=!0):(n++,i=!1)}return{line:e,column:n}}var O={fragment:r,range:o,path:a,local_path:s,indexStep:l,indirectionStep:u,terminus:c,idAssertion:d,textLocationAssertion:f,parameter:h,csv:g,valueNoSpace:p,value:m,escapedSpecialChars:v,number:S,integer:y,space:R,circumflex:I,doubleQuote:w,squareBracket:C,parentheses:E,comma:T,semicolon:b,equal:P,character:N};if(void 0!==n){if(void 0===O[n])throw new Error("Invalid rule name: "+e(n)+".")}else n="fragment";var _=0,A=0,M=0,k=[],L=O[n]();if(null===L||_!==t.length){var F=Math.max(_,M),B=F<t.length?t.charAt(F):null,V=D();throw new this.SyntaxError(x(k),B,F,V.line,V.column)}return L},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,i,r,o){function a(t,n){var i,r;switch(t.length){case 0:i="end of input";break;case 1:i=t[0];break;default:i=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return r=n?e(n):"end of input","Expected "+i+" but "+r+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=a(t,n),this.offset=i,this.line=r,this.column=o},t.SyntaxError.prototype=Error.prototype,t}(),t.CFIInstructions={getNextNode:function(e,t,n,i,r){var o;return o=e%2==0?this.elementNodeStep(e,t,n,i,r):this.inferTargetTextNode(e,t,n,i,r)},followIndirectionStep:function(e,n,i,r,o){var a,s,l,u;if(void 0===n||!n.is("iframe"))throw t.NodeTypeError(n,"expected an iframe element");return n.is("iframe")?(a=n.contents(),s=this.applyBlacklist(a.children(),i,r,o),l=$(s[0]),u=this.getNextNode(e,l,i,r,o)):void 0},textTermination:function(e,n,i){var r;if(void 0===e)throw t.NodeTypeError(e,"expected a terminating node, or node list");if(0===e.length)throw t.TerminusError("Text","Text offset:"+n,"no nodes found for termination condition");return r=this.injectCFIMarkerIntoText(e,n,i)},targetIdMatchesIdAssertion:function(e,t){return e.attr("id")===t?!0:!1},elementNodeStep:function(e,n,i,r,o){var a,s,l,u=e/2-1;if(s=this.applyBlacklist(n.children(),i,r,o),l=s.length,this.indexOutOfRange(u,l))throw t.OutOfRangeError(u,l-1,"");return a=$(s[u])},retrieveItemRefHref:function(e,t){return $("#"+e.attr("idref"),t).attr("href")},indexOutOfRange:function(e,t){return e>t-1?!0:!1},injectCFIMarkerIntoText:function(e,n,i){var r,o,a,s,l,u=0;for(r=0;r<=e.length;r++)if(3===e[r].nodeType){if(currNodeMaxIndex=e[r].nodeValue.length+u,o=n-u,currNodeMaxIndex>n)return a=e[r].nodeValue,e[r].nodeValue=a.slice(0,o),s=$(i).insertAfter(e.eq(r)),l=$(document.createTextNode(a.slice(o,a.length))),$(l).insertAfter(s),s;if(currNodeMaxIndex==n)return s=$(i).insertAfter(e.eq(r));u=currNodeMaxIndex}throw t.TerminusError("Text","Text offset:"+n,"The offset exceeded the length of the text")},inferTargetTextNode:function(e,n,i,r,o){var a,s,l,u,c;if(a=this.applyBlacklist(n.contents(),i,r,o),l=(parseInt(e)+1)/2-1,s=0,c=!1,u=a.filter(function(){return s!==l?(this.nodeType===Node.TEXT_NODE?c=!0:c&&this.nodeType!==Node.TEXT_NODE&&this!==a.lastChild&&(s++,c=!1),!1):this.nodeType===Node.TEXT_NODE?(c=!0,!0):c&&this.nodeType!==Node.TEXT_NODE?(s++,c=!1,!1):void 0}),0===u.length)throw t.OutOfRangeError(logicalTargetTextNodeIndex,s,"Index out of range");return u},applyBlacklist:function(e,t,n,i){var r;return r=e.filter(function(){var e=$(this),r=!0;return t&&$.each(t,function(t,n){return e.hasClass(n)?(r=!1,!1):void 0}),n&&$.each(n,function(t,n){return e.is(n)?(r=!1,!1):void 0}),i&&$.each(i,function(t,n){return e.attr("id")===n?(r=!1,!1):void 0}),r})}},t.Interpreter={getContentDocHref:function(e,n,i,r,o){var a=$(n),s=decodeURI(e),l=t.Parser.parse(s);if(!l||"CFIAST"!==l.type)throw t.NodeTypeError(l,"expected CFI AST root node");var u=$($("package",a)[0]),c=this.interpretIndexStepNode(l.cfiString.path,u,i,r,o);return foundHref=this.searchLocalPathForHref(c,a,l.cfiString.localPath,i,r,o),foundHref?foundHref:void 0},injectElement:function(e,n,i,r,o,a){var s,l,u,c=decodeURI(e),d=t.Parser.parse(c);return l=this.getFirstIndirectionStepNum(d),s=d.cfiString.localPath.steps[l],s.type="indexStep",u=this.interpretLocalPath(d.cfiString.localPath,l,$("html",n),r,o,a),u=this.interpretTextTerminusNode(d.cfiString.localPath.termStep,u,i)},injectRangeElements:function(e,n,i,r,o,a,s){var l,u,c,d,f,h=decodeURI(e),g=t.Parser.parse(h);return u=this.getFirstIndirectionStepNum(g),l=g.cfiString.localPath.steps[u],l.type="indexStep",c=this.interpretLocalPath(g.cfiString.localPath,u,$("html",n),o,a,s),d=this.interpretLocalPath(g.cfiString.range1,0,c,o,a,s),d=this.interpretTextTerminusNode(g.cfiString.range1.termStep,d,i),f=this.interpretLocalPath(g.cfiString.range2,0,c,o,a,s),f=this.interpretTextTerminusNode(g.cfiString.range2.termStep,f,r),{startElement:d[0],endElement:f[0]}},getTargetElement:function(e,n,i,r,o){var a,s,l,u=decodeURI(e),c=t.Parser.parse(u);return s=this.getFirstIndirectionStepNum(c),a=c.cfiString.localPath.steps[s],a.type="indexStep",l=this.interpretLocalPath(c.cfiString.localPath,s,$("html",n),i,r,o)},getRangeTargetElements:function(e,n,i,r,o){var a,s,l,u,c,d=decodeURI(e),f=t.Parser.parse(d);return s=this.getFirstIndirectionStepNum(f),a=f.cfiString.localPath.steps[s],a.type="indexStep",l=this.interpretLocalPath(f.cfiString.localPath,s,$("html",n),i,r,o),u=this.interpretLocalPath(f.cfiString.range1,0,l,i,r,o),c=this.interpretLocalPath(f.cfiString.range2,0,l,i,r,o),{startElement:u[0],endElement:c[0]}},getTargetElementWithPartialCFI:function(e,n,i,r,o){var a=decodeURI(e),s=t.Parser.parse(a),l=this.interpretIndexStepNode(s.cfiString.path,$("html",n),i,r,o);return l=this.interpretLocalPath(s.cfiString.localPath,0,l,i,r,o)},getTextTerminusInfoWithPartialCFI:function(e,n,i,r,o){var a,s=decodeURI(e),l=t.Parser.parse(s),u=this.interpretIndexStepNode(l.cfiString.path,$("html",n),i,r,o);return u=this.interpretLocalPath(l.cfiString.localPath,0,u,i,r,o),a=parseInt(l.cfiString.localPath.termStep.offsetValue),{textNode:u,textOffset:a}},getFirstIndirectionStepNum:function(e){var t=0;for(t;t<=e.cfiString.localPath.steps.length-1;t++)if(nextStepNode=e.cfiString.localPath.steps[t],"indirectionStep"===nextStepNode.type)return t},interpretLocalPath:function(e,t,n,i,r,o){var a,s=t;for(s;s<=e.steps.length-1;s++)a=e.steps[s],"indexStep"===a.type?n=this.interpretIndexStepNode(a,n,i,r,o):"indirectionStep"===a.type&&(n=this.interpretIndirectionStepNode(a,n,i,r,o));return n},interpretIndexStepNode:function(e,n,i,r,o){if(void 0===e||"indexStep"!==e.type)throw t.NodeTypeError(e,"expected index step node");var a=t.CFIInstructions.getNextNode(e.stepLength,n,i,r,o);if(e.idAssertion&&!t.CFIInstructions.targetIdMatchesIdAssertion(a,e.idAssertion))throw t.CFIAssertionError(e.idAssertion,a.attr("id"),"Id assertion failed");return a},interpretIndirectionStepNode:function(e,n,i,r){if(void 0===e||"indirectionStep"!==e.type)throw t.NodeTypeError(e,"expected indirection step node");var o=t.CFIInstructions.followIndirectionStep(e.stepLength,n,i,r);if(e.idAssertion&&!t.CFIInstructions.targetIdMatchesIdAssertion(o,e.idAssertion))throw t.CFIAssertionError(e.idAssertion,o.attr("id"),"Id assertion failed");return o},interpretTextTerminusNode:function(e,n,i){if(void 0===e||"textTerminus"!==e.type)throw t.NodeTypeError(e,"expected text terminus node");var r=t.CFIInstructions.textTermination(n,e.offsetValue,i);return r},searchLocalPathForHref:function(e,n,i,r,o,a){var s,l=0;for(l=0;l<=i.steps.length-1;l++)if(s=i.steps[l],"indexStep"===s.type?e=this.interpretIndexStepNode(s,e,r,o,a):"indirectionStep"===s.type&&(e=this.interpretIndirectionStepNode(s,e,r,o,a)),e.is("itemref"))return t.CFIInstructions.retrieveItemRefHref(e,n);return void 0}},t.NodeTypeError=function(e,t){function n(){this.node=e}return n.prototype=new Error(t),n.constructor=n,new n},t.OutOfRangeError=function(e,t,n){function i(){this.targetIndex=e,this.maxIndex=t}return i.prototype=new Error(n),i.constructor=i(),new i},t.TerminusError=function(e,t,n){function i(){this.terminusType=e,this.terminusCondition=t}return i.prototype=new Error(n),i.constructor=i(),new i},t.CFIAssertionError=function(e,t,n){function i(){this.expectedAssertion=e,this.targetElementAssertion=t}return i.prototype=new Error(n),i.constructor=i(),new i},t.Generator={generateCharOffsetRangeComponent:function(e,t,n,i,r,o,a){var s,l,u,c,d,f,h;return this.validateStartTextNode(e),this.validateStartTextNode(n),$(e).parent()[0]===$(n).parent()[0]?(u=this.createCFITextNodeStep($(e),t,r,o,a),d=this.createCFITextNodeStep($(n),i,r,o,a),h=this.createCFIElementSteps($(e).parent(),"html",r,o,a),h.substring(1,h.length)+","+u+","+d):(s=document.createRange(),s.setStart(e,t),s.setEnd(n,i),l=s.commonAncestorContainer,u=this.createCFITextNodeStep($(e),t,r,o,a),c=this.createCFIElementSteps($(e).parent(),l,r,o,a)+u,d=this.createCFITextNodeStep($(n),i,r,o,a),f=this.createCFIElementSteps($(n).parent(),l,r,o,a)+d,h=this.createCFIElementSteps($(l),"html",r,o,a),h.substring(1,h.length)+","+c+","+f)},generateElementRangeComponent:function(e,t,n,i,r){var o,a,s,l,u;if(this.validateStartElement(e),this.validateStartElement(t),e===t)throw new Error("Start and end element cannot be the same for a CFI range");return o=document.createRange(),o.setStart(e),o.setEnd(t),a=o.commonAncestorContainer,s=this.createCFIElementSteps($(e),a,n,i,r),l=this.createCFIElementSteps($(t),a,n,i,r),u=this.createCFIElementSteps($(a),"html",n,i,r),u.substring(1,u.length)+","+s+","+l},generateCharacterOffsetCFIComponent:function(e,t,n,i,r){var o,a;return this.validateStartTextNode(e,t),o=this.createCFITextNodeStep($(e),t,n,i,r),a=this.createCFIElementSteps($(e).parent(),"html",n,i,r)+o,a.substring(1,a.length)},generateElementCFIComponent:function(e,t,n,i){var r;return this.validateStartElement(e),r=this.createCFIElementSteps($(e),"html",t,n,i),r.substring(1,r.length)},generatePackageDocumentCFIComponent:function(e,t,n,i,r){return this.validateContentDocumentName(e),this.validatePackageDocument(t,e),$itemRefStartNode=$("itemref[idref='"+e+"']",$(t)),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",n,i,r),packageDocCFIComponent+"!"},generatePackageDocumentCFIComponentWithSpineIndex:function(e,t,n,i,r){return $itemRefStartNode=$($("spine",t).children()[e]),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",n,i,r),packageDocCFIComponent+"!"},generateCompleteCFI:function(e,t){return"epubcfi("+e+t+")"},validateStartTextNode:function(e,n){if(!e)throw new t.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(3!=e.nodeType)throw new t.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(0>n)throw new t.OutOfRangeError(n,0,"Character offset cannot be less than 0");if(n>e.nodeValue.length)throw new t.OutOfRangeError(n,e.nodeValue.length-1,"character offset cannot be greater than the length of the text node")},validateStartElement:function(e){if(!e)throw new t.NodeTypeError(e,"CFI target element is undefined");if(!e.nodeType||1!==e.nodeType)throw new t.NodeTypeError(e,"CFI target element is not an HTML element")},validateContentDocumentName:function(e){if(!e)throw new Error("The idref for the content document, as found in the spine, must be supplied")},validatePackageDocument:function(e,t){if(!e)throw new Error("A package document must be supplied to generate a CFI");if(0===$($("itemref[idref='"+t+"']",e)[0]).length)throw new Error("The idref of the content document could not be found in the spine")},createCFITextNodeStep:function(e,n,i,r,o){var a,s,l,u;a=e.parent(),s=t.CFIInstructions.applyBlacklist(a.contents(),i,r,o);var c,d,f=0,h=0,g=0;return $.each(s,function(){if(this.nodeType===Node.TEXT_NODE){if(this===e[0])return c?(u=d,g=h):u=f,!1;c=!0,h+=this.length,void 0===d&&(d=f,f+=1)}else c=!1,d=void 0,h=0}),l=2*u+1,"/"+l+":"+(g+n)},createCFIElementSteps:function(e,n,i,r,o){var a,s,l,u,c;return a=t.CFIInstructions.applyBlacklist(e.parent().children(),i,r,o),$.each(a,function(t){return this===e[0]?(l=t,!1):void 0}),u=2*(l+1),c=e.attr("id")?"/"+u+"["+e.attr("id")+"]":"/"+u,s=e.parent(),s.is(n)||e.is(n)?"html"===n?"!"+c:c:this.createCFIElementSteps(s,n,i,r,o)+c}};var n=t.Interpreter,i=t.Generator,r=t.CFIInstructions;if(e.EPUBcfi)throw new Error("The EPUB cfi library has already been defined");e.EPUBcfi=t;var o=t.CFIInstructions,a=t.Parser,s=t.OutOfRangeError,l=t.Interpreter,u=t.NodeTypeError,c=t.OutOfRangeError,d=t.TerminusError,f=t.CFIAssertionError;e.EPUBcfi=t={getContentDocHref:function(e,t){return n.getContentDocHref(e,t)},injectElement:function(e,t,i,r,o,a){return n.injectElement(e,t,i,r,o,a)},getTargetElement:function(e,t,i,r,o){return n.getTargetElement(e,t,i,r,o)},getTargetElementWithPartialCFI:function(e,t,i,r,o){return n.getTargetElementWithPartialCFI(e,t,i,r,o)},getTextTerminusInfoWithPartialCFI:function(e,t,i,r,o){return n.getTextTerminusInfoWithPartialCFI(e,t,i,r,o)},generateCharacterOffsetCFIComponent:function(e,t,n,r,o){return i.generateCharacterOffsetCFIComponent(e,t,n,r,o)},generateElementCFIComponent:function(e,t,n,r){return i.generateElementCFIComponent(e,t,n,r)},generatePackageDocumentCFIComponent:function(e,t,n,r,o){return i.generatePackageDocumentCFIComponent(e,t,n,r,o)},generatePackageDocumentCFIComponentWithSpineIndex:function(e,t,n,r,o){return i.generatePackageDocumentCFIComponentWithSpineIndex(e,t,n,r,o)},generateCompleteCFI:function(e,t){return i.generateCompleteCFI(e,t)},injectElementAtOffset:function(e,t,n){return r.injectCFIMarkerIntoText(e,t,n)},injectRangeElements:function(e,t,i,r,o,a,s){return n.injectRangeElements(e,t,i,r,o,a,s)},getRangeTargetElements:function(e,t,i,r,o){return n.getRangeTargetElements(e,t,i,r,o)},generateCharOffsetRangeComponent:function(e,t,n,r,o,a,s){return i.generateCharOffsetRangeComponent(e,t,n,r,o,a,s)},generateElementRangeComponent:function(e,t,n,r,o){return i.generateElementRangeComponent(e,t,n,r,o)}},t.CFIInstructions=o,t.Parser=a,t.OutOfRangeError=s,t.Interpreter=l,t.Generator=i,t.NodeTypeError=u,t.OutOfRangeError=c,t.TerminusError=d,t.CFIAssertionError=f}("undefined"==typeof window?this:window),n("epubCfi",function(){}),ReadiumSDK.Views.CfiNavigationLogic=function(e,t,n){function i(){return n.paginationInfo&&!!n.paginationInfo.rightToLeft}function r(){return n.paginationInfo&&!!n.paginationInfo.isVerticalWritingMode}function o(e,t,n){return n?e.top>=0&&e.top<t.height:e.left>=0&&e.left<t.width}function a(){return!n.paginationInfo||r()?t.width():n.paginationInfo.columnWidth+n.paginationInfo.columnGap}function s(){return r()?{top:n.paginationInfo?n.paginationInfo.pageOffset:0}:{left:(n.paginationInfo?n.paginationInfo.pageOffset:0)*(i()?-1:1)}}function l(e,t,n){var i=ReadiumSDK.Helpers.Rect.fromElement(e);_.isNaN(i.left)&&(i=new ReadiumSDK.Helpers.Rect(e.position().top,e.position().left,0,0));var r=t.top||0,o=i.bottom()>r,a=void 0!==t.bottom?i.top<t.bottom:!0,s=0;return o&&a?n?(i.top<=r&&(s=Math.ceil(100*(r-i.top)/i.height)),100-s):100:0}function u(e,n,s){var l=f(e),u=l.clientRectangles;if(0===u.length)return null;var c=i(),h=r(),g=a(),m={width:t.width(),height:t.height()};1===u.length&&p(u[0],m,g,c,h,!0);for(var v=0,S=0,y=u.length;y>S;++S)if(o(u[S],m,h)){v=s?d(u,S):100;break}return v}function c(e,o){var l=s(),u=f(e,l),c=u.clientRectangles;if(0===c.length)return null;var d=i(),h=r(),g=a(),v=t.height(),S=t.width();o&&m(c,o,v,g,d,h);var y=_.first(c);1===c.length&&p(y,{height:v,width:S},g,d,h);var R;if(h){var I=y.top;R=Math.floor(I/v)}else{var w=y.left;d&&(w=g*(n.paginationInfo?n.paginationInfo.visibleColumnCount:1)-w),R=Math.floor(w/g)}return 0>R?R=0:R>=(n.paginationInfo?n.paginationInfo.columnCount:1)&&(R=n.paginationInfo?n.paginationInfo.columnCount-1:0),R}function d(e,t){var n=0,i=0;return e.length>1?_.each(e,function(e,r){n+=e.height,r>=t&&(i+=e.height)}):(n=e[0].height,i=e[0].height-Math.max(0,-e[0].top)),i===n?100:Math.floor(100*i/n)}function f(e,t){t=t||{};for(var n=t.left||0,i=t.top||0,r=h(e[0].getBoundingClientRect(),n,i),o=[],a=e[0].getClientRects(),s=0,l=a.length;l>s;++s)a[s].height>0&&o.push(h(a[s],n,i));return 0===o.length&&(e=e.next(),e.length)?f(e,t):{wrapperRectangle:r,clientRectangles:o}}function h(e,t,n){var i={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.right-e.left,height:e.bottom-e.top};return g(i,t,n),i}function g(e,t,n){e.left+=t,e.right+=t,e.top+=n,e.bottom+=n}function p(e,t,n,i,r,a){if(!r){for(i&&(n*=-1);e.top<0;)g(e,-n,t.height);if(a)for(;e.bottom>=t.height&&!o(e,t,r);)g(e,n,-t.height)}}function m(e,t,n,i,r,o){if(!o){var a=_.reduce(e,function(e,t){return e+t.height},0),s=a*t/100;if(e.length>1){var l=0;do{if(l+=e[0].height,l>s)break;e.shift()}while(e.length>1)}else{for(r&&(i*=-1);e[0].bottom>=n;)g(e[0],i,-n);e[0].top+=s,e[0].height-=s}}}function v(e,n,i,r){var o=t[0].contentDocument,a="epubcfi("+e+")",s=EPUBcfi.getTargetElementWithPartialCFI(a,o,n,i,r);return s&&0!=s.length?s:void console.log("Can't find element for CFI: "+e)}function S(e){var t={cfi:"",x:0,y:0},n=e.indexOf("@");if(-1!=n){var i=e.substring(n+1),r=i.indexOf(":");-1!=r?(t.x=parseInt(i.substr(0,r)),t.y=parseInt(i.substr(r+1))):console.log("Unexpected terminating step format"),t.cfi=e.substring(0,n)}else t.cfi=e;return t}function y(e){if(e.nodeType===Node.TEXT_NODE){var t=e.nodeValue.replace(/\n/g,"");return t=t.replace(/ /g,""),t.length>0}return!1}n=n||{},this.getRootElement=function(){return t[0].contentDocument.documentElement};var R=n.rectangleBased?u:l;this.findFirstVisibleElement=function(e){"object"!=typeof e&&(e={top:e});var t,n=null,i=0;return t=$("body",this.getRootElement()).find(":not(iframe)").contents().filter(function(){return y(this)||"img"===this.nodeName.toLowerCase()}),$.each(t,function(){var t;t=this.nodeType===Node.TEXT_NODE?$(this).parent():$(this);var r=R(t,e,!0);return r?(n=t,i=100-r,!1):!0}),{$element:n,percentY:i}},this.getFirstVisibleElementCfi=function(e){var t=this.findFirstVisibleElement(e);if(!t.$element)return void console.log("Could not generate CFI no visible element on page");var n=EPUBcfi.Generator.generateElementCFIComponent(t.$element[0]);return"!"==n[0]&&(n=n.substring(1)),n+"@0:"+t.percentY},this.getPageForElementCfi=function(e,t,n,i){var r=S(e),o=v(r.cfi,t,n,i);return o?this.getPageForPointOnElement(o,r.x,r.y):-1},this.getElementByCfi=function(e,t,n,i){var r=S(e);return v(r.cfi,t,n,i)},this.getPageForElement=function(e){return this.getPageForPointOnElement(e,0,0)},this.getPageForPointOnElement=function(t,i,r){var o;if(n.rectangleBased)return o=c(t,r),null===o?(console.warn("Impossible to locate a hidden element: ",t),0):o;var a=this.getVerticalOffsetForPointOnElement(t,i,r);return Math.floor(a/e.height())},this.getVerticalOffsetForElement=function(e){return this.getVerticalOffsetForPointOnElement(e,0,0)},this.getVerticalOffsetForPointOnElement=function(e,t,n){var i=ReadiumSDK.Helpers.Rect.fromElement(e);return Math.ceil(i.top+n*i.height/100)},this.getElementById=function(e){var n=t[0].contentDocument,i=$(n.getElementById(e));return 0==i.length?void 0:i},this.getPageForElementId=function(e){var t=this.getElementById(e);return t?this.getPageForElement(t):-1},this.getFirstVisibleMediaOverlayElement=function(e){function t(n){if(!n||!n.length)return void 0;for(var i=0,a=n.length;a>i;i++){var s=n[i];if(s){var l=$(s);if(l.data("mediaOverlayData")){var u=r.getElementVisibility(l,e);if(u&&(o||(o=s),100==u))return s}else{var c=t(s.children);if(c)return c}}}return void 0}var n=this.getRootElement();if(!n)return void 0;var i=$("body",n);if(!i||!i.length||!i[0])return void 0;var r=this,o=void 0,a=t([i[0]]);return a||(a=o),a},this.getElementVisibility=function(e,t){return R(e,t,!0)},this.isElementVisible=R,this.getAllVisibleElementsWithSelector=function(e,t){var n=$(e,this.getRootElement()).filter(function(){return!0}),i=[];$.each(n,function(){i.push($(this))});var r=this.getVisibleElements(i,t);return r},this.getVisibleElements=function(e,t){var n=[];return $.each(e,function(){var e=this,i=R(e,t,!0);if(i){var r=e;return n.push({element:r[0],percentVisible:i}),!0}return null===i?!0:0===n.length}),n},this.getVisibleTextElements=function(e){var t=this.getTextElements($("body",this.getRootElement()));return this.getVisibleElements(t,e)},this.getMediaOverlayElements=function(e){function t(e){if(void 0!=e)for(var i=0,r=e.length;r>i;i++){var o=$(e[i]);o.data("mediaOverlayData")?n.push(o):t(o[0].children)}}var n=[];return t([e[0]]),n},this.getTextElements=function(e){var t=[];return e.find(":not(iframe)").contents().each(function(){y(this)&&t.push($(this).parent())}),t},this.getElement=function(e){var t=$(e,this.getRootElement());return t.length>0?t:void 0}},n("cfiNavigationLogic",["readiumSDK","epubCfi"],function(e){return function(){var t;return t||e.cfiNavigationLogic}}(this)),ReadiumSDK.Views.OnePageView=function(e,t,n){function i(e){if(e){S=!0;var t=c[0].contentDocument;l=$("html",t),l&&0!=l.length||(l=$("svg",t)),I&&h.applyBookStyles(),a(),R.onIFrameLoad()}}function r(){I&&l&&C&&l.css("font-size",C.fontSize+"%")}function o(){if(!c||!c.length)return 0;if(ReadiumSDK.Helpers.isIframeAlive(c[0])){var e=c[0].contentWindow,t=c[0].contentDocument,n=Math.round(parseFloat(e.getComputedStyle(t.documentElement).height));return n}if(l){console.error("getContentDocHeight ??");var i=l.height();return i}return 0}function a(){w.width=0,w.height=0;var e=void 0,t=c[0].contentDocument,n=$("meta[name=viewport]",t).attr("content");if(n||(n=$("meta[name=viewbox]",t).attr("content")),n&&(e=s(n)),!e){var i=$(t).find("svg");if(i.length>0){var r=void 0,o=void 0,a=i[0].getAttribute("width");if(a)try{r=parseInt(a,10)}catch(l){}var u=i[0].getAttribute("height");if(u)try{o=parseInt(u,10)}catch(l){}r&&o&&(e={width:r,height:o})}}if(!e&&d&&(n=d.getRenditionViewport(),n&&(e=s(n),e&&console.log("Viewport: using rendition:viewport dimensions"))),!e){var f=$(t).find("img");if(f.length>0){e={width:f.width(),height:f.height()};var h=d&&d.media_type&&d.media_type.length&&0==d.media_type.indexOf("image/");h||console.warn("Viewport: using img dimensions!")}else if(f=$(t).find("image"),f.length>0){var r=void 0,o=void 0,a=f[0].getAttribute("width");if(a)try{r=parseInt(a,10)}catch(l){}var u=f[0].getAttribute("height");if(u)try{o=parseInt(u,10)}catch(l){}r&&o&&(e={width:r,height:o},console.warn("Viewport: using image dimensions!"))}}e||(r=v.width(),o=v.height(),e={width:r,height:o},console.warn("Viewport: using browser / e-reader viewport dimensions!")),e&&(w.width=e.width,w.height=e.height)}function s(e){for(var t=e.replace(/\s/g,"").split(","),n={},i=0;i<t.length;i++){var r=t[i].split("=");2==r.length&&(n[r[0]]=r[1])}var o=Number.NaN,a=Number.NaN;return n.width&&(o=parseInt(n.width)),n.height&&(a=parseInt(n.height)),isNaN(o)||isNaN(a)?void 0:{width:o,height:a}}_.extend(this,Backbone.Events);var l,u,c,d,f,h=this,g=e.spine,p=e.iframeLoader,m=e.bookStyles,v=e.$viewport,S=!1,y=function(e){var n=function(e,t){this.begin=e,this.end=t},i=new n(function(e,t,n,i){i.css("opacity","0")},function(e,t,n,i){var r={};_.each(["-webkit-","-moz-","-ms-",""],function(e){r[e+"transition"]="opacity 150ms ease-out"}),i.css(r),i.css("opacity","1")}),r=new n(function(e,t,n,i,r,o,a){i.css("opacity","0");var s=Math.ceil(r*e),l=.8*s*(2===a?1:-1),u=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(l),origin:"50% 50%"});i.css(u)},function(e,t,n,i){var r={};_.each(["","-webkit-","-moz-","-ms-"],function(e){r[e+"transition"]=e+"transform 150ms ease-out"}),i.css(r),i.css("opacity","1"),r={},_.each(["-webkit-","-moz-","-ms-",""],function(e){r[e+"transform"]="none"}),i.css(r)}),o=new n(function(e,t,n,i,r,o,a){i.css("opacity","0");var s=Math.ceil(r*e),l=1.7*s*(2===a?1:-1),u=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(l),angle:30*(2===a?-1:1),origin:"50% 50%"});i.css(u)},function(e,t,n,i){var r={};_.each(["","-webkit-","-moz-","-ms-"],function(e){r[e+"transition"]=e+"transform 300ms ease-in-out"}),i.css(r),i.css("opacity","1"),r={},_.each(["-webkit-","-moz-","-ms-",""],function(e){r[e+"transform"]="none"}),i.css(r)}),a=new n(function(e,n,i,r,o,a,s){r.css("opacity","0");for(var l=!1,u=!1,c=!1,d=0;d<t.length;d++){var f=t[d].toLowerCase();if(f.indexOf("left")>=0){l=!0;break}if(f.indexOf("right")>=0){c=!0;break}if(f.indexOf("center")>=0){u=!0;break}}var h=Math.ceil(o*e),g=.5*h*(l||u&&1===s?1:-1),p=ReadiumSDK.Helpers.CSSTransformString({scale:.2,left:Math.round(g),angle:30*(l||u&&1===s?1:-1),origin:"50% 50%"});r.css(p)},function(e,t,n,i){var r={};_.each(["","-webkit-","-moz-","-ms-"],function(e){r[e+"transition"]=e+"transform 400ms ease-out"}),i.css(r),i.css("opacity","1"),r={},_.each(["-webkit-","-moz-","-ms-",""],function(e){r[e+"transform"]="none"}),i.css(r)}),s=[];s.push(i),s.push(r),s.push(o),s.push(a);var l=e.disablePageTransitions||!1,u=-1;this.updateOptions=function(e){null!==e.pageTransition&&"undefined"!=typeof e.pageTransition&&(u=e.pageTransition)},this.updateOptions(e);var c=0,d=!1,f=!1;this.updatePageSwitchDir=function(e,t){f||(c=e,d=t)},this.onIFrameLoad=function(){f=!0},this.transformContentImmediate_BEGIN=function(e,t,n,i){var r=d||f;if(f=!1,!l&&-1!==u){var o={};if(_.each(["-webkit-","-moz-","-ms-",""],function(e){o[e+"transition"]="all 0 ease 0"}),e.css(o),r){var a=u>=0&&u<s.length?s[u]:void 0;0!==c&&a?a.begin(t,n,i,e,h.meta_width(),h.meta_height(),c):e.css("opacity","0")}}},this.transformContentImmediate_END=function(e,t,n,i){l||-1===u||setTimeout(function(){var r=u>=0&&u<s.length?s[u]:void 0;if(0!==c&&r)r.end(t,n,i,e,h.meta_width(),h.meta_height(),c);else{var o={};_.each(["-webkit-","-moz-","-ms-",""],function(e){o[e+"transition"]="opacity 250ms linear"}),e.css(o),e.css("opacity","1")}},10)}},R=new y(e),I=n||!1,w={width:0,height:0};this.element=function(){return u},this.meta_height=function(){return w.height},this.meta_width=function(){return w.width},this.isDisplaying=function(){return S},this.render=function(){var e=ReadiumSDK.Helpers.loadTemplate("single_page_frame",{});u=$(e),f=$("#scaler",u),_.each(["-webkit-","-moz-","-ms-",""],function(e){u.css(e+"transition","all 0 ease 0")}),u.css("height","100%"),u.css("width","100%");var n=C;n||(n=new ReadiumSDK.Models.ViewerSettings({})),n.enableGPUHardwareAccelerationCSS3D&&u.css("transform","translateZ(0)");for(var i=0,r=t.length;r>i;i++)u.addClass(t[i]);return c=$("iframe",u),this},this.decorateIframe=function(){c&&c.length&&(c.css("border-bottom","1px dashed silver"),c.css("border-top","1px dashed silver"))},this.remove=function(){S=!1,d=void 0,u.remove()},this.clear=function(){S=!1,c[0].src=""
},this.currentSpineItem=function(){return d};var C=void 0;this.setViewSettings=function(e){C=e,I&&h.applyBookStyles(),a(),R.updateOptions(e)},this.applyBookStyles=function(){I&&l&&(ReadiumSDK.Helpers.setStyles(m.getStyles(),l),r())},this.scaleToWidth=function(e){if(!(w.width<=0)){var t=e/w.width;h.transformContentImmediate(t,0,0)}},this.resizeIFrameToContent=function(){var e=o();h.setHeight(e),h.showIFrame()},this.setHeight=function(e){f.css("height",e+"px"),u.css("height",e+"px")},this.showIFrame=function(){c.css("visibility","visible"),c.css("transform","none")},this.hideIFrame=function(){c.css("visibility","hidden"),c.css("transform","translate(10000px, 10000px)")},this.updatePageSwitchDir=function(e,t){R.updatePageSwitchDir(e,t)},this.transformContentImmediate=function(e,t,n){var i=Math.ceil(w.width*e),r=Math.floor(w.height*e);if(R.transformContentImmediate_BEGIN(u,e,t,n),u.css("left",t+"px"),u.css("top",n+"px"),u.css("width",i+"px"),u.css("height",r+"px"),l){var o=ReadiumSDK.Helpers.CSSTransformString({scale:e});o.width=w.width,o.height=w.height,f.css(o),l.css("opacity","0.999"),h.showIFrame(),setTimeout(function(){l.css("opacity","1")},0),R.transformContentImmediate_END(u,e,t,n)}},this.getCalculatedPageHeight=function(){return u.height()},this.transformContent=_.bind(_.debounce(this.transformContentImmediate,50),h),this.loadSpineItem=function(e,t,n){if(d!=e){d=e;var r=g.package.resolveRelativeUrl(e.href);h.hideIFrame(),h.trigger(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,c,d),p.loadIframe(c[0],r,function(r){if(r&&t){var o=function(){t(r,c,d,!0,n)};ReadiumSDK.Helpers.isIframeAlive(c[0])?(i(r),o()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(e.href),i(r),setTimeout(o,500))}else i(r)},h,{spineItem:d})}else t&&t(!0,c,d,!1,n)},this.getFirstVisibleElementCfi=function(){var e=new ReadiumSDK.Views.CfiNavigationLogic(u,c);return e.getFirstVisibleElementCfi(0)},this.getNavigator=function(){return new ReadiumSDK.Views.CfiNavigationLogic(u,c)},this.getElementByCfi=function(e,t,n,i,r){if(e!=d)return void console.error("spine item is not loaded");var o=new ReadiumSDK.Views.CfiNavigationLogic(u,c);return o.getElementByCfi(t,n,i,r)},this.getElementById=function(e,t){if(e!=d)return void console.error("spine item is not loaded");var n=new ReadiumSDK.Views.CfiNavigationLogic(u,c);return n.getElementById(t)},this.getElement=function(e,t){if(e!=d)return void console.error("spine item is not loaded");var n=new ReadiumSDK.Views.CfiNavigationLogic(u,c);return n.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){var e=new ReadiumSDK.Views.CfiNavigationLogic(u,c);return e.getFirstVisibleMediaOverlayElement({top:0,bottom:c.height()})},this.offset=function(){return c?c.offset():void 0}},ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START="SpineItemOpenStart",n("onePageView",["readiumSDK","cfiNavigationLogic"],function(e){return function(){var t;return t||e.onePageView}}(this)),ReadiumSDK.Models.CurrentPagesInfo=function(e,t){this.isRightToLeft=e.isRightToLeft(),this.isFixedLayout=t,this.spineItemCount=e.items.length,this.openPages=[],this.addOpenPage=function(e,t,n,i){this.openPages.push({spineItemPageIndex:e,spineItemPageCount:t,idref:n,spineItemIndex:i}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var t=this.openPages[this.openPages.length-1];return t.spineItemIndex<e.last().index||t.spineItemPageIndex<t.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var t=this.openPages[0];return e.first().index<t.spineItemIndex||0<t.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(e,t){return e.spineItemIndex!=t.spineItemIndex?e.spineItemIndex-t.spineItemIndex:e.pageIndex-t.pageIndex})}},n("currentPagesInfo",["readiumSDK"],function(e){return function(){var t;return t||e.currentPagesInfo}}(this)),ReadiumSDK.Models.Spread=function(e,t){function n(){a.leftItem=void 0,a.rightItem=void 0,a.centerItem=void 0}function i(e,t){t==ReadiumSDK.Models.Spread.POSITION_LEFT?a.leftItem=e:t==ReadiumSDK.Models.Spread.POSITION_RIGHT?a.rightItem=e:(t!=ReadiumSDK.Models.Spread.POSITION_CENTER&&console.error("Unrecognized position value"),a.centerItem=e)}function r(e){return s?e.isLeftPage()?ReadiumSDK.Models.Spread.POSITION_LEFT:e.isRightPage()?ReadiumSDK.Models.Spread.POSITION_RIGHT:ReadiumSDK.Models.Spread.POSITION_CENTER:ReadiumSDK.Models.Spread.POSITION_CENTER}function o(e){return e.isLeftPage()?a.spine.isRightToLeft()?a.spine.prevItem(e):a.spine.nextItem(e):e.isRightPage()?a.spine.isRightToLeft()?a.spine.nextItem(e):a.spine.prevItem(e):void 0}var a=this;this.spine=e,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var s=t;this.setSyntheticSpread=function(e){s=e},this.isSyntheticSpread=function(){return s},this.openFirst=function(){0==this.spine.items.length?n():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?n():this.openItem(this.spine.last())},this.openItem=function(e){n();var t=r(e);if(i(e,t),t!=ReadiumSDK.Models.Spread.POSITION_CENTER){var a=o(e);if(a){var s=r(a);s!=t&&s!=ReadiumSDK.Models.Spread.POSITION_CENTER&&i(a,s)}}},this.openNext=function(){var e=this.validItems();if(0==e.length)this.openFirst();else{var t=this.spine.nextItem(e[e.length-1]);t&&this.openItem(t)}},this.openPrev=function(){var e=this.validItems();if(0==e.length)this.openLast();else{var t=this.spine.prevItem(e[0]);t&&this.openItem(t)}},this.validItems=function(){var e=[];return this.leftItem&&e.push(this.leftItem),this.rightItem&&e.push(this.rightItem),this.centerItem&&e.push(this.centerItem),e.sort(function(e,t){return e.index-t.index}),e}},ReadiumSDK.Models.Spread.POSITION_LEFT="left",ReadiumSDK.Models.Spread.POSITION_RIGHT="right",ReadiumSDK.Models.Spread.POSITION_CENTER="center",n("fixedPageSpread",["readiumSDK"],function(e){return function(){var t;return t||e.fixedPageSpread}}(this)),ReadiumSDK.Models.BookmarkData=function(e,t){this.idref=e,this.contentCFI=t},n("bookmarkData",["readiumSDK"],function(e){return function(){var t;return t||e.bookmarkData}}(this)),ReadiumSDK.Views.FixedView=function(e){function t(t){var n=new ReadiumSDK.Views.OnePageView(e,[t],!1);return n.on(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,function(e,t){m.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,e,t)}),n}function n(){var e=N.validItems();return e[0]}function i(e,t){if(x)return void(D={initiator:e,paginationRequest:t});x=!0;var n={isElementAdded:!1},a=r([{pageView:w,spineItem:N.leftItem,context:n},{pageView:C,spineItem:N.rightItem,context:n},{pageView:E,spineItem:N.centerItem,context:n}]);$.when.apply($,a).done(function(){if(x=!1,D){var r=D.initiator,a=D.paginationRequest;D=void 0,i(r,a)}else n.isElementAdded&&m.applyStyles(),t?o(e,t.spineItem,t.elementId):o(e)})}function r(e){for(var t=[],n=0;n<e.length;n++){var i=f(e[n].pageView,e[n].spineItem,e[n].context);t.push(i)}return t}function o(e,t,n){c(),l(),m.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:m.getPaginationInfo(),initiator:e,spineItem:t,elementId:n})}function a(e,t){var n=new ReadiumSDK.Models.Spread(S,t);return n.openItem(e),N.leftItem!=n.leftItem||N.rightItem!=n.rightItem||N.centerItem!=n.centerItem}function s(){if(!P||!b)return!1;var e=v.width(),t=v.height();return e&&t}function l(e){if(O(0,!1),s()){var t=v.width(),n=v.height(),i=w.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(w.element()):ReadiumSDK.Helpers.Margins.empty(),r=C.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(C.element()):ReadiumSDK.Helpers.Margins.empty(),o=E.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(E.element()):ReadiumSDK.Helpers.Margins.empty(),a=u(i,r,o),l={width:t-b.width(),height:n-b.height()},c={width:l.width-a.width(),height:l.height-a.height()};if(!(l.width<=0||l.height<=0)){var d,f=c.width/P.width,h=c.height/P.height;d="fit-width"==R.style?f:"fit-height"==R.style?h:"user"==R.style?R.scale:Math.min(f,h),p=d;var S={width:P.width*d,height:P.height*d},y={width:S.width+a.width(),height:S.height+a.height()},I={width:y.width+b.width(),height:y.height+b.height()},T=Math.floor((t-I.width)/2),N=Math.floor((n-I.height)/2);0>T&&(T=0),0>N&&(N=0),g.css("left",T+"px"),g.css("top",N+"px"),g.css("width",y.width+"px"),g.css("height",y.height+"px");var x=b.padding.left,D=b.padding.top,_=e?"transformContentImmediate":"transformContent";w.isDisplaying()&&w[_](d,x,D),C.isDisplaying()&&(x+=P.separatorPosition*d,w.isDisplaying()&&(x+=i.left),C[_](d,x,D)),E.isDisplaying()&&E[_](d,x,D),m.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}}}function u(e,t,n){var i={left:Math.max(e.margin.left,t.margin.left,n.margin.left),right:Math.max(e.margin.right,t.margin.right,n.margin.right),top:Math.max(e.margin.top,t.margin.top,n.margin.top),bottom:Math.max(e.margin.bottom,t.margin.bottom,n.margin.bottom)},r={left:Math.max(e.border.left,t.border.left,n.border.left),right:Math.max(e.border.right,t.border.right,n.border.right),top:Math.max(e.border.top,t.border.top,n.border.top),bottom:Math.max(e.border.bottom,t.border.bottom,n.border.bottom)},o={left:Math.max(e.padding.left,t.padding.left,n.padding.left),right:Math.max(e.padding.right,t.padding.right,n.padding.right),top:Math.max(e.padding.top,t.padding.top,n.padding.top),bottom:Math.max(e.padding.bottom,t.padding.bottom,n.padding.bottom)};return new ReadiumSDK.Helpers.Margins(i,r,o)}function c(){P={},E.isDisplaying()?(P.width=E.meta_width(),P.height=E.meta_height(),P.separatorPosition=0):w.isDisplaying()&&C.isDisplaying()?w.meta_height()==C.meta_height()?(P.width=w.meta_width()+C.meta_width(),P.height=w.meta_height(),P.separatorPosition=w.meta_width()):(P.width=w.meta_width()+C.meta_width()*(w.meta_height()/C.meta_height()),P.height=w.meta_height(),P.separatorPosition=w.meta_width()):w.isDisplaying()?(P.width=2*w.meta_width(),P.height=w.meta_height(),P.separatorPosition=w.meta_width()):C.isDisplaying()?(P.width=2*C.meta_width(),P.height=C.meta_height(),P.separatorPosition=C.meta_width()):P=void 0}function d(){b=ReadiumSDK.Helpers.Margins.fromElement(g)}function f(e,t,n){var i=$.Deferred();return t?(e.isDisplaying()||(g.append(e.render().element()),n.isElementAdded=!0),e.loadSpineItem(t,function(t,n,r,o){t&&o&&(e.meta_height()&&e.meta_width()||console.error("Invalid document "+r.href+": viewport is not specified!"),m.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,n,r)),i.resolve()},n)):(e.isDisplaying()&&e.remove(),i.resolve()),i.promise()}function h(){var e=[];e=S.isLeftToRight()?[w,E,C]:[C,E,w];for(var t=[],n=0,i=e.length;i>n;n++)e[n].isDisplaying()&&t.push(e[n]);return t}_.extend(this,Backbone.Events);var g,p,m=this,v=e.$viewport,S=e.spine,y=e.userStyles,R=(e.bookStyles,e.zoom||{style:"default"}),I=(e.iframeLoader,void 0),w=t("fixed-page-frame-left"),C=t("fixed-page-frame-right"),E=t("fixed-page-frame-center"),T=[];T.push(w),T.push(C),T.push(E);var b,P,N=new ReadiumSDK.Models.Spread(S,!1),x=!1,D=!1;this.isReflowable=function(){return!1},this.setZoom=function(e){R=e,l(!1)},this.render=function(){var e=ReadiumSDK.Helpers.loadTemplate("fixed_book_frame",{});return g=$(e),_.each(["-webkit-","-moz-","-ms-",""],function(e){g.css(e+"transition","all 0 ease 0")}),g.css("overflow","hidden"),v.append(g),m.applyStyles(),this},this.remove=function(){g.remove()},this.setViewSettings=function(e){I=e,N.setSyntheticSpread(1==ReadiumSDK.Helpers.deduceSyntheticSpread(v,n(),I));for(var t=h(),i=0,r=t.length;r>i;i++)t[i].setViewSettings(e)};var O=function(e,t){w&&w.updatePageSwitchDir(e,t),C&&C.updatePageSwitchDir(e,t),E&&E.updatePageSwitchDir(e,t)};this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(y.getStyles(),g.parent()),d(),c(),l()},this.applyBookStyles=function(){for(var e=h(),t=0,n=e.length;n>t;t++)e[t].applyBookStyles()},this.onViewportResize=function(){var e=n();if(e){var t=1==ReadiumSDK.Helpers.deduceSyntheticSpread(v,e,I);if(a(e,t)){N.setSyntheticSpread(t);var i=new ReadiumSDK.Models.PageOpenRequest(e,m);m.openPage(i)}else l(!0)}},this.getViewScale=function(){return p},this.openPage=function(e,t){if(e.spineItem){var n=N.leftItem,r=N.rightItem,o=N.centerItem,a=1==ReadiumSDK.Helpers.deduceSyntheticSpread(v,e.spineItem,I);N.setSyntheticSpread(a),N.openItem(e.spineItem);var s=n!==N.leftItem||r!==N.rightItem||o!==N.centerItem;(null===t||"undefined"==typeof t)&&(t=0),O(0===t?0:N.spine.isRightToLeft()?1===t?2:1:t,s),i(e.initiator,e)}},this.openPagePrev=function(e){N.openPrev(),O(N.spine.isRightToLeft()?2:1,!0),i(e,void 0)},this.openPageNext=function(e){N.openNext(),O(N.spine.isRightToLeft()?1:2,!0),i(e,void 0)},this.getPaginationInfo=function(){for(var e=new ReadiumSDK.Models.CurrentPagesInfo(S,!0),t=[N.leftItem,N.rightItem,N.centerItem],n=0;n<t.length;n++){var i=t[n];i&&e.addOpenPage(0,1,i.idref,i.index)}return e},this.bookmarkCurrentPage=function(){var e=h();if(e.length>0){var t=e[0].currentSpineItem().idref,n=e[0].getFirstVisibleElementCfi();return void 0==n&&(n=""),new ReadiumSDK.Models.BookmarkData(t,n)}return new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return N.validItems()},this.getElement=function(e,t){for(var n=h(),i=0,r=n.length;r>i;i++){var o=n[i];if(o.currentSpineItem()==e)return o.getElement(e,t)}return void console.error("spine item is not loaded")},this.getElementById=function(e,t){for(var n=h(),i=0,r=n.length;r>i;i++){var o=n[i];if(o.currentSpineItem()==e)return o.getElementById(e,t)}return void console.error("spine item is not loaded")},this.getElementByCfi=function(e,t,n,i,r){for(var o=h(),a=0,s=o.length;s>a;a++){var l=o[a];if(l.currentSpineItem()==e)return l.getElementByCfi(e,t,n,i,r)}return void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){for(var e=h(),t=0,n=e.length;n>t;t++){var i=e[t].getFirstVisibleMediaOverlayElement();if(i)return i}return void 0},this.insureElementVisibility=function(){}},n("fixedView",["readiumSDK","onePageView","currentPagesInfo","fixedPageSpread","bookmarkData"],function(e){return function(){var t;return t||e.fixedView}}(this)),ReadiumSDK.Views.ReflowableView=function(e){function t(e){y.css("left",e.left+"px"),y.css("top",e.top+"px"),y.css("right",e.right+"px"),y.css("bottom",e.bottom+"px")}function n(){y&&y.remove();var e=ReadiumSDK.Helpers.loadTemplate("reflowable_book_page_frame",{}),t=$(e);t=I.append(t),y=$("#reflowable-content-frame",t),w=$("#epubContentIframe",t),w.css("left",""),w.css("right",""),w.css("position","relative"),w.css("overflow","hidden"),R=new ReadiumSDK.Views.CfiNavigationLogic(y,w,{rectangleBased:!0,paginationInfo:V})}function i(e){if(v!=e){n(),V.pageOffset=0,V.currentSpreadIndex=0,v=e,k=!0;var t=D.package.resolveRelativeUrl(e.href);N.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,w,e),w.css("opacity","0.01"),M.loadIframe(w[0],t,a,N,{spineItem:e})}}function r(){C&&C.css("font-size",L+"%")}function o(){C&&_.each(["-webkit-","-moz-","-ms-",""],function(e){C.css(e+"column-gap",V.columnGap+"px")})}function a(e){if(k=!1,S&&S.spineItem!=v)return void i(S.spineItem);if(!e)return w.css("opacity","1"),void(S=void 0);N.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,w,v);var t=w[0].contentDocument;C=$("html",t),E=$("body",C),T=!1,b=!0,P=void 0;var n=w[0].contentDocument.defaultView||w[0].contentWindow,a=n.getComputedStyle(E[0],null);if(a){b="ltr"===a.direction;var s=void 0;s=a.getPropertyValue?a.getPropertyValue("-webkit-writing-mode")||a.getPropertyValue("-moz-writing-mode")||a.getPropertyValue("-ms-writing-mode")||a.getPropertyValue("-o-writing-mode")||a.getPropertyValue("-epub-writing-mode")||a.getPropertyValue("writing-mode"):a.webkitWritingMode||a.mozWritingMode||a.msWritingMode||a.oWritingMode||a.epubWritingMode||a.writingMode,s&&(P=s.indexOf("-lr")>=0,(s.indexOf("vertical")>=0||s.indexOf("tb-")>=0||s.indexOf("bt-")>=0)&&(T=!0))}b&&("rtl"===E[0].getAttribute("dir")||"rtl"===C[0].getAttribute("dir"))&&(b=!1),D.isLeftToRight()||!b||T||(E[0].setAttribute("dir","rtl"),b=!1,P=!1),V.isVerticalWritingMode=T,f(),w.css("opacity","1"),u(),C.css("height",B.height+"px"),C.css("position","relative"),C.css("margin","0"),C.css("padding","0"),_.each(["-webkit-","-moz-","-ms-",""],function(e){C.css(e+"column-axis",T?"vertical":"horizontal")}),N.applyBookStyles(),p(),r(),o(),N.applyStyles()}function s(){if(S){var e=S;S=void 0,N.openPage(e)}}function l(){var e=-V.pageOffset+"px";if(T)C.css("top",e);else{var t=b||P;C.css("left",t?e:""),C.css("right",t?"":e)}h()}function u(){var e=y.width(),t=y.height();return B.width!==e||B.height!==t?(B.width=e,B.height=t,!0):!1}function c(e,t,n){V.pageOffset=(V.columnWidth+V.columnGap)*V.visibleColumnCount*V.currentSpreadIndex,l(),N.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:N.getPaginationInfo(),initiator:e,spineItem:t,elementId:n})}function d(){var e=550,t=400,n=ReadiumSDK.Helpers.deduceSyntheticSpread(x,v,H),i=n===!1||n===!0;if(0===n&&(n=1),V.visibleColumnCount=n?2:1,T&&(e*=2,n=!1,i=!0,V.visibleColumnCount=1),C){f();var r=parseInt(x.css("border-left-width")),o=parseInt(x.css("border-right-width")),a=V.columnGap/2;a=Math.max(0,a-r);var l=V.columnGap/2;l=Math.max(0,l-o);var d=0;if(H.fontSize){var h=.8*H.fontSize/100;e=Math.floor(e*h),t=Math.floor(t*h)}var g=x.width(),p=g-r-o-a-l;n&&(p=.5*(p-V.columnGap)),p>e?d=Math.floor((p-e)*(n?1:.5)):!i&&t>p&&n&&(n=!1,V.visibleColumnCount=1,p=g-r-o-a-l,p>e&&(d=Math.floor(.5*(p-e)))),I.css({left:d+a+"px",right:d+l+"px"}),u(),w.css("width",B.width+"px"),w.css("height",B.height+"px"),C.css("height",B.height+"px"),C.css("min-height",B.height+"px"),C.css("max-height",B.height+"px"),C.css("margin",0),C.css("padding",0),C.css("border",0),E.css("margin",0),E.css("padding",0);var m=0;try{m=parseInt(E.css("padding-top"))+parseInt(E.css("border-top-width"))+parseInt(E.css("border-bottom-width"))}catch(y){}E.css("min-height","50%"),E.css("max-height",B.height-m+"px"),V.rightToLeft=D.isRightToLeft(),V.columnWidth=Math.round(((T?B.height:B.width)-V.columnGap*(V.visibleColumnCount-1))/V.visibleColumnCount),C.css("width",(T?B.width:V.columnWidth)+"px"),_.each(["-webkit-","-moz-","-ms-",""],function(e){C.css(e+"column-width",V.columnWidth+"px")}),C.css({left:"0",right:"0",top:"0"}),ReadiumSDK.Helpers.triggerLayout(w),V.columnCount=((T?C[0].scrollHeight:C[0].scrollWidth)+V.columnGap)/(V.columnWidth+V.columnGap),V.columnCount=Math.round(V.columnCount);var R=(V.columnCount-1)*V.columnGap,b=((T?C[0].scrollHeight:C[0].scrollWidth)-R)/V.columnCount;b=Math.round(b),b>V.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(V.columnWidth),console.log(b),V.columnWidth=b),V.spreadCount=Math.ceil(V.columnCount/V.visibleColumnCount),V.currentSpreadIndex>=V.spreadCount&&(V.currentSpreadIndex=V.spreadCount-1),S?s():c(N)}}function f(){-1==F&&(F=C.css("opacity"),C.css("opacity","0"))}function h(){-1!=F&&C.css("opacity",F),F=-1}function g(){for(var e=[],t=V.currentSpreadIndex*V.visibleColumnCount,n=0;n<V.visibleColumnCount&&t+n<V.columnCount;n++)e.push(t+n);return e}function p(){if(C){var e;$("img, svg",C).each(function(){e=$(this),e.css("max-width","98%"),e.css("max-height","98%"),e.css("height")||e.css("height","auto"),e.css("width")||e.css("width","auto")})}}function m(){var e=Math.round(V.pageOffset/(V.columnWidth+V.columnGap)),t=e*y.height(),n=t+V.visibleColumnCount*y.height();return{top:t,bottom:n}}_.extend(this,Backbone.Events);var v,S,y,R,I,w,C,E,T,b,P,N=this,x=e.$viewport,D=e.spine,O=e.userStyles,A=e.bookStyles,M=e.iframeLoader,k=!1,L=100,F=-1,B={width:void 0,height:void 0},V={visibleColumnCount:2,columnGap:20,spreadCount:0,currentSpreadIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var e=ReadiumSDK.Helpers.loadTemplate("reflowable_book_frame",{});I=$(e),x.append(I);var t=H;return t||(t=new ReadiumSDK.Models.ViewerSettings({})),t.enableGPUHardwareAccelerationCSS3D&&I.css("transform","translateZ(0)"),n(),N},this.remove=function(){I.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){u()&&d()};var H=void 0;this.setViewSettings=function(e){H=e,V.columnGap=e.columnGap,L=e.fontSize,r(),o(),u(),d()},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(O.getStyles(),I.parent());var e=ReadiumSDK.Helpers.Margins.fromElement(I);t(e.padding),u(),d()},this.applyBookStyles=function(){C&&ReadiumSDK.Helpers.setStyles(A.getStyles(),C)},this.openPage=function(e){if(k)return void(S=e);if(e.spineItem&&e.spineItem!=v)return S=e,void i(e.spineItem);var t=void 0;if(void 0!==e.spineItemPageIndex)t=e.spineItemPageIndex;else if(e.elementId)t=R.getPageForElementId(e.elementId);else if(e.elementCfi)try{t=R.getPageForElementCfi(e.elementCfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(n){t=0,console.error(n)}else e.firstPage?t=0:e.lastPage?t=V.columnCount-1:(console.debug("No criteria in pageRequest"),t=0);t>=0&&t<V.columnCount?(V.currentSpreadIndex=Math.floor(t/V.visibleColumnCount),c(e.initiator,e.spineItem,e.elementId)):console.log("Illegal pageIndex value: ",t,"column count is ",V.columnCount)},this.openPagePrev=function(e){if(v)if(V.currentSpreadIndex>0)V.currentSpreadIndex--,c(e);else{var t=D.prevItem(v,!0);if(t){var n=new ReadiumSDK.Models.PageOpenRequest(t,e);n.setLastPage(),N.openPage(n)}}},this.openPageNext=function(e){if(v)if(V.currentSpreadIndex<V.spreadCount-1)V.currentSpreadIndex++,c(e);else{var t=D.nextItem(v,!0);if(t){var n=new ReadiumSDK.Models.PageOpenRequest(t,e);n.setFirstPage(),N.openPage(n)}}},this.getFirstVisibleElementCfi=function(){var e=m();return R.getFirstVisibleElementCfi(e)},this.getPaginationInfo=function(){var e=new ReadiumSDK.Models.CurrentPagesInfo(D,!1);if(!v)return e;for(var t=g(),n=0,i=t.length;i>n;n++)e.addOpenPage(t[n],V.columnCount,v.idref,v.index);return e},this.bookmarkCurrentPage=function(){return v?new ReadiumSDK.Models.BookmarkData(v.idref,N.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return[v]},this.getElementByCfi=function(e,t,n,i,r){return e!=v?void console.error("spine item is not loaded"):R.getElementByCfi(t,n,i,r)},this.getElementById=function(e,t){return e!=v?void console.error("spine item is not loaded"):R.getElementById(t)},this.getElement=function(e,t){return e!=v?void console.error("spine item is not loaded"):R.getElement(t)},this.getFirstVisibleMediaOverlayElement=function(){var e=m();return R.getFirstVisibleMediaOverlayElement(e)},this.insureElementVisibility=function(e,t,n){var i=$(t);if(!R.isElementVisible(i,m())){var r=R.getPageForElement(i);if(-1!=r){var o=new ReadiumSDK.Models.PageOpenRequest(v,n);o.setPageIndex(r);var a=t.id;a||(a=t.getAttribute("id")),a&&o.setElementId(a),N.openPage(o)}}}},n("reflowableView",["readiumSDK","cfiNavigationLogic","bookmarkData"],function(e){return function(){var t;return t||e.reflowableView}}(this)),ReadiumSDK.Models.SmilIterator=function(e){function t(e,n,i){for(var r=e,o=n.children.length;r>=0&&o>r;r+=i?-1:1){var a=n.children[r];if("par"==a.nodeType)return a;if(a=t(i?a.children.length-1:0,a,i))return a}return n.parent?t(n.index+(i?-1:1),n.parent,i):void 0}this.smil=e,this.currentPar=void 0,this.reset=function(){this.currentPar=t(0,this.smil,!1)},this.findTextId=function(e){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!e)return!1;for(;this.currentPar;){if(this.currentPar.element){if(e===this.currentPar.text.srcFragmentId)return!0;for(var t=this.currentPar.element.parentNode;t;){if(t.id&&t.id==e)return!0;t=t.parentNode}var n=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(e),this.currentPar.element);if(n&&n.length&&n[0])return!0}this.next()}return!1},this.next=function(){return this.currentPar?void(this.currentPar=t(this.currentPar.index+1,this.currentPar.parent,!1)):void console.debug("Par iterator is out of range")},this.previous=function(){return this.currentPar?void(this.currentPar=t(this.currentPar.index-1,this.currentPar.parent,!0)):void console.debug("Par iterator is out of range")},this.isLast=function(){return this.currentPar?t(this.currentPar.index+1,this.currentPar.parent,!1)?!1:!0:void console.debug("Par iterator is out of range")},this.goToPar=function(e){for(;this.currentPar&&this.currentPar!=e;)this.next()},this.reset()},n("smilIterator",["readiumSDK"],function(e){return function(){var t;return t||e.smilIterator}}(this)),ReadiumSDK.Views.MediaOverlayDataInjector=function(e,t){this.attachMediaOverlayData=function(n,i,r){var o=n[0].contentDocument.documentElement;if(i.media_overlay_id||0!==e.smil_models.length){var a=$("body",o);if(0==a.length)console.error("! BODY ???");else{var s=a.data("mediaOverlayClick");if(s)console.error("[WARN] already mediaOverlayClick");else{a.data("mediaOverlayClick",{ping:"pong"});var l="ontouchstart"in document.documentElement?"touchstart":"click";a.bind(l,function(e){var n=$(this)[0];if(n=e.target,!n)return t.touchInit(),!0;var i=void 0,o=n,a=!1;for("a"===o.nodeName.toLowerCase()&&(a=!0);!(i=$(o).data("mediaOverlayData"))&&("a"===o.nodeName.toLowerCase()&&(a=!0),o=o.parentNode););if(i&&(i.par||i.pars)){if(!r.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),t.touchInit(),!0;if(a)return console.log("MO CLICKED LINK"),t.touchInit(),!0;var s=i.par?i.par:i.pars[0];if(i.pars&&"undefined"!=typeof rangy){var l=!1;t.isPlayingCfi()&&(l=!0,t.pause());try{var u=rangy.positionFromPoint(e.pageX,e.pageY,n.ownerDocument);s=void 0;for(var c=0;c<i.pars.length;c++){var d=i.pars[c],f="epubcfi("+d.cfi.partialStartCfi+")",h=EPUBcfi.getTextTerminusInfoWithPartialCFI(f,n.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),g="epubcfi("+d.cfi.partialEndCfi+")",p=EPUBcfi.getTextTerminusInfoWithPartialCFI(g,n.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),m=rangy.createRange(n.ownerDocument);if(m.setStartAndEnd(h.textNode[0],h.textOffset,p.textNode[0],p.textOffset),m.isPointInRange(u.node,u.offset)){s=d;break}}}catch(v){console.error(v)}if(!s)return l&&t.toggleMediaOverlay(),!0}return o&&o!=n&&"body"===o.nodeName.toLowerCase()&&s&&!s.getSmil().id?(t.touchInit(),!0):(t.playUserPar(s),!0)}var S=$(n).attr("ibooks:readaloud");if(S||(S=$(n).attr("epub:readaloud")),S){console.debug("MO readaloud attr: "+S);var y=t.isPlaying();if("start"===S&&!y||"stop"===S&&y||"startstop"===S)return t.toggleMediaOverlay(),!0}return t.touchInit(),!0})}}var u=e.getSmilBySpineItem(i);if(!u)return void console.error("NO SMIL?? "+i.idref+" /// "+i.media_overlay_id);var c=function(e){if(e){if(e.nodeType&&"seq"===e.nodeType&&e.textref){var t=e.textref.split("#"),r=t[0],o=2===t.length?t[1]:"";if(r&&o){var a=ReadiumSDK.Helpers.ResolveContentRef(r,u.href),s=a===i.href;s&&(e.element=n[0].contentDocument.getElementById(o),e.element||console.error("seq.textref !element? "+e.textref))}}if(e.children&&e.children.length)for(var l=0;l<e.children.length;l++){var d=e.children[l];c(d)}}};c(u);for(var d=new ReadiumSDK.Models.SmilIterator(u),f="/99!",h="epubcfi";d.currentPar;){d.currentPar.element=void 0,d.currentPar.cfi=void 0;var g=ReadiumSDK.Helpers.ResolveContentRef(d.currentPar.text.srcFile,d.smil.href),p=g===i.href;if(p){var m=!d.currentPar.text.srcFragmentId||0==d.currentPar.text.srcFragmentId.length,v=0==d.currentPar.text.srcFragmentId.indexOf(h)?void 0:d.currentPar.text.srcFragmentId,S=void 0,y=!1;if(m||v)S=m?a:$(n[0].contentDocument.getElementById(v));else if(0===d.currentPar.text.srcFragmentId.indexOf(h)){var R=d.currentPar.text.srcFragmentId.substr(h.length+1,d.currentPar.text.srcFragmentId.length-h.length-2);0===R.indexOf(f)&&(R=R.substr(f.length,R.length-f.length));var I=R.split(",");if(I&&3===I.length)try{var w=I[0]+I[1],C="epubcfi("+w+")",E=EPUBcfi.getTextTerminusInfoWithPartialCFI(C,n[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),T=I[0]+I[2],b="epubcfi("+T+")",P=(EPUBcfi.getTextTerminusInfoWithPartialCFI(b,n[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),E.textNode[0].parentNode);d.currentPar.cfi={smilTextSrcCfi:d.currentPar.text.srcFragmentId,partialRangeCfi:R,partialStartCfi:w,partialEndCfi:T,cfiTextParent:P},y=!0,S=$(P);var N=S.data("mediaOverlayData");if(N){N.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),N.par=void 0);var x=!1;if(N.pars)for(var D=0;D<N.pars.length;D++){var O=N.pars[D];O===d.currentPar&&(x=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else N.pars=[];x||N.pars.push(d.currentPar)}else N={pars:[d.currentPar]},S.data("mediaOverlayData",N)}catch(_){console.error(_)}else try{var A="epubcfi("+R+")";S=EPUBcfi.getTargetElementWithPartialCFI(A,n[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(_){console.error(_)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+d.currentPar.text.srcFragmentId);if(S&&S.length>0){if(!y){d.currentPar.element&&d.currentPar.element!==S[0]&&console.error("DIFFERENT ELEMENTS??! "+d.currentPar.text.srcFragmentId+" /// "+d.currentPar.element.id);var M=S[0].nodeName?S[0].nodeName.toLowerCase():void 0;("audio"===M||"video"===M)&&S.attr("preload","auto"),d.currentPar.element=S[0];var N=S.data("mediaOverlayData");N&&(console.error("[WARN] MO DATA already exists."),N.par&&N.par!==d.currentPar&&console.error("DIFFERENT PARS??!")),S.data("mediaOverlayData",{par:d.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+d.currentPar.text.srcFragmentId+" == "+d.currentPar.text.srcFile+" /// "+i.href)}d.next()}}}},n("mediaOvelayDataInjector",["readiumSDK","mediaOverlay","mediaOverlayPlayer","smilModel","spineItem","smilIterator","rangy"],function(e){return function(){var t;return t||e.mediaOvelayDataInjector}}(this)),ReadiumSDK.Views.InternalLinksSupport=function(e){function t(e){var t=e.indexOf("("),n=e.indexOf("!"),i=e.indexOf(")");return-1==n?void 0:(-1==i&&(i=e.length),{spineItemCfi:e.substring(t+1,n),elementCfi:e.substring(n+1,i)})}function n(t,n){var i=e.package().resolveRelativeUrl(n.href),r=t.absoluteTo(i);return r}function i(i,o){var a=n(i,o);if(!a)return void console.error("Unable to resolve "+i.href());var l=i.fragment(),u=a.toString();u=ReadiumSDK.Helpers.RemoveFromString(u,"#"+l),r(u,function(n){if(n){var i=new window.DOMParser,r=i.parseFromString(n,"text/xml"),o=t(l);if(!o)return void console.warn("Unable to split cfi:"+l);var a=EPUBcfi.Interpreter.getContentDocHref("epubcfi("+o.spineItemCfi+")",r);if(a){var u=e.spine().getItemByHref(a);u?e.openSpineItemElementCfi(u.idref,o.elementCfi,s):console.warn("Unable to find spineItem with href="+a)}else console.warn("Unable to find document ref from "+l+" cfi")}})}function r(e,t){$.ajax({isLocal:0===e.indexOf("http")?!1:!0,url:e,dataType:"text",async:!0,success:function(e){t(e)},error:function(n,i,r){console.error("Error when AJAX fetching "+e),console.error(i),console.error(r),t()}})}function o(e){var t=e.filename();return t&&ReadiumSDK.Helpers.EndsWith(t,".opf")}function a(t,n){var i,r=t.filename();if(r){var o=new URI(t,n.href),a=decodeURIComponent(o.pathname()),l=e.spine().getItemByHref(a);if(!l)return void console.error("spine item with href="+a+" not found");i=l.idref}else i=n.idref;var u=t.fragment();e.openSpineItemElementId(i,u,s)}var s=this;this.processLinkElements=function(e,t){var n=e[0].contentDocument;$("a",n).click(function(e){var n;n=e.currentTarget.attributes["xlink:href"]?e.currentTarget.attributes["xlink:href"].value:e.currentTarget.attributes.href.value;var r=!1,s=new URI(n),l=s.is("relative");l?o(s)?(i(s,t),r=!0):(a(s,t),r=!0):(window.open(n,"_blank"),r=!0),r&&(e.preventDefault(),e.stopPropagation())})}},n("internalLinksSupport",["readiumSDK","URIjs"],function(e){return function(){var t;return t||e.internalLinksSupport}}(this)),ReadiumSDK.Views.IFrameLoader=function(){var e=this,t={};this.addIFrameEventListener=function(e,n,i){void 0==t[e]&&(t[e]=[]),t[e].push({callback:n,context:i})},this.updateIframeEvents=function(e){_.each(t,function(t,n){for(var i=0,r=t.length;r>i;i++)$(e.contentWindow).off(n),$(e.contentWindow).on(n,t[i].callback,t[i].context)
})},this.loadIframe=function(t,n,i,r,o){t.setAttribute("data-baseUri",t.baseURI),t.setAttribute("data-src",n);var a=new URI(n).absoluteTo(t.baseURI).toString();e._loadIframeWithUri(t,o,a,function(){var e=t.contentDocument||t.contentWindow.document;$("svg",e).load(function(){console.log("loaded")}),i.call(r,!0,o)})},this._loadIframeWithUri=function(t,n,i,r){t.onload=function(){e.updateIframeEvents(t);var n=t.contentWindow.MathJax;if(n){var i=_.once(r);n.Hub.Queue(i)}else r()},t.setAttribute("src",i)}},n("iframeLoader",["readiumSDK"],function(e){return function(){var t;return t||e.iframeLoader}}(this));var i=function(e,t,n){var i={};i.TextLineInferrer=Backbone.Model.extend({initialize:function(){},inferLines:function(e){for(var t,n,i,r=[],o=e.length,a=0,s=0;o-1>=s;s++){n=e[s],i=!1;for(var l=0;a-1>=l;l++)if(t=r[l],this.includeRectInLine(t,n.top,n.left,n.width,n.height)){this.expandLine(t,n.left,n.top,n.width,n.height),i=!0;break}i||(r.push(this.createNewLine(n.left,n.top,n.width,n.height)),a+=1)}return r},includeRectInLine:function(e,t,n,i,r){return this.rectIsWithinLineVertically(t,r,e.maxTop,e.maxBottom)&&this.rectIsWithinLineHorizontally(n,i,e.left,e.width,e.avgHeight)?!0:!1},rectIsWithinLineVertically:function(e,t,n,i){var r=e+t,o=i-n,a=.75*o/2,s=.75*t/2;return e+=s,r-=s,n+=a,i-=a,e===n&&r===i?!0:n>e&&i>r&&r>n?!0:e>n&&r>i&&i>e?!0:e>n&&i>r?!0:n>e&&r>i?!0:!1},rectIsWithinLineHorizontally:function(e,t,n,i,r){var o=2*r,a=e+t,s=e+i;return n-a>o?!1:e-s>o?!1:!0},createNewLine:function(e,t,n,i){var r=t+i;return{left:e,startTop:t,width:n,avgHeight:i,maxTop:t,maxBottom:r,numRects:1}},expandLine:function(e,t,n,i,r){var o=(e.left+e.width,t+i),a=n+r,s=e.numRects+1,l=e.avgHeight*e.numRects,u=(l+r)/s;return e.avgHeight=u,e.numRects=s,e=this.expandLineVertically(e,n,a),e=this.expandLineHorizontally(e,t,o)},expandLineVertically:function(e,t,n){return t<e.maxTop&&(e.maxTop=t),n>e.maxBottom&&(e.maxBottom=n),e},expandLineHorizontally:function(e,t,n){var i=e.left<=t?e.left:t,r=e.left+e.width,o=r>=n?r:n,a=o-i;return e.left=i,e.width=a,e}}),i.Highlight=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),i.HighlightGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],highlightViews:[]}},initialize:function(e){this.set("scale",e.scale),this.constructHighlightViews()},highlightGroupCallback:function(e){var t=this;return"click"===e.type?void t.get("bbPageSetView").trigger("annotationClicked","highlight",t.get("CFI"),t.get("id"),e):"contextmenu"===e.type?void t.get("bbPageSetView").trigger("annotationRightClicked","highlight",t.get("CFI"),t.get("id"),e):void _.each(this.get("highlightViews"),function(t){"mouseenter"===e.type?t.setHoverHighlight():"mouseleave"===e.type&&t.setBaseHighlight()})},constructHighlightViews:function(){var e,t,n=this,r=[];_.each(this.get("selectedNodes"),function(e){var t,n=document.createRange();n.selectNodeContents(e),t=n.getClientRects(),_.each(t,function(e){r.push(e)})}),e=new i.TextLineInferrer,t=e.inferLines(r);var o=this.get("scale");_.each(t,function(e){var t=e.startTop/o,r=e.left/o,a=e.avgHeight/o,s=e.width/o,l=new i.HighlightView({CFI:n.get("CFI"),top:t+n.get("offsetTopAddition"),left:r+n.get("offsetLeftAddition"),height:a,width:s,styles:n.get("styles"),highlightGroupCallback:n.highlightGroupCallback,callbackContext:n});n.get("highlightViews").push(l)})},resetHighlights:function(e,t,n){t&&this.set({offsetTopAddition:t}),n&&this.set({offsetLeftAddition:n}),this.destroyCurrentHighlights(),this.constructHighlightViews(),this.renderHighlights(e)},destroyCurrentHighlights:function(){_.each(this.get("highlightViews"),function(e){e.remove(),e.off()}),this.get("highlightViews").length=0},renderHighlights:function(e){_.each(this.get("highlightViews"),function(t){$(e).append(t.render())})},toInfo:function(){return{id:this.get("id"),type:"highlight",CFI:this.get("CFI")}},setStyles:function(e){var t=this.get("highlightViews");this.set({styles:e}),_.each(t,function(t){t.setStyles(e)})}}),i.Underline=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),i.UnderlineGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],underlineViews:[]}},initialize:function(){this.constructUnderlineViews()},underlineGroupCallback:function(e){var t=this;return"click"===e.type?void t.get("bbPageSetView").trigger("annotationClicked","underline",t.get("CFI"),t.get("id"),e):void _.each(this.get("underlineViews"),function(t){"mouseenter"===e.type?t.setHoverUnderline():"mouseleave"===e.type&&t.setBaseUnderline()})},constructUnderlineViews:function(){var e,t,n=this,r=[];_.each(this.get("selectedNodes"),function(e){var t,n=document.createRange();n.selectNodeContents(e),t=n.getClientRects(),_.each(t,function(e){r.push(e)})}),e=new i.TextLineInferrer,t=e.inferLines(r),_.each(t,function(e){var t=e.startTop,r=e.left,o=e.avgHeight,a=e.width,s=new i.UnderlineView({CFI:n.get("CFI"),top:t+n.get("offsetTopAddition"),left:r+n.get("offsetLeftAddition"),height:o,width:a,styles:n.get("styles"),underlineGroupCallback:n.underlineGroupCallback,callbackContext:n});n.get("underlineViews").push(s)})},resetUnderlines:function(e,t,n){t&&this.set({offsetTopAddition:t}),n&&this.set({offsetLeftAddition:n}),this.destroyCurrentUnderlines(),this.constructUnderlineViews(),this.renderUnderlines(e)},destroyCurrentUnderlines:function(){_.each(this.get("underlineViews"),function(e){e.remove(),e.off()}),this.get("underlineViews").length=0},renderUnderlines:function(e){_.each(this.get("underlineViews"),function(t){$(e).append(t.render())})},toInfo:function(){return{id:this.get("id"),type:"underline",CFI:this.get("CFI")}},setStyles:function(e){var t=this.get("underlineViews");this.set({styles:e}),_.each(t,function(t){t.setStyles(e)})}}),i.Bookmark=Backbone.Model.extend({defaults:{isVisible:!1,bookmarkCenteringAdjustment:15,bookmarkTopAdjustment:45},initialize:function(){},getAbsoluteTop:function(){var e=$(this.get("targetElement")).offset().top,t=this.get("offsetTopAddition")+e-this.get("bookmarkTopAdjustment");return t},getAbsoluteLeft:function(){var e=$(this.get("targetElement")).offset().left,t=this.get("offsetLeftAddition")+e-this.get("bookmarkCenteringAdjustment");return t},toInfo:function(){return{id:this.get("id"),type:"bookmark",CFI:this.get("CFI")}}}),i.ReflowableAnnotations=Backbone.Model.extend({initialize:function(){this.epubCFI=EPUBcfi,this.annotations=new i.Annotations({offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:$("html",this.get("contentDocumentDOM"))[0],scale:0,bbPageSetView:this.get("bbPageSetView")});var e=this.get("annotationCSSUrl");e&&this.injectAnnotationCSS(e);var t=$(this.get("contentDocumentDOM")),n=this;t.on("mouseup",function(e){var t=n.getCurrentSelectionRange();void 0!==t&&t.startOffset-t.endOffset&&n.annotations.get("bbPageSetView").trigger("textSelectionEvent",e)})},redraw:function(){var e=-this.getPaginationLeftOffset();this.annotations.redrawAnnotations(0,e)},removeHighlight:function(e){return this.annotations.removeHighlight(e)},addHighlight:function(e,t,n,i){var r,o,a,s,l,u=this.getRangeStartMarker(e,t),c=this.getRangeEndMarker(e,t),d=$(this.get("contentDocumentDOM")),f=$("html",d).css("-webkit-transform"),h=new WebKitCSSMatrix(f).a;this.set("scale",h);try{return r=this.epubCFI.injectRangeElements(e,this.get("contentDocumentDOM"),u,c,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),a=r.startElement.nextSibling?r.startElement.nextSibling:r.startElement,s=r.endElement.previousSibling?r.endElement.previousSibling:r.endElement,o=document.createRange(),o.setStart(a,0),o.setEnd(s,s.length),selectionInfo=this.getSelectionInfo(o),l=-this.getPaginationLeftOffset(),"highlight"===n?(this.annotations.set("scale",this.get("scale")),this.annotations.addHighlight(e,selectionInfo.selectedElements,t,0,l,r.startElement,r.endElement,i)):"underline"===n&&this.annotations.addUnderline(e,selectionInfo.selectedElements,t,0,l,i),{CFI:e,selectedElements:selectionInfo.selectedElements}}catch(g){console.log(g.message)}},addBookmark:function(e,t,n){var i,r,o=this.getBookmarkMarker(e,t);try{return i=this.epubCFI.injectElement(e,this.get("contentDocumentDOM"),o,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),r=-this.getPaginationLeftOffset(),this.annotations.addBookmark(e,i[0],t,0,r,n),{CFI:e,selectedElements:i[0]}}catch(a){console.log(a.message)}},addImageAnnotation:function(e,t){{var n;this.getBookmarkMarker(e,t)}try{return n=this.epubCFI.getTargetElement(e,this.get("contentDocumentDOM"),["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),this.annotations.addImageAnnotation(e,n[0],t),{CFI:e,selectedElements:n[0]}}catch(i){console.log(i.message)}},getCurrentSelectionCFI:function(){var e,t=this.getCurrentSelectionRange();return t&&(selectionInfo=this.getSelectionInfo(t),e=selectionInfo.CFI),e},getCurrentSelectionOffsetCFI:function(){var e,t=this.getCurrentSelectionRange();return t&&(e=this.generateCharOffsetCFI(t)),e},addSelectionHighlight:function(e,t,n){var i,r,o,a,s="/99!",l=this.getCurrentSelectionRange();if(l)return o=this.getSelectionInfo(l),i=o.CFI,r="epubcfi("+s+i+")","highlight"===t?a=this.addHighlight(r,e,t,n):"underline"===t&&(a=this.addHighlight(r,e,t,n)),a.CFI=i,a;throw new Error("Nothing selected")},addSelectionBookmark:function(e,t){var n,i,r,o="/99!",a=this.getCurrentSelectionRange();if(a)return n=this.generateCharOffsetCFI(a),i="epubcfi("+o+n+")",r=this.addBookmark(i,e,t),r.CFI=n,r;throw new Error("Nothing selected")},addSelectionImageAnnotation:function(e){var t,n,i,r,o,a="/99!",s=this.getCurrentSelectionRange();if(s)return i=this.getSelectionInfo(s,["img"]),o=i.selectedElements[0],t=this.epubCFI.generateElementCFIComponent(o,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),n="epubcfi("+a+t+")",r=this.addImageAnnotation(n,e),r.CFI=t,r;throw new Error("Nothing selected")},updateAnnotationView:function(e,t){var n=this.annotations.updateAnnotationView(e,t);return n},getSelectionInfo:function(e,t){var n=this.generateRangeCFI(e),i={startElementFound:!1,endElementFound:!1},r=[];if(!t)var t=["text"];return this.findSelectedElements(e.commonAncestorContainer,e.startContainer,e.endContainer,i,r,t),{CFI:n,selectedElements:r}},generateRangeCFI:function(e){var t,n,i,r=e.startContainer,o=e.endContainer;if(r.nodeType===Node.TEXT_NODE&&o.nodeType===Node.TEXT_NODE)return t=e.startOffset,n=e.endOffset,i=this.epubCFI.generateCharOffsetRangeComponent(r,t,o,n,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);throw new Error("Selection start and end must be text nodes")},generateCharOffsetCFI:function(e){var t,n=e.startContainer,i=e.startOffset;return n.nodeType===Node.TEXT_NODE&&(t=this.epubCFI.generateCharacterOffsetCFIComponent(n,i,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])),t},findSelectedElements:function(e,t,n,i,r,o){return e===t&&(i.startElementFound=!0),i.startElementFound===!0&&this.addElement(e,r,o),e===n?void(i.endElementFound=!0):void(e.firstChild&&(this.findSelectedElements(e.firstChild,t,n,i,r,o),i.endElementFound)||e.nextSibling&&(this.findSelectedElements(e.nextSibling,t,n,i,r,o),i.endElementFound))},addElement:function(e,t,n){_.each(n,function(n){"text"===n?e.nodeType===Node.TEXT_NODE&&t.push(e):$(e).is(n)&&t.push(e)})},getCurrentSelectionRange:function(){var e,t=this.get("contentDocumentDOM");return t.getSelection?(e=t.getSelection(),e&&e.rangeCount&&e.anchorOffset!==e.focusOffset?e.getRangeAt(0):void 0):t.selection?t.selection.createRange():void 0},getPaginationLeftOffset:function(){var e=$("html",this.get("contentDocumentDOM")),t=e.css("left"),n=parseInt(t.replace("px",""));return n},getBookmarkMarker:function(e,t){return"<span class='bookmark-marker cfi-marker' id='"+t+"' data-cfi='"+e+"'></span>"},getRangeStartMarker:function(e,t){return"<span class='range-start-marker cfi-marker' id='start-"+t+"' data-cfi='"+e+"'></span>"},getRangeEndMarker:function(e,t){return"<span class='range-end-marker cfi-marker' id='end-"+t+"' data-cfi='"+e+"'></span>"},injectAnnotationCSS:function(e){var t=$("head",this.get("contentDocumentDOM"));t.append($("<link/>",{rel:"stylesheet",href:e,type:"text/css"}))}}),i.Annotations=Backbone.Model.extend({defaults:function(){return{bookmarkViews:[],highlights:[],markers:{},underlines:[],imageAnnotations:[],annotationHash:{},offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:void 0}},initialize:function(){},remove:function(){_.each(this.get("highlights"),function(e){e.remove()})},redrawAnnotations:function(e,t){var n=this;_.each(this.get("highlights"),function(i){i.resetHighlights(n.get("readerBoundElement"),e,t)}),_.each(this.get("bookmarkViews"),function(n){n.resetBookmark(e,t)}),_.each(this.get("underlines"),function(i){i.resetUnderlines(n.get("readerBoundElement"),e,t)})},getBookmark:function(e){var t=this.get("annotationHash")[e];return t?t.bookmark.toInfo():void 0},getHighlight:function(e){var t=this.get("annotationHash")[e];return t?t.toInfo():void 0},getUnderline:function(e){var t=this.get("annotationHash")[e];return t?t.toInfo():void 0},getBookmarks:function(){var e=[];return _.each(this.get("bookmarkViews"),function(t){e.push(t.bookmark.toInfo())}),e},getHighlights:function(){var e=[];return _.each(this.get("highlights"),function(t){e.push(t.toInfo())}),e},getUnderlines:function(){var e=[];return _.each(this.get("underlines"),function(t){e.push(t.toInfo())}),e},getImageAnnotations:function(){var e=[];return _.each(this.get("imageAnnotations"),function(t){e.push(t.toInfo())}),e},addBookmark:function(e,t,n,r,o,a){r||(r=this.get("offsetTopAddition")),o||(o=this.get("offsetLeftAddition")),n=n.toString(),this.validateAnnotationId(n);var s=new i.BookmarkView({CFI:e,targetElement:t,offsetTopAddition:r,offsetLeftAddition:o,id:n.toString(),bbPageSetView:this.get("bbPageSetView"),type:a});this.get("annotationHash")[n]=s,this.get("bookmarkViews").push(s),$(this.get("readerBoundElement")).append(s.render())},removeHighlight:function(e){var t=this.get("annotationHash"),n=this.get("highlights"),i=this.get("markers");if(i[e]){var r=i[e].startMarker,o=i[e].endMarker;r.parentNode.removeChild(r),o.parentNode.removeChild(o),delete i[e],delete t[e],n=_.reject(n,function(t){return t.id==e?(t.destroyCurrentHighlights(),!0):!1}),this.set("highlights",n)}},addHighlight:function(e,t,n,r,o,a,s,l){r||(r=this.get("offsetTopAddition")),o||(o=this.get("offsetLeftAddition")),n=n.toString(),this.validateAnnotationId(n);var u=new i.HighlightGroup({CFI:e,selectedNodes:t,offsetTopAddition:r,offsetLeftAddition:o,styles:l,id:n,bbPageSetView:this.get("bbPageSetView"),scale:this.get("scale")});this.get("annotationHash")[n]=u,this.get("highlights").push(u),this.get("markers")[n]={startMarker:a,endMarker:s},u.renderHighlights(this.get("readerBoundElement"))},addUnderline:function(e,t,n,r,o,a){r||(r=this.get("offsetTopAddition")),o||(o=this.get("offsetLeftAddition")),n=n.toString(),this.validateAnnotationId(n);var s=new i.UnderlineGroup({CFI:e,selectedNodes:t,offsetTopAddition:r,offsetLeftAddition:o,styles:a,id:n,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[n]=s,this.get("underlines").push(s),s.renderUnderlines(this.get("readerBoundElement"))},addImageAnnotation:function(e,t,n){n=n.toString(),this.validateAnnotationId(n);var r=new i.ImageAnnotation({CFI:e,imageNode:t,id:n,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[n]=r,this.get("imageAnnotations").push(r),r.render()},updateAnnotationView:function(e,t){var n=this.get("annotationHash")[e];return n.setStyles(t),n},validateAnnotationId:function(e){if(this.get("annotationHash")[e])throw new Error("That annotation id already exists; annotation not added")}}),i.BookmarkView=Backbone.View.extend({el:"<div></div>",events:{mouseenter:"setHoverBookmark",mouseleave:"setBaseBookmark",click:"clickHandler"},initialize:function(e){this.bookmark=new i.Bookmark({CFI:e.CFI,targetElement:e.targetElement,offsetTopAddition:e.offsetTopAddition,offsetLeftAddition:e.offsetLeftAddition,id:e.id,bbPageSetView:e.bbPageSetView,type:e.type})},resetBookmark:function(e,t){e&&this.bookmark.set({offsetTopAddition:e}),t&&this.bookmark.set({offsetLeftAddition:t}),this.setCSS()},render:function(){return this.setCSS(),this.el},setCSS:function(){var e,t;"comment"===this.bookmark.get("type")?(e=this.bookmark.getAbsoluteTop(),t=this.bookmark.getAbsoluteLeft(),this.$el.css({top:e+"px",left:t+"px",width:"50px",height:"50px",position:"absolute"}),this.$el.addClass("comment")):this.$el.addClass("bookmark")},setHoverBookmark:function(e){e.stopPropagation(),this.$el.hasClass("comment")&&(this.$el.removeClass("comment"),this.$el.addClass("hover-comment"))},setBaseBookmark:function(e){e.stopPropagation(),this.$el.hasClass("hover-comment")&&(this.$el.removeClass("hover-comment"),this.$el.addClass("comment"))},clickHandler:function(e){e.stopPropagation();var t;t="comment"===this.bookmark.get("type")?"comment":"bookmark",this.bookmark.get("bbPageSetView").trigger("annotationClicked",t,this.bookmark.get("CFI"),this.bookmark.get("id"),this.$el.css("top"),this.$el.css("left"),e)}}),i.HighlightView=Backbone.View.extend({el:"<div class='highlight'></div>",events:{mouseenter:"highlightEvent",mouseleave:"highlightEvent",click:"highlightEvent",contextmenu:"highlightEvent"},initialize:function(e){this.highlight=new i.Highlight({CFI:e.CFI,top:e.top,left:e.left,height:e.height,width:e.width,styles:e.styles,highlightGroupCallback:e.highlightGroupCallback,callbackContext:e.callbackContext})},render:function(){return this.setCSS(),this.el},resetPosition:function(e,t,n,i){this.highlight.set({top:e,left:t,height:n,width:i}),this.setCSS()},setStyles:function(e){this.highlight.set({styles:e}),this.render()},setCSS:function(){var e=this.highlight.get("styles")||{};this.$el.css({top:this.highlight.get("top")+"px",left:this.highlight.get("left")+"px",height:this.highlight.get("height")+"px",width:this.highlight.get("width")+"px","background-color":e.fill_color||"normal"})},setBaseHighlight:function(){this.$el.addClass("highlight"),this.$el.removeClass("hover-highlight")},setHoverHighlight:function(){this.$el.addClass("hover-highlight"),this.$el.removeClass("highlight")},highlightEvent:function(e){e.stopPropagation();var t=(this.highlight.get("highlightGroupCallback"),this.highlight.get("callbackContext"));t.highlightGroupCallback(e)}}),i.UnderlineView=Backbone.View.extend({el:"<div class='underline-range'>              <div class='transparent-part'></div>              <div class='underline-part'></div>           </div>",events:{mouseenter:"underlineEvent",mouseleave:"underlineEvent",click:"underlineEvent"},initialize:function(e){this.underline=new i.Underline({CFI:e.CFI,top:e.top,left:e.left,height:e.height,width:e.width,styles:e.styles,underlineGroupCallback:e.underlineGroupCallback,callbackContext:e.callbackContext}),this.$transparentElement=$(".transparent-part",this.$el),this.$underlineElement=$(".underline-part",this.$el)},render:function(){return this.setCSS(),this.el},resetPosition:function(e,t,n,i){this.underline.set({top:e,left:t,height:n,width:i}),this.setCSS()},setStyles:function(e){this.underline.set({styles:e}),this.render()},setCSS:function(){var e=this.underline.get("styles")||{};this.$el.css({top:this.underline.get("top")+"px",left:this.underline.get("left")+"px",height:this.underline.get("height")+"px",width:this.underline.get("width")+"px"}),this.$underlineElement.css({"background-color":e.fill_color||"normal"}),this.$underlineElement.addClass("underline")},underlineEvent:function(e){e.stopPropagation();var t=(this.underline.get("underlineGroupCallback"),this.underline.get("callbackContext"));t.underlineGroupCallback(e)},setBaseUnderline:function(){this.$underlineElement.addClass("underline"),this.$underlineElement.removeClass("hover-underline")},setHoverUnderline:function(){this.$underlineElement.addClass("hover-underline"),this.$underlineElement.removeClass("underline")}}),i.ImageAnnotation=Backbone.Model.extend({initialize:function(){var e=this,t=$(this.get("imageNode"));t.on("mouseenter",function(){e.setMouseenterBorder()}),t.on("mouseleave",function(){e.setMouseleaveBorder()}),t.on("click",function(){e.get("bbPageSetView").trigger("annotationClicked","image",e.get("CFI"),e.get("id"),event)})},render:function(){this.setCSS()},setCSS:function(){$(this.get("imageNode")).css({border:"5px solid rgb(255, 0, 0)",border:"5px solid rgba(255, 0, 0, 0.2)","-webkit-background-clip":"padding-box","background-clip":"padding-box"})},setMouseenterBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.4)"})},setMouseleaveBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.2)"})}});var r=new i.ReflowableAnnotations({contentDocumentDOM:e,bbPageSetView:t,annotationCSSUrl:n});return{addSelectionHighlight:function(e,t,n){return r.addSelectionHighlight(e,t,n)},addSelectionBookmark:function(e,t){return r.addSelectionBookmark(e,t)},addSelectionImageAnnotation:function(e){return r.addSelectionImageAnnotation(e)},addHighlight:function(e,t,n,i){return r.addHighlight(e,t,n,i)},addBookmark:function(e,t,n){return r.addBookmark(e,t,n)},addImageAnnotation:function(e,t){return r.addImageAnnotation(e,t)},updateAnnotationView:function(e,t){return r.updateAnnotationView(e,t)},redraw:function(){return r.redraw()},getBookmark:function(e){return r.annotations.getBookmark(e)},getBookmarks:function(){return r.annotations.getBookmarks()},getHighlight:function(e){return r.annotations.getHighlight(e)},getHighlights:function(){return r.annotations.getHighlights()},getUnderline:function(e){return r.annotations.getUnderline(e)},getUnderlines:function(){return r.annotations.getUnderlines()},getImageAnnotation:function(){},getImageAnnotations:function(){},removeAnnotation:function(e){return r.remove(e)},getCurrentSelectionCFI:function(){return r.getCurrentSelectionCFI()},getCurrentSelectionOffsetCFI:function(){return r.getCurrentSelectionOffsetCFI()},removeHighlight:function(e){return r.removeHighlight(e)}}};n("annotations_module",["epubCfi"],function(e){return function(){var t;return t||e.annotations_module}}(this)),ReadiumSDK.Views.AnnotationsManager=function(e,t){function n(e){var t=new RegExp("^.*!"),n=e.replace(t,""),i=n.substring(0,n.length-1);return i}var r=this,o={},a={},s=e,l=t.annotationCSSUrl;l||console.warn("WARNING! Annotations CSS not supplied. Highlighting is not going to work."),_.extend(r,Backbone.Events),this.on("all",function(){var e=Array.prototype.slice.call(arguments),t="annotationClicked";if(e.length&&e[0]===t)for(var i in o){var l=e[4],u=e[3],c=e[2],d=e[1];if(o[i].getHighlight(u)){var f=a[i].idref,h=n(c);e=[t,d,f,h,u,l]}}r.trigger.apply(s,e)}),this.attachAnnotations=function(e,t){var n=e[0].contentDocument;o[t.index]=new i(n,r,l),a[t.index]=t;for(var s in o)Math.abs(s-s.index)>3&&delete o[s]},this.getCurrentSelectionCfi=function(){for(var e in o){var t=o[e],n=t.getCurrentSelectionCFI();if(n)return{idref:a[e].idref,cfi:n}}return void 0},this.addSelectionHighlight=function(e,t){for(spine in o){var n=o[spine];if(n.getCurrentSelectionCFI()){var i=n.addSelectionHighlight(e,t);return i.idref=a[spine].idref,i}}return void 0},this.addHighlight=function(e,t,i,r,s){for(var l in o)if(a[l].idref===e){var u="epubcfi(/99!"+t+")",c=o[l],d=c.addHighlight(u,i,r,s);return d.idref=e,d.CFI=n(d.CFI),d}return void 0},this.removeHighlight=function(e){var t=void 0;for(var n in o){var i=o[n];t=i.removeHighlight(e)}return t}},n("annotationsManager",["epubCfi","annotations_module"],function(e){return function(){var t;return t||e.annotationsManager}}(this)),ReadiumSDK.Models.Trigger=function(e){var t=$(e);this.action=t.attr("action"),this.ref=t.attr("ref"),this.event=t.attr("ev:event"),this.observer=t.attr("ev:observer"),this.ref=t.attr("ref")},ReadiumSDK.Models.Trigger.register=function(e){$("trigger",e).each(function(){var t=new ReadiumSDK.Models.Trigger(this);t.subscribe(e)})},ReadiumSDK.Models.Trigger.prototype.subscribe=function(e){var t="#"+this.observer,n=this;$(t,e).on(this.event,function(){n.execute(e)})},ReadiumSDK.Models.Trigger.prototype.execute=function(e){var t=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(this.ref),e);switch(this.action){case"show":t.css("visibility","visible");break;case"hide":t.css("visibility","hidden");break;case"play":t[0].currentTime=0,t[0].play();break;case"pause":t[0].pause();break;case"resume":t[0].play();break;case"mute":t[0].muted=!0;break;case"unmute":t[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}},n("triggers",["readiumSDK"],function(e){return function(){var t;return t||e.triggers}}(this)),ReadiumSDK.Views.ScrollView=function(e,t,n){function i(e,t){if(et)return void e();var n=R();if(!n)return void e();var r=L(0),o=k(n);if(r.top-o.bottom>z){var a=P();p(n),l(a-(o.bottom-o.top),void 0),t("updateLoadedViewsTop 1"),i(e,t)}else r.top-o.top<z?d(n,function(n){n?(t("updateLoadedViewsTop 2"),i(e,t)):e()}):e()}function r(e,t){if(et)return void e();var n=I();if(!n)return void e();var i=L(0),o=k(n);o.top-i.bottom>z?(p(n),t("updateLoadedViewsBottom 1"),r(e,t)):o.bottom-i.bottom<z?h(n,function(n){t("updateLoadedViewsBottom 2"),n?r(e,t):e()}):e()}function o(e){if(t){var n=void 0;if(U&&e){var o=e.offset();o&&(n=o.top)}var a=function(t){if(U){if(!n)return;var i=void 0,r=e.offset();if(r&&(i=r.top),!i)return;var o=i-n;Math.abs(o)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+t+") "+o+" -- "+e.currentSpineItem().href)}};tt=!0,r(function(){i(function(){setTimeout(function(){tt=!1},X+100)},a)},a)}}function a(){var e=n.viewerSettings();e.mediaOverlaysPreservePlaybackWhenScroll||!rt&&n.isMediaOverlayAvailable()&&(rt=n.isPlayingMediaOverlay(),rt&&n.pauseMediaOverlay())}function s(){if(!tt&&!nt&&!it){o(),b(J);var e=n.viewerSettings();e.mediaOverlaysPreservePlaybackWhenScroll||rt&&setTimeout(function(){n.playMediaOverlay(),rt=!1},100)}}function l(e,t){G[0].scrollTop=e,t&&b(t.initiator,t.spineItem,t.elementId)}function u(e){var t=P(),n=k(e);f(e);var i=k(e),r=i.bottom-i.top,o=n.bottom-n.top,a=r-o;Math.abs(a)>0&&(U&&console.debug("IMMEDIATE SCROLL ADJUST: "+e.currentSpineItem().href+" == "+a),l(t+a))}function c(e,t,n,i,r,o,a,s){if(!ReadiumSDK.Helpers.isIframeAlive(n))return U&&console.log("reachStableContentHeight ! win && doc (iFrame disposed?)"),void(s&&s(!1));var l=10,c=300,d=n.contentWindow,h=n.contentDocument,g=parseInt(Math.round(parseFloat(d.getComputedStyle(h.documentElement).height))),p=g;0===e?u(t):f(t);var m=function(r){return U&&r!==l&&console.log("tryAgainFunc - "+r+": "+i+"  <"+p+" -- "+g+">"),r--,0>r?(U&&console.error("tryAgainFunc abort: "+i),void(s&&s(!0))):void setTimeout(function(){try{if(!ReadiumSDK.Helpers.isIframeAlive(n))return U&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(s&&s(!1));var o=n.contentWindow,l=n.contentDocument,c=parseInt(Math.round(parseFloat(window.getComputedStyle(n).height))),d=parseInt(Math.round(parseFloat(o.getComputedStyle(l.documentElement).height)));if(g!==d)return g=d,void m(r);var h=c-d;if(Math.abs(h)>4){if(U&&(console.log("$$$ IFRAME HEIGHT ADJUST: "+i+"  ["+h+"]<"+p+" -- "+g+">"),console.log(a)),0===e?u(t):f(t),!ReadiumSDK.Helpers.isIframeAlive(n))return U&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(s&&s(!1));var o=n.contentWindow,l=n.contentDocument,v=parseInt(Math.round(parseFloat(o.getComputedStyle(l.documentElement).height))),S=parseInt(Math.round(parseFloat(window.getComputedStyle(n).height))),y=S-v;if(Math.abs(y)>4)return U&&(console.error("## IFRAME HEIGHT ADJUST: "+i+"  ["+y+"]<"+p+" -- "+g+">"),console.log(a)),void m(r);U&&console.log(">> IFRAME HEIGHT ADJUSTED OKAY: "+i+"  ["+h+"]<"+p+" -- "+g+">")}}catch(R){return console.error(R),void(s&&s(!1))}s&&s(!0)},c)};m(l)}function d(e,t){var n=Z.prevItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var i=v(!0),r=I();i.element().insertAfter(r.element()),i.loadSpineItem(n,function(r){if(r){f(i);var o=k(i);p(i);var a=P(),s=v(),u=o.bottom-o.top;s.setHeight(u),s.element().insertBefore(e.element()),a+=u,l(a,void 0),s.loadSpineItem(n,function(e,i,r,o,a){if(e){var l=function(n){w(s,e,i,r,o,a),t(n)};c(0,s,i[0],r.href,r.isFixedLayout(),r.isFixedLayout()?s.meta_width():0,"addToTopOf",l)}else console.error("Unable to open 2 "+n.href),p(s),t(!1)})}else console.error("Unable to open 1 "+n.href),p(i),t(!1)})}function f(e){e.currentSpineItem().isFixedLayout()?e.scaleToWidth(G.width()):e.resizeIFrameToContent()}function h(e,t){var n=Z.nextItem(e.currentSpineItem(),!0);if(!n)return void t(!1);var i=(P(),v());i.element().insertAfter(e.element()),i.loadSpineItem(n,function(e,r,o,a,s){if(e){var l=function(n){w(i,e,r,o,a,s),t(n)};c(2,i,r[0],o.href,o.isFixedLayout(),o.isFixedLayout()?i.meta_width():0,"addToBottomOf",l)}else console.error("Unable to load "+n.href),t(!1)})}function g(){var e=[];y(function(t){e.push(t)},!1);for(var t=0,n=e.length;n>t;t++)p(e[t])}function p(e){e.element().remove()}function m(e){G.css("left",e.left),G.css("top",e.top),G.css("right",e.right),G.css("bottom",e.bottom)}function v(n){e.disablePageTransitions=!0;var i=new ReadiumSDK.Views.OnePageView(e,["content-doc-frame"],!0);return i.render(),ot&&i.setViewSettings(ot),n||i.element().data("pageView",i),t&&i.decorateIframe(),i}function S(e,t){var n=void 0;return y(function(t){return t.currentSpineItem()==e?(n=t,!1):!0},t),n}function y(e,t){for(var n=G.children(),i=n.length,r=t?function(e){return e-1}:function(e){return e+1},o=t?function(e){return e>=0}:function(e){return i>e},a=t?i-1:0,s=a;o(s);s=r(s)){var l=n.eq(s),u=l.data("pageView");if(u&&e(u)===!1)return}}function R(){var e=void 0;return y(function(t){return e=t,!1},!1),e}function I(){var e=void 0;return y(function(t){return e=t,!1},!0),e}function w(e,t,n,i,r){t&&r&&J.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,n,i)}function C(e,t){g();var n=(P(),v());G.append(n.element()),n.loadSpineItem(e,function(e,i,r,o,a){if(e){var s=function(){w(n,e,i,r,o,a),t(n)};c(1,n,i[0],r.href,r.isFixedLayout(),r.isFixedLayout()?n.meta_width():0,"openPage",s)}else console.error("Unable to load "+r.href),p(n),n=void 0;t(n)})}function E(e,t){var n,i,r,o,a=0;if(void 0!==t.scrollTop)a=t.scrollTop;else if(void 0!==t.spineItemPageIndex){var s;n=T(),s=t.spineItemPageIndex<0?0:t.spineItemPageIndex>=n?n-1:t.spineItemPageIndex,a=s*x()}else if(e&&t.elementId){if(o=k(e),r=e.getNavigator(),i=r.getElementById(t.elementId),!i||!i.length)return void console.warn("Element id="+t.elementId+" not found!");if(V(e,i,60))return void b(t.initiator,t.spineItem,t.elementId);a=r.getVerticalOffsetForElement(i)+o.top}else if(e&&t.elementCfi){if(o=k(e),r=e.getNavigator(),i=r.getElementByCfi(t.elementCfi),!i||!i.length)return void console.warn("Element cfi="+t.elementCfi+" not found!");if(V(e,i,60))return void b(t.initiator,t.spineItem,t.elementId);a=r.getVerticalOffsetForElement(i)+o.top}else if(t.firstPage)a=0;else if(t.lastPage){if(n=T(),0===n)return;a=D()-x()-5}else e?(o=k(e),a=o.top):a=0;P()!=a?(nt=!0,l(a,t),setTimeout(function(){nt=!1},X+100)):b(t.initiator,t.spineItem,t.elementId)}function T(){return Math.ceil(D()/x())}function b(e,t,n){J.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:J.getPaginationInfo(),initiator:e,spineItem:t,elementId:n})}function P(){return G[0].scrollTop}function N(){return D()-(P()+x())}function x(){return G.height()}function D(){return G[0].scrollHeight}function O(){var e=[],t=L(-q);return y(function(n){if(M(n,t))e.push(n);else if(e.length>0)return!1;return!0},!1),e}function A(){var e=O();return e[0]}function M(e,t){var n=k(e);return B(F(n,t))>0}function k(e){var t={top:0,bottom:0};return t.top=e.element().position().top+P(),t.bottom=t.top+e.getCalculatedPageHeight(),t}function L(e){0===e||e||(e=0);var t={top:P()-e,bottom:P()+x()+e};return t.top<0&&(t.top=0),t.bottom>D()&&(t.bottom=D()),t}function F(e,t){return{top:Math.max(e.top,t.top),bottom:Math.min(e.bottom,t.bottom)}}function B(e){return e.bottom<e.top?0:e.bottom-e.top}function V(e,t,n){var i=K(e,t);return H(i,n)}function H(e,t){var n=L(),i=Math.min(B(n),B(e));
0===i&&(i=5);var r=F(n,e),o=B(r)/i*100;return o>=t}function K(e,t){var n=k(e),i={top:0,bottom:0};return i.top=t.offset().top+n.top,i.bottom=i.top+t.height(),i}var U=!1;_.extend(this,Backbone.Events);var W,G,j,q=5,z=2e3,X=300,J=this,Y=e.$viewport,Z=e.spine,Q=e.userStyles,et=!1,tt=!1,nt=!1,it=!1;this.isContinuousScroll=function(){return t},this.render=function(){var e=ReadiumSDK.Helpers.loadTemplate("scrolled_book_frame",{});j=$(e),Y.append(j),G=$("#scrolled-content-frame",j),G.css("overflow",""),G.css("overflow-y","auto"),G.css("overflow-x","hidden"),G.css("-webkit-overflow-scrolling","touch"),G.css("width","100%"),G.css("height","100%"),G.css("position","relative");var t=ot;t||(t=new ReadiumSDK.Models.ViewerSettings({})),t.enableGPUHardwareAccelerationCSS3D&&G.css("transform","translateZ(0)"),J.applyStyles();var n=_.debounce(s,X);return G.on("scroll",function(e){n(e),a()}),J};var rt=!1;this.remove=function(){j.remove()},this.onViewportResize=function(){G&&(y(function(e){f(e)},!1),b(J),o())};var ot=void 0;this.setViewSettings=function(e){ot=e,y(function(t){t.setViewSettings(e)},!1)},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(Q.getStyles(),j.parent());var e=ReadiumSDK.Helpers.Margins.fromElement(j);m(e.padding)},this.applyBookStyles=function(){y(function(e){e.applyBookStyles()},!1)},this.openPage=function(e){et=!0;var t=function(e,t){W=void 0,E(e,t),et=!1,o(e)};if(e.spineItem){var n=S(e.spineItem);n?t(n,e):(W=e,it=!0,C(e.spineItem,function(n){setTimeout(function(){it=!1},X+100),n&&W?n.currentSpineItem()===W.spineItem?t(n,W):J.openPage(W):b(e.initiator,e.spineItem,e.elementId)}))}else t(void 0,e)},this.openPageNext=function(e){var t;N()>0&&(t=new ReadiumSDK.Models.PageOpenRequest(void 0,e),t.scrollTop=P()+Math.min(N(),x()-q),E(void 0,t))},this.openPagePrev=function(e){var t;P()>0&&(t=new ReadiumSDK.Models.PageOpenRequest(void 0,e),t.scrollTop=P()-(x()-q),t.scrollTop<0&&(t.scrollTop=0),E(void 0,t))},this.getFirstVisibleElementCfi=function(){var e=A();return e?e.getNavigator().getFirstVisibleElementCfi(P()):void 0},this.getPaginationInfo=function(){for(var e,t,n,i,r,o,a,s,l=L(),u=l.bottom-l.top,c=new ReadiumSDK.Models.CurrentPagesInfo(Z,!1),d=O(),f=0,h=d.length;h>f;f++)n=d[f],e=n.currentSpineItem(),i=k(n),r=Math.max(l.top-i.top,0),o=Math.max(i.bottom-l.bottom,0),a=Math.ceil(r/u),s=Math.ceil(o/u),t=a+s+1,c.addOpenPage(a,t,e.idref,e.index);return c},this.bookmarkCurrentPage=function(){var e=A();return e?new ReadiumSDK.Models.BookmarkData(e.currentSpineItem().idref,J.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){var e=[];return y(function(t){e.push(t.currentSpineItem())},!1),e},this.getElement=function(e,t){var n=void 0;return y(function(i){return i.currentSpineItem()==e?(n=i.getNavigator().getElement(t),!1):!0},!1),n},this.getElementByCfi=function(e,t,n,i,r){var o=void 0;return y(function(a){return a.currentSpineItem()==e?(o=a.getElementByCfi(e,t,n,i,r),!1):!0},!1),o?o:void console.error("spine item is not loaded")},this.getElementById=function(e,t){var n=void 0;return y(function(i){return i.currentSpineItem()==e?(n=i.getNavigator().getElementById(t),!1):!0},!1),n?n:void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){var e,t=L(),n=void 0,i={top:0,bottom:0},r=!1;return y(function(o){if(e=k(o),i.top=Math.max(e.top,t.top)-e.top,i.bottom=Math.min(e.bottom,t.bottom)-e.top,B(i)>0){if(r=!0,n=o.getNavigator().getFirstVisibleMediaOverlayElement(i))return!1}else if(r)return!1;return!0},!1),n},this.insureElementVisibility=function(e,t,n){var i=void 0;if(y(function(t){return t.currentSpineItem().idref===e?(i=t,!1):!0},!1),!i)return void console.warn("Page for element "+t+" not found");var r=$(t),o=K(i,r);if(!H(o,60)){var a=Z.getItemById(e),s=new ReadiumSDK.Models.PageOpenRequest(a,n);s.scrollTop=o.top,J.openPage(s)}}},n("scrollView",["readiumSDK","cfiNavigationLogic","bookmarkData","triggers","onePageView"],function(e){return function(){var t;return t||e.scrollView}}(this)),ReadiumSDK.Models.Switches=function(){},ReadiumSDK.Models.Switches.apply=function(e){function t(e){var t=e.attributes["required-namespace"];if(!t)return console.log("Encountered a case statement with no required-namespace"),!1;var n=["http://www.w3.org/1998/Math/MathML"];return _.include(n,t)}$("switch",e).each(function(){var e=!1;$("case",this).each(function(){!e&&t(this)?e=!0:$(this).remove()}),e&&$("default",this).remove()})},n("switches",["readiumSDK"],function(e){return function(){var t;return t||e.switches}}(this)),ReadiumSDK.Views.ReaderView=function(e){function t(e){return"scroll-doc"==m.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==m.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:e.isFixedLayout()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:e.isFlowScrolledDoc()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:e.isFlowScrolledContinuous()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED}function n(e,n){var r=t(e);if(h){if(f.getCurrentViewType()==r)return void n(!1);i()}var o={$viewport:d,spine:p,userStyles:v,bookStyles:S,iframeLoader:c};h=f.createViewForType(r,o),f.trigger(ReadiumSDK.Events.READER_VIEW_CREATED,r),h.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function(e,t){if(ReadiumSDK.Helpers.isIframeAlive(e[0])){u.attachMediaOverlayData(e,t,m),y.processLinkElements(e,t),R.attachAnnotations(e,t);var n=e[0].contentDocument;ReadiumSDK.Models.Trigger.register(n),ReadiumSDK.Models.Switches.apply(n),f.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,e,t)}}),h.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,function(e,t){f.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,e,t)}),h.on(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(e){l.onPageChanged(e),f.trigger(ReadiumSDK.Events.PAGINATION_CHANGED,e)}),h.on(ReadiumSDK.Events.FXL_VIEW_RESIZED,function(){f.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}),h.render(),h.setViewSettings(m),setTimeout(function(){n(!0)},50)}function i(){h&&(f.trigger(ReadiumSDK.Events.READER_VIEW_DESTROYED),h.off(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),h.remove(),h=void 0)}function r(e){f.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,e)}function o(e){if(!e)return void console.log("idref parameter value missing!");var t=p.getItemById(e);return t?t:void console.log("Spine item with id "+e+" not found!")}function a(e,t){n(e.spineItem,function(n){n||h.setViewSettings(m),h.openPage(e,t)})}function s(e){ReadiumSDK.Helpers.setStyles(v.getStyles(),d),l&&l.applyStyles(),e||h&&h.applyStyles()}_.extend(this,Backbone.Events);var l,u,c,d,f=this,h=void 0,g=void 0,p=void 0,m=new ReadiumSDK.Models.ViewerSettings({}),v=new ReadiumSDK.Collections.StyleCollection,S=new ReadiumSDK.Collections.StyleCollection,y=new ReadiumSDK.Views.InternalLinksSupport(this),R=new ReadiumSDK.Views.AnnotationsManager(f,e),I=_.debounce(function(){f.handleViewportResize()},200,!1);$(window).on("resize.ReadiumSDK.readerView",_.bind(I,f)),e.el instanceof $?(d=e.el,console.log("** EL is a jQuery selector:"+e.el.attr("id"))):(d=$(e.el),console.log("** EL is a string:"+d.attr("id"))),c=e.iframeLoader?e.iframeLoader:new ReadiumSDK.Views.IFrameLoader({mathJaxUrl:e.mathJaxUrl}),this.createViewForType=function(e,t){var n;switch(e){case ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:n=new ReadiumSDK.Views.FixedView(t,f);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:n=new ReadiumSDK.Views.ScrollView(t,!1,f);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:n=new ReadiumSDK.Views.ScrollView(t,!0,f);break;default:n=new ReadiumSDK.Views.ReflowableView(t,f)}return n},this.getCurrentViewType=function(){return h?h instanceof ReadiumSDK.Views.ReflowableView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED:h instanceof ReadiumSDK.Views.FixedView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:h instanceof ReadiumSDK.Views.ScrollView?h.isContinuousScroll()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type"):void 0},this.getLoadedSpineItems=function(){return h?h.getLoadedSpineItems():[]},this.viewerSettings=function(){return m},this.package=function(){return g},this.spine=function(){return p},this.userStyles=function(){return v},this.openBook=function(e){var t=e.package?e.package:e;g=new ReadiumSDK.Models.Package(t),p=g.spine,p.handleLinear(!0),l&&l.reset(),l=new ReadiumSDK.Views.MediaOverlayPlayer(f,$.proxy(r,f)),l.setAutomaticNextSmil(m.mediaOverlaysAutomaticPageTurn?!0:!1),u=new ReadiumSDK.Views.MediaOverlayDataInjector(g.media_overlay,l),i(),e.settings&&f.updateSettings(e.settings),e.styles&&f.setStyles(e.styles);var n=void 0;e.openPageRequest&&(e.openPageRequest.idref||e.openPageRequest.contentRefUrl&&e.openPageRequest.sourceFileHref?n=e.openPageRequest:console.log("Invalid page request data: idref required!"));var o=!1;if(n){n=e.openPageRequest;try{o=n.idref?n.spineItemPageIndex?!f.openSpineItemPage(n.idref,n.spineItemPageIndex,f):n.elementCfi?!f.openSpineItemElementCfi(n.idref,n.elementCfi,f):!f.openSpineItemPage(n.idref,0,f):!f.openContentUrl(n.contentRefUrl,n.sourceFileHref,f)}catch(s){console.error("openPageRequest fail: fallback to first page!"),console.log(s),o=!0}}else o=!0;if(o){var c=p.first();if(c){var d=new ReadiumSDK.Models.PageOpenRequest(c,f);d.setFirstPage(),a(d,0)}}},this.openPageLeft=function(){g.spine.isLeftToRight()?f.openPagePrev():f.openPageNext()},this.openPageRight=function(){g.spine.isLeftToRight()?f.openPageNext():f.openPagePrev()},this.isCurrentViewFixedLayout=function(){return h instanceof ReadiumSDK.Views.FixedView},this.setZoom=function(e){f.isCurrentViewFixedLayout()&&h.setZoom(e)},this.getViewScale=function(){return f.isCurrentViewFixedLayout()?100*h.getViewScale():100},this.updateSettings=function(e){if(m.update(e),l&&l.setAutomaticNextSmil(m.mediaOverlaysAutomaticPageTurn?!0:!1),h&&!e.doNotUpdateView){var t=h.bookmarkCurrentPage();if(t&&t.idref){var i=!1;h.isReflowable&&h.isReflowable()&&(i=f.isPlayingMediaOverlay(),i&&f.pauseMediaOverlay());var r=p.getItemById(t.idref);n(r,function(e){e||h.setViewSettings(m),f.openSpineItemElementCfi(t.idref,t.contentCFI,f),i&&f.playMediaOverlay(),f.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)})}}f.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(f.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void h.openPageNext(f);var e=h.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[e.openPages.length-1];if(t.spineItemPageIndex<t.spineItemPageCount-1)return void h.openPageNext(f);var n=p.getItemById(t.idref),i=p.nextItem(n);if(i){var r=new ReadiumSDK.Models.PageOpenRequest(i,f);r.setFirstPage(),a(r,2)}}},this.openPagePrev=function(){if(f.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void h.openPagePrev(f);var e=h.getPaginationInfo();if(0!=e.openPages.length){var t=e.openPages[0];if(t.spineItemPageIndex>0)return void h.openPagePrev(f);var n=p.getItemById(t.idref),i=p.prevItem(n);if(i){var r=new ReadiumSDK.Models.PageOpenRequest(i,f);r.setLastPage(),a(r,1)}}},this.openSpineItemElementCfi=function(e,t,n){var i=o(e);if(!i)return!1;var r=new ReadiumSDK.Models.PageOpenRequest(i,n);return t&&r.setElementCfi(t),a(r,0),!0},this.openPageIndex=function(e,t){if(!h)return!1;var n,i=p.items[e];if(!i)return!1;if(g.isFixedLayout()){var i=p.items[e];if(!i)return!1;n=new ReadiumSDK.Models.PageOpenRequest(i,t),n.setPageIndex(0)}else{var r=this.getLoadedSpineItems();r.length>0&&(n=new ReadiumSDK.Models.PageOpenRequest(r[0],t),n.setPageIndex(e))}return a(n,0),!0},this.openSpineItemPage=function(e,t,n){var i=o(e);if(!i)return!1;var r=new ReadiumSDK.Models.PageOpenRequest(i,n);return t&&r.setPageIndex(t),a(r,0),!0},this.setStyles=function(e,t){for(var n=e.length,i=0;n>i;i++)e[i].declarations?v.addStyle(e[i].selector,e[i].declarations):v.removeStyle(e[i].selector);s(t)},this.setBookStyles=function(e){for(var t=e.length,n=0;t>n;n++)S.addStyle(e[n].selector,e[n].declarations);h&&h.applyBookStyles()},this.getElement=function(e,t){return h?h.getElement(e,t):void 0},this.getElementById=function(e,t){return h?h.getElementById(e,t):void 0},this.getElementByCfi=function(e,t,n,i,r){return h?h.getElementByCfi(e,t,n,i,r):void 0},this.mediaOverlaysOpenContentUrl=function(e,t,n){l.mediaOverlaysOpenContentUrl(e,t,n)},this.openContentUrl=function(e,t,n){var i,r,o=ReadiumSDK.Helpers.ResolveContentRef(e,t),a=o.indexOf("#");a>=0?(i=o.substr(0,a),r=o.substr(a+1)):(i=o,r=void 0);var s=p.getItemByHref(i);if(!s){console.warn("spineItem "+i+" not found");var l=decodeURIComponent(i);if(s=p.getItemByHref(l),!s)return console.warn("decoded spineItem "+l+" missing as well"),!1}return f.openSpineItemElementId(s.idref,r,n)},this.openSpineItemElementId=function(e,t,n){var i=p.getItemById(e);if(!i)return!1;var r=new ReadiumSDK.Models.PageOpenRequest(i,n);return t&&r.setElementId(t),a(r,0),!0},this.bookmarkCurrentPage=function(){return JSON.stringify(h.bookmarkCurrentPage())},this.clearStyles=function(){v.resetStyleValues(),s(),v.clear()},this.clearBookStyles=function(){h&&(S.resetStyleValues(),h.applyBookStyles()),S.clear()},this.isMediaOverlayAvailable=function(){return l?l.isMediaOverlayAvailable():!1},this.toggleMediaOverlay=function(){l.toggleMediaOverlay()},this.nextMediaOverlay=function(){l.nextMediaOverlay()},this.previousMediaOverlay=function(){l.previousMediaOverlay()},this.escapeMediaOverlay=function(){l.escape()},this.ttsEndedMediaOverlay=function(){l.onTTSEnd()},this.pauseMediaOverlay=function(){l.pause()},this.playMediaOverlay=function(){l.play()},this.isPlayingMediaOverlay=function(){return l.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){return h?h.getFirstVisibleMediaOverlayElement():void 0},this.insureElementVisibility=function(e,t,n){h&&h.insureElementVisibility(e,t,n)},this.handleViewportResize=function(){if(h){var e=h.bookmarkCurrentPage();if(h.isReflowable&&h.isReflowable()&&e&&e.idref){var t=f.isPlayingMediaOverlay();t&&f.pauseMediaOverlay();var i=p.getItemById(e.idref);n(i,function(){f.openSpineItemElementCfi(e.idref,e.contentCFI,f),t&&f.playMediaOverlay()})}else{console.debug("RESIZE NO RESTORE BOOKMARK");var t=!1;h.isReflowable&&h.isReflowable()&&(t=f.isPlayingMediaOverlay(),t&&f.pauseMediaOverlay()),h.onViewportResize(),t&&setTimeout(function(){f.playMediaOverlay()},150)}}},this.getCurrentSelectionCfi=function(){return R.getCurrentSelectionCfi()},this.addHighlight=function(e,t,n,i,r){return R.addHighlight(e,t,n,i,r)},this.addSelectionHighlight=function(e,t){return R.addSelectionHighlight(e,t)},this.removeHighlight=function(e){return R.removeHighlight(e)},this.addIFrameEventListener=function(e,t,n){c.addIFrameEventListener(e,t,n)};var w=function(){var e={},t=!1,n=void 0;this.setCallback_PlayPause=function(e){n=e};var i=void 0;this.setCallback_IsAvailable=function(e){i=e},this.playPause=function(e){r(e)};var r=function(t){n&&n(t);try{var i=void 0;for(var r in e)if(e.hasOwnProperty(r)){var o=e[r];if(o&&o.active&&(i&&console.error("More than one active iframe?? (pagination)"),i=o.$iframe)){var a=$("audio",i[0].contentDocument);$.each(a,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return e?e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0?!0:(t&&this.play?this.play():this.pause&&this.pause(),!0):!0})}}}catch(s){console.error(s)}};this.setPlayState=function(e){t=e},f.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function(t,n){try{n&&n.idref&&t&&t[0]&&(e[n.idref]={$iframe:t,href:n.href})}catch(i){console.error(i)}}),f.on(ReadiumSDK.Events.PAGINATION_CHANGED,function(n){var o=!1;try{for(var a in e)if(e.hasOwnProperty(a)){var s=n.spineItem&&n.spineItem.idref===a,l=!1;if(n.paginationInfo&&n.paginationInfo.openPages.length){for(var u=!0,c=0;c<n.paginationInfo.openPages.length;c++)n.paginationInfo.openPages[c].idref===a?l=!0:u=!1;!s&&u&&(s=!0)}if(s||l){var d=e[a];if(!d)continue;e[a].active=s;var f=d.$iframe,h=(d.href,$("audio",f[0].contentDocument));$.each(h,function(){var e=this.getAttribute("epub:type")||this.getAttribute("type");return e?e.indexOf("ibooks:soundtrack")<0&&e.indexOf("media:soundtrack")<0&&e.indexOf("media:background")<0?!0:(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),s||this.pause&&this.pause(),o=!0,!0):!0})}else e[a]&&(e[a].$iframe=void 0),e[a]=void 0}}catch(g){console.error(g)}i&&i(o),r(o?t?!0:!1:!1)}),f.on(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(n){if(n.smilIndex){var i=f.package(),o=i.media_overlay.smilAt(n.smilIndex);if(o&&o.spineItemId){var a=!1;for(var s in e)if(e.hasOwnProperty(s)){var l=e[s];l&&l.active&&s!==o.spineItemId&&(r(!1),l.active=!1,a=!0)}if(a){for(var s in e)if(e.hasOwnProperty(s)){var l=e[s];l&&(l.active||s===o.spineItemId&&(l.active=!0))}t&&r(!0)}}}})};this.backgroundAudioTrackManager=new w},ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED=1,ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED=2,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC=3,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS=4,n("readerView",["backbone","readiumSDK","helpers","viewerSettings","styleCollection","package","mediaOverlayPlayer","pageOpenRequest","fixedView","reflowableView","mediaOvelayDataInjector","internalLinksSupport","iframeLoader","annotationsManager","scrollView","URIjs","triggers","switches"],function(e){return function(){var t;return t||e.readerView}}(this)),n("epub-fetch/markup_parser",[],function(){var e=function(){var e=this;this.parseXml=function(t){return e.parseMarkup(t,"text/xml")},this.parseMarkup=function(e,t){var n=new window.DOMParser;return n.parseFromString(e,t)}};return e}),n("epub-fetch/discover_content_type",["require","module","jquery","backbone","URIjs"],function(e,t,n,i,r){var o=void 0,a=function(){var e=this;a.suffixContentTypeMap={css:"text/css",epub:"application/epub+zip",gif:"image/gif",html:"text/html",jpg:"image/jpeg",jpeg:"image/jpeg",ncx:"application/x-dtbncx+xml",opf:"application/oebps-package+xml",png:"image/png",svg:"image/svg+xml",xhtml:"application/xhtml+xml"},this.identifyContentTypeFromFileName=function(e){var t=r(e).suffix(),n="application/octet-stream";return"undefined"!=typeof a.suffixContentTypeMap[t]&&(n=a.suffixContentTypeMap[t]),n},this.identifyContentType=function(t){var i=n.ajax({type:"HEAD",url:t,async:!1}).getResponseHeader("Content-Type");return null===i&&(i=e.identifyContentTypeFromFileName(t),console.log("guessed contentType ["+i+"] from URI ["+t+"]. Configuring the web server to provide the content type is recommended.")),i}};return o||(o=new a),o}),n("epub-fetch/plain_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(e,t,n,i,r){var o=function(e,t){function i(e,t,n){var i=s.resolveURI(e);if("undefined"==typeof e)throw"Fetched file relative path is undefined!";var r=new XMLHttpRequest;r.open("GET",i,!0),r.responseType="arraybuffer",r.onerror=n,r.onload=function(){t(r.response)},r.send()}var o,a,s=this;this.initialize=function(n){e.getXmlFileDom("META-INF/container.xml",function(t){a=e.getRootFile(t),o=s.resolveURI(a),n()},function(e){console.error("unable to find package document: "+e),o=t,n()})},this.resolveURI=function(e){return t+"/"+e},this.getPackageUrl=function(){return o},this.fetchFileContentsText=function(e,t,i){var r=s.resolveURI(e);if("undefined"==typeof r)throw"Fetched file URL is undefined!";n.ajax({isLocal:0===r.indexOf("http")?!1:!0,url:r,dataType:"text",async:!0,success:function(e){t(e)},error:function(e,t,n){console.error("Error when AJAX fetching "+r),console.error(t),console.error(n),i(n)}})},this.fetchFileContentsBlob=function(t,n,o){var a=e.getDecryptionFunctionForRelativePath(t);if(a){var s=n;n=function(e){a(e,function(e){s(e)})}}i(t,function(e){var i=new Blob([e],{type:r.identifyContentTypeFromFileName(t)});n(i)},o)},this.getPackageDom=function(t,n){s.fetchFileContentsText(a,function(n){var i=e.markupParser.parseXml(n);t(i)},n)}};return o}),n("epub-fetch/zip_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(e,t,n,i,r){var o=function(e,t,n){function i(e,i){a?e(a,i):(zip.workerScriptsPath=n,a=new zip.fs.FS,a.importHttpContent(t,!0,function(){e(a,i)},i))}function o(e,n,r){if("undefined"==typeof e)throw"Fetched file relative path is undefined!";i(function(i,r){var o=i.find(e);"undefined"==typeof o||null===o?r(new Error("Entry "+e+" not found in zip "+t)):o.directory?r(new Error("Entry "+e+" is a directory while a file has been expected")):n(o)},r)}var a,s=!1;this.getPackageUrl=function(){return t},this.fetchFileContentsText=function(e,t,n){o(e,function(e){e.getText(t,void 0,s)},n)},this.fetchFileContentsData64Uri=function(e,t,n){o(e,function(n){n.getData64URI(r.identifyContentTypeFromFileName(e),t,void 0,s)},n)},this.fetchFileContentsBlob=function(t,n,i){var a=e.getDecryptionFunctionForRelativePath(t);if(a){var l=n;n=function(e){a(e,function(e){l(e)})}}o(t,function(e){e.getBlob(r.identifyContentTypeFromFileName(t),n,void 0,s)},i)}};return o}),n("epub-fetch/content_document_fetcher",["require","module","jquery","underscore","URIjs","./discover_content_type"],function(e,t,n,i,r,o){var a=function(e,t,a,s){function l(e,t){var n=e.getElementsByTagName("base")[0];if(!n){n=e.createElement("base");var i=e.getElementsByTagName("head")[0];i.insertBefore(n,i.childNodes[0])}n.setAttribute("href",t)}function u(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack)),console.error(e)}function c(e,t,i,a,s,l,u){function c(r){n(e).data("epubZipOrigHref",t),n(e).attr(i,r)}var d=new r(t).absoluteTo(E).toString(),f=P.getResourceURL(d);if(f)c(f);else{var h=n.Deferred();s.push(h),T.relativeToPackageFetchFileContents(d,a,function(t){var i=function(t){if("text"===a){var i=o.identifyContentTypeFromFileName(d),r=n(e).attr("type");r&&(i=r),t=new Blob([t],{type:i})}var s=window.URL.createObjectURL(t);P.putResourceURL(d,s),c(s),h.resolve()};u?u(t,d,i):i(t)},l)}}function d(e,t,o,a,s){var l=e[0],c=e.slice(2),d=i.find(c,function(e){return"undefined"!=typeof e}),h=new r(d),g=""===h.scheme();if(g){var p=new r(d).absoluteTo(o).toString(),m=P.getResourceURL(p);if(m)a[l]={isStyleSheetResource:s,resourceObjectURL:m};else{var v=n.Deferred();t.push(v);var S,y,R=function(e){var t=window.URL.createObjectURL(e);a[l]={isStyleSheetResource:s,resourceObjectURL:t},P.putResourceURL(p,t),v.resolve()},I=function(e){u(e),v.resolve()};s?(S="text",y=function(e){f(e,p,function(e){var t=new Blob([e],{type:"text/css"});R(t)})}):(S="blob",y=R),T.relativeToPackageFetchFileContents(p,S,y,I)}}}function f(e,t,i){var r=/[Uu][Rr][Ll]\(\s*([']([^']+)[']|["]([^"]+)["]|([^)]+))\s*\)/g,o=/@[Ii][Mm][Pp][Oo][Rr][Tt]\s*('([^']+)'|"([^"]+)")/g,a={},s=[];[o,r].forEach(function(n){for(var i=n.exec(e);null!=i;){var r=!1;n==o&&(r=!0),d(i,s,t,a,r),i=n.exec(e)}}),s.length>0?n.when.apply(n,s).done(function(){for(var t in a){var n,r=a[t];n=r.isStyleSheetResource?'@import "'+r.resourceObjectURL+'"':"url('"+r.resourceObjectURL+"')";var o=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),s=new RegExp(o,"g");e=e.replace(s,n,"g")}i(e)}):i(e)}function h(e,t,i,o,a,s){var l=n(e+"["+t+"]",w);l.each(function(e,l){var u=n(l).attr(t),d=new r(u);""===d.scheme()&&c(l,u,t,i,o,a,s)})}function g(e,t){h("img","src","blob",e,t)}function p(e,t){h("audio","src","blob",e,t)}function m(e,t){h("video","src","blob",e,t),h("video","poster","blob",e,t)}function v(e,t){h("script","src","blob",e,t)}function S(e,t){h("iframe","src","blob",e,t)}function y(e,t){h("link","href","text",e,t,f)}function R(e){var t=n("style",w);t.each(function(t,i){var r=n.Deferred();e.push(r);var o=n(i).text();f(o,E,function(e){n(i).text(e),r.resolve()})})}var I,w,C=this,E=t.href,T=e,b=t.media_type,P=s;this.fetchContentDocumentAndResolveDom=function(e,t){T.relativeToPackageFetchFileContents(E,"text",function(n){I=n,C.resolveInternalPackageResources(e,t)},t)},this.resolveInternalPackageResources=function(e,t){w=T.markupParser.parseMarkup(I,b),l(w,a);var i=[];T.shouldFetchMediaAssetsProgrammatically()&&(g(i,t),p(i,t),m(i,t)),S(i,t),v(i,t),y(i,t),R(i,t),n.when.apply(n,i).done(function(){e(w)})}};return a}),n("epub-fetch/resource_cache",[],function(){var e=function(){var e={};this.getResourceURL=function(t){var n=e[t];return n},this.putResourceURL=function(t,n){e[t]=n}};return e}),n("epub-fetch/encryption_handler",["require","module"],function(){var e=function(e){function t(e,t){var n=new FileReader;n.onload=function(){var e=this.result;t(new Uint8Array(e))},n.readAsArrayBuffer(e)}function n(e,n,i,r){var o=e.slice(0,n);t(o,function(t){for(var o=i.length,a=0;n>a;a++)t[a]=t[a]^i[a%o];var s=new Blob([t],{type:e.type}),l=e.slice(n),u=new Blob([s,l],{type:e.type});r(u)})}function i(t,i){var r=1040;n(t,r,e.uidHash,i)}function r(e){var t=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i,n=t.exec(e),i=n[2]+n[3]+n[4]+n[5]+n[6];i&&32==i.length||console.error("Bad UUID format for ID :"+e);for(var r=[],o=0;16>o;o++){var a=i.substr(2*o,2),s=parseInt(a,16);r.push(s)}return r}function o(t,i){var o=r(e.uid),a=1024;n(t,a,o,i)}var a=this,s={"http://www.idpf.org/2008/embedding":i,"http://ns.adobe.com/pdf/enc#RC":o};this.isEncryptionSpecified=function(){return e&&e.encryptions},this.getEncryptionMethodForRelativePath=function(t){return a.isEncryptionSpecified()?e.encryptions[t]:void 0},this.getDecryptionFunctionForRelativePath=function(e){var t=a.getEncryptionMethodForRelativePath(e);return t&&s[t]?s[t]:void 0}};return e.CreateEncryptionData=function(e,t){var n={uid:e,uidHash:window.Crypto.SHA1(unescape(encodeURIComponent(e.trim())),{asBytes:!0}),encryptions:void 0},i=$("EncryptedData",t);return i.each(function(e,t){var i=$("EncryptionMethod",t).first().attr("Algorithm"),r=$("CipherReference",t);r.each(function(e,t){var r=$(t).attr("URI");console.log("Encryption/obfuscation algorithm "+i+" specified for "+r),n.encryptions||(n.encryptions={}),n.encryptions[r]=i})}),n},e}),n("epub-fetch/publication_fetcher",["require","module","jquery","URIjs","./markup_parser","./plain_resource_fetcher","./zip_resource_fetcher","./content_document_fetcher","./resource_cache","./encryption_handler"],function(e,t,n,i,r,o,a,s,l,u){var c=function(e,t){function c(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack)),console.error(e)}function d(){var t=".epub";return-1===e.indexOf(t,e.length-t.length)}function f(n,i){return n?(console.log("using new PlainResourceFetcher"),p=new o(h,e),void p.initialize(function(){i(p)})):(console.log("using new ZipResourceFetcher"),p=new a(h,e,t),i(p),void 0)}var h=this;h.contentTypePackageReadStrategyMap={"application/oebps-package+xml":"exploded","application/epub+zip":"zipped","application/zip":"zipped"};var g,p,m,v,S,y,R=new l;this.markupParser=new r,this.initialize=function(e){var t=d();g=!t,f(t,e)},this.shouldConstructDomProgrammatically=function(){return g},this.shouldFetchMediaAssetsProgrammatically=function(){return g&&!d()},this.getBookRoot=function(){return e},this.getJsLibRoot=function(){return t},this.getPackageUrl=function(){return p.getPackageUrl()},this.fetchContentDocument=function(e,t,n,i){var r=new s(h,e.spineItem,t,R);r.fetchContentDocumentAndResolveDom(n,function(e){c(e),i(e)})},this.getFileContentsFromPackage=function(e,t,n){p.fetchFileContentsText(e,function(e){t(e)},n)},this.getXmlFileDom=function(e,t,n){h.getFileContentsFromPackage(e,function(e){var n=h.markupParser.parseXml(e);t(n)},n)},this.getPackageFullPath=function(e,t){h.getXmlFileDom("META-INF/container.xml",function(t){var n=h.getRootFile(t);e(n)},t)},this.getRootFile=function(e){var t=n("rootfile",e),i=t.attr("full-path");return i},this.getPackageDom=function(e,t){S?e(S):y?y.done(e):(y=n.Deferred(),y.done(e),h.getPackageFullPath(function(e){v=e,h.getXmlFileDom(e,function(e){S=e,y.resolve(e),y=void 0})},t))},this.convertPathRelativeToPackageToRelativeToBase=function(e){return new i(e).absoluteTo(v).toString()},this.relativeToPackageFetchFileContents=function(e,t,n,i){i||(i=c);var r=decodeURIComponent(h.convertPathRelativeToPackageToRelativeToBase(e));"/"===r.charAt(0)&&(r=r.substr(1));var o=p.fetchFileContentsText;"blob"===t?o=p.fetchFileContentsBlob:"data64uri"===t&&(o=p.fetchFileContentsData64Uri),o.call(p,r,n,i)},this.getRelativeXmlFileDom=function(e,t,n){h.getXmlFileDom(h.convertPathRelativeToPackageToRelativeToBase(e),t,n)},this.setPackageMetadata=function(e,t){h.getXmlFileDom("META-INF/encryption.xml",function(n){var i=u.CreateEncryptionData(e.id,n);m=new u(i),m.isEncryptionSpecified()&&(g=!0),t()},function(){console.log("Document doesn't make use of encryption."),m=new u(void 0),t()})},this.getDecryptionFunctionForRelativePath=function(e){return m.getDecryptionFunctionForRelativePath(e)}};return c}),n("epub-fetch",["epub-fetch/publication_fetcher"],function(e){return e}),n("epub-model/package_document",["require","module","jquery","underscore","backbone","URIjs"],function(e,t,n,i,r,o){var a=function(e,t,i,r,a){function s(){var e=c(),t=e.href,n=t.substr(t.lastIndexOf(".")+1);return"ncx"===n.trim().toLowerCase()}function l(e){var t=n("<ol></ol>");return n.each(e.children("navPoint"),function(e,i){u(n(i),t)}),t}function u(e,t){var i=e.children("navLabel").text().trim(),r=e.children("content").attr("src"),o=n('<li class="nav-elem"></li>').append(n("<a></a>",{href:r,text:i}));if(t.append(o),e.children("navPoint").length>0){var a=n("<li></li>"),s=n("<ol></ol>");n.each(e.children("navPoint"),function(e,t){s.append(u(n(t),s))}),a.append(s),t.append(a)}}function c(){var e=a.getNavItem();if(e)return e;var t=i.ncx;return t&&t.length>0?a.getManifestItemByIdref(t):null}var d;this.manifest=a,this.getSharedJsPackageData=function(){var t=e.substr(0,e.lastIndexOf("/"));return{rootUrl:t,rendition_viewport:i.rendition_viewport,rendition_layout:i.rendition_layout,rendition_orientation:i.rendition_orientation,rendition_flow:i.rendition_flow,rendition_spread:i.rendition_spread,media_overlay:i.media_overlay,spine:{direction:this.getPageProgressionDirection(),items:r}}},this.getSpineItem=function(e){var t=r[e];return t},this.setPageProgressionDirection=function(e){d=e},this.getPageProgressionDirection=function(){return"rtl"===d?"rtl":"default"===d?"default":"ltr"},this.spineLength=function(){return r.length},this.getMetadata=function(){return i},this.getToc=function(){var e=c();return e?e.href:null},this.getTocText=function(e){var n=this.getToc();t.relativeToPackageFetchFileContents(n,"text",function(t){e(t)},function(t){console.error("ERROR fetching TOC from ["+n+"]:"),console.error(t),e(void 0)})},this.getTocDom=function(e){this.getTocText(function(t){if("string"==typeof t){var n=(new DOMParser).parseFromString(t,"text/xml");e(n)}else e(void 0)})},this.generateTocListDOM=function(t){var i=this;this.getTocDom(function(r){if(r)if(s()){var a;a=l(n("navMap",r)),t(a[0])}else{var u=new o(e).absoluteTo(document.URL),c=new o(i.getToc()).absoluteTo(u),d=(n(r).remove("base"),n("<base></base>"));n(d).attr("href",c),n(r).find("head").append(d),t(r)}else t(void 0)})}};return a}),n("epub-model/smil_document_parser",["require","module","jquery","underscore"],function(e,t,n){var i=function(e,t){function r(e){return{id:"",href:"",spineItemId:e.idref,children:[{nodeType:"seq",textref:e.href,children:[{nodeType:"par",children:[{nodeType:"text",src:e.href,srcFile:e.href,srcFragmentId:""}]}]}]}}this.parse=function(i,r,o,a,s,l){var u=this;t.getRelativeXmlFileDom(r.href,function(t){var l=n("smil",t)[0];o.smilVersion=l.getAttribute("version"),o.children=u.getChildren(l),o.href=r.href,o.id=r.id,o.spineItemId=i.idref;var c=e.getMetadata().getMediaItemByRefinesId(r.id);c&&(o.duration=c.duration),s(a,o)},function(e){l(a,e)})};var o=function(e,t,n,i,r){var o=e.split(":"),a=o[o.length-1];"type"===a&&(a="epubtype"),void 0!=t.getAttribute(e)?n[a]=t.getAttribute(e):i&&(void 0!==r?n[a]=r:console.log("Required property "+e+" not found in smil node "+t.nodeName))
};this.getChildren=function(e){var t=this,i=[];return n.each(e.childNodes,function(e,n){if(1===n.nodeType){var r=t.createItemFromElement(n);r&&i.push(r)}}),i},this.createItemFromElement=function(e){var t=this,n={};n.nodeType=e.nodeName;var r=!1;if("body"===n.nodeType&&(r=!0,n.nodeType="seq"),"seq"===n.nodeType)o("epub:textref",e,n,!r),o("id",e,n),o("epub:type",e,n),n.children=t.getChildren(e);else if("par"===n.nodeType)o("id",e,n),o("epub:type",e,n),n.children=t.getChildren(e);else if("text"===n.nodeType){o("src",e,n,!0);var a=n.src.split("#");n.srcFile=a[0],n.srcFragmentId=2===a.length?a[1]:"",o("id",e,n)}else{if("audio"!==n.nodeType)return void 0;o("src",e,n,!0),o("id",e,n),n.clipBegin=i.resolveClockValue(e.getAttribute("clipBegin")),n.clipEnd=i.resolveClockValue(e.getAttribute("clipEnd"))}return n},this.fillSmilData=function(t){var i=this;if(e.spineLength()<=0)return void t();for(var o=!0,a=[],s=[],l=0;l<e.spineLength();l++){var u=e.getSpineItem(l);if(u.media_overlay_id){var c=e.manifest.getManifestItemByIdref(u.media_overlay_id);if(!c){console.error("Cannot find SMIL manifest item for spine/manifest item?! "+u.media_overlay_id);continue}var d=n.Deferred();d.media_overlay_id=u.media_overlay_id,s.push(d);var f={};a.push(f),i.parse(u,c,f,d,function(e){o=!1,e.resolve()},function(e,t){console.log("Error when parsing SMIL manifest item "+c.href+":"),console.log(t),e.resolve()})}else a.push(r(u))}n.when.apply(n,s).done(function(){e.getMetadata().setMoMap(a),o&&(console.log("No Media Overlays"),e.getMetadata().setMoMap([])),t()})}};return i.resolveClockValue=function(e){if(!e)return 0;var t=0,n=0,i=0;if(-1!=e.indexOf("min"))n=parseFloat(e.substr(0,e.indexOf("min")));else if(-1!=e.indexOf("ms")){var r=parseFloat(e.substr(0,e.indexOf("ms")));i=r/1e3}else if(-1!=e.indexOf("s"))i=parseFloat(e.substr(0,e.indexOf("s")));else if(-1!=e.indexOf("h"))t=parseFloat(e.substr(0,e.indexOf("h")));else{var o=e.split(":");i=parseFloat(o.pop()),o.length>0&&(n=parseFloat(o.pop()),o.length>0&&(t=parseFloat(o.pop())))}var a=3600*t+60*n+i;return a},i}),n("epub-model/metadata",["require","module","underscore"],function(e,t,n){var i=function(){var e=this,t={};this.eachMediaItem=function(t){return e.mediaItems&&n.each(e.mediaItems,t),this},this.getMediaItemByRefinesId=function(e){return t[e]},this.setMoMap=function(t){e.media_overlay.smil_models=t},this.eachMediaItem(function(e){var n=e.refines,i=n.indexOf("#");if(i>=0){var r=i+1,o=n.length-1;n=n.substr(r,o)}n=n.trim(),t[n]=e})};return i}),n("epub-model/manifest",["require","module","underscore"],function(e,t,n){var i=function(e){var t,i={};this.manifestLength=function(){return e.length},this.getManifestItemByIdref=function(e){return i[e]},this.each=function(t){return n.each(e,t),this},this.getNavItem=function(){return t},this.each(function(e){i[e.id]=e,e.properties&&-1!==e.properties.indexOf("nav")&&(t=e)})};return i}),n("epub-model/package_document_parser",["require","module","jquery","underscore","backbone","epub-fetch/markup_parser","URIjs","./package_document","./smil_document_parser","./metadata","./manifest"],function(e,t,n,i,r,o,a,s,l,u,c){var d=function(e,t){function r(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack))}function a(e,n){var i=new l(e,t);i.fillSmilData(function(){n(e)})}function d(e){var i=n.Deferred();if(e.rendition_layout)i.resolve();else{var r="/META-INF/com.apple.ibooks.display-options.xml";t.relativeToPackageFetchFileContents(r,"text",function(t){if(t){var r=new o,a=r.parseXml(t),s=n("option[name=fixed-layout]",a)[0];if(s){var l=n(s).text();"true"===l&&(e.rendition_layout="pre-paginated",console.log("using com.apple.ibooks.display-options.xml fixed-layout property"))}}i.resolve()},function(){console.log("com.apple.ibooks.display-options.xml not found"),i.resolve()})}return i.promise()}function f(e,t,r){var o,a=[];return o=n(h(e,"spine")).children(),n.each(o,function(e,o){var s=n(o),l=s.attr("idref")?s.attr("idref"):"",u=t.getManifestItemByIdref(l),c=s.attr("id"),d=void 0;i.each(r.rendition_viewports,function(e){return e.refines==c?(d=e.viewport,!0):void 0});var f={rendition_viewport:d,idref:l,href:u.href,manifest_id:u.id,media_type:u.media_type,media_overlay_id:u.media_overlay_id,linear:s.attr("linear")?s.attr("linear"):"",properties:s.attr("properties")?s.attr("properties"):""},h=w(f.properties);i.extend(f,h),a.push(f)}),a}function h(e,t,n){var r=e.getElementsByTagNameNS("*",t);return n?i.find(r,n):r[0]}function g(e,t,n){var r=e.getElementsByTagNameNS("*",t);return i.filter(r,n)}function p(e,t,n){var i=h(e,t,n);return i?i.textContent:""}function m(e,t,n,i){var r=h(e,t,i);return r?r.getAttribute(n):""}function v(e,t){var n=h(e,"meta",function(e){return e.getAttribute("property")===t});return n?n.textContent:""}function S(e){var t=new u,n=h(e,"metadata"),r=h(e,"package"),o=h(e,"spine");t.author=p(n,"creator"),t.description=p(n,"description"),t.epub_version=r.getAttribute("version")?r.getAttribute("version"):"",t.id=p(n,"identifier"),t.language=p(n,"language"),t.modified_date=v(n,"dcterms:modified"),t.ncx=o.getAttribute("toc")?o.getAttribute("toc"):"",t.pubdate=p(n,"date"),t.publisher=p(n,"publisher"),t.rights=p(n,"rights"),t.title=p(n,"title"),t.rendition_orientation=v(n,"rendition:orientation"),t.rendition_layout=v(n,"rendition:layout"),t.rendition_spread=v(n,"rendition:spread"),t.rendition_flow=v(n,"rendition:flow"),t.rendition_viewport=p(n,"meta",function(e){return"rendition:viewport"===e.getAttribute("property")&&!e.hasAttribute("refines")});var a=[],s=g(n,"meta",function(e){return"rendition:viewport"===e.getAttribute("property")&&e.hasAttribute("refines")});i.each(s,function(e){var t=e.getAttribute("refines");if(t){var n=t.indexOf("#");if(n>=0){var i=n+1,r=t.length-1;t=t.substr(i,r)}t=t.trim()}var o={refines:t,viewport:e.textContent};a.push(o)}),t.rendition_viewports=a,t.mediaItems=[];var c=g(n,"meta",function(e){return"media:duration"===e.getAttribute("property")&&e.hasAttribute("refines")});return i.each(c,function(e){t.mediaItems.push({refines:e.getAttribute("refines"),duration:l.resolveClockValue(e.textContent)})}),t.media_overlay={duration:l.resolveClockValue(p(n,"meta",function(e){return"media:duration"===e.getAttribute("property")&&!e.hasAttribute("refines")})),narrator:v(n,"media:narrator"),activeClass:v(n,"media:active-class"),playbackActiveClass:v(n,"media:playback-active-class"),smil_models:[],skippables:["sidebar","practice","marginalia","annotation","help","note","footnote","rearnote","table","table-row","table-cell","list","list-item","pagebreak"],escapables:["sidebar","bibliography","toc","loi","appendix","landmarks","lot","index","colophon","epigraph","conclusion","afterword","warning","epilogue","foreword","introduction","prologue","preface","preamble","notice","errata","copyright-page","acknowledgments","other-credits","titlepage","imprimatur","contributors","halftitlepage","dedication","help","annotation","marginalia","practice","note","footnote","rearnote","footnotes","rearnotes","bridgehead","page-list","table","table-row","table-cell","list","list-item","glossary"]},t}function y(e){var t=n(h(e,"manifest")).children(),i=[];return n.each(t,function(e,t){var r=n(t),o=r.attr("href")?r.attr("href"):"",a={href:o,id:r.attr("id")?r.attr("id"):"",media_overlay_id:r.attr("media-overlay")?r.attr("media-overlay"):"",media_type:r.attr("media-type")?r.attr("media-type"):"",properties:r.attr("properties")?r.attr("properties"):""};i.push(a)}),i}function R(e){var t=n(h(e,"bindings")).children(),i=[];return n.each(t,function(e,t){var r=n(t),o={handler:r.attr("handler")?r.attr("handler"):"",media_type:r.attr("media-type")?r.attr("media-type"):""};i.push(o)}),i}function I(e){var t,r;if(t=h(e,"manifest"),r=n(h(t,"item",function(e){var t=e.getAttribute("properties");return t&&i.contains(t.split(" "),"cover-image")})),1===r.length&&r.attr("href"))return r.attr("href");var o=n(h(e,"meta",function(e){return"cover"===e.getAttribute("name")})),a=o.attr("content");return 1===o.length&&a&&(r=n(h(t,"item",function(e){return e.getAttribute("id")===a})),1===r.length&&r.attr("href"))?r.attr("href"):(r=n(h(t,"item",function(e){return"cover"===e.getAttribute("id")})),1===r.length&&r.attr("href")?r.attr("href"):null)}function w(e){for(var t={},n=e.split(" "),i=0;i<n.length;i++)"rendition:orientation-landscape"===n[i]&&(t.rendition_orientation="landscape"),"rendition:orientation-portrait"===n[i]&&(t.rendition_orientation="portrait"),"rendition:orientation-auto"===n[i]&&(t.rendition_orientation="auto"),"rendition:spread-none"===n[i]&&(t.rendition_spread="none"),"rendition:spread-landscape"===n[i]&&(t.rendition_spread="landscape"),"rendition:spread-portrait"===n[i]&&(t.rendition_spread="portrait"),"rendition:spread-both"===n[i]&&(t.rendition_spread="both"),"rendition:spread-auto"===n[i]&&(t.rendition_spread="auto"),"rendition:flow-paginated"===n[i]&&(t.rendition_flow="paginated"),"rendition:flow-scrolled-continuous"===n[i]&&(t.rendition_flow="scrolled-continuous"),"rendition:flow-scrolled-doc"===n[i]&&(t.rendition_flow="scrolled-doc"),"rendition:flow-auto"===n[i]&&(t.rendition_flow="auto"),"rendition:page-spread-center"===n[i]&&(t.page_spread="page-spread-center"),"page-spread-left"===n[i]&&(t.page_spread="page-spread-left"),"page-spread-right"===n[i]&&(t.page_spread="page-spread-right"),"rendition:layout-reflowable"===n[i]&&(t.fixed_flow=!1,t.rendition_layout="reflowable"),"rendition:layout-pre-paginated"===n[i]&&(t.fixed_flow=!0,t.rendition_layout="pre-paginated");return t}var C,E=t,T=n.Deferred();t.getPackageDom(function(e){C=e,T.resolve(e)},r),this.parse=function(e){T.done(function(i){var r=S(i),o=(i.getElementsByTagNameNS("*","spine")[0],m(i,"spine","page-progression-direction")),l=(R(i),new c(y(i))),u=f(i,l,r),h=I(i);h&&(r.cover_href=h),n.when(d(r)).then(function(){E.setPackageMetadata(r,function(){var n=new s(t.getPackageUrl(),t,r,u,l);n.setPageProgressionDirection(o),a(n,e)})})})}};return d}),n("epub-fetch/iframe_zip_loader",["URIjs"],function(e){var t=function(t,n,i){function r(e,t){$.ajax({url:e,dataType:"html",async:!0,success:function(e){t(e)},error:function(n,i,r){console.error("Error when AJAX fetching "+e),console.error(i),console.error(r),t()}})}function o(e,t){r(e,function(n){if(!n)return void t();var r=e.split("/");r.pop();var o='<base href="'+r.join("/")+'/"/>',s='<script type="text/javascript">('+a.toString()+")()</script>";i&&i.mathJaxUrl&&n.indexOf("<math")>=0&&(s+='<script type="text/javascript" src="'+i.mathJaxUrl+'"></script>');var l=n.replace(/(<head.*?>)/,"$1"+o+s);t(l)})}function a(){navigator.epubReadingSystem=window.parent.navigator.epubReadingSystem,window.parent=window.self,window.top=window.self}var s=new t.Views.IFrameLoader,l=this;this.addIFrameEventListener=function(e,t,n){s.addIFrameEventListener(e,t,n)},this.updateIframeEvents=function(e){s.updateIframeEvents(e)},this.loadIframe=function(t,i,r,a,s){var u=new e(i).absoluteTo(t.baseURI).search("").hash("").toString(),c=n().shouldConstructDomProgrammatically();c?n().fetchContentDocument(s,u,function(e){l._loadIframeWithDocument(t,s,e.documentElement.outerHTML,function(){r.call(a,!0,s)})},function(){r.call(a,!1,s)}):o(u,function(e){e?l._loadIframeWithDocument(t,s,e,function(){r.call(a,!0,s)}):r.call(a,!1,s)})},this._loadIframeWithDocument=function(e,t,n,i){var r=window.navigator.userAgent.indexOf("Trident")>0;if(r)e.contentWindow.document.open(),e.contentWindow.document.write(n);else{var o="text/html";t.spineItem.media_type&&t.spineItem.media_type.length&&(o=t.spineItem.media_type);var a=window.URL.createObjectURL(new Blob([n],{type:o}))}e.onload=function(){l.updateIframeEvents(e);var t=e.contentWindow.MathJax;if(t){var n=_.once(i);t.Hub.Queue(n)}else i();r||window.URL.revokeObjectURL(a)},r?e.contentWindow.document.close():e.setAttribute("src",a)}};return t}),n("Readium",["require","console_shim","jquery","underscore","readerView","epub-fetch","epub-model/package_document_parser","epub-fetch/iframe_zip_loader","URIjs"],function(e,t,n,i,r,o,a,s,l){if(window.URI=l,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}var u=function(e,t){var i,r=this,l=e.jsLibRoot;t.iframeLoader=e.useSimpleLoader?new ReadiumSDK.Views.IFrameLoader:new s(ReadiumSDK,function(){return i},{mathJaxUrl:t.mathJaxUrl}),this.reader=new ReadiumSDK.Views.ReaderView(t),this.openPackageDocument=function(t,s,u){i=new o(t,l),i.initialize(function(){var o=new a(t,i);o.parse(function(t){var o=e.openBookOptions||{},a=n.extend(t.getSharedJsPackageData(),o);u&&(a.openPageRequest=u),r.reader.openBook(a);var l={packageDocumentUrl:i.getPackageUrl(),metadata:t.getMetadata()};s&&s(t,l)})})},ReadiumSDK.reader=this.reader,ReadiumSDK.trigger(ReadiumSDK.Events.READER_INITIALIZED,this.reader)};return u.version={readiumJs:{sha:"428b2956dce052598a73f8558b8a686600eabbd2",clean:!0},readiumSharedJs:{sha:"e3d096dabe6d6ea188c9af97fc28fc7c410982b2",clean:!0}},u}),n("readium",function(){})}();