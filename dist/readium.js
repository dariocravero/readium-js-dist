/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * @license RequireJS text 2.0.6 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

//  LauncherOSX
//
//  Created by Boris Schneiderman.
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

/**
 * @preserve JSizes - JQuery plugin v0.33
 *
 * Licensed under the revised BSD License.
 * Copyright 2008-2010 Bram Stein
 * All rights reserved.
 */

//  Created by Boris Schneiderman.
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  LauncherOSX
//
//  Created by Boris Schneiderman.
// Modified by Daniel Weck
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  LauncherOSX
//
//  Created by Boris Schneiderman.
// Modified by Daniel Weck, Andrey Kavarma
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

/**
 * Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Highlighter module for Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core, TextRange and CssClassApplier modules.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Class Applier module for Rangy.
 * Adds, removes and toggles classes on Ranges and Selections
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Text range module for Rangy.
 * Text-based manipulation and searching of ranges and selections.
 *
 * Features
 *
 * - Ability to move range boundaries by character or word offsets
 * - Customizable word tokenizer
 * - Ignores text nodes inside <script> or <style> elements or those hidden by CSS display and visibility properties
 * - Range findText method to search for text or regex within the page or within a range. Flags for whole words and case
 *   sensitivity
 * - Selection and range save/restore as text offsets within a node
 * - Methods to return visible text within a range or selection
 * - innerText method for elements
 *
 * References
 *
 * https://www.w3.org/Bugs/Public/show_bug.cgi?id=13145
 * http://aryeh.name/spec/innertext/innertext.html
 * http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.804
 * Build date: 8 December 2013
 */

/**
 * Position module for Rangy.
 * Extensions to Range and Selection objects to provide access to pixel positions relative to the viewport or document.
 *
 * Part of Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core.
 *
 * Copyright %%build:year%%, Tim Down
 * Licensed under the MIT license.
 * Version: %%build:version%%
 * Build date: %%build:date%%
 */

//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
// 
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Created by Dmitry Markushevich (dmitrym@evidentpoint.com)
// 
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Created by Boris Schneiderman.
// Modified by Daniel Weck
//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.
//  
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND 
//  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
//  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. 
//  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, 
//  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
//  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, 
//  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF 
//  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE 
//  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED 
//  OF THE POSSIBILITY OF SUCH DAMAGE.

//  Copyright (c) 2014 Readium Foundation and/or its licensees. All rights reserved.
//  
//  Redistribution and use in source and binary forms, with or without modification, 
//  are permitted provided that the following conditions are met:
//  1. Redistributions of source code must retain the above copyright notice, this 
//  list of conditions and the following disclaimer.
//  2. Redistributions in binary form must reproduce the above copyright notice, 
//  this list of conditions and the following disclaimer in the documentation and/or 
//  other materials provided with the distribution.
//  3. Neither the name of the organization nor the names of its contributors may be 
//  used to endorse or promote products derived from this software without specific 
//  prior written permission.

!function(){var requirejs,require,define;!function(undef){function hasProp(obj,prop){return hasOwn.call(obj,prop)}function normalize(name,baseName){var nameParts,nameSegment,mapValue,foundMap,lastIndex,foundI,foundStarMap,starI,i,j,part,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"]||{};if(name&&"."===name.charAt(0))if(baseName){for(baseParts=baseParts.slice(0,baseParts.length-1),name=name.split("/"),lastIndex=name.length-1,config.nodeIdCompat&&jsSuffixRegExp.test(name[lastIndex])&&(name[lastIndex]=name[lastIndex].replace(jsSuffixRegExp,"")),name=baseParts.concat(name),i=0;i<name.length;i+=1)if(part=name[i],"."===part)name.splice(i,1),i-=1;else if(".."===part){if(1===i&&(".."===name[2]||".."===name[0]))break;i>0&&(name.splice(i-1,2),i-=2)}name=name.join("/")}else 0===name.indexOf("./")&&(name=name.substring(2));if((baseParts||starMap)&&map){for(nameParts=name.split("/"),i=nameParts.length;i>0;i-=1){if(nameSegment=nameParts.slice(0,i).join("/"),baseParts)for(j=baseParts.length;j>0;j-=1)if(mapValue=map[baseParts.slice(0,j).join("/")],mapValue&&(mapValue=mapValue[nameSegment])){foundMap=mapValue,foundI=i;break}if(foundMap)break;!foundStarMap&&starMap&&starMap[nameSegment]&&(foundStarMap=starMap[nameSegment],starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return name}function makeRequire(relName,forceSync){return function(){var args=aps.call(arguments,0);return"string"!=typeof args[0]&&1===args.length&&args.push(null),req.apply(undef,args.concat([relName,forceSync]))}}function makeNormalize(relName){return function(name){return normalize(name,relName)}}function makeLoad(depName){return function(value){defined[depName]=value}}function callDep(name){if(hasProp(waiting,name)){var args=waiting[name];delete waiting[name],defining[name]=!0,main.apply(undef,args)}if(!hasProp(defined,name)&&!hasProp(defining,name))throw new Error("No "+name);return defined[name]}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;return index>-1&&(prefix=name.substring(0,index),name=name.substring(index+1,name.length)),[prefix,name]}function makeConfig(name){return function(){return config&&config.config&&config.config[name]||{}}}var main,req,makeMap,handlers,defined={},waiting={},config={},defining={},hasOwn=Object.prototype.hasOwnProperty,aps=[].slice,jsSuffixRegExp=/\.js$/;makeMap=function(name,relName){var plugin,parts=splitPrefix(name),prefix=parts[0];return name=parts[1],prefix&&(prefix=normalize(prefix,relName),plugin=callDep(prefix)),prefix?name=plugin&&plugin.normalize?plugin.normalize(name,makeNormalize(relName)):normalize(name,relName):(name=normalize(name,relName),parts=splitPrefix(name),prefix=parts[0],name=parts[1],prefix&&(plugin=callDep(prefix))),{f:prefix?prefix+"!"+name:name,n:name,pr:prefix,p:plugin}},handlers={require:function(name){return makeRequire(name)},exports:function(name){var e=defined[name];return"undefined"!=typeof e?e:defined[name]={}},module:function(name){return{id:name,uri:"",exports:defined[name],config:makeConfig(name)}}},main=function(name,deps,callback,relName){var cjsModule,depName,ret,map,i,usingExports,args=[],callbackType=typeof callback;if(relName=relName||name,"undefined"===callbackType||"function"===callbackType){for(deps=!deps.length&&callback.length?["require","exports","module"]:deps,i=0;i<deps.length;i+=1)if(map=makeMap(deps[i],relName),depName=map.f,"require"===depName)args[i]=handlers.require(name);else if("exports"===depName)args[i]=handlers.exports(name),usingExports=!0;else if("module"===depName)cjsModule=args[i]=handlers.module(name);else if(hasProp(defined,depName)||hasProp(waiting,depName)||hasProp(defining,depName))args[i]=callDep(depName);else{if(!map.p)throw new Error(name+" missing "+depName);map.p.load(map.n,makeRequire(relName,!0),makeLoad(depName),{}),args[i]=defined[depName]}ret=callback?callback.apply(defined[name],args):void 0,name&&(cjsModule&&cjsModule.exports!==undef&&cjsModule.exports!==defined[name]?defined[name]=cjsModule.exports:ret===undef&&usingExports||(defined[name]=ret))}else name&&(defined[name]=callback)},requirejs=require=req=function(deps,callback,relName,forceSync,alt){if("string"==typeof deps)return handlers[deps]?handlers[deps](callback):callDep(makeMap(deps,callback).f);if(!deps.splice){if(config=deps,config.deps&&req(config.deps,config.callback),!callback)return;callback.splice?(deps=callback,callback=relName,relName=null):deps=undef}return callback=callback||function(){},"function"==typeof relName&&(relName=forceSync,forceSync=alt),forceSync?main(undef,deps,callback,relName):setTimeout(function(){main(undef,deps,callback,relName)},4),req},req.config=function(cfg){return req(cfg)},requirejs._defined=defined,define=function(name,deps,callback){deps.splice||(callback=deps,deps=[]),hasProp(defined,name)||hasProp(waiting,name)||(waiting[name]=[name,deps,callback])},define.amd={jQuery:!0}}(),define("almond",function(){}),define("text",["module"],function(module){var text,fs,Cc,Ci,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation="undefined"!=typeof location&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||void 0),buildMap=[],masterConfig=module.config&&module.config()||{};return text={version:"2.0.6",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(i=0;3>i;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var modName,ext,temp,strip=!1,index=name.indexOf("."),isRelative=0===name.indexOf("./")||0===name.indexOf("../");return-1!==index&&(!isRelative||index>1)?(modName=name.substring(0,index),ext=name.substring(index+1,name.length)):modName=name,temp=ext||modName,index=temp.indexOf("!"),-1!==index&&(strip="strip"===temp.substring(index+1),temp=temp.substring(0,index),ext?ext=temp:modName=temp),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var uProtocol,uHostName,uPort,match=text.xdRegExp.exec(url);return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],!(uProtocol&&uProtocol!==protocol||uHostName&&uHostName.toLowerCase()!==hostname.toLowerCase()||(uPort||uHostName)&&uPort!==port)):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config.isBuild&&!config.inlineText)return void onLoad();masterConfig.isBuild=config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+(parsed.ext?"."+parsed.ext:""),url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})},write:function(pluginName,moduleName,write){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),extPart=parsed.ext?"."+parsed.ext:"",nonStripName=parsed.moduleName+extPart,fileName=req.toUrl(parsed.moduleName+extPart)+".js";text.load(nonStripName,req,function(){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}},"node"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(fs=require.nodeRequire("fs"),text.get=function(url,callback){var file=fs.readFileSync(url,"utf8");0===file.indexOf("ï»¿")&&(file=file.substring(1)),callback(file)}):"xhr"===masterConfig.env||!masterConfig.env&&text.createXhr()?text.get=function(url,callback,errback,headers){var header,xhr=text.createXhr();if(xhr.open("GET",url,!0),headers)for(header in headers)headers.hasOwnProperty(header)&&xhr.setRequestHeader(header.toLowerCase(),headers[header]);masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(){var status,err;4===xhr.readyState&&(status=xhr.status,status>399&&600>status?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback(err)):callback(xhr.responseText),masterConfig.onXhrComplete&&masterConfig.onXhrComplete(xhr,url))},xhr.send(null)}:"rhino"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?text.get=function(url,callback){var stringBuffer,line,encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),content="";try{for(stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&65279===line.charAt(0)&&(line=line.substring(1)),stringBuffer.append(line);null!==(line=input.readLine());)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)}:("xpconnect"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(Cc=Components.classes,Ci=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),text.get=function(url,callback){var inStream,convertStream,readData={},fileObj=new FileUtils.File(url);try{inStream=Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream),inStream.init(fileObj,1,0,!1),convertStream=Cc["@mozilla.org/intl/converter-input-stream;1"].createInstance(Ci.nsIConverterInputStream),convertStream.init(inStream,"utf-8",inStream.available(),Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),convertStream.readString(inStream.available(),readData),convertStream.close(),inStream.close(),callback(readData.value)}catch(e){throw new Error((fileObj&&fileObj.path||"")+": "+e)}}),text}),function(){console.debug||(console.debug=console.log),console.info||(console.info=console.log),console.warn||(console.warn=console.log),console.error||(console.error=console.log)}(),define("console_shim",function(){}),ReadiumSDK={version:function(){return"0.8.0"},Models:{Smil:{}},Views:{ORIENTATION_LANDSCAPE:"orientation_landscape",ORIENTATION_PORTRAIT:"orientation_portrait"},Collections:{},Routers:{},Helpers:{},Events:{READER_INITIALIZED:"ReaderInitialized",PAGINATION_CHANGED:"PaginationChanged",SETTINGS_APPLIED:"SettingsApplied",FXL_VIEW_RESIZED:"FXLViewResized",READER_VIEW_CREATED:"ReaderViewCreated",READER_VIEW_DESTROYED:"ReaderViewDestroyed",CONTENT_DOCUMENT_LOAD_START:"ContentDocumentLoadStart",CONTENT_DOCUMENT_LOADED:"ContentDocumentLoaded",MEDIA_OVERLAY_STATUS_CHANGED:"MediaOverlayStatusChanged",MEDIA_OVERLAY_TTS_SPEAK:"MediaOverlayTTSSpeak",MEDIA_OVERLAY_TTS_STOP:"MediaOverlayTTSStop"},InternalEvents:{CURRENT_VIEW_PAGINATION_CHANGED:"CurrentViewPaginationChanged"}},navigator.epubReadingSystem={name:"",version:"0.0.0",layoutStyle:"paginated",hasFeature:function(feature,version){return version&&"1.0"!==version?!1:"dom-manipulation"===feature?!0:"layout-changes"===feature?!0:"touch-events"===feature?!1:"mouse-events"===feature?!0:"keyboard-events"===feature?!0:"spine-scripting"===feature?!0:!1}},_.extend(ReadiumSDK,Backbone.Events),define("readiumSDK",["backbone"],function(global){return function(){var ret;return ret||global.readiumSDK}}(this)),function($){var num=function(value){return parseInt(value,10)||0};$.each(["min","max"],function(i,name){$.fn[name+"Size"]=function(value){var width,height;return value?(void 0!==value.width&&this.css(name+"-width",value.width),void 0!==value.height&&this.css(name+"-height",value.height),this):(width=this.css(name+"-width"),height=this.css(name+"-height"),{width:"max"===name&&(void 0===width||"none"===width||-1===num(width))&&Number.MAX_VALUE||num(width),height:"max"===name&&(void 0===height||"none"===height||-1===num(height))&&Number.MAX_VALUE||num(height)})}}),$.fn.isVisible=function(){return this.is(":visible")},$.each(["border","margin","padding"],function(i,name){$.fn[name]=function(value){return value?(void 0!==value.top&&this.css(name+"-top"+("border"===name?"-width":""),value.top),void 0!==value.bottom&&this.css(name+"-bottom"+("border"===name?"-width":""),value.bottom),void 0!==value.left&&this.css(name+"-left"+("border"===name?"-width":""),value.left),void 0!==value.right&&this.css(name+"-right"+("border"===name?"-width":""),value.right),this):{top:num(this.css(name+"-top"+("border"===name?"-width":""))),bottom:num(this.css(name+"-bottom"+("border"===name?"-width":""))),left:num(this.css(name+"-left"+("border"===name?"-width":""))),right:num(this.css(name+"-right"+("border"===name?"-width":"")))}}})}(jQuery),define("jquerySizes",["jquery"],function(global){return function(){var ret;return ret||global.jquerySizes}}(this)),ReadiumSDK.Helpers.Rect=function(left,top,width,height){this.left=left,this.top=top,this.width=width,this.height=height,this.right=function(){return this.left+this.width},this.bottom=function(){return this.top+this.height},this.isOverlap=function(rect,tolerance){return void 0==tolerance&&(tolerance=0),!(rect.right()<this.left+tolerance||rect.left>this.right()-tolerance||rect.bottom()<this.top+tolerance||rect.top>this.bottom()-tolerance)}},ReadiumSDK.Helpers.Rect.fromElement=function($element){var e;e=_.isArray($element)||$element instanceof jQuery?$element[0]:$element,3===e.nodeType&&(e=$element.parent()[0]);for(var offsetLeft=e.offsetLeft,offsetTop=e.offsetTop,offsetWidth=e.offsetWidth,offsetHeight=e.offsetHeight;e=e.offsetParent;)offsetLeft+=e.offsetLeft,offsetTop+=e.offsetTop;return new ReadiumSDK.Helpers.Rect(offsetLeft,offsetTop,offsetWidth,offsetHeight)},ReadiumSDK.Helpers.ResolveContentRef=function(contentRef,sourceFileHref){if(!sourceFileHref)return contentRef;var sourceParts=sourceFileHref.split("/");sourceParts.pop();for(var pathComponents=contentRef.split("/");sourceParts.length>0&&".."===pathComponents[0];)sourceParts.pop(),pathComponents.splice(0,1);var combined=sourceParts.concat(pathComponents);return combined.join("/")},ReadiumSDK.Helpers.EndsWith=function(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)},ReadiumSDK.Helpers.BeginsWith=function(str,suffix){return 0===str.indexOf(suffix)},ReadiumSDK.Helpers.RemoveFromString=function(str,toRemove){var startIx=str.indexOf(toRemove);return-1==startIx?str:str.substring(0,startIx)+str.substring(startIx+toRemove.length)},ReadiumSDK.Helpers.Margins=function(margin,border,padding){this.margin=margin,this.border=border,this.padding=padding,this.left=this.margin.left+this.border.left+this.padding.left,this.right=this.margin.right+this.border.right+this.padding.right,this.top=this.margin.top+this.border.top+this.padding.top,this.bottom=this.margin.bottom+this.border.bottom+this.padding.bottom,this.width=function(){return this.left+this.right},this.height=function(){return this.top+this.bottom}},ReadiumSDK.Helpers.triggerLayout=function($iframe){var doc=$iframe[0].contentDocument;if(doc){var ss=void 0;try{if(ss=doc.styleSheets&&doc.styleSheets.length?doc.styleSheets[0]:void 0,!ss){var style=doc.createElement("style");doc.head.appendChild(style),style.appendChild(doc.createTextNode("")),ss=style.sheet}ss&&ss.insertRule("body:first-child::before {content:'READIUM';color: red;font-weight: bold;}",ss.cssRules.length)}catch(ex){console.error(ex)}try{var el=doc.createElementNS("http://www.w3.org/1999/xhtml","style");el.appendChild(doc.createTextNode("*{}")),doc.body.appendChild(el),doc.body.removeChild(el),ss&&ss.deleteRule(ss.cssRules.length-1)}catch(ex){console.error(ex)}if(doc.body){doc.body.offsetTop}}},ReadiumSDK.Helpers.deduceSyntheticSpread=function($viewport,spineItem,settings){if(!$viewport||0==$viewport.length)return 0;var rendition_spread=spineItem?spineItem.getRenditionSpread():void 0;if(rendition_spread===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE)return!1;if("double"==settings.syntheticSpread)return!0;if("single"==settings.syntheticSpread)return!1;if(!spineItem)return 0;if(rendition_spread===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH)return!0;var orientation=ReadiumSDK.Helpers.getOrientation($viewport);if(rendition_spread===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE)return orientation===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;if(rendition_spread===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT)return orientation===ReadiumSDK.Views.ORIENTATION_PORTRAIT;if(!rendition_spread||rendition_spread===ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO){var landscape=orientation===ReadiumSDK.Views.ORIENTATION_LANDSCAPE;return landscape?1:0}return console.warn("ReadiumSDK.Helpers.deduceSyntheticSpread: spread properties?!"),0},ReadiumSDK.Helpers.Margins.fromElement=function($element){return new this($element.margin(),$element.border(),$element.padding())},ReadiumSDK.Helpers.Margins.empty=function(){return new this({left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0},{left:0,right:0,top:0,bottom:0})},ReadiumSDK.Helpers.loadTemplate=function(name){return ReadiumSDK.Helpers.loadTemplate.cache[name]},ReadiumSDK.Helpers.loadTemplate.cache={fixed_book_frame:'<div id="fixed-book-frame" class="clearfix book-frame fixed-book-frame"></div>',single_page_frame:'<div><div id="scaler"><iframe scrolling="no" class="iframe-fixed"></iframe></div></div>',scrolled_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"><div id="scrolled-content-frame"></div></div>',reflowable_book_frame:'<div id="reflowable-book-frame" class="clearfix book-frame reflowable-book-frame"></div>',reflowable_book_page_frame:'<div id="reflowable-content-frame" class="reflowable-content-frame"><iframe scrolling="no" id="epubContentIframe"></iframe></div>'},ReadiumSDK.Helpers.setStyles=function(styles,$element){var count=styles.length;if(count)for(var i=0;count>i;i++){var style=styles[i];style.selector?$(style.selector,$element).css(style.declarations):$element.css(style.declarations)}},ReadiumSDK.Helpers.isIframeAlive=function(iframe){var w=void 0,d=void 0;try{w=iframe.contentWindow,d=iframe.contentDocument}catch(ex){return console.error(ex),!1}return w&&d},ReadiumSDK.Helpers.getOrientation=function($viewport){var viewportWidth=$viewport.width(),viewportHeight=$viewport.height();return viewportWidth&&viewportHeight?viewportWidth>=viewportHeight?ReadiumSDK.Views.ORIENTATION_LANDSCAPE:ReadiumSDK.Views.ORIENTATION_PORTRAIT:void 0},ReadiumSDK.Helpers.isRenditionSpreadPermittedForItem=function(item,orientation){var rendition_spread=item.getRenditionSpread();return!rendition_spread||rendition_spread==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH||rendition_spread==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO||rendition_spread==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE&&orientation==ReadiumSDK.Views.ORIENTATION_LANDSCAPE||rendition_spread==ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT&&orientation==ReadiumSDK.Views.ORIENTATION_PORTRAIT},ReadiumSDK.Helpers.CSSTransformString=function(options){var translate,scale,rotation,origin=options.origin;if(options.left||options.top){var left=options.left||0,top=options.top||0;translate="translate("+left+"px, "+top+"px)"}if(options.scale&&(scale="scale("+options.scale+")"),options.angle&&(rotation="rotate("+options.angle+"deg)"),!(translate||scale||rotation))return{};var transformString=translate&&scale?translate+" "+scale:translate?translate:scale;rotation&&(transformString=transformString+" "+rotation);var css={};return _.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transform"]=transformString,css[prefix+"transform-origin"]=origin?origin:"0 0"}),css},ReadiumSDK.Helpers.escapeJQuerySelector=function(sel){if(!sel)return void 0;var selector=sel.replace(/([;&,\.\+\*\~\?':"\!\^#$%@\[\]\(\)<=>\|\/\\{}`])/g,"\\$1");return selector},define("helpers",["readiumSDK","jquerySizes"],function(global){return function(){var ret;return ret||global.helpers}}(this)),ReadiumSDK.Models.ViewerSettings=function(settingsData){function buildArray(str){for(var retArr=[],arr=str.split(/[\s,;]+/),i=0;i<arr.length;i++){var item=arr[i].trim();""!==item&&retArr.push(item)}return retArr}function mapProperty(propName,settingsData,functionToApply){void 0!==settingsData[propName]&&(self[propName]=functionToApply?functionToApply(settingsData[propName]):settingsData[propName])}var self=this;this.syntheticSpread="auto",this.fontSize=100,this.columnGap=20,this.mediaOverlaysPreservePlaybackWhenScroll=!1,this.mediaOverlaysSkipSkippables=!1,this.mediaOverlaysEscapeEscapables=!0,this.mediaOverlaysSkippables=[],this.mediaOverlaysEscapables=[],this.mediaOverlaysEnableClick=!0,this.mediaOverlaysRate=1,this.mediaOverlaysVolume=100,this.mediaOverlaysSynchronizationGranularity="",this.mediaOverlaysAutomaticPageTurn=!0,this.enableGPUHardwareAccelerationCSS3D=!0,this.pageTransition=-1,this.scroll="auto",this.update=function(settingsData){mapProperty("columnGap",settingsData),mapProperty("fontSize",settingsData),mapProperty("mediaOverlaysPreservePlaybackWhenScroll",settingsData),mapProperty("mediaOverlaysSkipSkippables",settingsData),mapProperty("mediaOverlaysEscapeEscapables",settingsData),mapProperty("mediaOverlaysSkippables",settingsData,buildArray),mapProperty("mediaOverlaysEscapables",settingsData,buildArray),mapProperty("mediaOverlaysEnableClick",settingsData),mapProperty("mediaOverlaysRate",settingsData),mapProperty("mediaOverlaysVolume",settingsData),mapProperty("mediaOverlaysSynchronizationGranularity",settingsData),mapProperty("mediaOverlaysAutomaticPageTurn",settingsData),mapProperty("scroll",settingsData),mapProperty("syntheticSpread",settingsData),mapProperty("pageTransition",settingsData),mapProperty("enableGPUHardwareAccelerationCSS3D",settingsData)},this.update(settingsData)},define("viewerSettings",["readiumSDK"],function(global){return function(){var ret;return ret||global.viewerSettings}}(this)),ReadiumSDK.Models.Style=function(selector,declarations){this.selector=selector,this.declarations=declarations,this.setDeclarations=function(declarations){for(var prop in declarations)declarations.hasOwnProperty(prop)&&(this.declarations[prop]=declarations[prop])}},define("style",["readiumSDK"],function(global){return function(){var ret;return ret||global.style}}(this)),ReadiumSDK.Collections.StyleCollection=function(){var _styles=[];this.clear=function(){_styles.length=0},this.findStyle=function(selector){for(var count=_styles.length,i=0;count>i;i++)if(_styles[i].selector===selector)return _styles[i];return void 0},this.addStyle=function(selector,declarations){var style=this.findStyle(selector);return style?style.setDeclarations(declarations):(style=new ReadiumSDK.Models.Style(selector,declarations),_styles.push(style)),style},this.removeStyle=function(selector){for(var count=_styles.length,i=0;count>i;i++)if(_styles[i].selector===selector)return void _styles.splice(i,1)},this.getStyles=function(){return _styles},this.resetStyleValues=function(){for(var count=_styles.length,i=0;count>i;i++){var style=_styles[i],declarations=style.declarations;for(var prop in declarations)declarations.hasOwnProperty(prop)&&(declarations[prop]="")}}},define("styleCollection",["readiumSDK","style"],function(global){return function(){var ret;return ret||global.styleCollection}}(this)),ReadiumSDK.Models.SpineItem=function(itemData,index,spine){function validateSpread(){self.page_spread&&self.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_LEFT&&self.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_RIGHT&&self.page_spread!=ReadiumSDK.Models.SpineItem.SPREAD_CENTER&&console.error(self.page_spread+" is not a recognized spread type")}function isPropertyValueSetForItemOrPackage(propName,propValue){return self[propName]?self[propName]===propValue:self.spine.package[propName]?self.spine.package[propName]===propValue:!1}var self=this;this.idref=itemData.idref,this.href=itemData.href,this.linear=itemData.linear?itemData.linear.toLowerCase():itemData.linear,this.page_spread=itemData.page_spread,this.rendition_viewport=itemData.rendition_viewport,this.rendition_spread=itemData.rendition_spread,this.rendition_orientation=itemData.rendition_orientation,this.rendition_layout=itemData.rendition_layout,this.rendition_flow=itemData.rendition_flow,this.media_overlay_id=itemData.media_overlay_id,this.media_type=itemData.media_type,this.index=index,this.spine=spine,validateSpread(),this.setSpread=function(spread){this.page_spread=spread,validateSpread()},this.isRenditionSpreadAllowed=function(){var rendition_spread=self.getRenditionSpread();return!rendition_spread||rendition_spread!=ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE},this.isLeftPage=function(){return self.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_LEFT},this.isRightPage=function(){return self.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_RIGHT},this.isCenterPage=function(){return self.page_spread==ReadiumSDK.Models.SpineItem.SPREAD_CENTER},this.isReflowable=function(){return!self.isFixedLayout()},this.isFixedLayout=function(){var isLayoutExplicitlyDefined=self.getRenditionLayout();if(isLayoutExplicitlyDefined){if(self.rendition_layout){if(self.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED)return!0;if(self.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE)return!1}return self.spine.package.isFixedLayout()}return self.media_type.indexOf("image/")>=0},this.getRenditionFlow=function(){return self.rendition_flow?self.rendition_flow:self.spine.package.rendition_flow},this.getRenditionViewport=function(){return self.rendition_viewport?self.rendition_viewport:self.spine.package.rendition_viewport},this.getRenditionSpread=function(){return self.rendition_spread?self.rendition_spread:self.spine.package.rendition_spread},this.getRenditionOrientation=function(){return self.rendition_orientation?self.rendition_orientation:self.spine.package.rendition_orientation},this.getRenditionLayout=function(){return self.rendition_layout?self.rendition_layout:self.spine.package.rendition_layout},this.isFlowScrolledContinuous=function(){return isPropertyValueSetForItemOrPackage("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS)},this.isFlowScrolledDoc=function(){return isPropertyValueSetForItemOrPackage("rendition_flow",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC)}},ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_REFLOWABLE="reflowable",ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED="pre-paginated",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_ORIENTATION_AUTO="auto",ReadiumSDK.Models.SpineItem.SPREAD_LEFT="page-spread-left",ReadiumSDK.Models.SpineItem.SPREAD_RIGHT="page-spread-right",ReadiumSDK.Models.SpineItem.SPREAD_CENTER="page-spread-center",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_NONE="none",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_LANDSCAPE="landscape",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_PORTRAIT="portrait",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_BOTH="both",ReadiumSDK.Models.SpineItem.RENDITION_SPREAD_AUTO="auto",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_PAGINATED="paginated",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_CONTINUOUS="scrolled-continuous",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_SCROLLED_DOC="scrolled-doc",ReadiumSDK.Models.SpineItem.RENDITION_FLOW_AUTO="auto",ReadiumSDK.Models.SpineItem.alternateSpread=function(spread){return spread===ReadiumSDK.Models.SpineItem.SPREAD_LEFT?ReadiumSDK.Models.SpineItem.SPREAD_RIGHT:spread===ReadiumSDK.Models.SpineItem.SPREAD_RIGHT?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:spread},define("spineItem",["readiumSDK"],function(global){return function(){var ret;return ret||global.spineItem}}(this)),ReadiumSDK.Models.Spine=function(epubPackage,spineDTO){function isValidLinearItem(item){return!_handleLinear||"no"!==item.linear}function lookForNextValidItem(ix){if(!isValidIndex(ix))return void 0;var item=self.items[ix];return isValidLinearItem(item)?item:lookForNextValidItem(item.index+1)}function lookForPrevValidItem(ix){if(!isValidIndex(ix))return void 0;var item=self.items[ix];return isValidLinearItem(item)?item:lookForPrevValidItem(item.index-1)}function isValidIndex(index){return index>=0&&index<self.items.length}function updateSpineItemsSpread(){for(var len=self.items.length,isFirstPageInSpread=!1,baseSide=self.isLeftToRight()?ReadiumSDK.Models.SpineItem.SPREAD_LEFT:ReadiumSDK.Models.SpineItem.SPREAD_RIGHT,i=0;len>i;i++){var spineItem=self.items[i];if(!spineItem.page_spread){var spread=isFirstPageInSpread?baseSide:ReadiumSDK.Models.SpineItem.alternateSpread(baseSide);spineItem.setSpread(spread)}isFirstPageInSpread=!spineItem.isRenditionSpreadAllowed()||spineItem.page_spread!=baseSide}}var self=this;this.items=[],this.direction="ltr",this.package=epubPackage;var _handleLinear=!1;if(this.handleLinear=function(handleLinear){_handleLinear=handleLinear},this.isValidLinearItem=function(index){return isValidLinearItem(this.item(index))},this.prevItem=function(item){return lookForPrevValidItem(item.index-1)},this.nextItem=function(item){return lookForNextValidItem(item.index+1)},this.getItemUrl=function(item){return self.package.resolveRelativeUrl(item.href)},this.first=function(){return lookForNextValidItem(0)},this.last=function(){return lookForPrevValidItem(this.items.length-1)},this.isFirstItem=function(item){return self.first()===item},this.isLastItem=function(item){return self.last()===item},this.item=function(index){return isValidIndex(index)?self.items[index]:void 0},this.isRightToLeft=function(){return"rtl"==self.direction},this.isLeftToRight=function(){return!self.isRightToLeft()},this.getItemById=function(idref){for(var length=self.items.length,i=0;length>i;i++)if(self.items[i].idref==idref)return self.items[i];return void 0},this.getItemByHref=function(href){for(var length=self.items.length,i=0;length>i;i++)if(self.items[i].href==href)return self.items[i];return void 0},spineDTO){spineDTO.direction&&(this.direction=spineDTO.direction);for(var length=spineDTO.items.length,i=0;length>i;i++){var item=new ReadiumSDK.Models.SpineItem(spineDTO.items[i],i,this);this.items.push(item)}updateSpineItemsSpread()}},define("spine",["readiumSDK","spineItem"],function(global){return function(){var ret;return ret||global.spine}}(this)),ReadiumSDK.Models.Smil.SmilNode=function(parent){this.parent=parent,this.id="",this.getSmil=function(){for(var node=this;node.parent;)node=node.parent;return node},this.hasAncestor=function(node){for(var parent=this.parent;parent;){if(parent==node)return!0;parent=parent.parent}return!1}},ReadiumSDK.Models.Smil.TimeContainerNode=function(parent){this.parent=parent,this.children=void 0,this.index=void 0,this.epubtype="",this.isEscapable=function(userEscapables){if(""===this.epubtype)return!1;
var smilModel=this.getSmil();if(!smilModel.mo)return!1;var arr=smilModel.mo.escapables;userEscapables.length>0&&(arr=userEscapables);for(var i=0;i<arr.length;i++)if(this.epubtype.indexOf(arr[i])>=0)return!0;return!1},this.isSkippable=function(userSkippables){if(""===this.epubtype)return!1;var smilModel=this.getSmil();if(!smilModel.mo)return!1;var arr=smilModel.mo.skippables;userSkippables.length>0&&(arr=userSkippables);for(var i=0;i<arr.length;i++)if(this.epubtype.indexOf(arr[i])>=0)return!0;return!1}},ReadiumSDK.Models.Smil.TimeContainerNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.MediaNode=function(parent){this.parent=parent,this.src=""},ReadiumSDK.Models.Smil.MediaNode.prototype=new ReadiumSDK.Models.Smil.SmilNode,ReadiumSDK.Models.Smil.SeqNode=function(parent){this.parent=parent,this.children=[],this.nodeType="seq",this.textref="",this.durationMilliseconds=function(){for(var smilData=this.getSmil(),total=0,i=0;i<this.children.length;i++){var container=this.children[i];if("par"===container.nodeType){if(!container.audio)continue;if(container.text&&(!container.text.manifestItemId||container.text.manifestItemId!=smilData.spineItemId))continue;var clipDur=container.audio.clipDurationMilliseconds();total+=clipDur}else"seq"===container.nodeType&&(total+=container.durationMilliseconds())}return total},this.clipOffset=function(offset,par){for(var smilData=this.getSmil(),i=0;i<this.children.length;i++){var container=this.children[i];if("par"===container.nodeType){if(container==par)return!0;if(!container.audio)continue;if(container.text&&(!container.text.manifestItemId||container.text.manifestItemId!=smilData.spineItemId))continue;var clipDur=container.audio.clipDurationMilliseconds();offset.offset+=clipDur}else if("seq"===container.nodeType){var found=container.clipOffset(offset,par);if(found)return!0}}return!1},this.parallelAt=function(timeMilliseconds){for(var smilData=this.getSmil(),offset=0,i=0;i<this.children.length;i++){var timeAdjusted=timeMilliseconds-offset,container=this.children[i];if("par"===container.nodeType){if(!container.audio)continue;if(container.text&&(!container.text.manifestItemId||container.text.manifestItemId!=smilData.spineItemId))continue;var clipDur=container.audio.clipDurationMilliseconds();if(clipDur>0&&clipDur>=timeAdjusted)return container;offset+=clipDur}else if("seq"===container.nodeType){var para=container.parallelAt(timeAdjusted);if(para)return para;offset+=container.durationMilliseconds()}}return void 0},this.nthParallel=function(index,count){for(var i=0;i<this.children.length;i++){var container=this.children[i];if("par"===container.nodeType){if(count.count++,count.count==index)return container}else if("seq"===container.nodeType){var para=container.nthParallel(index,count);if(para)return para}}return void 0}},ReadiumSDK.Models.Smil.SeqNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.ParNode=function(parent){this.parent=parent,this.children=[],this.nodeType="par",this.text=void 0,this.audio=void 0,this.element=void 0,this.getFirstSeqAncestorWithEpubType=function(epubtype,includeSelf){if(!epubtype)return void 0;for(var parent=includeSelf?this:this.parent;parent;){if(parent.epubtype&&parent.epubtype.indexOf(epubtype)>=0)return parent;parent=parent.parent}return void 0}},ReadiumSDK.Models.Smil.ParNode.prototype=new ReadiumSDK.Models.Smil.TimeContainerNode,ReadiumSDK.Models.Smil.TextNode=function(parent){this.parent=parent,this.nodeType="text",this.srcFile="",this.srcFragmentId="",this.manifestItemId=void 0,this.updateMediaManifestItemId=function(){var smilData=this.getSmil();if(smilData.href&&smilData.href.length){for(var src=this.srcFile?this.srcFile:this.src,ref=ReadiumSDK.Helpers.ResolveContentRef(src,smilData.href),full=smilData.mo.package.resolveRelativeUrlMO(ref),j=0;j<smilData.mo.package.spine.items.length;j++){var item=smilData.mo.package.spine.items[j],url=smilData.mo.package.resolveRelativeUrl(item.href);if(url===full)return void(this.manifestItemId=item.idref)}console.error("Cannot set the Media ManifestItemId? "+this.src+" && "+smilData.href)}}},ReadiumSDK.Models.Smil.TextNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.Smil.AudioNode=function(parent){this.parent=parent,this.nodeType="audio",this.clipBegin=0,this.MAX=1234567890.1,this.clipEnd=this.MAX,this.clipDurationMilliseconds=function(){var _clipBeginMilliseconds=1e3*this.clipBegin,_clipEndMilliseconds=1e3*this.clipEnd;return this.clipEnd>=this.MAX||_clipBeginMilliseconds>=_clipEndMilliseconds?0:_clipEndMilliseconds-_clipBeginMilliseconds}},ReadiumSDK.Models.Smil.AudioNode.prototype=new ReadiumSDK.Models.Smil.MediaNode,ReadiumSDK.Models.SmilModel=function(){this.parent=void 0,this.children=[],this.id=void 0,this.href=void 0,this.duration=void 0,this.mo=void 0,this.parallelAt=function(timeMilliseconds){return this.children[0].parallelAt(timeMilliseconds)},this.nthParallel=function(index){var count={count:-1};return this.children[0].nthParallel(index,count)},this.clipOffset=function(par){var offset={offset:0};return this.children[0].clipOffset(offset,par)?offset.offset:0},this.durationMilliseconds_Calculated=function(){return this.children[0].durationMilliseconds()};var _epubtypeSyncs=[];this.hasSync=function(epubtype){for(var i=0;i<_epubtypeSyncs.length;i++)if(_epubtypeSyncs[i]===epubtype)return!0;return!1},this.addSync=function(epubtypes){if(epubtypes)for(var parts=epubtypes.split(" "),i=0;i<parts.length;i++){var epubtype=parts[i].trim();epubtype.length>0&&!this.hasSync(epubtype)&&_epubtypeSyncs.push(epubtype)}}},ReadiumSDK.Models.SmilModel.fromSmilDTO=function(smilDTO,mo){mo.DEBUG&&console.debug("Media Overlay DTO import...");var indent=0,getIndent=function(){for(var str="",i=0;indent>i;i++)str+="   ";return str},smilModel=new ReadiumSDK.Models.SmilModel;smilModel.id=smilDTO.id,smilModel.spineItemId=smilDTO.spineItemId,smilModel.href=smilDTO.href,smilModel.smilVersion=smilDTO.smilVersion,smilModel.duration=smilDTO.duration,smilModel.duration&&smilModel.duration.length&&smilModel.duration.length>0&&(console.error("SMIL duration is string, parsing float... ("+smilModel.duration+")"),smilModel.duration=parseFloat(smilModel.duration)),smilModel.mo=mo,smilModel.mo.DEBUG&&(console.log("JS MO smilVersion="+smilModel.smilVersion),console.log("JS MO id="+smilModel.id),console.log("JS MO spineItemId="+smilModel.spineItemId),console.log("JS MO href="+smilModel.href),console.log("JS MO duration="+smilModel.duration));var safeCopyProperty=function(property,from,to,isRequired){property in from?(property in to||console.debug("property "+property+" not declared in smil node "+to.nodeType),to[property]=from[property],smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO: ["+property+"="+to[property]+"]")):isRequired&&console.log("Required property "+property+" not found in smil node "+from.nodeType)},createNodeFromDTO=function(nodeDTO,parent){var node;if("seq"==nodeDTO.nodeType)smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO seq"),node=new ReadiumSDK.Models.Smil.SeqNode(parent),safeCopyProperty("textref",nodeDTO,node,parent&&parent.parent?!0:!1),safeCopyProperty("id",nodeDTO,node),safeCopyProperty("epubtype",nodeDTO,node),node.epubtype&&node.getSmil().addSync(node.epubtype),indent++,copyChildren(nodeDTO,node),indent--;else if("par"==nodeDTO.nodeType){smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO par"),node=new ReadiumSDK.Models.Smil.ParNode(parent),safeCopyProperty("id",nodeDTO,node),safeCopyProperty("epubtype",nodeDTO,node),node.epubtype&&node.getSmil().addSync(node.epubtype),indent++,copyChildren(nodeDTO,node),indent--;for(var i=0,count=node.children.length;count>i;i++){var child=node.children[i];"text"==child.nodeType?node.text=child:"audio"==child.nodeType?node.audio=child:console.error("Unexpected smil node type: "+child.nodeType)}var forceTTS=!1;if(forceTTS||!node.audio){var fakeAudio=new ReadiumSDK.Models.Smil.AudioNode(node);fakeAudio.clipBegin=0,fakeAudio.clipEnd=fakeAudio.MAX,fakeAudio.src=void 0,node.audio=fakeAudio}}else if("text"==nodeDTO.nodeType)smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO text"),node=new ReadiumSDK.Models.Smil.TextNode(parent),safeCopyProperty("src",nodeDTO,node,!0),safeCopyProperty("srcFile",nodeDTO,node,!0),safeCopyProperty("srcFragmentId",nodeDTO,node,!1),safeCopyProperty("id",nodeDTO,node),node.updateMediaManifestItemId();else{if("audio"!=nodeDTO.nodeType)return void console.error("Unexpected smil node type: "+nodeDTO.nodeType);smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO audio"),node=new ReadiumSDK.Models.Smil.AudioNode(parent),safeCopyProperty("src",nodeDTO,node,!0),safeCopyProperty("id",nodeDTO,node),safeCopyProperty("clipBegin",nodeDTO,node),node.clipBegin&&node.clipBegin.length&&node.clipBegin.length>0&&(console.error("SMIL clipBegin is string, parsing float... ("+node.clipBegin+")"),node.clipBegin=parseFloat(node.clipBegin)),node.clipBegin<0&&(smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO clipBegin adjusted to ZERO"),node.clipBegin=0),safeCopyProperty("clipEnd",nodeDTO,node),node.clipEnd&&node.clipEnd.length&&node.clipEnd.length>0&&(console.error("SMIL clipEnd is string, parsing float... ("+node.clipEnd+")"),node.clipEnd=parseFloat(node.clipEnd)),node.clipEnd<=node.clipBegin&&(smilModel.mo.DEBUG&&console.log(getIndent()+"JS MO clipEnd adjusted to MAX"),node.clipEnd=node.MAX)}return node},copyChildren=function(from,to){for(var count=from.children.length,i=0;count>i;i++){var node=createNodeFromDTO(from.children[i],to);node.index=i,to.children.push(node)}};return copyChildren(smilDTO,smilModel),smilModel},define("smilModel",["readiumSDK"],function(global){return function(){var ret;return ret||global.smilModel}}(this)),ReadiumSDK.Models.MediaOverlay=function(package){this.package=package,this.parallelAt=function(timeMilliseconds){for(var offset=0,i=0;i<this.smil_models.length;i++){var smilData=this.smil_models[i],timeAdjusted=timeMilliseconds-offset,para=smilData.parallelAt(timeAdjusted);if(para)return para;offset+=smilData.durationMilliseconds_Calculated()}return void 0},this.percentToPosition=function(percent,smilData,par,milliseconds){(0>percent||percent>100)&&(percent=0);var total=this.durationMilliseconds_Calculated(),timeMs=total*(percent/100);if(par.par=this.parallelAt(timeMs),par.par){var smilDataPar=par.par.getSmil();if(smilDataPar){for(var smilDataOffset=0,i=0;i<this.smil_models.length&&(smilData.smilData=this.smil_models[i],smilData.smilData!=smilDataPar);i++)smilDataOffset+=smilData.smilData.durationMilliseconds_Calculated();milliseconds.milliseconds=timeMs-(smilDataOffset+smilData.smilData.clipOffset(par.par))}}},this.durationMilliseconds_Calculated=function(){for(var total=0,i=0;i<this.smil_models.length;i++){var smilData=this.smil_models[i];total+=smilData.durationMilliseconds_Calculated()}return total},this.smilAt=function(smilIndex){return 0>smilIndex||smilIndex>=this.smil_models.length?void 0:this.smil_models[smilIndex]},this.positionToPercent=function(smilIndex,parIndex,milliseconds){if(smilIndex>=this.smil_models.length)return-1;for(var smilDataOffset=0,i=0;smilIndex>i;i++){var sd=this.smil_models[i];smilDataOffset+=sd.durationMilliseconds_Calculated()}var smilData=this.smil_models[smilIndex],par=smilData.nthParallel(parIndex);if(!par)return-1;var offset=smilDataOffset+smilData.clipOffset(par)+milliseconds,total=this.durationMilliseconds_Calculated(),percent=offset/total*100;return percent},this.smil_models=[],this.skippables=[],this.escapables=[],this.duration=void 0,this.narrator=void 0,this.activeClass=void 0,this.playbackActiveClass=void 0,this.DEBUG=!1,this.getSmilBySpineItem=function(spineItem){if(!spineItem)return void 0;for(var i=0,count=this.smil_models.length;count>i;i++){var smil=this.smil_models[i];if(smil.spineItemId===spineItem.idref)return spineItem.media_overlay_id!==smil.id&&console.error("SMIL INCORRECT ID?? "+spineItem.media_overlay_id+" /// "+smil.id),smil}return void 0},this.getNextSmil=function(smil){var index=this.smil_models.indexOf(smil);return-1==index||index==this.smil_models.length-1?void 0:this.smil_models[index+1]},this.getPreviousSmil=function(smil){var index=this.smil_models.indexOf(smil);return-1==index||0==index?void 0:this.smil_models[index-1]}},ReadiumSDK.Models.MediaOverlay.fromDTO=function(moDTO,package){var mo=new ReadiumSDK.Models.MediaOverlay(package);if(!moDTO)return console.debug("No Media Overlay."),mo;console.debug("Media Overlay INIT..."),mo.duration=moDTO.duration,mo.duration&&mo.duration.length&&mo.duration.length>0&&(console.error("SMIL total duration is string, parsing float... ("+mo.duration+")"),mo.duration=parseFloat(mo.duration)),mo.DEBUG&&console.debug("Media Overlay Duration (TOTAL): "+mo.duration),mo.narrator=moDTO.narrator,mo.DEBUG&&console.debug("Media Overlay Narrator: "+mo.narrator),mo.activeClass=moDTO.activeClass,mo.DEBUG&&console.debug("Media Overlay Active-Class: "+mo.activeClass),mo.playbackActiveClass=moDTO.playbackActiveClass,mo.DEBUG&&console.debug("Media Overlay Playback-Active-Class: "+mo.playbackActiveClass);var count=moDTO.smil_models.length;mo.DEBUG&&console.debug("Media Overlay SMIL count: "+count);for(var i=0;count>i;i++){var smilModel=ReadiumSDK.Models.SmilModel.fromSmilDTO(moDTO.smil_models[i],mo);mo.smil_models.push(smilModel),mo.DEBUG&&console.debug("Media Overlay Duration (SPINE ITEM): "+smilModel.duration)}count=moDTO.skippables.length,mo.DEBUG&&console.debug("Media Overlay SKIPPABLES count: "+count);for(var i=0;count>i;i++)mo.skippables.push(moDTO.skippables[i]);count=moDTO.escapables.length,mo.DEBUG&&console.debug("Media Overlay ESCAPABLES count: "+count);for(var i=0;count>i;i++)mo.escapables.push(moDTO.escapables[i]);return mo},define("mediaOverlay",["readiumSDK","smilModel"],function(global){return function(){var ret;return ret||global.mediaOverlay}}(this)),ReadiumSDK.Models.Package=function(packageData){var self=this;this.spine=void 0,this.rootUrl=void 0,this.rootUrlMO=void 0,this.media_overlay=void 0,this.rendition_viewport=void 0,this.rendition_flow=void 0,this.rendition_layout=void 0,this.rendition_spread=void 0,this.rendition_orientation=void 0,this.resolveRelativeUrlMO=function(relativeUrl){return self.rootUrlMO&&self.rootUrlMO.length>0?ReadiumSDK.Helpers.EndsWith(self.rootUrlMO,"/")?self.rootUrlMO+relativeUrl:self.rootUrlMO+"/"+relativeUrl:self.resolveRelativeUrl(relativeUrl)},this.resolveRelativeUrl=function(relativeUrl){return self.rootUrl?ReadiumSDK.Helpers.EndsWith(self.rootUrl,"/")?self.rootUrl+relativeUrl:self.rootUrl+"/"+relativeUrl:relativeUrl},this.isFixedLayout=function(){return self.rendition_layout===ReadiumSDK.Models.SpineItem.RENDITION_LAYOUT_PREPAGINATED},this.isReflowable=function(){return!self.isFixedLayout()},packageData&&(this.rootUrl=packageData.rootUrl,this.rootUrlMO=packageData.rootUrlMO,this.rendition_viewport=packageData.rendition_viewport,this.rendition_layout=packageData.rendition_layout,this.rendition_flow=packageData.rendition_flow,this.rendition_orientation=packageData.rendition_orientation,this.rendition_spread=packageData.rendition_spread,this.spine=new ReadiumSDK.Models.Spine(this,packageData.spine),this.media_overlay=ReadiumSDK.Models.MediaOverlay.fromDTO(packageData.media_overlay,this))},define("package",["readiumSDK","spine","mediaOverlay"],function(global){return function(){var ret;return ret||global.package}}(this)),function(){var _iOS=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?!0:!1,_Android=navigator.userAgent.toLowerCase().indexOf("android")>-1,DEBUG=!1,_audioElement=new Audio;DEBUG&&(_audioElement.addEventListener("load",function(){console.debug("0) load")}),_audioElement.addEventListener("loadstart",function(){console.debug("1) loadstart")}),_audioElement.addEventListener("durationchange",function(){console.debug("2) durationchange")}),_audioElement.addEventListener("loadedmetadata",function(){console.debug("3) loadedmetadata")}),_audioElement.addEventListener("loadeddata",function(){console.debug("4) loadeddata")}),_audioElement.addEventListener("progress",function(){console.debug("5) progress")}),_audioElement.addEventListener("canplay",function(){console.debug("6) canplay")}),_audioElement.addEventListener("canplaythrough",function(){console.debug("7) canplaythrough")}),_audioElement.addEventListener("play",function(){console.debug("8) play")}),_audioElement.addEventListener("pause",function(){console.debug("9) pause")}),_audioElement.addEventListener("ended",function(){console.debug("10) ended")}),_audioElement.addEventListener("seeked",function(){console.debug("X) seeked")}),_audioElement.addEventListener("timeupdate",function(){console.debug("Y) timeupdate")})),ReadiumSDK.Views.AudioPlayer=function(onStatusChanged,onPositionChanged,onAudioEnded,onAudioPlay,onAudioPause){function onPlay(){onStatusChanged({isPlaying:!0}),onAudioPlay()}function onPause(){onAudioPause(),onStatusChanged({isPlaying:!1})}function onEnded(){return _audioElement.moSeeking?void(DEBUG&&console.debug("onEnded() skipped (still seeking...)")):(stopTimer(),onAudioEnded(),void onStatusChanged({isPlaying:!1}))}function startTimer(){_intervalTimer||(_intervalTimer=setInterval(function(){if(_audioElement.moSeeking)return DEBUG&&console.debug("interval timer skipped (still seeking...)"),_intervalTimerSkips++,void(_intervalTimerSkips>1e3&&(_intervalTimerSkips=0,stopTimer()));var currentTime=_audioElement.currentTime;onPositionChanged(currentTime,1)},20))}function stopTimer(){_intervalTimer&&clearInterval(_intervalTimer),_intervalTimer=void 0}function onReadyToSeek(event){$(_audioElement).off(_readyEvent,onReadyToSeek),DEBUG&&console.debug("onReadyToSeek #"+event.data.playId),playSeekCurrentTime(event.data.seekBegin,event.data.playId,!0)}function playSeekCurrentTime(newCurrentTime,playId,isNewSrc){if(DEBUG&&console.debug("playSeekCurrentTime() #"+playId),0==newCurrentTime&&(newCurrentTime=.01),Math.abs(newCurrentTime-_audioElement.currentTime)<.3)return DEBUG&&console.debug("playSeekCurrentTime() CONTINUE"),_audioElement.moSeeking=void 0,void self.play();var ev=isNewSrc?_seekedEvent1:_seekedEvent2;DEBUG&&console.debug("playSeekCurrentTime() NEED SEEK, EV: "+ev),self.pause(),$(_audioElement).on(ev,{newCurrentTime:newCurrentTime,playId:playId,isNewSrc:isNewSrc},onSeeked);try{_audioElement.currentTime=newCurrentTime}catch(ex){console.error(ex.message),setTimeout(function(){try{_audioElement.currentTime=newCurrentTime}catch(ex){console.error(ex.message)}},5)}}function onSeeked(event){var ev=event.data.isNewSrc?_seekedEvent1:_seekedEvent2,notRetry=void 0==event.data.seekRetries;(notRetry||event.data.seekRetries==MAX_SEEK_RETRIES)&&$(_audioElement).off(ev,onSeeked),DEBUG&&console.debug("onSeeked() #"+event.data.playId+" FIRST? "+notRetry+" EV: "+ev);var curTime=_audioElement.currentTime,diff=Math.abs(event.data.newCurrentTime-curTime);if((notRetry||event.data.seekRetries>=0)&&diff>=1)DEBUG&&console.debug("onSeeked() time diff: "+event.data.newCurrentTime+" vs. "+curTime+" ("+diff+")"),notRetry&&(event.data.seekRetries=MAX_SEEK_RETRIES,event.data.isNewSrc=!1),event.data.seekRetries--,DEBUG&&console.debug("onSeeked() FAIL => retry again (timeout)"),setTimeout(function(){onSeeked(event)},50),setTimeout(function(){try{_audioElement.pause(),setTimeout(function(){_audioElement.currentTime=event.data.newCurrentTime},0)}catch(ex){console.error(ex.message),setTimeout(function(){try{_audioElement.pause(),setTimeout(function(){_audioElement.currentTime=event.data.newCurrentTime},0)}catch(ex){console.error(ex.message)}},4)}},5);else{if(DEBUG&&(console.debug("onSeeked() STATE:"),console.debug(notRetry),console.debug(event.data.seekRetries),console.debug(diff)),diff>=1){DEBUG&&console.debug("onSeeked() ABORT, TRY AGAIN FROM SCRATCH!");var smilSrc=_currentSmilSrc,epubSrc=_currentEpubSrc,seekBegin=event.data.newCurrentTime;return self.reset(),void setTimeout(function(){self.playFile(smilSrc,epubSrc,seekBegin)},10)}DEBUG&&console.debug("onSeeked() OKAY => play!"),event.data.seekRetries=void 0,self.play(),_audioElement.moSeeking=void 0}}var self=this,_currentEpubSrc=void 0,_currentSmilSrc=void 0;this.currentSmilSrc=function(){return _currentSmilSrc};var _rate=1;this.setRate=function(rate){_rate=rate,.5>_rate&&(_rate=.5),_rate>4&&(_rate=4),_audioElement.playbackRate=_rate},self.setRate(_rate),this.getRate=function(){return _rate};var _volume=100;this.setVolume=function(volume){_volume=volume,0>_volume&&(_volume=0),_volume>1&&(_volume=1),_audioElement.volume=_volume},self.setVolume(_volume),this.getVolume=function(){return _volume},this.play=function(){return DEBUG&&console.error("this.play()"),_currentEpubSrc?(startTimer(),self.setVolume(_volume),self.setRate(_rate),_audioElement.play(),!0):!1},this.pause=function(){DEBUG&&console.error("this.pause()"),stopTimer(),_audioElement.pause()},_audioElement.addEventListener("play",onPlay,!1),_audioElement.addEventListener("pause",onPause,!1),_audioElement.addEventListener("ended",onEnded,!1);var _intervalTimerSkips=0,_intervalTimer=void 0;this.isPlaying=function(){return void 0!==_intervalTimer},this.reset=function(){DEBUG&&console.error("this.reset()"),this.pause(),_audioElement.moSeeking=void 0,_currentSmilSrc=void 0,_currentEpubSrc=void 0,setTimeout(function(){_audioElement.setAttribute("src","")},1)},_audioElement.addEventListener("loadstart",function(){_touchInited=!0});var _touchInited=!1;this.touchInit=function(){return _iOS?_touchInited?!1:(_touchInited=!0,_audioElement.setAttribute("src","touch/init/html5/audio.mp3"),_audioElement.load(),!0):!1};var _playId=0,_seekQueuing=0;this.playFile=function(smilSrc,epubSrc,seekBegin){_playId++,_playId>99999&&(_playId=0);var playId=_playId;if(_audioElement.moSeeking)return _seekQueuing++,_seekQueuing>MAX_SEEK_RETRIES?void(_seekQueuing=0):(DEBUG&&console.debug("this.playFile("+epubSrc+") @"+seekBegin+" (POSTPONE, SEEKING...)"),void setTimeout(function(){self.playFile(smilSrc,epubSrc,seekBegin)},20));_audioElement.moSeeking={},DEBUG&&console.debug("this.playFile("+epubSrc+") @"+seekBegin+" #"+playId);var audioNeedsNewSrc=!_currentEpubSrc||_currentEpubSrc!==epubSrc;return audioNeedsNewSrc?(DEBUG&&(console.debug("this.playFile() NEW SRC"),console.debug("_currentEpubSrc: "+_currentEpubSrc),console.debug("epubSrc: "+epubSrc)),this.reset(),_audioElement.moSeeking={},_currentSmilSrc=smilSrc,_currentEpubSrc=epubSrc,_Android||_audioElement.addEventListener("play",onPlayToForcePreload,!1),$(_audioElement).on(_readyEvent,{seekBegin:seekBegin,playId:playId},onReadyToSeek),void setTimeout(function(){_audioElement.setAttribute("src",_currentEpubSrc),_audioElement.load(),_Android||playToForcePreload()},1)):(DEBUG&&console.debug("this.playFile() SAME SRC"),this.pause(),_currentSmilSrc=smilSrc,_currentEpubSrc=epubSrc,void playSeekCurrentTime(seekBegin,playId,!1))};var playToForcePreload=function(){DEBUG&&console.debug("playToForcePreload");var vol=_volume;_volume=0,self.play(),_volume=vol},onPlayToForcePreload=function(){_audioElement.removeEventListener("play",onPlayToForcePreload,!1),DEBUG&&console.debug("onPlayToForcePreload"),_audioElement.pause()},_readyEvent=_Android?"canplaythrough":"canplay",MAX_SEEK_RETRIES=10,_seekedEvent1=_iOS?"canplaythrough":"seeked",_seekedEvent2=_iOS?"timeupdate":"seeked"}}(),define("audioPlayer",["readiumSDK"],function(global){return function(){var ret;return ret||global.audioPlayer}}(this)),define("domReady",[],function(){function runCallbacks(callbacks){var i;for(i=0;i<callbacks.length;i+=1)callbacks[i](doc)}function callReady(){var callbacks=readyCalls;isPageLoaded&&callbacks.length&&(readyCalls=[],runCallbacks(callbacks))}function pageLoaded(){isPageLoaded||(isPageLoaded=!0,scrollIntervalId&&clearInterval(scrollIntervalId),callReady())}function domReady(callback){return isPageLoaded?callback(doc):readyCalls.push(callback),domReady}var isTop,testDiv,scrollIntervalId,isBrowser="undefined"!=typeof window&&window.document,isPageLoaded=!isBrowser,doc=isBrowser?document:null,readyCalls=[];if(isBrowser){if(document.addEventListener)document.addEventListener("DOMContentLoaded",pageLoaded,!1),window.addEventListener("load",pageLoaded,!1);else if(window.attachEvent){window.attachEvent("onload",pageLoaded),testDiv=document.createElement("div");try{isTop=null===window.frameElement}catch(e){}testDiv.doScroll&&isTop&&window.external&&(scrollIntervalId=setInterval(function(){try{testDiv.doScroll(),pageLoaded()}catch(e){}},30))}"complete"===document.readyState&&pageLoaded()}return domReady.version="2.0.1",domReady.load=function(name,req,onLoad,config){config.isBuild?onLoad(null):domReady(onLoad)},domReady}),function(global){function isHostMethod(o,p){var t=typeof o[p];return t==FUNCTION||!(t!=OBJECT||!o[p])||"unknown"==t}function isHostObject(o,p){return!(typeof o[p]!=OBJECT||!o[p])}function isHostProperty(o,p){return typeof o[p]!=UNDEFINED}function createMultiplePropertyTest(testFunc){return function(o,props){for(var i=props.length;i--;)if(!testFunc(o,props[i]))return!1;return!0}}function isTextRange(range){return range&&areHostMethods(range,textRangeMethods)&&areHostProperties(range,textRangeProperties)}function getBody(doc){return isHostObject(doc,"body")?doc.body:doc.getElementsByTagName("body")[0]}function consoleLog(msg){isHostObject(window,"console")&&isHostMethod(window.console,"log")&&window.console.log(msg)}function alertOrLog(msg,shouldAlert){shouldAlert?window.alert(msg):consoleLog(msg)}function fail(reason){api.initialized=!0,api.supported=!1,alertOrLog("Rangy is not supported on this page in your browser. Reason: "+reason,api.config.alertOnFail)}function warn(msg){alertOrLog("Rangy warning: "+msg,api.config.alertOnWarn)}function getErrorDesc(ex){return ex.message||ex.description||String(ex)}function init(){if(!api.initialized){var testRange,implementsDomRange=!1,implementsTextRange=!1;isHostMethod(document,"createRange")&&(testRange=document.createRange(),areHostMethods(testRange,domRangeMethods)&&areHostProperties(testRange,domRangeProperties)&&(implementsDomRange=!0),testRange.detach());var body=getBody(document);if(!body||"body"!=body.nodeName.toLowerCase())return void fail("No body element found");if(body&&isHostMethod(body,"createTextRange")&&(testRange=body.createTextRange(),isTextRange(testRange)&&(implementsTextRange=!0)),!implementsDomRange&&!implementsTextRange)return void fail("Neither Range nor TextRange are available");api.initialized=!0,api.features={implementsDomRange:implementsDomRange,implementsTextRange:implementsTextRange};var module,errorMessage;for(var moduleName in modules)(module=modules[moduleName])instanceof Module&&module.init(module,api);for(var i=0,len=initListeners.length;len>i;++i)try{initListeners[i](api)}catch(ex){errorMessage="Rangy init listener threw an exception. Continuing. Detail: "+getErrorDesc(ex),consoleLog(errorMessage)}}}function createMissingNativeApi(win){win=win||window,init();for(var i=0,len=createMissingNativeApiListeners.length;len>i;++i)createMissingNativeApiListeners[i](win)}function Module(name,dependencies,initializer){this.name=name,this.dependencies=dependencies,this.initialized=!1,this.supported=!1,this.initializer=initializer}function createModule(isCore,name,dependencies,initFunc){var newModule=new Module(name,dependencies,function(module){if(!module.initialized){module.initialized=!0;try{initFunc(api,module),module.supported=!0}catch(ex){var errorMessage="Module '"+name+"' failed to load: "+getErrorDesc(ex);consoleLog(errorMessage)}}});modules[name]=newModule}function RangePrototype(){}function SelectionPrototype(){}var OBJECT=("function"==typeof global.define&&global.define.amd,"object"),FUNCTION="function",UNDEFINED="undefined",domRangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],domRangeMethods=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],textRangeProperties=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],textRangeMethods=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],areHostMethods=createMultiplePropertyTest(isHostMethod),areHostObjects=createMultiplePropertyTest(isHostObject),areHostProperties=createMultiplePropertyTest(isHostProperty),modules={},api={version:"1.3alpha.804",initialized:!1,supported:!0,util:{isHostMethod:isHostMethod,isHostObject:isHostObject,isHostProperty:isHostProperty,areHostMethods:areHostMethods,areHostObjects:areHostObjects,areHostProperties:areHostProperties,isTextRange:isTextRange,getBody:getBody},features:{},modules:modules,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};api.fail=fail,api.warn=warn,{}.hasOwnProperty?api.util.extend=function(obj,props,deep){var o,p;for(var i in props)props.hasOwnProperty(i)&&(o=obj[i],p=props[i],deep&&null!==o&&"object"==typeof o&&null!==p&&"object"==typeof p&&api.util.extend(o,p,!0),obj[i]=p);return obj}:fail("hasOwnProperty not supported"),function(){var el=document.createElementNS("http://www.w3.org/1999/xhtml","div");el.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","span"));var toArray,slice=[].slice;try{1==slice.call(el.childNodes,0)[0].nodeType&&(toArray=function(arrayLike){return slice.call(arrayLike,0)})}catch(e){}toArray||(toArray=function(arrayLike){for(var arr=[],i=0,len=arrayLike.length;len>i;++i)arr[i]=arrayLike[i];return arr}),api.util.toArray=toArray}();var addListener;isHostMethod(document,"addEventListener")?addListener=function(obj,eventType,listener){obj.addEventListener(eventType,listener,!1)}:isHostMethod(document,"attachEvent")?addListener=function(obj,eventType,listener){obj.attachEvent("on"+eventType,listener)}:fail("Document does not have required addEventListener or attachEvent method"),api.util.addListener=addListener;var initListeners=[];api.init=init,api.addInitListener=function(listener){api.initialized?listener(api):initListeners.push(listener)};var createMissingNativeApiListeners=[];api.addCreateMissingNativeApiListener=function(listener){createMissingNativeApiListeners.push(listener)},api.createMissingNativeApi=createMissingNativeApi,Module.prototype={init:function(){for(var requiredModule,moduleName,requiredModuleNames=this.dependencies||[],i=0,len=requiredModuleNames.length;len>i;++i){if(moduleName=requiredModuleNames[i],requiredModule=modules[moduleName],!(requiredModule&&requiredModule instanceof Module))throw new Error("required module '"+moduleName+"' not found");if(requiredModule.init(),!requiredModule.supported)throw new Error("required module '"+moduleName+"' not supported")}this.initializer(this)},fail:function(reason){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+reason)},warn:function(msg){api.warn("Module "+this.name+": "+msg)},deprecationNotice:function(deprecated,replacement){api.warn("DEPRECATED: "+deprecated+" in module "+this.name+"is deprecated. Please use "+replacement+" instead")},createError:function(msg){return new Error("Error in Rangy "+this.name+" module: "+msg)}},api.createModule=function(name){var initFunc,dependencies;2==arguments.length?(initFunc=arguments[1],dependencies=[]):(initFunc=arguments[2],dependencies=arguments[1]),createModule(!1,name,dependencies,initFunc)},api.createCoreModule=function(name,dependencies,initFunc){createModule(!0,name,dependencies,initFunc)},api.RangePrototype=RangePrototype,api.rangePrototype=new RangePrototype,api.selectionPrototype=new SelectionPrototype;var docReady=!1,loadHandler=function(){docReady||(docReady=!0,api.initialized||init())};return typeof window==UNDEFINED?void fail("No window found"):typeof document==UNDEFINED?void fail("No document found"):(isHostMethod(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",loadHandler,!1),addListener(window,"load",loadHandler),void(global.rangy=api))
}(this),rangy.createCoreModule("DomUtil",[],function(api,module){function isHtmlNamespace(node){var ns;return typeof node.namespaceURI==UNDEF||null===(ns=node.namespaceURI)||"http://www.w3.org/1999/xhtml"==ns}function parentElement(node){var parent=node.parentNode;return 1==parent.nodeType?parent:null}function getNodeIndex(node){for(var i=0;node=node.previousSibling;)++i;return i}function getNodeLength(node){switch(node.nodeType){case 7:case 10:return 0;case 3:case 8:return node.length;default:return node.childNodes.length}}function getCommonAncestor(node1,node2){var n,ancestors=[];for(n=node1;n;n=n.parentNode)ancestors.push(n);for(n=node2;n;n=n.parentNode)if(arrayContains(ancestors,n))return n;return null}function isAncestorOf(ancestor,descendant,selfIsAncestor){for(var n=selfIsAncestor?descendant:descendant.parentNode;n;){if(n===ancestor)return!0;n=n.parentNode}return!1}function isOrIsAncestorOf(ancestor,descendant){return isAncestorOf(ancestor,descendant,!0)}function getClosestAncestorIn(node,ancestor,selfIsAncestor){for(var p,n=selfIsAncestor?node:node.parentNode;n;){if(p=n.parentNode,p===ancestor)return n;n=p}return null}function isCharacterDataNode(node){var t=node.nodeType;return 3==t||4==t||8==t}function isTextOrCommentNode(node){if(!node)return!1;var t=node.nodeType;return 3==t||8==t}function insertAfter(node,precedingNode){var nextNode=precedingNode.nextSibling,parent=precedingNode.parentNode;return nextNode?parent.insertBefore(node,nextNode):parent.appendChild(node),node}function splitDataNode(node,index,positionsToPreserve){var newNode=node.cloneNode(!1);if(newNode.deleteData(0,index),node.deleteData(index,node.length-index),insertAfter(newNode,node),positionsToPreserve)for(var position,i=0;position=positionsToPreserve[i++];)position.node==node&&position.offset>index?(position.node=newNode,position.offset-=index):position.node==node.parentNode&&position.offset>getNodeIndex(node)&&++position.offset;return newNode}function getDocument(node){if(9==node.nodeType)return node;if(typeof node.ownerDocument!=UNDEF)return node.ownerDocument;if(typeof node.document!=UNDEF)return node.document;if(node.parentNode)return getDocument(node.parentNode);throw module.createError("getDocument: no document found for node")}function getWindow(node){var doc=getDocument(node);if(typeof doc.defaultView!=UNDEF)return doc.defaultView;if(typeof doc.parentWindow!=UNDEF)return doc.parentWindow;throw module.createError("Cannot get a window object for node")}function getIframeDocument(iframeEl){if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument;if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow.document;throw module.createError("getIframeDocument: No Document object found for iframe element")}function getIframeWindow(iframeEl){if(typeof iframeEl.contentWindow!=UNDEF)return iframeEl.contentWindow;if(typeof iframeEl.contentDocument!=UNDEF)return iframeEl.contentDocument.defaultView;throw module.createError("getIframeWindow: No Window object found for iframe element")}function isWindow(obj){return obj&&util.isHostMethod(obj,"setTimeout")&&util.isHostObject(obj,"document")}function getContentDocument(obj,module,methodName){var doc;if(obj?util.isHostProperty(obj,"nodeType")?doc=1==obj.nodeType&&"iframe"==obj.tagName.toLowerCase()?getIframeDocument(obj):getDocument(obj):isWindow(obj)&&(doc=obj.document):doc=document,!doc)throw module.createError(methodName+"(): Parameter must be a Window object or DOM node");return doc}function getRootContainer(node){for(var parent;parent=node.parentNode;)node=parent;return node}function comparePoints(nodeA,offsetA,nodeB,offsetB){var nodeC,root,childA,childB,n;if(nodeA==nodeB)return offsetA===offsetB?0:offsetB>offsetA?-1:1;if(nodeC=getClosestAncestorIn(nodeB,nodeA,!0))return offsetA<=getNodeIndex(nodeC)?-1:1;if(nodeC=getClosestAncestorIn(nodeA,nodeB,!0))return getNodeIndex(nodeC)<offsetB?-1:1;if(root=getCommonAncestor(nodeA,nodeB),!root)throw new Error("comparePoints error: nodes have no common ancestor");if(childA=nodeA===root?root:getClosestAncestorIn(nodeA,root,!0),childB=nodeB===root?root:getClosestAncestorIn(nodeB,root,!0),childA===childB)throw module.createError("comparePoints got to case 4 and childA and childB are the same!");for(n=root.firstChild;n;){if(n===childA)return-1;if(n===childB)return 1;n=n.nextSibling}}function isBrokenNode(node){try{return node.parentNode,!1}catch(e){return!0}}function inspectNode(node){if(!node)return"[No node]";if(crashyTextNodes&&isBrokenNode(node))return"[Broken node]";if(isCharacterDataNode(node))return'"'+node.data+'"';if(1==node.nodeType){var idAttr=node.id?' id="'+node.id+'"':"";return"<"+node.nodeName+idAttr+">["+getNodeIndex(node)+"]["+node.childNodes.length+"]["+(node.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return node.nodeName}function fragmentFromNodeChildren(node){for(var child,fragment=getDocument(node).createDocumentFragment();child=node.firstChild;)fragment.appendChild(child);return fragment}function NodeIterator(root){this.root=root,this._next=root}function createIterator(root){return new NodeIterator(root)}function DomPosition(node,offset){this.node=node,this.offset=offset}function DOMException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="DOMException: "+this.codeName}var UNDEF="undefined",util=api.util;util.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||module.fail("document missing a Node creation method"),util.isHostMethod(document,"getElementsByTagName")||module.fail("document missing getElementsByTagName method");var el=document.createElementNS("http://www.w3.org/1999/xhtml","div");util.areHostMethods(el,["insertBefore","appendChild","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"]))||module.fail("Incomplete Element implementation"),util.isHostProperty(el,"innerHTML")||module.fail("Element is missing innerHTML property");var textNode=document.createTextNode("test");util.areHostMethods(textNode,["splitText","deleteData","insertData","appendData","cloneNode"]||!util.areHostObjects(el,["previousSibling","nextSibling","childNodes","parentNode"])||!util.areHostProperties(textNode,["data"]))||module.fail("Incomplete Text Node implementation");var arrayContains=function(arr,val){for(var i=arr.length;i--;)if(arr[i]===val)return!0;return!1},crashyTextNodes=!1;!function(){var el=document.createElementNS("http://www.w3.org/1999/xhtml","b");el.innerHTML="1";var textNode=el.firstChild;el.innerHTML="<br>",crashyTextNodes=isBrokenNode(textNode),api.features.crashyTextNodes=crashyTextNodes}();var getComputedStyleProperty;typeof window.getComputedStyle!=UNDEF?getComputedStyleProperty=function(el,propName){return getWindow(el).getComputedStyle(el,null)[propName]}:typeof document.documentElement.currentStyle!=UNDEF?getComputedStyleProperty=function(el,propName){return el.currentStyle[propName]}:module.fail("No means of obtaining computed style properties found"),NodeIterator.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var child,next,n=this._current=this._next;if(this._current)if(child=n.firstChild)this._next=child;else{for(next=null;n!==this.root&&!(next=n.nextSibling);)n=n.parentNode;this._next=next}return this._current},detach:function(){this._current=this._next=this.root=null}},DomPosition.prototype={equals:function(pos){return!!pos&&this.node===pos.node&&this.offset==pos.offset},inspect:function(){return"[DomPosition("+inspectNode(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},DOMException.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},DOMException.prototype.toString=function(){return this.message},api.dom={arrayContains:arrayContains,isHtmlNamespace:isHtmlNamespace,parentElement:parentElement,getNodeIndex:getNodeIndex,getNodeLength:getNodeLength,getCommonAncestor:getCommonAncestor,isAncestorOf:isAncestorOf,isOrIsAncestorOf:isOrIsAncestorOf,getClosestAncestorIn:getClosestAncestorIn,isCharacterDataNode:isCharacterDataNode,isTextOrCommentNode:isTextOrCommentNode,insertAfter:insertAfter,splitDataNode:splitDataNode,getDocument:getDocument,getWindow:getWindow,getIframeWindow:getIframeWindow,getIframeDocument:getIframeDocument,getBody:util.getBody,isWindow:isWindow,getContentDocument:getContentDocument,getRootContainer:getRootContainer,comparePoints:comparePoints,isBrokenNode:isBrokenNode,inspectNode:inspectNode,getComputedStyleProperty:getComputedStyleProperty,fragmentFromNodeChildren:fragmentFromNodeChildren,createIterator:createIterator,DomPosition:DomPosition},api.DOMException=DOMException}),rangy.createCoreModule("DomRange",["DomUtil"],function(api){function isNonTextPartiallySelected(node,range){return 3!=node.nodeType&&(isOrIsAncestorOf(node,range.startContainer)||isOrIsAncestorOf(node,range.endContainer))}function getRangeDocument(range){return range.document||getDocument(range.startContainer)}function getBoundaryBeforeNode(node){return new DomPosition(node.parentNode,getNodeIndex(node))}function getBoundaryAfterNode(node){return new DomPosition(node.parentNode,getNodeIndex(node)+1)}function insertNodeAtPosition(node,n,o){var firstNodeInserted=11==node.nodeType?node.firstChild:node;return isCharacterDataNode(n)?o==n.length?dom.insertAfter(node,n):n.parentNode.insertBefore(node,0==o?n:splitDataNode(n,o)):o>=n.childNodes.length?n.appendChild(node):n.insertBefore(node,n.childNodes[o]),firstNodeInserted}function rangesIntersect(rangeA,rangeB,touchingIsIntersecting){if(assertRangeValid(rangeA),assertRangeValid(rangeB),getRangeDocument(rangeB)!=getRangeDocument(rangeA))throw new DOMException("WRONG_DOCUMENT_ERR");var startComparison=comparePoints(rangeA.startContainer,rangeA.startOffset,rangeB.endContainer,rangeB.endOffset),endComparison=comparePoints(rangeA.endContainer,rangeA.endOffset,rangeB.startContainer,rangeB.startOffset);return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0}function cloneSubtree(iterator){for(var partiallySelected,node,subIterator,frag=getRangeDocument(iterator.range).createDocumentFragment();node=iterator.next();){if(partiallySelected=iterator.isPartiallySelectedSubtree(),node=node.cloneNode(!partiallySelected),partiallySelected&&(subIterator=iterator.getSubtreeIterator(),node.appendChild(cloneSubtree(subIterator)),subIterator.detach(!0)),10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function iterateSubtree(rangeIterator,func,iteratorState){var it,n;iteratorState=iteratorState||{stop:!1};for(var node,subRangeIterator;node=rangeIterator.next();)if(rangeIterator.isPartiallySelectedSubtree()){if(func(node)===!1)return void(iteratorState.stop=!0);if(subRangeIterator=rangeIterator.getSubtreeIterator(),iterateSubtree(subRangeIterator,func,iteratorState),subRangeIterator.detach(!0),iteratorState.stop)return}else for(it=dom.createIterator(node);n=it.next();)if(func(n)===!1)return void(iteratorState.stop=!0)}function deleteSubtree(iterator){for(var subIterator;iterator.next();)iterator.isPartiallySelectedSubtree()?(subIterator=iterator.getSubtreeIterator(),deleteSubtree(subIterator),subIterator.detach(!0)):iterator.remove()}function extractSubtree(iterator){for(var node,subIterator,frag=getRangeDocument(iterator.range).createDocumentFragment();node=iterator.next();){if(iterator.isPartiallySelectedSubtree()?(node=node.cloneNode(!1),subIterator=iterator.getSubtreeIterator(),node.appendChild(extractSubtree(subIterator)),subIterator.detach(!0)):iterator.remove(),10==node.nodeType)throw new DOMException("HIERARCHY_REQUEST_ERR");frag.appendChild(node)}return frag}function getNodesInRange(range,nodeTypes,filter){var regex,filterNodeTypes=!(!nodeTypes||!nodeTypes.length),filterExists=!!filter;filterNodeTypes&&(regex=new RegExp("^("+nodeTypes.join("|")+")$"));var nodes=[];return iterateSubtree(new RangeIterator(range,!1),function(node){if(!(filterNodeTypes&&!regex.test(node.nodeType)||filterExists&&!filter(node))){var sc=range.startContainer;if(node!=sc||!isCharacterDataNode(sc)||range.startOffset!=sc.length){var ec=range.endContainer;node==ec&&isCharacterDataNode(ec)&&0==range.endOffset||nodes.push(node)}}}),nodes}function inspect(range){var name="undefined"==typeof range.getName?"Range":range.getName();return"["+name+"("+dom.inspectNode(range.startContainer)+":"+range.startOffset+", "+dom.inspectNode(range.endContainer)+":"+range.endOffset+")]"}function RangeIterator(range,clonePartiallySelectedTextNodes){if(this.range=range,this.clonePartiallySelectedTextNodes=clonePartiallySelectedTextNodes,!range.collapsed){this.sc=range.startContainer,this.so=range.startOffset,this.ec=range.endContainer,this.eo=range.endOffset;var root=range.commonAncestorContainer;this.sc===this.ec&&isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==root||isCharacterDataNode(this.sc)?getClosestAncestorIn(this.sc,root,!0):this.sc.childNodes[this.so],this._last=this.ec!==root||isCharacterDataNode(this.ec)?getClosestAncestorIn(this.ec,root,!0):this.ec.childNodes[this.eo-1])}}function RangeException(codeName){this.code=this[codeName],this.codeName=codeName,this.message="RangeException: "+this.codeName}function createAncestorFinder(nodeTypes){return function(node,selfIsAncestor){for(var t,n=selfIsAncestor?node:node.parentNode;n;){if(t=n.nodeType,arrayContains(nodeTypes,t))return n;n=n.parentNode}return null}}function assertNoDocTypeNotationEntityAncestor(node,allowSelf){if(getDocTypeNotationEntityAncestor(node,allowSelf))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertNotDetached(range){if(!range.startContainer)throw new DOMException("INVALID_STATE_ERR")}function assertValidNodeType(node,invalidTypes){if(!arrayContains(invalidTypes,node.nodeType))throw new RangeException("INVALID_NODE_TYPE_ERR")}function assertValidOffset(node,offset){if(0>offset||offset>(isCharacterDataNode(node)?node.length:node.childNodes.length))throw new DOMException("INDEX_SIZE_ERR")}function assertSameDocumentOrFragment(node1,node2){if(getDocumentOrFragmentContainer(node1,!0)!==getDocumentOrFragmentContainer(node2,!0))throw new DOMException("WRONG_DOCUMENT_ERR")}function assertNodeNotReadOnly(node){if(getReadonlyAncestor(node,!0))throw new DOMException("NO_MODIFICATION_ALLOWED_ERR")}function assertNode(node,codeName){if(!node)throw new DOMException(codeName)}function isOrphan(node){return crashyTextNodes&&dom.isBrokenNode(node)||!arrayContains(rootContainerNodeTypes,node.nodeType)&&!getDocumentOrFragmentContainer(node,!0)}function isValidOffset(node,offset){return offset<=(isCharacterDataNode(node)?node.length:node.childNodes.length)}function isRangeValid(range){return!!range.startContainer&&!!range.endContainer&&!isOrphan(range.startContainer)&&!isOrphan(range.endContainer)&&isValidOffset(range.startContainer,range.startOffset)&&isValidOffset(range.endContainer,range.endOffset)}function assertRangeValid(range){if(assertNotDetached(range),!isRangeValid(range))throw new Error("Range error: Range is no longer valid after DOM mutation ("+range.inspect()+")")}function splitRangeBoundaries(range,positionsToPreserve){assertRangeValid(range);var sc=range.startContainer,so=range.startOffset,ec=range.endContainer,eo=range.endOffset,startEndSame=sc===ec;isCharacterDataNode(ec)&&eo>0&&eo<ec.length&&splitDataNode(ec,eo,positionsToPreserve),isCharacterDataNode(sc)&&so>0&&so<sc.length&&(sc=splitDataNode(sc,so,positionsToPreserve),startEndSame?(eo-=so,ec=sc):ec==sc.parentNode&&eo>=getNodeIndex(sc)&&eo++,so=0),range.setStartAndEnd(sc,so,ec,eo)}function copyComparisonConstantsToObject(obj){obj.START_TO_START=s2s,obj.START_TO_END=s2e,obj.END_TO_END=e2e,obj.END_TO_START=e2s,obj.NODE_BEFORE=n_b,obj.NODE_AFTER=n_a,obj.NODE_BEFORE_AND_AFTER=n_b_a,obj.NODE_INSIDE=n_i}function copyComparisonConstants(constructor){copyComparisonConstantsToObject(constructor),copyComparisonConstantsToObject(constructor.prototype)}function createRangeContentRemover(remover,boundaryUpdater){return function(){assertRangeValid(this);var node,boundary,sc=this.startContainer,so=this.startOffset,root=this.commonAncestorContainer,iterator=new RangeIterator(this,!0);sc!==root&&(node=getClosestAncestorIn(sc,root,!0),boundary=getBoundaryAfterNode(node),sc=boundary.node,so=boundary.offset),iterateSubtree(iterator,assertNodeNotReadOnly),iterator.reset();var returnValue=remover(iterator);return iterator.detach(),boundaryUpdater(this,sc,so,sc,so),returnValue}}function createPrototypeRange(constructor,boundaryUpdater,detacher){function createBeforeAfterNodeSetter(isBefore,isStart){return function(node){assertNotDetached(this),assertValidNodeType(node,beforeAfterNodeTypes),assertValidNodeType(getRootContainer(node),rootContainerNodeTypes);var boundary=(isBefore?getBoundaryBeforeNode:getBoundaryAfterNode)(node);(isStart?setRangeStart:setRangeEnd)(this,boundary.node,boundary.offset)}}function setRangeStart(range,node,offset){var ec=range.endContainer,eo=range.endOffset;(node!==range.startContainer||offset!==range.startOffset)&&((getRootContainer(node)!=getRootContainer(ec)||1==comparePoints(node,offset,ec,eo))&&(ec=node,eo=offset),boundaryUpdater(range,node,offset,ec,eo))}function setRangeEnd(range,node,offset){var sc=range.startContainer,so=range.startOffset;(node!==range.endContainer||offset!==range.endOffset)&&((getRootContainer(node)!=getRootContainer(sc)||-1==comparePoints(node,offset,sc,so))&&(sc=node,so=offset),boundaryUpdater(range,sc,so,node,offset))}var F=function(){};F.prototype=api.rangePrototype,constructor.prototype=new F,util.extend(constructor.prototype,{setStart:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeStart(this,node,offset)},setEnd:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),setRangeEnd(this,node,offset)},setStartAndEnd:function(){assertNotDetached(this);var args=arguments,sc=args[0],so=args[1],ec=sc,eo=so;switch(args.length){case 3:eo=args[2];break;case 4:ec=args[2],eo=args[3]}boundaryUpdater(this,sc,so,ec,eo)},setBoundary:function(node,offset,isStart){this["set"+(isStart?"Start":"End")](node,offset)},setStartBefore:createBeforeAfterNodeSetter(!0,!0),setStartAfter:createBeforeAfterNodeSetter(!1,!0),setEndBefore:createBeforeAfterNodeSetter(!0,!1),setEndAfter:createBeforeAfterNodeSetter(!1,!1),collapse:function(isStart){assertRangeValid(this),isStart?boundaryUpdater(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):boundaryUpdater(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),boundaryUpdater(this,node,0,node,getNodeLength(node))},selectNode:function(node){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!1),assertValidNodeType(node,beforeAfterNodeTypes);var start=getBoundaryBeforeNode(node),end=getBoundaryAfterNode(node);boundaryUpdater(this,start.node,start.offset,end.node,end.offset)},extractContents:createRangeContentRemover(extractSubtree,boundaryUpdater),deleteContents:createRangeContentRemover(deleteSubtree,boundaryUpdater),canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},detach:function(){detacher(this)},splitBoundaries:function(){splitRangeBoundaries(this)},splitBoundariesPreservingPositions:function(positionsToPreserve){splitRangeBoundaries(this,positionsToPreserve)},normalizeBoundaries:function(){assertRangeValid(this);var sc=this.startContainer,so=this.startOffset,ec=this.endContainer,eo=this.endOffset,mergeForward=function(node){var sibling=node.nextSibling;sibling&&sibling.nodeType==node.nodeType&&(ec=node,eo=node.length,node.appendData(sibling.data),sibling.parentNode.removeChild(sibling))},mergeBackward=function(node){var sibling=node.previousSibling;if(sibling&&sibling.nodeType==node.nodeType){sc=node;var nodeLength=node.length;if(so=sibling.length,node.insertData(0,sibling.data),sibling.parentNode.removeChild(sibling),sc==ec)eo+=so,ec=sc;else if(ec==node.parentNode){var nodeIndex=getNodeIndex(node);eo==nodeIndex?(ec=node,eo=nodeLength):eo>nodeIndex&&eo--}}},normalizeStart=!0;if(isCharacterDataNode(ec))ec.length==eo&&mergeForward(ec);else{if(eo>0){var endNode=ec.childNodes[eo-1];endNode&&isCharacterDataNode(endNode)&&mergeForward(endNode)}normalizeStart=!this.collapsed}if(normalizeStart){if(isCharacterDataNode(sc))0==so&&mergeBackward(sc);else if(so<sc.childNodes.length){var startNode=sc.childNodes[so];startNode&&isCharacterDataNode(startNode)&&mergeBackward(startNode)}}else sc=ec,so=eo;boundaryUpdater(this,sc,so,ec,eo)},collapseToPoint:function(node,offset){assertNotDetached(this),assertNoDocTypeNotationEntityAncestor(node,!0),assertValidOffset(node,offset),this.setStartAndEnd(node,offset)}}),copyComparisonConstants(constructor)}function updateCollapsedAndCommonAncestor(range){range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset,range.commonAncestorContainer=range.collapsed?range.startContainer:dom.getCommonAncestor(range.startContainer,range.endContainer)}function updateBoundaries(range,startContainer,startOffset,endContainer,endOffset){range.startContainer=startContainer,range.startOffset=startOffset,range.endContainer=endContainer,range.endOffset=endOffset,range.document=dom.getDocument(startContainer),updateCollapsedAndCommonAncestor(range)}function detach(range){assertNotDetached(range),range.startContainer=range.startOffset=range.endContainer=range.endOffset=range.document=null,range.collapsed=range.commonAncestorContainer=null}function Range(doc){this.startContainer=doc,this.startOffset=0,this.endContainer=doc,this.endOffset=0,this.document=doc,updateCollapsedAndCommonAncestor(this)}var dom=api.dom,util=api.util,DomPosition=dom.DomPosition,DOMException=api.DOMException,isCharacterDataNode=dom.isCharacterDataNode,getNodeIndex=dom.getNodeIndex,isOrIsAncestorOf=dom.isOrIsAncestorOf,getDocument=dom.getDocument,comparePoints=dom.comparePoints,splitDataNode=dom.splitDataNode,getClosestAncestorIn=dom.getClosestAncestorIn,getNodeLength=dom.getNodeLength,arrayContains=dom.arrayContains,getRootContainer=dom.getRootContainer,crashyTextNodes=api.features.crashyTextNodes;RangeIterator.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var current=this._current=this._next;return current&&(this._next=current!==this._last?current.nextSibling:null,isCharacterDataNode(current)&&this.clonePartiallySelectedTextNodes&&(current===this.ec&&(current=current.cloneNode(!0)).deleteData(this.eo,current.length-this.eo),this._current===this.sc&&(current=current.cloneNode(!0)).deleteData(0,this.so))),current},remove:function(){var start,end,current=this._current;!isCharacterDataNode(current)||current!==this.sc&&current!==this.ec?current.parentNode&&current.parentNode.removeChild(current):(start=current===this.sc?this.so:0,end=current===this.ec?this.eo:current.length,start!=end&&current.deleteData(start,end-start))},isPartiallySelectedSubtree:function(){var current=this._current;return isNonTextPartiallySelected(current,this.range)},getSubtreeIterator:function(){var subRange;if(this.isSingleCharacterDataNode)subRange=this.range.cloneRange(),subRange.collapse(!1);else{subRange=new Range(getRangeDocument(this.range));var current=this._current,startContainer=current,startOffset=0,endContainer=current,endOffset=getNodeLength(current);isOrIsAncestorOf(current,this.sc)&&(startContainer=this.sc,startOffset=this.so),isOrIsAncestorOf(current,this.ec)&&(endContainer=this.ec,endOffset=this.eo),updateBoundaries(subRange,startContainer,startOffset,endContainer,endOffset)}return new RangeIterator(subRange,this.clonePartiallySelectedTextNodes)},detach:function(detachRange){detachRange&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},RangeException.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},RangeException.prototype.toString=function(){return this.message};var beforeAfterNodeTypes=[1,3,4,5,7,8,10],rootContainerNodeTypes=[2,9,11],readonlyNodeTypes=[5,6,10,12],insertableNodeTypes=[1,3,4,5,7,8,10,11],surroundNodeTypes=[1,3,4,5,7,8],getDocumentOrFragmentContainer=createAncestorFinder([9,11]),getReadonlyAncestor=createAncestorFinder(readonlyNodeTypes),getDocTypeNotationEntityAncestor=createAncestorFinder([6,10,12]),styleEl=document.createElementNS("http://www.w3.org/1999/xhtml","style"),htmlParsingConforms=!1;try{styleEl.innerHTML="<b>x</b>",htmlParsingConforms=3==styleEl.firstChild.nodeType}catch(e){}api.features.htmlParsingConforms=htmlParsingConforms;var createContextualFragment=htmlParsingConforms?function(fragmentStr){var node=this.startContainer,doc=getDocument(node);if(!node)throw new DOMException("INVALID_STATE_ERR");var el=null;return 1==node.nodeType?el=node:isCharacterDataNode(node)&&(el=dom.parentElement(node)),el=null===el||"HTML"==el.nodeName&&dom.isHtmlNamespace(getDocument(el).documentElement)&&dom.isHtmlNamespace(el)?doc.createElementNS("http://www.w3.org/1999/xhtml","body"):el.cloneNode(!1),el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)}:function(fragmentStr){assertNotDetached(this);var doc=getRangeDocument(this),el=doc.createElementNS("http://www.w3.org/1999/xhtml","body");return el.innerHTML=fragmentStr,dom.fragmentFromNodeChildren(el)},rangeProperties=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],s2s=0,s2e=1,e2e=2,e2s=3,n_b=0,n_a=1,n_b_a=2,n_i=3;util.extend(api.rangePrototype,{compareBoundaryPoints:function(how,range){assertRangeValid(this),assertSameDocumentOrFragment(this.startContainer,range.startContainer);var nodeA,offsetA,nodeB,offsetB,prefixA=how==e2s||how==s2s?"start":"end",prefixB=how==s2e||how==s2s?"start":"end";return nodeA=this[prefixA+"Container"],offsetA=this[prefixA+"Offset"],nodeB=range[prefixB+"Container"],offsetB=range[prefixB+"Offset"],comparePoints(nodeA,offsetA,nodeB,offsetB)},insertNode:function(node){if(assertRangeValid(this),assertValidNodeType(node,insertableNodeTypes),assertNodeNotReadOnly(this.startContainer),isOrIsAncestorOf(node,this.startContainer))throw new DOMException("HIERARCHY_REQUEST_ERR");var firstNodeInserted=insertNodeAtPosition(node,this.startContainer,this.startOffset);this.setStartBefore(firstNodeInserted)},cloneContents:function(){assertRangeValid(this);var clone,frag;if(this.collapsed)return getRangeDocument(this).createDocumentFragment();if(this.startContainer===this.endContainer&&isCharacterDataNode(this.startContainer))return clone=this.startContainer.cloneNode(!0),clone.data=clone.data.slice(this.startOffset,this.endOffset),frag=getRangeDocument(this).createDocumentFragment(),frag.appendChild(clone),frag;var iterator=new RangeIterator(this,!0);return clone=cloneSubtree(iterator),iterator.detach(),clone},canSurroundContents:function(){assertRangeValid(this),assertNodeNotReadOnly(this.startContainer),assertNodeNotReadOnly(this.endContainer);var iterator=new RangeIterator(this,!0),boundariesInvalid=iterator._first&&isNonTextPartiallySelected(iterator._first,this)||iterator._last&&isNonTextPartiallySelected(iterator._last,this);return iterator.detach(),!boundariesInvalid},surroundContents:function(node){if(assertValidNodeType(node,surroundNodeTypes),!this.canSurroundContents())throw new RangeException("BAD_BOUNDARYPOINTS_ERR");var content=this.extractContents();if(node.hasChildNodes())for(;node.lastChild;)node.removeChild(node.lastChild);insertNodeAtPosition(node,this.startContainer,this.startOffset),node.appendChild(content),this.selectNode(node)},cloneRange:function(){assertRangeValid(this);for(var prop,range=new Range(getRangeDocument(this)),i=rangeProperties.length;i--;)prop=rangeProperties[i],range[prop]=this[prop];return range},toString:function(){assertRangeValid(this);var sc=this.startContainer;if(sc===this.endContainer&&isCharacterDataNode(sc))return 3==sc.nodeType||4==sc.nodeType?sc.data.slice(this.startOffset,this.endOffset):"";var textParts=[],iterator=new RangeIterator(this,!0);return iterateSubtree(iterator,function(node){(3==node.nodeType||4==node.nodeType)&&textParts.push(node.data)}),iterator.detach(),textParts.join("")},compareNode:function(node){assertRangeValid(this);var parent=node.parentNode,nodeIndex=getNodeIndex(node);if(!parent)throw new DOMException("NOT_FOUND_ERR");var startComparison=this.comparePoint(parent,nodeIndex),endComparison=this.comparePoint(parent,nodeIndex+1);return 0>startComparison?endComparison>0?n_b_a:n_b:endComparison>0?n_a:n_i},comparePoint:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),comparePoints(node,offset,this.startContainer,this.startOffset)<0?-1:comparePoints(node,offset,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:createContextualFragment,toHtml:function(){assertRangeValid(this);var container=this.commonAncestorContainer.parentNode.cloneNode(!1);return container.appendChild(this.cloneContents()),container.innerHTML},intersectsNode:function(node,touchingIsIntersecting){if(assertRangeValid(this),assertNode(node,"NOT_FOUND_ERR"),getDocument(node)!==getRangeDocument(this))return!1;var parent=node.parentNode,offset=getNodeIndex(node);assertNode(parent,"NOT_FOUND_ERR");var startComparison=comparePoints(parent,offset,this.endContainer,this.endOffset),endComparison=comparePoints(parent,offset+1,this.startContainer,this.startOffset);return touchingIsIntersecting?0>=startComparison&&endComparison>=0:0>startComparison&&endComparison>0},isPointInRange:function(node,offset){return assertRangeValid(this),assertNode(node,"HIERARCHY_REQUEST_ERR"),assertSameDocumentOrFragment(node,this.startContainer),comparePoints(node,offset,this.startContainer,this.startOffset)>=0&&comparePoints(node,offset,this.endContainer,this.endOffset)<=0},intersectsRange:function(range){return rangesIntersect(this,range,!1)},intersectsOrTouchesRange:function(range){return rangesIntersect(this,range,!0)},intersection:function(range){if(this.intersectsRange(range)){var startComparison=comparePoints(this.startContainer,this.startOffset,range.startContainer,range.startOffset),endComparison=comparePoints(this.endContainer,this.endOffset,range.endContainer,range.endOffset),intersectionRange=this.cloneRange();return-1==startComparison&&intersectionRange.setStart(range.startContainer,range.startOffset),1==endComparison&&intersectionRange.setEnd(range.endContainer,range.endOffset),intersectionRange}return null},union:function(range){if(this.intersectsOrTouchesRange(range)){var unionRange=this.cloneRange();return-1==comparePoints(range.startContainer,range.startOffset,this.startContainer,this.startOffset)&&unionRange.setStart(range.startContainer,range.startOffset),1==comparePoints(range.endContainer,range.endOffset,this.endContainer,this.endOffset)&&unionRange.setEnd(range.endContainer,range.endOffset),unionRange}throw new RangeException("Ranges do not intersect")},containsNode:function(node,allowPartial){return allowPartial?this.intersectsNode(node,!1):this.compareNode(node)==n_i},containsNodeContents:function(node){return this.comparePoint(node,0)>=0&&this.comparePoint(node,getNodeLength(node))<=0},containsRange:function(range){var intersection=this.intersection(range);
return null!==intersection&&range.equals(intersection)},containsNodeText:function(node){var nodeRange=this.cloneRange();nodeRange.selectNode(node);var textNodes=nodeRange.getNodes([3]);if(textNodes.length>0){nodeRange.setStart(textNodes[0],0);var lastTextNode=textNodes.pop();nodeRange.setEnd(lastTextNode,lastTextNode.length);var contains=this.containsRange(nodeRange);return nodeRange.detach(),contains}return this.containsNodeContents(node)},getNodes:function(nodeTypes,filter){return assertRangeValid(this),getNodesInRange(this,nodeTypes,filter)},getDocument:function(){return getRangeDocument(this)},collapseBefore:function(node){assertNotDetached(this),this.setEndBefore(node),this.collapse(!1)},collapseAfter:function(node){assertNotDetached(this),this.setStartAfter(node),this.collapse(!0)},getBookmark:function(containerNode){var doc=getRangeDocument(this),preSelectionRange=api.createRange(doc);containerNode=containerNode||dom.getBody(doc),preSelectionRange.selectNodeContents(containerNode);var range=this.intersection(preSelectionRange),start=0,end=0;return range&&(preSelectionRange.setEnd(range.startContainer,range.startOffset),start=preSelectionRange.toString().length,end=start+range.toString().length,preSelectionRange.detach()),{start:start,end:end,containerNode:containerNode}},moveToBookmark:function(bookmark){var containerNode=bookmark.containerNode,charIndex=0;this.setStart(containerNode,0),this.collapse(!0);for(var node,nextCharIndex,i,childNodes,nodeStack=[containerNode],foundStart=!1,stop=!1;!stop&&(node=nodeStack.pop());)if(3==node.nodeType)nextCharIndex=charIndex+node.length,!foundStart&&bookmark.start>=charIndex&&bookmark.start<=nextCharIndex&&(this.setStart(node,bookmark.start-charIndex),foundStart=!0),foundStart&&bookmark.end>=charIndex&&bookmark.end<=nextCharIndex&&(this.setEnd(node,bookmark.end-charIndex),stop=!0),charIndex=nextCharIndex;else for(childNodes=node.childNodes,i=childNodes.length;i--;)nodeStack.push(childNodes[i])},getName:function(){return"DomRange"},equals:function(range){return Range.rangesEqual(this,range)},isValid:function(){return isRangeValid(this)},inspect:function(){return inspect(this)}}),createPrototypeRange(Range,updateBoundaries,detach),util.extend(Range,{rangeProperties:rangeProperties,RangeIterator:RangeIterator,copyComparisonConstants:copyComparisonConstants,createPrototypeRange:createPrototypeRange,inspect:inspect,getRangeDocument:getRangeDocument,rangesEqual:function(r1,r2){return r1.startContainer===r2.startContainer&&r1.startOffset===r2.startOffset&&r1.endContainer===r2.endContainer&&r1.endOffset===r2.endOffset}}),api.DomRange=Range,api.RangeException=RangeException}),rangy.createCoreModule("WrappedRange",["DomRange"],function(api,module){var WrappedRange,WrappedTextRange,dom=api.dom,util=api.util,DomPosition=dom.DomPosition,DomRange=api.DomRange,getBody=dom.getBody,getContentDocument=dom.getContentDocument,isCharacterDataNode=dom.isCharacterDataNode;if(api.features.implementsDomRange&&!function(){function updateRangeProperties(range){for(var prop,i=rangeProperties.length;i--;)prop=rangeProperties[i],range[prop]=range.nativeRange[prop];range.collapsed=range.startContainer===range.endContainer&&range.startOffset===range.endOffset}function updateNativeRange(range,startContainer,startOffset,endContainer,endOffset){var startMoved=range.startContainer!==startContainer||range.startOffset!=startOffset,endMoved=range.endContainer!==endContainer||range.endOffset!=endOffset,nativeRangeDifferent=!range.equals(range.nativeRange);(startMoved||endMoved||nativeRangeDifferent)&&(range.setEnd(endContainer,endOffset),range.setStart(startContainer,startOffset))}function detach(range){range.nativeRange.detach(),range.detached=!0;for(var i=rangeProperties.length;i--;)range[rangeProperties[i]]=null}var rangeProto,createBeforeAfterNodeSetter,rangeProperties=DomRange.rangeProperties;WrappedRange=function(range){if(!range)throw module.createError("WrappedRange: Range must be specified");this.nativeRange=range,updateRangeProperties(this)},DomRange.createPrototypeRange(WrappedRange,updateNativeRange,detach),rangeProto=WrappedRange.prototype,rangeProto.selectNode=function(node){this.nativeRange.selectNode(node),updateRangeProperties(this)},rangeProto.cloneContents=function(){return this.nativeRange.cloneContents()},rangeProto.surroundContents=function(node){this.nativeRange.surroundContents(node),updateRangeProperties(this)},rangeProto.collapse=function(isStart){this.nativeRange.collapse(isStart),updateRangeProperties(this)},rangeProto.cloneRange=function(){return new WrappedRange(this.nativeRange.cloneRange())},rangeProto.refresh=function(){updateRangeProperties(this)},rangeProto.toString=function(){return this.nativeRange.toString()};var testTextNode=document.createTextNode("test");getBody(document).appendChild(testTextNode);var range=document.createRange();range.setStart(testTextNode,0),range.setEnd(testTextNode,0);try{range.setStart(testTextNode,1),rangeProto.setStart=function(node,offset){this.nativeRange.setStart(node,offset),updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){this.nativeRange.setEnd(node,offset),updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name){return function(node){this.nativeRange[name](node),updateRangeProperties(this)}}}catch(ex){rangeProto.setStart=function(node,offset){try{this.nativeRange.setStart(node,offset)}catch(ex){this.nativeRange.setEnd(node,offset),this.nativeRange.setStart(node,offset)}updateRangeProperties(this)},rangeProto.setEnd=function(node,offset){try{this.nativeRange.setEnd(node,offset)}catch(ex){this.nativeRange.setStart(node,offset),this.nativeRange.setEnd(node,offset)}updateRangeProperties(this)},createBeforeAfterNodeSetter=function(name,oppositeName){return function(node){try{this.nativeRange[name](node)}catch(ex){this.nativeRange[oppositeName](node),this.nativeRange[name](node)}updateRangeProperties(this)}}}rangeProto.setStartBefore=createBeforeAfterNodeSetter("setStartBefore","setEndBefore"),rangeProto.setStartAfter=createBeforeAfterNodeSetter("setStartAfter","setEndAfter"),rangeProto.setEndBefore=createBeforeAfterNodeSetter("setEndBefore","setStartBefore"),rangeProto.setEndAfter=createBeforeAfterNodeSetter("setEndAfter","setStartAfter"),rangeProto.selectNodeContents=function(node){this.setStartAndEnd(node,0,dom.getNodeLength(node))},range.selectNodeContents(testTextNode),range.setEnd(testTextNode,3);var range2=document.createRange();range2.selectNodeContents(testTextNode),range2.setEnd(testTextNode,4),range2.setStart(testTextNode,2),rangeProto.compareBoundaryPoints=-1==range.compareBoundaryPoints(range.START_TO_END,range2)&&1==range.compareBoundaryPoints(range.END_TO_START,range2)?function(type,range){return range=range.nativeRange||range,type==range.START_TO_END?type=range.END_TO_START:type==range.END_TO_START&&(type=range.START_TO_END),this.nativeRange.compareBoundaryPoints(type,range)}:function(type,range){return this.nativeRange.compareBoundaryPoints(type,range.nativeRange||range)};var el=document.createElementNS("http://www.w3.org/1999/xhtml","div");el.innerHTML="123";var textNode=el.firstChild,body=getBody(document);body.appendChild(el),range.setStart(textNode,1),range.setEnd(textNode,2),range.deleteContents(),"13"==textNode.data&&(rangeProto.deleteContents=function(){this.nativeRange.deleteContents(),updateRangeProperties(this)},rangeProto.extractContents=function(){var frag=this.nativeRange.extractContents();return updateRangeProperties(this),frag}),body.removeChild(el),body=null,util.isHostMethod(range,"createContextualFragment")&&(rangeProto.createContextualFragment=function(fragmentStr){return this.nativeRange.createContextualFragment(fragmentStr)}),getBody(document).removeChild(testTextNode),range.detach(),range2.detach(),rangeProto.getName=function(){return"WrappedRange"},api.WrappedRange=WrappedRange,api.createNativeRange=function(doc){return doc=getContentDocument(doc,module,"createNativeRange"),doc.createRange()}}(),api.features.implementsTextRange){var getTextRangeContainerElement=function(textRange){var parentEl=textRange.parentElement(),range=textRange.duplicate();range.collapse(!0);var startEl=range.parentElement();range=textRange.duplicate(),range.collapse(!1);var endEl=range.parentElement(),startEndContainer=startEl==endEl?startEl:dom.getCommonAncestor(startEl,endEl);return startEndContainer==parentEl?startEndContainer:dom.getCommonAncestor(parentEl,startEndContainer)},textRangeIsCollapsed=function(textRange){return 0==textRange.compareEndPoints("StartToEnd",textRange)},getTextRangeBoundaryPosition=function(textRange,wholeRangeContainerElement,isStart,isCollapsed,startInfo){var workingRange=textRange.duplicate();workingRange.collapse(isStart);var containerElement=workingRange.parentElement();if(dom.isOrIsAncestorOf(wholeRangeContainerElement,containerElement)||(containerElement=wholeRangeContainerElement),!containerElement.canHaveHTML){var pos=new DomPosition(containerElement.parentNode,dom.getNodeIndex(containerElement));return{boundaryPosition:pos,nodeInfo:{nodeIndex:pos.offset,containerElement:pos.node}}}var workingNode=dom.getDocument(containerElement).createElementNS("http://www.w3.org/1999/xhtml","span");workingNode.parentNode&&workingNode.parentNode.removeChild(workingNode);for(var comparison,previousNode,nextNode,boundaryPosition,boundaryNode,workingComparisonType=isStart?"StartToStart":"StartToEnd",start=startInfo&&startInfo.containerElement==containerElement?startInfo.nodeIndex:0,childNodeCount=containerElement.childNodes.length,end=childNodeCount,nodeIndex=end;;){if(nodeIndex==childNodeCount?containerElement.appendChild(workingNode):containerElement.insertBefore(workingNode,containerElement.childNodes[nodeIndex]),workingRange.moveToElementText(workingNode),comparison=workingRange.compareEndPoints(workingComparisonType,textRange),0==comparison||start==end)break;if(-1==comparison){if(end==start+1)break;start=nodeIndex}else end=end==start+1?start:nodeIndex;nodeIndex=Math.floor((start+end)/2),containerElement.removeChild(workingNode)}if(boundaryNode=workingNode.nextSibling,-1==comparison&&boundaryNode&&isCharacterDataNode(boundaryNode)){workingRange.setEndPoint(isStart?"EndToStart":"EndToEnd",textRange);var offset;if(/[\r\n]/.test(boundaryNode.data)){var tempRange=workingRange.duplicate(),rangeLength=tempRange.text.replace(/\r\n/g,"\r").length;for(offset=tempRange.moveStart("character",rangeLength);-1==(comparison=tempRange.compareEndPoints("StartToEnd",tempRange));)offset++,tempRange.moveStart("character",1)}else offset=workingRange.text.length;boundaryPosition=new DomPosition(boundaryNode,offset)}else previousNode=(isCollapsed||!isStart)&&workingNode.previousSibling,nextNode=(isCollapsed||isStart)&&workingNode.nextSibling,boundaryPosition=nextNode&&isCharacterDataNode(nextNode)?new DomPosition(nextNode,0):previousNode&&isCharacterDataNode(previousNode)?new DomPosition(previousNode,previousNode.data.length):new DomPosition(containerElement,dom.getNodeIndex(workingNode));return workingNode.parentNode.removeChild(workingNode),{boundaryPosition:boundaryPosition,nodeInfo:{nodeIndex:nodeIndex,containerElement:containerElement}}},createBoundaryTextRange=function(boundaryPosition,isStart){var boundaryNode,boundaryParent,workingNode,childNodes,boundaryOffset=boundaryPosition.offset,doc=dom.getDocument(boundaryPosition.node),workingRange=getBody(doc).createTextRange(),nodeIsDataNode=isCharacterDataNode(boundaryPosition.node);return nodeIsDataNode?(boundaryNode=boundaryPosition.node,boundaryParent=boundaryNode.parentNode):(childNodes=boundaryPosition.node.childNodes,boundaryNode=boundaryOffset<childNodes.length?childNodes[boundaryOffset]:null,boundaryParent=boundaryPosition.node),workingNode=doc.createElementNS("http://www.w3.org/1999/xhtml","span"),workingNode.innerHTML="&#feff;",boundaryNode?boundaryParent.insertBefore(workingNode,boundaryNode):boundaryParent.appendChild(workingNode),workingRange.moveToElementText(workingNode),workingRange.collapse(!isStart),boundaryParent.removeChild(workingNode),nodeIsDataNode&&workingRange[isStart?"moveStart":"moveEnd"]("character",boundaryOffset),workingRange};if(WrappedTextRange=function(textRange){this.textRange=textRange,this.refresh()},WrappedTextRange.prototype=new DomRange(document),WrappedTextRange.prototype.refresh=function(){var start,end,startBoundary,rangeContainerElement=getTextRangeContainerElement(this.textRange);textRangeIsCollapsed(this.textRange)?end=start=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!0).boundaryPosition:(startBoundary=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!0,!1),start=startBoundary.boundaryPosition,end=getTextRangeBoundaryPosition(this.textRange,rangeContainerElement,!1,!1,startBoundary.nodeInfo).boundaryPosition),this.setStart(start.node,start.offset),this.setEnd(end.node,end.offset)},WrappedTextRange.prototype.getName=function(){return"WrappedTextRange"},DomRange.copyComparisonConstants(WrappedTextRange),WrappedTextRange.rangeToTextRange=function(range){if(range.collapsed)return createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0);var startRange=createBoundaryTextRange(new DomPosition(range.startContainer,range.startOffset),!0),endRange=createBoundaryTextRange(new DomPosition(range.endContainer,range.endOffset),!1),textRange=getBody(DomRange.getRangeDocument(range)).createTextRange();return textRange.setEndPoint("StartToStart",startRange),textRange.setEndPoint("EndToEnd",endRange),textRange},api.WrappedTextRange=WrappedTextRange,!api.features.implementsDomRange||api.config.preferTextRange){var globalObj=function(){return this}();"undefined"==typeof globalObj.Range&&(globalObj.Range=WrappedTextRange),api.createNativeRange=function(doc){return doc=getContentDocument(doc,module,"createNativeRange"),getBody(doc).createTextRange()},api.WrappedRange=WrappedTextRange}}api.createRange=function(doc){return doc=getContentDocument(doc,module,"createRange"),new api.WrappedRange(api.createNativeRange(doc))},api.createRangyRange=function(doc){return doc=getContentDocument(doc,module,"createRangyRange"),new DomRange(doc)},api.createIframeRange=function(iframeEl){return module.deprecationNotice("createIframeRange()","createRange(iframeEl)"),api.createRange(iframeEl)},api.createIframeRangyRange=function(iframeEl){return module.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),api.createRangyRange(iframeEl)},api.addCreateMissingNativeApiListener(function(win){var doc=win.document;"undefined"==typeof doc.createRange&&(doc.createRange=function(){return api.createRange(doc)}),doc=win=null})}),rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(api,module){function isDirectionBackward(dir){return"string"==typeof dir?/^backward(s)?$/i.test(dir):!!dir}function getWindow(win,methodName){if(win){if(dom.isWindow(win))return win;if(win instanceof WrappedSelection)return win.win;var doc=dom.getContentDocument(win,module,methodName);return dom.getWindow(doc)}return window}function getWinSelection(winParam){return getWindow(winParam,"getWinSelection").getSelection()}function getDocSelection(winParam){return getWindow(winParam,"getDocSelection").document.selection}function winSelectionIsBackward(sel){var backward=!1;return sel.anchorNode&&(backward=1==dom.comparePoints(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset)),backward}function updateAnchorAndFocusFromRange(sel,range,backward){var anchorPrefix=backward?"end":"start",focusPrefix=backward?"start":"end";sel.anchorNode=range[anchorPrefix+"Container"],sel.anchorOffset=range[anchorPrefix+"Offset"],sel.focusNode=range[focusPrefix+"Container"],sel.focusOffset=range[focusPrefix+"Offset"]}function updateAnchorAndFocusFromNativeSelection(sel){var nativeSel=sel.nativeSelection;sel.anchorNode=nativeSel.anchorNode,sel.anchorOffset=nativeSel.anchorOffset,sel.focusNode=nativeSel.focusNode,sel.focusOffset=nativeSel.focusOffset}function updateEmptySelection(sel){sel.anchorNode=sel.focusNode=null,sel.anchorOffset=sel.focusOffset=0,sel.rangeCount=0,sel.isCollapsed=!0,sel._ranges.length=0}function getNativeRange(range){var nativeRange;return range instanceof DomRange?(nativeRange=api.createNativeRange(range.getDocument()),nativeRange.setEnd(range.endContainer,range.endOffset),nativeRange.setStart(range.startContainer,range.startOffset)):range instanceof WrappedRange?nativeRange=range.nativeRange:features.implementsDomRange&&range instanceof dom.getWindow(range.startContainer).Range&&(nativeRange=range),nativeRange}function rangeContainsSingleElement(rangeNodes){if(!rangeNodes.length||1!=rangeNodes[0].nodeType)return!1;for(var i=1,len=rangeNodes.length;len>i;++i)if(!dom.isAncestorOf(rangeNodes[0],rangeNodes[i]))return!1;return!0}function getSingleElementFromRange(range){var nodes=range.getNodes();if(!rangeContainsSingleElement(nodes))throw module.createError("getSingleElementFromRange: range "+range.inspect()+" did not consist of a single element");return nodes[0]}function isTextRange(range){return!!range&&"undefined"!=typeof range.text}function updateFromTextRange(sel,range){var wrappedRange=new WrappedRange(range);sel._ranges=[wrappedRange],updateAnchorAndFocusFromRange(sel,wrappedRange,!1),sel.rangeCount=1,sel.isCollapsed=wrappedRange.collapsed}function updateControlSelection(sel){if(sel._ranges.length=0,"None"==sel.docSelection.type)updateEmptySelection(sel);else{var controlRange=sel.docSelection.createRange();if(isTextRange(controlRange))updateFromTextRange(sel,controlRange);else{sel.rangeCount=controlRange.length;for(var range,doc=getDocument(controlRange.item(0)),i=0;i<sel.rangeCount;++i)range=api.createRange(doc),range.selectNode(controlRange.item(i)),sel._ranges.push(range);sel.isCollapsed=1==sel.rangeCount&&sel._ranges[0].collapsed,updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],!1)}}}function addRangeToControlSelection(sel,range){for(var controlRange=sel.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=getDocument(controlRange.item(0)),newControlRange=getBody(doc).createControlRange(),i=0,len=controlRange.length;len>i;++i)newControlRange.add(controlRange.item(i));try{newControlRange.add(rangeElement)}catch(ex){throw module.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}newControlRange.select(),updateControlSelection(sel)}function WrappedSelection(selection,docSelection,win){this.nativeSelection=selection,this.docSelection=docSelection,this._ranges=[],this.win=win,this.refresh()}function deleteProperties(sel){sel.win=sel.anchorNode=sel.focusNode=sel._ranges=null,sel.rangeCount=sel.anchorOffset=sel.focusOffset=0,sel.detached=!0}function actOnCachedSelection(win,action){for(var cached,sel,i=cachedRangySelections.length;i--;)if(cached=cachedRangySelections[i],sel=cached.selection,"deleteAll"==action)deleteProperties(sel);else if(cached.win==win)return"delete"==action?(cachedRangySelections.splice(i,1),!0):sel;return"deleteAll"==action&&(cachedRangySelections.length=0),null}function createControlSelection(sel,ranges){for(var el,doc=getDocument(ranges[0].startContainer),controlRange=getBody(doc).createControlRange(),i=0,len=ranges.length;len>i;++i){el=getSingleElementFromRange(ranges[i]);try{controlRange.add(el)}catch(ex){throw module.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}controlRange.select(),updateControlSelection(sel)}function assertNodeInSameDocument(sel,node){if(sel.win.document!=getDocument(node))throw new DOMException("WRONG_DOCUMENT_ERR")}function createStartOrEndSetter(isStart){return function(node,offset){var range;this.rangeCount?(range=this.getRangeAt(0),range["set"+(isStart?"Start":"End")](node,offset)):(range=api.createRange(this.win.document),range.setStartAndEnd(node,offset)),this.setSingleRange(range,this.isBackward())}}function inspect(sel){var rangeInspects=[],anchor=new DomPosition(sel.anchorNode,sel.anchorOffset),focus=new DomPosition(sel.focusNode,sel.focusOffset),name="function"==typeof sel.getName?sel.getName():"Selection";if("undefined"!=typeof sel.rangeCount)for(var i=0,len=sel.rangeCount;len>i;++i)rangeInspects[i]=DomRange.inspect(sel.getRangeAt(i));return"["+name+"(Ranges: "+rangeInspects.join(", ")+")(anchor: "+anchor.inspect()+", focus: "+focus.inspect()+"]"}api.config.checkSelectionRanges=!0;var getNativeSelection,selectionIsCollapsed,BOOLEAN="boolean",NUMBER="number",dom=api.dom,util=api.util,isHostMethod=util.isHostMethod,DomRange=api.DomRange,WrappedRange=api.WrappedRange,DOMException=api.DOMException,DomPosition=dom.DomPosition,features=api.features,CONTROL="Control",getDocument=dom.getDocument,getBody=dom.getBody,rangesEqual=DomRange.rangesEqual,implementsWinGetSelection=isHostMethod(window,"getSelection"),implementsDocSelection=util.isHostObject(document,"selection");features.implementsWinGetSelection=implementsWinGetSelection,features.implementsDocSelection=implementsDocSelection;var useDocumentSelection=implementsDocSelection&&(!implementsWinGetSelection||api.config.preferTextRange);useDocumentSelection?(getNativeSelection=getDocSelection,api.isSelectionValid=function(winParam){var doc=getWindow(winParam,"isSelectionValid").document,nativeSel=doc.selection;return"None"!=nativeSel.type||getDocument(nativeSel.createRange().parentElement())==doc}):implementsWinGetSelection?(getNativeSelection=getWinSelection,api.isSelectionValid=function(){return!0}):module.fail("Neither document.selection or window.getSelection() detected."),api.getNativeSelection=getNativeSelection;var testSelection=getNativeSelection(),testRange=api.createNativeRange(document),body=getBody(document),selectionHasAnchorAndFocus=util.areHostProperties(testSelection,["anchorNode","focusNode","anchorOffset","focusOffset"]);features.selectionHasAnchorAndFocus=selectionHasAnchorAndFocus;var selectionHasExtend=isHostMethod(testSelection,"extend");features.selectionHasExtend=selectionHasExtend;var selectionHasRangeCount=typeof testSelection.rangeCount==NUMBER;features.selectionHasRangeCount=selectionHasRangeCount;var selectionSupportsMultipleRanges=!1,collapsedNonEditableSelectionsSupported=!0,addRangeBackwardToNative=selectionHasExtend?function(nativeSelection,range){var doc=DomRange.getRangeDocument(range),endRange=api.createRange(doc);endRange.collapseToPoint(range.endContainer,range.endOffset),nativeSelection.addRange(getNativeRange(endRange)),nativeSelection.extend(range.startContainer,range.startOffset)}:null;util.areHostMethods(testSelection,["addRange","getRangeAt","removeAllRanges"])&&typeof testSelection.rangeCount==NUMBER&&features.implementsDomRange&&!function(){var sel=window.getSelection();if(sel){for(var originalSelectionRangeCount=sel.rangeCount,selectionHasMultipleRanges=originalSelectionRangeCount>1,originalSelectionRanges=[],originalSelectionBackward=winSelectionIsBackward(sel),i=0;originalSelectionRangeCount>i;++i)originalSelectionRanges[i]=sel.getRangeAt(i);var body=getBody(document),testEl=body.appendChild(document.createElementNS("http://www.w3.org/1999/xhtml","div"));testEl.contentEditable="false";var textNode=testEl.appendChild(document.createTextNode("Â Â Â ")),r1=document.createRange();if(r1.setStart(textNode,1),r1.collapse(!0),sel.addRange(r1),collapsedNonEditableSelectionsSupported=1==sel.rangeCount,sel.removeAllRanges(),!selectionHasMultipleRanges){var r2=r1.cloneRange();r1.setStart(textNode,0),r2.setEnd(textNode,3),r2.setStart(textNode,2),sel.addRange(r1),sel.addRange(r2),selectionSupportsMultipleRanges=2==sel.rangeCount,r2.detach()}for(body.removeChild(testEl),sel.removeAllRanges(),r1.detach(),i=0;originalSelectionRangeCount>i;++i)0==i&&originalSelectionBackward?addRangeBackwardToNative?addRangeBackwardToNative(sel,originalSelectionRanges[i]):(api.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because browser does not support Selection.extend"),sel.addRange(originalSelectionRanges[i])):sel.addRange(originalSelectionRanges[i])}}(),features.selectionSupportsMultipleRanges=selectionSupportsMultipleRanges,features.collapsedNonEditableSelectionsSupported=collapsedNonEditableSelectionsSupported;var testControlRange,implementsControlRange=!1;body&&isHostMethod(body,"createControlRange")&&(testControlRange=body.createControlRange(),util.areHostProperties(testControlRange,["item","add"])&&(implementsControlRange=!0)),features.implementsControlRange=implementsControlRange,selectionIsCollapsed=selectionHasAnchorAndFocus?function(sel){return sel.anchorNode===sel.focusNode&&sel.anchorOffset===sel.focusOffset}:function(sel){return sel.rangeCount?sel.getRangeAt(sel.rangeCount-1).collapsed:!1};var getSelectionRangeAt;isHostMethod(testSelection,"getRangeAt")?getSelectionRangeAt=function(sel,index){try{return sel.getRangeAt(index)}catch(ex){return null}}:selectionHasAnchorAndFocus&&(getSelectionRangeAt=function(sel){var doc=getDocument(sel.anchorNode),range=api.createRange(doc);return range.setStartAndEnd(sel.anchorNode,sel.anchorOffset,sel.focusNode,sel.focusOffset),range.collapsed!==this.isCollapsed&&range.setStartAndEnd(sel.focusNode,sel.focusOffset,sel.anchorNode,sel.anchorOffset),range}),WrappedSelection.prototype=api.selectionPrototype;var cachedRangySelections=[],getSelection=function(win){if(win&&win instanceof WrappedSelection)return win.refresh(),win;win=getWindow(win,"getNativeSelection");var sel=actOnCachedSelection(win),nativeSel=getNativeSelection(win),docSel=implementsDocSelection?getDocSelection(win):null;return sel?(sel.nativeSelection=nativeSel,sel.docSelection=docSel,sel.refresh()):(sel=new WrappedSelection(nativeSel,docSel,win),cachedRangySelections.push({win:win,selection:sel})),sel};api.getSelection=getSelection,api.getIframeSelection=function(iframeEl){return module.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),api.getSelection(dom.getIframeWindow(iframeEl))};var selProto=WrappedSelection.prototype;if(!useDocumentSelection&&selectionHasAnchorAndFocus&&util.areHostMethods(testSelection,["removeAllRanges","addRange"])){selProto.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),updateEmptySelection(this)};var addRangeBackward=function(sel,range){addRangeBackwardToNative(sel.nativeSelection,range),sel.refresh()};selProto.addRange=selectionHasRangeCount?function(range,direction){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL)addRangeToControlSelection(this,range);else if(isDirectionBackward(direction)&&selectionHasExtend)addRangeBackward(this,range);else{var previousRangeCount;if(selectionSupportsMultipleRanges?previousRangeCount=this.rangeCount:(this.removeAllRanges(),previousRangeCount=0),this.nativeSelection.addRange(getNativeRange(range).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==previousRangeCount+1){if(api.config.checkSelectionRanges){var nativeRange=getSelectionRangeAt(this.nativeSelection,this.rangeCount-1);nativeRange&&!rangesEqual(nativeRange,range)&&(range=new WrappedRange(nativeRange))}this._ranges[this.rangeCount-1]=range,updateAnchorAndFocusFromRange(this,range,selectionIsBackward(this.nativeSelection)),this.isCollapsed=selectionIsCollapsed(this)}else this.refresh()}}:function(range,direction){isDirectionBackward(direction)&&selectionHasExtend?addRangeBackward(this,range):(this.nativeSelection.addRange(getNativeRange(range)),this.refresh())},selProto.setRanges=function(ranges){if(implementsControlRange&&ranges.length>1)createControlSelection(this,ranges);else{this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)this.addRange(ranges[i])}}}else{if(!(isHostMethod(testSelection,"empty")&&isHostMethod(testRange,"select")&&implementsControlRange&&useDocumentSelection))return module.fail("No means of selecting a Range or TextRange was found"),!1;selProto.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var doc;if(this.anchorNode)doc=getDocument(this.anchorNode);else if(this.docSelection.type==CONTROL){var controlRange=this.docSelection.createRange();controlRange.length&&(doc=getDocument(controlRange.item(0)))}if(doc){var textRange=getBody(doc).createTextRange();textRange.select(),this.docSelection.empty()}}}catch(ex){}updateEmptySelection(this)},selProto.addRange=function(range){this.docSelection.type==CONTROL?addRangeToControlSelection(this,range):(api.WrappedTextRange.rangeToTextRange(range).select(),this._ranges[0]=range,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,updateAnchorAndFocusFromRange(this,range,!1))},selProto.setRanges=function(ranges){this.removeAllRanges();var rangeCount=ranges.length;rangeCount>1?createControlSelection(this,ranges):rangeCount&&this.addRange(ranges[0])}}selProto.getRangeAt=function(index){if(0>index||index>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");return this._ranges[index].cloneRange()};var refreshSelection;if(useDocumentSelection)refreshSelection=function(sel){var range;api.isSelectionValid(sel.win)?range=sel.docSelection.createRange():(range=getBody(sel.win.document).createTextRange(),range.collapse(!0)),sel.docSelection.type==CONTROL?updateControlSelection(sel):isTextRange(range)?updateFromTextRange(sel,range):updateEmptySelection(sel)};else if(isHostMethod(testSelection,"getRangeAt")&&typeof testSelection.rangeCount==NUMBER)refreshSelection=function(sel){if(implementsControlRange&&implementsDocSelection&&sel.docSelection.type==CONTROL)updateControlSelection(sel);else if(sel._ranges.length=sel.rangeCount=sel.nativeSelection.rangeCount,sel.rangeCount){for(var i=0,len=sel.rangeCount;len>i;++i)sel._ranges[i]=new api.WrappedRange(sel.nativeSelection.getRangeAt(i));updateAnchorAndFocusFromRange(sel,sel._ranges[sel.rangeCount-1],selectionIsBackward(sel.nativeSelection)),sel.isCollapsed=selectionIsCollapsed(sel)}else updateEmptySelection(sel)};else{if(!selectionHasAnchorAndFocus||typeof testSelection.isCollapsed!=BOOLEAN||typeof testRange.collapsed!=BOOLEAN||!features.implementsDomRange)return module.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;refreshSelection=function(sel){var range,nativeSel=sel.nativeSelection;nativeSel.anchorNode?(range=getSelectionRangeAt(nativeSel,0),sel._ranges=[range],sel.rangeCount=1,updateAnchorAndFocusFromNativeSelection(sel),sel.isCollapsed=selectionIsCollapsed(sel)):updateEmptySelection(sel)}}selProto.refresh=function(checkForChanges){var oldRanges=checkForChanges?this._ranges.slice(0):null,oldAnchorNode=this.anchorNode,oldAnchorOffset=this.anchorOffset;if(refreshSelection(this),checkForChanges){var i=oldRanges.length;if(i!=this._ranges.length)return!0;if(this.anchorNode!=oldAnchorNode||this.anchorOffset!=oldAnchorOffset)return!0;for(;i--;)if(!rangesEqual(oldRanges[i],this._ranges[i]))return!0;return!1}};var removeRangeManually=function(sel,range){var ranges=sel.getAllRanges();sel.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)rangesEqual(range,ranges[i])||sel.addRange(ranges[i]);sel.rangeCount||updateEmptySelection(sel)};selProto.removeRange=implementsControlRange?function(range){if(this.docSelection.type==CONTROL){for(var el,controlRange=this.docSelection.createRange(),rangeElement=getSingleElementFromRange(range),doc=getDocument(controlRange.item(0)),newControlRange=getBody(doc).createControlRange(),removed=!1,i=0,len=controlRange.length;len>i;++i)el=controlRange.item(i),el!==rangeElement||removed?newControlRange.add(controlRange.item(i)):removed=!0;newControlRange.select(),updateControlSelection(this)}else removeRangeManually(this,range)}:function(range){removeRangeManually(this,range)};var selectionIsBackward;!useDocumentSelection&&selectionHasAnchorAndFocus&&features.implementsDomRange?(selectionIsBackward=winSelectionIsBackward,selProto.isBackward=function(){return selectionIsBackward(this)}):selectionIsBackward=selProto.isBackward=function(){return!1
},selProto.isBackwards=selProto.isBackward,selProto.toString=function(){for(var rangeTexts=[],i=0,len=this.rangeCount;len>i;++i)rangeTexts[i]=""+this._ranges[i];return rangeTexts.join("")},selProto.collapse=function(node,offset){assertNodeInSameDocument(this,node);var range=api.createRange(node);range.collapseToPoint(node,offset),this.setSingleRange(range),this.isCollapsed=!0},selProto.collapseToStart=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[0];this.collapse(range.startContainer,range.startOffset)},selProto.collapseToEnd=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var range=this._ranges[this.rangeCount-1];this.collapse(range.endContainer,range.endOffset)},selProto.selectAllChildren=function(node){assertNodeInSameDocument(this,node);var range=api.createRange(node);range.selectNodeContents(node),this.setSingleRange(range)},selProto.deleteFromDocument=function(){if(implementsControlRange&&implementsDocSelection&&this.docSelection.type==CONTROL){for(var element,controlRange=this.docSelection.createRange();controlRange.length;)element=controlRange.item(0),controlRange.remove(element),element.parentNode.removeChild(element);this.refresh()}else if(this.rangeCount){var ranges=this.getAllRanges();if(ranges.length){this.removeAllRanges();for(var i=0,len=ranges.length;len>i;++i)ranges[i].deleteContents();this.addRange(ranges[len-1])}}},selProto.eachRange=function(func,returnValue){for(var i=0,len=this._ranges.length;len>i;++i)if(func(this.getRangeAt(i)))return returnValue},selProto.getAllRanges=function(){var ranges=[];return this.eachRange(function(range){ranges.push(range)}),ranges},selProto.setSingleRange=function(range,direction){this.removeAllRanges(),this.addRange(range,direction)},selProto.callMethodOnEachRange=function(methodName,params){var results=[];return this.eachRange(function(range){results.push(range[methodName].apply(range,params))}),results},selProto.setStart=createStartOrEndSetter(!0),selProto.setEnd=createStartOrEndSetter(!1),api.rangePrototype.select=function(direction){getSelection(this.getDocument()).setSingleRange(this,direction)},selProto.changeEachRange=function(func){var ranges=[],backward=this.isBackward();this.eachRange(function(range){func(range),ranges.push(range)}),this.removeAllRanges(),backward&&1==ranges.length?this.addRange(ranges[0],"backward"):this.setRanges(ranges)},selProto.containsNode=function(node,allowPartial){return this.eachRange(function(range){return range.containsNode(node,allowPartial)},!0)},selProto.getBookmark=function(containerNode){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[containerNode])}},selProto.moveToBookmark=function(bookmark){for(var rangeBookmark,range,selRanges=[],i=0;rangeBookmark=bookmark.rangeBookmarks[i++];)range=api.createRange(this.win),range.moveToBookmark(rangeBookmark),selRanges.push(range);bookmark.backward?this.setSingleRange(selRanges[0],"backward"):this.setRanges(selRanges)},selProto.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},selProto.getName=function(){return"WrappedSelection"},selProto.inspect=function(){return inspect(this)},selProto.detach=function(){actOnCachedSelection(this.win,"delete"),deleteProperties(this)},WrappedSelection.detachAll=function(){actOnCachedSelection(null,"deleteAll")},WrappedSelection.inspect=inspect,WrappedSelection.isDirectionBackward=isDirectionBackward,api.Selection=WrappedSelection,api.selectionPrototype=selProto,api.addCreateMissingNativeApiListener(function(win){"undefined"==typeof win.getSelection&&(win.getSelection=function(){return getSelection(win)}),win=null})}),define("rangy-core",["domReady"],function(global){return function(){var ret,fn;return fn=function(domReady){var rangi=this.rangy;return domReady(function(){rangi.init()}),this.rangy},ret=fn.apply(global,arguments),ret||global.rangy}}(this)),rangy.createModule("Highlighter",["ClassApplier"],function(api){function compareHighlights(h1,h2){return h1.characterRange.start-h2.characterRange.start}function HighlighterType(type,converterCreator){this.type=type,this.converterCreator=converterCreator}function registerHighlighterType(type,converterCreator){highlighterTypes[type]=new HighlighterType(type,converterCreator)}function getConverter(type){var highlighterType=highlighterTypes[type];if(highlighterType instanceof HighlighterType)return highlighterType.create();throw new Error("Highlighter type '"+type+"' is not valid")}function CharacterRange(start,end){this.start=start,this.end=end}function Highlight(doc,characterRange,classApplier,converter,id,containerElementId){id?(this.id=id,nextHighlightId=Math.max(nextHighlightId,id+1)):this.id=nextHighlightId++,this.characterRange=characterRange,this.doc=doc,this.classApplier=classApplier,this.converter=converter,this.containerElementId=containerElementId||null,this.applied=!1}function Highlighter(doc,type){type=type||"textContent",this.doc=doc||document,this.classAppliers={},this.highlights=[],this.converter=getConverter(type)}var dom=api.dom,contains=dom.arrayContains,getBody=dom.getBody,forEach=[].forEach?function(arr,func){arr.forEach(func)}:function(arr,func){for(var i=0,len=arr.length;len>i;++i)func(arr[i])},nextHighlightId=1,highlighterTypes={};HighlighterType.prototype.create=function(){var converter=this.converterCreator();return converter.type=this.type,converter},api.registerHighlighterType=registerHighlighterType,CharacterRange.prototype={intersects:function(charRange){return this.start<charRange.end&&this.end>charRange.start},union:function(charRange){return new CharacterRange(Math.min(this.start,charRange.start),Math.max(this.end,charRange.end))},intersection:function(charRange){return new CharacterRange(Math.max(this.start,charRange.start),Math.min(this.end,charRange.end))},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},CharacterRange.fromCharacterRange=function(charRange){return new CharacterRange(charRange.start,charRange.end)};var textContentConverter={rangeToCharacterRange:function(range,containerNode){var bookmark=range.getBookmark(containerNode);return new CharacterRange(bookmark.start,bookmark.end)},characterRangeToRange:function(doc,characterRange,containerNode){var range=api.createRange(doc);return range.moveToBookmark({start:characterRange.start,end:characterRange.end,containerNode:containerNode}),range},serializeSelection:function(selection,containerNode){for(var ranges=selection.getAllRanges(),rangeCount=ranges.length,rangeInfos=[],backward=1==rangeCount&&selection.isBackward(),i=0,len=ranges.length;len>i;++i)rangeInfos[i]={characterRange:this.rangeToCharacterRange(ranges[i],containerNode),backward:backward};return rangeInfos},restoreSelection:function(selection,savedSelection,containerNode){selection.removeAllRanges();for(var range,rangeInfo,characterRange,doc=selection.win.document,i=0,len=savedSelection.length;len>i;++i)rangeInfo=savedSelection[i],characterRange=rangeInfo.characterRange,range=this.characterRangeToRange(doc,rangeInfo.characterRange,containerNode),selection.addRange(range,rangeInfo.backward)}};registerHighlighterType("textContent",function(){return textContentConverter}),registerHighlighterType("TextRange",function(){var converter;return function(){if(!converter){var textRangeModule=api.modules.TextRange;if(!textRangeModule)throw new Error("TextRange module is missing.");if(!textRangeModule.supported)throw new Error("TextRange module is present but not supported.");converter={rangeToCharacterRange:function(range,containerNode){return CharacterRange.fromCharacterRange(range.toCharacterRange(containerNode))},characterRangeToRange:function(doc,characterRange,containerNode){var range=api.createRange(doc);return range.selectCharacters(containerNode,characterRange.start,characterRange.end),range},serializeSelection:function(selection,containerNode){return selection.saveCharacterRanges(containerNode)},restoreSelection:function(selection,savedSelection,containerNode){selection.restoreCharacterRanges(containerNode,savedSelection)}}}return converter}}()),Highlight.prototype={getContainerElement:function(){return this.containerElementId?this.doc.getElementById(this.containerElementId):getBody(this.doc)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(range){this.characterRange=this.converter.rangeToCharacterRange(range,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(el){return this.getRange().containsNodeContents(el.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.cssClass+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},Highlighter.prototype={addClassApplier:function(classApplier){this.classAppliers[classApplier.cssClass]=classApplier},getHighlightForElement:function(el){for(var highlights=this.highlights,i=0,len=highlights.length;len>i;++i)if(highlights[i].containsElement(el))return highlights[i];return null},removeHighlights:function(highlights){for(var highlight,i=0,len=this.highlights.length;len>i;++i)highlight=this.highlights[i],contains(highlights,highlight)&&(highlight.unapply(),this.highlights.splice(i--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(ranges){{var intersectingHighlights=[],highlights=this.highlights;this.converter}return forEach(ranges,function(range){forEach(highlights,function(highlight){range.intersectsRange(highlight.getRange())&&!contains(intersectingHighlights,highlight)&&intersectingHighlights.push(highlight)})}),intersectingHighlights},highlightCharacterRanges:function(className,charRanges,containerElementId){var i,len,j,highlights=this.highlights,converter=this.converter,doc=this.doc,highlightsToRemove=[],classApplier=this.classAppliers[className];containerElementId=containerElementId||null;var containerElement,containerElementRange,containerElementCharRange;containerElementId&&(containerElement=this.doc.getElementById(containerElementId),containerElement&&(containerElementRange=api.createRange(this.doc),containerElementRange.selectNodeContents(containerElement),containerElementCharRange=new CharacterRange(0,containerElementRange.toString().length),containerElementRange.detach()));var charRange,highlightCharRange,merged;for(i=0,len=charRanges.length;len>i;++i){for(charRange=charRanges[i],merged=!1,containerElementCharRange&&(charRange=charRange.intersection(containerElementCharRange)),j=0;j<highlights.length;++j)containerElementId==highlights[j].containerElementId&&(highlightCharRange=highlights[j].characterRange,highlightCharRange.intersects(charRange)&&(highlightsToRemove.push(highlights[j]),highlights[j]=new Highlight(doc,highlightCharRange.union(charRange),classApplier,converter,null,containerElementId)));merged||highlights.push(new Highlight(doc,charRange,classApplier,converter,null,containerElementId))}forEach(highlightsToRemove,function(highlightToRemove){highlightToRemove.unapply()});var newHighlights=[];return forEach(highlights,function(highlight){highlight.applied||(highlight.apply(),newHighlights.push(highlight))}),newHighlights},highlightRanges:function(className,ranges,containerElement){var containerElementRange,selCharRanges=[],converter=this.converter,containerElementId=containerElement?containerElement.id:null;return containerElement&&(containerElementRange=api.createRange(containerElement),containerElementRange.selectNodeContents(containerElement)),forEach(ranges,function(range){var scopedRange=containerElement?containerElementRange.intersection(range):range;selCharRanges.push(converter.rangeToCharacterRange(scopedRange,containerElement||getBody(range.getDocument())))}),this.highlightCharacterRanges(selCharRanges,ranges,containerElementId)},highlightSelection:function(className,selection,containerElementId){var converter=this.converter;selection=selection||api.getSelection();var classApplier=this.classAppliers[className],doc=selection.win.document,containerElement=containerElementId?doc.getElementById(containerElementId):getBody(doc);if(!classApplier)throw new Error("No class applier found for class '"+className+"'");var serializedSelection=converter.serializeSelection(selection,containerElement),selCharRanges=[];forEach(serializedSelection,function(rangeInfo){selCharRanges.push(CharacterRange.fromCharacterRange(rangeInfo.characterRange))});var newHighlights=this.highlightCharacterRanges(className,selCharRanges,containerElementId);return converter.restoreSelection(selection,serializedSelection,containerElement),newHighlights},unhighlightSelection:function(selection){selection=selection||api.getSelection();var intersectingHighlights=this.getIntersectingHighlights(selection.getAllRanges());return this.removeHighlights(intersectingHighlights),selection.removeAllRanges(),intersectingHighlights},getHighlightsInSelection:function(selection){return selection=selection||api.getSelection(),this.getIntersectingHighlights(selection.getAllRanges())},selectionOverlapsHighlight:function(selection){return this.getHighlightsInSelection(selection).length>0},serialize:function(options){var highlights=this.highlights;highlights.sort(compareHighlights);var serializedHighlights=["type:"+this.converter.type];return forEach(highlights,function(highlight){var characterRange=highlight.characterRange,parts=[characterRange.start,characterRange.end,highlight.id,highlight.classApplier.cssClass,highlight.containerElementId];options&&options.serializeHighlightText&&parts.push(highlight.getText()),serializedHighlights.push(parts.join("$"))}),serializedHighlights.join("|")},deserialize:function(serialized){var regexResult,serializationType,serializationConverter,serializedHighlights=serialized.split("|"),highlights=[],firstHighlight=serializedHighlights[0],convertType=!1;if(!firstHighlight||!(regexResult=/^type:(\w+)$/.exec(firstHighlight)))throw new Error("Serialized highlights are invalid.");serializationType=regexResult[1],serializationType!=this.converter.type&&(serializationConverter=getConverter(serializationType),convertType=!0),serializedHighlights.shift();for(var classApplier,highlight,characterRange,containerElementId,containerElement,parts,i=serializedHighlights.length;i-->0;)parts=serializedHighlights[i].split("$"),characterRange=new CharacterRange(+parts[0],+parts[1]),containerElementId=parts[4]||null,containerElement=containerElementId?this.doc.getElementById(containerElementId):getBody(this.doc),convertType&&(characterRange=this.converter.rangeToCharacterRange(serializationConverter.characterRangeToRange(this.doc,characterRange,containerElement),containerElement)),classApplier=this.classAppliers[parts[3]],highlight=new Highlight(this.doc,characterRange,classApplier,this.converter,parseInt(parts[2]),containerElementId),highlight.apply(),highlights.push(highlight);this.highlights=highlights}},api.Highlighter=Highlighter,api.createHighlighter=function(doc,rangeCharacterOffsetConverterType){return new Highlighter(doc,rangeCharacterOffsetConverterType)}}),define("rangy-highlighter",["rangy-core"],function(global){return function(){var ret;return ret||global.rangy.modules.Highlighter}}(this)),rangy.createModule("ClassApplier",["WrappedSelection"],function(api,module){function each(obj,func){for(var i in obj)if(obj.hasOwnProperty(i)&&func(i,obj[i])===!1)return!1;return!0}function trim(str){return str.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function hasClass(el,cssClass){return el.className&&new RegExp("(?:^|\\s)"+cssClass+"(?:\\s|$)").test(el.className)}function addClass(el,cssClass){el.className?hasClass(el,cssClass)||(el.className+=" "+cssClass):el.className=cssClass}function sortClassName(className){return className.split(/\s+/).sort().join(" ")}function getSortedClassName(el){return sortClassName(el.className)}function haveSameClasses(el1,el2){return getSortedClassName(el1)==getSortedClassName(el2)}function movePosition(position,oldParent,oldIndex,newParent,newIndex){var node=position.node,offset=position.offset,newNode=node,newOffset=offset;node==newParent&&offset>newIndex&&++newOffset,node!=oldParent||offset!=oldIndex&&offset!=oldIndex+1||(newNode=newParent,newOffset+=newIndex-oldIndex),node==oldParent&&offset>oldIndex+1&&--newOffset,position.node=newNode,position.offset=newOffset}function movePositionWhenRemovingNode(position,parentNode,index){position.node==parentNode&&position.offset>index&&--position.offset}function movePreservingPositions(node,newParent,newIndex,positionsToPreserve){-1==newIndex&&(newIndex=newParent.childNodes.length);for(var position,oldParent=node.parentNode,oldIndex=dom.getNodeIndex(node),i=0;position=positionsToPreserve[i++];)movePosition(position,oldParent,oldIndex,newParent,newIndex);newParent.childNodes.length==newIndex?newParent.appendChild(node):newParent.insertBefore(node,newParent.childNodes[newIndex])}function removePreservingPositions(node,positionsToPreserve){for(var position,oldParent=node.parentNode,oldIndex=dom.getNodeIndex(node),i=0;position=positionsToPreserve[i++];)movePositionWhenRemovingNode(position,oldParent,oldIndex);node.parentNode.removeChild(node)}function moveChildrenPreservingPositions(node,newParent,newIndex,removeNode,positionsToPreserve){for(var child,children=[];child=node.firstChild;)movePreservingPositions(child,newParent,newIndex++,positionsToPreserve),children.push(child);return removeNode&&node.parentNode.removeChild(node),children}function replaceWithOwnChildrenPreservingPositions(element,positionsToPreserve){return moveChildrenPreservingPositions(element,element.parentNode,dom.getNodeIndex(element),!0,positionsToPreserve)}function rangeSelectsAnyText(range,textNode){var textNodeRange=range.cloneRange();textNodeRange.selectNodeContents(textNode);var intersectionRange=textNodeRange.intersection(range),text=intersectionRange?intersectionRange.toString():"";return textNodeRange.detach(),""!=text}function getEffectiveTextNodes(range){for(var node,nodes=range.getNodes([3]),start=0;(node=nodes[start])&&!rangeSelectsAnyText(range,node);)++start;for(var end=nodes.length-1;(node=nodes[end])&&!rangeSelectsAnyText(range,node);)--end;return nodes.slice(start,end+1)}function elementsHaveSameNonClassAttributes(el1,el2){if(el1.attributes.length!=el2.attributes.length)return!1;for(var attr1,attr2,name,i=0,len=el1.attributes.length;len>i;++i)if(attr1=el1.attributes[i],name=attr1.name,"class"!=name){if(attr2=el2.attributes.getNamedItem(name),null===attr1!=(null===attr2))return!1;if(attr1.specified!=attr2.specified)return!1;if(attr1.specified&&attr1.nodeValue!==attr2.nodeValue)return!1}return!0}function elementHasNonClassAttributes(el,exceptions){for(var attrName,i=0,len=el.attributes.length;len>i;++i)if(attrName=el.attributes[i].name,(!exceptions||!contains(exceptions,attrName))&&el.attributes[i].specified&&"class"!=attrName)return!0;return!1}function elementHasProperties(el,props){return each(props,function(p,propValue){if("object"==typeof propValue){if(!elementHasProperties(el[p],propValue))return!1}else if(el[p]!==propValue)return!1}),!0}function isEditingHost(node){var parent;return node&&1==node.nodeType&&((parent=node.parentNode)&&9==parent.nodeType&&"on"==parent.designMode||isEditableElement(node)&&!isEditableElement(node.parentNode))}function isEditable(node){return(isEditableElement(node)||1!=node.nodeType&&isEditableElement(node.parentNode))&&!isEditingHost(node)}function isNonInlineElement(node){return node&&1==node.nodeType&&!inlineDisplayRegex.test(getComputedStyleProperty(node,"display"))}function isUnrenderedWhiteSpaceNode(node){if(0==node.data.length)return!0;if(htmlNonWhiteSpaceRegex.test(node.data))return!1;var cssWhiteSpace=getComputedStyleProperty(node.parentNode,"whiteSpace");switch(cssWhiteSpace){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(node.data))return!1}return isNonInlineElement(node.previousSibling)||isNonInlineElement(node.nextSibling)}function getRangeBoundaries(ranges){var i,range,positions=[];for(i=0;range=ranges[i++];)positions.push(new DomPosition(range.startContainer,range.startOffset),new DomPosition(range.endContainer,range.endOffset));return positions}function updateRangesFromBoundaries(ranges,positions){for(var range,start,end,i=0,len=ranges.length;len>i;++i)range=ranges[i],start=positions[2*i],end=positions[2*i+1],range.setStartAndEnd(start.node,start.offset,end.node,end.offset)}function isSplitPoint(node,offset){return dom.isCharacterDataNode(node)?0==offset?!!node.previousSibling:offset==node.length?!!node.nextSibling:!0:offset>0&&offset<node.childNodes.length}function splitNodeAt(node,descendantNode,descendantOffset,positionsToPreserve){var newNode,parentNode,splitAtStart=0==descendantOffset;if(dom.isAncestorOf(descendantNode,node))return node;if(dom.isCharacterDataNode(descendantNode)){var descendantIndex=dom.getNodeIndex(descendantNode);if(0==descendantOffset)descendantOffset=descendantIndex;else{if(descendantOffset!=descendantNode.length)throw module.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+descendantOffset+" in "+descendantNode.data);descendantOffset=descendantIndex+1}descendantNode=descendantNode.parentNode}if(isSplitPoint(descendantNode,descendantOffset)){newNode=descendantNode.cloneNode(!1),parentNode=descendantNode.parentNode,newNode.id&&newNode.removeAttribute("id");for(var child,newChildIndex=0;child=descendantNode.childNodes[descendantOffset];)movePreservingPositions(child,newNode,newChildIndex++,positionsToPreserve);return movePreservingPositions(newNode,parentNode,dom.getNodeIndex(descendantNode)+1,positionsToPreserve),descendantNode==node?newNode:splitNodeAt(node,parentNode,dom.getNodeIndex(newNode),positionsToPreserve)}if(node!=descendantNode){newNode=descendantNode.parentNode;var newNodeIndex=dom.getNodeIndex(descendantNode);return splitAtStart||newNodeIndex++,splitNodeAt(node,newNode,newNodeIndex,positionsToPreserve)}return node}function areElementsMergeable(el1,el2){return el1.tagName==el2.tagName&&haveSameClasses(el1,el2)&&elementsHaveSameNonClassAttributes(el1,el2)&&"inline"==getComputedStyleProperty(el1,"display")&&"inline"==getComputedStyleProperty(el2,"display")}function createAdjacentMergeableTextNodeGetter(forward){var siblingPropName=forward?"nextSibling":"previousSibling";return function(textNode,checkParentElement){var el=textNode.parentNode,adjacentNode=textNode[siblingPropName];if(adjacentNode){if(adjacentNode&&3==adjacentNode.nodeType)return adjacentNode}else if(checkParentElement&&(adjacentNode=el[siblingPropName],adjacentNode&&1==adjacentNode.nodeType&&areElementsMergeable(el,adjacentNode))){var adjacentNodeChild=adjacentNode[forward?"firstChild":"lastChild"];if(adjacentNodeChild&&3==adjacentNodeChild.nodeType)return adjacentNodeChild}return null}}function Merge(firstNode){this.isElementMerge=1==firstNode.nodeType,this.textNodes=[];var firstTextNode=this.isElementMerge?firstNode.lastChild:firstNode;firstTextNode&&(this.textNodes[0]=firstTextNode)}function ClassApplier(cssClass,options,tagNames){var normalize,i,len,propName,applier=this;applier.cssClass=cssClass;var elementPropertiesFromOptions=null,elementAttributes={};if("object"==typeof options&&null!==options){for(tagNames=options.tagNames,elementPropertiesFromOptions=options.elementProperties,elementAttributes=options.elementAttributes,i=0;propName=optionProperties[i++];)options.hasOwnProperty(propName)&&(applier[propName]=options[propName]);normalize=options.normalize}else normalize=options;applier.normalize="undefined"==typeof normalize?!0:normalize,applier.attrExceptions=[];var el=document.createElementNS("http://www.w3.org/1999/xhtml",applier.elementTagName);applier.elementProperties=applier.copyPropertiesToElement(elementPropertiesFromOptions,el,!0),each(elementAttributes,function(attrName){applier.attrExceptions.push(attrName)}),applier.elementAttributes=elementAttributes,applier.elementSortedClassName=applier.elementProperties.hasOwnProperty("className")?applier.elementProperties.className:cssClass,applier.applyToAnyTagName=!1;var type=typeof tagNames;if("string"==type)"*"==tagNames?applier.applyToAnyTagName=!0:applier.tagNames=trim(tagNames.toLowerCase()).split(/\s*,\s*/);else if("object"==type&&"number"==typeof tagNames.length)for(applier.tagNames=[],i=0,len=tagNames.length;len>i;++i)"*"==tagNames[i]?applier.applyToAnyTagName=!0:applier.tagNames.push(tagNames[i].toLowerCase());else applier.tagNames=[applier.elementTagName]}function createClassApplier(cssClass,options,tagNames){return new ClassApplier(cssClass,options,tagNames)}var dom=api.dom,DomPosition=dom.DomPosition,contains=dom.arrayContains,defaultTagName="span",removeClass=function(){function replacer(matched,whiteSpaceBefore,whiteSpaceAfter){return whiteSpaceBefore&&whiteSpaceAfter?" ":""}return function(el,cssClass){el.className&&(el.className=el.className.replace(new RegExp("(^|\\s)"+cssClass+"(\\s|$)"),replacer))}}(),getComputedStyleProperty=dom.getComputedStyleProperty,isEditableElement=function(){var testEl=document.createElementNS("http://www.w3.org/1999/xhtml","div");return"boolean"==typeof testEl.isContentEditable?function(node){return node&&1==node.nodeType&&node.isContentEditable}:function(node){return node&&1==node.nodeType&&"false"!=node.contentEditable?"true"==node.contentEditable||isEditableElement(node.parentNode):!1}}(),inlineDisplayRegex=/^inline(-block|-table)?$/i,htmlNonWhiteSpaceRegex=/[^\r\n\t\f \u200B]/,getPreviousMergeableTextNode=createAdjacentMergeableTextNodeGetter(!1),getNextMergeableTextNode=createAdjacentMergeableTextNodeGetter(!0);Merge.prototype={doMerge:function(positionsToPreserve){var textNodes=this.textNodes,firstTextNode=textNodes[0];if(textNodes.length>1){for(var textNode,parent,j,position,textParts=[],combinedTextLength=0,i=0,len=textNodes.length;len>i;++i){if(textNode=textNodes[i],parent=textNode.parentNode,i>0&&(parent.removeChild(textNode),parent.hasChildNodes()||parent.parentNode.removeChild(parent),positionsToPreserve))for(j=0;position=positionsToPreserve[j++];)position.node==textNode&&(position.node=firstTextNode,position.offset+=combinedTextLength);textParts[i]=textNode.data,combinedTextLength+=textNode.data.length}firstTextNode.data=textParts.join("")}return firstTextNode.data},getLength:function(){for(var i=this.textNodes.length,len=0;i--;)len+=this.textNodes[i].length;return len},toString:function(){for(var textParts=[],i=0,len=this.textNodes.length;len>i;++i)textParts[i]="'"+this.textNodes[i].data+"'";return"[Merge("+textParts.join(",")+")]"}};var optionProperties=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],attrNamesForProperties={};ClassApplier.prototype={elementTagName:defaultTagName,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(props,el,createCopy){var s,elStyle,elPropsStyle,propValue,elPropValue,attrName,elProps={};for(var p in props)if(props.hasOwnProperty(p))if(propValue=props[p],elPropValue=el[p],"className"==p)addClass(el,propValue),addClass(el,this.cssClass),el[p]=sortClassName(el[p]),createCopy&&(elProps[p]=el[p]);else if("style"==p){elStyle=elPropValue,createCopy&&(elProps[p]=elPropsStyle={});for(s in props[p])elStyle[s]=propValue[s],createCopy&&(elPropsStyle[s]=elStyle[s]);this.attrExceptions.push(p)}else el[p]=propValue,createCopy&&(elProps[p]=el[p],attrName=attrNamesForProperties.hasOwnProperty(p)?attrNamesForProperties[p]:p,this.attrExceptions.push(attrName));return createCopy?elProps:""},copyAttributesToElement:function(attrs,el){for(var attrName in attrs)attrs.hasOwnProperty(attrName)&&el.setAttribute(attrName,attrs[attrName])},hasClass:function(node){return 1==node.nodeType&&contains(this.tagNames,node.tagName.toLowerCase())&&hasClass(node,this.cssClass)},getSelfOrAncestorWithClass:function(node){for(;node;){if(this.hasClass(node))return node;node=node.parentNode}return null},isModifiable:function(node){return!this.applyToEditableOnly||isEditable(node)},isIgnorableWhiteSpaceNode:function(node){return this.ignoreWhiteSpace&&node&&3==node.nodeType&&isUnrenderedWhiteSpaceNode(node)},postApply:function(textNodes,range,positionsToPreserve,isUndo){for(var currentMerge,textNode,precedingTextNode,firstNode=textNodes[0],lastNode=textNodes[textNodes.length-1],merges=[],rangeStartNode=firstNode,rangeEndNode=lastNode,rangeStartOffset=0,rangeEndOffset=lastNode.length,i=0,len=textNodes.length;len>i;++i)textNode=textNodes[i],precedingTextNode=getPreviousMergeableTextNode(textNode,!isUndo),precedingTextNode?(currentMerge||(currentMerge=new Merge(precedingTextNode),merges.push(currentMerge)),currentMerge.textNodes.push(textNode),textNode===firstNode&&(rangeStartNode=currentMerge.textNodes[0],rangeStartOffset=rangeStartNode.length),textNode===lastNode&&(rangeEndNode=currentMerge.textNodes[0],rangeEndOffset=currentMerge.getLength())):currentMerge=null;var nextTextNode=getNextMergeableTextNode(lastNode,!isUndo);if(nextTextNode&&(currentMerge||(currentMerge=new Merge(lastNode),merges.push(currentMerge)),currentMerge.textNodes.push(nextTextNode)),merges.length){for(i=0,len=merges.length;len>i;++i)merges[i].doMerge(positionsToPreserve);range.setStartAndEnd(rangeStartNode,rangeStartOffset,rangeEndNode,rangeEndOffset)}},createContainer:function(doc){var el=doc.createElementNS("http://www.w3.org/1999/xhtml",this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,el,!1),this.copyAttributesToElement(this.elementAttributes,el),addClass(el,this.cssClass),this.onElementCreate&&this.onElementCreate(el,this),el},applyToTextNode:function(textNode){var parent=textNode.parentNode;if(1==parent.childNodes.length&&this.useExistingElements&&contains(this.tagNames,parent.tagName.toLowerCase())&&elementHasProperties(parent,this.elementProperties))addClass(parent,this.cssClass);else{var el=this.createContainer(dom.getDocument(textNode));textNode.parentNode.insertBefore(el,textNode),el.appendChild(textNode)}},isRemovable:function(el){return el.tagName.toLowerCase()==this.elementTagName&&getSortedClassName(el)==this.elementSortedClassName&&elementHasProperties(el,this.elementProperties)&&!elementHasNonClassAttributes(el,this.attrExceptions)&&this.isModifiable(el)},isEmptyContainer:function(el){var childNodeCount=el.childNodes.length;return 1==el.nodeType&&this.isRemovable(el)&&(0==childNodeCount||1==childNodeCount&&this.isEmptyContainer(el.firstChild))},removeEmptyContainers:function(range){for(var node,applier=this,nodesToRemove=range.getNodes([1],function(el){return applier.isEmptyContainer(el)}),rangesToPreserve=[range],positionsToPreserve=getRangeBoundaries(rangesToPreserve),i=0;node=nodesToRemove[i++];)removePreservingPositions(node,positionsToPreserve);updateRangesFromBoundaries(rangesToPreserve,positionsToPreserve)},undoToTextNode:function(textNode,range,ancestorWithClass,positionsToPreserve){if(!range.containsNode(ancestorWithClass)){var ancestorRange=range.cloneRange();ancestorRange.selectNode(ancestorWithClass),ancestorRange.isPointInRange(range.endContainer,range.endOffset)&&(splitNodeAt(ancestorWithClass,range.endContainer,range.endOffset,positionsToPreserve),range.setEndAfter(ancestorWithClass)),ancestorRange.isPointInRange(range.startContainer,range.startOffset)&&(ancestorWithClass=splitNodeAt(ancestorWithClass,range.startContainer,range.startOffset,positionsToPreserve))}this.isRemovable(ancestorWithClass)?replaceWithOwnChildrenPreservingPositions(ancestorWithClass,positionsToPreserve):removeClass(ancestorWithClass,this.cssClass)
},applyToRange:function(range,rangesToPreserve){rangesToPreserve=rangesToPreserve||[];var positionsToPreserve=getRangeBoundaries(rangesToPreserve||[]);range.splitBoundariesPreservingPositions(positionsToPreserve),this.removeEmptyElements&&this.removeEmptyContainers(range);var textNodes=getEffectiveTextNodes(range);if(textNodes.length){for(var textNode,i=0;textNode=textNodes[i++];)this.isIgnorableWhiteSpaceNode(textNode)||this.getSelfOrAncestorWithClass(textNode)||!this.isModifiable(textNode)||this.applyToTextNode(textNode,positionsToPreserve);textNode=textNodes[textNodes.length-1],range.setStartAndEnd(textNodes[0],0,textNode,textNode.length),this.normalize&&this.postApply(textNodes,range,positionsToPreserve,!1),updateRangesFromBoundaries(rangesToPreserve,positionsToPreserve)}},applyToRanges:function(ranges){for(var i=ranges.length;i--;)this.applyToRange(ranges[i],ranges);return ranges},applyToSelection:function(win){var sel=api.getSelection(win);sel.setRanges(this.applyToRanges(sel.getAllRanges()))},undoToRange:function(range,rangesToPreserve){rangesToPreserve=rangesToPreserve||[];var positionsToPreserve=getRangeBoundaries(rangesToPreserve);range.splitBoundariesPreservingPositions(positionsToPreserve),this.removeEmptyElements&&this.removeEmptyContainers(range,positionsToPreserve);var textNode,ancestorWithClass,textNodes=getEffectiveTextNodes(range),lastTextNode=textNodes[textNodes.length-1];if(textNodes.length){for(var i=0,len=textNodes.length;len>i;++i)textNode=textNodes[i],ancestorWithClass=this.getSelfOrAncestorWithClass(textNode),ancestorWithClass&&this.isModifiable(textNode)&&this.undoToTextNode(textNode,range,ancestorWithClass,positionsToPreserve),range.setStartAndEnd(textNodes[0],0,lastTextNode,lastTextNode.length);this.normalize&&this.postApply(textNodes,range,positionsToPreserve,!0),updateRangesFromBoundaries(rangesToPreserve,positionsToPreserve)}},undoToRanges:function(ranges){for(var i=ranges.length;i--;)this.undoToRange(ranges[i],ranges);return ranges},undoToSelection:function(win){var sel=api.getSelection(win),ranges=api.getSelection(win).getAllRanges();this.undoToRanges(ranges),sel.setRanges(ranges)},isAppliedToRange:function(range){if(range.collapsed||""==range.toString())return!!this.getSelfOrAncestorWithClass(range.commonAncestorContainer);var textNodes=range.getNodes([3]);if(textNodes.length)for(var textNode,i=0;textNode=textNodes[i++];)if(!this.isIgnorableWhiteSpaceNode(textNode)&&rangeSelectsAnyText(range,textNode)&&this.isModifiable(textNode)&&!this.getSelfOrAncestorWithClass(textNode))return!1;return!0},isAppliedToRanges:function(ranges){var i=ranges.length;if(0==i)return!1;for(;i--;)if(!this.isAppliedToRange(ranges[i]))return!1;return!0},isAppliedToSelection:function(win){var sel=api.getSelection(win);return this.isAppliedToRanges(sel.getAllRanges())},toggleRange:function(range){this.isAppliedToRange(range)?this.undoToRange(range):this.applyToRange(range)},toggleSelection:function(win){this.isAppliedToSelection(win)?this.undoToSelection(win):this.applyToSelection(win)},getElementsWithClassIntersectingRange:function(range){var elements=[],applier=this;return range.getNodes([3],function(textNode){var el=applier.getSelfOrAncestorWithClass(textNode);el&&!contains(elements,el)&&elements.push(el)}),elements},detach:function(){}},ClassApplier.util={hasClass:hasClass,addClass:addClass,removeClass:removeClass,hasSameClasses:haveSameClasses,replaceWithOwnChildren:replaceWithOwnChildrenPreservingPositions,elementsHaveSameNonClassAttributes:elementsHaveSameNonClassAttributes,elementHasNonClassAttributes:elementHasNonClassAttributes,splitNodeAt:splitNodeAt,isEditableElement:isEditableElement,isEditingHost:isEditingHost,isEditable:isEditable},api.CssClassApplier=api.ClassApplier=ClassApplier,api.createCssClassApplier=api.createClassApplier=createClassApplier}),define("rangy-cssclassapplier",["rangy-core"],function(global){return function(){var ret;return ret||global.rangy.modules.ClassApplier}}(this)),rangy.createModule("TextRange",["WrappedSelection"],function(api,module){function defaultTokenizer(chars,wordOptions){function createTokenFromRange(start,end,isWord){for(var tokenChars=chars.slice(start,end),token={isWord:isWord,chars:tokenChars,toString:function(){return tokenChars.join("")}},i=0,len=tokenChars.length;len>i;++i)tokenChars[i].token=token;tokens.push(token)}for(var result,wordStart,wordEnd,word=chars.join(""),tokens=[],lastWordEnd=0;result=wordOptions.wordRegex.exec(word);){if(wordStart=result.index,wordEnd=wordStart+result[0].length,wordStart>lastWordEnd&&createTokenFromRange(lastWordEnd,wordStart,!1),wordOptions.includeTrailingSpace)for(;nonLineBreakWhiteSpaceRegex.test(chars[wordEnd]);)++wordEnd;createTokenFromRange(wordStart,wordEnd,!0),lastWordEnd=wordEnd}return lastWordEnd<chars.length&&createTokenFromRange(lastWordEnd,chars.length,!1),tokens}function createOptions(optionsParam,defaults){if(optionsParam){var options={};return extend(options,defaults),extend(options,optionsParam),options}return defaults}function createWordOptions(options){var lang,defaults;return options?(lang=options.language||defaultLanguage,defaults={},extend(defaults,defaultWordOptions[lang]||defaultWordOptions[defaultLanguage]),extend(defaults,options),defaults):defaultWordOptions[defaultLanguage]}function createCharacterOptions(options){return createOptions(options,defaultCharacterOptions)}function createCaretCharacterOptions(options){return createOptions(options,defaultCaretCharacterOptions)}function getComputedDisplay(el,win){var display=getComputedStyleProperty(el,"display",win),tagName=el.tagName.toLowerCase();return"block"==display&&tableCssDisplayBlock&&defaultDisplayValueForTag.hasOwnProperty(tagName)?defaultDisplayValueForTag[tagName]:display}function isHidden(node){for(var ancestors=getAncestorsAndSelf(node),i=0,len=ancestors.length;len>i;++i)if(1==ancestors[i].nodeType&&"none"==getComputedDisplay(ancestors[i]))return!0;return!1}function isVisibilityHiddenTextNode(textNode){var el;return 3==textNode.nodeType&&(el=textNode.parentNode)&&"hidden"==getComputedStyleProperty(el,"visibility")}function isBlockNode(node){return node&&(1==node.nodeType&&!/^(inline(-block|-table)?|none)$/.test(getComputedDisplay(node))||9==node.nodeType||11==node.nodeType)}function containsPositions(node){return dom.isCharacterDataNode(node)||!/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i.test(node.nodeName)}function getAncestors(node){for(var ancestors=[];node.parentNode;)ancestors.unshift(node.parentNode),node=node.parentNode;return ancestors}function getAncestorsAndSelf(node){return getAncestors(node).concat([node])}function nextNodeDescendants(node){for(;node&&!node.nextSibling;)node=node.parentNode;return node?node.nextSibling:null}function nextNode(node,excludeChildren){return!excludeChildren&&node.hasChildNodes()?node.firstChild:nextNodeDescendants(node)}function previousNode(node){var previous=node.previousSibling;if(previous){for(node=previous;node.hasChildNodes();)node=node.lastChild;return node}var parent=node.parentNode;return parent&&1==parent.nodeType?parent:null}function isWhitespaceNode(node){if(!node||3!=node.nodeType)return!1;var text=node.data;if(""===text)return!0;var parent=node.parentNode;if(!parent||1!=parent.nodeType)return!1;var computedWhiteSpace=getComputedStyleProperty(node.parentNode,"whiteSpace");return/^[\t\n\r ]+$/.test(text)&&/^(normal|nowrap)$/.test(computedWhiteSpace)||/^[\t\r ]+$/.test(text)&&"pre-line"==computedWhiteSpace}function isCollapsedWhitespaceNode(node){if(""===node.data)return!0;if(!isWhitespaceNode(node))return!1;var ancestor=node.parentNode;return ancestor?isHidden(node)?!0:!1:!0}function isCollapsedNode(node){var type=node.nodeType;return 7==type||8==type||isHidden(node)||/^(script|style)$/i.test(node.nodeName)||isVisibilityHiddenTextNode(node)||isCollapsedWhitespaceNode(node)}function isIgnoredNode(node,win){var type=node.nodeType;return 7==type||8==type||1==type&&"none"==getComputedDisplay(node,win)}function Cache(){this.store={}}function createCachingGetter(methodName,func,objProperty){return function(args){var cache=this.cache;if(cache.hasOwnProperty(methodName))return cachedCount++,cache[methodName];uncachedCount++;var value=func.call(this,objProperty?this[objProperty]:this,args);return cache[methodName]=value,value}}function NodeWrapper(node,session){this.node=node,this.session=session,this.cache=new Cache,this.positions=new Cache}function Position(nodeWrapper,offset){this.offset=offset,this.nodeWrapper=nodeWrapper,this.node=nodeWrapper.node,this.session=nodeWrapper.session,this.cache=new Cache}function inspectPosition(){return"[Position("+dom.inspectNode(this.node)+":"+this.offset+")]"}function startSession(){return endSession(),currentSession=new Session}function getSession(){return currentSession||startSession()}function endSession(){currentSession&&currentSession.detach(),currentSession=null}function createCharacterIterator(startPos,backward,endPos,characterOptions){function next(){var charPos=null;return backward?(charPos=pos,finished||(pos=pos.previousVisible(),finished=!pos||endPos&&pos.equals(endPos))):finished||(charPos=pos=pos.nextVisible(),finished=!pos||endPos&&pos.equals(endPos)),finished&&(pos=null),charPos}endPos&&(backward?isCollapsedNode(endPos.node)&&(endPos=startPos.previousVisible()):isCollapsedNode(endPos.node)&&(endPos=endPos.nextVisible()));var previousTextPos,pos=startPos,finished=!1,returnPreviousTextPos=!1;return{next:function(){if(returnPreviousTextPos)return returnPreviousTextPos=!1,previousTextPos;for(var pos,character;pos=next();)if(character=pos.getCharacter(characterOptions))return previousTextPos=pos,pos;return null},rewind:function(){if(!previousTextPos)throw module.createError("createCharacterIterator: cannot rewind. Only one position can be rewound.");returnPreviousTextPos=!0},dispose:function(){startPos=endPos=null}}}function createTokenizedTextProvider(pos,characterOptions,wordOptions){function consumeWord(forward){for(var pos,textChar,newChars=[],it=forward?forwardIterator:backwardIterator,passedWordBoundary=!1,insideWord=!1;pos=it.next();){if(textChar=pos.character,allWhiteSpaceRegex.test(textChar))insideWord&&(insideWord=!1,passedWordBoundary=!0);else{if(passedWordBoundary){it.rewind();break}insideWord=!0}newChars.push(pos)}return newChars}var forwardIterator=createCharacterIterator(pos,!1,null,characterOptions),backwardIterator=createCharacterIterator(pos,!0,null,characterOptions),tokenizer=wordOptions.tokenizer,forwardChars=consumeWord(!0),backwardChars=consumeWord(!1).reverse(),tokens=tokenizer(backwardChars.concat(forwardChars),wordOptions),forwardTokensBuffer=forwardChars.length?tokens.slice(arrayIndexOf(tokens,forwardChars[0].token)):[],backwardTokensBuffer=backwardChars.length?tokens.slice(0,arrayIndexOf(tokens,backwardChars.pop().token)+1):[];return{nextEndToken:function(){for(var lastToken,forwardChars;1==forwardTokensBuffer.length&&!(lastToken=forwardTokensBuffer[0]).isWord&&(forwardChars=consumeWord(!0)).length>0;)forwardTokensBuffer=tokenizer(lastToken.chars.concat(forwardChars),wordOptions);return forwardTokensBuffer.shift()},previousStartToken:function(){for(var lastToken,backwardChars;1==backwardTokensBuffer.length&&!(lastToken=backwardTokensBuffer[0]).isWord&&(backwardChars=consumeWord(!1)).length>0;)backwardTokensBuffer=tokenizer(backwardChars.reverse().concat(lastToken.chars),wordOptions);return backwardTokensBuffer.pop()},dispose:function(){forwardIterator.dispose(),backwardIterator.dispose(),forwardTokensBuffer=backwardTokensBuffer=null}}}function movePositionBy(pos,unit,count,characterOptions,wordOptions){var currentPos,charIterator,nextPos,token,unitsMoved=0,newPos=pos,absCount=Math.abs(count);if(0!==count){var backward=0>count;switch(unit){case CHARACTER:for(charIterator=createCharacterIterator(pos,backward,null,characterOptions);(currentPos=charIterator.next())&&absCount>unitsMoved;)++unitsMoved,newPos=currentPos;nextPos=currentPos,charIterator.dispose();break;case WORD:for(var tokenizedTextProvider=createTokenizedTextProvider(pos,characterOptions,wordOptions),next=backward?tokenizedTextProvider.previousStartToken:tokenizedTextProvider.nextEndToken;(token=next())&&absCount>unitsMoved;)token.isWord&&(++unitsMoved,newPos=backward?token.chars[0]:token.chars[token.chars.length-1]);break;default:throw new Error("movePositionBy: unit '"+unit+"' not implemented")}backward?(newPos=newPos.previousVisible(),unitsMoved=-unitsMoved):newPos&&newPos.isLeadingSpace&&(unit==WORD&&(charIterator=createCharacterIterator(pos,!1,null,characterOptions),nextPos=charIterator.next(),charIterator.dispose()),nextPos&&(newPos=nextPos.previousVisible()))}return{position:newPos,unitsMoved:unitsMoved}}function createRangeCharacterIterator(session,range,characterOptions,backward){var rangeStart=session.getRangeBoundaryPosition(range,!0),rangeEnd=session.getRangeBoundaryPosition(range,!1),itStart=backward?rangeEnd:rangeStart,itEnd=backward?rangeStart:rangeEnd;return createCharacterIterator(itStart,!!backward,itEnd,characterOptions)}function getRangeCharacters(session,range,characterOptions){for(var pos,chars=[],it=createRangeCharacterIterator(session,range,characterOptions);pos=it.next();)chars.push(pos);return it.dispose(),chars}function isWholeWord(startPos,endPos,wordOptions){var range=api.createRange(startPos.node);range.setStartAndEnd(startPos.node,startPos.offset,endPos.node,endPos.offset);var returnVal=!range.expand("word",wordOptions);return range.detach(),returnVal}function findTextFromPosition(initialPos,searchTerm,isRegex,searchScopeRange,findOptions){function handleMatch(startIndex,endIndex){var startPos=chars[startIndex].previousVisible(),endPos=chars[endIndex-1],valid=!findOptions.wholeWordsOnly||isWholeWord(startPos,endPos,findOptions.wordOptions);return{startPos:startPos,endPos:endPos,valid:valid}}for(var pos,currentChar,matchStartIndex,matchEndIndex,result,insideRegexMatch,backward=isDirectionBackward(findOptions.direction),it=createCharacterIterator(initialPos,backward,initialPos.session.getRangeBoundaryPosition(searchScopeRange,backward),findOptions),text="",chars=[],returnValue=null;pos=it.next();)if(currentChar=pos.character,isRegex||findOptions.caseSensitive||(currentChar=currentChar.toLowerCase()),backward?(chars.unshift(pos),text=currentChar+text):(chars.push(pos),text+=currentChar),isRegex){if(result=searchTerm.exec(text))if(insideRegexMatch){if(matchStartIndex=result.index,matchEndIndex=matchStartIndex+result[0].length,!backward&&matchEndIndex<text.length||backward&&matchStartIndex>0){returnValue=handleMatch(matchStartIndex,matchEndIndex);break}}else insideRegexMatch=!0}else if(-1!=(matchStartIndex=text.indexOf(searchTerm))){returnValue=handleMatch(matchStartIndex,matchStartIndex+searchTerm.length);break}return insideRegexMatch&&(returnValue=handleMatch(matchStartIndex,matchEndIndex)),it.dispose(),returnValue}function createEntryPointFunction(func){return function(){var sessionRunning=!!currentSession,session=getSession(),args=[session].concat(util.toArray(arguments)),returnValue=func.apply(this,args);return sessionRunning||endSession(),returnValue}}function createRangeBoundaryMover(isStart,collapse){return createEntryPointFunction(function(session,unit,count,moveOptions){"undefined"==typeof count&&(count=unit,unit=CHARACTER),moveOptions=createOptions(moveOptions,defaultMoveOptions);var characterOptions=createCharacterOptions(moveOptions.characterOptions),wordOptions=createWordOptions(moveOptions.wordOptions),boundaryIsStart=isStart;collapse&&(boundaryIsStart=count>=0,this.collapse(!boundaryIsStart));var moveResult=movePositionBy(session.getRangeBoundaryPosition(this,boundaryIsStart),unit,count,characterOptions,wordOptions),newPos=moveResult.position;return this[boundaryIsStart?"setStart":"setEnd"](newPos.node,newPos.offset),moveResult.unitsMoved})}function createRangeTrimmer(isStart){return createEntryPointFunction(function(session,characterOptions){characterOptions=createCharacterOptions(characterOptions);for(var pos,it=createRangeCharacterIterator(session,this,characterOptions,!isStart),trimCharCount=0;(pos=it.next())&&allWhiteSpaceRegex.test(pos.character);)++trimCharCount;it.dispose();var trimmed=trimCharCount>0;return trimmed&&this[isStart?"moveStart":"moveEnd"]("character",isStart?trimCharCount:-trimCharCount,{characterOptions:characterOptions}),trimmed})}function createSelectionTrimmer(methodName){return createEntryPointFunction(function(session,characterOptions){var trimmed=!1;return this.changeEachRange(function(range){trimmed=range[methodName](characterOptions)||trimmed}),trimmed})}var CHARACTER="character",WORD="word",dom=api.dom,util=api.util,extend=util.extend,getBody=dom.getBody,spacesRegex=/^[ \t\f\r\n]+$/,spacesMinusLineBreaksRegex=/^[ \t\f\r]+$/,allWhiteSpaceRegex=/^[\t-\r \u0085\u00A0\u1680\u180E\u2000-\u200B\u2028\u2029\u202F\u205F\u3000]+$/,nonLineBreakWhiteSpaceRegex=/^[\t \u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]+$/,defaultLanguage="en",isDirectionBackward=api.Selection.isDirectionBackward,trailingSpaceInBlockCollapses=!1,trailingSpaceBeforeBrCollapses=!1,trailingSpaceBeforeBlockCollapses=!1,trailingSpaceBeforeLineBreakInPreLineCollapses=!0;!function(){var el=document.createElementNS("http://www.w3.org/1999/xhtml","div");el.contentEditable="true",el.innerHTML="<p>1 </p><p></p>";var body=getBody(document),p=el.firstChild,sel=api.getSelection();body.appendChild(el),sel.collapse(p.lastChild,2),sel.setStart(p.firstChild,0),trailingSpaceInBlockCollapses=1==(""+sel).length,el.innerHTML="1 <br>",sel.collapse(el,2),sel.setStart(el.firstChild,0),trailingSpaceBeforeBrCollapses=1==(""+sel).length,el.innerHTML="1 <p>1</p>",sel.collapse(el,2),sel.setStart(el.firstChild,0),trailingSpaceBeforeBlockCollapses=1==(""+sel).length,body.removeChild(el),sel.removeAllRanges()}();var tableCssDisplayBlock,defaultCharacterOptions={includeBlockContentTrailingSpace:!0,includeSpaceBeforeBr:!0,includeSpaceBeforeBlock:!0,includePreLineTrailingSpace:!0},defaultCaretCharacterOptions={includeBlockContentTrailingSpace:!trailingSpaceBeforeLineBreakInPreLineCollapses,includeSpaceBeforeBr:!trailingSpaceBeforeBrCollapses,includeSpaceBeforeBlock:!trailingSpaceBeforeBlockCollapses,includePreLineTrailingSpace:!0},defaultWordOptions={en:{wordRegex:/[a-z0-9]+('[a-z0-9]+)*/gi,includeTrailingSpace:!1,tokenizer:defaultTokenizer}},defaultFindOptions={caseSensitive:!1,withinRange:null,wholeWordsOnly:!1,wrap:!1,direction:"forward",wordOptions:null,characterOptions:null},defaultMoveOptions={wordOptions:null,characterOptions:null},defaultExpandOptions={wordOptions:null,characterOptions:null,trim:!1,trimStart:!0,trimEnd:!0},defaultWordIteratorOptions={wordOptions:null,characterOptions:null,direction:"forward"},getComputedStyleProperty=dom.getComputedStyleProperty;!function(){var table=document.createElementNS("http://www.w3.org/1999/xhtml","table"),body=getBody(document);body.appendChild(table),tableCssDisplayBlock="block"==getComputedStyleProperty(table,"display"),body.removeChild(table)}(),api.features.tableCssDisplayBlock=tableCssDisplayBlock;var defaultDisplayValueForTag={table:"table",caption:"table-caption",colgroup:"table-column-group",col:"table-column",thead:"table-header-group",tbody:"table-row-group",tfoot:"table-footer-group",tr:"table-row",td:"table-cell",th:"table-cell"};Cache.prototype={get:function(key){return this.store.hasOwnProperty(key)?this.store[key]:null},set:function(key,value){return this.store[key]=value}};var cachedCount=0,uncachedCount=0,nodeProto={getPosition:function(offset){var positions=this.positions;return positions.get(offset)||positions.set(offset,new Position(this,offset))},toString:function(){return"[NodeWrapper("+dom.inspectNode(this.node)+")]"}};NodeWrapper.prototype=nodeProto;var EMPTY="EMPTY",NON_SPACE="NON_SPACE",UNCOLLAPSIBLE_SPACE="UNCOLLAPSIBLE_SPACE",COLLAPSIBLE_SPACE="COLLAPSIBLE_SPACE",TRAILING_SPACE_BEFORE_BLOCK="TRAILING_SPACE_BEFORE_BLOCK",TRAILING_SPACE_IN_BLOCK="TRAILING_SPACE_IN_BLOCK",TRAILING_SPACE_BEFORE_BR="TRAILING_SPACE_BEFORE_BR",PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK="PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK",TRAILING_LINE_BREAK_AFTER_BR="TRAILING_LINE_BREAK_AFTER_BR";extend(nodeProto,{isCharacterDataNode:createCachingGetter("isCharacterDataNode",dom.isCharacterDataNode,"node"),getNodeIndex:createCachingGetter("nodeIndex",dom.getNodeIndex,"node"),getLength:createCachingGetter("nodeLength",dom.getNodeLength,"node"),containsPositions:createCachingGetter("containsPositions",containsPositions,"node"),isWhitespace:createCachingGetter("isWhitespace",isWhitespaceNode,"node"),isCollapsedWhitespace:createCachingGetter("isCollapsedWhitespace",isCollapsedWhitespaceNode,"node"),getComputedDisplay:createCachingGetter("computedDisplay",getComputedDisplay,"node"),isCollapsed:createCachingGetter("collapsed",isCollapsedNode,"node"),isIgnored:createCachingGetter("ignored",isIgnoredNode,"node"),next:createCachingGetter("nextPos",nextNode,"node"),previous:createCachingGetter("previous",previousNode,"node"),getTextNodeInfo:createCachingGetter("textNodeInfo",function(textNode){var spaceRegex=null,collapseSpaces=!1,cssWhitespace=getComputedStyleProperty(textNode.parentNode,"whiteSpace"),preLine="pre-line"==cssWhitespace;return preLine?(spaceRegex=spacesMinusLineBreaksRegex,collapseSpaces=!0):("normal"==cssWhitespace||"nowrap"==cssWhitespace)&&(spaceRegex=spacesRegex,collapseSpaces=!0),{node:textNode,text:textNode.data,spaceRegex:spaceRegex,collapseSpaces:collapseSpaces,preLine:preLine}},"node"),hasInnerText:createCachingGetter("hasInnerText",function(el,backward){for(var session=this.session,posAfterEl=session.getPosition(el.parentNode,this.getNodeIndex()+1),firstPosInEl=session.getPosition(el,0),pos=backward?posAfterEl:firstPosInEl,endPos=backward?firstPosInEl:posAfterEl;pos!==endPos;){if(pos.prepopulateChar(),pos.isDefinitelyNonEmpty())return!0;pos=backward?pos.previousVisible():pos.nextVisible()}return!1},"node"),isRenderedBlock:createCachingGetter("isRenderedBlock",function(el){for(var brs=el.getElementsByTagName("br"),i=0,len=brs.length;len>i;++i)if(!isCollapsedNode(brs[i]))return!0;return this.hasInnerText()},"node"),getTrailingSpace:createCachingGetter("trailingSpace",function(el){if("br"==el.tagName.toLowerCase())return"";switch(this.getComputedDisplay()){case"inline":for(var child=el.lastChild;child;){if(!isIgnoredNode(child))return 1==child.nodeType?this.session.getNodeWrapper(child).getTrailingSpace():"";child=child.previousSibling}break;case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":break;case"table-cell":return"	";default:return this.isRenderedBlock(!0)?"\n":""}return""},"node"),getLeadingSpace:createCachingGetter("leadingSpace",function(){switch(this.getComputedDisplay()){case"inline":case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":case"table-cell":break;default:return this.isRenderedBlock(!1)?"\n":""}return""},"node")});var positionProto={character:"",characterType:EMPTY,isBr:!1,prepopulateChar:function(){var pos=this;if(!pos.prepopulatedChar){var node=pos.node,offset=pos.offset,visibleChar="",charType=EMPTY,finalizedChar=!1;if(offset>0)if(3==node.nodeType){var text=node.data,textChar=text.charAt(offset-1),nodeInfo=pos.nodeWrapper.getTextNodeInfo(),spaceRegex=nodeInfo.spaceRegex;nodeInfo.collapseSpaces?spaceRegex.test(textChar)?offset>1&&spaceRegex.test(text.charAt(offset-2))||(nodeInfo.preLine&&"\n"===text.charAt(offset)?(visibleChar=" ",charType=PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK):(visibleChar=" ",charType=COLLAPSIBLE_SPACE)):(visibleChar=textChar,charType=NON_SPACE,finalizedChar=!0):(visibleChar=textChar,charType=UNCOLLAPSIBLE_SPACE,finalizedChar=!0)}else{var nodePassed=node.childNodes[offset-1];if(nodePassed&&1==nodePassed.nodeType&&!isCollapsedNode(nodePassed)&&("br"==nodePassed.tagName.toLowerCase()?(visibleChar="\n",pos.isBr=!0,charType=COLLAPSIBLE_SPACE,finalizedChar=!1):pos.checkForTrailingSpace=!0),!visibleChar){var nextNode=node.childNodes[offset];nextNode&&1==nextNode.nodeType&&!isCollapsedNode(nextNode)&&(pos.checkForLeadingSpace=!0)}}pos.prepopulatedChar=!0,pos.character=visibleChar,pos.characterType=charType,pos.isCharInvariant=finalizedChar}},isDefinitelyNonEmpty:function(){var charType=this.characterType;return charType==NON_SPACE||charType==UNCOLLAPSIBLE_SPACE},resolveLeadingAndTrailingSpaces:function(){if(this.prepopulatedChar||this.prepopulateChar(),this.checkForTrailingSpace){var trailingSpace=this.session.getNodeWrapper(this.node.childNodes[this.offset-1]).getTrailingSpace();trailingSpace&&(this.isTrailingSpace=!0,this.character=trailingSpace,this.characterType=COLLAPSIBLE_SPACE),this.checkForTrailingSpace=!1}if(this.checkForLeadingSpace){var leadingSpace=this.session.getNodeWrapper(this.node.childNodes[this.offset]).getLeadingSpace();leadingSpace&&(this.isLeadingSpace=!0,this.character=leadingSpace,this.characterType=COLLAPSIBLE_SPACE),this.checkForLeadingSpace=!1}},getPrecedingUncollapsedPosition:function(characterOptions){for(var character,pos=this;pos=pos.previousVisible();)if(character=pos.getCharacter(characterOptions),""!==character)return pos;return null},getCharacter:function(characterOptions){function getPreviousPos(){return gotPreviousPos||(previousPos=pos.getPrecedingUncollapsedPosition(characterOptions),gotPreviousPos=!0),previousPos}if(this.resolveLeadingAndTrailingSpaces(),this.isCharInvariant)return this.character;var cacheKey=["character",characterOptions.includeSpaceBeforeBr,characterOptions.includeBlockContentTrailingSpace,characterOptions.includePreLineTrailingSpace].join("_"),cachedChar=this.cache.get(cacheKey);if(null!==cachedChar)return cachedChar;var nextPos,previousPos,character="",collapsible=this.characterType==COLLAPSIBLE_SPACE,gotPreviousPos=!1,pos=this;return collapsible?(" "!=this.character||getPreviousPos()&&!previousPos.isTrailingSpace&&"\n"!=previousPos.character)&&("\n"==this.character&&this.isLeadingSpace?getPreviousPos()&&"\n"!=previousPos.character&&(character="\n"):(nextPos=this.nextUncollapsed(),nextPos&&(nextPos.isBr?this.type=TRAILING_SPACE_BEFORE_BR:nextPos.isTrailingSpace&&"\n"==nextPos.character?this.type=TRAILING_SPACE_IN_BLOCK:nextPos.isLeadingSpace&&"\n"==nextPos.character&&(this.type=TRAILING_SPACE_BEFORE_BLOCK),"\n"===nextPos.character?(this.type!=TRAILING_SPACE_BEFORE_BR||characterOptions.includeSpaceBeforeBr)&&(this.type!=TRAILING_SPACE_BEFORE_BLOCK||characterOptions.includeSpaceBeforeBlock)&&(this.type==TRAILING_SPACE_IN_BLOCK&&nextPos.isTrailingSpace&&!characterOptions.includeBlockContentTrailingSpace||(this.type!=PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK||nextPos.type!=NON_SPACE||characterOptions.includePreLineTrailingSpace)&&("\n"===this.character?nextPos.isTrailingSpace?this.isTrailingSpace||this.isBr&&(nextPos.type=TRAILING_LINE_BREAK_AFTER_BR,getPreviousPos()&&previousPos.isLeadingSpace&&"\n"==previousPos.character&&(nextPos.character="")):character="\n":" "===this.character&&(character=" "))):character=this.character))):"\n"===this.character&&(!(nextPos=this.nextUncollapsed())||nextPos.isTrailingSpace),this.cache.set(cacheKey,character),character},equals:function(pos){return!!pos&&this.node===pos.node&&this.offset===pos.offset},inspect:inspectPosition,toString:function(){return this.character}};Position.prototype=positionProto,extend(positionProto,{next:createCachingGetter("nextPos",function(pos){var nodeWrapper=pos.nodeWrapper,node=pos.node,offset=pos.offset,session=nodeWrapper.session;if(!node)return null;var nextNode,nextOffset,child;return offset==nodeWrapper.getLength()?(nextNode=node.parentNode,nextOffset=nextNode?nodeWrapper.getNodeIndex()+1:0):nodeWrapper.isCharacterDataNode()?(nextNode=node,nextOffset=offset+1):(child=node.childNodes[offset],session.getNodeWrapper(child).containsPositions()?(nextNode=child,nextOffset=0):(nextNode=node,nextOffset=offset+1)),nextNode?session.getPosition(nextNode,nextOffset):null}),previous:createCachingGetter("previous",function(pos){var previousNode,previousOffset,child,nodeWrapper=pos.nodeWrapper,node=pos.node,offset=pos.offset,session=nodeWrapper.session;return 0==offset?(previousNode=node.parentNode,previousOffset=previousNode?nodeWrapper.getNodeIndex():0):nodeWrapper.isCharacterDataNode()?(previousNode=node,previousOffset=offset-1):(child=node.childNodes[offset-1],session.getNodeWrapper(child).containsPositions()?(previousNode=child,previousOffset=dom.getNodeLength(child)):(previousNode=node,previousOffset=offset-1)),previousNode?session.getPosition(previousNode,previousOffset):null}),nextVisible:createCachingGetter("nextVisible",function(pos){var next=pos.next();if(!next)return null;var nodeWrapper=next.nodeWrapper,node=next.node,newPos=next;return nodeWrapper.isCollapsed()&&(newPos=nodeWrapper.session.getPosition(node.parentNode,nodeWrapper.getNodeIndex()+1)),newPos}),nextUncollapsed:createCachingGetter("nextUncollapsed",function(pos){for(var nextPos=pos;nextPos=nextPos.nextVisible();)if(nextPos.resolveLeadingAndTrailingSpaces(),""!==nextPos.character)return nextPos;return null}),previousVisible:createCachingGetter("previousVisible",function(pos){var previous=pos.previous();if(!previous)return null;var nodeWrapper=previous.nodeWrapper,node=previous.node,newPos=previous;return nodeWrapper.isCollapsed()&&(newPos=nodeWrapper.session.getPosition(node.parentNode,nodeWrapper.getNodeIndex())),newPos})});var currentSession=null,Session=function(){function createWrapperCache(nodeProperty){var cache=new Cache;return{get:function(node){var wrappersByProperty=cache.get(node[nodeProperty]);if(wrappersByProperty)for(var wrapper,i=0;wrapper=wrappersByProperty[i++];)if(wrapper.node===node)return wrapper;return null},set:function(nodeWrapper){var property=nodeWrapper.node[nodeProperty],wrappersByProperty=cache.get(property)||cache.set(property,[]);wrappersByProperty.push(nodeWrapper)}}}function Session(){this.initCaches()}var uniqueIDSupported=util.isHostProperty(document.documentElement,"uniqueID");return Session.prototype={initCaches:function(){this.elementCache=uniqueIDSupported?function(){var elementsCache=new Cache;return{get:function(el){return elementsCache.get(el.uniqueID)},set:function(elWrapper){elementsCache.set(elWrapper.node.uniqueID,elWrapper)}}}():createWrapperCache("tagName"),this.textNodeCache=createWrapperCache("data"),this.otherNodeCache=createWrapperCache("nodeName")},getNodeWrapper:function(node){var wrapperCache;switch(node.nodeType){case 1:wrapperCache=this.elementCache;break;case 3:wrapperCache=this.textNodeCache;break;default:wrapperCache=this.otherNodeCache}var wrapper=wrapperCache.get(node);return wrapper||(wrapper=new NodeWrapper(node,this),wrapperCache.set(wrapper)),wrapper},getPosition:function(node,offset){return this.getNodeWrapper(node).getPosition(offset)},getRangeBoundaryPosition:function(range,isStart){var prefix=isStart?"start":"end";return this.getPosition(range[prefix+"Container"],range[prefix+"Offset"])},detach:function(){this.elementCache=this.textNodeCache=this.otherNodeCache=null}},Session}();extend(dom,{nextNode:nextNode,previousNode:previousNode});var arrayIndexOf=Array.prototype.indexOf?function(arr,val){return arr.indexOf(val)}:function(arr,val){for(var i=0,len=arr.length;len>i;++i)if(arr[i]===val)return i;return-1};extend(api.rangePrototype,{moveStart:createRangeBoundaryMover(!0,!1),moveEnd:createRangeBoundaryMover(!1,!1),move:createRangeBoundaryMover(!0,!0),trimStart:createRangeTrimmer(!0),trimEnd:createRangeTrimmer(!1),trim:createEntryPointFunction(function(session,characterOptions){var startTrimmed=this.trimStart(characterOptions),endTrimmed=this.trimEnd(characterOptions);return startTrimmed||endTrimmed}),expand:createEntryPointFunction(function(session,unit,expandOptions){var moved=!1;expandOptions=createOptions(expandOptions,defaultExpandOptions);var characterOptions=createCharacterOptions(expandOptions.characterOptions);if(unit||(unit=CHARACTER),unit==WORD){var endToken,newEndPos,wordOptions=createWordOptions(expandOptions.wordOptions),startPos=session.getRangeBoundaryPosition(this,!0),endPos=session.getRangeBoundaryPosition(this,!1),startTokenizedTextProvider=createTokenizedTextProvider(startPos,characterOptions,wordOptions),startToken=startTokenizedTextProvider.nextEndToken(),newStartPos=startToken.chars[0].previousVisible();
if(this.collapsed)endToken=startToken;else{var endTokenizedTextProvider=createTokenizedTextProvider(endPos,characterOptions,wordOptions);endToken=endTokenizedTextProvider.previousStartToken()}return newEndPos=endToken.chars[endToken.chars.length-1],newStartPos.equals(startPos)||(this.setStart(newStartPos.node,newStartPos.offset),moved=!0),newEndPos&&!newEndPos.equals(endPos)&&(this.setEnd(newEndPos.node,newEndPos.offset),moved=!0),expandOptions.trim&&(expandOptions.trimStart&&(moved=this.trimStart(characterOptions)||moved),expandOptions.trimEnd&&(moved=this.trimEnd(characterOptions)||moved)),moved}return this.moveEnd(CHARACTER,1,expandOptions)}),text:createEntryPointFunction(function(session,characterOptions){return this.collapsed?"":getRangeCharacters(session,this,createCharacterOptions(characterOptions)).join("")}),selectCharacters:createEntryPointFunction(function(session,containerNode,startIndex,endIndex,characterOptions){var moveOptions={characterOptions:characterOptions};containerNode||(containerNode=getBody(this.getDocument())),this.selectNodeContents(containerNode),this.collapse(!0),this.moveStart("character",startIndex,moveOptions),this.collapse(!0),this.moveEnd("character",endIndex-startIndex,moveOptions)}),toCharacterRange:createEntryPointFunction(function(session,containerNode,characterOptions){containerNode||(containerNode=getBody(this.getDocument()));var startIndex,endIndex,parent=containerNode.parentNode,nodeIndex=dom.getNodeIndex(containerNode),rangeStartsBeforeNode=-1==dom.comparePoints(this.startContainer,this.endContainer,parent,nodeIndex),rangeBetween=this.cloneRange();return rangeStartsBeforeNode?(rangeBetween.setStartAndEnd(this.startContainer,this.startOffset,parent,nodeIndex),startIndex=-rangeBetween.text(characterOptions).length):(rangeBetween.setStartAndEnd(parent,nodeIndex,this.startContainer,this.startOffset),startIndex=rangeBetween.text(characterOptions).length),endIndex=startIndex+this.text(characterOptions).length,{start:startIndex,end:endIndex}}),findText:createEntryPointFunction(function(session,searchTermParam,findOptions){findOptions=createOptions(findOptions,defaultFindOptions),findOptions.wholeWordsOnly&&(findOptions.wordOptions=createWordOptions(findOptions.wordOptions),findOptions.wordOptions.includeTrailingSpace=!1);var backward=isDirectionBackward(findOptions.direction),searchScopeRange=findOptions.withinRange;searchScopeRange||(searchScopeRange=api.createRange(),searchScopeRange.selectNodeContents(this.getDocument()));var searchTerm=searchTermParam,isRegex=!1;"string"==typeof searchTerm?findOptions.caseSensitive||(searchTerm=searchTerm.toLowerCase()):isRegex=!0;var initialPos=session.getRangeBoundaryPosition(this,!backward),comparison=searchScopeRange.comparePoint(initialPos.node,initialPos.offset);-1===comparison?initialPos=session.getRangeBoundaryPosition(searchScopeRange,!0):1===comparison&&(initialPos=session.getRangeBoundaryPosition(searchScopeRange,!1));for(var findResult,pos=initialPos,wrappedAround=!1;;)if(findResult=findTextFromPosition(pos,searchTerm,isRegex,searchScopeRange,findOptions)){if(findResult.valid)return this.setStartAndEnd(findResult.startPos.node,findResult.startPos.offset,findResult.endPos.node,findResult.endPos.offset),!0;pos=backward?findResult.startPos:findResult.endPos}else{if(!findOptions.wrap||wrappedAround)return!1;searchScopeRange=searchScopeRange.cloneRange(),pos=session.getRangeBoundaryPosition(searchScopeRange,!backward),searchScopeRange.setBoundary(initialPos.node,initialPos.offset,backward),wrappedAround=!0}}),pasteHtml:function(html){if(this.deleteContents(),html){var frag=this.createContextualFragment(html),lastChild=frag.lastChild;this.insertNode(frag),this.collapseAfter(lastChild)}}}),extend(api.selectionPrototype,{expand:createEntryPointFunction(function(session,unit,expandOptions){this.changeEachRange(function(range){range.expand(unit,expandOptions)})}),move:createEntryPointFunction(function(session,unit,count,options){var unitsMoved=0;if(this.focusNode){this.collapse(this.focusNode,this.focusOffset);var range=this.getRangeAt(0);options||(options={}),options.characterOptions=createCaretCharacterOptions(options.characterOptions),unitsMoved=range.move(unit,count,options),this.setSingleRange(range)}return unitsMoved}),trimStart:createSelectionTrimmer("trimStart"),trimEnd:createSelectionTrimmer("trimEnd"),trim:createSelectionTrimmer("trim"),selectCharacters:createEntryPointFunction(function(session,containerNode,startIndex,endIndex,direction,characterOptions){var range=api.createRange(containerNode);range.selectCharacters(containerNode,startIndex,endIndex,characterOptions),this.setSingleRange(range,direction)}),saveCharacterRanges:createEntryPointFunction(function(session,containerNode,characterOptions){for(var ranges=this.getAllRanges(),rangeCount=ranges.length,rangeInfos=[],backward=1==rangeCount&&this.isBackward(),i=0,len=ranges.length;len>i;++i)rangeInfos[i]={characterRange:ranges[i].toCharacterRange(containerNode,characterOptions),backward:backward,characterOptions:characterOptions};return rangeInfos}),restoreCharacterRanges:createEntryPointFunction(function(session,containerNode,saved){this.removeAllRanges();for(var range,rangeInfo,characterRange,i=0,len=saved.length;len>i;++i)rangeInfo=saved[i],characterRange=rangeInfo.characterRange,range=api.createRange(containerNode),range.selectCharacters(containerNode,characterRange.start,characterRange.end,rangeInfo.characterOptions),this.addRange(range,rangeInfo.backward)}),text:createEntryPointFunction(function(session,characterOptions){for(var rangeTexts=[],i=0,len=this.rangeCount;len>i;++i)rangeTexts[i]=this.getRangeAt(i).text(characterOptions);return rangeTexts.join("")})}),api.innerText=function(el,characterOptions){var range=api.createRange(el);range.selectNodeContents(el);var text=range.text(characterOptions);return range.detach(),text},api.createWordIterator=function(startNode,startOffset,iteratorOptions){var session=getSession();iteratorOptions=createOptions(iteratorOptions,defaultWordIteratorOptions);var characterOptions=createCharacterOptions(iteratorOptions.characterOptions),wordOptions=createWordOptions(iteratorOptions.wordOptions),startPos=session.getPosition(startNode,startOffset),tokenizedTextProvider=createTokenizedTextProvider(startPos,characterOptions,wordOptions),backward=isDirectionBackward(iteratorOptions.direction);return{next:function(){return backward?tokenizedTextProvider.previousStartToken():tokenizedTextProvider.nextEndToken()},dispose:function(){tokenizedTextProvider.dispose(),this.next=function(){}}}},api.noMutation=function(func){var session=getSession();func(session),endSession()},api.noMutation.createEntryPointFunction=createEntryPointFunction,api.textRange={isBlockNode:isBlockNode,isCollapsedWhitespaceNode:isCollapsedWhitespaceNode,createPosition:createEntryPointFunction(function(session,node,offset){return session.getPosition(node,offset)})}}),define("rangy-textrange",["rangy-core"],function(global){return function(){var ret;return ret||global.rangy.modules.TextRange}}(this)),rangy.createModule("Position",["WrappedSelection"],function(api,module){function getScrollPosition(win){var x=0,y=0;if(typeof win.pageXOffset==NUMBER&&typeof win.pageYOffset==NUMBER)x=win.pageXOffset,y=win.pageYOffset;else{var doc=win.document,docEl=doc.documentElement,compatMode=doc.compatMode,scrollEl="string"==typeof compatMode&&compatMode.indexOf("CSS")>=0&&docEl?docEl:dom.getBody(doc);if(scrollEl&&typeof scrollEl.scrollLeft==NUMBER&&typeof scrollEl.scrollTop==NUMBER)try{x=scrollEl.scrollLeft,y=scrollEl.scrollTop}catch(ex){}}return{x:x,y:y}}function getAncestorElement(node,tagName){for(tagName=tagName.toLowerCase();node;){if(1==node.nodeType&&node.tagName.toLowerCase()==tagName)return node;node=node.parentNode}return null}function Rect(top,right,bottom,left){this.top=top,this.right=right,this.bottom=bottom,this.left=left,this.width=right-left,this.height=bottom-top}function createRelativeRect(rect,dx,dy){return new Rect(rect.top+dy,rect.right+dx,rect.bottom+dy,rect.left+dx)}function adjustClientRect(rect,doc){var dx=0,dy=0,docEl=doc.documentElement,body=dom.getBody(doc),container=0===docEl.clientWidth&&typeof body.clientTop==NUMBER?body:docEl,clientLeft=container.clientLeft,clientTop=container.clientTop;return clientLeft&&(dx=-clientLeft),clientTop&&(dy=-clientTop),createRelativeRect(rect,dx,dy)}function mergeRects(rects){for(var rect,tops=[],bottoms=[],lefts=[],rights=[],i=0,len=rects.length;len>i;++i)rect=rects[i],rect&&(tops.push(rect.top),bottoms.push(rect.bottom),lefts.push(rect.left),rights.push(rect.right));return new Rect(Math.min.apply(Math,tops),Math.max.apply(Math,rights),Math.max.apply(Math,bottoms),Math.min.apply(Math,lefts))}function getTextRangePosition(doc,x,y){var textRange=dom.getBody(doc).createTextRange();textRange.moveToPoint(x,y);var range=new api.WrappedTextRange(textRange);return new DomPosition(range.startContainer,range.startOffset)}function caretPositionFromPoint(doc,x,y){var pos=doc.caretPositionFromPoint(x,y);return new DomPosition(pos.offsetNode,pos.offset)}function caretRangeFromPoint(doc,x,y){var range=doc.caretRangeFromPoint(x,y);return new DomPosition(range.startContainer,range.startOffset)}function getLastRangeRect(range){var rects=(range.nativeRange||range).getClientRects();return rects.length>0?rects[rects.length-1]:null}function pointIsInOrAboveRect(x,y,rect){return console.log("pointIsInOrAboveRect",x,y,Math.floor(rect.top),Math.floor(rect.right),Math.floor(rect.bottom),Math.floor(rect.left)),y<rect.bottom&&x>=rect.left&&x<=rect.right}function positionFromPoint(doc,x,y,favourPrecedingPosition){var el=doc.elementFromPoint(x,y);console.log("elementFromPoint is ",el);var range=api.createRange(doc);range.selectNodeContents(el),range.collapse(!0);var offset,rect,textLen,node=el.firstChild;if(node){main:for(;node;){if(console.log(node),3==node.nodeType){for(offset=0,textLen=node.length;textLen>=offset;++offset)if(range.setEnd(node,offset),rect=getLastRangeRect(range),rect&&pointIsInOrAboveRect(x,y,rect)){rect.right-x>x-rect.left&&--offset;break main}}else if(range.setEndAfter(node),rect=getLastRangeRect(range),rect&&pointIsInOrAboveRect(x,y,rect)){offset=dom.getNodeIndex(node),node=el.parentNode,favourPrecedingPosition||++offset;break}node=node.nextSibling}node||(node=el,offset=el.childNodes.length)}else node=el.parentNode,offset=dom.getNodeIndex(el),favourPrecedingPosition||++offset;return new DomPosition(node,offset)}function createCaretPositionFromPointGetter(doc){if(api.features.implementsTextRange)return getTextRangePosition;if(typeof doc.caretPositionFromPoint!=UNDEF)return caretPositionFromPoint;if(typeof doc.caretRangeFromPoint!=UNDEF)return caretRangeFromPoint;if(typeof doc.elementFromPoint!=UNDEF&&rangeSupportsGetClientRects)return positionFromPoint;throw module.createError("createCaretPositionFromPointGetter(): Browser does not provide a recognised method to create a selection from pixel coordinates")}function createRangeFromPoints(startX,startY,endX,endY,doc){doc=dom.getContentDocument(doc,module,"createRangeFromPoints");var positionFinder=createCaretPositionFromPointGetter(doc),startPos=positionFinder(doc,startX,startY,!1),endPos=positionFinder(doc,endX,endY,!0);console.log(startPos.node,startPos.offset,endPos.node,endPos.offset);var range=api.createRange(doc);return range.setStartAndEnd(startPos.node,startPos.offset,endPos.node,endPos.offset),range}function moveSelectionToPoints(anchorX,anchorY,focusX,focusY,doc){var startX,startY,endX,endY,backward=anchorY>focusY||anchorY==focusY&&anchorX>focusX;backward?(startX=focusX,startY=focusY,endX=anchorX,endY=anchorY):(startX=anchorX,startY=anchorY,endX=focusX,endY=focusY);var sel=rangy.getSelection(doc),range=createRangeFromPoints(startX,startY,endX,endY,doc);return sel.setSingleRange(range),sel}function createDocumentBoundaryPosGetter(isStart){return function(){var pos=this["get"+(isStart?"Start":"End")+"ClientPos"](),scrollPos=getScrollPosition(dom.getWindow(this.startContainer));return{x:pos.x+scrollPos.x,y:pos.y+scrollPos.y}}}function compareRanges(r1,r2){return r1.compareBoundaryPoints(r2.START_TO_START,r2)}function createSelectionRectGetter(isDocument){return function(){for(var rangeMethodName="getBounding"+(isDocument?"Document":"Client")+"Rect",rects=[],i=0;i<this.rangeCount;++i)rects.push(this.getRangeAt(i)[rangeMethodName]());return mergeRects(rects)}}function createSelectionBoundaryPosGetter(isStart,isDocument){return function(){if(0==this.rangeCount)return null;var posType=isDocument?"Document":"Client",ranges=this.getAllRanges();return ranges.length>1&&ranges.sort(compareRanges),isStart?ranges[0]["getStart"+posType+"Pos"]():ranges[ranges.length-1]["getEnd"+posType+"Pos"]()}}var NUMBER="number",UNDEF="undefined",WrappedRange=api.WrappedRange,WrappedTextRange=api.WrappedTextRange,dom=api.dom,util=api.util,DomPosition=dom.DomPosition,span=document.createElementNS("http://www.w3.org/1999/xhtml","span"),elementSupportsGetBoundingClientRect=util.isHostMethod(span,"getBoundingClientRect");span=null;var rangeSupportsGetClientRects=!1,rangeSupportsGetBoundingClientRect=!1;if(api.features.implementsDomRange){var testRange=api.createNativeRange();rangeSupportsGetClientRects=util.isHostMethod(testRange,"getClientRects"),rangeSupportsGetBoundingClientRect=util.isHostMethod(testRange,"getBoundingClientRect"),testRange.detach()}util.extend(api.features,{rangeSupportsGetBoundingClientRect:rangeSupportsGetBoundingClientRect,rangeSupportsGetClientRects:rangeSupportsGetClientRects,elementSupportsGetBoundingClientRect:elementSupportsGetBoundingClientRect});var createClientBoundaryPosGetter=function(isStart){return function(){var boundaryRange=this.cloneRange();boundaryRange.collapse(isStart);var rect=boundaryRange.getBoundingClientRect();return{x:rect[isStart?"left":"right"],y:rect[isStart?"top":"bottom"]}}},rangeProto=api.rangePrototype;if(api.features.implementsTextRange&&elementSupportsGetBoundingClientRect)rangeProto.getBoundingClientRect=function(){var rect,textRange=WrappedTextRange.rangeToTextRange(this),cells=this.getNodes([1],function(el){return/^t[dh]$/i.test(el.tagName)}),rects=[];if(cells.length>0){for(var cell,tempTextRange,table,subRange,lastTable=getAncestorElement(this.startContainer,"table"),i=0;cell=cells[i];++i)table=getAncestorElement(cell,"table"),lastTable&&table==lastTable||(subRange=this.cloneRange(),lastTable&&subRange.setStartAfter(lastTable),subRange.setEndBefore(table),rects.push(WrappedTextRange.rangeToTextRange(subRange).getBoundingClientRect())),this.containsNode(cell)?rects.push(cell.getBoundingClientRect()):(tempTextRange=textRange.duplicate(),tempTextRange.moveToElementText(cell),-1==tempTextRange.compareEndPoints("StartToStart",textRange)?tempTextRange.setEndPoint("StartToStart",textRange):1==tempTextRange.compareEndPoints("EndToEnd",textRange)&&tempTextRange.setEndPoint("EndToEnd",textRange),rects.push(tempTextRange.getBoundingClientRect())),lastTable=table;var endTable=getAncestorElement(this.endContainer,"table");!endTable&&lastTable&&(subRange=this.cloneRange(),subRange.setStartAfter(lastTable),rects.push(WrappedTextRange.rangeToTextRange(subRange).getBoundingClientRect())),rect=mergeRects(rects)}else rect=textRange.getBoundingClientRect();return adjustClientRect(rect,dom.getDocument(this.startContainer))};else if(api.features.implementsDomRange){var createWrappedRange=function(range){return range instanceof WrappedRange?range:new WrappedRange(range)};if(rangeSupportsGetBoundingClientRect){if(rangeProto.getBoundingClientRect=function(){var nativeRange=createWrappedRange(this).nativeRange,rect=nativeRange.getBoundingClientRect()||nativeRange.getClientRects()[0];return adjustClientRect(rect,dom.getDocument(this.startContainer))},rangeSupportsGetClientRects){createClientBoundaryPosGetter=function(isStart){return function(){var rect,nativeRange=createWrappedRange(this).nativeRange,rects=nativeRange.getClientRects();if(0==rects.length&&elementSupportsGetBoundingClientRect&&(console.log(nativeRange,nativeRange.getClientRects(),nativeRange.getBoundingClientRect()),this.collapsed&&1==this.startContainer.nodeType&&this.startOffset<this.startContainer.childNodes.length)){var n=this.startContainer.childNodes[this.startOffset];n.getClientRects&&console.log(n,n.getClientRects(),this.startContainer.getClientRects())}if(rects.length>0)return isStart?(rect=rects[0],{x:rect.left,y:rect.top}):(rect=rects[rects.length-1],{x:rect.right,y:rect.bottom});throw module.createError("Cannot get position for range "+this.inspect())}}}}else{var getElementBoundingClientRect=elementSupportsGetBoundingClientRect?function(el){return adjustClientRect(el.getBoundingClientRect(),dom.getDocument(el))}:function(el){for(var x=0,y=0,offsetEl=el,width=el.offsetWidth,height=el.offsetHeight;offsetEl;)x+=offsetEl.offsetLeft,y+=offsetEl.offsetTop,offsetEl=offsetEl.offsetParent;return adjustClientRect(new Rect(y,x+width,y+height,x),dom.getDocument(el))},getRectFromBoundaries=function(range){var rect;range.splitBoundaries();var span=document.createElementNS("http://www.w3.org/1999/xhtml","span");if(range.collapsed)range.insertNode(span),rect=getElementBoundingClientRect(span),span.parentNode.removeChild(span);else{var workingRange=range.cloneRange();workingRange.collapse(!0),workingRange.insertNode(span);var startRect=getElementBoundingClientRect(span);span.parentNode.removeChild(span),workingRange.collapseToPoint(range.endContainer,range.endOffset),workingRange.insertNode(span);var endRect=getElementBoundingClientRect(span);span.parentNode.removeChild(span);for(var rects=[startRect,endRect],elements=range.getNodes([1],function(el){return range.containsNode(el)}),i=0,len=elements.length;len>i;++i)rects.push(getElementBoundingClientRect(elements[i]));rect=mergeRects(rects)}return range.normalizeBoundaries(),rect};rangeProto.getBoundingClientRect=function(range){return getRectFromBoundaries(createWrappedRange(range))}}}util.extend(rangeProto,{getBoundingDocumentRect:function(){var scrollPos=getScrollPosition(dom.getWindow(this.startContainer));return createRelativeRect(this.getBoundingClientRect(),scrollPos.x,scrollPos.y)},getStartClientPos:createClientBoundaryPosGetter(!0),getEndClientPos:createClientBoundaryPosGetter(!1),getStartDocumentPos:createDocumentBoundaryPosGetter(!0),getEndDocumentPos:createDocumentBoundaryPosGetter(!1)}),util.extend(api.selectionPrototype,{getBoundingClientRect:createSelectionRectGetter(!1),getBoundingDocumentRect:createSelectionRectGetter(!0),getStartClientPos:createSelectionBoundaryPosGetter(!0,!1),getEndClientPos:createSelectionBoundaryPosGetter(!1,!1),getStartDocumentPos:createSelectionBoundaryPosGetter(!0,!0),getEndDocumentPos:createSelectionBoundaryPosGetter(!1,!0)}),api.positionFromPoint=function(x,y,doc){return doc=dom.getContentDocument(doc,module,"positionFromPoint"),createCaretPositionFromPointGetter(doc)(doc,x,y)},api.createRangeFromPoints=createRangeFromPoints,api.moveSelectionToPoints=moveSelectionToPoints}),define("rangy-position",["rangy-core"],function(global){return function(){var ret;return ret||global.rangy.modules.Position}}(this)),define("rangy",["rangy-core","rangy-highlighter","rangy-cssclassapplier","rangy-textrange","rangy-position"],function(core){return core}),ReadiumSDK.Views.MediaOverlayElementHighlighter=function(reader){function ensureUserStyle($element,hasAuthorStyle,overrideWithUserStyle){if($userStyle)try{if($userStyle[0].ownerDocument===$element[0].ownerDocument)return}catch(e){}$head=$("head",$element[0].ownerDocument.documentElement),$userStyle=$("<style type='text/css'> </style>"),$userStyle.append("."+DEFAULT_MO_ACTIVE_CLASS+" {");var fallbackUserStyle="background-color: yellow !important; color: black !important; border-radius: 0.4em;",style=overrideWithUserStyle;if(style){var atLeastOne=!1;for(var prop in style.declarations)style.declarations.hasOwnProperty(prop)&&(atLeastOne=!0,$userStyle.append(prop+": "+style.declarations[prop]+"; "));atLeastOne||hasAuthorStyle||$userStyle.append(fallbackUserStyle)}else hasAuthorStyle||$userStyle.append(fallbackUserStyle);$userStyle.append("}"),$userStyle.appendTo($head)}this.includeParWhenAdjustingToSeqSyncGranularity=!0;var DEFAULT_MO_ACTIVE_CLASS="mo-active-default",DEFAULT_MO_SUB_SYNC_CLASS="mo-sub-sync",_highlightedElementPar=void 0;this.isElementHighlighted=function(par){return _highlightedElementPar&&par===_highlightedElementPar};var _highlightedCfiPar=void 0;this.isCfiHighlighted=function(par){return _highlightedCfiPar&&par===_highlightedCfiPar};var _activeClass="",_playbackActiveClass="",_reader=reader,USE_RANGY=!0&&"undefined"!=typeof rangy,_rangyCSS=void 0,_rangyRange=void 0,HIGHLIGHT_ID="MO_SPEAK",$userStyle=void 0;this.reDo=function(){$userStyle&&$userStyle.remove(),$userStyle=void 0;var he=_highlightedElementPar,hc=_highlightedCfiPar,c1=_activeClass,c2=_playbackActiveClass;_highlightedElementPar?(this.reset(),this.highlightElement(he,c1,c2)):_highlightedCfiPar&&(this.reset(),this.highlightCfi(hc,c1,c2))},this.highlightElement=function(par,activeClass,playbackActiveClass){if(par&&par!==_highlightedElementPar){this.reset(),_highlightedElementPar=par,_highlightedCfiPar=void 0,_activeClass=activeClass,_playbackActiveClass=playbackActiveClass;var seq=this.adjustParToSeqSyncGranularity(_highlightedElementPar),element=seq.element;_playbackActiveClass&&""!==_playbackActiveClass&&$(element.ownerDocument.documentElement).addClass(_playbackActiveClass);var $hel=$(element),hasAuthorStyle=_activeClass&&""!==_activeClass,overrideWithUserStyle=_reader.userStyles().findStyle("."+DEFAULT_MO_ACTIVE_CLASS);ensureUserStyle($hel,hasAuthorStyle,overrideWithUserStyle),overrideWithUserStyle||!hasAuthorStyle?(hasAuthorStyle&&$hel.addClass(_activeClass),$hel.addClass(DEFAULT_MO_ACTIVE_CLASS)):$hel.addClass(_activeClass),(this.includeParWhenAdjustingToSeqSyncGranularity||_highlightedElementPar!==seq)&&$(_highlightedElementPar.element).addClass(DEFAULT_MO_SUB_SYNC_CLASS)}},this.highlightCfi=function(par,activeClass,playbackActiveClass){if(par&&par!==_highlightedCfiPar){this.reset(),_highlightedElementPar=void 0,_highlightedCfiPar=par,_activeClass=activeClass,_playbackActiveClass=playbackActiveClass;var $hel=$(_highlightedCfiPar.cfi.cfiTextParent),hasAuthorStyle=_activeClass&&""!==_activeClass,overrideWithUserStyle=_reader.userStyles().findStyle("."+DEFAULT_MO_ACTIVE_CLASS);ensureUserStyle($hel,hasAuthorStyle,overrideWithUserStyle);var clazz=overrideWithUserStyle||!hasAuthorStyle?(hasAuthorStyle?_activeClass+" ":"")+DEFAULT_MO_ACTIVE_CLASS:_activeClass;if(USE_RANGY){var doc=_highlightedCfiPar.cfi.cfiTextParent.ownerDocument;_rangyRange=rangy.createRange(doc);var startCFI="epubcfi("+_highlightedCfiPar.cfi.partialStartCfi+")",infoStart=EPUBcfi.getTextTerminusInfoWithPartialCFI(startCFI,doc,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),endCFI="epubcfi("+_highlightedCfiPar.cfi.partialEndCfi+")",infoEnd=EPUBcfi.getTextTerminusInfoWithPartialCFI(endCFI,doc,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);_rangyRange.setStartAndEnd(infoStart.textNode[0],infoStart.textOffset,infoEnd.textNode[0],infoEnd.textOffset);_rangyRange.MO_createCssClassApplier=!0,_rangyCSS&&_rangyCSS.cssClass===clazz||(_rangyCSS=rangy.createCssClassApplier(clazz,{elementTagName:"span",elementProperties:{className:"mo-cfi-highlight"},ignoreWhiteSpace:!0,applyToEditableOnly:!1,normalize:!0},["span"])),_rangyCSS.applyToRange(_rangyRange)}else try{var id=par.getSmil().spineItemId;_reader.addHighlight(id,par.cfi.partialRangeCfi,HIGHLIGHT_ID,"highlight",void 0)}catch(error){console.error(error)}}},this.reset=function(){if(_highlightedCfiPar){var doc=_highlightedCfiPar.cfi.cfiTextParent.ownerDocument;if(USE_RANGY){if(_rangyCSS&&_rangyRange.MO_createCssClassApplier)_rangyCSS.undoToRange(_rangyRange);else for(var toRemove=void 0;null!==(toRemove=doc.getElementById(HIGHLIGHT_ID));){var txt=toRemove.textContent,txtNode=doc.createTextNode(txt);toRemove.parentNode.replaceChild(txtNode,toRemove),txtNode.parentNode.normalize()}_rangyRange=void 0}else try{_reader.removeHighlight(HIGHLIGHT_ID);for(var toRemove=void 0;null!==(toRemove=doc.getElementById("start-"+HIGHLIGHT_ID));)console.log("toRemove START"),console.log(toRemove),toRemove.parentNode.removeChild(toRemove);for(;null!==(toRemove=doc.getElementById("end-"+HIGHLIGHT_ID));)console.log("toRemove END"),console.log(toRemove),toRemove.parentNode.removeChild(toRemove)}catch(error){console.error(error)}_highlightedCfiPar=void 0}if(_highlightedElementPar){var seq=this.adjustParToSeqSyncGranularity(_highlightedElementPar),element=seq.element;(this.includeParWhenAdjustingToSeqSyncGranularity||_highlightedElementPar!==seq)&&$(_highlightedElementPar.element).removeClass(DEFAULT_MO_SUB_SYNC_CLASS),_playbackActiveClass&&""!==_playbackActiveClass&&$(element.ownerDocument.documentElement).removeClass(_playbackActiveClass),_activeClass&&""!==_activeClass&&$(element).removeClass(_activeClass),$(element).removeClass(DEFAULT_MO_ACTIVE_CLASS),_highlightedElementPar=void 0}_activeClass="",_playbackActiveClass=""},this.adjustParToSeqSyncGranularity=function(par){if(!par)return void 0;var sync=_reader.viewerSettings().mediaOverlaysSynchronizationGranularity;if(sync&&sync.length>0){var element=par.element||(par.cfi?par.cfi.cfiTextParent:void 0);if(!element)return console.error("adjustParToSeqSyncGranularity !element ???"),par;var seq=par.getFirstSeqAncestorWithEpubType(sync,this.includeParWhenAdjustingToSeqSyncGranularity);if(seq&&seq.element)return seq}return par}},define("mediaOverlayElementHighlighter",["readiumSDK","rangy"],function(global){return function(){var ret;return ret||global.mediaOverlayElementHighlighter}}(this)),ReadiumSDK.Views.MediaOverlayPlayer=function(reader,onStatusChanged){function playPar(par){var parSmil=par.getSmil();return _smilIterator&&_smilIterator.smil==parSmil?_smilIterator.reset():_smilIterator=new ReadiumSDK.Models.SmilIterator(parSmil),_smilIterator.goToPar(par),_smilIterator.currentPar?void playCurrentPar():void console.error("playPar !_smilIterator.currentPar")}function initBlankPagePlayer(){self.resetBlankPage(),_blankPagePlayer=setTimeout(function(){if(_blankPagePlayer){if(self.resetBlankPage(),!_smilIterator||!_smilIterator.currentPar)return void self.reset();audioCurrentTime=0,onAudioPositionChanged(_smilIterator.currentPar.audio.clipEnd+.1,2)}},2e3),onStatusChanged({isPlaying:!0})}function playCurrentPar(){if(_wasPlayingScrolling=!1,!_smilIterator||!_smilIterator.currentPar)return void console.error("playCurrentPar !_smilIterator || !_smilIterator.currentPar ???");if(!_smilIterator.smil.id)return _audioPlayer.reset(),self.resetTTS(),self.resetEmbedded(),void setTimeout(function(){initBlankPagePlayer()},100);if(_smilIterator.currentPar.audio.src){self.resetTTS(),self.resetEmbedded(),self.resetBlankPage();var dur=_smilIterator.currentPar.audio.clipEnd-_smilIterator.currentPar.audio.clipBegin;(0>=dur||clipBeginOffset>dur)&&(console.error("### MO XXX PAR OFFSET: "+clipBeginOffset+" / "+dur),clipBeginOffset=0);var audioContentRef=ReadiumSDK.Helpers.ResolveContentRef(_smilIterator.currentPar.audio.src,_smilIterator.smil.href),audioSource=_package.resolveRelativeUrlMO(audioContentRef),startTime=_smilIterator.currentPar.audio.clipBegin+clipBeginOffset;_audioPlayer.playFile(_smilIterator.currentPar.audio.src,audioSource,startTime)}else{clipBeginOffset=0,_audioPlayer.reset();var element=_smilIterator.currentPar.element;if(element){audioCurrentTime=0;var name=element.nodeName?element.nodeName.toLowerCase():void 0;"audio"===name||"video"===name?(self.resetTTS(),self.resetBlankPage(),_currentEmbedded&&self.resetEmbedded(),_currentEmbedded=element,_currentEmbedded.pause(),_currentEmbedded.currentTime=0,_currentEmbedded.play(),$(_currentEmbedded).on("ended",self.onEmbeddedEnd),_embeddedIsPlaying=!0,setTimeout(function(){onStatusChanged({isPlaying:!0})},80)):(self.resetEmbedded(),self.resetBlankPage(),_currentTTS=element.textContent,_currentTTS&&""!=_currentTTS?speakStart(_currentTTS):_currentTTS=void 0)}var cfi=_smilIterator.currentPar.cfi;if(cfi){audioCurrentTime=0,self.resetEmbedded(),self.resetBlankPage(),_elementHighlighter.reset();var doc=cfi.cfiTextParent.ownerDocument,startCFI="epubcfi("+cfi.partialStartCfi+")",infoStart=EPUBcfi.getTextTerminusInfoWithPartialCFI(startCFI,doc,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),endCFI="epubcfi("+cfi.partialEndCfi+")",infoEnd=EPUBcfi.getTextTerminusInfoWithPartialCFI(endCFI,doc,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(rangy){var range=rangy.createRange(doc);range.setStartAndEnd(infoStart.textNode[0],infoStart.textOffset,infoEnd.textNode[0],infoEnd.textOffset),_currentTTS=range.toString()}else _currentTTS=void 0;_currentTTS&&""!=_currentTTS?speakStart(_currentTTS):_currentTTS=void 0}}clipBeginOffset=0,highlightCurrentElement()}function nextSmil(goNext){self.pause();var nextSmil=goNext?_package.media_overlay.getNextSmil(_smilIterator.smil):_package.media_overlay.getPreviousSmil(_smilIterator.smil);if(nextSmil){if(_smilIterator=new ReadiumSDK.Models.SmilIterator(nextSmil),_smilIterator.currentPar){if(!goNext)for(;!_smilIterator.isLast();)_smilIterator.next();reader.openContentUrl(_smilIterator.currentPar.text.src,_smilIterator.smil.href,self)}}else console.log("No more SMIL"),self.reset()}function onAudioPositionChanged(position,from){if(audioCurrentTime=position,_skipAudioEnded=!1,_smilIterator&&_smilIterator.currentPar){var parFrom=_smilIterator.currentPar,audio=_smilIterator.currentPar.audio;if(!(position>DIRECTION_MARK&&position<=audio.clipEnd)){_skipAudioEnded=!0;var isPlaying=_audioPlayer.isPlaying();isPlaying&&6===from&&console.debug("from userNav _audioPlayer.isPlaying() ???");var goNext=position>audio.clipEnd,doNotNextSmil=!_autoNextSmil&&6!==from&&goNext,spineItemIdRef=_smilIterator&&_smilIterator.smil&&_smilIterator.smil.spineItemId?_smilIterator.smil.spineItemId:_lastPaginationData&&_lastPaginationData.spineItem&&_lastPaginationData.spineItem.idref?_lastPaginationData.spineItem.idref:void 0;if(doNotNextSmil&&spineItemIdRef&&_lastPaginationData&&_lastPaginationData.paginationInfo&&_lastPaginationData.paginationInfo.openPages&&_lastPaginationData.paginationInfo.openPages.length>1){var iPage=0,openPage=_lastPaginationData.paginationInfo.openPages[iPage];spineItemIdRef===openPage.idref&&(doNotNextSmil=!1)}if(goNext?_smilIterator.next():_smilIterator.previous(),!_smilIterator.currentPar)return void(doNotNextSmil?(_wasPausedBecauseNoAutoNextSmil=!0,self.reset()):nextSmil(goNext));if(!_smilIterator.currentPar.audio)return void self.pause();if(_settings.mediaOverlaysSkipSkippables){for(var skip=!1,parent=_smilIterator.currentPar;parent;){if(parent.isSkippable&&parent.isSkippable(_settings.mediaOverlaysSkippables)){skip=!0;break}parent=parent.parent}if(skip){console.log("MO SKIP: "+parent.epubtype),self.pause();var pos=goNext?_smilIterator.currentPar.audio.clipEnd+.1:DIRECTION_MARK-1;return void onAudioPositionChanged(pos,from,!0)}}if(!isPlaying&&(_smilIterator.currentPar.element||_smilIterator.currentPar.cfi&&_smilIterator.currentPar.cfi.cfiTextParent)){var scopeTo=_elementHighlighter.adjustParToSeqSyncGranularity(_smilIterator.currentPar);if(scopeTo&&scopeTo!==_smilIterator.currentPar){var scopeFrom=_elementHighlighter.adjustParToSeqSyncGranularity(parFrom);if(scopeFrom&&(scopeFrom===scopeTo||!goNext)){if(scopeFrom===scopeTo){do goNext?_smilIterator.next():_smilIterator.previous();while(_smilIterator.currentPar&&_smilIterator.currentPar.hasAncestor(scopeFrom));if(!_smilIterator.currentPar)return void(doNotNextSmil?(_wasPausedBecauseNoAutoNextSmil=!0,self.reset()):nextSmil(goNext))}if(!goNext){var landed=_elementHighlighter.adjustParToSeqSyncGranularity(_smilIterator.currentPar);if(landed&&landed!==_smilIterator.currentPar){var backup=_smilIterator.currentPar,innerPar=void 0;do innerPar=_smilIterator.currentPar,_smilIterator.previous();while(_smilIterator.currentPar&&_smilIterator.currentPar.hasAncestor(landed));
_smilIterator.currentPar?(_smilIterator.next(),_smilIterator.currentPar.hasAncestor(landed)||console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar.hasAncestor(landed) ???")):(_smilIterator.reset(),_smilIterator.currentPar!==innerPar&&console.error("adjustParToSeqSyncGranularity _smilIterator.currentPar !=== innerPar???")),_smilIterator.currentPar||(console.error("adjustParToSeqSyncGranularity !_smilIterator.currentPar ?????"),_smilIterator.goToPar(backup))}}}}}return _audioPlayer.isPlaying()&&_smilIterator.currentPar.audio.src&&_smilIterator.currentPar.audio.src==_audioPlayer.currentSmilSrc()&&position>=_smilIterator.currentPar.audio.clipBegin&&position<=_smilIterator.currentPar.audio.clipEnd?void highlightCurrentElement():void playCurrentPar()}}}function ensureTTSStyle($element){if(!$ttsStyle||$ttsStyle[0].ownerDocument!==$element[0].ownerDocument){var style=".tts_on{background-color:red;color:white;} .tts_off{}";$head=$("head",$element[0].ownerDocument.documentElement),$ttsStyle=$("<style type='text/css'> </style>").appendTo($head),$ttsStyle.append(style)}}function onPlay(){onPause();var func=function(){if(_smilIterator&&_smilIterator.currentPar){var smil=_smilIterator.smil;if(smil.mo){var playPosition=audioCurrentTime-_smilIterator.currentPar.audio.clipBegin;if(!(0>=playPosition)){for(var smilIndex=smil.mo.smil_models.indexOf(smil),smilIterator=new ReadiumSDK.Models.SmilIterator(smil),parIndex=-1;smilIterator.currentPar&&(parIndex++,smilIterator.currentPar!=_smilIterator.currentPar);)smilIterator.next();onStatusChanged({playPosition:playPosition,smilIndex:smilIndex,parIndex:parIndex})}}}};setTimeout(func,500),_timerTick=setInterval(func,1500)}function onPause(){audioCurrentTime=0,void 0!==_timerTick&&clearInterval(_timerTick),_timerTick=void 0}function onAudioEnded(){return onPause(),_skipAudioEnded?void(_skipAudioEnded=!1):_smilIterator&&_smilIterator.currentPar?void onAudioPositionChanged(_smilIterator.currentPar.audio.clipEnd+.1,5):void self.reset()}function highlightCurrentElement(){if(_smilIterator&&_smilIterator.currentPar){if(_smilIterator.currentPar.text.srcFragmentId&&_smilIterator.currentPar.text.srcFragmentId.length>0){if(_smilIterator.currentPar.element)return void(_elementHighlighter.isElementHighlighted(_smilIterator.currentPar)||(_elementHighlighter.highlightElement(_smilIterator.currentPar,_package.media_overlay.activeClass,_package.media_overlay.playbackActiveClass),_wasPlayingScrolling||reader.insureElementVisibility(_smilIterator.currentPar.getSmil().spineItemId,_smilIterator.currentPar.element,self)));if(_smilIterator.currentPar.cfi)return void(_elementHighlighter.isCfiHighlighted(_smilIterator.currentPar)||(_elementHighlighter.highlightCfi(_smilIterator.currentPar,_package.media_overlay.activeClass,_package.media_overlay.playbackActiveClass),_wasPlayingScrolling||reader.insureElementVisibility(_smilIterator.currentPar.getSmil().spineItemId,_smilIterator.currentPar.cfi.cfiTextParent,self)))}if(!_smilIterator.currentPar.element){var src=_smilIterator.currentPar.text.src,base=_smilIterator.smil.href;_smilIterator=void 0,reader.openContentUrl(src,base,self)}}}var _smilIterator=void 0,_audioPlayer=new ReadiumSDK.Views.AudioPlayer(onStatusChanged,onAudioPositionChanged,onAudioEnded,onPlay,onPause),_ttsIsPlaying=!1,_currentTTS=void 0,_enableHTMLSpeech=!0&&"undefined"!=typeof window.speechSynthesis&&null!=speechSynthesis,_SpeechSynthesisUtterance=void 0,TOKENIZE_TTS=!1,_embeddedIsPlaying=!1,_currentEmbedded=void 0;this.isPlaying=function(){return _audioPlayer.isPlaying()||_ttsIsPlaying||_embeddedIsPlaying||_blankPagePlayer};var _package=reader.package(),_settings=reader.viewerSettings(),self=this,_elementHighlighter=new ReadiumSDK.Views.MediaOverlayElementHighlighter(reader);reader.on(ReadiumSDK.Events.READER_VIEW_DESTROYED,function(){self.reset()}),this.applyStyles=function(){_elementHighlighter.reDo()},this.onSettingsApplied=function(){_audioPlayer.setRate(_settings.mediaOverlaysRate),_audioPlayer.setVolume(_settings.mediaOverlaysVolume/100)},self.onSettingsApplied(),reader.on(ReadiumSDK.Events.SETTINGS_APPLIED,this.onSettingsApplied,this);var _wasPlayingAtDocLoadStart=!1;this.onDocLoadStart=function(){var wasPlaying=self.isPlaying();wasPlaying&&(_wasPlayingAtDocLoadStart=!0,self.pause())};var _lastPaginationData=void 0;this.onPageChanged=function(paginationData){_lastPaginationData=paginationData;var wasPausedBecauseNoAutoNextSmil=_wasPausedBecauseNoAutoNextSmil;_wasPausedBecauseNoAutoNextSmil=!1;var wasPlayingAtDocLoadStart=_wasPlayingAtDocLoadStart;if(_wasPlayingAtDocLoadStart=!1,!paginationData)return void self.reset();var element=void 0,fakeOpfRoot="/99!",epubCfiPrefix="epubcfi";if(paginationData.elementId||paginationData.initiator==self){for(var spineItems=reader.getLoadedSpineItems(),rtl=reader.spine().isRightToLeft(),i=rtl?spineItems.length-1:0;rtl&&i>=0||!rtl&&i<spineItems.length;i+=rtl?-1:1){var spineItem=spineItems[i];if(!paginationData.spineItem||paginationData.spineItem==spineItem){if(paginationData.elementId&&0===paginationData.elementId.indexOf(epubCfiPrefix)){_elementHighlighter.reset();var partial=paginationData.elementId.substr(epubCfiPrefix.length+1,paginationData.elementId.length-epubCfiPrefix.length-2);0===partial.indexOf(fakeOpfRoot)&&(partial=partial.substr(fakeOpfRoot.length,partial.length-fakeOpfRoot.length));var parts=partial.split(",");if(parts&&3===parts.length)try{var cfi=parts[0]+parts[1],$element=reader.getElementByCfi(spineItem,cfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(element=$element&&$element.length>0?$element[0]:void 0){element.nodeType===Node.TEXT_NODE&&(element=element.parentNode);break}}catch(error){console.error(error)}else try{var $element=reader.getElementByCfi(spineItem,partial,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);if(element=$element&&$element.length>0?$element[0]:void 0){element.nodeType===Node.TEXT_NODE&&(element=element.parentNode);break}}catch(error){console.error(error)}}if(!element){if(paginationData.initiator!=self||paginationData.elementId){var $element=reader.getElementById(spineItem,paginationData.elementId);element=$element&&$element.length>0?$element[0]:void 0}else{var $element=reader.getElement(spineItem,"body");element=$element&&$element.length>0?$element[0]:void 0}if(element)break}}}element||console.error("paginationData.elementId BUT !element: "+paginationData.elementId)}var wasPlaying=self.isPlaying()||wasPlayingAtDocLoadStart;if(!_smilIterator||!_smilIterator.currentPar){if(paginationData.initiator!==self)return clipBeginOffset=0,self.reset(),void(paginationData.elementId&&element?(wasPlaying||wasPausedBecauseNoAutoNextSmil)&&(paginationData.elementIdResolved=element,self.toggleMediaOverlayRefresh(paginationData)):(wasPlaying||wasPausedBecauseNoAutoNextSmil)&&self.toggleMediaOverlay());if(!element)return console.error("!element: "+paginationData.elementId),void(clipBeginOffset=0);var moData=$(element).data("mediaOverlayData");if(!moData)return console.error("!moData: "+paginationData.elementId),void(clipBeginOffset=0);var parToPlay=moData.par?moData.par:moData.pars[0];if(moData.pars)for(var iPar=0;iPar<moData.pars.length;iPar++){var p=moData.pars[iPar];if(paginationData.elementId===p.cfi.smilTextSrcCfi){parToPlay=p;break}}return void playPar(parToPlay)}var noReverseData=!_smilIterator.currentPar.element&&!_smilIterator.currentPar.cfi;if(noReverseData&&console.error("!! _smilIterator.currentPar.element ??"),paginationData.initiator==self){var notSameTargetID=paginationData.elementId&&paginationData.elementId!==_smilIterator.currentPar.text.srcFragmentId;if(notSameTargetID&&console.error("!! paginationData.elementId !== _smilIterator.currentPar.text.srcFragmentId"),notSameTargetID||noReverseData)return void(clipBeginOffset=0);wasPlaying?highlightCurrentElement():playCurrentPar()}else{if(!wasPlaying&&!wasPausedBecauseNoAutoNextSmil)return void self.reset();if(!paginationData.elementId,paginationData.elementId&&!element)return;paginationData.elementId&&(paginationData.elementIdResolved=element),self.toggleMediaOverlayRefresh(paginationData)}};var clipBeginOffset=0,_blankPagePlayer=void 0,_skipAudioEnded=!1,audioCurrentTime=0,DIRECTION_MARK=-999;this.touchInit=function(){var todo=_audioPlayer.touchInit();todo&&_enableHTMLSpeech&&speakStart("o",0)};var tokeniseTTS=function(element){var BLOCK_DELIMITERS=["p","div","pagenum","td","table","li","ul","ol"],BOUNDARY_PUNCTUATION=[",",";",".","-","??","??","?","!"],flush=function(t,r){if(!(t.word.length<=0)){var pos=t.text.length;r.spanMap[pos]=t.counter,t.text+=t.word,t.markup+=t.html.substring(0,t.wordStart)+'<span class="tts_off" id="tts_'+t.counter+'">'+t.html.substring(t.wordStart,t.wordEnd)+"</span>"+t.html.substring(t.wordEnd,t.html.length),t.word="",t.html="",t.wordStart=-1,t.wordEnd=-1,t.counter++}},r={element:element,innerHTML_tts:"",spanMap:{},text:"",lastCharIndex:void 0};r.element.innerHTML_original=element.innerHTML;for(var t={inTag:!1,counter:0,wordStart:-1,wordEnd:-1,text:"",markup:"",word:"",html:""},limit=r.element.innerHTML_original.length,i=0;limit>=i;){if(t.inTag){if(t.html+=r.element.innerHTML_original[i],">"==r.element.innerHTML_original[i]){t.inTag=!1;var blockCheck=t.html.match(/<\/(.*?)>$/);blockCheck&&BLOCK_DELIMITERS.indexOf(blockCheck[1])>-1&&(flush(t,r),t.text+=" ")}}else i==limit||r.element.innerHTML_original[i].match(/\s/)?(flush(t,r),limit>i&&(t.text+=r.element.innerHTML_original[i],t.markup+=r.element.innerHTML_original[i])):BOUNDARY_PUNCTUATION.indexOf(r.element.innerHTML_original[i])>-1?(flush(t,r),t.wordStart=t.html.length,t.wordEnd=t.html.length+1,t.word+=r.element.innerHTML_original[i],t.html+=r.element.innerHTML_original[i],flush(t,r)):"<"==r.element.innerHTML_original[i]?(t.inTag=!0,t.html+=r.element.innerHTML_original[i]):(0==t.word.length&&(t.wordStart=t.html.length),t.wordEnd=t.html.length+1,t.word+=r.element.innerHTML_original[i],t.html+=r.element.innerHTML_original[i]);i++}return r.text=t.text,r.innerHTML_tts=t.markup,r.element.innerHTML=r.innerHTML_tts,r},$ttsStyle=void 0,speakStart=function(txt,volume){function cancelTTS(first){first||window.speechSynthesis.pending?(console.debug("TTS cancel before speak"),window.speechSynthesis.cancel(),setTimeout(function(){cancelTTS(!1)},5)):updateTTS()}function updateTTS(){_SpeechSynthesisUtterance=new SpeechSynthesisUtterance,TOKENIZE_TTS&&tokenData&&(_SpeechSynthesisUtterance.tokenData=tokenData,_SpeechSynthesisUtterance.onboundary=function(event){if(_SpeechSynthesisUtterance){console.debug("TTS boundary: "+event.name+" / "+event.charIndex);var tokenised=event.target.tokenData;if(tokenised&&tokenised.spanMap.hasOwnProperty(event.charIndex)){var id;[].forEach.call(tokenised.element.querySelectorAll(".tts_on"),function(el){console.debug("TTS OFF "+el.id),el.className="tts_off"});var id="tts_"+tokenised.spanMap[event.charIndex];console.debug("TTS charIndex ID: "+id);var spanNew=tokenised.element.querySelector("#"+id);spanNew&&(console.debug("TTS ON"),spanNew.className="tts_on"),tokenised.lastCharIndex=event.charIndex}}}),_SpeechSynthesisUtterance.onend=function(event){if(_SpeechSynthesisUtterance)if(console.debug("TTS ended"),TOKENIZE_TTS){var tokenised=event.target.tokenData,doEnd=!event.forceSkipEnd&&_SpeechSynthesisUtterance===event.target&&(!tokenised||tokenised.element.innerHTML_original);tokenised&&(tokenised.element.innerHTML_original?tokenised.element.innerHTML=tokenised.element.innerHTML_original:[].forEach.call(tokenised.element.querySelectorAll(".tts_on"),function(el){console.debug("TTS OFF (end)"+el.id),el.className="tts_off"}),tokenised.element.innerHTML_original=void 0),doEnd?self.onTTSEnd():console.debug("TTS end SKIPPED")}else self.onTTSEnd()},_SpeechSynthesisUtterance.onerror=function(event){if(_SpeechSynthesisUtterance&&(console.error("TTS error"),console.debug(_SpeechSynthesisUtterance.text),console.debug(window.speechSynthesis.paused),console.debug(window.speechSynthesis.pending),console.debug(window.speechSynthesis.speaking),TOKENIZE_TTS)){var tokenised=event.target.tokenData;tokenised&&(tokenised.element.innerHTML_original?tokenised.element.innerHTML=tokenised.element.innerHTML_original:[].forEach.call(tokenised.element.ownerDocument.querySelectorAll(".tts_on"),function(el){console.debug("TTS OFF (error)"+el.id),el.className="tts_off"}),tokenised.element.innerHTML_original=void 0)}};var vol=volume||_audioPlayer.getVolume();_SpeechSynthesisUtterance.volume=vol,_SpeechSynthesisUtterance.rate=_audioPlayer.getRate(),_SpeechSynthesisUtterance.pitch=1,_SpeechSynthesisUtterance.text=text,window.speechSynthesis.speak(_SpeechSynthesisUtterance),window.speechSynthesis.paused&&(console.debug("TTS resume"),window.speechSynthesis.resume())}{var tokenData=void 0,curPar=_smilIterator&&_smilIterator.currentPar?_smilIterator.currentPar:void 0,element=curPar?curPar.element:void 0;curPar?curPar.cfi:void 0}if((!volume||volume>0)&&(setTimeout(function(){onStatusChanged({isPlaying:!0})},80),_ttsIsPlaying=!0,TOKENIZE_TTS&&element)){var $el=$(element);ensureTTSStyle($el),element.innerHTML_original&&(element.innerHTML=element.innerHTML_original,element.innerHTML_original=void 0),tokenData=tokeniseTTS(element)}if(!_enableHTMLSpeech)return void reader.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_SPEAK,{tts:txt});if(!txt&&window.speechSynthesis.paused)return void window.speechSynthesis.resume();var text=txt||_currentTTS;text&&(_SpeechSynthesisUtterance&&(TOKENIZE_TTS&&(_SpeechSynthesisUtterance.onend&&_SpeechSynthesisUtterance.onend({forceSkipEnd:!0,target:_SpeechSynthesisUtterance}),_SpeechSynthesisUtterance.tokenData=void 0,_SpeechSynthesisUtterance.onboundary=void 0),_SpeechSynthesisUtterance.onend=void 0,_SpeechSynthesisUtterance.onerror=void 0,_SpeechSynthesisUtterance=void 0),console.debug("paused: "+window.speechSynthesis.paused),console.debug("speaking: "+window.speechSynthesis.speaking),console.debug("pending: "+window.speechSynthesis.pending),cancelTTS(!0))},speakStop=function(){return onStatusChanged({isPlaying:!1}),_ttsIsPlaying=!1,_enableHTMLSpeech?void window.speechSynthesis.pause():void reader.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_TTS_STOP,void 0)},_timerTick=void 0;this.onEmbeddedEnd=function(){return audioCurrentTime=0,_embeddedIsPlaying=!1,_smilIterator&&_smilIterator.currentPar?void onAudioPositionChanged(_smilIterator.currentPar.audio.clipEnd+.1,3):void self.reset()},this.onTTSEnd=function(){return audioCurrentTime=0,_ttsIsPlaying=!1,_smilIterator&&_smilIterator.currentPar?void onAudioPositionChanged(_smilIterator.currentPar.audio.clipEnd+.1,4):void self.reset()},this.escape=function(){if(!_smilIterator||!_smilIterator.currentPar)return void this.toggleMediaOverlay();if(!self.isPlaying())return void self.play();if(_settings.mediaOverlaysEscapeEscapables)for(var parent=_smilIterator.currentPar;parent;){if(parent.isEscapable&&parent.isEscapable(_settings.mediaOverlaysEscapables)){do _smilIterator.next();while(_smilIterator.currentPar&&_smilIterator.currentPar.hasAncestor(parent));return _smilIterator.currentPar?void playCurrentPar():void nextSmil(!0)}parent=parent.parent}this.nextMediaOverlay(!0)},this.playUserPar=function(par){if(self.isPlaying()&&self.pause(),par.element||par.cfi&&par.cfi.cfiTextParent){var seq=_elementHighlighter.adjustParToSeqSyncGranularity(par);if(seq&&seq!==par){var findFirstPar=function(smilNode){if(smilNode.nodeType&&"par"===smilNode.nodeType)return smilNode;if(!smilNode.children||smilNode.children.length<=0)return void 0;for(var i=0;i<smilNode.children.length;i++){var child=smilNode.children[i],inPar=findFirstPar(child);if(inPar)return inPar}},firstPar=findFirstPar(seq);firstPar&&(par=firstPar)}}playPar(par)},this.resetTTS=function(){_currentTTS=void 0,speakStop()},this.resetBlankPage=function(){if(_blankPagePlayer){var timer=_blankPagePlayer;_blankPagePlayer=void 0,clearTimeout(timer)}_blankPagePlayer=void 0,onStatusChanged({isPlaying:!1})},this.resetEmbedded=function(){_currentEmbedded&&($(_currentEmbedded).off("ended",self.onEmbeddedEnd),_currentEmbedded.pause()),_currentEmbedded=void 0,onStatusChanged({isPlaying:!1}),_embeddedIsPlaying=!1},this.reset=function(){clipBeginOffset=0,_audioPlayer.reset(),self.resetTTS(),self.resetEmbedded(),self.resetBlankPage(),_elementHighlighter.reset(),_smilIterator=void 0,_skipAudioEnded=!1},this.play=function(){if(_smilIterator&&_smilIterator.smil&&!_smilIterator.smil.id)return void initBlankPagePlayer();if(_currentEmbedded)_embeddedIsPlaying=!0,_currentEmbedded.play(),onStatusChanged({isPlaying:!0});else if(_currentTTS)speakStart(void 0);else if(!_audioPlayer.play())return console.log("Audio player was dead, reactivating..."),this.reset(),void this.toggleMediaOverlay();highlightCurrentElement()},this.pause=function(){_wasPlayingScrolling=!1,_blankPagePlayer?this.resetBlankPage():_embeddedIsPlaying?(_embeddedIsPlaying=!1,_currentEmbedded&&_currentEmbedded.pause(),onStatusChanged({isPlaying:!1})):_ttsIsPlaying?speakStop():_audioPlayer.pause(),_elementHighlighter.reset()},this.isMediaOverlayAvailable=function(){var visibleMediaElement=reader.getFirstVisibleMediaOverlayElement();return"undefined"!=typeof visibleMediaElement},this.nextOrPreviousMediaOverlay=function(previous){if(self.isPlaying())self.pause();else if(_smilIterator&&_smilIterator.currentPar)return void self.play();if(!_smilIterator)return void this.toggleMediaOverlay();var position=previous?DIRECTION_MARK-1:_smilIterator.currentPar.audio.clipEnd+.1;onAudioPositionChanged(position,6)},this.nextMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!1)},this.previousMediaOverlay=function(){this.nextOrPreviousMediaOverlay(!0)},this.mediaOverlaysOpenContentUrl=function(contentRefUrl,sourceFileHref,offset){clipBeginOffset=offset,_smilIterator=void 0,reader.openContentUrl(contentRefUrl,sourceFileHref,self)},this.toggleMediaOverlay=function(){return self.isPlaying()?void self.pause():_smilIterator?void self.play():void this.toggleMediaOverlayRefresh(void 0)};var _wasPlayingScrolling=!1;this.toggleMediaOverlayRefresh=function(paginationData){var spineItems=reader.getLoadedSpineItems(),rtl=reader.spine().isRightToLeft(),playingPar=void 0,wasPlaying=self.isPlaying();if(wasPlaying&&_smilIterator){var isScrollView=paginationData.initiator&&paginationData.initiator instanceof ReadiumSDK.Views.ScrollView;if(isScrollView&&_settings.mediaOverlaysPreservePlaybackWhenScroll)return void(_wasPlayingScrolling=!0);playingPar=_smilIterator.currentPar,self.pause()}_wasPlayingScrolling=!1;var element=paginationData&&paginationData.elementIdResolved?paginationData.elementIdResolved:void 0,id=paginationData&&paginationData.elementId?paginationData.elementId:void 0;if(!element){id&&console.error("[WARN] id did not resolve to element?");for(var i=rtl?spineItems.length-1:0;rtl&&i>=0||!rtl&&i<spineItems.length;i+=rtl?-1:1){var spineItem=spineItems[i];if(spineItem){if(!paginationData||!paginationData.spineItem||paginationData.spineItem==spineItem){if(id){var $element=reader.getElementById(spineItem,id);element=$element&&$element.length>0?$element[0]:void 0}else if(spineItem.isFixedLayout()&&paginationData&&paginationData.paginationInfo&&paginationData.paginationInfo.openPages){var index=0;if(paginationData.paginationInfo.openPages[index]&&paginationData.paginationInfo.openPages[index].idref&&paginationData.paginationInfo.openPages[index].idref===spineItem.idref){var $element=reader.getElement(spineItem,"body");element=$element&&$element.length>0?$element[0]:void 0}}if(element)break}}else console.error("spineItems[i] is undefined??")}}if(element||(element=reader.getFirstVisibleMediaOverlayElement()),!element)return void self.reset();var moData=$(element).data("mediaOverlayData");if(!moData){for(var foundMe=!1,depthFirstTraversal=function(elements){if(!elements)return!1;for(var i=0;i<elements.length;i++){if(element===elements[i]&&(foundMe=!0),foundMe){var d=$(elements[i]).data("mediaOverlayData");if(d)return moData=d,!0}var found=depthFirstTraversal(elements[i].children);if(found)return!0}return!1},root=element;root&&"body"!==root.nodeName.toLowerCase();)root=root.parentNode;if(!root)return void self.reset();depthFirstTraversal([root])}if(!moData)return void self.reset();var zPar=moData.par?moData.par:moData.pars[0],parSmil=zPar.getSmil();return _smilIterator&&_smilIterator.smil==parSmil?_smilIterator.reset():_smilIterator=new ReadiumSDK.Models.SmilIterator(parSmil),_smilIterator.goToPar(zPar),!_smilIterator.currentPar&&id&&(_smilIterator.reset(),_smilIterator.findTextId(id)),_smilIterator.currentPar?void(wasPlaying&&playingPar&&playingPar===_smilIterator.currentPar?self.play():playCurrentPar()):void self.reset()},this.isPlayingCfi=function(){return _smilIterator&&_smilIterator.currentPar&&_smilIterator.currentPar.cfi};var _wasPausedBecauseNoAutoNextSmil=!1,_autoNextSmil=!0;this.setAutomaticNextSmil=function(autoNext){_autoNextSmil=autoNext}},define("mediaOverlayPlayer",["readiumSDK","mediaOverlay","audioPlayer","mediaOverlayElementHighlighter","rangy"],function(global){return function(){var ret;return ret||global.mediaOverlayPlayer}}(this)),ReadiumSDK.Models.PageOpenRequest=function(spineItem,initiator){this.spineItem=spineItem,this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1,this.initiator=initiator,this.reset=function(){this.spineItemPageIndex=void 0,this.elementId=void 0,this.elementCfi=void 0,this.firstPage=!1,this.lastPage=!1},this.setFirstPage=function(){this.reset(),this.firstPage=!0},this.setLastPage=function(){this.reset(),this.lastPage=!0},this.setPageIndex=function(pageIndex){this.reset(),this.spineItemPageIndex=pageIndex},this.setElementId=function(elementId){this.reset(),this.elementId=elementId},this.setElementCfi=function(elementCfi){this.reset(),this.elementCfi=elementCfi}},define("pageOpenRequest",["readiumSDK"],function(global){return function(){var ret;return ret||global.pageOpenRequest}}(this)),function(global){var EPUBcfi={};EPUBcfi.Parser=function(){function quote(s){return'"'+s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var result={parse:function(input,startRule){function matchFailed(failure){rightmostFailuresPos>pos||(pos>rightmostFailuresPos&&(rightmostFailuresPos=pos,rightmostFailuresExpected=[]),rightmostFailuresExpected.push(failure))}function parse_fragment(){var result0,result1,result2,pos0,pos1;return pos0=pos,pos1=pos,"epubcfi("===input.substr(pos,8)?(result0="epubcfi(",pos+=8):(result0=null,0===reportFailures&&matchFailed('"epubcfi("')),null!==result0?(result1=parse_range(),null===result1&&(result1=parse_path()),null!==result1?(41===input.charCodeAt(pos)?(result2=")",pos++):(result2=null,0===reportFailures&&matchFailed('")"')),null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,fragmentVal){return{type:"CFIAST",cfiString:fragmentVal}}(pos0,result0[1])),null===result0&&(pos=pos0),result0}function parse_range(){var result0,result1,result2,result3,result4,result5,pos0,pos1;return pos0=pos,pos1=pos,result0=parse_indexStep(),null!==result0?(result1=parse_local_path(),null!==result1?(44===input.charCodeAt(pos)?(result2=",",pos++):(result2=null,0===reportFailures&&matchFailed('","')),null!==result2?(result3=parse_local_path(),null!==result3?(44===input.charCodeAt(pos)?(result4=",",pos++):(result4=null,0===reportFailures&&matchFailed('","')),null!==result4?(result5=parse_local_path(),null!==result5?result0=[result0,result1,result2,result3,result4,result5]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,stepVal,localPathVal,rangeLocalPath1Val,rangeLocalPath2Val){return{type:"range",path:stepVal,localPath:localPathVal,range1:rangeLocalPath1Val,range2:rangeLocalPath2Val}}(pos0,result0[0],result0[1],result0[3],result0[5])),null===result0&&(pos=pos0),result0}function parse_path(){var result0,result1,pos0,pos1;return pos0=pos,pos1=pos,result0=parse_indexStep(),null!==result0?(result1=parse_local_path(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,stepVal,localPathVal){return{type:"path",path:stepVal,localPath:localPathVal}}(pos0,result0[0],result0[1])),null===result0&&(pos=pos0),result0}function parse_local_path(){var result0,result1,pos0,pos1;if(pos0=pos,pos1=pos,result1=parse_indexStep(),null===result1&&(result1=parse_indirectionStep()),null!==result1)for(result0=[];null!==result1;)result0.push(result1),result1=parse_indexStep(),null===result1&&(result1=parse_indirectionStep());else result0=null;return null!==result0?(result1=parse_terminus(),result1=null!==result1?result1:"",null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,localPathStepVal,termStepVal){return{steps:localPathStepVal,termStep:termStepVal}}(pos0,result0[0],result0[1])),null===result0&&(pos=pos0),result0}function parse_indexStep(){var result0,result1,result2,result3,result4,pos0,pos1,pos2;return pos0=pos,pos1=pos,47===input.charCodeAt(pos)?(result0="/",pos++):(result0=null,0===reportFailures&&matchFailed('"/"')),null!==result0?(result1=parse_integer(),null!==result1?(pos2=pos,91===input.charCodeAt(pos)?(result2="[",pos++):(result2=null,0===reportFailures&&matchFailed('"["')),null!==result2?(result3=parse_idAssertion(),null!==result3?(93===input.charCodeAt(pos)?(result4="]",pos++):(result4=null,0===reportFailures&&matchFailed('"]"')),null!==result4?result2=[result2,result3,result4]:(result2=null,pos=pos2)):(result2=null,pos=pos2)):(result2=null,pos=pos2),result2=null!==result2?result2:"",null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,stepLengthVal,assertVal){return{type:"indexStep",stepLength:stepLengthVal,idAssertion:assertVal[1]}}(pos0,result0[1],result0[2])),null===result0&&(pos=pos0),result0}function parse_indirectionStep(){var result0,result1,result2,result3,result4,pos0,pos1,pos2;return pos0=pos,pos1=pos,"!/"===input.substr(pos,2)?(result0="!/",pos+=2):(result0=null,0===reportFailures&&matchFailed('"!/"')),null!==result0?(result1=parse_integer(),null!==result1?(pos2=pos,91===input.charCodeAt(pos)?(result2="[",pos++):(result2=null,0===reportFailures&&matchFailed('"["')),null!==result2?(result3=parse_idAssertion(),null!==result3?(93===input.charCodeAt(pos)?(result4="]",pos++):(result4=null,0===reportFailures&&matchFailed('"]"')),null!==result4?result2=[result2,result3,result4]:(result2=null,pos=pos2)):(result2=null,pos=pos2)):(result2=null,pos=pos2),result2=null!==result2?result2:"",null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,stepLengthVal,assertVal){return{type:"indirectionStep",stepLength:stepLengthVal,idAssertion:assertVal[1]}}(pos0,result0[1],result0[2])),null===result0&&(pos=pos0),result0}function parse_terminus(){var result0,result1,result2,result3,result4,pos0,pos1,pos2;return pos0=pos,pos1=pos,58===input.charCodeAt(pos)?(result0=":",pos++):(result0=null,0===reportFailures&&matchFailed('":"')),null!==result0?(result1=parse_integer(),null!==result1?(pos2=pos,91===input.charCodeAt(pos)?(result2="[",pos++):(result2=null,0===reportFailures&&matchFailed('"["')),null!==result2?(result3=parse_textLocationAssertion(),null!==result3?(93===input.charCodeAt(pos)?(result4="]",pos++):(result4=null,0===reportFailures&&matchFailed('"]"')),null!==result4?result2=[result2,result3,result4]:(result2=null,pos=pos2)):(result2=null,pos=pos2)):(result2=null,pos=pos2),result2=null!==result2?result2:"",null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,textOffsetValue,textLocAssertVal){return{type:"textTerminus",offsetValue:textOffsetValue,textAssertion:textLocAssertVal[1]}}(pos0,result0[1],result0[2])),null===result0&&(pos=pos0),result0}function parse_idAssertion(){var result0,pos0;return pos0=pos,result0=parse_value(),null!==result0&&(result0=function(offset,idVal){return idVal}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_textLocationAssertion(){var result0,result1,pos0,pos1;return pos0=pos,pos1=pos,result0=parse_csv(),result0=null!==result0?result0:"",null!==result0?(result1=parse_parameter(),result1=null!==result1?result1:"",null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,csvVal,paramVal){return{type:"textLocationAssertion",csv:csvVal,parameter:paramVal}}(pos0,result0[0],result0[1])),null===result0&&(pos=pos0),result0}function parse_parameter(){var result0,result1,result2,result3,pos0,pos1;return pos0=pos,pos1=pos,59===input.charCodeAt(pos)?(result0=";",pos++):(result0=null,0===reportFailures&&matchFailed('";"')),null!==result0?(result1=parse_valueNoSpace(),null!==result1?(61===input.charCodeAt(pos)?(result2="=",pos++):(result2=null,0===reportFailures&&matchFailed('"="')),null!==result2?(result3=parse_valueNoSpace(),null!==result3?result0=[result0,result1,result2,result3]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,paramLHSVal,paramRHSVal){return{type:"parameter",LHSValue:paramLHSVal,RHSValue:paramRHSVal}}(pos0,result0[1],result0[3])),null===result0&&(pos=pos0),result0}function parse_csv(){var result0,result1,result2,pos0,pos1;return pos0=pos,pos1=pos,result0=parse_value(),result0=null!==result0?result0:"",null!==result0?(44===input.charCodeAt(pos)?(result1=",",pos++):(result1=null,0===reportFailures&&matchFailed('","')),null!==result1?(result2=parse_value(),result2=null!==result2?result2:"",null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,preAssertionVal,postAssertionVal){return{type:"csv",preAssertion:preAssertionVal,postAssertion:postAssertionVal}}(pos0,result0[0],result0[2])),null===result0&&(pos=pos0),result0}function parse_valueNoSpace(){var result0,result1,pos0;if(pos0=pos,result1=parse_escapedSpecialChars(),null===result1&&(result1=parse_character()),null!==result1)for(result0=[];null!==result1;)result0.push(result1),result1=parse_escapedSpecialChars(),null===result1&&(result1=parse_character());else result0=null;return null!==result0&&(result0=function(offset,stringVal){return stringVal.join("")}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_value(){var result0,result1,pos0;if(pos0=pos,result1=parse_escapedSpecialChars(),null===result1&&(result1=parse_character(),null===result1&&(result1=parse_space())),null!==result1)for(result0=[];null!==result1;)result0.push(result1),result1=parse_escapedSpecialChars(),null===result1&&(result1=parse_character(),null===result1&&(result1=parse_space()));else result0=null;return null!==result0&&(result0=function(offset,stringVal){return stringVal.join("")}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_escapedSpecialChars(){var result0,result1,pos0,pos1;return pos0=pos,pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_circumflex(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null===result0&&(pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_squareBracket(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null===result0&&(pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_parentheses(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null===result0&&(pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_comma(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null===result0&&(pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_semicolon(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1),null===result0&&(pos1=pos,result0=parse_circumflex(),null!==result0?(result1=parse_equal(),null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)):(result0=null,pos=pos1)))))),null!==result0&&(result0=function(offset,escSpecCharVal){return escSpecCharVal[1]
}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_number(){var result0,result1,result2,result3,pos0,pos1,pos2;if(pos0=pos,pos1=pos,pos2=pos,/^[1-9]/.test(input.charAt(pos))?(result0=input.charAt(pos),pos++):(result0=null,0===reportFailures&&matchFailed("[1-9]")),null!==result0){if(/^[0-9]/.test(input.charAt(pos))?(result2=input.charAt(pos),pos++):(result2=null,0===reportFailures&&matchFailed("[0-9]")),null!==result2)for(result1=[];null!==result2;)result1.push(result2),/^[0-9]/.test(input.charAt(pos))?(result2=input.charAt(pos),pos++):(result2=null,0===reportFailures&&matchFailed("[0-9]"));else result1=null;null!==result1?result0=[result0,result1]:(result0=null,pos=pos2)}else result0=null,pos=pos2;if(null!==result0)if(46===input.charCodeAt(pos)?(result1=".",pos++):(result1=null,0===reportFailures&&matchFailed('"."')),null!==result1){for(pos2=pos,result2=[],/^[0-9]/.test(input.charAt(pos))?(result3=input.charAt(pos),pos++):(result3=null,0===reportFailures&&matchFailed("[0-9]"));null!==result3;)result2.push(result3),/^[0-9]/.test(input.charAt(pos))?(result3=input.charAt(pos),pos++):(result3=null,0===reportFailures&&matchFailed("[0-9]"));null!==result2?(/^[1-9]/.test(input.charAt(pos))?(result3=input.charAt(pos),pos++):(result3=null,0===reportFailures&&matchFailed("[1-9]")),null!==result3?result2=[result2,result3]:(result2=null,pos=pos2)):(result2=null,pos=pos2),null!==result2?result0=[result0,result1,result2]:(result0=null,pos=pos1)}else result0=null,pos=pos1;else result0=null,pos=pos1;return null!==result0&&(result0=function(offset,intPartVal,fracPartVal){return intPartVal.join("")+"."+fracPartVal.join("")}(pos0,result0[0],result0[2])),null===result0&&(pos=pos0),result0}function parse_integer(){var result0,result1,result2,pos0,pos1;if(pos0=pos,48===input.charCodeAt(pos)?(result0="0",pos++):(result0=null,0===reportFailures&&matchFailed('"0"')),null===result0)if(pos1=pos,/^[1-9]/.test(input.charAt(pos))?(result0=input.charAt(pos),pos++):(result0=null,0===reportFailures&&matchFailed("[1-9]")),null!==result0){for(result1=[],/^[0-9]/.test(input.charAt(pos))?(result2=input.charAt(pos),pos++):(result2=null,0===reportFailures&&matchFailed("[0-9]"));null!==result2;)result1.push(result2),/^[0-9]/.test(input.charAt(pos))?(result2=input.charAt(pos),pos++):(result2=null,0===reportFailures&&matchFailed("[0-9]"));null!==result1?result0=[result0,result1]:(result0=null,pos=pos1)}else result0=null,pos=pos1;return null!==result0&&(result0=function(offset,integerVal){return"0"===integerVal?"0":integerVal[0].concat(integerVal[1].join(""))}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_space(){var result0,pos0;return pos0=pos,32===input.charCodeAt(pos)?(result0=" ",pos++):(result0=null,0===reportFailures&&matchFailed('" "')),null!==result0&&(result0=function(){return" "}(pos0)),null===result0&&(pos=pos0),result0}function parse_circumflex(){var result0,pos0;return pos0=pos,94===input.charCodeAt(pos)?(result0="^",pos++):(result0=null,0===reportFailures&&matchFailed('"^"')),null!==result0&&(result0=function(){return"^"}(pos0)),null===result0&&(pos=pos0),result0}function parse_doubleQuote(){var result0,pos0;return pos0=pos,34===input.charCodeAt(pos)?(result0='"',pos++):(result0=null,0===reportFailures&&matchFailed('"\\""')),null!==result0&&(result0=function(){return'"'}(pos0)),null===result0&&(pos=pos0),result0}function parse_squareBracket(){var result0,pos0;return pos0=pos,91===input.charCodeAt(pos)?(result0="[",pos++):(result0=null,0===reportFailures&&matchFailed('"["')),null===result0&&(93===input.charCodeAt(pos)?(result0="]",pos++):(result0=null,0===reportFailures&&matchFailed('"]"'))),null!==result0&&(result0=function(offset,bracketVal){return bracketVal}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_parentheses(){var result0,pos0;return pos0=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null===result0&&(41===input.charCodeAt(pos)?(result0=")",pos++):(result0=null,0===reportFailures&&matchFailed('")"'))),null!==result0&&(result0=function(offset,paraVal){return paraVal}(pos0,result0)),null===result0&&(pos=pos0),result0}function parse_comma(){var result0,pos0;return pos0=pos,44===input.charCodeAt(pos)?(result0=",",pos++):(result0=null,0===reportFailures&&matchFailed('","')),null!==result0&&(result0=function(){return","}(pos0)),null===result0&&(pos=pos0),result0}function parse_semicolon(){var result0,pos0;return pos0=pos,59===input.charCodeAt(pos)?(result0=";",pos++):(result0=null,0===reportFailures&&matchFailed('";"')),null!==result0&&(result0=function(){return";"}(pos0)),null===result0&&(pos=pos0),result0}function parse_equal(){var result0,pos0;return pos0=pos,61===input.charCodeAt(pos)?(result0="=",pos++):(result0=null,0===reportFailures&&matchFailed('"="')),null!==result0&&(result0=function(){return"="}(pos0)),null===result0&&(pos=pos0),result0}function parse_character(){var result0,pos0;return pos0=pos,/^[a-z]/.test(input.charAt(pos))?(result0=input.charAt(pos),pos++):(result0=null,0===reportFailures&&matchFailed("[a-z]")),null===result0&&(/^[A-Z]/.test(input.charAt(pos))?(result0=input.charAt(pos),pos++):(result0=null,0===reportFailures&&matchFailed("[A-Z]")),null===result0&&(/^[0-9]/.test(input.charAt(pos))?(result0=input.charAt(pos),pos++):(result0=null,0===reportFailures&&matchFailed("[0-9]")),null===result0&&(45===input.charCodeAt(pos)?(result0="-",pos++):(result0=null,0===reportFailures&&matchFailed('"-"')),null===result0&&(95===input.charCodeAt(pos)?(result0="_",pos++):(result0=null,0===reportFailures&&matchFailed('"_"')),null===result0&&(46===input.charCodeAt(pos)?(result0=".",pos++):(result0=null,0===reportFailures&&matchFailed('"."'))))))),null!==result0&&(result0=function(offset,charVal){return charVal}(pos0,result0)),null===result0&&(pos=pos0),result0}function cleanupExpected(expected){expected.sort();for(var lastExpected=null,cleanExpected=[],i=0;i<expected.length;i++)expected[i]!==lastExpected&&(cleanExpected.push(expected[i]),lastExpected=expected[i]);return cleanExpected}function computeErrorPosition(){for(var line=1,column=1,seenCR=!1,i=0;i<Math.max(pos,rightmostFailuresPos);i++){var ch=input.charAt(i);"\n"===ch?(seenCR||line++,column=1,seenCR=!1):"\r"===ch||"\u2028"===ch||"\u2029"===ch?(line++,column=1,seenCR=!0):(column++,seenCR=!1)}return{line:line,column:column}}var parseFunctions={fragment:parse_fragment,range:parse_range,path:parse_path,local_path:parse_local_path,indexStep:parse_indexStep,indirectionStep:parse_indirectionStep,terminus:parse_terminus,idAssertion:parse_idAssertion,textLocationAssertion:parse_textLocationAssertion,parameter:parse_parameter,csv:parse_csv,valueNoSpace:parse_valueNoSpace,value:parse_value,escapedSpecialChars:parse_escapedSpecialChars,number:parse_number,integer:parse_integer,space:parse_space,circumflex:parse_circumflex,doubleQuote:parse_doubleQuote,squareBracket:parse_squareBracket,parentheses:parse_parentheses,comma:parse_comma,semicolon:parse_semicolon,equal:parse_equal,character:parse_character};if(void 0!==startRule){if(void 0===parseFunctions[startRule])throw new Error("Invalid rule name: "+quote(startRule)+".")}else startRule="fragment";var pos=0,reportFailures=0,rightmostFailuresPos=0,rightmostFailuresExpected=[],result=parseFunctions[startRule]();if(null===result||pos!==input.length){var offset=Math.max(pos,rightmostFailuresPos),found=offset<input.length?input.charAt(offset):null,errorPosition=computeErrorPosition();throw new this.SyntaxError(cleanupExpected(rightmostFailuresExpected),found,offset,errorPosition.line,errorPosition.column)}return result},toSource:function(){return this._source}};return result.SyntaxError=function(expected,found,offset,line,column){function buildMessage(expected,found){var expectedHumanized,foundHumanized;switch(expected.length){case 0:expectedHumanized="end of input";break;case 1:expectedHumanized=expected[0];break;default:expectedHumanized=expected.slice(0,expected.length-1).join(", ")+" or "+expected[expected.length-1]}return foundHumanized=found?quote(found):"end of input","Expected "+expectedHumanized+" but "+foundHumanized+" found."}this.name="SyntaxError",this.expected=expected,this.found=found,this.message=buildMessage(expected,found),this.offset=offset,this.line=line,this.column=column},result.SyntaxError.prototype=Error.prototype,result}(),EPUBcfi.CFIInstructions={getNextNode:function(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist){var $targetNode;return $targetNode=CFIStepValue%2==0?this.elementNodeStep(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist):this.inferTargetTextNode(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist)},followIndirectionStep:function(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist){var $contentDocument,$blacklistExcluded,$startElement,$targetNode;if(void 0===$currNode||!$currNode.is("iframe"))throw EPUBcfi.NodeTypeError($currNode,"expected an iframe element");return $currNode.is("iframe")?($contentDocument=$currNode.contents(),$blacklistExcluded=this.applyBlacklist($contentDocument.children(),classBlacklist,elementBlacklist,idBlacklist),$startElement=$($blacklistExcluded[0]),$targetNode=this.getNextNode(CFIStepValue,$startElement,classBlacklist,elementBlacklist,idBlacklist)):void 0},textTermination:function($currNode,textOffset,elementToInject){var $injectedElement;if(void 0===$currNode)throw EPUBcfi.NodeTypeError($currNode,"expected a terminating node, or node list");if(0===$currNode.length)throw EPUBcfi.TerminusError("Text","Text offset:"+textOffset,"no nodes found for termination condition");return $injectedElement=this.injectCFIMarkerIntoText($currNode,textOffset,elementToInject)},targetIdMatchesIdAssertion:function($foundNode,idAssertion){return $foundNode.attr("id")===idAssertion?!0:!1},elementNodeStep:function(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist){var $targetNode,$blacklistExcluded,numElements,jqueryTargetNodeIndex=CFIStepValue/2-1;if($blacklistExcluded=this.applyBlacklist($currNode.children(),classBlacklist,elementBlacklist,idBlacklist),numElements=$blacklistExcluded.length,this.indexOutOfRange(jqueryTargetNodeIndex,numElements))throw EPUBcfi.OutOfRangeError(jqueryTargetNodeIndex,numElements-1,"");return $targetNode=$($blacklistExcluded[jqueryTargetNodeIndex])},retrieveItemRefHref:function($itemRefElement,$packageDocument){return $("#"+$itemRefElement.attr("idref"),$packageDocument).attr("href")},indexOutOfRange:function(targetIndex,numChildElements){return targetIndex>numChildElements-1?!0:!1},injectCFIMarkerIntoText:function($textNodeList,textOffset,elementToInject){var nodeNum,nodeOffset,originalText,$injectedNode,$newTextNode,currTextPosition=0;for(nodeNum=0;nodeNum<=$textNodeList.length;nodeNum++)if(3===$textNodeList[nodeNum].nodeType){if(currNodeMaxIndex=$textNodeList[nodeNum].nodeValue.length+currTextPosition,nodeOffset=textOffset-currTextPosition,currNodeMaxIndex>textOffset)return originalText=$textNodeList[nodeNum].nodeValue,$textNodeList[nodeNum].nodeValue=originalText.slice(0,nodeOffset),$injectedNode=$(elementToInject).insertAfter($textNodeList.eq(nodeNum)),$newTextNode=$(document.createTextNode(originalText.slice(nodeOffset,originalText.length))),$($newTextNode).insertAfter($injectedNode),$injectedNode;if(currNodeMaxIndex==textOffset)return $injectedNode=$(elementToInject).insertAfter($textNodeList.eq(nodeNum));currTextPosition=currNodeMaxIndex}throw EPUBcfi.TerminusError("Text","Text offset:"+textOffset,"The offset exceeded the length of the text")},inferTargetTextNode:function(CFIStepValue,$currNode,classBlacklist,elementBlacklist,idBlacklist){var $elementsWithoutMarkers,currLogicalTextNodeIndex,targetLogicalTextNodeIndex,$targetTextNodeList,prevNodeWasTextNode;if($elementsWithoutMarkers=this.applyBlacklist($currNode.contents(),classBlacklist,elementBlacklist,idBlacklist),targetLogicalTextNodeIndex=(parseInt(CFIStepValue)+1)/2-1,currLogicalTextNodeIndex=0,prevNodeWasTextNode=!1,$targetTextNodeList=$elementsWithoutMarkers.filter(function(){return currLogicalTextNodeIndex!==targetLogicalTextNodeIndex?(this.nodeType===Node.TEXT_NODE?prevNodeWasTextNode=!0:prevNodeWasTextNode&&this.nodeType!==Node.TEXT_NODE&&this!==$elementsWithoutMarkers.lastChild&&(currLogicalTextNodeIndex++,prevNodeWasTextNode=!1),!1):this.nodeType===Node.TEXT_NODE?(prevNodeWasTextNode=!0,!0):prevNodeWasTextNode&&this.nodeType!==Node.TEXT_NODE?(currLogicalTextNodeIndex++,prevNodeWasTextNode=!1,!1):void 0}),0===$targetTextNodeList.length)throw EPUBcfi.OutOfRangeError(logicalTargetTextNodeIndex,currLogicalTextNodeIndex,"Index out of range");return $targetTextNodeList},applyBlacklist:function($elements,classBlacklist,elementBlacklist,idBlacklist){var $filteredElements;return $filteredElements=$elements.filter(function(){var $currElement=$(this),includeInList=!0;return classBlacklist&&$.each(classBlacklist,function(index,value){return $currElement.hasClass(value)?(includeInList=!1,!1):void 0}),elementBlacklist&&$.each(elementBlacklist,function(index,value){return $currElement.is(value)?(includeInList=!1,!1):void 0}),idBlacklist&&$.each(idBlacklist,function(index,value){return $currElement.attr("id")===value?(includeInList=!1,!1):void 0}),includeInList})}},EPUBcfi.Interpreter={getContentDocHref:function(CFI,packageDocument,classBlacklist,elementBlacklist,idBlacklist){var $packageDocument=$(packageDocument),decodedCFI=decodeURI(CFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI);if(!CFIAST||"CFIAST"!==CFIAST.type)throw EPUBcfi.NodeTypeError(CFIAST,"expected CFI AST root node");var $packageElement=$($("package",$packageDocument)[0]),$currElement=this.interpretIndexStepNode(CFIAST.cfiString.path,$packageElement,classBlacklist,elementBlacklist,idBlacklist);return foundHref=this.searchLocalPathForHref($currElement,$packageDocument,CFIAST.cfiString.localPath,classBlacklist,elementBlacklist,idBlacklist),foundHref?foundHref:void 0},injectElement:function(CFI,contentDocument,elementToInject,classBlacklist,elementBlacklist,idBlacklist){var indirectionNode,indirectionStepNum,$currElement,decodedCFI=decodeURI(CFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI);return indirectionStepNum=this.getFirstIndirectionStepNum(CFIAST),indirectionNode=CFIAST.cfiString.localPath.steps[indirectionStepNum],indirectionNode.type="indexStep",$currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,indirectionStepNum,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist),$currElement=this.interpretTextTerminusNode(CFIAST.cfiString.localPath.termStep,$currElement,elementToInject)},injectRangeElements:function(rangeCFI,contentDocument,startElementToInject,endElementToInject,classBlacklist,elementBlacklist,idBlacklist){var indirectionNode,indirectionStepNum,$currElement,$range1TargetElement,$range2TargetElement,decodedCFI=decodeURI(rangeCFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI);return indirectionStepNum=this.getFirstIndirectionStepNum(CFIAST),indirectionNode=CFIAST.cfiString.localPath.steps[indirectionStepNum],indirectionNode.type="indexStep",$currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,indirectionStepNum,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist),$range1TargetElement=this.interpretLocalPath(CFIAST.cfiString.range1,0,$currElement,classBlacklist,elementBlacklist,idBlacklist),$range1TargetElement=this.interpretTextTerminusNode(CFIAST.cfiString.range1.termStep,$range1TargetElement,startElementToInject),$range2TargetElement=this.interpretLocalPath(CFIAST.cfiString.range2,0,$currElement,classBlacklist,elementBlacklist,idBlacklist),$range2TargetElement=this.interpretTextTerminusNode(CFIAST.cfiString.range2.termStep,$range2TargetElement,endElementToInject),{startElement:$range1TargetElement[0],endElement:$range2TargetElement[0]}},getTargetElement:function(CFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){var indirectionNode,indirectionStepNum,$currElement,decodedCFI=decodeURI(CFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI);return indirectionStepNum=this.getFirstIndirectionStepNum(CFIAST),indirectionNode=CFIAST.cfiString.localPath.steps[indirectionStepNum],indirectionNode.type="indexStep",$currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,indirectionStepNum,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist)},getRangeTargetElements:function(rangeCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){var indirectionNode,indirectionStepNum,$currElement,$range1TargetElement,$range2TargetElement,decodedCFI=decodeURI(rangeCFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI);return indirectionStepNum=this.getFirstIndirectionStepNum(CFIAST),indirectionNode=CFIAST.cfiString.localPath.steps[indirectionStepNum],indirectionNode.type="indexStep",$currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,indirectionStepNum,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist),$range1TargetElement=this.interpretLocalPath(CFIAST.cfiString.range1,0,$currElement,classBlacklist,elementBlacklist,idBlacklist),$range2TargetElement=this.interpretLocalPath(CFIAST.cfiString.range2,0,$currElement,classBlacklist,elementBlacklist,idBlacklist),{startElement:$range1TargetElement[0],endElement:$range2TargetElement[0]}},getTargetElementWithPartialCFI:function(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){var decodedCFI=decodeURI(contentDocumentCFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI),$currElement=this.interpretIndexStepNode(CFIAST.cfiString.path,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist);return $currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,0,$currElement,classBlacklist,elementBlacklist,idBlacklist)},getTextTerminusInfoWithPartialCFI:function(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){var textOffset,decodedCFI=decodeURI(contentDocumentCFI),CFIAST=EPUBcfi.Parser.parse(decodedCFI),$currElement=this.interpretIndexStepNode(CFIAST.cfiString.path,$("html",contentDocument),classBlacklist,elementBlacklist,idBlacklist);return $currElement=this.interpretLocalPath(CFIAST.cfiString.localPath,0,$currElement,classBlacklist,elementBlacklist,idBlacklist),textOffset=parseInt(CFIAST.cfiString.localPath.termStep.offsetValue),{textNode:$currElement,textOffset:textOffset}},getFirstIndirectionStepNum:function(CFIAST){var stepNum=0;for(stepNum;stepNum<=CFIAST.cfiString.localPath.steps.length-1;stepNum++)if(nextStepNode=CFIAST.cfiString.localPath.steps[stepNum],"indirectionStep"===nextStepNode.type)return stepNum},interpretLocalPath:function(localPathNode,startStepNum,$currElement,classBlacklist,elementBlacklist,idBlacklist){var nextStepNode,stepNum=startStepNum;for(stepNum;stepNum<=localPathNode.steps.length-1;stepNum++)nextStepNode=localPathNode.steps[stepNum],"indexStep"===nextStepNode.type?$currElement=this.interpretIndexStepNode(nextStepNode,$currElement,classBlacklist,elementBlacklist,idBlacklist):"indirectionStep"===nextStepNode.type&&($currElement=this.interpretIndirectionStepNode(nextStepNode,$currElement,classBlacklist,elementBlacklist,idBlacklist));return $currElement},interpretIndexStepNode:function(indexStepNode,$currElement,classBlacklist,elementBlacklist,idBlacklist){if(void 0===indexStepNode||"indexStep"!==indexStepNode.type)throw EPUBcfi.NodeTypeError(indexStepNode,"expected index step node");var $stepTarget=EPUBcfi.CFIInstructions.getNextNode(indexStepNode.stepLength,$currElement,classBlacklist,elementBlacklist,idBlacklist);if(indexStepNode.idAssertion&&!EPUBcfi.CFIInstructions.targetIdMatchesIdAssertion($stepTarget,indexStepNode.idAssertion))throw EPUBcfi.CFIAssertionError(indexStepNode.idAssertion,$stepTarget.attr("id"),"Id assertion failed");return $stepTarget},interpretIndirectionStepNode:function(indirectionStepNode,$currElement,classBlacklist,elementBlacklist){if(void 0===indirectionStepNode||"indirectionStep"!==indirectionStepNode.type)throw EPUBcfi.NodeTypeError(indirectionStepNode,"expected indirection step node");var $stepTarget=EPUBcfi.CFIInstructions.followIndirectionStep(indirectionStepNode.stepLength,$currElement,classBlacklist,elementBlacklist);if(indirectionStepNode.idAssertion&&!EPUBcfi.CFIInstructions.targetIdMatchesIdAssertion($stepTarget,indirectionStepNode.idAssertion))throw EPUBcfi.CFIAssertionError(indirectionStepNode.idAssertion,$stepTarget.attr("id"),"Id assertion failed");return $stepTarget},interpretTextTerminusNode:function(terminusNode,$currElement,elementToInject){if(void 0===terminusNode||"textTerminus"!==terminusNode.type)throw EPUBcfi.NodeTypeError(terminusNode,"expected text terminus node");var $injectedElement=EPUBcfi.CFIInstructions.textTermination($currElement,terminusNode.offsetValue,elementToInject);return $injectedElement},searchLocalPathForHref:function($currElement,$packageDocument,localPathNode,classBlacklist,elementBlacklist,idBlacklist){var nextStepNode,stepNum=0;for(stepNum=0;stepNum<=localPathNode.steps.length-1;stepNum++)if(nextStepNode=localPathNode.steps[stepNum],"indexStep"===nextStepNode.type?$currElement=this.interpretIndexStepNode(nextStepNode,$currElement,classBlacklist,elementBlacklist,idBlacklist):"indirectionStep"===nextStepNode.type&&($currElement=this.interpretIndirectionStepNode(nextStepNode,$currElement,classBlacklist,elementBlacklist,idBlacklist)),$currElement.is("itemref"))return EPUBcfi.CFIInstructions.retrieveItemRefHref($currElement,$packageDocument);return void 0}},EPUBcfi.NodeTypeError=function(node,message){function NodeTypeError(){this.node=node}return NodeTypeError.prototype=new Error(message),NodeTypeError.constructor=NodeTypeError,new NodeTypeError},EPUBcfi.OutOfRangeError=function(targetIndex,maxIndex,message){function OutOfRangeError(){this.targetIndex=targetIndex,this.maxIndex=maxIndex}return OutOfRangeError.prototype=new Error(message),OutOfRangeError.constructor=OutOfRangeError(),new OutOfRangeError},EPUBcfi.TerminusError=function(terminusType,terminusCondition,message){function TerminusError(){this.terminusType=terminusType,this.terminusCondition=terminusCondition}return TerminusError.prototype=new Error(message),TerminusError.constructor=TerminusError(),new TerminusError},EPUBcfi.CFIAssertionError=function(expectedAssertion,targetElementAssertion,message){function CFIAssertionError(){this.expectedAssertion=expectedAssertion,this.targetElementAssertion=targetElementAssertion}return CFIAssertionError.prototype=new Error(message),CFIAssertionError.constructor=CFIAssertionError(),new CFIAssertionError},EPUBcfi.Generator={generateCharOffsetRangeComponent:function(rangeStartElement,startOffset,rangeEndElement,endOffset,classBlacklist,elementBlacklist,idBlacklist){var docRange,commonAncestor,range1OffsetStep,range1CFI,range2OffsetStep,range2CFI,commonCFIComponent;return this.validateStartTextNode(rangeStartElement),this.validateStartTextNode(rangeEndElement),$(rangeStartElement).parent()[0]===$(rangeEndElement).parent()[0]?(range1OffsetStep=this.createCFITextNodeStep($(rangeStartElement),startOffset,classBlacklist,elementBlacklist,idBlacklist),range2OffsetStep=this.createCFITextNodeStep($(rangeEndElement),endOffset,classBlacklist,elementBlacklist,idBlacklist),commonCFIComponent=this.createCFIElementSteps($(rangeStartElement).parent(),"html",classBlacklist,elementBlacklist,idBlacklist),commonCFIComponent.substring(1,commonCFIComponent.length)+","+range1OffsetStep+","+range2OffsetStep):(docRange=document.createRange(),docRange.setStart(rangeStartElement,startOffset),docRange.setEnd(rangeEndElement,endOffset),commonAncestor=docRange.commonAncestorContainer,range1OffsetStep=this.createCFITextNodeStep($(rangeStartElement),startOffset,classBlacklist,elementBlacklist,idBlacklist),range1CFI=this.createCFIElementSteps($(rangeStartElement).parent(),commonAncestor,classBlacklist,elementBlacklist,idBlacklist)+range1OffsetStep,range2OffsetStep=this.createCFITextNodeStep($(rangeEndElement),endOffset,classBlacklist,elementBlacklist,idBlacklist),range2CFI=this.createCFIElementSteps($(rangeEndElement).parent(),commonAncestor,classBlacklist,elementBlacklist,idBlacklist)+range2OffsetStep,commonCFIComponent=this.createCFIElementSteps($(commonAncestor),"html",classBlacklist,elementBlacklist,idBlacklist),commonCFIComponent.substring(1,commonCFIComponent.length)+","+range1CFI+","+range2CFI)},generateElementRangeComponent:function(rangeStartElement,rangeEndElement,classBlacklist,elementBlacklist,idBlacklist){var docRange,commonAncestor,range1CFI,range2CFI,commonCFIComponent;if(this.validateStartElement(rangeStartElement),this.validateStartElement(rangeEndElement),rangeStartElement===rangeEndElement)throw new Error("Start and end element cannot be the same for a CFI range");return docRange=document.createRange(),docRange.setStart(rangeStartElement),docRange.setEnd(rangeEndElement),commonAncestor=docRange.commonAncestorContainer,range1CFI=this.createCFIElementSteps($(rangeStartElement),commonAncestor,classBlacklist,elementBlacklist,idBlacklist),range2CFI=this.createCFIElementSteps($(rangeEndElement),commonAncestor,classBlacklist,elementBlacklist,idBlacklist),commonCFIComponent=this.createCFIElementSteps($(commonAncestor),"html",classBlacklist,elementBlacklist,idBlacklist),commonCFIComponent.substring(1,commonCFIComponent.length)+","+range1CFI+","+range2CFI},generateCharacterOffsetCFIComponent:function(startTextNode,characterOffset,classBlacklist,elementBlacklist,idBlacklist){var textNodeStep,contentDocCFI;return this.validateStartTextNode(startTextNode,characterOffset),textNodeStep=this.createCFITextNodeStep($(startTextNode),characterOffset,classBlacklist,elementBlacklist,idBlacklist),contentDocCFI=this.createCFIElementSteps($(startTextNode).parent(),"html",classBlacklist,elementBlacklist,idBlacklist)+textNodeStep,contentDocCFI.substring(1,contentDocCFI.length)},generateElementCFIComponent:function(startElement,classBlacklist,elementBlacklist,idBlacklist){var contentDocCFI;return this.validateStartElement(startElement),contentDocCFI=this.createCFIElementSteps($(startElement),"html",classBlacklist,elementBlacklist,idBlacklist),contentDocCFI.substring(1,contentDocCFI.length)},generatePackageDocumentCFIComponent:function(contentDocumentName,packageDocument,classBlacklist,elementBlacklist,idBlacklist){return this.validateContentDocumentName(contentDocumentName),this.validatePackageDocument(packageDocument,contentDocumentName),$itemRefStartNode=$("itemref[idref='"+contentDocumentName+"']",$(packageDocument)),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",classBlacklist,elementBlacklist,idBlacklist),packageDocCFIComponent+"!"},generatePackageDocumentCFIComponentWithSpineIndex:function(spineIndex,packageDocument,classBlacklist,elementBlacklist,idBlacklist){return $itemRefStartNode=$($("spine",packageDocument).children()[spineIndex]),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",classBlacklist,elementBlacklist,idBlacklist),packageDocCFIComponent+"!"},generateCompleteCFI:function(packageDocumentCFIComponent,contentDocumentCFIComponent){return"epubcfi("+packageDocumentCFIComponent+contentDocumentCFIComponent+")"},validateStartTextNode:function(startTextNode,characterOffset){if(!startTextNode)throw new EPUBcfi.NodeTypeError(startTextNode,"Cannot generate a character offset from a starting point that is not a text node");if(3!=startTextNode.nodeType)throw new EPUBcfi.NodeTypeError(startTextNode,"Cannot generate a character offset from a starting point that is not a text node");if(0>characterOffset)throw new EPUBcfi.OutOfRangeError(characterOffset,0,"Character offset cannot be less than 0");if(characterOffset>startTextNode.nodeValue.length)throw new EPUBcfi.OutOfRangeError(characterOffset,startTextNode.nodeValue.length-1,"character offset cannot be greater than the length of the text node")},validateStartElement:function(startElement){if(!startElement)throw new EPUBcfi.NodeTypeError(startElement,"CFI target element is undefined");if(!startElement.nodeType||1!==startElement.nodeType)throw new EPUBcfi.NodeTypeError(startElement,"CFI target element is not an HTML element")},validateContentDocumentName:function(contentDocumentName){if(!contentDocumentName)throw new Error("The idref for the content document, as found in the spine, must be supplied")},validatePackageDocument:function(packageDocument,contentDocumentName){if(!packageDocument)throw new Error("A package document must be supplied to generate a CFI");if(0===$($("itemref[idref='"+contentDocumentName+"']",packageDocument)[0]).length)throw new Error("The idref of the content document could not be found in the spine")},createCFITextNodeStep:function($startTextNode,characterOffset,classBlacklist,elementBlacklist,idBlacklist){var $parentNode,$contentsExcludingMarkers,CFIIndex,indexOfTextNode;$parentNode=$startTextNode.parent(),$contentsExcludingMarkers=EPUBcfi.CFIInstructions.applyBlacklist($parentNode.contents(),classBlacklist,elementBlacklist,idBlacklist);var prevNodeWasTextNode,indexOfFirstInSequence,textNodeOnlyIndex=0,characterOffsetSinceUnsplit=0,finalCharacterOffsetInSequence=0;return $.each($contentsExcludingMarkers,function(){if(this.nodeType===Node.TEXT_NODE){if(this===$startTextNode[0])return prevNodeWasTextNode?(indexOfTextNode=indexOfFirstInSequence,finalCharacterOffsetInSequence=characterOffsetSinceUnsplit):indexOfTextNode=textNodeOnlyIndex,!1;prevNodeWasTextNode=!0,characterOffsetSinceUnsplit+=this.length,void 0===indexOfFirstInSequence&&(indexOfFirstInSequence=textNodeOnlyIndex,textNodeOnlyIndex+=1)}else prevNodeWasTextNode=!1,indexOfFirstInSequence=void 0,characterOffsetSinceUnsplit=0}),CFIIndex=2*indexOfTextNode+1,"/"+CFIIndex+":"+(finalCharacterOffsetInSequence+characterOffset)},createCFIElementSteps:function($currNode,topLevelElement,classBlacklist,elementBlacklist,idBlacklist){var $blacklistExcluded,$parentNode,currNodePosition,CFIPosition,elementStep;return $blacklistExcluded=EPUBcfi.CFIInstructions.applyBlacklist($currNode.parent().children(),classBlacklist,elementBlacklist,idBlacklist),$.each($blacklistExcluded,function(index){return this===$currNode[0]?(currNodePosition=index,!1):void 0}),CFIPosition=2*(currNodePosition+1),elementStep=$currNode.attr("id")?"/"+CFIPosition+"["+$currNode.attr("id")+"]":"/"+CFIPosition,$parentNode=$currNode.parent(),$parentNode.is(topLevelElement)||$currNode.is(topLevelElement)?"html"===topLevelElement?"!"+elementStep:elementStep:this.createCFIElementSteps($parentNode,topLevelElement,classBlacklist,elementBlacklist,idBlacklist)+elementStep}};var interpreter=EPUBcfi.Interpreter,generator=EPUBcfi.Generator,instructions=EPUBcfi.CFIInstructions;if(global.EPUBcfi)throw new Error("The EPUB cfi library has already been defined");global.EPUBcfi=EPUBcfi;var CFIInstructions=EPUBcfi.CFIInstructions,Parser=EPUBcfi.Parser,OError=EPUBcfi.OutOfRangeError,Interp=EPUBcfi.Interpreter,NodeTypeError=EPUBcfi.NodeTypeError,OutOfRangeError=EPUBcfi.OutOfRangeError,TerminusError=EPUBcfi.TerminusError,CFIAssertionError=EPUBcfi.CFIAssertionError;global.EPUBcfi=EPUBcfi={getContentDocHref:function(CFI,packageDocument){return interpreter.getContentDocHref(CFI,packageDocument)},injectElement:function(CFI,contentDocument,elementToInject,classBlacklist,elementBlacklist,idBlacklist){return interpreter.injectElement(CFI,contentDocument,elementToInject,classBlacklist,elementBlacklist,idBlacklist)},getTargetElement:function(CFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){return interpreter.getTargetElement(CFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist)},getTargetElementWithPartialCFI:function(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){return interpreter.getTargetElementWithPartialCFI(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist)},getTextTerminusInfoWithPartialCFI:function(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){return interpreter.getTextTerminusInfoWithPartialCFI(contentDocumentCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist)
},generateCharacterOffsetCFIComponent:function(startTextNode,characterOffset,classBlacklist,elementBlacklist,idBlacklist){return generator.generateCharacterOffsetCFIComponent(startTextNode,characterOffset,classBlacklist,elementBlacklist,idBlacklist)},generateElementCFIComponent:function(startElement,classBlacklist,elementBlacklist,idBlacklist){return generator.generateElementCFIComponent(startElement,classBlacklist,elementBlacklist,idBlacklist)},generatePackageDocumentCFIComponent:function(contentDocumentName,packageDocument,classBlacklist,elementBlacklist,idBlacklist){return generator.generatePackageDocumentCFIComponent(contentDocumentName,packageDocument,classBlacklist,elementBlacklist,idBlacklist)},generatePackageDocumentCFIComponentWithSpineIndex:function(spineIndex,packageDocument,classBlacklist,elementBlacklist,idBlacklist){return generator.generatePackageDocumentCFIComponentWithSpineIndex(spineIndex,packageDocument,classBlacklist,elementBlacklist,idBlacklist)},generateCompleteCFI:function(packageDocumentCFIComponent,contentDocumentCFIComponent){return generator.generateCompleteCFI(packageDocumentCFIComponent,contentDocumentCFIComponent)},injectElementAtOffset:function($textNodeList,textOffset,elementToInject){return instructions.injectCFIMarkerIntoText($textNodeList,textOffset,elementToInject)},injectRangeElements:function(rangeCFI,contentDocument,startElementToInject,endElementToInject,classBlacklist,elementBlacklist,idBlacklist){return interpreter.injectRangeElements(rangeCFI,contentDocument,startElementToInject,endElementToInject,classBlacklist,elementBlacklist,idBlacklist)},getRangeTargetElements:function(rangeCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist){return interpreter.getRangeTargetElements(rangeCFI,contentDocument,classBlacklist,elementBlacklist,idBlacklist)},generateCharOffsetRangeComponent:function(rangeStartElement,startOffset,rangeEndElement,endOffset,classBlacklist,elementBlacklist,idBlacklist){return generator.generateCharOffsetRangeComponent(rangeStartElement,startOffset,rangeEndElement,endOffset,classBlacklist,elementBlacklist,idBlacklist)},generateElementRangeComponent:function(rangeStartElement,rangeEndElement,classBlacklist,elementBlacklist,idBlacklist){return generator.generateElementRangeComponent(rangeStartElement,rangeEndElement,classBlacklist,elementBlacklist,idBlacklist)}},EPUBcfi.CFIInstructions=CFIInstructions,EPUBcfi.Parser=Parser,EPUBcfi.OutOfRangeError=OError,EPUBcfi.Interpreter=Interp,EPUBcfi.Generator=generator,EPUBcfi.NodeTypeError=NodeTypeError,EPUBcfi.OutOfRangeError=OutOfRangeError,EPUBcfi.TerminusError=TerminusError,EPUBcfi.CFIAssertionError=CFIAssertionError}("undefined"==typeof window?this:window),define("epubCfi",function(){}),ReadiumSDK.Views.CfiNavigationLogic=function($viewport,$iframe,options){function isPageProgressionRightToLeft(){return options.paginationInfo&&!!options.paginationInfo.rightToLeft}function isVerticalWritingMode(){return options.paginationInfo&&!!options.paginationInfo.isVerticalWritingMode}function isRectVisible(rect,frameDimensions,isVwm){return isVwm?rect.top>=0&&rect.top<frameDimensions.height:rect.left>=0&&rect.left<frameDimensions.width}function getColumnFullWidth(){return!options.paginationInfo||isVerticalWritingMode()?$iframe.width():options.paginationInfo.columnWidth+options.paginationInfo.columnGap}function getVisibleContentOffsets(){return isVerticalWritingMode()?{top:options.paginationInfo?options.paginationInfo.pageOffset:0}:{left:(options.paginationInfo?options.paginationInfo.pageOffset:0)*(isPageProgressionRightToLeft()?-1:1)}}function checkVisibilityByVerticalOffsets($element,visibleContentOffsets,shouldCalculateVisibilityOffset){var elementRect=ReadiumSDK.Helpers.Rect.fromElement($element);_.isNaN(elementRect.left)&&(elementRect=new ReadiumSDK.Helpers.Rect($element.position().top,$element.position().left,0,0));var topOffset=visibleContentOffsets.top||0,isBelowVisibleTop=elementRect.bottom()>topOffset,isAboveVisibleBottom=void 0!==visibleContentOffsets.bottom?elementRect.top<visibleContentOffsets.bottom:!0,percentOfElementHeight=0;return isBelowVisibleTop&&isAboveVisibleBottom?shouldCalculateVisibilityOffset?(elementRect.top<=topOffset&&(percentOfElementHeight=Math.ceil(100*(topOffset-elementRect.top)/elementRect.height)),100-percentOfElementHeight):100:0}function checkVisibilityByRectangles($element,_props,shouldCalculateVisibilityPercentage){var elementRectangles=getNormalizedRectangles($element),clientRectangles=elementRectangles.clientRectangles;if(0===clientRectangles.length)return null;var isRtl=isPageProgressionRightToLeft(),isVwm=isVerticalWritingMode(),columnFullWidth=getColumnFullWidth(),frameDimensions={width:$iframe.width(),height:$iframe.height()};1===clientRectangles.length&&adjustRectangle(clientRectangles[0],frameDimensions,columnFullWidth,isRtl,isVwm,!0);for(var visibilityPercentage=0,i=0,l=clientRectangles.length;l>i;++i)if(isRectVisible(clientRectangles[i],frameDimensions,isVwm)){visibilityPercentage=shouldCalculateVisibilityPercentage?measureVisibilityPercentageByRectangles(clientRectangles,i):100;break}return visibilityPercentage}function findPageByRectangles($element,spatialVerticalOffset){var visibleContentOffsets=getVisibleContentOffsets(),elementRectangles=getNormalizedRectangles($element,visibleContentOffsets),clientRectangles=elementRectangles.clientRectangles;if(0===clientRectangles.length)return null;var isRtl=isPageProgressionRightToLeft(),isVwm=isVerticalWritingMode(),columnFullWidth=getColumnFullWidth(),frameHeight=$iframe.height(),frameWidth=$iframe.width();spatialVerticalOffset&&trimRectanglesByVertOffset(clientRectangles,spatialVerticalOffset,frameHeight,columnFullWidth,isRtl,isVwm);var firstRectangle=_.first(clientRectangles);1===clientRectangles.length&&adjustRectangle(firstRectangle,{height:frameHeight,width:frameWidth},columnFullWidth,isRtl,isVwm);var pageIndex;if(isVwm){var topOffset=firstRectangle.top;pageIndex=Math.floor(topOffset/frameHeight)}else{var leftOffset=firstRectangle.left;isRtl&&(leftOffset=columnFullWidth*(options.paginationInfo?options.paginationInfo.visibleColumnCount:1)-leftOffset),pageIndex=Math.floor(leftOffset/columnFullWidth)}return 0>pageIndex?pageIndex=0:pageIndex>=(options.paginationInfo?options.paginationInfo.columnCount:1)&&(pageIndex=options.paginationInfo?options.paginationInfo.columnCount-1:0),pageIndex}function measureVisibilityPercentageByRectangles(clientRectangles,firstVisibleRectIndex){var heightTotal=0,heightVisible=0;return clientRectangles.length>1?_.each(clientRectangles,function(rect,index){heightTotal+=rect.height,index>=firstVisibleRectIndex&&(heightVisible+=rect.height)}):(heightTotal=clientRectangles[0].height,heightVisible=clientRectangles[0].height-Math.max(0,-clientRectangles[0].top)),heightVisible===heightTotal?100:Math.floor(100*heightVisible/heightTotal)}function getNormalizedRectangles($el,visibleContentOffsets){visibleContentOffsets=visibleContentOffsets||{};for(var leftOffset=visibleContentOffsets.left||0,topOffset=visibleContentOffsets.top||0,wrapperRectangle=normalizeRectangle($el[0].getBoundingClientRect(),leftOffset,topOffset),clientRectangles=[],clientRectList=$el[0].getClientRects(),i=0,l=clientRectList.length;l>i;++i)clientRectList[i].height>0&&clientRectangles.push(normalizeRectangle(clientRectList[i],leftOffset,topOffset));return 0===clientRectangles.length&&($el=$el.next(),$el.length)?getNormalizedRectangles($el,visibleContentOffsets):{wrapperRectangle:wrapperRectangle,clientRectangles:clientRectangles}}function normalizeRectangle(textRect,leftOffset,topOffset){var plainRectObject={left:textRect.left,right:textRect.right,top:textRect.top,bottom:textRect.bottom,width:textRect.right-textRect.left,height:textRect.bottom-textRect.top};return offsetRectangle(plainRectObject,leftOffset,topOffset),plainRectObject}function offsetRectangle(rect,leftOffset,topOffset){rect.left+=leftOffset,rect.right+=leftOffset,rect.top+=topOffset,rect.bottom+=topOffset}function adjustRectangle(rect,frameDimensions,columnFullWidth,isRtl,isVwm,shouldLookForFirstVisibleColumn){if(!isVwm){for(isRtl&&(columnFullWidth*=-1);rect.top<0;)offsetRectangle(rect,-columnFullWidth,frameDimensions.height);if(shouldLookForFirstVisibleColumn)for(;rect.bottom>=frameDimensions.height&&!isRectVisible(rect,frameDimensions,isVwm);)offsetRectangle(rect,columnFullWidth,-frameDimensions.height)}}function trimRectanglesByVertOffset(rects,verticalOffset,frameHeight,columnFullWidth,isRtl,isVwm){if(!isVwm){var totalHeight=_.reduce(rects,function(prev,cur){return prev+cur.height},0),heightToHide=totalHeight*verticalOffset/100;if(rects.length>1){var heightAccum=0;do{if(heightAccum+=rects[0].height,heightAccum>heightToHide)break;rects.shift()}while(rects.length>1)}else{for(isRtl&&(columnFullWidth*=-1);rects[0].bottom>=frameHeight;)offsetRectangle(rects[0],columnFullWidth,-frameHeight);rects[0].top+=heightToHide,rects[0].height-=heightToHide}}}function getElementByPartialCfi(cfi,classBlacklist,elementBlacklist,idBlacklist){var contentDoc=$iframe[0].contentDocument,wrappedCfi="epubcfi("+cfi+")",$element=EPUBcfi.getTargetElementWithPartialCFI(wrappedCfi,contentDoc,classBlacklist,elementBlacklist,idBlacklist);return $element&&0!=$element.length?$element:void console.log("Can't find element for CFI: "+cfi)}function splitCfi(cfi){var ret={cfi:"",x:0,y:0},ix=cfi.indexOf("@");if(-1!=ix){var terminus=cfi.substring(ix+1),colIx=terminus.indexOf(":");-1!=colIx?(ret.x=parseInt(terminus.substr(0,colIx)),ret.y=parseInt(terminus.substr(colIx+1))):console.log("Unexpected terminating step format"),ret.cfi=cfi.substring(0,ix)}else ret.cfi=cfi;return ret}function isValidTextNode(node){if(node.nodeType===Node.TEXT_NODE){var nodeText=node.nodeValue.replace(/\n/g,"");return nodeText=nodeText.replace(/ /g,""),nodeText.length>0}return!1}options=options||{},this.getRootElement=function(){return $iframe[0].contentDocument.documentElement};var visibilityCheckerFunc=options.rectangleBased?checkVisibilityByRectangles:checkVisibilityByVerticalOffsets;this.findFirstVisibleElement=function(props){"object"!=typeof props&&(props={top:props});var $elements,$firstVisibleTextNode=null,percentOfElementHeight=0;return $elements=$("body",this.getRootElement()).find(":not(iframe)").contents().filter(function(){return isValidTextNode(this)||"img"===this.nodeName.toLowerCase()}),$.each($elements,function(){var $element;$element=this.nodeType===Node.TEXT_NODE?$(this).parent():$(this);var visibilityResult=visibilityCheckerFunc($element,props,!0);return visibilityResult?($firstVisibleTextNode=$element,percentOfElementHeight=100-visibilityResult,!1):!0}),{$element:$firstVisibleTextNode,percentY:percentOfElementHeight}},this.getFirstVisibleElementCfi=function(topOffset){var foundElement=this.findFirstVisibleElement(topOffset);if(!foundElement.$element)return void console.log("Could not generate CFI no visible element on page");var cfi=EPUBcfi.Generator.generateElementCFIComponent(foundElement.$element[0]);return"!"==cfi[0]&&(cfi=cfi.substring(1)),cfi+"@0:"+foundElement.percentY},this.getPageForElementCfi=function(cfi,classBlacklist,elementBlacklist,idBlacklist){var cfiParts=splitCfi(cfi),$element=getElementByPartialCfi(cfiParts.cfi,classBlacklist,elementBlacklist,idBlacklist);return $element?this.getPageForPointOnElement($element,cfiParts.x,cfiParts.y):-1},this.getElementByCfi=function(cfi,classBlacklist,elementBlacklist,idBlacklist){var cfiParts=splitCfi(cfi);return getElementByPartialCfi(cfiParts.cfi,classBlacklist,elementBlacklist,idBlacklist)},this.getPageForElement=function($element){return this.getPageForPointOnElement($element,0,0)},this.getPageForPointOnElement=function($element,x,y){var pageIndex;if(options.rectangleBased)return pageIndex=findPageByRectangles($element,y),null===pageIndex?(console.warn("Impossible to locate a hidden element: ",$element),0):pageIndex;var posInElement=this.getVerticalOffsetForPointOnElement($element,x,y);return Math.floor(posInElement/$viewport.height())},this.getVerticalOffsetForElement=function($element){return this.getVerticalOffsetForPointOnElement($element,0,0)},this.getVerticalOffsetForPointOnElement=function($element,x,y){var elementRect=ReadiumSDK.Helpers.Rect.fromElement($element);return Math.ceil(elementRect.top+y*elementRect.height/100)},this.getElementById=function(id){var contentDoc=$iframe[0].contentDocument,$element=$(contentDoc.getElementById(id));return 0==$element.length?void 0:$element},this.getPageForElementId=function(id){var $element=this.getElementById(id);return $element?this.getPageForElement($element):-1},this.getFirstVisibleMediaOverlayElement=function(visibleContentOffsets){function traverseArray(arr){if(!arr||!arr.length)return void 0;for(var i=0,count=arr.length;count>i;i++){var item=arr[i];if(item){var $item=$(item);if($item.data("mediaOverlayData")){var visible=that.getElementVisibility($item,visibleContentOffsets);if(visible&&(firstPartial||(firstPartial=item),100==visible))return item}else{var elem=traverseArray(item.children);if(elem)return elem}}}return void 0}var docElement=this.getRootElement();if(!docElement)return void 0;var $root=$("body",docElement);if(!$root||!$root.length||!$root[0])return void 0;var that=this,firstPartial=void 0,el=traverseArray([$root[0]]);return el||(el=firstPartial),el},this.getElementVisibility=function($element,visibleContentOffsets){return visibilityCheckerFunc($element,visibleContentOffsets,!0)},this.isElementVisible=visibilityCheckerFunc,this.getAllVisibleElementsWithSelector=function(selector,visibleContentOffset){var elements=$(selector,this.getRootElement()).filter(function(){return!0}),$newElements=[];$.each(elements,function(){$newElements.push($(this))});var visibleDivs=this.getVisibleElements($newElements,visibleContentOffset);return visibleDivs},this.getVisibleElements=function($elements,visibleContentOffsets){var visibleElements=[];return $.each($elements,function(){var $element=this,visibilityPercentage=visibilityCheckerFunc($element,visibleContentOffsets,!0);if(visibilityPercentage){var $visibleElement=$element;return visibleElements.push({element:$visibleElement[0],percentVisible:visibilityPercentage}),!0}return null===visibilityPercentage?!0:0===visibleElements.length}),visibleElements},this.getVisibleTextElements=function(visibleContentOffsets){var $elements=this.getTextElements($("body",this.getRootElement()));return this.getVisibleElements($elements,visibleContentOffsets)},this.getMediaOverlayElements=function($root){function traverseCollection(elements){if(void 0!=elements)for(var i=0,count=elements.length;count>i;i++){var $element=$(elements[i]);$element.data("mediaOverlayData")?$elements.push($element):traverseCollection($element[0].children)}}var $elements=[];return traverseCollection([$root[0]]),$elements},this.getTextElements=function($root){var $textElements=[];return $root.find(":not(iframe)").contents().each(function(){isValidTextNode(this)&&$textElements.push($(this).parent())}),$textElements},this.getElement=function(selector){var $element=$(selector,this.getRootElement());return $element.length>0?$element:void 0}},define("cfiNavigationLogic",["readiumSDK","epubCfi"],function(global){return function(){var ret;return ret||global.cfiNavigationLogic}}(this)),ReadiumSDK.Views.OnePageView=function(options,classes,enableBookStyleOverrides){function onIFrameLoad(success){if(success){_isIframeLoaded=!0;var epubContentDocument=_$iframe[0].contentDocument;_$epubHtml=$("html",epubContentDocument),_$epubHtml&&0!=_$epubHtml.length||(_$epubHtml=$("svg",epubContentDocument)),_enableBookStyleOverrides&&self.applyBookStyles(),updateMetaSize(),_pageTransitionHandler.onIFrameLoad()}}function updateHtmlFontSize(){_enableBookStyleOverrides&&_$epubHtml&&_viewSettings&&_$epubHtml.css("font-size",_viewSettings.fontSize+"%")}function getContentDocHeight(){if(!_$iframe||!_$iframe.length)return 0;if(ReadiumSDK.Helpers.isIframeAlive(_$iframe[0])){var win=_$iframe[0].contentWindow,doc=_$iframe[0].contentDocument,height=Math.round(parseFloat(win.getComputedStyle(doc.documentElement).height));return height}if(_$epubHtml){console.error("getContentDocHeight ??");var jqueryHeight=_$epubHtml.height();return jqueryHeight}return 0}function updateMetaSize(){_meta_size.width=0,_meta_size.height=0;var size=void 0,contentDocument=_$iframe[0].contentDocument,content=$("meta[name=viewport]",contentDocument).attr("content");if(content||(content=$("meta[name=viewbox]",contentDocument).attr("content")),content&&(size=parseMetaSize(content)),!size){var $svg=$(contentDocument).find("svg");if($svg.length>0){var width=void 0,height=void 0,wAttr=$svg[0].getAttribute("width");if(wAttr)try{width=parseInt(wAttr,10)}catch(err){}var hAttr=$svg[0].getAttribute("height");if(hAttr)try{height=parseInt(hAttr,10)}catch(err){}width&&height&&(size={width:width,height:height})}}if(!size&&_currentSpineItem&&(content=_currentSpineItem.getRenditionViewport(),content&&(size=parseMetaSize(content),size&&console.log("Viewport: using rendition:viewport dimensions"))),!size){var $img=$(contentDocument).find("img");if($img.length>0){size={width:$img.width(),height:$img.height()};var isImage=_currentSpineItem&&_currentSpineItem.media_type&&_currentSpineItem.media_type.length&&0==_currentSpineItem.media_type.indexOf("image/");isImage||console.warn("Viewport: using img dimensions!")}else if($img=$(contentDocument).find("image"),$img.length>0){var width=void 0,height=void 0,wAttr=$img[0].getAttribute("width");if(wAttr)try{width=parseInt(wAttr,10)}catch(err){}var hAttr=$img[0].getAttribute("height");if(hAttr)try{height=parseInt(hAttr,10)}catch(err){}width&&height&&(size={width:width,height:height},console.warn("Viewport: using image dimensions!"))}}size||(width=_$viewport.width(),height=_$viewport.height(),size={width:width,height:height},console.warn("Viewport: using browser / e-reader viewport dimensions!")),size&&(_meta_size.width=size.width,_meta_size.height=size.height)}function parseMetaSize(content){for(var pairs=content.replace(/\s/g,"").split(","),dict={},i=0;i<pairs.length;i++){var nameVal=pairs[i].split("=");2==nameVal.length&&(dict[nameVal[0]]=nameVal[1])}var width=Number.NaN,height=Number.NaN;return dict.width&&(width=parseInt(dict.width)),dict.height&&(height=parseInt(dict.height)),isNaN(width)||isNaN(height)?void 0:{width:width,height:height}}_.extend(this,Backbone.Events);var _$epubHtml,_$el,_$iframe,_currentSpineItem,_$scaler,self=this,_spine=options.spine,_iframeLoader=options.iframeLoader,_bookStyles=options.bookStyles,_$viewport=options.$viewport,_isIframeLoaded=!1,PageTransitionHandler=function(opts){var PageTransition=function(begin,end){this.begin=begin,this.end=end},_pageTransition_OPACITY=new PageTransition(function(scale,left,top,$el){$el.css("opacity","0")},function(scale,left,top,$el){var css={};_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transition"]="opacity 150ms ease-out"}),$el.css(css),$el.css("opacity","1")}),_pageTransition_TRANSLATE=new PageTransition(function(scale,left,top,$el,meta_width,meta_height,pageSwitchDir){$el.css("opacity","0");var elWidth=Math.ceil(meta_width*scale),initialLeft=.8*elWidth*(2===pageSwitchDir?1:-1),move=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(initialLeft),origin:"50% 50%"});$el.css(move)},function(scale,left,top,$el){var css={};_.each(["","-webkit-","-moz-","-ms-"],function(prefix){css[prefix+"transition"]=prefix+"transform 150ms ease-out"}),$el.css(css),$el.css("opacity","1"),css={},_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transform"]="none"}),$el.css(css)}),_pageTransition_ROTATE=new PageTransition(function(scale,left,top,$el,meta_width,meta_height,pageSwitchDir){$el.css("opacity","0");var elWidth=Math.ceil(meta_width*scale),initialLeft=1.7*elWidth*(2===pageSwitchDir?1:-1),trans=ReadiumSDK.Helpers.CSSTransformString({left:Math.round(initialLeft),angle:30*(2===pageSwitchDir?-1:1),origin:"50% 50%"});$el.css(trans)},function(scale,left,top,$el){var css={};_.each(["","-webkit-","-moz-","-ms-"],function(prefix){css[prefix+"transition"]=prefix+"transform 300ms ease-in-out"}),$el.css(css),$el.css("opacity","1"),css={},_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transform"]="none"}),$el.css(css)}),_pageTransition_SWING=new PageTransition(function(scale,left,top,$el,meta_width,meta_height,pageSwitchDir){$el.css("opacity","0");for(var isLeft=!1,isCenter=!1,isRight=!1,i=0;i<classes.length;i++){var c=classes[i].toLowerCase();if(c.indexOf("left")>=0){isLeft=!0;break}if(c.indexOf("right")>=0){isRight=!0;break}if(c.indexOf("center")>=0){isCenter=!0;break}}var elWidth=Math.ceil(meta_width*scale),initialLeft=.5*elWidth*(isLeft||isCenter&&1===pageSwitchDir?1:-1),trans=ReadiumSDK.Helpers.CSSTransformString({scale:.2,left:Math.round(initialLeft),angle:30*(isLeft||isCenter&&1===pageSwitchDir?1:-1),origin:"50% 50%"});$el.css(trans)},function(scale,left,top,$el){var css={};_.each(["","-webkit-","-moz-","-ms-"],function(prefix){css[prefix+"transition"]=prefix+"transform 400ms ease-out"}),$el.css(css),$el.css("opacity","1"),css={},_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transform"]="none"}),$el.css(css)}),_pageTransitions=[];_pageTransitions.push(_pageTransition_OPACITY),_pageTransitions.push(_pageTransition_TRANSLATE),_pageTransitions.push(_pageTransition_ROTATE),_pageTransitions.push(_pageTransition_SWING);var _disablePageTransitions=opts.disablePageTransitions||!1,_pageTransition=-1;this.updateOptions=function(o){null!==o.pageTransition&&"undefined"!=typeof o.pageTransition&&(_pageTransition=o.pageTransition)},this.updateOptions(opts);var _pageSwitchDir=0,_pageSwitchActuallyChanged=!1,_pageSwitchActuallyChanged_IFRAME_LOAD=!1;this.updatePageSwitchDir=function(dir,hasChanged){_pageSwitchActuallyChanged_IFRAME_LOAD||(_pageSwitchDir=dir,_pageSwitchActuallyChanged=hasChanged)},this.onIFrameLoad=function(){_pageSwitchActuallyChanged_IFRAME_LOAD=!0},this.transformContentImmediate_BEGIN=function($el,scale,left,top){var pageSwitchActuallyChanged=_pageSwitchActuallyChanged||_pageSwitchActuallyChanged_IFRAME_LOAD;if(_pageSwitchActuallyChanged_IFRAME_LOAD=!1,!_disablePageTransitions&&-1!==_pageTransition){var css={};if(_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transition"]="all 0 ease 0"}),$el.css(css),pageSwitchActuallyChanged){var pageTransition=_pageTransition>=0&&_pageTransition<_pageTransitions.length?_pageTransitions[_pageTransition]:void 0;0!==_pageSwitchDir&&pageTransition?pageTransition.begin(scale,left,top,$el,self.meta_width(),self.meta_height(),_pageSwitchDir):$el.css("opacity","0")}}},this.transformContentImmediate_END=function($el,scale,left,top){_disablePageTransitions||-1===_pageTransition||setTimeout(function(){var pageTransition=_pageTransition>=0&&_pageTransition<_pageTransitions.length?_pageTransitions[_pageTransition]:void 0;if(0!==_pageSwitchDir&&pageTransition)pageTransition.end(scale,left,top,$el,self.meta_width(),self.meta_height(),_pageSwitchDir);else{var css={};_.each(["-webkit-","-moz-","-ms-",""],function(prefix){css[prefix+"transition"]="opacity 250ms linear"}),$el.css(css),$el.css("opacity","1")}},10)}},_pageTransitionHandler=new PageTransitionHandler(options),_enableBookStyleOverrides=enableBookStyleOverrides||!1,_meta_size={width:0,height:0};this.element=function(){return _$el},this.meta_height=function(){return _meta_size.height},this.meta_width=function(){return _meta_size.width},this.isDisplaying=function(){return _isIframeLoaded},this.render=function(){var template=ReadiumSDK.Helpers.loadTemplate("single_page_frame",{});_$el=$(template),_$scaler=$("#scaler",_$el),_.each(["-webkit-","-moz-","-ms-",""],function(prefix){_$el.css(prefix+"transition","all 0 ease 0")}),_$el.css("height","100%"),_$el.css("width","100%");var settings=_viewSettings;settings||(settings=new ReadiumSDK.Models.ViewerSettings({})),settings.enableGPUHardwareAccelerationCSS3D&&_$el.css("transform","translateZ(0)");for(var i=0,count=classes.length;count>i;i++)_$el.addClass(classes[i]);return _$iframe=$("iframe",_$el),this},this.decorateIframe=function(){_$iframe&&_$iframe.length&&(_$iframe.css("border-bottom","1px dashed silver"),_$iframe.css("border-top","1px dashed silver"))},this.remove=function(){_isIframeLoaded=!1,_currentSpineItem=void 0,_$el.remove()},this.clear=function(){_isIframeLoaded=!1,_$iframe[0].src=""},this.currentSpineItem=function(){return _currentSpineItem};var _viewSettings=void 0;this.setViewSettings=function(settings){_viewSettings=settings,_enableBookStyleOverrides&&self.applyBookStyles(),updateMetaSize(),_pageTransitionHandler.updateOptions(settings)},this.applyBookStyles=function(){_enableBookStyleOverrides&&_$epubHtml&&(ReadiumSDK.Helpers.setStyles(_bookStyles.getStyles(),_$epubHtml),updateHtmlFontSize())},this.scaleToWidth=function(width){if(!(_meta_size.width<=0)){var scale=width/_meta_size.width;self.transformContentImmediate(scale,0,0)}},this.resizeIFrameToContent=function(){var contHeight=getContentDocHeight();self.setHeight(contHeight),self.showIFrame()},this.setHeight=function(height){_$scaler.css("height",height+"px"),_$el.css("height",height+"px")},this.showIFrame=function(){_$iframe.css("visibility","visible"),_$iframe.css("transform","none")},this.hideIFrame=function(){_$iframe.css("visibility","hidden"),_$iframe.css("transform","translate(10000px, 10000px)")},this.updatePageSwitchDir=function(dir,hasChanged){_pageTransitionHandler.updatePageSwitchDir(dir,hasChanged)},this.transformContentImmediate=function(scale,left,top){var elWidth=Math.ceil(_meta_size.width*scale),elHeight=Math.floor(_meta_size.height*scale);if(_pageTransitionHandler.transformContentImmediate_BEGIN(_$el,scale,left,top),_$el.css("left",left+"px"),_$el.css("top",top+"px"),_$el.css("width",elWidth+"px"),_$el.css("height",elHeight+"px"),_$epubHtml){var css=ReadiumSDK.Helpers.CSSTransformString({scale:scale});css.width=_meta_size.width,css.height=_meta_size.height,_$scaler.css(css),_$epubHtml.css("opacity","0.999"),self.showIFrame(),setTimeout(function(){_$epubHtml.css("opacity","1")},0),_pageTransitionHandler.transformContentImmediate_END(_$el,scale,left,top)}},this.getCalculatedPageHeight=function(){return _$el.height()},this.transformContent=_.bind(_.debounce(this.transformContentImmediate,50),self),this.loadSpineItem=function(spineItem,callback,context){if(_currentSpineItem!=spineItem){_currentSpineItem=spineItem;var src=_spine.package.resolveRelativeUrl(spineItem.href);self.hideIFrame(),self.trigger(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,_$iframe,_currentSpineItem),_iframeLoader.loadIframe(_$iframe[0],src,function(success){if(success&&callback){var func=function(){callback(success,_$iframe,_currentSpineItem,!0,context)};ReadiumSDK.Helpers.isIframeAlive(_$iframe[0])?(onIFrameLoad(success),func()):(console.error("onIFrameLoad !! doc && win + TIMEOUT"),console.debug(spineItem.href),onIFrameLoad(success),setTimeout(func,500))}else onIFrameLoad(success)},self,{spineItem:_currentSpineItem})}else callback&&callback(!0,_$iframe,_currentSpineItem,!1,context)},this.getFirstVisibleElementCfi=function(){var navigation=new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe);return navigation.getFirstVisibleElementCfi(0)},this.getNavigator=function(){return new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe)},this.getElementByCfi=function(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist){if(spineItem!=_currentSpineItem)return void console.error("spine item is not loaded");var navigation=new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe);return navigation.getElementByCfi(cfi,classBlacklist,elementBlacklist,idBlacklist)},this.getElementById=function(spineItem,id){if(spineItem!=_currentSpineItem)return void console.error("spine item is not loaded");var navigation=new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe);return navigation.getElementById(id)},this.getElement=function(spineItem,selector){if(spineItem!=_currentSpineItem)return void console.error("spine item is not loaded");var navigation=new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe);return navigation.getElement(selector)},this.getFirstVisibleMediaOverlayElement=function(){var navigation=new ReadiumSDK.Views.CfiNavigationLogic(_$el,_$iframe);return navigation.getFirstVisibleMediaOverlayElement({top:0,bottom:_$iframe.height()})},this.offset=function(){return _$iframe?_$iframe.offset():void 0}},ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START="SpineItemOpenStart",define("onePageView",["readiumSDK","cfiNavigationLogic"],function(global){return function(){var ret;return ret||global.onePageView}}(this)),ReadiumSDK.Models.CurrentPagesInfo=function(spine,isFixedLayout){this.isRightToLeft=spine.isRightToLeft(),this.isFixedLayout=isFixedLayout,this.spineItemCount=spine.items.length,this.openPages=[],this.addOpenPage=function(spineItemPageIndex,spineItemPageCount,idref,spineItemIndex){this.openPages.push({spineItemPageIndex:spineItemPageIndex,spineItemPageCount:spineItemPageCount,idref:idref,spineItemIndex:spineItemIndex}),this.sort()},this.canGoLeft=function(){return this.isRightToLeft?this.canGoNext():this.canGoPrev()},this.canGoRight=function(){return this.isRightToLeft?this.canGoPrev():this.canGoNext()},this.canGoNext=function(){if(0==this.openPages.length)return!1;var lastOpenPage=this.openPages[this.openPages.length-1];return lastOpenPage.spineItemIndex<spine.last().index||lastOpenPage.spineItemPageIndex<lastOpenPage.spineItemPageCount-1},this.canGoPrev=function(){if(0==this.openPages.length)return!1;var firstOpenPage=this.openPages[0];return spine.first().index<firstOpenPage.spineItemIndex||0<firstOpenPage.spineItemPageIndex},this.sort=function(){this.openPages.sort(function(a,b){return a.spineItemIndex!=b.spineItemIndex?a.spineItemIndex-b.spineItemIndex:a.pageIndex-b.pageIndex})}},define("currentPagesInfo",["readiumSDK"],function(global){return function(){var ret;return ret||global.currentPagesInfo}}(this)),ReadiumSDK.Models.Spread=function(spine,isSyntheticSpread){function resetItems(){self.leftItem=void 0,self.rightItem=void 0,self.centerItem=void 0}function setItemToPosition(item,position){position==ReadiumSDK.Models.Spread.POSITION_LEFT?self.leftItem=item:position==ReadiumSDK.Models.Spread.POSITION_RIGHT?self.rightItem=item:(position!=ReadiumSDK.Models.Spread.POSITION_CENTER&&console.error("Unrecognized position value"),self.centerItem=item)}function getItemPosition(item){return _isSyntheticSpread?item.isLeftPage()?ReadiumSDK.Models.Spread.POSITION_LEFT:item.isRightPage()?ReadiumSDK.Models.Spread.POSITION_RIGHT:ReadiumSDK.Models.Spread.POSITION_CENTER:ReadiumSDK.Models.Spread.POSITION_CENTER}function getNeighbourItem(item){return item.isLeftPage()?self.spine.isRightToLeft()?self.spine.prevItem(item):self.spine.nextItem(item):item.isRightPage()?self.spine.isRightToLeft()?self.spine.nextItem(item):self.spine.prevItem(item):void 0}var self=this;this.spine=spine,this.leftItem=void 0,this.rightItem=void 0,this.centerItem=void 0;var _isSyntheticSpread=isSyntheticSpread;this.setSyntheticSpread=function(isSyntheticSpread){_isSyntheticSpread=isSyntheticSpread},this.isSyntheticSpread=function(){return _isSyntheticSpread},this.openFirst=function(){0==this.spine.items.length?resetItems():this.openItem(this.spine.first())},this.openLast=function(){0==this.spine.items.length?resetItems():this.openItem(this.spine.last())},this.openItem=function(item){resetItems();var position=getItemPosition(item);if(setItemToPosition(item,position),position!=ReadiumSDK.Models.Spread.POSITION_CENTER){var neighbour=getNeighbourItem(item);if(neighbour){var neighbourPos=getItemPosition(neighbour);neighbourPos!=position&&neighbourPos!=ReadiumSDK.Models.Spread.POSITION_CENTER&&setItemToPosition(neighbour,neighbourPos)}}},this.openNext=function(){var items=this.validItems();if(0==items.length)this.openFirst();else{var nextItem=this.spine.nextItem(items[items.length-1]);nextItem&&this.openItem(nextItem)
}},this.openPrev=function(){var items=this.validItems();if(0==items.length)this.openLast();else{var prevItem=this.spine.prevItem(items[0]);prevItem&&this.openItem(prevItem)}},this.validItems=function(){var arr=[];return this.leftItem&&arr.push(this.leftItem),this.rightItem&&arr.push(this.rightItem),this.centerItem&&arr.push(this.centerItem),arr.sort(function(a,b){return a.index-b.index}),arr}},ReadiumSDK.Models.Spread.POSITION_LEFT="left",ReadiumSDK.Models.Spread.POSITION_RIGHT="right",ReadiumSDK.Models.Spread.POSITION_CENTER="center",define("fixedPageSpread",["readiumSDK"],function(global){return function(){var ret;return ret||global.fixedPageSpread}}(this)),ReadiumSDK.Models.BookmarkData=function(idref,contentCFI){this.idref=idref,this.contentCFI=contentCFI},define("bookmarkData",["readiumSDK"],function(global){return function(){var ret;return ret||global.bookmarkData}}(this)),ReadiumSDK.Views.FixedView=function(options){function createOnePageView(elementClass){var pageView=new ReadiumSDK.Views.OnePageView(options,[elementClass],!1);return pageView.on(ReadiumSDK.Views.OnePageView.SPINE_ITEM_OPEN_START,function($iframe,spineItem){self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,$iframe,spineItem)}),pageView}function getFirstVisibleItem(){var visibleItems=_spread.validItems();return visibleItems[0]}function redraw(initiator,paginationRequest){if(_isRedrowing)return void(_redrawRequest={initiator:initiator,paginationRequest:paginationRequest});_isRedrowing=!0;var context={isElementAdded:!1},pageLoadDeferrals=createPageLoadDeferrals([{pageView:_leftPageView,spineItem:_spread.leftItem,context:context},{pageView:_rightPageView,spineItem:_spread.rightItem,context:context},{pageView:_centerPageView,spineItem:_spread.centerItem,context:context}]);$.when.apply($,pageLoadDeferrals).done(function(){if(_isRedrowing=!1,_redrawRequest){var p1=_redrawRequest.initiator,p2=_redrawRequest.paginationRequest;_redrawRequest=void 0,redraw(p1,p2)}else context.isElementAdded&&self.applyStyles(),paginationRequest?onPagesLoaded(initiator,paginationRequest.spineItem,paginationRequest.elementId):onPagesLoaded(initiator)})}function createPageLoadDeferrals(viewItemPairs){for(var pageLoadDeferrals=[],i=0;i<viewItemPairs.length;i++){var dfd=updatePageViewForItem(viewItemPairs[i].pageView,viewItemPairs[i].spineItem,viewItemPairs[i].context);pageLoadDeferrals.push(dfd)}return pageLoadDeferrals}function onPagesLoaded(initiator,paginationRequest_spineItem,paginationRequest_elementId){updateContentMetaSize(),resizeBook(),self.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:self.getPaginationInfo(),initiator:initiator,spineItem:paginationRequest_spineItem,elementId:paginationRequest_elementId})}function isSpreadChanged(firstVisibleItem,isSyntheticSpread){var tmpSpread=new ReadiumSDK.Models.Spread(_spine,isSyntheticSpread);return tmpSpread.openItem(firstVisibleItem),_spread.leftItem!=tmpSpread.leftItem||_spread.rightItem!=tmpSpread.rightItem||_spread.centerItem!=tmpSpread.centerItem}function isContentRendered(){if(!_contentMetaSize||!_bookMargins)return!1;var viewportWidth=_$viewport.width(),viewportHeight=_$viewport.height();return viewportWidth&&viewportHeight}function resizeBook(viewportIsResizing){if(updatePageSwitchDir(0,!1),isContentRendered()){var viewportWidth=_$viewport.width(),viewportHeight=_$viewport.height(),leftPageMargins=_leftPageView.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(_leftPageView.element()):ReadiumSDK.Helpers.Margins.empty(),rightPageMargins=_rightPageView.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(_rightPageView.element()):ReadiumSDK.Helpers.Margins.empty(),centerPageMargins=_centerPageView.isDisplaying()?ReadiumSDK.Helpers.Margins.fromElement(_centerPageView.element()):ReadiumSDK.Helpers.Margins.empty(),pageMargins=getMaxPageMargins(leftPageMargins,rightPageMargins,centerPageMargins),potentialTargetElementSize={width:viewportWidth-_bookMargins.width(),height:viewportHeight-_bookMargins.height()},potentialContentSize={width:potentialTargetElementSize.width-pageMargins.width(),height:potentialTargetElementSize.height-pageMargins.height()};if(!(potentialTargetElementSize.width<=0||potentialTargetElementSize.height<=0)){var scale,horScale=potentialContentSize.width/_contentMetaSize.width,verScale=potentialContentSize.height/_contentMetaSize.height;scale="fit-width"==_zoom.style?horScale:"fit-height"==_zoom.style?verScale:"user"==_zoom.style?_zoom.scale:Math.min(horScale,verScale),_currentScale=scale;var contentSize={width:_contentMetaSize.width*scale,height:_contentMetaSize.height*scale},targetElementSize={width:contentSize.width+pageMargins.width(),height:contentSize.height+pageMargins.height()},bookSize={width:targetElementSize.width+_bookMargins.width(),height:targetElementSize.height+_bookMargins.height()},bookLeft=Math.floor((viewportWidth-bookSize.width)/2),bookTop=Math.floor((viewportHeight-bookSize.height)/2);0>bookLeft&&(bookLeft=0),0>bookTop&&(bookTop=0),_$el.css("left",bookLeft+"px"),_$el.css("top",bookTop+"px"),_$el.css("width",targetElementSize.width+"px"),_$el.css("height",targetElementSize.height+"px");var left=_bookMargins.padding.left,top=_bookMargins.padding.top,transFunc=viewportIsResizing?"transformContentImmediate":"transformContent";_leftPageView.isDisplaying()&&_leftPageView[transFunc](scale,left,top),_rightPageView.isDisplaying()&&(left+=_contentMetaSize.separatorPosition*scale,_leftPageView.isDisplaying()&&(left+=leftPageMargins.left),_rightPageView[transFunc](scale,left,top)),_centerPageView.isDisplaying()&&_centerPageView[transFunc](scale,left,top),self.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}}}function getMaxPageMargins(leftPageMargins,rightPageMargins,centerPageMargins){var sumMargin={left:Math.max(leftPageMargins.margin.left,rightPageMargins.margin.left,centerPageMargins.margin.left),right:Math.max(leftPageMargins.margin.right,rightPageMargins.margin.right,centerPageMargins.margin.right),top:Math.max(leftPageMargins.margin.top,rightPageMargins.margin.top,centerPageMargins.margin.top),bottom:Math.max(leftPageMargins.margin.bottom,rightPageMargins.margin.bottom,centerPageMargins.margin.bottom)},sumBorder={left:Math.max(leftPageMargins.border.left,rightPageMargins.border.left,centerPageMargins.border.left),right:Math.max(leftPageMargins.border.right,rightPageMargins.border.right,centerPageMargins.border.right),top:Math.max(leftPageMargins.border.top,rightPageMargins.border.top,centerPageMargins.border.top),bottom:Math.max(leftPageMargins.border.bottom,rightPageMargins.border.bottom,centerPageMargins.border.bottom)},sumPAdding={left:Math.max(leftPageMargins.padding.left,rightPageMargins.padding.left,centerPageMargins.padding.left),right:Math.max(leftPageMargins.padding.right,rightPageMargins.padding.right,centerPageMargins.padding.right),top:Math.max(leftPageMargins.padding.top,rightPageMargins.padding.top,centerPageMargins.padding.top),bottom:Math.max(leftPageMargins.padding.bottom,rightPageMargins.padding.bottom,centerPageMargins.padding.bottom)};return new ReadiumSDK.Helpers.Margins(sumMargin,sumBorder,sumPAdding)}function updateContentMetaSize(){_contentMetaSize={},_centerPageView.isDisplaying()?(_contentMetaSize.width=_centerPageView.meta_width(),_contentMetaSize.height=_centerPageView.meta_height(),_contentMetaSize.separatorPosition=0):_leftPageView.isDisplaying()&&_rightPageView.isDisplaying()?_leftPageView.meta_height()==_rightPageView.meta_height()?(_contentMetaSize.width=_leftPageView.meta_width()+_rightPageView.meta_width(),_contentMetaSize.height=_leftPageView.meta_height(),_contentMetaSize.separatorPosition=_leftPageView.meta_width()):(_contentMetaSize.width=_leftPageView.meta_width()+_rightPageView.meta_width()*(_leftPageView.meta_height()/_rightPageView.meta_height()),_contentMetaSize.height=_leftPageView.meta_height(),_contentMetaSize.separatorPosition=_leftPageView.meta_width()):_leftPageView.isDisplaying()?(_contentMetaSize.width=2*_leftPageView.meta_width(),_contentMetaSize.height=_leftPageView.meta_height(),_contentMetaSize.separatorPosition=_leftPageView.meta_width()):_rightPageView.isDisplaying()?(_contentMetaSize.width=2*_rightPageView.meta_width(),_contentMetaSize.height=_rightPageView.meta_height(),_contentMetaSize.separatorPosition=_rightPageView.meta_width()):_contentMetaSize=void 0}function updateBookMargins(){_bookMargins=ReadiumSDK.Helpers.Margins.fromElement(_$el)}function updatePageViewForItem(pageView,item,context){var dfd=$.Deferred();return item?(pageView.isDisplaying()||(_$el.append(pageView.render().element()),context.isElementAdded=!0),pageView.loadSpineItem(item,function(success,$iframe,spineItem,isNewContentDocumentLoaded){success&&isNewContentDocumentLoaded&&(pageView.meta_height()&&pageView.meta_width()||console.error("Invalid document "+spineItem.href+": viewport is not specified!"),self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,$iframe,spineItem)),dfd.resolve()},context)):(pageView.isDisplaying()&&pageView.remove(),dfd.resolve()),dfd.promise()}function getDisplayingViews(){var viewsToCheck=[];viewsToCheck=_spine.isLeftToRight()?[_leftPageView,_centerPageView,_rightPageView]:[_rightPageView,_centerPageView,_leftPageView];for(var views=[],i=0,count=viewsToCheck.length;count>i;i++)viewsToCheck[i].isDisplaying()&&views.push(viewsToCheck[i]);return views}_.extend(this,Backbone.Events);var _$el,_currentScale,self=this,_$viewport=options.$viewport,_spine=options.spine,_userStyles=options.userStyles,_zoom=(options.bookStyles,options.zoom||{style:"default"}),_viewSettings=(options.iframeLoader,void 0),_leftPageView=createOnePageView("fixed-page-frame-left"),_rightPageView=createOnePageView("fixed-page-frame-right"),_centerPageView=createOnePageView("fixed-page-frame-center"),_pageViews=[];_pageViews.push(_leftPageView),_pageViews.push(_rightPageView),_pageViews.push(_centerPageView);var _bookMargins,_contentMetaSize,_spread=new ReadiumSDK.Models.Spread(_spine,!1),_isRedrowing=!1,_redrawRequest=!1;this.isReflowable=function(){return!1},this.setZoom=function(zoom){_zoom=zoom,resizeBook(!1)},this.render=function(){var template=ReadiumSDK.Helpers.loadTemplate("fixed_book_frame",{});return _$el=$(template),_.each(["-webkit-","-moz-","-ms-",""],function(prefix){_$el.css(prefix+"transition","all 0 ease 0")}),_$el.css("overflow","hidden"),_$viewport.append(_$el),self.applyStyles(),this},this.remove=function(){_$el.remove()},this.setViewSettings=function(settings){_viewSettings=settings,_spread.setSyntheticSpread(1==ReadiumSDK.Helpers.deduceSyntheticSpread(_$viewport,getFirstVisibleItem(),_viewSettings));for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++)views[i].setViewSettings(settings)};var updatePageSwitchDir=function(dir,hasChanged){_leftPageView&&_leftPageView.updatePageSwitchDir(dir,hasChanged),_rightPageView&&_rightPageView.updatePageSwitchDir(dir,hasChanged),_centerPageView&&_centerPageView.updatePageSwitchDir(dir,hasChanged)};this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(_userStyles.getStyles(),_$el.parent()),updateBookMargins(),updateContentMetaSize(),resizeBook()},this.applyBookStyles=function(){for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++)views[i].applyBookStyles()},this.onViewportResize=function(){var firstVisibleItem=getFirstVisibleItem();if(firstVisibleItem){var isSyntheticSpread=1==ReadiumSDK.Helpers.deduceSyntheticSpread(_$viewport,firstVisibleItem,_viewSettings);if(isSpreadChanged(firstVisibleItem,isSyntheticSpread)){_spread.setSyntheticSpread(isSyntheticSpread);var paginationRequest=new ReadiumSDK.Models.PageOpenRequest(firstVisibleItem,self);self.openPage(paginationRequest)}else resizeBook(!0)}},this.getViewScale=function(){return _currentScale},this.openPage=function(paginationRequest,dir){if(paginationRequest.spineItem){var leftItem=_spread.leftItem,rightItem=_spread.rightItem,centerItem=_spread.centerItem,isSyntheticSpread=1==ReadiumSDK.Helpers.deduceSyntheticSpread(_$viewport,paginationRequest.spineItem,_viewSettings);_spread.setSyntheticSpread(isSyntheticSpread),_spread.openItem(paginationRequest.spineItem);var hasChanged=leftItem!==_spread.leftItem||rightItem!==_spread.rightItem||centerItem!==_spread.centerItem;(null===dir||"undefined"==typeof dir)&&(dir=0),updatePageSwitchDir(0===dir?0:_spread.spine.isRightToLeft()?1===dir?2:1:dir,hasChanged),redraw(paginationRequest.initiator,paginationRequest)}},this.openPagePrev=function(initiator){_spread.openPrev(),updatePageSwitchDir(_spread.spine.isRightToLeft()?2:1,!0),redraw(initiator,void 0)},this.openPageNext=function(initiator){_spread.openNext(),updatePageSwitchDir(_spread.spine.isRightToLeft()?1:2,!0),redraw(initiator,void 0)},this.getPaginationInfo=function(){for(var paginationInfo=new ReadiumSDK.Models.CurrentPagesInfo(_spine,!0),spreadItems=[_spread.leftItem,_spread.rightItem,_spread.centerItem],i=0;i<spreadItems.length;i++){var spreadItem=spreadItems[i];spreadItem&&paginationInfo.addOpenPage(0,1,spreadItem.idref,spreadItem.index)}return paginationInfo},this.bookmarkCurrentPage=function(){var views=getDisplayingViews();if(views.length>0){var idref=views[0].currentSpineItem().idref,cfi=views[0].getFirstVisibleElementCfi();return void 0==cfi&&(cfi=""),new ReadiumSDK.Models.BookmarkData(idref,cfi)}return new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return _spread.validItems()},this.getElement=function(spineItem,selector){for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++){var view=views[i];if(view.currentSpineItem()==spineItem)return view.getElement(spineItem,selector)}return void console.error("spine item is not loaded")},this.getElementById=function(spineItem,id){for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++){var view=views[i];if(view.currentSpineItem()==spineItem)return view.getElementById(spineItem,id)}return void console.error("spine item is not loaded")},this.getElementByCfi=function(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist){for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++){var view=views[i];if(view.currentSpineItem()==spineItem)return view.getElementByCfi(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist)}return void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){for(var views=getDisplayingViews(),i=0,count=views.length;count>i;i++){var el=views[i].getFirstVisibleMediaOverlayElement();if(el)return el}return void 0},this.insureElementVisibility=function(){}},define("fixedView",["readiumSDK","onePageView","currentPagesInfo","fixedPageSpread","bookmarkData"],function(global){return function(){var ret;return ret||global.fixedView}}(this)),ReadiumSDK.Views.ReflowableView=function(options){function setFrameSizesToRectangle(rectangle){_$contentFrame.css("left",rectangle.left+"px"),_$contentFrame.css("top",rectangle.top+"px"),_$contentFrame.css("right",rectangle.right+"px"),_$contentFrame.css("bottom",rectangle.bottom+"px")}function renderIframe(){_$contentFrame&&_$contentFrame.remove();var template=ReadiumSDK.Helpers.loadTemplate("reflowable_book_page_frame",{}),$bookFrame=$(template);$bookFrame=_$el.append($bookFrame),_$contentFrame=$("#reflowable-content-frame",$bookFrame),_$iframe=$("#epubContentIframe",$bookFrame),_$iframe.css("left",""),_$iframe.css("right",""),_$iframe.css("position","relative"),_$iframe.css("overflow","hidden"),_navigationLogic=new ReadiumSDK.Views.CfiNavigationLogic(_$contentFrame,_$iframe,{rectangleBased:!0,paginationInfo:_paginationInfo})}function loadSpineItem(spineItem){if(_currentSpineItem!=spineItem){renderIframe(),_paginationInfo.pageOffset=0,_paginationInfo.currentSpreadIndex=0,_currentSpineItem=spineItem,_isWaitingFrameRender=!0;var src=_spine.package.resolveRelativeUrl(spineItem.href);self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,_$iframe,spineItem),_$iframe.css("opacity","0.01"),_iframeLoader.loadIframe(_$iframe[0],src,onIFrameLoad,self,{spineItem:spineItem})}}function updateHtmlFontSize(){_$epubHtml&&_$epubHtml.css("font-size",_fontSize+"%")}function updateColumnGap(){_$epubHtml&&_.each(["-webkit-","-moz-","-ms-",""],function(prefix){_$epubHtml.css(prefix+"column-gap",_paginationInfo.columnGap+"px")})}function onIFrameLoad(success){if(_isWaitingFrameRender=!1,_deferredPageRequest&&_deferredPageRequest.spineItem!=_currentSpineItem)return void loadSpineItem(_deferredPageRequest.spineItem);if(!success)return _$iframe.css("opacity","1"),void(_deferredPageRequest=void 0);self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,_$iframe,_currentSpineItem);var epubContentDocument=_$iframe[0].contentDocument;_$epubHtml=$("html",epubContentDocument),_$htmlBody=$("body",_$epubHtml),_htmlBodyIsVerticalWritingMode=!1,_htmlBodyIsLTRDirection=!0,_htmlBodyIsLTRWritingMode=void 0;var win=_$iframe[0].contentDocument.defaultView||_$iframe[0].contentWindow,htmlBodyComputedStyle=win.getComputedStyle(_$htmlBody[0],null);if(htmlBodyComputedStyle){_htmlBodyIsLTRDirection="ltr"===htmlBodyComputedStyle.direction;var writingMode=void 0;writingMode=htmlBodyComputedStyle.getPropertyValue?htmlBodyComputedStyle.getPropertyValue("-webkit-writing-mode")||htmlBodyComputedStyle.getPropertyValue("-moz-writing-mode")||htmlBodyComputedStyle.getPropertyValue("-ms-writing-mode")||htmlBodyComputedStyle.getPropertyValue("-o-writing-mode")||htmlBodyComputedStyle.getPropertyValue("-epub-writing-mode")||htmlBodyComputedStyle.getPropertyValue("writing-mode"):htmlBodyComputedStyle.webkitWritingMode||htmlBodyComputedStyle.mozWritingMode||htmlBodyComputedStyle.msWritingMode||htmlBodyComputedStyle.oWritingMode||htmlBodyComputedStyle.epubWritingMode||htmlBodyComputedStyle.writingMode,writingMode&&(_htmlBodyIsLTRWritingMode=writingMode.indexOf("-lr")>=0,(writingMode.indexOf("vertical")>=0||writingMode.indexOf("tb-")>=0||writingMode.indexOf("bt-")>=0)&&(_htmlBodyIsVerticalWritingMode=!0))}_htmlBodyIsLTRDirection&&("rtl"===_$htmlBody[0].getAttribute("dir")||"rtl"===_$epubHtml[0].getAttribute("dir"))&&(_htmlBodyIsLTRDirection=!1),_spine.isLeftToRight()||!_htmlBodyIsLTRDirection||_htmlBodyIsVerticalWritingMode||(_$htmlBody[0].setAttribute("dir","rtl"),_htmlBodyIsLTRDirection=!1,_htmlBodyIsLTRWritingMode=!1),_paginationInfo.isVerticalWritingMode=_htmlBodyIsVerticalWritingMode,hideBook(),_$iframe.css("opacity","1"),updateViewportSize(),_$epubHtml.css("height",_lastViewPortSize.height+"px"),_$epubHtml.css("position","relative"),_$epubHtml.css("margin","0"),_$epubHtml.css("padding","0"),_.each(["-webkit-","-moz-","-ms-",""],function(prefix){_$epubHtml.css(prefix+"column-axis",_htmlBodyIsVerticalWritingMode?"vertical":"horizontal")}),self.applyBookStyles(),resizeImages(),updateHtmlFontSize(),updateColumnGap(),self.applyStyles()}function openDeferredElement(){if(_deferredPageRequest){var deferredData=_deferredPageRequest;_deferredPageRequest=void 0,self.openPage(deferredData)}}function redraw(){var offsetVal=-_paginationInfo.pageOffset+"px";if(_htmlBodyIsVerticalWritingMode)_$epubHtml.css("top",offsetVal);else{var ltr=_htmlBodyIsLTRDirection||_htmlBodyIsLTRWritingMode;_$epubHtml.css("left",ltr?offsetVal:""),_$epubHtml.css("right",ltr?"":offsetVal)}showBook()}function updateViewportSize(){var newWidth=_$contentFrame.width(),newHeight=_$contentFrame.height();return _lastViewPortSize.width!==newWidth||_lastViewPortSize.height!==newHeight?(_lastViewPortSize.width=newWidth,_lastViewPortSize.height=newHeight,!0):!1}function onPaginationChanged(initiator,paginationRequest_spineItem,paginationRequest_elementId){_paginationInfo.pageOffset=(_paginationInfo.columnWidth+_paginationInfo.columnGap)*_paginationInfo.visibleColumnCount*_paginationInfo.currentSpreadIndex,redraw(),self.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:self.getPaginationInfo(),initiator:initiator,spineItem:paginationRequest_spineItem,elementId:paginationRequest_elementId})}function updatePagination(){var MAXW=550,MINW=400,isDoublePageSyntheticSpread=ReadiumSDK.Helpers.deduceSyntheticSpread(_$viewport,_currentSpineItem,_viewSettings),forced=isDoublePageSyntheticSpread===!1||isDoublePageSyntheticSpread===!0;if(0===isDoublePageSyntheticSpread&&(isDoublePageSyntheticSpread=1),_paginationInfo.visibleColumnCount=isDoublePageSyntheticSpread?2:1,_htmlBodyIsVerticalWritingMode&&(MAXW*=2,isDoublePageSyntheticSpread=!1,forced=!0,_paginationInfo.visibleColumnCount=1),_$epubHtml){hideBook();var borderLeft=parseInt(_$viewport.css("border-left-width")),borderRight=parseInt(_$viewport.css("border-right-width")),adjustedGapLeft=_paginationInfo.columnGap/2;adjustedGapLeft=Math.max(0,adjustedGapLeft-borderLeft);var adjustedGapRight=_paginationInfo.columnGap/2;adjustedGapRight=Math.max(0,adjustedGapRight-borderRight);var filler=0;if(_viewSettings.fontSize){var fontSizeAdjust=.8*_viewSettings.fontSize/100;MAXW=Math.floor(MAXW*fontSizeAdjust),MINW=Math.floor(MINW*fontSizeAdjust)}var availableWidth=_$viewport.width(),textWidth=availableWidth-borderLeft-borderRight-adjustedGapLeft-adjustedGapRight;isDoublePageSyntheticSpread&&(textWidth=.5*(textWidth-_paginationInfo.columnGap)),textWidth>MAXW?filler=Math.floor((textWidth-MAXW)*(isDoublePageSyntheticSpread?1:.5)):!forced&&MINW>textWidth&&isDoublePageSyntheticSpread&&(isDoublePageSyntheticSpread=!1,_paginationInfo.visibleColumnCount=1,textWidth=availableWidth-borderLeft-borderRight-adjustedGapLeft-adjustedGapRight,textWidth>MAXW&&(filler=Math.floor(.5*(textWidth-MAXW)))),_$el.css({left:filler+adjustedGapLeft+"px",right:filler+adjustedGapRight+"px"}),updateViewportSize(),_$iframe.css("width",_lastViewPortSize.width+"px"),_$iframe.css("height",_lastViewPortSize.height+"px"),_$epubHtml.css("height",_lastViewPortSize.height+"px"),_$epubHtml.css("min-height",_lastViewPortSize.height+"px"),_$epubHtml.css("max-height",_lastViewPortSize.height+"px"),_$epubHtml.css("margin",0),_$epubHtml.css("padding",0),_$epubHtml.css("border",0),_$htmlBody.css("margin",0),_$htmlBody.css("padding",0);var spacing=0;try{spacing=parseInt(_$htmlBody.css("padding-top"))+parseInt(_$htmlBody.css("border-top-width"))+parseInt(_$htmlBody.css("border-bottom-width"))}catch(err){}_$htmlBody.css("min-height","50%"),_$htmlBody.css("max-height",_lastViewPortSize.height-spacing+"px"),_paginationInfo.rightToLeft=_spine.isRightToLeft(),_paginationInfo.columnWidth=Math.round(((_htmlBodyIsVerticalWritingMode?_lastViewPortSize.height:_lastViewPortSize.width)-_paginationInfo.columnGap*(_paginationInfo.visibleColumnCount-1))/_paginationInfo.visibleColumnCount),_$epubHtml.css("width",(_htmlBodyIsVerticalWritingMode?_lastViewPortSize.width:_paginationInfo.columnWidth)+"px"),_.each(["-webkit-","-moz-","-ms-",""],function(prefix){_$epubHtml.css(prefix+"column-width",_paginationInfo.columnWidth+"px")}),_$epubHtml.css({left:"0",right:"0",top:"0"}),ReadiumSDK.Helpers.triggerLayout(_$iframe),_paginationInfo.columnCount=((_htmlBodyIsVerticalWritingMode?_$epubHtml[0].scrollHeight:_$epubHtml[0].scrollWidth)+_paginationInfo.columnGap)/(_paginationInfo.columnWidth+_paginationInfo.columnGap),_paginationInfo.columnCount=Math.round(_paginationInfo.columnCount);var totalGaps=(_paginationInfo.columnCount-1)*_paginationInfo.columnGap,colWidthCheck=((_htmlBodyIsVerticalWritingMode?_$epubHtml[0].scrollHeight:_$epubHtml[0].scrollWidth)-totalGaps)/_paginationInfo.columnCount;colWidthCheck=Math.round(colWidthCheck),colWidthCheck>_paginationInfo.columnWidth&&(console.debug("ADJUST COLUMN"),console.log(_paginationInfo.columnWidth),console.log(colWidthCheck),_paginationInfo.columnWidth=colWidthCheck),_paginationInfo.spreadCount=Math.ceil(_paginationInfo.columnCount/_paginationInfo.visibleColumnCount),_paginationInfo.currentSpreadIndex>=_paginationInfo.spreadCount&&(_paginationInfo.currentSpreadIndex=_paginationInfo.spreadCount-1),_deferredPageRequest?openDeferredElement():onPaginationChanged(self)}}function hideBook(){-1==_currentOpacity&&(_currentOpacity=_$epubHtml.css("opacity"),_$epubHtml.css("opacity","0"))}function showBook(){-1!=_currentOpacity&&_$epubHtml.css("opacity",_currentOpacity),_currentOpacity=-1}function getOpenPageIndexes(){for(var indexes=[],currentPage=_paginationInfo.currentSpreadIndex*_paginationInfo.visibleColumnCount,i=0;i<_paginationInfo.visibleColumnCount&&currentPage+i<_paginationInfo.columnCount;i++)indexes.push(currentPage+i);return indexes}function resizeImages(){if(_$epubHtml){var $elem;$("img, svg",_$epubHtml).each(function(){$elem=$(this),$elem.css("max-width","98%"),$elem.css("max-height","98%"),$elem.css("height")||$elem.css("height","auto"),$elem.css("width")||$elem.css("width","auto")})}}function getVisibleContentOffsets(){var columnsLeftOfViewport=Math.round(_paginationInfo.pageOffset/(_paginationInfo.columnWidth+_paginationInfo.columnGap)),topOffset=columnsLeftOfViewport*_$contentFrame.height(),bottomOffset=topOffset+_paginationInfo.visibleColumnCount*_$contentFrame.height();return{top:topOffset,bottom:bottomOffset}}_.extend(this,Backbone.Events);var _currentSpineItem,_deferredPageRequest,_$contentFrame,_navigationLogic,_$el,_$iframe,_$epubHtml,_$htmlBody,_htmlBodyIsVerticalWritingMode,_htmlBodyIsLTRDirection,_htmlBodyIsLTRWritingMode,self=this,_$viewport=options.$viewport,_spine=options.spine,_userStyles=options.userStyles,_bookStyles=options.bookStyles,_iframeLoader=options.iframeLoader,_isWaitingFrameRender=!1,_fontSize=100,_currentOpacity=-1,_lastViewPortSize={width:void 0,height:void 0},_paginationInfo={visibleColumnCount:2,columnGap:20,spreadCount:0,currentSpreadIndex:0,columnWidth:void 0,pageOffset:0,columnCount:0};this.render=function(){var template=ReadiumSDK.Helpers.loadTemplate("reflowable_book_frame",{});_$el=$(template),_$viewport.append(_$el);var settings=_viewSettings;return settings||(settings=new ReadiumSDK.Models.ViewerSettings({})),settings.enableGPUHardwareAccelerationCSS3D&&_$el.css("transform","translateZ(0)"),renderIframe(),self},this.remove=function(){_$el.remove()},this.isReflowable=function(){return!0},this.onViewportResize=function(){updateViewportSize()&&updatePagination()};var _viewSettings=void 0;this.setViewSettings=function(settings){_viewSettings=settings,_paginationInfo.columnGap=settings.columnGap,_fontSize=settings.fontSize,updateHtmlFontSize(),updateColumnGap(),updateViewportSize(),updatePagination()},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(_userStyles.getStyles(),_$el.parent());var elementMargins=ReadiumSDK.Helpers.Margins.fromElement(_$el);setFrameSizesToRectangle(elementMargins.padding),updateViewportSize(),updatePagination()},this.applyBookStyles=function(){_$epubHtml&&ReadiumSDK.Helpers.setStyles(_bookStyles.getStyles(),_$epubHtml)},this.openPage=function(pageRequest){if(_isWaitingFrameRender)return void(_deferredPageRequest=pageRequest);if(pageRequest.spineItem&&pageRequest.spineItem!=_currentSpineItem)return _deferredPageRequest=pageRequest,void loadSpineItem(pageRequest.spineItem);var pageIndex=void 0;if(void 0!==pageRequest.spineItemPageIndex)pageIndex=pageRequest.spineItemPageIndex;else if(pageRequest.elementId)pageIndex=_navigationLogic.getPageForElementId(pageRequest.elementId);else if(pageRequest.elementCfi)try{pageIndex=_navigationLogic.getPageForElementCfi(pageRequest.elementCfi,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(e){pageIndex=0,console.error(e)}else pageRequest.firstPage?pageIndex=0:pageRequest.lastPage?pageIndex=_paginationInfo.columnCount-1:(console.debug("No criteria in pageRequest"),pageIndex=0);pageIndex>=0&&pageIndex<_paginationInfo.columnCount?(_paginationInfo.currentSpreadIndex=Math.floor(pageIndex/_paginationInfo.visibleColumnCount),onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId)):console.log("Illegal pageIndex value: ",pageIndex,"column count is ",_paginationInfo.columnCount)},this.openPagePrev=function(initiator){if(_currentSpineItem)if(_paginationInfo.currentSpreadIndex>0)_paginationInfo.currentSpreadIndex--,onPaginationChanged(initiator);else{var prevSpineItem=_spine.prevItem(_currentSpineItem,!0);if(prevSpineItem){var pageRequest=new ReadiumSDK.Models.PageOpenRequest(prevSpineItem,initiator);pageRequest.setLastPage(),self.openPage(pageRequest)}}},this.openPageNext=function(initiator){if(_currentSpineItem)if(_paginationInfo.currentSpreadIndex<_paginationInfo.spreadCount-1)_paginationInfo.currentSpreadIndex++,onPaginationChanged(initiator);else{var nextSpineItem=_spine.nextItem(_currentSpineItem,!0);if(nextSpineItem){var pageRequest=new ReadiumSDK.Models.PageOpenRequest(nextSpineItem,initiator);pageRequest.setFirstPage(),self.openPage(pageRequest)}}},this.getFirstVisibleElementCfi=function(){var contentOffsets=getVisibleContentOffsets();return _navigationLogic.getFirstVisibleElementCfi(contentOffsets)},this.getPaginationInfo=function(){var paginationInfo=new ReadiumSDK.Models.CurrentPagesInfo(_spine,!1);if(!_currentSpineItem)return paginationInfo;for(var pageIndexes=getOpenPageIndexes(),i=0,count=pageIndexes.length;count>i;i++)paginationInfo.addOpenPage(pageIndexes[i],_paginationInfo.columnCount,_currentSpineItem.idref,_currentSpineItem.index);return paginationInfo},this.bookmarkCurrentPage=function(){return _currentSpineItem?new ReadiumSDK.Models.BookmarkData(_currentSpineItem.idref,self.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){return[_currentSpineItem]},this.getElementByCfi=function(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist){return spineItem!=_currentSpineItem?void console.error("spine item is not loaded"):_navigationLogic.getElementByCfi(cfi,classBlacklist,elementBlacklist,idBlacklist)},this.getElementById=function(spineItem,id){return spineItem!=_currentSpineItem?void console.error("spine item is not loaded"):_navigationLogic.getElementById(id)},this.getElement=function(spineItem,selector){return spineItem!=_currentSpineItem?void console.error("spine item is not loaded"):_navigationLogic.getElement(selector)},this.getFirstVisibleMediaOverlayElement=function(){var visibleContentOffsets=getVisibleContentOffsets();return _navigationLogic.getFirstVisibleMediaOverlayElement(visibleContentOffsets)},this.insureElementVisibility=function(spineItemId,element,initiator){var $element=$(element);if(!_navigationLogic.isElementVisible($element,getVisibleContentOffsets())){var page=_navigationLogic.getPageForElement($element);if(-1!=page){var openPageRequest=new ReadiumSDK.Models.PageOpenRequest(_currentSpineItem,initiator);openPageRequest.setPageIndex(page);var id=element.id;id||(id=element.getAttribute("id")),id&&openPageRequest.setElementId(id),self.openPage(openPageRequest)}}}},define("reflowableView",["readiumSDK","cfiNavigationLogic","bookmarkData"],function(global){return function(){var ret;return ret||global.reflowableView}}(this)),ReadiumSDK.Models.SmilIterator=function(smil){function findParNode(startIndex,container,previous){for(var i=startIndex,count=container.children.length;i>=0&&count>i;i+=previous?-1:1){var node=container.children[i];if("par"==node.nodeType)return node;if(node=findParNode(previous?node.children.length-1:0,node,previous))return node}return container.parent?findParNode(container.index+(previous?-1:1),container.parent,previous):void 0}this.smil=smil,this.currentPar=void 0,this.reset=function(){this.currentPar=findParNode(0,this.smil,!1)},this.findTextId=function(id){if(!this.currentPar)return void console.debug("Par iterator is out of range");if(!id)return!1;for(;this.currentPar;){if(this.currentPar.element){if(id===this.currentPar.text.srcFragmentId)return!0;for(var parent=this.currentPar.element.parentNode;parent;){if(parent.id&&parent.id==id)return!0;parent=parent.parentNode}var inside=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(id),this.currentPar.element);if(inside&&inside.length&&inside[0])return!0}this.next()}return!1},this.next=function(){return this.currentPar?void(this.currentPar=findParNode(this.currentPar.index+1,this.currentPar.parent,!1)):void console.debug("Par iterator is out of range")
},this.previous=function(){return this.currentPar?void(this.currentPar=findParNode(this.currentPar.index-1,this.currentPar.parent,!0)):void console.debug("Par iterator is out of range")},this.isLast=function(){return this.currentPar?findParNode(this.currentPar.index+1,this.currentPar.parent,!1)?!1:!0:void console.debug("Par iterator is out of range")},this.goToPar=function(par){for(;this.currentPar&&this.currentPar!=par;)this.next()},this.reset()},define("smilIterator",["readiumSDK"],function(global){return function(){var ret;return ret||global.smilIterator}}(this)),ReadiumSDK.Views.MediaOverlayDataInjector=function(mediaOverlay,mediaOverlayPlayer){this.attachMediaOverlayData=function($iframe,spineItem,mediaOverlaySettings){var contentDocElement=$iframe[0].contentDocument.documentElement;if(spineItem.media_overlay_id||0!==mediaOverlay.smil_models.length){var $body=$("body",contentDocElement);if(0==$body.length)console.error("! BODY ???");else{var click=$body.data("mediaOverlayClick");if(click)console.error("[WARN] already mediaOverlayClick");else{$body.data("mediaOverlayClick",{ping:"pong"});var clickEvent="ontouchstart"in document.documentElement?"touchstart":"click";$body.bind(clickEvent,function(event){var elem=$(this)[0];if(elem=event.target,!elem)return mediaOverlayPlayer.touchInit(),!0;var data=void 0,el=elem,inLink=!1;for("a"===el.nodeName.toLowerCase()&&(inLink=!0);!(data=$(el).data("mediaOverlayData"))&&("a"===el.nodeName.toLowerCase()&&(inLink=!0),el=el.parentNode););if(data&&(data.par||data.pars)){if(!mediaOverlaySettings.mediaOverlaysEnableClick)return console.log("MO CLICK DISABLED"),mediaOverlayPlayer.touchInit(),!0;if(inLink)return console.log("MO CLICKED LINK"),mediaOverlayPlayer.touchInit(),!0;var par=data.par?data.par:data.pars[0];if(data.pars&&"undefined"!=typeof rangy){var wasPaused=!1;mediaOverlayPlayer.isPlayingCfi()&&(wasPaused=!0,mediaOverlayPlayer.pause());try{var pos=rangy.positionFromPoint(event.pageX,event.pageY,elem.ownerDocument);par=void 0;for(var iPar=0;iPar<data.pars.length;iPar++){var p=data.pars[iPar],startCFI="epubcfi("+p.cfi.partialStartCfi+")",infoStart=EPUBcfi.getTextTerminusInfoWithPartialCFI(startCFI,elem.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),endCFI="epubcfi("+p.cfi.partialEndCfi+")",infoEnd=EPUBcfi.getTextTerminusInfoWithPartialCFI(endCFI,elem.ownerDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),range=rangy.createRange(elem.ownerDocument);if(range.setStartAndEnd(infoStart.textNode[0],infoStart.textOffset,infoEnd.textNode[0],infoEnd.textOffset),range.isPointInRange(pos.node,pos.offset)){par=p;break}}}catch(e){console.error(e)}if(!par)return wasPaused&&mediaOverlayPlayer.toggleMediaOverlay(),!0}return el&&el!=elem&&"body"===el.nodeName.toLowerCase()&&par&&!par.getSmil().id?(mediaOverlayPlayer.touchInit(),!0):(mediaOverlayPlayer.playUserPar(par),!0)}var readaloud=$(elem).attr("ibooks:readaloud");if(readaloud||(readaloud=$(elem).attr("epub:readaloud")),readaloud){console.debug("MO readaloud attr: "+readaloud);var isPlaying=mediaOverlayPlayer.isPlaying();if("start"===readaloud&&!isPlaying||"stop"===readaloud&&isPlaying||"startstop"===readaloud)return mediaOverlayPlayer.toggleMediaOverlay(),!0}return mediaOverlayPlayer.touchInit(),!0})}}var smil=mediaOverlay.getSmilBySpineItem(spineItem);if(!smil)return void console.error("NO SMIL?? "+spineItem.idref+" /// "+spineItem.media_overlay_id);var traverseSmilSeqs=function(root){if(root){if(root.nodeType&&"seq"===root.nodeType&&root.textref){var parts=root.textref.split("#"),file=parts[0],fragmentId=2===parts.length?parts[1]:"";if(file&&fragmentId){var textRelativeRef=ReadiumSDK.Helpers.ResolveContentRef(file,smil.href),same=textRelativeRef===spineItem.href;same&&(root.element=$iframe[0].contentDocument.getElementById(fragmentId),root.element||console.error("seq.textref !element? "+root.textref))}}if(root.children&&root.children.length)for(var i=0;i<root.children.length;i++){var child=root.children[i];traverseSmilSeqs(child)}}};traverseSmilSeqs(smil);for(var iter=new ReadiumSDK.Models.SmilIterator(smil),fakeOpfRoot="/99!",epubCfiPrefix="epubcfi";iter.currentPar;){iter.currentPar.element=void 0,iter.currentPar.cfi=void 0;var textRelativeRef=ReadiumSDK.Helpers.ResolveContentRef(iter.currentPar.text.srcFile,iter.smil.href),same=textRelativeRef===spineItem.href;if(same){var selectBody=!iter.currentPar.text.srcFragmentId||0==iter.currentPar.text.srcFragmentId.length,selectId=0==iter.currentPar.text.srcFragmentId.indexOf(epubCfiPrefix)?void 0:iter.currentPar.text.srcFragmentId,$element=void 0,isCfiTextRange=!1;if(selectBody||selectId)$element=selectBody?$body:$($iframe[0].contentDocument.getElementById(selectId));else if(0===iter.currentPar.text.srcFragmentId.indexOf(epubCfiPrefix)){var partial=iter.currentPar.text.srcFragmentId.substr(epubCfiPrefix.length+1,iter.currentPar.text.srcFragmentId.length-epubCfiPrefix.length-2);0===partial.indexOf(fakeOpfRoot)&&(partial=partial.substr(fakeOpfRoot.length,partial.length-fakeOpfRoot.length));var parts=partial.split(",");if(parts&&3===parts.length)try{var partialStartCfi=parts[0]+parts[1],startCFI="epubcfi("+partialStartCfi+")",infoStart=EPUBcfi.getTextTerminusInfoWithPartialCFI(startCFI,$iframe[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),partialEndCfi=parts[0]+parts[2],endCFI="epubcfi("+partialEndCfi+")",cfiTextParent=(EPUBcfi.getTextTerminusInfoWithPartialCFI(endCFI,$iframe[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),infoStart.textNode[0].parentNode);iter.currentPar.cfi={smilTextSrcCfi:iter.currentPar.text.srcFragmentId,partialRangeCfi:partial,partialStartCfi:partialStartCfi,partialEndCfi:partialEndCfi,cfiTextParent:cfiTextParent},isCfiTextRange=!0,$element=$(cfiTextParent);var modata=$element.data("mediaOverlayData");if(modata){modata.par&&(console.error("[WARN] non-CFI MO DATA already exists!"),modata.par=void 0);var found=!1;if(modata.pars)for(var iPars=0;iPars<modata.pars.length;iPars++){var par=modata.pars[iPars];par===iter.currentPar&&(found=!0,console.error("[WARN] mediaOverlayData CFI PAR already registered!"))}else modata.pars=[];found||modata.pars.push(iter.currentPar)}else modata={pars:[iter.currentPar]},$element.data("mediaOverlayData",modata)}catch(error){console.error(error)}else try{var cfi="epubcfi("+partial+")";$element=EPUBcfi.getTargetElementWithPartialCFI(cfi,$iframe[0].contentDocument,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])}catch(error){console.error(error)}}else console.error("SMIL text@src CFI fragment identifier scheme not supported: "+iter.currentPar.text.srcFragmentId);if($element&&$element.length>0){if(!isCfiTextRange){iter.currentPar.element&&iter.currentPar.element!==$element[0]&&console.error("DIFFERENT ELEMENTS??! "+iter.currentPar.text.srcFragmentId+" /// "+iter.currentPar.element.id);var name=$element[0].nodeName?$element[0].nodeName.toLowerCase():void 0;("audio"===name||"video"===name)&&$element.attr("preload","auto"),iter.currentPar.element=$element[0];var modata=$element.data("mediaOverlayData");modata&&(console.error("[WARN] MO DATA already exists."),modata.par&&modata.par!==iter.currentPar&&console.error("DIFFERENT PARS??!")),$element.data("mediaOverlayData",{par:iter.currentPar})}}else console.error("!! CANNOT FIND ELEMENT: "+iter.currentPar.text.srcFragmentId+" == "+iter.currentPar.text.srcFile+" /// "+spineItem.href)}iter.next()}}}},define("mediaOvelayDataInjector",["readiumSDK","mediaOverlay","mediaOverlayPlayer","smilModel","spineItem","smilIterator","rangy"],function(global){return function(){var ret;return ret||global.mediaOvelayDataInjector}}(this)),ReadiumSDK.Views.InternalLinksSupport=function(reader){function splitCfi(fullCfi){var startIx=fullCfi.indexOf("("),bungIx=fullCfi.indexOf("!"),endIx=fullCfi.indexOf(")");return-1==bungIx?void 0:(-1==endIx&&(endIx=fullCfi.length),{spineItemCfi:fullCfi.substring(startIx+1,bungIx),elementCfi:fullCfi.substring(bungIx+1,endIx)})}function getAbsoluteUriRelativeToSpineItem(hrefUri,spineItem){var fullPath=reader.package().resolveRelativeUrl(spineItem.href),absUrl=hrefUri.absoluteTo(fullPath);return absUrl}function processDeepLink(hrefUri,spineItem){var absoluteOpfUri=getAbsoluteUriRelativeToSpineItem(hrefUri,spineItem);if(!absoluteOpfUri)return void console.error("Unable to resolve "+hrefUri.href());var fullCfi=hrefUri.fragment(),absPath=absoluteOpfUri.toString();absPath=ReadiumSDK.Helpers.RemoveFromString(absPath,"#"+fullCfi),readOpfFile(absPath,function(opfText){if(opfText){var parser=new window.DOMParser,packageDom=parser.parseFromString(opfText,"text/xml"),cfi=splitCfi(fullCfi);if(!cfi)return void console.warn("Unable to split cfi:"+fullCfi);var contentDocRef=EPUBcfi.Interpreter.getContentDocHref("epubcfi("+cfi.spineItemCfi+")",packageDom);if(contentDocRef){var newSpineItem=reader.spine().getItemByHref(contentDocRef);newSpineItem?reader.openSpineItemElementCfi(newSpineItem.idref,cfi.elementCfi,self):console.warn("Unable to find spineItem with href="+contentDocRef)}else console.warn("Unable to find document ref from "+fullCfi+" cfi")}})}function readOpfFile(path,callback){$.ajax({isLocal:0===path.indexOf("http")?!1:!0,url:path,dataType:"text",async:!0,success:function(result){callback(result)},error:function(xhr,status,errorThrown){console.error("Error when AJAX fetching "+path),console.error(status),console.error(errorThrown),callback()}})}function isDeepLikHref(uri){var fileName=uri.filename();return fileName&&ReadiumSDK.Helpers.EndsWith(fileName,".opf")}function processLinkWithHash(hrefUri,spineItem){var idref,fileName=hrefUri.filename();if(fileName){var normalizedUri=new URI(hrefUri,spineItem.href),pathname=decodeURIComponent(normalizedUri.pathname()),newSpineItem=reader.spine().getItemByHref(pathname);if(!newSpineItem)return void console.error("spine item with href="+pathname+" not found");idref=newSpineItem.idref}else idref=spineItem.idref;var hashFrag=hrefUri.fragment();reader.openSpineItemElementId(idref,hashFrag,self)}var self=this;this.processLinkElements=function($iframe,spineItem){var epubContentDocument=$iframe[0].contentDocument;$("a",epubContentDocument).click(function(clickEvent){var href;href=clickEvent.currentTarget.attributes["xlink:href"]?clickEvent.currentTarget.attributes["xlink:href"].value:clickEvent.currentTarget.attributes.href.value;var overrideClickEvent=!1,hrefUri=new URI(href),hrefIsRelative=hrefUri.is("relative");hrefIsRelative?isDeepLikHref(hrefUri)?(processDeepLink(hrefUri,spineItem),overrideClickEvent=!0):(processLinkWithHash(hrefUri,spineItem),overrideClickEvent=!0):(window.open(href,"_blank"),overrideClickEvent=!0),overrideClickEvent&&(clickEvent.preventDefault(),clickEvent.stopPropagation())})}},define("internalLinksSupport",["readiumSDK","URIjs"],function(global){return function(){var ret;return ret||global.internalLinksSupport}}(this)),ReadiumSDK.Views.IFrameLoader=function(){var self=this,eventListeners={};this.addIFrameEventListener=function(eventName,callback,context){void 0==eventListeners[eventName]&&(eventListeners[eventName]=[]),eventListeners[eventName].push({callback:callback,context:context})},this.updateIframeEvents=function(iframe){_.each(eventListeners,function(value,key){for(var i=0,count=value.length;count>i;i++)$(iframe.contentWindow).off(key),$(iframe.contentWindow).on(key,value[i].callback,value[i].context)})},this.loadIframe=function(iframe,src,callback,context,attachedData){iframe.setAttribute("data-baseUri",iframe.baseURI),iframe.setAttribute("data-src",src);var loadedDocumentUri=new URI(src).absoluteTo(iframe.baseURI).toString();self._loadIframeWithUri(iframe,attachedData,loadedDocumentUri,function(){var doc=iframe.contentDocument||iframe.contentWindow.document;$("svg",doc).load(function(){console.log("loaded")}),callback.call(context,!0,attachedData)})},this._loadIframeWithUri=function(iframe,attachedData,contentUri,callback){iframe.onload=function(){self.updateIframeEvents(iframe);var mathJax=iframe.contentWindow.MathJax;if(mathJax){var mathJaxCallback=_.once(callback);mathJax.Hub.Queue(mathJaxCallback)}else callback()},iframe.setAttribute("src",contentUri)}},define("iframeLoader",["readiumSDK"],function(global){return function(){var ret;return ret||global.iframeLoader}}(this));var EpubAnnotationsModule=function(contentDocumentDOM,bbPageSetView,annotationCSSUrl){var EpubAnnotations={};EpubAnnotations.TextLineInferrer=Backbone.Model.extend({initialize:function(){},inferLines:function(rectList){for(var currLine,currRect,rectAppended,inferredLines=[],numRects=rectList.length,numLines=0,currRectNum=0;numRects-1>=currRectNum;currRectNum++){currRect=rectList[currRectNum],rectAppended=!1;for(var currLineNum=0;numLines-1>=currLineNum;currLineNum++)if(currLine=inferredLines[currLineNum],this.includeRectInLine(currLine,currRect.top,currRect.left,currRect.width,currRect.height)){this.expandLine(currLine,currRect.left,currRect.top,currRect.width,currRect.height),rectAppended=!0;break}rectAppended||(inferredLines.push(this.createNewLine(currRect.left,currRect.top,currRect.width,currRect.height)),numLines+=1)}return inferredLines},includeRectInLine:function(currLine,rectTop,rectLeft,rectWidth,rectHeight){return this.rectIsWithinLineVertically(rectTop,rectHeight,currLine.maxTop,currLine.maxBottom)&&this.rectIsWithinLineHorizontally(rectLeft,rectWidth,currLine.left,currLine.width,currLine.avgHeight)?!0:!1},rectIsWithinLineVertically:function(rectTop,rectHeight,currLineMaxTop,currLineMaxBottom){var rectBottom=rectTop+rectHeight,lineHeight=currLineMaxBottom-currLineMaxTop,lineHeightAdjustment=.75*lineHeight/2,rectHeightAdjustment=.75*rectHeight/2;return rectTop+=rectHeightAdjustment,rectBottom-=rectHeightAdjustment,currLineMaxTop+=lineHeightAdjustment,currLineMaxBottom-=lineHeightAdjustment,rectTop===currLineMaxTop&&rectBottom===currLineMaxBottom?!0:currLineMaxTop>rectTop&&currLineMaxBottom>rectBottom&&rectBottom>currLineMaxTop?!0:rectTop>currLineMaxTop&&rectBottom>currLineMaxBottom&&currLineMaxBottom>rectTop?!0:rectTop>currLineMaxTop&&currLineMaxBottom>rectBottom?!0:currLineMaxTop>rectTop&&rectBottom>currLineMaxBottom?!0:!1},rectIsWithinLineHorizontally:function(rectLeft,rectWidth,currLineLeft,currLineWidth,currLineAvgHeight){var lineGapHeuristic=2*currLineAvgHeight,rectRight=rectLeft+rectWidth,currLineRight=rectLeft+currLineWidth;return currLineLeft-rectRight>lineGapHeuristic?!1:rectLeft-currLineRight>lineGapHeuristic?!1:!0},createNewLine:function(rectLeft,rectTop,rectWidth,rectHeight){var maxBottom=rectTop+rectHeight;return{left:rectLeft,startTop:rectTop,width:rectWidth,avgHeight:rectHeight,maxTop:rectTop,maxBottom:maxBottom,numRects:1}},expandLine:function(currLine,rectLeft,rectTop,rectWidth,rectHeight){var rectRight=(currLine.left+currLine.width,rectLeft+rectWidth),rectBottom=rectTop+rectHeight,numRectsPlusOne=currLine.numRects+1,currSumHeights=currLine.avgHeight*currLine.numRects,avgHeight=(currSumHeights+rectHeight)/numRectsPlusOne;return currLine.avgHeight=avgHeight,currLine.numRects=numRectsPlusOne,currLine=this.expandLineVertically(currLine,rectTop,rectBottom),currLine=this.expandLineHorizontally(currLine,rectLeft,rectRight)},expandLineVertically:function(currLine,rectTop,rectBottom){return rectTop<currLine.maxTop&&(currLine.maxTop=rectTop),rectBottom>currLine.maxBottom&&(currLine.maxBottom=rectBottom),currLine},expandLineHorizontally:function(currLine,rectLeft,rectRight){var newLineLeft=currLine.left<=rectLeft?currLine.left:rectLeft,lineRight=currLine.left+currLine.width,newLineRight=lineRight>=rectRight?lineRight:rectRight,newLineWidth=newLineRight-newLineLeft;return currLine.left=newLineLeft,currLine.width=newLineWidth,currLine}}),EpubAnnotations.Highlight=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),EpubAnnotations.HighlightGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],highlightViews:[]}},initialize:function(attributes){this.set("scale",attributes.scale),this.constructHighlightViews()},highlightGroupCallback:function(event){var that=this;return"click"===event.type?void that.get("bbPageSetView").trigger("annotationClicked","highlight",that.get("CFI"),that.get("id"),event):"contextmenu"===event.type?void that.get("bbPageSetView").trigger("annotationRightClicked","highlight",that.get("CFI"),that.get("id"),event):void _.each(this.get("highlightViews"),function(highlightView){"mouseenter"===event.type?highlightView.setHoverHighlight():"mouseleave"===event.type&&highlightView.setBaseHighlight()})},constructHighlightViews:function(){var inferrer,inferredLines,that=this,rectList=[];_.each(this.get("selectedNodes"),function(node){var rects,range=document.createRange();range.selectNodeContents(node),rects=range.getClientRects(),_.each(rects,function(rect){rectList.push(rect)})}),inferrer=new EpubAnnotations.TextLineInferrer,inferredLines=inferrer.inferLines(rectList);var scale=this.get("scale");_.each(inferredLines,function(line){var highlightTop=line.startTop/scale,highlightLeft=line.left/scale,highlightHeight=line.avgHeight/scale,highlightWidth=line.width/scale,highlightView=new EpubAnnotations.HighlightView({CFI:that.get("CFI"),top:highlightTop+that.get("offsetTopAddition"),left:highlightLeft+that.get("offsetLeftAddition"),height:highlightHeight,width:highlightWidth,styles:that.get("styles"),highlightGroupCallback:that.highlightGroupCallback,callbackContext:that});that.get("highlightViews").push(highlightView)})},resetHighlights:function(viewportElement,offsetTop,offsetLeft){offsetTop&&this.set({offsetTopAddition:offsetTop}),offsetLeft&&this.set({offsetLeftAddition:offsetLeft}),this.destroyCurrentHighlights(),this.constructHighlightViews(),this.renderHighlights(viewportElement)},destroyCurrentHighlights:function(){_.each(this.get("highlightViews"),function(highlightView){highlightView.remove(),highlightView.off()}),this.get("highlightViews").length=0},renderHighlights:function(viewportElement){_.each(this.get("highlightViews"),function(view){$(viewportElement).append(view.render())})},toInfo:function(){return{id:this.get("id"),type:"highlight",CFI:this.get("CFI")}},setStyles:function(styles){var highlightViews=this.get("highlightViews");this.set({styles:styles}),_.each(highlightViews,function(view){view.setStyles(styles)})}}),EpubAnnotations.Underline=Backbone.Model.extend({defaults:{isVisible:!1},initialize:function(){}}),EpubAnnotations.UnderlineGroup=Backbone.Model.extend({defaults:function(){return{selectedNodes:[],underlineViews:[]}},initialize:function(){this.constructUnderlineViews()},underlineGroupCallback:function(event){var that=this;return"click"===event.type?void that.get("bbPageSetView").trigger("annotationClicked","underline",that.get("CFI"),that.get("id"),event):void _.each(this.get("underlineViews"),function(underlineView){"mouseenter"===event.type?underlineView.setHoverUnderline():"mouseleave"===event.type&&underlineView.setBaseUnderline()})},constructUnderlineViews:function(){var inferrer,inferredLines,that=this,rectList=[];_.each(this.get("selectedNodes"),function(node){var rects,range=document.createRange();range.selectNodeContents(node),rects=range.getClientRects(),_.each(rects,function(rect){rectList.push(rect)})}),inferrer=new EpubAnnotations.TextLineInferrer,inferredLines=inferrer.inferLines(rectList),_.each(inferredLines,function(line){var underlineTop=line.startTop,underlineLeft=line.left,underlineHeight=line.avgHeight,underlineWidth=line.width,underlineView=new EpubAnnotations.UnderlineView({CFI:that.get("CFI"),top:underlineTop+that.get("offsetTopAddition"),left:underlineLeft+that.get("offsetLeftAddition"),height:underlineHeight,width:underlineWidth,styles:that.get("styles"),underlineGroupCallback:that.underlineGroupCallback,callbackContext:that});that.get("underlineViews").push(underlineView)})},resetUnderlines:function(viewportElement,offsetTop,offsetLeft){offsetTop&&this.set({offsetTopAddition:offsetTop}),offsetLeft&&this.set({offsetLeftAddition:offsetLeft}),this.destroyCurrentUnderlines(),this.constructUnderlineViews(),this.renderUnderlines(viewportElement)},destroyCurrentUnderlines:function(){_.each(this.get("underlineViews"),function(underlineView){underlineView.remove(),underlineView.off()}),this.get("underlineViews").length=0},renderUnderlines:function(viewportElement){_.each(this.get("underlineViews"),function(view){$(viewportElement).append(view.render())})},toInfo:function(){return{id:this.get("id"),type:"underline",CFI:this.get("CFI")}},setStyles:function(styles){var underlineViews=this.get("underlineViews");this.set({styles:styles}),_.each(underlineViews,function(view){view.setStyles(styles)})}}),EpubAnnotations.Bookmark=Backbone.Model.extend({defaults:{isVisible:!1,bookmarkCenteringAdjustment:15,bookmarkTopAdjustment:45},initialize:function(){},getAbsoluteTop:function(){var targetElementTop=$(this.get("targetElement")).offset().top,bookmarkAbsoluteTop=this.get("offsetTopAddition")+targetElementTop-this.get("bookmarkTopAdjustment");return bookmarkAbsoluteTop},getAbsoluteLeft:function(){var targetElementLeft=$(this.get("targetElement")).offset().left,bookmarkAbsoluteLeft=this.get("offsetLeftAddition")+targetElementLeft-this.get("bookmarkCenteringAdjustment");return bookmarkAbsoluteLeft},toInfo:function(){return{id:this.get("id"),type:"bookmark",CFI:this.get("CFI")}}}),EpubAnnotations.ReflowableAnnotations=Backbone.Model.extend({initialize:function(){this.epubCFI=EPUBcfi,this.annotations=new EpubAnnotations.Annotations({offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:$("html",this.get("contentDocumentDOM"))[0],scale:0,bbPageSetView:this.get("bbPageSetView")});var annotationCSSUrl=this.get("annotationCSSUrl");annotationCSSUrl&&this.injectAnnotationCSS(annotationCSSUrl);var epubWindow=$(this.get("contentDocumentDOM")),self=this;epubWindow.on("mouseup",function(event){var range=self.getCurrentSelectionRange();void 0!==range&&range.startOffset-range.endOffset&&self.annotations.get("bbPageSetView").trigger("textSelectionEvent",event)})},redraw:function(){var leftAddition=-this.getPaginationLeftOffset();this.annotations.redrawAnnotations(0,leftAddition)},removeHighlight:function(annotationId){return this.annotations.removeHighlight(annotationId)},addHighlight:function(CFI,id,type,styles){var CFIRangeInfo,range,rangeStartNode,rangeEndNode,leftAddition,startMarkerHtml=this.getRangeStartMarker(CFI,id),endMarkerHtml=this.getRangeEndMarker(CFI,id),$html=$(this.get("contentDocumentDOM")),matrix=$("html",$html).css("-webkit-transform"),scale=new WebKitCSSMatrix(matrix).a;this.set("scale",scale);try{return CFIRangeInfo=this.epubCFI.injectRangeElements(CFI,this.get("contentDocumentDOM"),startMarkerHtml,endMarkerHtml,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),rangeStartNode=CFIRangeInfo.startElement.nextSibling?CFIRangeInfo.startElement.nextSibling:CFIRangeInfo.startElement,rangeEndNode=CFIRangeInfo.endElement.previousSibling?CFIRangeInfo.endElement.previousSibling:CFIRangeInfo.endElement,range=document.createRange(),range.setStart(rangeStartNode,0),range.setEnd(rangeEndNode,rangeEndNode.length),selectionInfo=this.getSelectionInfo(range),leftAddition=-this.getPaginationLeftOffset(),"highlight"===type?(this.annotations.set("scale",this.get("scale")),this.annotations.addHighlight(CFI,selectionInfo.selectedElements,id,0,leftAddition,CFIRangeInfo.startElement,CFIRangeInfo.endElement,styles)):"underline"===type&&this.annotations.addUnderline(CFI,selectionInfo.selectedElements,id,0,leftAddition,styles),{CFI:CFI,selectedElements:selectionInfo.selectedElements}}catch(error){console.log(error.message)}},addBookmark:function(CFI,id,type){var $injectedElement,leftAddition,bookmarkMarkerHtml=this.getBookmarkMarker(CFI,id);try{return $injectedElement=this.epubCFI.injectElement(CFI,this.get("contentDocumentDOM"),bookmarkMarkerHtml,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),leftAddition=-this.getPaginationLeftOffset(),this.annotations.addBookmark(CFI,$injectedElement[0],id,0,leftAddition,type),{CFI:CFI,selectedElements:$injectedElement[0]}}catch(error){console.log(error.message)}},addImageAnnotation:function(CFI,id){{var $targetImage;this.getBookmarkMarker(CFI,id)}try{return $targetImage=this.epubCFI.getTargetElement(CFI,this.get("contentDocumentDOM"),["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),this.annotations.addImageAnnotation(CFI,$targetImage[0],id),{CFI:CFI,selectedElements:$targetImage[0]}}catch(error){console.log(error.message)}},getCurrentSelectionCFI:function(){var CFI,currentSelection=this.getCurrentSelectionRange();return currentSelection&&(selectionInfo=this.getSelectionInfo(currentSelection),CFI=selectionInfo.CFI),CFI},getCurrentSelectionOffsetCFI:function(){var CFI,currentSelection=this.getCurrentSelectionRange();return currentSelection&&(CFI=this.generateCharOffsetCFI(currentSelection)),CFI},addSelectionHighlight:function(id,type,styles){var generatedContentDocCFI,CFI,selectionInfo,annotationInfo,arbitraryPackageDocCFI="/99!",currentSelection=this.getCurrentSelectionRange();if(currentSelection)return selectionInfo=this.getSelectionInfo(currentSelection),generatedContentDocCFI=selectionInfo.CFI,CFI="epubcfi("+arbitraryPackageDocCFI+generatedContentDocCFI+")","highlight"===type?annotationInfo=this.addHighlight(CFI,id,type,styles):"underline"===type&&(annotationInfo=this.addHighlight(CFI,id,type,styles)),annotationInfo.CFI=generatedContentDocCFI,annotationInfo;throw new Error("Nothing selected")},addSelectionBookmark:function(id,type){var generatedContentDocCFI,CFI,annotationInfo,arbitraryPackageDocCFI="/99!",currentSelection=this.getCurrentSelectionRange();if(currentSelection)return generatedContentDocCFI=this.generateCharOffsetCFI(currentSelection),CFI="epubcfi("+arbitraryPackageDocCFI+generatedContentDocCFI+")",annotationInfo=this.addBookmark(CFI,id,type),annotationInfo.CFI=generatedContentDocCFI,annotationInfo;throw new Error("Nothing selected")},addSelectionImageAnnotation:function(id){var generatedContentDocCFI,CFI,selectionInfo,annotationInfo,firstSelectedImage,arbitraryPackageDocCFI="/99!",currentSelection=this.getCurrentSelectionRange();if(currentSelection)return selectionInfo=this.getSelectionInfo(currentSelection,["img"]),firstSelectedImage=selectionInfo.selectedElements[0],generatedContentDocCFI=this.epubCFI.generateElementCFIComponent(firstSelectedImage,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]),CFI="epubcfi("+arbitraryPackageDocCFI+generatedContentDocCFI+")",annotationInfo=this.addImageAnnotation(CFI,id),annotationInfo.CFI=generatedContentDocCFI,annotationInfo;throw new Error("Nothing selected")},updateAnnotationView:function(id,styles){var annotationViews=this.annotations.updateAnnotationView(id,styles);return annotationViews},getSelectionInfo:function(selectedRange,elementType){var CFI=this.generateRangeCFI(selectedRange),intervalState={startElementFound:!1,endElementFound:!1},selectedElements=[];if(!elementType)var elementType=["text"];return this.findSelectedElements(selectedRange.commonAncestorContainer,selectedRange.startContainer,selectedRange.endContainer,intervalState,selectedElements,elementType),{CFI:CFI,selectedElements:selectedElements}},generateRangeCFI:function(selectedRange){var startOffset,endOffset,rangeCFIComponent,startNode=selectedRange.startContainer,endNode=selectedRange.endContainer;if(startNode.nodeType===Node.TEXT_NODE&&endNode.nodeType===Node.TEXT_NODE)return startOffset=selectedRange.startOffset,endOffset=selectedRange.endOffset,rangeCFIComponent=this.epubCFI.generateCharOffsetRangeComponent(startNode,startOffset,endNode,endOffset,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"]);throw new Error("Selection start and end must be text nodes")},generateCharOffsetCFI:function(selectedRange){var charOffsetCFI,startNode=selectedRange.startContainer,startOffset=selectedRange.startOffset;return startNode.nodeType===Node.TEXT_NODE&&(charOffsetCFI=this.epubCFI.generateCharacterOffsetCFIComponent(startNode,startOffset,["cfi-marker","mo-cfi-highlight"],[],["MathJax_Message"])),charOffsetCFI},findSelectedElements:function(currElement,startElement,endElement,intervalState,selectedElements,elementTypes){return currElement===startElement&&(intervalState.startElementFound=!0),intervalState.startElementFound===!0&&this.addElement(currElement,selectedElements,elementTypes),currElement===endElement?void(intervalState.endElementFound=!0):void(currElement.firstChild&&(this.findSelectedElements(currElement.firstChild,startElement,endElement,intervalState,selectedElements,elementTypes),intervalState.endElementFound)||currElement.nextSibling&&(this.findSelectedElements(currElement.nextSibling,startElement,endElement,intervalState,selectedElements,elementTypes),intervalState.endElementFound))},addElement:function(currElement,selectedElements,elementTypes){_.each(elementTypes,function(elementType){"text"===elementType?currElement.nodeType===Node.TEXT_NODE&&selectedElements.push(currElement):$(currElement).is(elementType)&&selectedElements.push(currElement)})},getCurrentSelectionRange:function(){var currentSelection,iframeDocument=this.get("contentDocumentDOM");return iframeDocument.getSelection?(currentSelection=iframeDocument.getSelection(),currentSelection&&currentSelection.rangeCount&&currentSelection.anchorOffset!==currentSelection.focusOffset?currentSelection.getRangeAt(0):void 0):iframeDocument.selection?iframeDocument.selection.createRange():void 0},getPaginationLeftOffset:function(){var $htmlElement=$("html",this.get("contentDocumentDOM")),offsetLeftPixels=$htmlElement.css("left"),offsetLeft=parseInt(offsetLeftPixels.replace("px",""));return offsetLeft},getBookmarkMarker:function(CFI,id){return"<span class='bookmark-marker cfi-marker' id='"+id+"' data-cfi='"+CFI+"'></span>"},getRangeStartMarker:function(CFI,id){return"<span class='range-start-marker cfi-marker' id='start-"+id+"' data-cfi='"+CFI+"'></span>"},getRangeEndMarker:function(CFI,id){return"<span class='range-end-marker cfi-marker' id='end-"+id+"' data-cfi='"+CFI+"'></span>"},injectAnnotationCSS:function(annotationCSSUrl){var $contentDocHead=$("head",this.get("contentDocumentDOM"));$contentDocHead.append($("<link/>",{rel:"stylesheet",href:annotationCSSUrl,type:"text/css"}))}}),EpubAnnotations.Annotations=Backbone.Model.extend({defaults:function(){return{bookmarkViews:[],highlights:[],markers:{},underlines:[],imageAnnotations:[],annotationHash:{},offsetTopAddition:0,offsetLeftAddition:0,readerBoundElement:void 0}},initialize:function(){},remove:function(){_.each(this.get("highlights"),function(highlightGroup){highlightGroup.remove()})},redrawAnnotations:function(offsetTop,offsetLeft){var that=this;_.each(this.get("highlights"),function(highlightGroup){highlightGroup.resetHighlights(that.get("readerBoundElement"),offsetTop,offsetLeft)}),_.each(this.get("bookmarkViews"),function(bookmarkView){bookmarkView.resetBookmark(offsetTop,offsetLeft)}),_.each(this.get("underlines"),function(underlineGroup){underlineGroup.resetUnderlines(that.get("readerBoundElement"),offsetTop,offsetLeft)})},getBookmark:function(id){var bookmarkView=this.get("annotationHash")[id];return bookmarkView?bookmarkView.bookmark.toInfo():void 0},getHighlight:function(id){var highlight=this.get("annotationHash")[id];return highlight?highlight.toInfo():void 0},getUnderline:function(id){var underline=this.get("annotationHash")[id];return underline?underline.toInfo():void 0},getBookmarks:function(){var bookmarks=[];return _.each(this.get("bookmarkViews"),function(bookmarkView){bookmarks.push(bookmarkView.bookmark.toInfo())}),bookmarks},getHighlights:function(){var highlights=[];return _.each(this.get("highlights"),function(highlight){highlights.push(highlight.toInfo())}),highlights},getUnderlines:function(){var underlines=[];return _.each(this.get("underlines"),function(underline){underlines.push(underline.toInfo())}),underlines},getImageAnnotations:function(){var imageAnnotations=[];return _.each(this.get("imageAnnotations"),function(imageAnnotation){imageAnnotations.push(imageAnnotation.toInfo())
}),imageAnnotations},addBookmark:function(CFI,targetElement,annotationId,offsetTop,offsetLeft,type){offsetTop||(offsetTop=this.get("offsetTopAddition")),offsetLeft||(offsetLeft=this.get("offsetLeftAddition")),annotationId=annotationId.toString(),this.validateAnnotationId(annotationId);var bookmarkView=new EpubAnnotations.BookmarkView({CFI:CFI,targetElement:targetElement,offsetTopAddition:offsetTop,offsetLeftAddition:offsetLeft,id:annotationId.toString(),bbPageSetView:this.get("bbPageSetView"),type:type});this.get("annotationHash")[annotationId]=bookmarkView,this.get("bookmarkViews").push(bookmarkView),$(this.get("readerBoundElement")).append(bookmarkView.render())},removeHighlight:function(annotationId){var annotationHash=this.get("annotationHash"),highlights=this.get("highlights"),markers=this.get("markers");if(markers[annotationId]){var startMarker=markers[annotationId].startMarker,endMarker=markers[annotationId].endMarker;startMarker.parentNode.removeChild(startMarker),endMarker.parentNode.removeChild(endMarker),delete markers[annotationId],delete annotationHash[annotationId],highlights=_.reject(highlights,function(obj){return obj.id==annotationId?(obj.destroyCurrentHighlights(),!0):!1}),this.set("highlights",highlights)}},addHighlight:function(CFI,highlightedTextNodes,annotationId,offsetTop,offsetLeft,startMarker,endMarker,styles){offsetTop||(offsetTop=this.get("offsetTopAddition")),offsetLeft||(offsetLeft=this.get("offsetLeftAddition")),annotationId=annotationId.toString(),this.validateAnnotationId(annotationId);var highlightGroup=new EpubAnnotations.HighlightGroup({CFI:CFI,selectedNodes:highlightedTextNodes,offsetTopAddition:offsetTop,offsetLeftAddition:offsetLeft,styles:styles,id:annotationId,bbPageSetView:this.get("bbPageSetView"),scale:this.get("scale")});this.get("annotationHash")[annotationId]=highlightGroup,this.get("highlights").push(highlightGroup),this.get("markers")[annotationId]={startMarker:startMarker,endMarker:endMarker},highlightGroup.renderHighlights(this.get("readerBoundElement"))},addUnderline:function(CFI,underlinedTextNodes,annotationId,offsetTop,offsetLeft,styles){offsetTop||(offsetTop=this.get("offsetTopAddition")),offsetLeft||(offsetLeft=this.get("offsetLeftAddition")),annotationId=annotationId.toString(),this.validateAnnotationId(annotationId);var underlineGroup=new EpubAnnotations.UnderlineGroup({CFI:CFI,selectedNodes:underlinedTextNodes,offsetTopAddition:offsetTop,offsetLeftAddition:offsetLeft,styles:styles,id:annotationId,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[annotationId]=underlineGroup,this.get("underlines").push(underlineGroup),underlineGroup.renderUnderlines(this.get("readerBoundElement"))},addImageAnnotation:function(CFI,imageNode,annotationId){annotationId=annotationId.toString(),this.validateAnnotationId(annotationId);var imageAnnotation=new EpubAnnotations.ImageAnnotation({CFI:CFI,imageNode:imageNode,id:annotationId,bbPageSetView:this.get("bbPageSetView")});this.get("annotationHash")[annotationId]=imageAnnotation,this.get("imageAnnotations").push(imageAnnotation),imageAnnotation.render()},updateAnnotationView:function(id,styles){var annotationViews=this.get("annotationHash")[id];return annotationViews.setStyles(styles),annotationViews},validateAnnotationId:function(id){if(this.get("annotationHash")[id])throw new Error("That annotation id already exists; annotation not added")}}),EpubAnnotations.BookmarkView=Backbone.View.extend({el:"<div></div>",events:{mouseenter:"setHoverBookmark",mouseleave:"setBaseBookmark",click:"clickHandler"},initialize:function(options){this.bookmark=new EpubAnnotations.Bookmark({CFI:options.CFI,targetElement:options.targetElement,offsetTopAddition:options.offsetTopAddition,offsetLeftAddition:options.offsetLeftAddition,id:options.id,bbPageSetView:options.bbPageSetView,type:options.type})},resetBookmark:function(offsetTop,offsetLeft){offsetTop&&this.bookmark.set({offsetTopAddition:offsetTop}),offsetLeft&&this.bookmark.set({offsetLeftAddition:offsetLeft}),this.setCSS()},render:function(){return this.setCSS(),this.el},setCSS:function(){var absoluteTop,absoluteLeft;"comment"===this.bookmark.get("type")?(absoluteTop=this.bookmark.getAbsoluteTop(),absoluteLeft=this.bookmark.getAbsoluteLeft(),this.$el.css({top:absoluteTop+"px",left:absoluteLeft+"px",width:"50px",height:"50px",position:"absolute"}),this.$el.addClass("comment")):this.$el.addClass("bookmark")},setHoverBookmark:function(event){event.stopPropagation(),this.$el.hasClass("comment")&&(this.$el.removeClass("comment"),this.$el.addClass("hover-comment"))},setBaseBookmark:function(event){event.stopPropagation(),this.$el.hasClass("hover-comment")&&(this.$el.removeClass("hover-comment"),this.$el.addClass("comment"))},clickHandler:function(event){event.stopPropagation();var type;type="comment"===this.bookmark.get("type")?"comment":"bookmark",this.bookmark.get("bbPageSetView").trigger("annotationClicked",type,this.bookmark.get("CFI"),this.bookmark.get("id"),this.$el.css("top"),this.$el.css("left"),event)}}),EpubAnnotations.HighlightView=Backbone.View.extend({el:"<div class='highlight'></div>",events:{mouseenter:"highlightEvent",mouseleave:"highlightEvent",click:"highlightEvent",contextmenu:"highlightEvent"},initialize:function(options){this.highlight=new EpubAnnotations.Highlight({CFI:options.CFI,top:options.top,left:options.left,height:options.height,width:options.width,styles:options.styles,highlightGroupCallback:options.highlightGroupCallback,callbackContext:options.callbackContext})},render:function(){return this.setCSS(),this.el},resetPosition:function(top,left,height,width){this.highlight.set({top:top,left:left,height:height,width:width}),this.setCSS()},setStyles:function(styles){this.highlight.set({styles:styles}),this.render()},setCSS:function(){var styles=this.highlight.get("styles")||{};this.$el.css({top:this.highlight.get("top")+"px",left:this.highlight.get("left")+"px",height:this.highlight.get("height")+"px",width:this.highlight.get("width")+"px","background-color":styles.fill_color||"normal"})},setBaseHighlight:function(){this.$el.addClass("highlight"),this.$el.removeClass("hover-highlight")},setHoverHighlight:function(){this.$el.addClass("hover-highlight"),this.$el.removeClass("highlight")},highlightEvent:function(event){event.stopPropagation();var highlightGroupContext=(this.highlight.get("highlightGroupCallback"),this.highlight.get("callbackContext"));highlightGroupContext.highlightGroupCallback(event)}}),EpubAnnotations.UnderlineView=Backbone.View.extend({el:"<div class='underline-range'>              <div class='transparent-part'></div>              <div class='underline-part'></div>           </div>",events:{mouseenter:"underlineEvent",mouseleave:"underlineEvent",click:"underlineEvent"},initialize:function(options){this.underline=new EpubAnnotations.Underline({CFI:options.CFI,top:options.top,left:options.left,height:options.height,width:options.width,styles:options.styles,underlineGroupCallback:options.underlineGroupCallback,callbackContext:options.callbackContext}),this.$transparentElement=$(".transparent-part",this.$el),this.$underlineElement=$(".underline-part",this.$el)},render:function(){return this.setCSS(),this.el},resetPosition:function(top,left,height,width){this.underline.set({top:top,left:left,height:height,width:width}),this.setCSS()},setStyles:function(styles){this.underline.set({styles:styles}),this.render()},setCSS:function(){var styles=this.underline.get("styles")||{};this.$el.css({top:this.underline.get("top")+"px",left:this.underline.get("left")+"px",height:this.underline.get("height")+"px",width:this.underline.get("width")+"px"}),this.$underlineElement.css({"background-color":styles.fill_color||"normal"}),this.$underlineElement.addClass("underline")},underlineEvent:function(event){event.stopPropagation();var underlineGroupContext=(this.underline.get("underlineGroupCallback"),this.underline.get("callbackContext"));underlineGroupContext.underlineGroupCallback(event)},setBaseUnderline:function(){this.$underlineElement.addClass("underline"),this.$underlineElement.removeClass("hover-underline")},setHoverUnderline:function(){this.$underlineElement.addClass("hover-underline"),this.$underlineElement.removeClass("underline")}}),EpubAnnotations.ImageAnnotation=Backbone.Model.extend({initialize:function(){var that=this,$imageElement=$(this.get("imageNode"));$imageElement.on("mouseenter",function(){that.setMouseenterBorder()}),$imageElement.on("mouseleave",function(){that.setMouseleaveBorder()}),$imageElement.on("click",function(){that.get("bbPageSetView").trigger("annotationClicked","image",that.get("CFI"),that.get("id"),event)})},render:function(){this.setCSS()},setCSS:function(){$(this.get("imageNode")).css({border:"5px solid rgb(255, 0, 0)",border:"5px solid rgba(255, 0, 0, 0.2)","-webkit-background-clip":"padding-box","background-clip":"padding-box"})},setMouseenterBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.4)"})},setMouseleaveBorder:function(){$(this.get("imageNode")).css({border:"5px solid rgba(255, 0, 0, 0.2)"})}});var reflowableAnnotations=new EpubAnnotations.ReflowableAnnotations({contentDocumentDOM:contentDocumentDOM,bbPageSetView:bbPageSetView,annotationCSSUrl:annotationCSSUrl});return{addSelectionHighlight:function(id,type,styles){return reflowableAnnotations.addSelectionHighlight(id,type,styles)},addSelectionBookmark:function(id,type){return reflowableAnnotations.addSelectionBookmark(id,type)},addSelectionImageAnnotation:function(id){return reflowableAnnotations.addSelectionImageAnnotation(id)},addHighlight:function(CFI,id,type,styles){return reflowableAnnotations.addHighlight(CFI,id,type,styles)},addBookmark:function(CFI,id,type){return reflowableAnnotations.addBookmark(CFI,id,type)},addImageAnnotation:function(CFI,id){return reflowableAnnotations.addImageAnnotation(CFI,id)},updateAnnotationView:function(id,styles){return reflowableAnnotations.updateAnnotationView(id,styles)},redraw:function(){return reflowableAnnotations.redraw()},getBookmark:function(id){return reflowableAnnotations.annotations.getBookmark(id)},getBookmarks:function(){return reflowableAnnotations.annotations.getBookmarks()},getHighlight:function(id){return reflowableAnnotations.annotations.getHighlight(id)},getHighlights:function(){return reflowableAnnotations.annotations.getHighlights()},getUnderline:function(id){return reflowableAnnotations.annotations.getUnderline(id)},getUnderlines:function(){return reflowableAnnotations.annotations.getUnderlines()},getImageAnnotation:function(){},getImageAnnotations:function(){},removeAnnotation:function(annotationId){return reflowableAnnotations.remove(annotationId)},getCurrentSelectionCFI:function(){return reflowableAnnotations.getCurrentSelectionCFI()},getCurrentSelectionOffsetCFI:function(){return reflowableAnnotations.getCurrentSelectionOffsetCFI()},removeHighlight:function(annotationId){return reflowableAnnotations.removeHighlight(annotationId)}}};define("annotations_module",["epubCfi"],function(global){return function(){var ret;return ret||global.annotations_module}}(this)),ReadiumSDK.Views.AnnotationsManager=function(proxyObj,options){function getPartialCfi(CFI){var cfiWrapperPattern=new RegExp("^.*!"),partiallyNakedCfi=CFI.replace(cfiWrapperPattern,""),nakedCfi=partiallyNakedCfi.substring(0,partiallyNakedCfi.length-1);return nakedCfi}var self=this,liveAnnotations={},spines={},proxy=proxyObj,annotationCSSUrl=options.annotationCSSUrl;annotationCSSUrl||console.warn("WARNING! Annotations CSS not supplied. Highlighting is not going to work."),_.extend(self,Backbone.Events),this.on("all",function(){var args=Array.prototype.slice.call(arguments),annotationClickedEvent="annotationClicked";if(args.length&&args[0]===annotationClickedEvent)for(var spineIndex in liveAnnotations){var jQueryEvent=args[4],annotationId=args[3],fullFakeCfi=args[2],type=args[1];if(liveAnnotations[spineIndex].getHighlight(annotationId)){var idref=spines[spineIndex].idref,partialCfi=getPartialCfi(fullFakeCfi);args=[annotationClickedEvent,type,idref,partialCfi,annotationId,jQueryEvent]}}self.trigger.apply(proxy,args)}),this.attachAnnotations=function($iframe,spineItem){var epubDocument=$iframe[0].contentDocument;liveAnnotations[spineItem.index]=new EpubAnnotationsModule(epubDocument,self,annotationCSSUrl),spines[spineItem.index]=spineItem;for(var spineIndex in liveAnnotations)Math.abs(spineIndex-spineIndex.index)>3&&delete liveAnnotations[spineIndex]},this.getCurrentSelectionCfi=function(){for(var spine in liveAnnotations){var annotationsForView=liveAnnotations[spine],partialCfi=annotationsForView.getCurrentSelectionCFI();if(partialCfi)return{idref:spines[spine].idref,cfi:partialCfi}}return void 0},this.addSelectionHighlight=function(id,type){for(spine in liveAnnotations){var annotationsForView=liveAnnotations[spine];if(annotationsForView.getCurrentSelectionCFI()){var annotation=annotationsForView.addSelectionHighlight(id,type);return annotation.idref=spines[spine].idref,annotation}}return void 0},this.addHighlight=function(spineIdRef,partialCfi,id,type,styles){for(var spine in liveAnnotations)if(spines[spine].idref===spineIdRef){var fakeCfi="epubcfi(/99!"+partialCfi+")",annotationsForView=liveAnnotations[spine],annotation=annotationsForView.addHighlight(fakeCfi,id,type,styles);return annotation.idref=spineIdRef,annotation.CFI=getPartialCfi(annotation.CFI),annotation}return void 0},this.removeHighlight=function(id){var result=void 0;for(var spine in liveAnnotations){var annotationsForView=liveAnnotations[spine];result=annotationsForView.removeHighlight(id)}return result}},define("annotationsManager",["epubCfi","annotations_module"],function(global){return function(){var ret;return ret||global.annotationsManager}}(this)),ReadiumSDK.Models.Trigger=function(domNode){var $el=$(domNode);this.action=$el.attr("action"),this.ref=$el.attr("ref"),this.event=$el.attr("ev:event"),this.observer=$el.attr("ev:observer"),this.ref=$el.attr("ref")},ReadiumSDK.Models.Trigger.register=function(dom){$("trigger",dom).each(function(){var trigger=new ReadiumSDK.Models.Trigger(this);trigger.subscribe(dom)})},ReadiumSDK.Models.Trigger.prototype.subscribe=function(dom){var selector="#"+this.observer,that=this;$(selector,dom).on(this.event,function(){that.execute(dom)})},ReadiumSDK.Models.Trigger.prototype.execute=function(dom){var $target=$("#"+ReadiumSDK.Helpers.escapeJQuerySelector(this.ref),dom);switch(this.action){case"show":$target.css("visibility","visible");break;case"hide":$target.css("visibility","hidden");break;case"play":$target[0].currentTime=0,$target[0].play();break;case"pause":$target[0].pause();break;case"resume":$target[0].play();break;case"mute":$target[0].muted=!0;break;case"unmute":$target[0].muted=!1;break;default:console.log("do not no how to handle trigger "+this.action)}},define("triggers",["readiumSDK"],function(global){return function(){var ret;return ret||global.triggers}}(this)),ReadiumSDK.Views.ScrollView=function(options,isContinuousScroll,reader){function updateLoadedViewsTop(callback,assertScrollPosition){if(_stopTransientViewUpdate)return void callback();var viewPage=firstLoadedView();if(!viewPage)return void callback();var viewPortRange=getVisibleRange(0),firstViewRange=getPageViewRange(viewPage);if(viewPortRange.top-firstViewRange.bottom>ITEM_LOAD_SCROLL_BUFFER){var scrollPos=scrollTop();removePageView(viewPage),scrollTo(scrollPos-(firstViewRange.bottom-firstViewRange.top),void 0),assertScrollPosition("updateLoadedViewsTop 1"),updateLoadedViewsTop(callback,assertScrollPosition)}else viewPortRange.top-firstViewRange.top<ITEM_LOAD_SCROLL_BUFFER?addToTopOf(viewPage,function(isElementAdded){isElementAdded?(assertScrollPosition("updateLoadedViewsTop 2"),updateLoadedViewsTop(callback,assertScrollPosition)):callback()}):callback()}function updateLoadedViewsBottom(callback,assertScrollPosition){if(_stopTransientViewUpdate)return void callback();var viewPage=lastLoadedView();if(!viewPage)return void callback();var viewPortRange=getVisibleRange(0),lastViewRange=getPageViewRange(viewPage);lastViewRange.top-viewPortRange.bottom>ITEM_LOAD_SCROLL_BUFFER?(removePageView(viewPage),assertScrollPosition("updateLoadedViewsBottom 1"),updateLoadedViewsBottom(callback,assertScrollPosition)):lastViewRange.bottom-viewPortRange.bottom<ITEM_LOAD_SCROLL_BUFFER?addToBottomOf(viewPage,function(newPageLoaded){assertScrollPosition("updateLoadedViewsBottom 2"),newPageLoaded?updateLoadedViewsBottom(callback,assertScrollPosition):callback()}):callback()}function updateTransientViews(pageView){if(isContinuousScroll){var scrollPosBefore=void 0;if(_DEBUG&&pageView){var offset=pageView.offset();offset&&(scrollPosBefore=offset.top)}var assertScrollPosition=function(msg){if(_DEBUG){if(!scrollPosBefore)return;var scrollPosAfter=void 0,offset=pageView.offset();if(offset&&(scrollPosAfter=offset.top),!scrollPosAfter)return;var diff=scrollPosAfter-scrollPosBefore;Math.abs(diff)>1&&console.debug("@@@@@@@@@@@@@@@ SCROLL ADJUST ("+msg+") "+diff+" -- "+pageView.currentSpineItem().href)}};_isPerformingLayoutModifications=!0,updateLoadedViewsBottom(function(){updateLoadedViewsTop(function(){setTimeout(function(){_isPerformingLayoutModifications=!1},ON_SCROLL_TIME_DALAY+100)},assertScrollPosition)},assertScrollPosition)}}function onScrollDirect(){var settings=reader.viewerSettings();settings.mediaOverlaysPreservePlaybackWhenScroll||!_mediaOverlaysWasPlayingLastTimeScrollStarted&&reader.isMediaOverlayAvailable()&&(_mediaOverlaysWasPlayingLastTimeScrollStarted=reader.isPlayingMediaOverlay(),_mediaOverlaysWasPlayingLastTimeScrollStarted&&reader.pauseMediaOverlay())}function onScroll(){if(!_isPerformingLayoutModifications&&!_isSettingScrollPosition&&!_isLoadingNewSpineItemOnPageRequest){updateTransientViews(),onPaginationChanged(self);var settings=reader.viewerSettings();settings.mediaOverlaysPreservePlaybackWhenScroll||_mediaOverlaysWasPlayingLastTimeScrollStarted&&setTimeout(function(){reader.playMediaOverlay(),_mediaOverlaysWasPlayingLastTimeScrollStarted=!1},100)}}function scrollTo(offset,pageRequest){_$contentFrame[0].scrollTop=offset,pageRequest&&onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId)}function updatePageViewSizeAndAdjustScroll(pageView){var scrollPos=scrollTop(),rangeBeforeResize=getPageViewRange(pageView);updatePageViewSize(pageView);var rangeAfterResize=getPageViewRange(pageView),heightAfter=rangeAfterResize.bottom-rangeAfterResize.top,heightBefore=rangeBeforeResize.bottom-rangeBeforeResize.top,delta=heightAfter-heightBefore;Math.abs(delta)>0&&(_DEBUG&&console.debug("IMMEDIATE SCROLL ADJUST: "+pageView.currentSpineItem().href+" == "+delta),scrollTo(scrollPos+delta))}function reachStableContentHeight(updateScroll,pageView,iframe,href,fixedLayout,metaWidth,msg,callback){if(!ReadiumSDK.Helpers.isIframeAlive(iframe))return _DEBUG&&console.log("reachStableContentHeight ! win && doc (iFrame disposed?)"),void(callback&&callback(!1));var MAX_ATTEMPTS=10,TIME_MS=300,w=iframe.contentWindow,d=iframe.contentDocument,previousPolledContentHeight=parseInt(Math.round(parseFloat(w.getComputedStyle(d.documentElement).height))),initialContentHeight=previousPolledContentHeight;0===updateScroll?updatePageViewSizeAndAdjustScroll(pageView):updatePageViewSize(pageView);var tryAgainFunc=function(tryAgain){return _DEBUG&&tryAgain!==MAX_ATTEMPTS&&console.log("tryAgainFunc - "+tryAgain+": "+href+"  <"+initialContentHeight+" -- "+previousPolledContentHeight+">"),tryAgain--,0>tryAgain?(_DEBUG&&console.error("tryAgainFunc abort: "+href),void(callback&&callback(!0))):void setTimeout(function(){try{if(!ReadiumSDK.Helpers.isIframeAlive(iframe))return _DEBUG&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(callback&&callback(!1));var win=iframe.contentWindow,doc=iframe.contentDocument,iframeHeight=parseInt(Math.round(parseFloat(window.getComputedStyle(iframe).height))),docHeight=parseInt(Math.round(parseFloat(win.getComputedStyle(doc.documentElement).height)));if(previousPolledContentHeight!==docHeight)return previousPolledContentHeight=docHeight,void tryAgainFunc(tryAgain);var diff=iframeHeight-docHeight;if(Math.abs(diff)>4){if(_DEBUG&&(console.log("$$$ IFRAME HEIGHT ADJUST: "+href+"  ["+diff+"]<"+initialContentHeight+" -- "+previousPolledContentHeight+">"),console.log(msg)),0===updateScroll?updatePageViewSizeAndAdjustScroll(pageView):updatePageViewSize(pageView),!ReadiumSDK.Helpers.isIframeAlive(iframe))return _DEBUG&&console.log("tryAgainFunc ! win && doc (iFrame disposed?)"),void(callback&&callback(!1));var win=iframe.contentWindow,doc=iframe.contentDocument,docHeightAfter=parseInt(Math.round(parseFloat(win.getComputedStyle(doc.documentElement).height))),iframeHeightAfter=parseInt(Math.round(parseFloat(window.getComputedStyle(iframe).height))),newdiff=iframeHeightAfter-docHeightAfter;if(Math.abs(newdiff)>4)return _DEBUG&&(console.error("## IFRAME HEIGHT ADJUST: "+href+"  ["+newdiff+"]<"+initialContentHeight+" -- "+previousPolledContentHeight+">"),console.log(msg)),void tryAgainFunc(tryAgain);_DEBUG&&console.log(">> IFRAME HEIGHT ADJUSTED OKAY: "+href+"  ["+diff+"]<"+initialContentHeight+" -- "+previousPolledContentHeight+">")}}catch(ex){return console.error(ex),void(callback&&callback(!1))}callback&&callback(!0)},TIME_MS)};tryAgainFunc(MAX_ATTEMPTS)}function addToTopOf(topView,callback){var prevSpineItem=_spine.prevItem(topView.currentSpineItem(),!0);if(!prevSpineItem)return void callback(!1);var tmpView=createPageViewForSpineItem(!0),lastView=lastLoadedView();tmpView.element().insertAfter(lastView.element()),tmpView.loadSpineItem(prevSpineItem,function(success){if(success){updatePageViewSize(tmpView);var range=getPageViewRange(tmpView);removePageView(tmpView);var scrollPos=scrollTop(),newView=createPageViewForSpineItem(),originalHeight=range.bottom-range.top;newView.setHeight(originalHeight),newView.element().insertBefore(topView.element()),scrollPos+=originalHeight,scrollTo(scrollPos,void 0),newView.loadSpineItem(prevSpineItem,function(success,$iframe,spineItem,isNewlyLoaded,context){if(success){var continueCallback=function(successFlag){onPageViewLoaded(newView,success,$iframe,spineItem,isNewlyLoaded,context),callback(successFlag)};reachStableContentHeight(0,newView,$iframe[0],spineItem.href,spineItem.isFixedLayout(),spineItem.isFixedLayout()?newView.meta_width():0,"addToTopOf",continueCallback)}else console.error("Unable to open 2 "+prevSpineItem.href),removePageView(newView),callback(!1)})}else console.error("Unable to open 1 "+prevSpineItem.href),removePageView(tmpView),callback(!1)})}function updatePageViewSize(pageView){pageView.currentSpineItem().isFixedLayout()?pageView.scaleToWidth(_$contentFrame.width()):pageView.resizeIFrameToContent()}function addToBottomOf(bottomView,callback){var nexSpineItem=_spine.nextItem(bottomView.currentSpineItem(),!0);if(!nexSpineItem)return void callback(!1);var newView=(scrollTop(),createPageViewForSpineItem());newView.element().insertAfter(bottomView.element()),newView.loadSpineItem(nexSpineItem,function(success,$iframe,spineItem,isNewlyLoaded,context){if(success){var continueCallback=function(successFlag){onPageViewLoaded(newView,success,$iframe,spineItem,isNewlyLoaded,context),callback(successFlag)};reachStableContentHeight(2,newView,$iframe[0],spineItem.href,spineItem.isFixedLayout(),spineItem.isFixedLayout()?newView.meta_width():0,"addToBottomOf",continueCallback)}else console.error("Unable to load "+nexSpineItem.href),callback(!1)})}function removeLoadedItems(){var loadedPageViews=[];forEachItemView(function(pageView){loadedPageViews.push(pageView)},!1);for(var i=0,count=loadedPageViews.length;count>i;i++)removePageView(loadedPageViews[i])}function removePageView(pageView){pageView.element().remove()}function setFrameSizesToRectangle(rectangle){_$contentFrame.css("left",rectangle.left),_$contentFrame.css("top",rectangle.top),_$contentFrame.css("right",rectangle.right),_$contentFrame.css("bottom",rectangle.bottom)}function createPageViewForSpineItem(isTemporaryView){options.disablePageTransitions=!0;var pageView=new ReadiumSDK.Views.OnePageView(options,["content-doc-frame"],!0);return pageView.render(),_viewSettings&&pageView.setViewSettings(_viewSettings),isTemporaryView||pageView.element().data("pageView",pageView),isContinuousScroll&&pageView.decorateIframe(),pageView}function findPageViewForSpineItem(spineItem,reverse){var retView=void 0;return forEachItemView(function(pageView){return pageView.currentSpineItem()==spineItem?(retView=pageView,!1):!0},reverse),retView}function forEachItemView(func,reverse){for(var pageNodes=_$contentFrame.children(),count=pageNodes.length,iter=reverse?function(ix){return ix-1}:function(ix){return ix+1},compare=reverse?function(ix){return ix>=0}:function(ix){return count>ix},start=reverse?count-1:0,i=start;compare(i);i=iter(i)){var $element=pageNodes.eq(i),curView=$element.data("pageView");if(curView&&func(curView)===!1)return}}function firstLoadedView(){var firstView=void 0;return forEachItemView(function(pageView){return firstView=pageView,!1},!1),firstView}function lastLoadedView(){var lastView=void 0;return forEachItemView(function(pageView){return lastView=pageView,!1},!0),lastView}function onPageViewLoaded(pageView,success,$iframe,spineItem,isNewlyLoaded){success&&isNewlyLoaded&&self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,$iframe,spineItem)}function loadSpineItem(spineItem,callback){removeLoadedItems();var loadedView=(scrollTop(),createPageViewForSpineItem());_$contentFrame.append(loadedView.element()),loadedView.loadSpineItem(spineItem,function(success,$iframe,spineItem,isNewlyLoaded,context){if(success){var continueCallback=function(){onPageViewLoaded(loadedView,success,$iframe,spineItem,isNewlyLoaded,context),callback(loadedView)};reachStableContentHeight(1,loadedView,$iframe[0],spineItem.href,spineItem.isFixedLayout(),spineItem.isFixedLayout()?loadedView.meta_width():0,"openPage",continueCallback)}else console.error("Unable to load "+spineItem.href),removePageView(loadedView),loadedView=void 0;callback(loadedView)})}function openPageViewElement(pageView,pageRequest){var pageCount,$element,sfiNav,pageRange,topOffset=0;if(void 0!==pageRequest.scrollTop)topOffset=pageRequest.scrollTop;else if(void 0!==pageRequest.spineItemPageIndex){var pageIndex;pageCount=calculatePageCount(),pageIndex=pageRequest.spineItemPageIndex<0?0:pageRequest.spineItemPageIndex>=pageCount?pageCount-1:pageRequest.spineItemPageIndex,topOffset=pageIndex*viewHeight()}else if(pageView&&pageRequest.elementId){if(pageRange=getPageViewRange(pageView),sfiNav=pageView.getNavigator(),$element=sfiNav.getElementById(pageRequest.elementId),!$element||!$element.length)return void console.warn("Element id="+pageRequest.elementId+" not found!");if(isElementVisibleOnScreen(pageView,$element,60))return void onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId);topOffset=sfiNav.getVerticalOffsetForElement($element)+pageRange.top}else if(pageView&&pageRequest.elementCfi){if(pageRange=getPageViewRange(pageView),sfiNav=pageView.getNavigator(),$element=sfiNav.getElementByCfi(pageRequest.elementCfi),!$element||!$element.length)return void console.warn("Element cfi="+pageRequest.elementCfi+" not found!");if(isElementVisibleOnScreen(pageView,$element,60))return void onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId);topOffset=sfiNav.getVerticalOffsetForElement($element)+pageRange.top}else if(pageRequest.firstPage)topOffset=0;else if(pageRequest.lastPage){if(pageCount=calculatePageCount(),0===pageCount)return;topOffset=scrollHeight()-viewHeight()-5}else pageView?(pageRange=getPageViewRange(pageView),topOffset=pageRange.top):topOffset=0;scrollTop()!=topOffset?(_isSettingScrollPosition=!0,scrollTo(topOffset,pageRequest),setTimeout(function(){_isSettingScrollPosition=!1},ON_SCROLL_TIME_DALAY+100)):onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId)}function calculatePageCount(){return Math.ceil(scrollHeight()/viewHeight())}function onPaginationChanged(initiator,paginationRequest_spineItem,paginationRequest_elementId){self.trigger(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,{paginationInfo:self.getPaginationInfo(),initiator:initiator,spineItem:paginationRequest_spineItem,elementId:paginationRequest_elementId})}function scrollTop(){return _$contentFrame[0].scrollTop}function scrollBottom(){return scrollHeight()-(scrollTop()+viewHeight())}function viewHeight(){return _$contentFrame.height()}function scrollHeight(){return _$contentFrame[0].scrollHeight}function getVisiblePageViews(){var views=[],range=getVisibleRange(-SCROLL_MARGIN_TO_SHOW_LAST_VISBLE_LINE);return forEachItemView(function(pageView){if(isPageViewVisibleInRange(pageView,range))views.push(pageView);else if(views.length>0)return!1;return!0},!1),views}function getFirstVisiblePageView(){var visibleViews=getVisiblePageViews();return visibleViews[0]}function isPageViewVisibleInRange(pageView,range){var pageViewRange=getPageViewRange(pageView);return rangeLength(intersectRanges(pageViewRange,range))>0}function getPageViewRange(pageView){var range={top:0,bottom:0};return range.top=pageView.element().position().top+scrollTop(),range.bottom=range.top+pageView.getCalculatedPageHeight(),range}function getVisibleRange(expand){0===expand||expand||(expand=0);var range={top:scrollTop()-expand,bottom:scrollTop()+viewHeight()+expand};return range.top<0&&(range.top=0),range.bottom>scrollHeight()&&(range.bottom=scrollHeight()),range}function intersectRanges(r1,r2){return{top:Math.max(r1.top,r2.top),bottom:Math.min(r1.bottom,r2.bottom)}}function rangeLength(range){return range.bottom<range.top?0:range.bottom-range.top}function isElementVisibleOnScreen(pageView,$element,percentVisible){var elementRange=getElementRange(pageView,$element);return isRangeIsVisibleOnScreen(elementRange,percentVisible)}function isRangeIsVisibleOnScreen(range,percentVisible){var visibleRange=getVisibleRange(),smallestVisibleLength=Math.min(rangeLength(visibleRange),rangeLength(range));0===smallestVisibleLength&&(smallestVisibleLength=5);var intersectionRange=intersectRanges(visibleRange,range),visiblePercent=rangeLength(intersectionRange)/smallestVisibleLength*100;return visiblePercent>=percentVisible}function getElementRange(pageView,$element){var pageRange=getPageViewRange(pageView),elementRange={top:0,bottom:0};return elementRange.top=$element.offset().top+pageRange.top,elementRange.bottom=elementRange.top+$element.height(),elementRange}var _DEBUG=!1;_.extend(this,Backbone.Events);var _deferredPageRequest,_$contentFrame,_$el,SCROLL_MARGIN_TO_SHOW_LAST_VISBLE_LINE=5,ITEM_LOAD_SCROLL_BUFFER=2e3,ON_SCROLL_TIME_DALAY=300,self=this,_$viewport=options.$viewport,_spine=options.spine,_userStyles=options.userStyles,_stopTransientViewUpdate=!1,_isPerformingLayoutModifications=!1,_isSettingScrollPosition=!1,_isLoadingNewSpineItemOnPageRequest=!1;this.isContinuousScroll=function(){return isContinuousScroll},this.render=function(){var template=ReadiumSDK.Helpers.loadTemplate("scrolled_book_frame",{});_$el=$(template),_$viewport.append(_$el),_$contentFrame=$("#scrolled-content-frame",_$el),_$contentFrame.css("overflow",""),_$contentFrame.css("overflow-y","auto"),_$contentFrame.css("overflow-x","hidden"),_$contentFrame.css("-webkit-overflow-scrolling","touch"),_$contentFrame.css("width","100%"),_$contentFrame.css("height","100%"),_$contentFrame.css("position","relative");var settings=_viewSettings;settings||(settings=new ReadiumSDK.Models.ViewerSettings({})),settings.enableGPUHardwareAccelerationCSS3D&&_$contentFrame.css("transform","translateZ(0)"),self.applyStyles();var lazyScroll=_.debounce(onScroll,ON_SCROLL_TIME_DALAY);return _$contentFrame.on("scroll",function(e){lazyScroll(e),onScrollDirect()}),self};var _mediaOverlaysWasPlayingLastTimeScrollStarted=!1;this.remove=function(){_$el.remove()},this.onViewportResize=function(){_$contentFrame&&(forEachItemView(function(pageView){updatePageViewSize(pageView)
},!1),onPaginationChanged(self),updateTransientViews())};var _viewSettings=void 0;this.setViewSettings=function(settings){_viewSettings=settings,forEachItemView(function(pageView){pageView.setViewSettings(settings)},!1)},this.applyStyles=function(){ReadiumSDK.Helpers.setStyles(_userStyles.getStyles(),_$el.parent());var elementMargins=ReadiumSDK.Helpers.Margins.fromElement(_$el);setFrameSizesToRectangle(elementMargins.padding)},this.applyBookStyles=function(){forEachItemView(function(pageView){pageView.applyBookStyles()},!1)},this.openPage=function(pageRequest){_stopTransientViewUpdate=!0;var doneLoadingSpineItem=function(pageView,pageRequest){_deferredPageRequest=void 0,openPageViewElement(pageView,pageRequest),_stopTransientViewUpdate=!1,updateTransientViews(pageView)};if(pageRequest.spineItem){var pageView=findPageViewForSpineItem(pageRequest.spineItem);pageView?doneLoadingSpineItem(pageView,pageRequest):(_deferredPageRequest=pageRequest,_isLoadingNewSpineItemOnPageRequest=!0,loadSpineItem(pageRequest.spineItem,function(pageView){setTimeout(function(){_isLoadingNewSpineItemOnPageRequest=!1},ON_SCROLL_TIME_DALAY+100),pageView&&_deferredPageRequest?pageView.currentSpineItem()===_deferredPageRequest.spineItem?doneLoadingSpineItem(pageView,_deferredPageRequest):self.openPage(_deferredPageRequest):onPaginationChanged(pageRequest.initiator,pageRequest.spineItem,pageRequest.elementId)}))}else doneLoadingSpineItem(void 0,pageRequest)},this.openPageNext=function(initiator){var pageRequest;scrollBottom()>0&&(pageRequest=new ReadiumSDK.Models.PageOpenRequest(void 0,initiator),pageRequest.scrollTop=scrollTop()+Math.min(scrollBottom(),viewHeight()-SCROLL_MARGIN_TO_SHOW_LAST_VISBLE_LINE),openPageViewElement(void 0,pageRequest))},this.openPagePrev=function(initiator){var pageRequest;scrollTop()>0&&(pageRequest=new ReadiumSDK.Models.PageOpenRequest(void 0,initiator),pageRequest.scrollTop=scrollTop()-(viewHeight()-SCROLL_MARGIN_TO_SHOW_LAST_VISBLE_LINE),pageRequest.scrollTop<0&&(pageRequest.scrollTop=0),openPageViewElement(void 0,pageRequest))},this.getFirstVisibleElementCfi=function(){var visibleViewPage=getFirstVisiblePageView();return visibleViewPage?visibleViewPage.getNavigator().getFirstVisibleElementCfi(scrollTop()):void 0},this.getPaginationInfo=function(){for(var spineItem,pageCount,pageView,pageViewRange,heightAboveViewport,heightBelowViewport,pageCountAbove,pageCountBelow,viewPortRange=getVisibleRange(),viewPortHeight=viewPortRange.bottom-viewPortRange.top,paginationInfo=new ReadiumSDK.Models.CurrentPagesInfo(_spine,!1),visibleViews=getVisiblePageViews(),i=0,count=visibleViews.length;count>i;i++)pageView=visibleViews[i],spineItem=pageView.currentSpineItem(),pageViewRange=getPageViewRange(pageView),heightAboveViewport=Math.max(viewPortRange.top-pageViewRange.top,0),heightBelowViewport=Math.max(pageViewRange.bottom-viewPortRange.bottom,0),pageCountAbove=Math.ceil(heightAboveViewport/viewPortHeight),pageCountBelow=Math.ceil(heightBelowViewport/viewPortHeight),pageCount=pageCountAbove+pageCountBelow+1,paginationInfo.addOpenPage(pageCountAbove,pageCount,spineItem.idref,spineItem.index);return paginationInfo},this.bookmarkCurrentPage=function(){var pageView=getFirstVisiblePageView();return pageView?new ReadiumSDK.Models.BookmarkData(pageView.currentSpineItem().idref,self.getFirstVisibleElementCfi()):new ReadiumSDK.Models.BookmarkData("","")},this.getLoadedSpineItems=function(){var spineItems=[];return forEachItemView(function(pageView){spineItems.push(pageView.currentSpineItem())},!1),spineItems},this.getElement=function(spineItem,selector){var element=void 0;return forEachItemView(function(pageView){return pageView.currentSpineItem()==spineItem?(element=pageView.getNavigator().getElement(selector),!1):!0},!1),element},this.getElementByCfi=function(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist){var found=void 0;return forEachItemView(function(pageView){return pageView.currentSpineItem()==spineItem?(found=pageView.getElementByCfi(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist),!1):!0},!1),found?found:void console.error("spine item is not loaded")},this.getElementById=function(spineItem,id){var found=void 0;return forEachItemView(function(pageView){return pageView.currentSpineItem()==spineItem?(found=pageView.getNavigator().getElementById(id),!1):!0},!1),found?found:void console.error("spine item is not loaded")},this.getFirstVisibleMediaOverlayElement=function(){var pageViewRange,viewPortRange=getVisibleRange(),moElement=void 0,normalizedRange={top:0,bottom:0},steppedToVisiblePage=!1;return forEachItemView(function(pageView){if(pageViewRange=getPageViewRange(pageView),normalizedRange.top=Math.max(pageViewRange.top,viewPortRange.top)-pageViewRange.top,normalizedRange.bottom=Math.min(pageViewRange.bottom,viewPortRange.bottom)-pageViewRange.top,rangeLength(normalizedRange)>0){if(steppedToVisiblePage=!0,moElement=pageView.getNavigator().getFirstVisibleMediaOverlayElement(normalizedRange))return!1}else if(steppedToVisiblePage)return!1;return!0},!1),moElement},this.insureElementVisibility=function(spineItemId,element,initiator){var pageView=void 0;if(forEachItemView(function(pv){return pv.currentSpineItem().idref===spineItemId?(pageView=pv,!1):!0},!1),!pageView)return void console.warn("Page for element "+element+" not found");var $element=$(element),elementRange=getElementRange(pageView,$element);if(!isRangeIsVisibleOnScreen(elementRange,60)){var spineItem=_spine.getItemById(spineItemId),openPageRequest=new ReadiumSDK.Models.PageOpenRequest(spineItem,initiator);openPageRequest.scrollTop=elementRange.top,self.openPage(openPageRequest)}}},define("scrollView",["readiumSDK","cfiNavigationLogic","bookmarkData","triggers","onePageView"],function(global){return function(){var ret;return ret||global.scrollView}}(this)),ReadiumSDK.Models.Switches=function(){},ReadiumSDK.Models.Switches.apply=function(dom){function isSupported(caseNode){var ns=caseNode.attributes["required-namespace"];if(!ns)return console.log("Encountered a case statement with no required-namespace"),!1;var supportedNamespaces=["http://www.w3.org/1998/Math/MathML"];return _.include(supportedNamespaces,ns)}$("switch",dom).each(function(){var found=!1;$("case",this).each(function(){!found&&isSupported(this)?found=!0:$(this).remove()}),found&&$("default",this).remove()})},define("switches",["readiumSDK"],function(global){return function(){var ret;return ret||global.switches}}(this)),ReadiumSDK.Views.ReaderView=function(options){function deduceDesiredViewType(spineItem){return"scroll-doc"==_viewerSettings.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:"scroll-continuous"==_viewerSettings.scroll?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:spineItem.isFixedLayout()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:spineItem.isFlowScrolledDoc()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:spineItem.isFlowScrolledContinuous()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED}function initViewForItem(spineItem,callback){var desiredViewType=deduceDesiredViewType(spineItem);if(_currentView){if(self.getCurrentViewType()==desiredViewType)return void callback(!1);resetCurrentView()}var viewCreationParams={$viewport:_$el,spine:_spine,userStyles:_userStyles,bookStyles:_bookStyles,iframeLoader:_iframeLoader};_currentView=self.createViewForType(desiredViewType,viewCreationParams),self.trigger(ReadiumSDK.Events.READER_VIEW_CREATED,desiredViewType),_currentView.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function($iframe,spineItem){if(ReadiumSDK.Helpers.isIframeAlive($iframe[0])){_mediaOverlayDataInjector.attachMediaOverlayData($iframe,spineItem,_viewerSettings),_internalLinksSupport.processLinkElements($iframe,spineItem),_annotationsManager.attachAnnotations($iframe,spineItem);var contentDoc=$iframe[0].contentDocument;ReadiumSDK.Models.Trigger.register(contentDoc),ReadiumSDK.Models.Switches.apply(contentDoc),self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,$iframe,spineItem)}}),_currentView.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,function($iframe,spineItem){self.trigger(ReadiumSDK.Events.CONTENT_DOCUMENT_LOAD_START,$iframe,spineItem)}),_currentView.on(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED,function(pageChangeData){_mediaOverlayPlayer.onPageChanged(pageChangeData),self.trigger(ReadiumSDK.Events.PAGINATION_CHANGED,pageChangeData)}),_currentView.on(ReadiumSDK.Events.FXL_VIEW_RESIZED,function(){self.trigger(ReadiumSDK.Events.FXL_VIEW_RESIZED)}),_currentView.render(),_currentView.setViewSettings(_viewerSettings),setTimeout(function(){callback(!0)},50)}function resetCurrentView(){_currentView&&(self.trigger(ReadiumSDK.Events.READER_VIEW_DESTROYED),_currentView.off(ReadiumSDK.InternalEvents.CURRENT_VIEW_PAGINATION_CHANGED),_currentView.remove(),_currentView=void 0)}function onMediaPlayerStatusChanged(status){self.trigger(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,status)}function getSpineItem(idref){if(!idref)return void console.log("idref parameter value missing!");var spineItem=_spine.getItemById(idref);return spineItem?spineItem:void console.log("Spine item with id "+idref+" not found!")}function openPage(pageRequest,dir){initViewForItem(pageRequest.spineItem,function(isViewChanged){isViewChanged||_currentView.setViewSettings(_viewerSettings),_currentView.openPage(pageRequest,dir)})}function applyStyles(doNotUpdateView){ReadiumSDK.Helpers.setStyles(_userStyles.getStyles(),_$el),_mediaOverlayPlayer&&_mediaOverlayPlayer.applyStyles(),doNotUpdateView||_currentView&&_currentView.applyStyles()}_.extend(this,Backbone.Events);var _mediaOverlayPlayer,_mediaOverlayDataInjector,_iframeLoader,_$el,self=this,_currentView=void 0,_package=void 0,_spine=void 0,_viewerSettings=new ReadiumSDK.Models.ViewerSettings({}),_userStyles=new ReadiumSDK.Collections.StyleCollection,_bookStyles=new ReadiumSDK.Collections.StyleCollection,_internalLinksSupport=new ReadiumSDK.Views.InternalLinksSupport(this),_annotationsManager=new ReadiumSDK.Views.AnnotationsManager(self,options),lazyResize=_.debounce(function(){self.handleViewportResize()},200,!1);$(window).on("resize.ReadiumSDK.readerView",_.bind(lazyResize,self)),options.el instanceof $?(_$el=options.el,console.log("** EL is a jQuery selector:"+options.el.attr("id"))):(_$el=$(options.el),console.log("** EL is a string:"+_$el.attr("id"))),_iframeLoader=options.iframeLoader?options.iframeLoader:new ReadiumSDK.Views.IFrameLoader({mathJaxUrl:options.mathJaxUrl}),this.createViewForType=function(viewType,options){var createdView;switch(viewType){case ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:createdView=new ReadiumSDK.Views.FixedView(options,self);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:createdView=new ReadiumSDK.Views.ScrollView(options,!1,self);break;case ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:createdView=new ReadiumSDK.Views.ScrollView(options,!0,self);break;default:createdView=new ReadiumSDK.Views.ReflowableView(options,self)}return createdView},this.getCurrentViewType=function(){return _currentView?_currentView instanceof ReadiumSDK.Views.ReflowableView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED:_currentView instanceof ReadiumSDK.Views.FixedView?ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED:_currentView instanceof ReadiumSDK.Views.ScrollView?_currentView.isContinuousScroll()?ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS:ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC:void console.error("Unrecognized view type"):void 0},this.getLoadedSpineItems=function(){return _currentView?_currentView.getLoadedSpineItems():[]},this.viewerSettings=function(){return _viewerSettings},this.package=function(){return _package},this.spine=function(){return _spine},this.userStyles=function(){return _userStyles},this.openBook=function(openBookData){var packageData=openBookData.package?openBookData.package:openBookData;_package=new ReadiumSDK.Models.Package(packageData),_spine=_package.spine,_spine.handleLinear(!0),_mediaOverlayPlayer&&_mediaOverlayPlayer.reset(),_mediaOverlayPlayer=new ReadiumSDK.Views.MediaOverlayPlayer(self,$.proxy(onMediaPlayerStatusChanged,self)),_mediaOverlayPlayer.setAutomaticNextSmil(_viewerSettings.mediaOverlaysAutomaticPageTurn?!0:!1),_mediaOverlayDataInjector=new ReadiumSDK.Views.MediaOverlayDataInjector(_package.media_overlay,_mediaOverlayPlayer),resetCurrentView(),openBookData.settings&&self.updateSettings(openBookData.settings),openBookData.styles&&self.setStyles(openBookData.styles);var pageRequestData=void 0;openBookData.openPageRequest&&(openBookData.openPageRequest.idref||openBookData.openPageRequest.contentRefUrl&&openBookData.openPageRequest.sourceFileHref?pageRequestData=openBookData.openPageRequest:console.log("Invalid page request data: idref required!"));var fallback=!1;if(pageRequestData){pageRequestData=openBookData.openPageRequest;try{fallback=pageRequestData.idref?pageRequestData.spineItemPageIndex?!self.openSpineItemPage(pageRequestData.idref,pageRequestData.spineItemPageIndex,self):pageRequestData.elementCfi?!self.openSpineItemElementCfi(pageRequestData.idref,pageRequestData.elementCfi,self):!self.openSpineItemPage(pageRequestData.idref,0,self):!self.openContentUrl(pageRequestData.contentRefUrl,pageRequestData.sourceFileHref,self)}catch(err){console.error("openPageRequest fail: fallback to first page!"),console.log(err),fallback=!0}}else fallback=!0;if(fallback){var spineItem=_spine.first();if(spineItem){var pageOpenRequest=new ReadiumSDK.Models.PageOpenRequest(spineItem,self);pageOpenRequest.setFirstPage(),openPage(pageOpenRequest,0)}}},this.openPageLeft=function(){_package.spine.isLeftToRight()?self.openPagePrev():self.openPageNext()},this.openPageRight=function(){_package.spine.isLeftToRight()?self.openPageNext():self.openPagePrev()},this.isCurrentViewFixedLayout=function(){return _currentView instanceof ReadiumSDK.Views.FixedView},this.setZoom=function(zoom){self.isCurrentViewFixedLayout()&&_currentView.setZoom(zoom)},this.getViewScale=function(){return self.isCurrentViewFixedLayout()?100*_currentView.getViewScale():100},this.updateSettings=function(settingsData){if(_viewerSettings.update(settingsData),_mediaOverlayPlayer&&_mediaOverlayPlayer.setAutomaticNextSmil(_viewerSettings.mediaOverlaysAutomaticPageTurn?!0:!1),_currentView&&!settingsData.doNotUpdateView){var bookMark=_currentView.bookmarkCurrentPage();if(bookMark&&bookMark.idref){var wasPlaying=!1;_currentView.isReflowable&&_currentView.isReflowable()&&(wasPlaying=self.isPlayingMediaOverlay(),wasPlaying&&self.pauseMediaOverlay());var spineItem=_spine.getItemById(bookMark.idref);initViewForItem(spineItem,function(isViewChanged){isViewChanged||_currentView.setViewSettings(_viewerSettings),self.openSpineItemElementCfi(bookMark.idref,bookMark.contentCFI,self),wasPlaying&&self.playMediaOverlay(),self.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)})}}self.trigger(ReadiumSDK.Events.SETTINGS_APPLIED)},this.openPageNext=function(){if(self.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void _currentView.openPageNext(self);var paginationInfo=_currentView.getPaginationInfo();if(0!=paginationInfo.openPages.length){var lastOpenPage=paginationInfo.openPages[paginationInfo.openPages.length-1];if(lastOpenPage.spineItemPageIndex<lastOpenPage.spineItemPageCount-1)return void _currentView.openPageNext(self);var currentSpineItem=_spine.getItemById(lastOpenPage.idref),nextSpineItem=_spine.nextItem(currentSpineItem);if(nextSpineItem){var openPageRequest=new ReadiumSDK.Models.PageOpenRequest(nextSpineItem,self);openPageRequest.setFirstPage(),openPage(openPageRequest,2)}}},this.openPagePrev=function(){if(self.getCurrentViewType()===ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS)return void _currentView.openPagePrev(self);var paginationInfo=_currentView.getPaginationInfo();if(0!=paginationInfo.openPages.length){var firstOpenPage=paginationInfo.openPages[0];if(firstOpenPage.spineItemPageIndex>0)return void _currentView.openPagePrev(self);var currentSpineItem=_spine.getItemById(firstOpenPage.idref),prevSpineItem=_spine.prevItem(currentSpineItem);if(prevSpineItem){var openPageRequest=new ReadiumSDK.Models.PageOpenRequest(prevSpineItem,self);openPageRequest.setLastPage(),openPage(openPageRequest,1)}}},this.openSpineItemElementCfi=function(idref,elementCfi,initiator){var spineItem=getSpineItem(idref);if(!spineItem)return!1;var pageData=new ReadiumSDK.Models.PageOpenRequest(spineItem,initiator);return elementCfi&&pageData.setElementCfi(elementCfi),openPage(pageData,0),!0},this.openPageIndex=function(pageIndex,initiator){if(!_currentView)return!1;var pageRequest,spineItem=_spine.items[pageIndex];if(!spineItem)return!1;if(_package.isFixedLayout()){var spineItem=_spine.items[pageIndex];if(!spineItem)return!1;pageRequest=new ReadiumSDK.Models.PageOpenRequest(spineItem,initiator),pageRequest.setPageIndex(0)}else{var spineItems=this.getLoadedSpineItems();spineItems.length>0&&(pageRequest=new ReadiumSDK.Models.PageOpenRequest(spineItems[0],initiator),pageRequest.setPageIndex(pageIndex))}return openPage(pageRequest,0),!0},this.openSpineItemPage=function(idref,pageIndex,initiator){var spineItem=getSpineItem(idref);if(!spineItem)return!1;var pageData=new ReadiumSDK.Models.PageOpenRequest(spineItem,initiator);return pageIndex&&pageData.setPageIndex(pageIndex),openPage(pageData,0),!0},this.setStyles=function(styles,doNotUpdateView){for(var count=styles.length,i=0;count>i;i++)styles[i].declarations?_userStyles.addStyle(styles[i].selector,styles[i].declarations):_userStyles.removeStyle(styles[i].selector);applyStyles(doNotUpdateView)},this.setBookStyles=function(styles){for(var count=styles.length,i=0;count>i;i++)_bookStyles.addStyle(styles[i].selector,styles[i].declarations);_currentView&&_currentView.applyBookStyles()},this.getElement=function(spineItem,selector){return _currentView?_currentView.getElement(spineItem,selector):void 0},this.getElementById=function(spineItem,id){return _currentView?_currentView.getElementById(spineItem,id):void 0},this.getElementByCfi=function(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist){return _currentView?_currentView.getElementByCfi(spineItem,cfi,classBlacklist,elementBlacklist,idBlacklist):void 0},this.mediaOverlaysOpenContentUrl=function(contentRefUrl,sourceFileHref,offset){_mediaOverlayPlayer.mediaOverlaysOpenContentUrl(contentRefUrl,sourceFileHref,offset)},this.openContentUrl=function(contentRefUrl,sourceFileHref,initiator){var hrefPart,elementId,combinedPath=ReadiumSDK.Helpers.ResolveContentRef(contentRefUrl,sourceFileHref),hashIndex=combinedPath.indexOf("#");hashIndex>=0?(hrefPart=combinedPath.substr(0,hashIndex),elementId=combinedPath.substr(hashIndex+1)):(hrefPart=combinedPath,elementId=void 0);var spineItem=_spine.getItemByHref(hrefPart);if(!spineItem){console.warn("spineItem "+hrefPart+" not found");var decodedHrefPart=decodeURIComponent(hrefPart);if(spineItem=_spine.getItemByHref(decodedHrefPart),!spineItem)return console.warn("decoded spineItem "+decodedHrefPart+" missing as well"),!1}return self.openSpineItemElementId(spineItem.idref,elementId,initiator)},this.openSpineItemElementId=function(idref,elementId,initiator){var spineItem=_spine.getItemById(idref);if(!spineItem)return!1;var pageData=new ReadiumSDK.Models.PageOpenRequest(spineItem,initiator);return elementId&&pageData.setElementId(elementId),openPage(pageData,0),!0},this.bookmarkCurrentPage=function(){return JSON.stringify(_currentView.bookmarkCurrentPage())},this.clearStyles=function(){_userStyles.resetStyleValues(),applyStyles(),_userStyles.clear()},this.clearBookStyles=function(){_currentView&&(_bookStyles.resetStyleValues(),_currentView.applyBookStyles()),_bookStyles.clear()},this.isMediaOverlayAvailable=function(){return _mediaOverlayPlayer?_mediaOverlayPlayer.isMediaOverlayAvailable():!1},this.toggleMediaOverlay=function(){_mediaOverlayPlayer.toggleMediaOverlay()},this.nextMediaOverlay=function(){_mediaOverlayPlayer.nextMediaOverlay()},this.previousMediaOverlay=function(){_mediaOverlayPlayer.previousMediaOverlay()},this.escapeMediaOverlay=function(){_mediaOverlayPlayer.escape()},this.ttsEndedMediaOverlay=function(){_mediaOverlayPlayer.onTTSEnd()},this.pauseMediaOverlay=function(){_mediaOverlayPlayer.pause()},this.playMediaOverlay=function(){_mediaOverlayPlayer.play()},this.isPlayingMediaOverlay=function(){return _mediaOverlayPlayer.isPlaying()},this.getFirstVisibleMediaOverlayElement=function(){return _currentView?_currentView.getFirstVisibleMediaOverlayElement():void 0},this.insureElementVisibility=function(spineItemId,element,initiator){_currentView&&_currentView.insureElementVisibility(spineItemId,element,initiator)},this.handleViewportResize=function(){if(_currentView){var bookMark=_currentView.bookmarkCurrentPage();if(_currentView.isReflowable&&_currentView.isReflowable()&&bookMark&&bookMark.idref){var wasPlaying=self.isPlayingMediaOverlay();wasPlaying&&self.pauseMediaOverlay();var spineItem=_spine.getItemById(bookMark.idref);initViewForItem(spineItem,function(){self.openSpineItemElementCfi(bookMark.idref,bookMark.contentCFI,self),wasPlaying&&self.playMediaOverlay()})}else{console.debug("RESIZE NO RESTORE BOOKMARK");var wasPlaying=!1;_currentView.isReflowable&&_currentView.isReflowable()&&(wasPlaying=self.isPlayingMediaOverlay(),wasPlaying&&self.pauseMediaOverlay()),_currentView.onViewportResize(),wasPlaying&&setTimeout(function(){self.playMediaOverlay()},150)}}},this.getCurrentSelectionCfi=function(){return _annotationsManager.getCurrentSelectionCfi()},this.addHighlight=function(spineIdRef,Cfi,id,type,styles){return _annotationsManager.addHighlight(spineIdRef,Cfi,id,type,styles)},this.addSelectionHighlight=function(id,type){return _annotationsManager.addSelectionHighlight(id,type)},this.removeHighlight=function(id){return _annotationsManager.removeHighlight(id)},this.addIFrameEventListener=function(eventName,callback,context){_iframeLoader.addIFrameEventListener(eventName,callback,context)};var BackgroundAudioTrackManager=function(){var _spineItemIframeMap={},_wasPlaying=!1,_callback_playPause=void 0;this.setCallback_PlayPause=function(callback){_callback_playPause=callback};var _callback_isAvailable=void 0;this.setCallback_IsAvailable=function(callback){_callback_isAvailable=callback},this.playPause=function(doPlay){_playPause(doPlay)};var _playPause=function(doPlay){_callback_playPause&&_callback_playPause(doPlay);try{var $iframe=void 0;for(var prop in _spineItemIframeMap)if(_spineItemIframeMap.hasOwnProperty(prop)){var data=_spineItemIframeMap[prop];if(data&&data.active&&($iframe&&console.error("More than one active iframe?? (pagination)"),$iframe=data.$iframe)){var $audios=$("audio",$iframe[0].contentDocument);$.each($audios,function(){var attr=this.getAttribute("epub:type")||this.getAttribute("type");return attr?attr.indexOf("ibooks:soundtrack")<0&&attr.indexOf("media:soundtrack")<0&&attr.indexOf("media:background")<0?!0:(doPlay&&this.play?this.play():this.pause&&this.pause(),!0):!0})}}}catch(err){console.error(err)}};this.setPlayState=function(wasPlaying){_wasPlaying=wasPlaying},self.on(ReadiumSDK.Events.CONTENT_DOCUMENT_LOADED,function($iframe,spineItem){try{spineItem&&spineItem.idref&&$iframe&&$iframe[0]&&(_spineItemIframeMap[spineItem.idref]={$iframe:$iframe,href:spineItem.href})}catch(err){console.error(err)}}),self.on(ReadiumSDK.Events.PAGINATION_CHANGED,function(pageChangeData){var atLeastOne=!1;try{for(var prop in _spineItemIframeMap)if(_spineItemIframeMap.hasOwnProperty(prop)){var isActive=pageChangeData.spineItem&&pageChangeData.spineItem.idref===prop,isDisplayed=!1;if(pageChangeData.paginationInfo&&pageChangeData.paginationInfo.openPages.length){for(var allSame=!0,i=0;i<pageChangeData.paginationInfo.openPages.length;i++)pageChangeData.paginationInfo.openPages[i].idref===prop?isDisplayed=!0:allSame=!1;!isActive&&allSame&&(isActive=!0)}if(isActive||isDisplayed){var data=_spineItemIframeMap[prop];if(!data)continue;_spineItemIframeMap[prop].active=isActive;var $iframe=data.$iframe,$audios=(data.href,$("audio",$iframe[0].contentDocument));$.each($audios,function(){var attr=this.getAttribute("epub:type")||this.getAttribute("type");return attr?attr.indexOf("ibooks:soundtrack")<0&&attr.indexOf("media:soundtrack")<0&&attr.indexOf("media:background")<0?!0:(this.setAttribute("loop","loop"),this.removeAttribute("autoplay"),isActive||this.pause&&this.pause(),atLeastOne=!0,!0):!0})}else _spineItemIframeMap[prop]&&(_spineItemIframeMap[prop].$iframe=void 0),_spineItemIframeMap[prop]=void 0}}catch(err){console.error(err)}_callback_isAvailable&&_callback_isAvailable(atLeastOne),_playPause(atLeastOne?_wasPlaying?!0:!1:!1)}),self.on(ReadiumSDK.Events.MEDIA_OVERLAY_STATUS_CHANGED,function(value){if(value.smilIndex){var package=self.package(),smil=package.media_overlay.smilAt(value.smilIndex);if(smil&&smil.spineItemId){var needUpdate=!1;for(var prop in _spineItemIframeMap)if(_spineItemIframeMap.hasOwnProperty(prop)){var data=_spineItemIframeMap[prop];data&&data.active&&prop!==smil.spineItemId&&(_playPause(!1),data.active=!1,needUpdate=!0)}if(needUpdate){for(var prop in _spineItemIframeMap)if(_spineItemIframeMap.hasOwnProperty(prop)){var data=_spineItemIframeMap[prop];data&&(data.active||prop===smil.spineItemId&&(data.active=!0))}_wasPlaying&&_playPause(!0)}}}})};this.backgroundAudioTrackManager=new BackgroundAudioTrackManager},ReadiumSDK.Views.ReaderView.VIEW_TYPE_COLUMNIZED=1,ReadiumSDK.Views.ReaderView.VIEW_TYPE_FIXED=2,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_DOC=3,ReadiumSDK.Views.ReaderView.VIEW_TYPE_SCROLLED_CONTINUOUS=4,define("readerView",["backbone","readiumSDK","helpers","viewerSettings","styleCollection","package","mediaOverlayPlayer","pageOpenRequest","fixedView","reflowableView","mediaOvelayDataInjector","internalLinksSupport","iframeLoader","annotationsManager","scrollView","URIjs","triggers","switches"],function(global){return function(){var ret;return ret||global.readerView}}(this)),define("epub-fetch/markup_parser",[],function(){var MarkupParser=function(){var self=this;this.parseXml=function(xmlString){return self.parseMarkup(xmlString,"text/xml")},this.parseMarkup=function(markupString,contentType){var parser=new window.DOMParser;return parser.parseFromString(markupString,contentType)}};return MarkupParser}),define("epub-fetch/discover_content_type",["require","module","jquery","backbone","URIjs"],function(require,module,$,Backbone,URI){var _instance=void 0,ContentTypeDiscovery=function(){var self=this;ContentTypeDiscovery.suffixContentTypeMap={css:"text/css",epub:"application/epub+zip",gif:"image/gif",html:"text/html",jpg:"image/jpeg",jpeg:"image/jpeg",ncx:"application/x-dtbncx+xml",opf:"application/oebps-package+xml",png:"image/png",svg:"image/svg+xml",xhtml:"application/xhtml+xml"},this.identifyContentTypeFromFileName=function(contentUrl){var contentUrlSuffix=URI(contentUrl).suffix(),contentType="application/octet-stream";return"undefined"!=typeof ContentTypeDiscovery.suffixContentTypeMap[contentUrlSuffix]&&(contentType=ContentTypeDiscovery.suffixContentTypeMap[contentUrlSuffix]),contentType},this.identifyContentType=function(contentUrl){var contentType=$.ajax({type:"HEAD",url:contentUrl,async:!1}).getResponseHeader("Content-Type");return null===contentType&&(contentType=self.identifyContentTypeFromFileName(contentUrl),console.log("guessed contentType ["+contentType+"] from URI ["+contentUrl+"]. Configuring the web server to provide the content type is recommended.")),contentType}};return _instance||(_instance=new ContentTypeDiscovery),_instance}),define("epub-fetch/plain_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(require,module,$,URI,ContentTypeDiscovery){var PlainResourceFetcher=function(parentFetcher,baseUrl){function fetchFileContents(pathRelativeToPackageRoot,readCallback,onerror){var fileUrl=self.resolveURI(pathRelativeToPackageRoot);if("undefined"==typeof pathRelativeToPackageRoot)throw"Fetched file relative path is undefined!";var xhr=new XMLHttpRequest;xhr.open("GET",fileUrl,!0),xhr.responseType="arraybuffer",xhr.onerror=onerror,xhr.onload=function(){readCallback(xhr.response)},xhr.send()}var _packageDocumentAbsoluteUrl,_packageDocumentRelativePath,self=this;this.initialize=function(callback){parentFetcher.getXmlFileDom("META-INF/container.xml",function(containerXmlDom){_packageDocumentRelativePath=parentFetcher.getRootFile(containerXmlDom),_packageDocumentAbsoluteUrl=self.resolveURI(_packageDocumentRelativePath),callback()},function(error){console.error("unable to find package document: "+error),_packageDocumentAbsoluteUrl=baseUrl,callback()})},this.resolveURI=function(pathRelativeToPackageRoot){return baseUrl+"/"+pathRelativeToPackageRoot},this.getPackageUrl=function(){return _packageDocumentAbsoluteUrl},this.fetchFileContentsText=function(pathRelativeToPackageRoot,fetchCallback,onerror){var fileUrl=self.resolveURI(pathRelativeToPackageRoot);if("undefined"==typeof fileUrl)throw"Fetched file URL is undefined!";$.ajax({isLocal:0===fileUrl.indexOf("http")?!1:!0,url:fileUrl,dataType:"text",async:!0,success:function(result){fetchCallback(result)},error:function(xhr,status,errorThrown){console.error("Error when AJAX fetching "+fileUrl),console.error(status),console.error(errorThrown),onerror(errorThrown)}})},this.fetchFileContentsBlob=function(pathRelativeToPackageRoot,fetchCallback,onerror){var decryptionFunction=parentFetcher.getDecryptionFunctionForRelativePath(pathRelativeToPackageRoot);if(decryptionFunction){var origFetchCallback=fetchCallback;fetchCallback=function(unencryptedBlob){decryptionFunction(unencryptedBlob,function(decryptedBlob){origFetchCallback(decryptedBlob)})}}fetchFileContents(pathRelativeToPackageRoot,function(contentsArrayBuffer){var blob=new Blob([contentsArrayBuffer],{type:ContentTypeDiscovery.identifyContentTypeFromFileName(pathRelativeToPackageRoot)});fetchCallback(blob)},onerror)},this.getPackageDom=function(callback,onerror){self.fetchFileContentsText(_packageDocumentRelativePath,function(packageXml){var packageDom=parentFetcher.markupParser.parseXml(packageXml);callback(packageDom)},onerror)}};return PlainResourceFetcher}),define("epub-fetch/zip_resource_fetcher",["require","module","jquery","URIjs","./discover_content_type"],function(require,module,$,URI,ContentTypeDiscovery){var ZipResourceFetcher=function(parentFetcher,baseUrl,libDir){function withZipFsPerform(callback,onerror){_zipFs?callback(_zipFs,onerror):(zip.workerScriptsPath=libDir,_zipFs=new zip.fs.FS,_zipFs.importHttpContent(baseUrl,!0,function(){callback(_zipFs,onerror)},onerror))}function fetchFileContents(relativePathRelativeToPackageRoot,readCallback,onerror){if("undefined"==typeof relativePathRelativeToPackageRoot)throw"Fetched file relative path is undefined!";withZipFsPerform(function(zipFs,onerror){var entry=zipFs.find(relativePathRelativeToPackageRoot);"undefined"==typeof entry||null===entry?onerror(new Error("Entry "+relativePathRelativeToPackageRoot+" not found in zip "+baseUrl)):entry.directory?onerror(new Error("Entry "+relativePathRelativeToPackageRoot+" is a directory while a file has been expected")):readCallback(entry)},onerror)}var _zipFs,_checkCrc32=!1;this.getPackageUrl=function(){return baseUrl},this.fetchFileContentsText=function(relativePathRelativeToPackageRoot,fetchCallback,onerror){fetchFileContents(relativePathRelativeToPackageRoot,function(entry){entry.getText(fetchCallback,void 0,_checkCrc32)},onerror)},this.fetchFileContentsData64Uri=function(relativePathRelativeToPackageRoot,fetchCallback,onerror){fetchFileContents(relativePathRelativeToPackageRoot,function(entry){entry.getData64URI(ContentTypeDiscovery.identifyContentTypeFromFileName(relativePathRelativeToPackageRoot),fetchCallback,void 0,_checkCrc32)},onerror)},this.fetchFileContentsBlob=function(relativePathRelativeToPackageRoot,fetchCallback,onerror){var decryptionFunction=parentFetcher.getDecryptionFunctionForRelativePath(relativePathRelativeToPackageRoot);
if(decryptionFunction){var origFetchCallback=fetchCallback;fetchCallback=function(unencryptedBlob){decryptionFunction(unencryptedBlob,function(decryptedBlob){origFetchCallback(decryptedBlob)})}}fetchFileContents(relativePathRelativeToPackageRoot,function(entry){entry.getBlob(ContentTypeDiscovery.identifyContentTypeFromFileName(relativePathRelativeToPackageRoot),fetchCallback,void 0,_checkCrc32)},onerror)}};return ZipResourceFetcher}),define("epub-fetch/content_document_fetcher",["require","module","jquery","underscore","URIjs","./discover_content_type"],function(require,module,$,_,URI,ContentTypeDiscovery){var ContentDocumentFetcher=function(publicationFetcher,spineItem,loadedDocumentUri,publicationResourcesCache){function setBaseUri(documentDom,baseURI){var baseElem=documentDom.getElementsByTagName("base")[0];if(!baseElem){baseElem=documentDom.createElement("base");var anchor=documentDom.getElementsByTagName("head")[0];anchor.insertBefore(baseElem,anchor.childNodes[0])}baseElem.setAttribute("href",baseURI)}function _handleError(err){err&&(err.message&&console.error(err.message),err.stack&&console.error(err.stack)),console.error(err)}function fetchResourceForElement(resolvedElem,refAttrOrigVal,refAttr,fetchMode,resolutionDeferreds,onerror,resourceDataPreprocessing){function replaceRefAttrInElem(newResourceUrl){$(resolvedElem).data("epubZipOrigHref",refAttrOrigVal),$(resolvedElem).attr(refAttr,newResourceUrl)}var resourceUriRelativeToPackageDocument=new URI(refAttrOrigVal).absoluteTo(_contentDocumentPathRelativeToPackage).toString(),cachedResourceUrl=_publicationResourcesCache.getResourceURL(resourceUriRelativeToPackageDocument);if(cachedResourceUrl)replaceRefAttrInElem(cachedResourceUrl);else{var resolutionDeferred=$.Deferred();resolutionDeferreds.push(resolutionDeferred),_publicationFetcher.relativeToPackageFetchFileContents(resourceUriRelativeToPackageDocument,fetchMode,function(resourceData){var replaceResourceURL=function(finalResourceData){if("text"===fetchMode){var textResourceContentType=ContentTypeDiscovery.identifyContentTypeFromFileName(resourceUriRelativeToPackageDocument),declaredType=$(resolvedElem).attr("type");declaredType&&(textResourceContentType=declaredType),finalResourceData=new Blob([finalResourceData],{type:textResourceContentType})}var resourceObjectURL=window.URL.createObjectURL(finalResourceData);_publicationResourcesCache.putResourceURL(resourceUriRelativeToPackageDocument,resourceObjectURL),replaceRefAttrInElem(resourceObjectURL),resolutionDeferred.resolve()};resourceDataPreprocessing?resourceDataPreprocessing(resourceData,resourceUriRelativeToPackageDocument,replaceResourceURL):replaceResourceURL(resourceData)},onerror)}}function fetchResourceForCssUrlMatch(cssUrlMatch,cssResourceDownloadDeferreds,styleSheetUriRelativeToPackageDocument,stylesheetCssResourceUrlsMap,isStyleSheetResource){var origMatchedUrlString=cssUrlMatch[0],extractedUrlCandidates=cssUrlMatch.slice(2),extractedUrl=_.find(extractedUrlCandidates,function(matchGroup){return"undefined"!=typeof matchGroup}),extractedUri=new URI(extractedUrl),isCssUrlRelative=""===extractedUri.scheme();if(isCssUrlRelative){var resourceUriRelativeToPackageDocument=new URI(extractedUrl).absoluteTo(styleSheetUriRelativeToPackageDocument).toString(),cachedResourceURL=_publicationResourcesCache.getResourceURL(resourceUriRelativeToPackageDocument);if(cachedResourceURL)stylesheetCssResourceUrlsMap[origMatchedUrlString]={isStyleSheetResource:isStyleSheetResource,resourceObjectURL:cachedResourceURL};else{var cssUrlFetchDeferred=$.Deferred();cssResourceDownloadDeferreds.push(cssUrlFetchDeferred);var fetchMode,fetchCallback,processedBlobCallback=function(resourceDataBlob){var resourceObjectURL=window.URL.createObjectURL(resourceDataBlob);stylesheetCssResourceUrlsMap[origMatchedUrlString]={isStyleSheetResource:isStyleSheetResource,resourceObjectURL:resourceObjectURL},_publicationResourcesCache.putResourceURL(resourceUriRelativeToPackageDocument,resourceObjectURL),cssUrlFetchDeferred.resolve()},fetchErrorCallback=function(error){_handleError(error),cssUrlFetchDeferred.resolve()};isStyleSheetResource?(fetchMode="text",fetchCallback=function(styleSheetResourceData){preprocessCssStyleSheetData(styleSheetResourceData,resourceUriRelativeToPackageDocument,function(preprocessedStyleSheetData){var resourceDataBlob=new Blob([preprocessedStyleSheetData],{type:"text/css"});processedBlobCallback(resourceDataBlob)})}):(fetchMode="blob",fetchCallback=processedBlobCallback),_publicationFetcher.relativeToPackageFetchFileContents(resourceUriRelativeToPackageDocument,fetchMode,fetchCallback,fetchErrorCallback)}}}function preprocessCssStyleSheetData(styleSheetResourceData,styleSheetUriRelativeToPackageDocument,callback){var cssUrlRegexp=/[Uu][Rr][Ll]\(\s*([']([^']+)[']|["]([^"]+)["]|([^)]+))\s*\)/g,nonUrlCssImportRegexp=/@[Ii][Mm][Pp][Oo][Rr][Tt]\s*('([^']+)'|"([^"]+)")/g,stylesheetCssResourceUrlsMap={},cssResourceDownloadDeferreds=[];[nonUrlCssImportRegexp,cssUrlRegexp].forEach(function(processingRegexp){for(var cssUrlMatch=processingRegexp.exec(styleSheetResourceData);null!=cssUrlMatch;){var isStyleSheetResource=!1;processingRegexp==nonUrlCssImportRegexp&&(isStyleSheetResource=!0),fetchResourceForCssUrlMatch(cssUrlMatch,cssResourceDownloadDeferreds,styleSheetUriRelativeToPackageDocument,stylesheetCssResourceUrlsMap,isStyleSheetResource),cssUrlMatch=processingRegexp.exec(styleSheetResourceData)}}),cssResourceDownloadDeferreds.length>0?$.when.apply($,cssResourceDownloadDeferreds).done(function(){for(var origMatchedUrlString in stylesheetCssResourceUrlsMap){var processedUrlString,processedResourceDescriptor=stylesheetCssResourceUrlsMap[origMatchedUrlString];processedUrlString=processedResourceDescriptor.isStyleSheetResource?'@import "'+processedResourceDescriptor.resourceObjectURL+'"':"url('"+processedResourceDescriptor.resourceObjectURL+"')";var origMatchedUrlStringEscaped=origMatchedUrlString.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),origMatchedUrlStringRegExp=new RegExp(origMatchedUrlStringEscaped,"g");styleSheetResourceData=styleSheetResourceData.replace(origMatchedUrlStringRegExp,processedUrlString,"g")}callback(styleSheetResourceData)}):callback(styleSheetResourceData)}function resolveResourceElements(elemName,refAttr,fetchMode,resolutionDeferreds,onerror,resourceDataPreprocessing){var resolvedElems=$(elemName+"["+refAttr+"]",_contentDocumentDom);resolvedElems.each(function(index,resolvedElem){var refAttrOrigVal=$(resolvedElem).attr(refAttr),refAttrUri=new URI(refAttrOrigVal);""===refAttrUri.scheme()&&fetchResourceForElement(resolvedElem,refAttrOrigVal,refAttr,fetchMode,resolutionDeferreds,onerror,resourceDataPreprocessing)})}function resolveDocumentImages(resolutionDeferreds,onerror){resolveResourceElements("img","src","blob",resolutionDeferreds,onerror)}function resolveDocumentAudios(resolutionDeferreds,onerror){resolveResourceElements("audio","src","blob",resolutionDeferreds,onerror)}function resolveDocumentVideos(resolutionDeferreds,onerror){resolveResourceElements("video","src","blob",resolutionDeferreds,onerror),resolveResourceElements("video","poster","blob",resolutionDeferreds,onerror)}function resolveDocumentScripts(resolutionDeferreds,onerror){resolveResourceElements("script","src","blob",resolutionDeferreds,onerror)}function resolveDocumentIframes(resolutionDeferreds,onerror){resolveResourceElements("iframe","src","blob",resolutionDeferreds,onerror)}function resolveDocumentLinkStylesheets(resolutionDeferreds,onerror){resolveResourceElements("link","href","text",resolutionDeferreds,onerror,preprocessCssStyleSheetData)}function resolveDocumentEmbeddedStylesheets(resolutionDeferreds){var resolvedElems=$("style",_contentDocumentDom);resolvedElems.each(function(index,resolvedElem){var resolutionDeferred=$.Deferred();resolutionDeferreds.push(resolutionDeferred);var styleSheetData=$(resolvedElem).text();preprocessCssStyleSheetData(styleSheetData,_contentDocumentPathRelativeToPackage,function(resolvedStylesheetData){$(resolvedElem).text(resolvedStylesheetData),resolutionDeferred.resolve()})})}var _contentDocumentText,_contentDocumentDom,self=this,_contentDocumentPathRelativeToPackage=spineItem.href,_publicationFetcher=publicationFetcher,_srcMediaType=spineItem.media_type,_publicationResourcesCache=publicationResourcesCache;this.fetchContentDocumentAndResolveDom=function(contentDocumentResolvedCallback,errorCallback){_publicationFetcher.relativeToPackageFetchFileContents(_contentDocumentPathRelativeToPackage,"text",function(contentDocumentText){_contentDocumentText=contentDocumentText,self.resolveInternalPackageResources(contentDocumentResolvedCallback,errorCallback)},errorCallback)},this.resolveInternalPackageResources=function(resolvedDocumentCallback,onerror){_contentDocumentDom=_publicationFetcher.markupParser.parseMarkup(_contentDocumentText,_srcMediaType),setBaseUri(_contentDocumentDom,loadedDocumentUri);var resolutionDeferreds=[];_publicationFetcher.shouldFetchMediaAssetsProgrammatically()&&(resolveDocumentImages(resolutionDeferreds,onerror),resolveDocumentAudios(resolutionDeferreds,onerror),resolveDocumentVideos(resolutionDeferreds,onerror)),resolveDocumentIframes(resolutionDeferreds,onerror),resolveDocumentScripts(resolutionDeferreds,onerror),resolveDocumentLinkStylesheets(resolutionDeferreds,onerror),resolveDocumentEmbeddedStylesheets(resolutionDeferreds,onerror),$.when.apply($,resolutionDeferreds).done(function(){resolvedDocumentCallback(_contentDocumentDom)})}};return ContentDocumentFetcher}),define("epub-fetch/resource_cache",[],function(){var ResourceCache=function(){var _resourcesHash={};this.getResourceURL=function(resourceAbsoluteHref){var resourceObjectUrl=_resourcesHash[resourceAbsoluteHref];return resourceObjectUrl},this.putResourceURL=function(resourceAbsoluteHref,resourceObjectUrl){_resourcesHash[resourceAbsoluteHref]=resourceObjectUrl}};return ResourceCache}),define("epub-fetch/encryption_handler",["require","module"],function(){var EncryptionHandler=function(encryptionData){function blob2BinArray(blob,callback){var fileReader=new FileReader;fileReader.onload=function(){var arrayBuffer=this.result;callback(new Uint8Array(arrayBuffer))},fileReader.readAsArrayBuffer(blob)}function xorObfuscatedBlob(obfuscatedResourceBlob,prefixLength,xorKey,callback){var obfuscatedPrefixBlob=obfuscatedResourceBlob.slice(0,prefixLength);blob2BinArray(obfuscatedPrefixBlob,function(bytes){for(var masklen=xorKey.length,i=0;prefixLength>i;i++)bytes[i]=bytes[i]^xorKey[i%masklen];var deobfuscatedPrefixBlob=new Blob([bytes],{type:obfuscatedResourceBlob.type}),remainderBlob=obfuscatedResourceBlob.slice(prefixLength),deobfuscatedBlob=new Blob([deobfuscatedPrefixBlob,remainderBlob],{type:obfuscatedResourceBlob.type});callback(deobfuscatedBlob)})}function embeddedFontDeobfuscateIdpf(obfuscatedResourceBlob,callback){var prefixLength=1040;xorObfuscatedBlob(obfuscatedResourceBlob,prefixLength,encryptionData.uidHash,callback)}function urnUuidToByteArray(id){var uuidRegexp=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i,matchResults=uuidRegexp.exec(id),rawUuid=matchResults[2]+matchResults[3]+matchResults[4]+matchResults[5]+matchResults[6];rawUuid&&32==rawUuid.length||console.error("Bad UUID format for ID :"+id);for(var byteArray=[],i=0;16>i;i++){var byteHex=rawUuid.substr(2*i,2),byteNumber=parseInt(byteHex,16);byteArray.push(byteNumber)}return byteArray}function embeddedFontDeobfuscateAdobe(obfuscatedResourceBlob,callback){var uidWordArray=urnUuidToByteArray(encryptionData.uid),prefixLength=1024;xorObfuscatedBlob(obfuscatedResourceBlob,prefixLength,uidWordArray,callback)}var self=this,ENCRYPTION_METHODS={"http://www.idpf.org/2008/embedding":embeddedFontDeobfuscateIdpf,"http://ns.adobe.com/pdf/enc#RC":embeddedFontDeobfuscateAdobe};this.isEncryptionSpecified=function(){return encryptionData&&encryptionData.encryptions},this.getEncryptionMethodForRelativePath=function(pathRelativeToRoot){return self.isEncryptionSpecified()?encryptionData.encryptions[pathRelativeToRoot]:void 0},this.getDecryptionFunctionForRelativePath=function(pathRelativeToRoot){var encryptionMethod=self.getEncryptionMethodForRelativePath(pathRelativeToRoot);return encryptionMethod&&ENCRYPTION_METHODS[encryptionMethod]?ENCRYPTION_METHODS[encryptionMethod]:void 0}};return EncryptionHandler.CreateEncryptionData=function(id,encryptionDom){var encryptionData={uid:id,uidHash:window.Crypto.SHA1(unescape(encodeURIComponent(id.trim())),{asBytes:!0}),encryptions:void 0},encryptedData=$("EncryptedData",encryptionDom);return encryptedData.each(function(index,encryptedData){var encryptionAlgorithm=$("EncryptionMethod",encryptedData).first().attr("Algorithm"),cipherReference=$("CipherReference",encryptedData);cipherReference.each(function(index,CipherReference){var cipherReferenceURI=$(CipherReference).attr("URI");console.log("Encryption/obfuscation algorithm "+encryptionAlgorithm+" specified for "+cipherReferenceURI),encryptionData.encryptions||(encryptionData.encryptions={}),encryptionData.encryptions[cipherReferenceURI]=encryptionAlgorithm})}),encryptionData},EncryptionHandler}),define("epub-fetch/publication_fetcher",["require","module","jquery","URIjs","./markup_parser","./plain_resource_fetcher","./zip_resource_fetcher","./content_document_fetcher","./resource_cache","./encryption_handler"],function(require,module,$,URI,MarkupParser,PlainResourceFetcher,ZipResourceFetcher,ContentDocumentFetcher,ResourceCache,EncryptionHandler){var PublicationFetcher=function(bookRoot,jsLibRoot){function _handleError(err){err&&(err.message&&console.error(err.message),err.stack&&console.error(err.stack)),console.error(err)}function isExploded(){var ext=".epub";return-1===bookRoot.indexOf(ext,bookRoot.length-ext.length)}function createResourceFetcher(isExploded,callback){return isExploded?(console.log("using new PlainResourceFetcher"),_resourceFetcher=new PlainResourceFetcher(self,bookRoot),void _resourceFetcher.initialize(function(){callback(_resourceFetcher)})):(console.log("using new ZipResourceFetcher"),_resourceFetcher=new ZipResourceFetcher(self,bookRoot,jsLibRoot),callback(_resourceFetcher),void 0)}var self=this;self.contentTypePackageReadStrategyMap={"application/oebps-package+xml":"exploded","application/epub+zip":"zipped","application/zip":"zipped"};var _shouldConstructDomProgrammatically,_resourceFetcher,_encryptionHandler,_packageFullPath,_packageDom,_packageDomInitializationDeferred,_publicationResourcesCache=new ResourceCache;this.markupParser=new MarkupParser,this.initialize=function(callback){var isEpubExploded=isExploded();_shouldConstructDomProgrammatically=!isEpubExploded,createResourceFetcher(isEpubExploded,callback)},this.shouldConstructDomProgrammatically=function(){return _shouldConstructDomProgrammatically},this.shouldFetchMediaAssetsProgrammatically=function(){return _shouldConstructDomProgrammatically&&!isExploded()},this.getBookRoot=function(){return bookRoot},this.getJsLibRoot=function(){return jsLibRoot},this.getPackageUrl=function(){return _resourceFetcher.getPackageUrl()},this.fetchContentDocument=function(attachedData,loadedDocumentUri,contentDocumentResolvedCallback,errorCallback){var contentDocumentFetcher=new ContentDocumentFetcher(self,attachedData.spineItem,loadedDocumentUri,_publicationResourcesCache);contentDocumentFetcher.fetchContentDocumentAndResolveDom(contentDocumentResolvedCallback,function(err){_handleError(err),errorCallback(err)})},this.getFileContentsFromPackage=function(filePathRelativeToPackageRoot,callback,onerror){_resourceFetcher.fetchFileContentsText(filePathRelativeToPackageRoot,function(fileContents){callback(fileContents)},onerror)},this.getXmlFileDom=function(xmlFilePathRelativeToPackageRoot,callback,onerror){self.getFileContentsFromPackage(xmlFilePathRelativeToPackageRoot,function(xmlFileContents){var fileDom=self.markupParser.parseXml(xmlFileContents);callback(fileDom)},onerror)},this.getPackageFullPath=function(callback,onerror){self.getXmlFileDom("META-INF/container.xml",function(containerXmlDom){var packageFullPath=self.getRootFile(containerXmlDom);callback(packageFullPath)},onerror)},this.getRootFile=function(containerXmlDom){var rootFile=$("rootfile",containerXmlDom),packageFullPath=rootFile.attr("full-path");return packageFullPath},this.getPackageDom=function(callback,onerror){_packageDom?callback(_packageDom):_packageDomInitializationDeferred?_packageDomInitializationDeferred.done(callback):(_packageDomInitializationDeferred=$.Deferred(),_packageDomInitializationDeferred.done(callback),self.getPackageFullPath(function(packageFullPath){_packageFullPath=packageFullPath,self.getXmlFileDom(packageFullPath,function(packageDom){_packageDom=packageDom,_packageDomInitializationDeferred.resolve(packageDom),_packageDomInitializationDeferred=void 0})},onerror))},this.convertPathRelativeToPackageToRelativeToBase=function(relativeToPackagePath){return new URI(relativeToPackagePath).absoluteTo(_packageFullPath).toString()},this.relativeToPackageFetchFileContents=function(relativeToPackagePath,fetchMode,fetchCallback,onerror){onerror||(onerror=_handleError);var pathRelativeToEpubRoot=decodeURIComponent(self.convertPathRelativeToPackageToRelativeToBase(relativeToPackagePath));"/"===pathRelativeToEpubRoot.charAt(0)&&(pathRelativeToEpubRoot=pathRelativeToEpubRoot.substr(1));var fetchFunction=_resourceFetcher.fetchFileContentsText;"blob"===fetchMode?fetchFunction=_resourceFetcher.fetchFileContentsBlob:"data64uri"===fetchMode&&(fetchFunction=_resourceFetcher.fetchFileContentsData64Uri),fetchFunction.call(_resourceFetcher,pathRelativeToEpubRoot,fetchCallback,onerror)},this.getRelativeXmlFileDom=function(filePath,callback,errorCallback){self.getXmlFileDom(self.convertPathRelativeToPackageToRelativeToBase(filePath),callback,errorCallback)},this.setPackageMetadata=function(packageMetadata,settingFinishedCallback){self.getXmlFileDom("META-INF/encryption.xml",function(encryptionDom){var encryptionData=EncryptionHandler.CreateEncryptionData(packageMetadata.id,encryptionDom);_encryptionHandler=new EncryptionHandler(encryptionData),_encryptionHandler.isEncryptionSpecified()&&(_shouldConstructDomProgrammatically=!0),settingFinishedCallback()},function(){console.log("Document doesn't make use of encryption."),_encryptionHandler=new EncryptionHandler(void 0),settingFinishedCallback()})},this.getDecryptionFunctionForRelativePath=function(pathRelativeToRoot){return _encryptionHandler.getDecryptionFunctionForRelativePath(pathRelativeToRoot)}};return PublicationFetcher}),define("epub-fetch",["epub-fetch/publication_fetcher"],function(main){return main}),define("epub-model/package_document",["require","module","jquery","underscore","backbone","URIjs"],function(require,module,$,_,Backbone,URI){var PackageDocument=function(packageDocumentURL,resourceFetcher,metadata,spine,manifest){function tocIsNcx(){var tocItem=getTocItem(),contentDocURI=tocItem.href,fileExtension=contentDocURI.substr(contentDocURI.lastIndexOf(".")+1);return"ncx"===fileExtension.trim().toLowerCase()}function getNcxOrderedList($navMapDOM){var $ol=$("<ol></ol>");return $.each($navMapDOM.children("navPoint"),function(index,navPoint){addNavPointElements($(navPoint),$ol)}),$ol}function addNavPointElements($navPointDOM,$ol){var navText=$navPointDOM.children("navLabel").text().trim(),navHref=$navPointDOM.children("content").attr("src"),$navPointLi=$('<li class="nav-elem"></li>').append($("<a></a>",{href:navHref,text:navText}));if($ol.append($navPointLi),$navPointDOM.children("navPoint").length>0){var $newLi=$("<li></li>"),$newOl=$("<ol></ol>");$.each($navPointDOM.children("navPoint"),function(navIndex,navPoint){$newOl.append(addNavPointElements($(navPoint),$newOl))}),$newLi.append($newOl),$ol.append($newLi)}}function getTocItem(){var item=manifest.getNavItem();if(item)return item;var spine_id=metadata.ncx;return spine_id&&spine_id.length>0?manifest.getManifestItemByIdref(spine_id):null}var _page_prog_dir;this.manifest=manifest,this.getSharedJsPackageData=function(){var packageDocRoot=packageDocumentURL.substr(0,packageDocumentURL.lastIndexOf("/"));return{rootUrl:packageDocRoot,rendition_viewport:metadata.rendition_viewport,rendition_layout:metadata.rendition_layout,rendition_orientation:metadata.rendition_orientation,rendition_flow:metadata.rendition_flow,rendition_spread:metadata.rendition_spread,media_overlay:metadata.media_overlay,spine:{direction:this.getPageProgressionDirection(),items:spine}}},this.getSpineItem=function(spineIndex){var spineItem=spine[spineIndex];return spineItem},this.setPageProgressionDirection=function(page_prog_dir){_page_prog_dir=page_prog_dir},this.getPageProgressionDirection=function(){return"rtl"===_page_prog_dir?"rtl":"default"===_page_prog_dir?"default":"ltr"},this.spineLength=function(){return spine.length},this.getMetadata=function(){return metadata},this.getToc=function(){var item=getTocItem();return item?item.href:null},this.getTocText=function(callback){var toc=this.getToc();resourceFetcher.relativeToPackageFetchFileContents(toc,"text",function(tocDocumentText){callback(tocDocumentText)},function(err){console.error("ERROR fetching TOC from ["+toc+"]:"),console.error(err),callback(void 0)})},this.getTocDom=function(callback){this.getTocText(function(tocText){if("string"==typeof tocText){var tocDom=(new DOMParser).parseFromString(tocText,"text/xml");callback(tocDom)}else callback(void 0)})},this.generateTocListDOM=function(callback){var that=this;this.getTocDom(function(tocDom){if(tocDom)if(tocIsNcx()){var $ncxOrderedList;$ncxOrderedList=getNcxOrderedList($("navMap",tocDom)),callback($ncxOrderedList[0])}else{var packageDocumentAbsoluteURL=new URI(packageDocumentURL).absoluteTo(document.URL),tocDocumentAbsoluteURL=new URI(that.getToc()).absoluteTo(packageDocumentAbsoluteURL),newBaseTag=($(tocDom).remove("base"),$("<base></base>"));$(newBaseTag).attr("href",tocDocumentAbsoluteURL),$(tocDom).find("head").append(newBaseTag),callback(tocDom)}else callback(void 0)})}};return PackageDocument}),define("epub-model/smil_document_parser",["require","module","jquery","underscore"],function(require,module,$){var SmilDocumentParser=function(packageDocument,publicationFetcher){function makeFakeSmilJson(spineItem){return{id:"",href:"",spineItemId:spineItem.idref,children:[{nodeType:"seq",textref:spineItem.href,children:[{nodeType:"par",children:[{nodeType:"text",src:spineItem.href,srcFile:spineItem.href,srcFragmentId:""}]}]}]}}this.parse=function(spineItem,manifestItemSMIL,smilJson,deferred,callback,errorCallback){var that=this;publicationFetcher.getRelativeXmlFileDom(manifestItemSMIL.href,function(xmlDom){var smil=$("smil",xmlDom)[0];smilJson.smilVersion=smil.getAttribute("version"),smilJson.children=that.getChildren(smil),smilJson.href=manifestItemSMIL.href,smilJson.id=manifestItemSMIL.id,smilJson.spineItemId=spineItem.idref;var mediaItem=packageDocument.getMetadata().getMediaItemByRefinesId(manifestItemSMIL.id);mediaItem&&(smilJson.duration=mediaItem.duration),callback(deferred,smilJson)},function(fetchError){errorCallback(deferred,fetchError)})};var safeCopyProperty=function(property,fromNode,toItem,isRequired,defaultValue){var propParse=property.split(":"),destProperty=propParse[propParse.length-1];"type"===destProperty&&(destProperty="epubtype"),void 0!=fromNode.getAttribute(property)?toItem[destProperty]=fromNode.getAttribute(property):isRequired&&(void 0!==defaultValue?toItem[destProperty]=defaultValue:console.log("Required property "+property+" not found in smil node "+fromNode.nodeName))};this.getChildren=function(element){var that=this,children=[];return $.each(element.childNodes,function(elementIndex,currElement){if(1===currElement.nodeType){var item=that.createItemFromElement(currElement);item&&children.push(item)}}),children},this.createItemFromElement=function(element){var that=this,item={};item.nodeType=element.nodeName;var isBody=!1;if("body"===item.nodeType&&(isBody=!0,item.nodeType="seq"),"seq"===item.nodeType)safeCopyProperty("epub:textref",element,item,!isBody),safeCopyProperty("id",element,item),safeCopyProperty("epub:type",element,item),item.children=that.getChildren(element);else if("par"===item.nodeType)safeCopyProperty("id",element,item),safeCopyProperty("epub:type",element,item),item.children=that.getChildren(element);else if("text"===item.nodeType){safeCopyProperty("src",element,item,!0);var srcParts=item.src.split("#");item.srcFile=srcParts[0],item.srcFragmentId=2===srcParts.length?srcParts[1]:"",safeCopyProperty("id",element,item)}else{if("audio"!==item.nodeType)return void 0;safeCopyProperty("src",element,item,!0),safeCopyProperty("id",element,item),item.clipBegin=SmilDocumentParser.resolveClockValue(element.getAttribute("clipBegin")),item.clipEnd=SmilDocumentParser.resolveClockValue(element.getAttribute("clipEnd"))}return item},this.fillSmilData=function(callback){var that=this;if(packageDocument.spineLength()<=0)return void callback();for(var allFakeSmil=!0,mo_map=[],parsingDeferreds=[],spineIdx=0;spineIdx<packageDocument.spineLength();spineIdx++){var spineItem=packageDocument.getSpineItem(spineIdx);if(spineItem.media_overlay_id){var manifestItemSMIL=packageDocument.manifest.getManifestItemByIdref(spineItem.media_overlay_id);if(!manifestItemSMIL){console.error("Cannot find SMIL manifest item for spine/manifest item?! "+spineItem.media_overlay_id);continue}var parsingDeferred=$.Deferred();parsingDeferred.media_overlay_id=spineItem.media_overlay_id,parsingDeferreds.push(parsingDeferred);var smilJson={};mo_map.push(smilJson),that.parse(spineItem,manifestItemSMIL,smilJson,parsingDeferred,function(myDeferred){allFakeSmil=!1,myDeferred.resolve()},function(myDeferred,parseError){console.log("Error when parsing SMIL manifest item "+manifestItemSMIL.href+":"),console.log(parseError),myDeferred.resolve()})}else mo_map.push(makeFakeSmilJson(spineItem))}$.when.apply($,parsingDeferreds).done(function(){packageDocument.getMetadata().setMoMap(mo_map),allFakeSmil&&(console.log("No Media Overlays"),packageDocument.getMetadata().setMoMap([])),callback()})}};return SmilDocumentParser.resolveClockValue=function(value){if(!value)return 0;var hours=0,mins=0,secs=0;if(-1!=value.indexOf("min"))mins=parseFloat(value.substr(0,value.indexOf("min")));else if(-1!=value.indexOf("ms")){var ms=parseFloat(value.substr(0,value.indexOf("ms")));secs=ms/1e3}else if(-1!=value.indexOf("s"))secs=parseFloat(value.substr(0,value.indexOf("s")));else if(-1!=value.indexOf("h"))hours=parseFloat(value.substr(0,value.indexOf("h")));else{var arr=value.split(":");secs=parseFloat(arr.pop()),arr.length>0&&(mins=parseFloat(arr.pop()),arr.length>0&&(hours=parseFloat(arr.pop())))}var total=3600*hours+60*mins+secs;return total},SmilDocumentParser}),define("epub-model/metadata",["require","module","underscore"],function(require,module,_){var Metadata=function(){var that=this,_mediaItemIndexByRefinesId={};this.eachMediaItem=function(iteratorCallback){return that.mediaItems&&_.each(that.mediaItems,iteratorCallback),this},this.getMediaItemByRefinesId=function(id){return _mediaItemIndexByRefinesId[id]},this.setMoMap=function(mediaOverlaysMap){that.media_overlay.smil_models=mediaOverlaysMap},this.eachMediaItem(function(item){var id=item.refines,hash=id.indexOf("#");if(hash>=0){var start=hash+1,end=id.length-1;id=id.substr(start,end)}id=id.trim(),_mediaItemIndexByRefinesId[id]=item})};return Metadata}),define("epub-model/manifest",["require","module","underscore"],function(require,module,_){var Manifest=function(manifestJson){var _navItem,_manifestIndexById={};this.manifestLength=function(){return manifestJson.length},this.getManifestItemByIdref=function(idref){return _manifestIndexById[idref]},this.each=function(iteratorCallback){return _.each(manifestJson,iteratorCallback),this},this.getNavItem=function(){return _navItem},this.each(function(manifestItem){_manifestIndexById[manifestItem.id]=manifestItem,manifestItem.properties&&-1!==manifestItem.properties.indexOf("nav")&&(_navItem=manifestItem)})};return Manifest}),define("epub-model/package_document_parser",["require","module","jquery","underscore","backbone","epub-fetch/markup_parser","URIjs","./package_document","./smil_document_parser","./metadata","./manifest"],function(require,module,$,_,Backbone,MarkupParser,URI,PackageDocument,SmilDocumentParser,Metadata,Manifest){var PackageDocumentParser=function(bookRoot,publicationFetcher){function onError(error){error&&(error.message&&console.error(error.message),error.stack&&console.error(error.stack))}function fillSmilData(packageDocument,callback){var smilParser=new SmilDocumentParser(packageDocument,publicationFetcher);smilParser.fillSmilData(function(){callback(packageDocument)})}function updateMetadataWithIBookProperties(metadata){var dff=$.Deferred();if(metadata.rendition_layout)dff.resolve();else{var pathToIBooksSpecificXml="/META-INF/com.apple.ibooks.display-options.xml";publicationFetcher.relativeToPackageFetchFileContents(pathToIBooksSpecificXml,"text",function(ibookPropText){if(ibookPropText){var parser=new MarkupParser,propModel=parser.parseXml(ibookPropText),fixLayoutProp=$("option[name=fixed-layout]",propModel)[0];if(fixLayoutProp){var fixLayoutVal=$(fixLayoutProp).text();"true"===fixLayoutVal&&(metadata.rendition_layout="pre-paginated",console.log("using com.apple.ibooks.display-options.xml fixed-layout property"))}}dff.resolve()},function(){console.log("com.apple.ibooks.display-options.xml not found"),dff.resolve()})}return dff.promise()}function getJsonSpine(xmlDom,manifest,metadata){var $spineElements,jsonSpine=[];return $spineElements=$(findXmlElemByLocalNameAnyNS(xmlDom,"spine")).children(),$.each($spineElements,function(spineElementIndex,currSpineElement){var $currSpineElement=$(currSpineElement),idref=$currSpineElement.attr("idref")?$currSpineElement.attr("idref"):"",manifestItem=manifest.getManifestItemByIdref(idref),id=$currSpineElement.attr("id"),viewport=void 0;_.each(metadata.rendition_viewports,function(vp){return vp.refines==id?(viewport=vp.viewport,!0):void 0});var spineItem={rendition_viewport:viewport,idref:idref,href:manifestItem.href,manifest_id:manifestItem.id,media_type:manifestItem.media_type,media_overlay_id:manifestItem.media_overlay_id,linear:$currSpineElement.attr("linear")?$currSpineElement.attr("linear"):"",properties:$currSpineElement.attr("properties")?$currSpineElement.attr("properties"):""},parsedProperties=parsePropertiesString(spineItem.properties);_.extend(spineItem,parsedProperties),jsonSpine.push(spineItem)}),jsonSpine}function findXmlElemByLocalNameAnyNS(rootElement,localName,predicate){var elements=rootElement.getElementsByTagNameNS("*",localName);return predicate?_.find(elements,predicate):elements[0]}function filterXmlElemsByLocalNameAnyNS(rootElement,localName,predicate){var elements=rootElement.getElementsByTagNameNS("*",localName);return _.filter(elements,predicate)}function getElemText(rootElement,localName,predicate){var foundElement=findXmlElemByLocalNameAnyNS(rootElement,localName,predicate);return foundElement?foundElement.textContent:""}function getElemAttr(rootElement,localName,attrName,predicate){var foundElement=findXmlElemByLocalNameAnyNS(rootElement,localName,predicate);return foundElement?foundElement.getAttribute(attrName):""}function getMetaElemPropertyText(rootElement,attrPropertyValue){var foundElement=findXmlElemByLocalNameAnyNS(rootElement,"meta",function(element){return element.getAttribute("property")===attrPropertyValue});return foundElement?foundElement.textContent:""}function getMetadata(xmlDom){var metadata=new Metadata,metadataElem=findXmlElemByLocalNameAnyNS(xmlDom,"metadata"),packageElem=findXmlElemByLocalNameAnyNS(xmlDom,"package"),spineElem=findXmlElemByLocalNameAnyNS(xmlDom,"spine");metadata.author=getElemText(metadataElem,"creator"),metadata.description=getElemText(metadataElem,"description"),metadata.epub_version=packageElem.getAttribute("version")?packageElem.getAttribute("version"):"",metadata.id=getElemText(metadataElem,"identifier"),metadata.language=getElemText(metadataElem,"language"),metadata.modified_date=getMetaElemPropertyText(metadataElem,"dcterms:modified"),metadata.ncx=spineElem.getAttribute("toc")?spineElem.getAttribute("toc"):"",metadata.pubdate=getElemText(metadataElem,"date"),metadata.publisher=getElemText(metadataElem,"publisher"),metadata.rights=getElemText(metadataElem,"rights"),metadata.title=getElemText(metadataElem,"title"),metadata.rendition_orientation=getMetaElemPropertyText(metadataElem,"rendition:orientation"),metadata.rendition_layout=getMetaElemPropertyText(metadataElem,"rendition:layout"),metadata.rendition_spread=getMetaElemPropertyText(metadataElem,"rendition:spread"),metadata.rendition_flow=getMetaElemPropertyText(metadataElem,"rendition:flow"),metadata.rendition_viewport=getElemText(metadataElem,"meta",function(element){return"rendition:viewport"===element.getAttribute("property")&&!element.hasAttribute("refines")
});var viewports=[],viewportMetaElems=filterXmlElemsByLocalNameAnyNS(metadataElem,"meta",function(element){return"rendition:viewport"===element.getAttribute("property")&&element.hasAttribute("refines")});_.each(viewportMetaElems,function(currItem){var id=currItem.getAttribute("refines");if(id){var hash=id.indexOf("#");if(hash>=0){var start=hash+1,end=id.length-1;id=id.substr(start,end)}id=id.trim()}var vp={refines:id,viewport:currItem.textContent};viewports.push(vp)}),metadata.rendition_viewports=viewports,metadata.mediaItems=[];var overlayElems=filterXmlElemsByLocalNameAnyNS(metadataElem,"meta",function(element){return"media:duration"===element.getAttribute("property")&&element.hasAttribute("refines")});return _.each(overlayElems,function(currItem){metadata.mediaItems.push({refines:currItem.getAttribute("refines"),duration:SmilDocumentParser.resolveClockValue(currItem.textContent)})}),metadata.media_overlay={duration:SmilDocumentParser.resolveClockValue(getElemText(metadataElem,"meta",function(element){return"media:duration"===element.getAttribute("property")&&!element.hasAttribute("refines")})),narrator:getMetaElemPropertyText(metadataElem,"media:narrator"),activeClass:getMetaElemPropertyText(metadataElem,"media:active-class"),playbackActiveClass:getMetaElemPropertyText(metadataElem,"media:playback-active-class"),smil_models:[],skippables:["sidebar","practice","marginalia","annotation","help","note","footnote","rearnote","table","table-row","table-cell","list","list-item","pagebreak"],escapables:["sidebar","bibliography","toc","loi","appendix","landmarks","lot","index","colophon","epigraph","conclusion","afterword","warning","epilogue","foreword","introduction","prologue","preface","preamble","notice","errata","copyright-page","acknowledgments","other-credits","titlepage","imprimatur","contributors","halftitlepage","dedication","help","annotation","marginalia","practice","note","footnote","rearnote","footnotes","rearnotes","bridgehead","page-list","table","table-row","table-cell","list","list-item","glossary"]},metadata}function getJsonManifest(xmlDom){var $manifestItems=$(findXmlElemByLocalNameAnyNS(xmlDom,"manifest")).children(),jsonManifest=[];return $.each($manifestItems,function(manifestElementIndex,currManifestElement){var $currManifestElement=$(currManifestElement),currManifestElementHref=$currManifestElement.attr("href")?$currManifestElement.attr("href"):"",manifestItem={href:currManifestElementHref,id:$currManifestElement.attr("id")?$currManifestElement.attr("id"):"",media_overlay_id:$currManifestElement.attr("media-overlay")?$currManifestElement.attr("media-overlay"):"",media_type:$currManifestElement.attr("media-type")?$currManifestElement.attr("media-type"):"",properties:$currManifestElement.attr("properties")?$currManifestElement.attr("properties"):""};jsonManifest.push(manifestItem)}),jsonManifest}function getJsonBindings(xmlDom){var $bindings=$(findXmlElemByLocalNameAnyNS(xmlDom,"bindings")).children(),jsonBindings=[];return $.each($bindings,function(bindingElementIndex,currBindingElement){var $currBindingElement=$(currBindingElement),binding={handler:$currBindingElement.attr("handler")?$currBindingElement.attr("handler"):"",media_type:$currBindingElement.attr("media-type")?$currBindingElement.attr("media-type"):""};jsonBindings.push(binding)}),jsonBindings}function getCoverHref(xmlDom){var manifest,$imageNode;if(manifest=findXmlElemByLocalNameAnyNS(xmlDom,"manifest"),$imageNode=$(findXmlElemByLocalNameAnyNS(manifest,"item",function(element){var attr=element.getAttribute("properties");return attr&&_.contains(attr.split(" "),"cover-image")})),1===$imageNode.length&&$imageNode.attr("href"))return $imageNode.attr("href");var metaNode=$(findXmlElemByLocalNameAnyNS(xmlDom,"meta",function(element){return"cover"===element.getAttribute("name")})),contentAttr=metaNode.attr("content");return 1===metaNode.length&&contentAttr&&($imageNode=$(findXmlElemByLocalNameAnyNS(manifest,"item",function(element){return element.getAttribute("id")===contentAttr})),1===$imageNode.length&&$imageNode.attr("href"))?$imageNode.attr("href"):($imageNode=$(findXmlElemByLocalNameAnyNS(manifest,"item",function(element){return"cover"===element.getAttribute("id")})),1===$imageNode.length&&$imageNode.attr("href")?$imageNode.attr("href"):null)}function parsePropertiesString(str){for(var properties={},allPropStrs=str.split(" "),i=0;i<allPropStrs.length;i++)"rendition:orientation-landscape"===allPropStrs[i]&&(properties.rendition_orientation="landscape"),"rendition:orientation-portrait"===allPropStrs[i]&&(properties.rendition_orientation="portrait"),"rendition:orientation-auto"===allPropStrs[i]&&(properties.rendition_orientation="auto"),"rendition:spread-none"===allPropStrs[i]&&(properties.rendition_spread="none"),"rendition:spread-landscape"===allPropStrs[i]&&(properties.rendition_spread="landscape"),"rendition:spread-portrait"===allPropStrs[i]&&(properties.rendition_spread="portrait"),"rendition:spread-both"===allPropStrs[i]&&(properties.rendition_spread="both"),"rendition:spread-auto"===allPropStrs[i]&&(properties.rendition_spread="auto"),"rendition:flow-paginated"===allPropStrs[i]&&(properties.rendition_flow="paginated"),"rendition:flow-scrolled-continuous"===allPropStrs[i]&&(properties.rendition_flow="scrolled-continuous"),"rendition:flow-scrolled-doc"===allPropStrs[i]&&(properties.rendition_flow="scrolled-doc"),"rendition:flow-auto"===allPropStrs[i]&&(properties.rendition_flow="auto"),"rendition:page-spread-center"===allPropStrs[i]&&(properties.page_spread="page-spread-center"),"page-spread-left"===allPropStrs[i]&&(properties.page_spread="page-spread-left"),"page-spread-right"===allPropStrs[i]&&(properties.page_spread="page-spread-right"),"rendition:layout-reflowable"===allPropStrs[i]&&(properties.fixed_flow=!1,properties.rendition_layout="reflowable"),"rendition:layout-pre-paginated"===allPropStrs[i]&&(properties.fixed_flow=!0,properties.rendition_layout="pre-paginated");return properties}var _xmlDom,_packageFetcher=publicationFetcher,_deferredXmlDom=$.Deferred();publicationFetcher.getPackageDom(function(packageDom){_xmlDom=packageDom,_deferredXmlDom.resolve(packageDom)},onError),this.parse=function(callback){_deferredXmlDom.done(function(xmlDom){var metadata=getMetadata(xmlDom),page_prog_dir=(xmlDom.getElementsByTagNameNS("*","spine")[0],getElemAttr(xmlDom,"spine","page-progression-direction")),manifest=(getJsonBindings(xmlDom),new Manifest(getJsonManifest(xmlDom))),spine=getJsonSpine(xmlDom,manifest,metadata),cover=getCoverHref(xmlDom);cover&&(metadata.cover_href=cover),$.when(updateMetadataWithIBookProperties(metadata)).then(function(){_packageFetcher.setPackageMetadata(metadata,function(){var packageDocument=new PackageDocument(publicationFetcher.getPackageUrl(),publicationFetcher,metadata,spine,manifest);packageDocument.setPageProgressionDirection(page_prog_dir),fillSmilData(packageDocument,callback)})})})}};return PackageDocumentParser}),define("epub-fetch/iframe_zip_loader",["URIjs"],function(URI){var zipIframeLoader=function(ReadiumSDK,getCurrentResourceFetcher,options){function fetchHtmlAsText(path,callback){$.ajax({url:path,dataType:"html",async:!0,success:function(result){callback(result)},error:function(xhr,status,errorThrown){console.error("Error when AJAX fetching "+path),console.error(status),console.error(errorThrown),callback()}})}function fetchContentDocument(src,callback){fetchHtmlAsText(src,function(contentDocumentHtml){if(!contentDocumentHtml)return void callback();var sourceParts=src.split("/");sourceParts.pop();var base='<base href="'+sourceParts.join("/")+'/"/>',scripts='<script type="text/javascript">('+injectedScript.toString()+")()</script>";options&&options.mathJaxUrl&&contentDocumentHtml.indexOf("<math")>=0&&(scripts+='<script type="text/javascript" src="'+options.mathJaxUrl+'"></script>');var mangledContent=contentDocumentHtml.replace(/(<head.*?>)/,"$1"+base+scripts);callback(mangledContent)})}function injectedScript(){navigator.epubReadingSystem=window.parent.navigator.epubReadingSystem,window.parent=window.self,window.top=window.self}var basicIframeLoader=new ReadiumSDK.Views.IFrameLoader,self=this;this.addIFrameEventListener=function(eventName,callback,context){basicIframeLoader.addIFrameEventListener(eventName,callback,context)},this.updateIframeEvents=function(iframe){basicIframeLoader.updateIframeEvents(iframe)},this.loadIframe=function(iframe,src,callback,caller,attachedData){var loadedDocumentUri=new URI(src).absoluteTo(iframe.baseURI).search("").hash("").toString(),shouldConstructDomProgrammatically=getCurrentResourceFetcher().shouldConstructDomProgrammatically();shouldConstructDomProgrammatically?getCurrentResourceFetcher().fetchContentDocument(attachedData,loadedDocumentUri,function(resolvedContentDocumentDom){self._loadIframeWithDocument(iframe,attachedData,resolvedContentDocumentDom.documentElement.outerHTML,function(){callback.call(caller,!0,attachedData)})},function(){callback.call(caller,!1,attachedData)}):fetchContentDocument(loadedDocumentUri,function(contentDocumentHtml){contentDocumentHtml?self._loadIframeWithDocument(iframe,attachedData,contentDocumentHtml,function(){callback.call(caller,!0,attachedData)}):callback.call(caller,!1,attachedData)})},this._loadIframeWithDocument=function(iframe,attachedData,contentDocumentData,callback){var isIE=window.navigator.userAgent.indexOf("Trident")>0;if(isIE)iframe.contentWindow.document.open(),iframe.contentWindow.document.write(contentDocumentData);else{var contentType="text/html";attachedData.spineItem.media_type&&attachedData.spineItem.media_type.length&&(contentType=attachedData.spineItem.media_type);var documentDataUri=window.URL.createObjectURL(new Blob([contentDocumentData],{type:contentType}))}iframe.onload=function(){self.updateIframeEvents(iframe);var mathJax=iframe.contentWindow.MathJax;if(mathJax){var mathJaxCallback=_.once(callback);mathJax.Hub.Queue(mathJaxCallback)}else callback();isIE||window.URL.revokeObjectURL(documentDataUri)},isIE?iframe.contentWindow.document.close():iframe.setAttribute("src",documentDataUri)}};return zipIframeLoader}),define("Readium",["require","console_shim","jquery","underscore","readerView","epub-fetch","epub-model/package_document_parser","epub-fetch/iframe_zip_loader","URIjs"],function(require,console_shim,$,_,readerView,PublicationFetcher,PackageParser,IframeZipLoader,URI){if(window.URI=URI,"URL"in window==!1){if("webkitURL"in window==!1)throw Error("Browser does not support window.URL");window.URL=window.webkitURL}var Readium=function(readiumOptions,readerOptions){var _currentPublicationFetcher,self=this,jsLibRoot=readiumOptions.jsLibRoot;readerOptions.iframeLoader=readiumOptions.useSimpleLoader?new ReadiumSDK.Views.IFrameLoader:new IframeZipLoader(ReadiumSDK,function(){return _currentPublicationFetcher},{mathJaxUrl:readerOptions.mathJaxUrl}),this.reader=new ReadiumSDK.Views.ReaderView(readerOptions),this.openPackageDocument=function(bookRoot,callback,openPageRequest){_currentPublicationFetcher=new PublicationFetcher(bookRoot,jsLibRoot),_currentPublicationFetcher.initialize(function(){var _packageParser=new PackageParser(bookRoot,_currentPublicationFetcher);_packageParser.parse(function(packageDocument){var openBookOptions=readiumOptions.openBookOptions||{},openBookData=$.extend(packageDocument.getSharedJsPackageData(),openBookOptions);openPageRequest&&(openBookData.openPageRequest=openPageRequest),self.reader.openBook(openBookData);var options={packageDocumentUrl:_currentPublicationFetcher.getPackageUrl(),metadata:packageDocument.getMetadata()};callback&&callback(packageDocument,options)})})},ReadiumSDK.reader=this.reader,ReadiumSDK.trigger(ReadiumSDK.Events.READER_INITIALIZED,this.reader)};return Readium.version={readiumJs:{sha:"428b2956dce052598a73f8558b8a686600eabbd2",clean:!0},readiumSharedJs:{sha:"e3d096dabe6d6ea188c9af97fc28fc7c410982b2",clean:!0}},Readium}),define("readium",function(){})}();